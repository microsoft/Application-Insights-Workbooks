{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "7aa94d19-4c5b-40e2-b14f-e29736a8f90c",
            "version": "KqlParameterItem/1.0",
            "name": "resource",
            "type": 5,
            "isRequired": true,
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [
                "value::1"
              ],
              "showDefault": false
            },
            "timeContextFromParameter": "timeRange",
            "defaultValue": "value::1"
          }
        ],
        "style": "above",
        "queryType": 7
      },
      "conditionalVisibility": {
        "parameterName": "a",
        "comparison": "isEqualTo",
        "value": "a"
      },
      "name": "resourceParameter"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"{resource}/providers/Microsoft.Insights/dataCollectionRuleAssociations?api-version=2021-04-01\",\"urlParams\":[],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.value\",\"columns\":[{\"path\":\"$.properties.dataCollectionRuleId\",\"columnid\":\"Id\",\"columnType\":\"string\"}]}}]}",
        "size": 0,
        "queryType": 12
      },
      "conditionalVisibility": {
        "parameterName": "a",
        "comparison": "isEqualTo",
        "value": "a"
      },
      "name": "dcrAssociations"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "resources\r\n    | where type == \"microsoft.insights/datacollectionrules\"\r\n    | extend extensions = properties.dataSources.extensions\r\n    | extend flows = properties.dataFlows\r\n    | mv-expand extensions\r\n    | where extensions.name contains \"ContainerInsightsExtension\"\r\n    | extend extensionStreams = extensions.streams\r\n    | where extensionStreams !contains \"Microsoft-ContainerInsights-Group-Default\" and extensionStreams !contains \"Microsoft-InsightsMetrics\"\r\n    | project id",
        "size": 0,
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources"
      },
      "conditionalVisibility": {
        "parameterName": "a",
        "comparison": "isEqualTo",
        "value": "a"
      },
      "name": "dcrsFromARG"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "7f395a97-9643-4cb4-8825-7277b7441cc6",
            "version": "KqlParameterItem/1.0",
            "name": "parsedDCRInfo",
            "type": 1,
            "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"60f80c2a-b820-4cc6-bcf2-7d0f5ebcc862\",\"mergeType\":\"innerunique\",\"leftTable\":\"dcrAssociations\",\"rightTable\":\"dcrsFromARG\",\"leftColumn\":\"Id\",\"rightColumn\":\"id\"}],\"projectRename\":[{\"originalName\":\"[dcrAssociations].Id\",\"mergedName\":\"Id\",\"fromId\":\"60f80c2a-b820-4cc6-bcf2-7d0f5ebcc862\"},{\"originalName\":\"[dcrsFromARG].id\",\"mergedName\":\"id\",\"fromId\":\"60f80c2a-b820-4cc6-bcf2-7d0f5ebcc862\"}]}",
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 7
          }
        ],
        "style": "above",
        "queryType": 7
      },
      "conditionalVisibility": {
        "parameterName": "a",
        "comparison": "isEqualTo",
        "value": "a"
      },
      "name": "parsedDCRInfo"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "Insights data is not available with custom data collection. To view this workbook, set \"Collected data\" to “All” in Monitoring Settings or use Log Analytics to query logs.",
              "style": "info"
            },
            "name": "Cost Settings Banner"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "paragraph",
              "links": [
                {
                  "id": "9e26bb9c-0a13-4754-9e40-daa7d0c4f86e",
                  "cellValue": "OpenBlade",
                  "linkTarget": "OpenBlade",
                  "linkLabel": "Configure Monitoring Settings",
                  "style": "primary",
                  "linkIsContextBlade": true,
                  "bladeOpenContext": {
                    "bladeName": "OnboardMonitorInsights.ReactView",
                    "extensionName": "Microsoft_Azure_ContainerInsightsExt",
                    "bladeParameters": [
                      {
                        "name": "clusterResourceId",
                        "source": "parameter",
                        "value": "resource"
                      }
                    ]
                  }
                }
              ]
            },
            "name": "Configure Monitoring Settings"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "parsedDCRInfo",
        "comparison": "isNotEqualTo",
        "value": ""
      },
      "name": "Custom Cost Settings",
      "styleSettings": {
        "padding": "20"
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "crossComponentResources": [
                "{resource}"
              ],
              "parameters": [
                {
                  "id": "d9ba2e0d-ed51-4222-b6fa-84275b6181f9",
                  "version": "KqlParameterItem/1.0",
                  "name": "timeRange",
                  "type": 4,
                  "isRequired": true,
                  "value": {
                    "durationMs": 21600000
                  },
                  "typeSettings": {
                    "selectableValues": [
                      {
                        "durationMs": 3600000
                      },
                      {
                        "durationMs": 14400000
                      },
                      {
                        "durationMs": 43200000
                      },
                      {
                        "durationMs": 86400000
                      },
                      {
                        "durationMs": 172800000
                      },
                      {
                        "durationMs": 259200000
                      },
                      {
                        "durationMs": 604800000
                      },
                      {
                        "durationMs": 1209600000
                      },
                      {
                        "durationMs": 2592000000
                      }
                    ],
                    "allowCustom": false
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "label": "Time Range"
                },
                {
                  "id": "f7a7d374-98be-4c71-8475-d217b99e869c",
                  "version": "KqlParameterItem/1.0",
                  "name": "resourceType",
                  "type": 7,
                  "description": "Resource type to run queries off of",
                  "isRequired": true,
                  "query": "{\"version\":\"1.0.0\",\"content\":\"\\\"{resource:resourcetype}\\\"\",\"transformers\":null}",
                  "isHiddenWhenLocked": true,
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::1"
                    ],
                    "showDefault": false
                  },
                  "defaultValue": "value::1",
                  "queryType": 8
                },
                {
                  "id": "7ca5d424-3756-4ae7-b65b-26829f014c33",
                  "version": "KqlParameterItem/1.0",
                  "name": "clusterId",
                  "type": 1,
                  "description": "Filter queries by cluster id",
                  "isHiddenWhenLocked": true,
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "f1c34272-0c59-4f41-bd8a-f99734f355ac",
                  "version": "KqlParameterItem/1.0",
                  "name": "clusterIdWhereClause",
                  "type": 1,
                  "description": "Filter queries by cluster id",
                  "isRequired": true,
                  "isHiddenWhenLocked": true,
                  "criteriaData": [
                    {
                      "criteriaContext": {
                        "leftOperand": "resourceType",
                        "operator": "contains",
                        "rightValType": "static",
                        "rightVal": "Microsoft.operationalinsights/workspaces",
                        "resultValType": "static",
                        "resultVal": "| where ClusterId =~ \"{clusterId}\""
                      }
                    },
                    {
                      "criteriaContext": {
                        "operator": "Default",
                        "rightValType": "param",
                        "resultValType": "static",
                        "resultVal": "| where \"a\" == \"a\""
                      }
                    }
                  ],
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "649427ba-20ed-47f0-80e7-860a1ee5521f",
                  "version": "KqlParameterItem/1.0",
                  "name": "namespace",
                  "type": 2,
                  "description": "Filter by namespace",
                  "isRequired": true,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "query": "InsightsMetrics\r\n| where Name contains \"kube_\"\r\n| extend Tags = parse_json(Tags)\r\n| extend ClusterId = Tags[\"container.azm.ms/clusterId\"]\r\n{clusterIdWhereClause}\r\n| extend k8sNamespace = tostring(Tags.k8sNamespace)\r\n| distinct k8sNamespace\r\n| project k8sNamespace",
                  "crossComponentResources": [
                    "{resource}"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "defaultValue": "value::all",
                  "queryType": 0,
                  "resourceType": "{resourceType}",
                  "label": "Namespace"
                },
                {
                  "id": "067ed1a2-d4ed-49a0-adf3-7efd7f7071ac",
                  "version": "KqlParameterItem/1.0",
                  "name": "deploymentName",
                  "type": 2,
                  "description": "Filter by deployment",
                  "isRequired": true,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "query": "InsightsMetrics\r\n| where Name == \"kube_deployment_status_replicas_ready\"\r\n| extend Tags = parse_json(Tags)\r\n| extend ClusterId = Tags[\"container.azm.ms/clusterId\"]\r\n{clusterIdWhereClause}\r\n| extend DeploymentName = tostring(Tags.deployment)\r\n| where Tags.k8sNamespace in ({namespace})\r\n| distinct DeploymentName\r\n| project DeploymentName",
                  "crossComponentResources": [
                    "{resource}"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "defaultValue": "value::all",
                  "queryType": 0,
                  "resourceType": "{resourceType}",
                  "label": "Deployment"
                },
                {
                  "id": "a01cf284-1c57-4788-a105-d4c69300156e",
                  "version": "KqlParameterItem/1.0",
                  "name": "hpa",
                  "type": 2,
                  "description": "Filter by HPA",
                  "isRequired": true,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "query": "InsightsMetrics\r\n| where Name contains \"hpa\"\r\n| extend Tags = parse_json(Tags)\r\n| extend ClusterId = Tags[\"container.azm.ms/clusterId\"]\r\n{clusterIdWhereClause}\r\n| extend Namespaces = tostring(Tags.k8sNamespace)\r\n| where Namespaces in ({namespace})\r\n| extend hpa = tostring(Tags.hpa)\r\n| project hpa, Namespaces\r\n| distinct *\r\n| project hpa",
                  "crossComponentResources": [
                    "{resource}"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "defaultValue": "value::all",
                  "queryType": 0,
                  "resourceType": "{resourceType}",
                  "label": "HPA"
                }
              ],
              "style": "above",
              "queryType": 0,
              "resourceType": "{resourceType}"
            },
            "name": "pills"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "tabs",
              "links": [
                {
                  "id": "539ff615-7d81-4859-93fe-d06d0f28080e",
                  "cellValue": "selectedTab",
                  "linkTarget": "parameter",
                  "linkLabel": "Deployment",
                  "subTarget": "Deployment",
                  "style": "link"
                },
                {
                  "id": "36737f64-389e-47a2-8bfb-a43423a142e6",
                  "cellValue": "selectedTab",
                  "linkTarget": "parameter",
                  "linkLabel": "HPA",
                  "subTarget": "HPA",
                  "style": "link"
                }
              ]
            },
            "name": "tabs"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "InsightsMetrics\r\n| where Name == \"kube_deployment_status_replicas_ready\"\r\n| extend parsed = parse_json(Tags)\r\n| where parsed.deployment in ({deploymentName})\r\n| extend Deployment = tostring(parsed.deployment)\r\n| extend k8sNamespace = tostring(parsed.k8sNamespace)\r\n| extend Ready = Val/parsed.spec_replicas * 100, Updated = Val/parsed.status_replicas_updated * 100, Available = Val/parsed.status_replicas_available * 100\r\n| extend ReadyCase = case(Ready == 100, \"Healthy\", \"Warning\"),  UpdatedCase = case(Updated == 100, \"Healthy\", \"Warning\"),  AvailableCase = case(Available == 100, \"Healthy\", \"Warning\")\r\n| extend Overall = case(ReadyCase == \"Healthy\" and UpdatedCase == \"Healthy\" and AvailableCase == \"Healthy\", \"Healthy\", \"Warning\")\r\n| summarize arg_max(TimeGenerated, *) by k8sNamespace, Deployment\r\n| summarize OverallStatus = count() by Overall",
                    "size": 3,
                    "title": "Deployment Status",
                    "timeContext": {
                      "durationMs": 86400000
                    },
                    "exportParameterName": "OverallFilter",
                    "exportDefaultValue": "*",
                    "queryType": 0,
                    "resourceType": "{resourceType}",
                    "crossComponentResources": [
                      "{resource}"
                    ],
                    "visualization": "tiles",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "Overall",
                        "formatter": 18,
                        "formatOptions": {
                          "thresholdsOptions": "colors",
                          "thresholdsGrid": [
                            {
                              "operator": "==",
                              "thresholdValue": "Warning",
                              "representation": "redBright",
                              "text": "{0}{1}"
                            },
                            {
                              "operator": "Default",
                              "thresholdValue": null,
                              "representation": "green",
                              "text": "{0}{1}"
                            }
                          ]
                        }
                      },
                      "leftContent": {
                        "columnMatch": "OverallStatus",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "none"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "useGrouping": false,
                            "maximumFractionDigits": 2,
                            "maximumSignificantDigits": 3
                          }
                        }
                      },
                      "showBorder": false,
                      "sortCriteriaField": "Overall",
                      "sortOrderField": 2
                    }
                  },
                  "showPin": true,
                  "name": "Deployment Status Tiles"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let data = materialize(\r\nInsightsMetrics\r\n| where Name == \"kube_deployment_status_replicas_ready\"\r\n| extend Tags = parse_json(Tags)\r\n| extend ClusterId = Tags[\"container.azm.ms/clusterId\"]\r\n{clusterIdWhereClause}\r\n| where Tags.deployment in ({deploymentName})\r\n| extend Deployment = tostring(Tags.deployment)\r\n| extend k8sNamespace = tostring(Tags.k8sNamespace)\r\n| extend Ready = Val/Tags.spec_replicas * 100, Updated = Val/Tags.status_replicas_updated * 100, Available = Val/Tags.status_replicas_available * 100\r\n| project k8sNamespace, Deployment, Ready, Updated, Available, TimeGenerated, Tags\r\n);\r\nlet data2 = data\r\n| extend Age = (now() - todatetime(Tags[\"creationTime\"]))/1m\r\n| summarize arg_max(TimeGenerated, *) by k8sNamespace, Deployment\r\n| project k8sNamespace, Deployment, Age, Ready, Updated, Available;\r\nlet ReadyData = data\r\n| make-series ReadyTrend = avg(Ready) default = 0 on TimeGenerated from {timeRange:start} to {timeRange:end} step {timeRange:grain} by k8sNamespace, Deployment;\r\nlet UpdatedData = data\r\n| make-series UpdatedTrend = avg(Updated) default = 0 on TimeGenerated from {timeRange:start} to {timeRange:end} step {timeRange:grain} by k8sNamespace, Deployment;\r\nlet AvailableData = data\r\n| make-series AvailableTrend = avg(Available) default = 0 on TimeGenerated from {timeRange:start} to {timeRange:end} step {timeRange:grain} by k8sNamespace, Deployment;\r\ndata2\r\n| join kind = inner(ReadyData) on k8sNamespace, Deployment \r\n| join kind = inner(UpdatedData) on k8sNamespace, Deployment \r\n| join kind = inner(AvailableData) on k8sNamespace, Deployment\r\n| extend ReadyCase = case(Ready == 100, \"Healthy\", \"Warning\"),  UpdatedCase = case(Updated == 100, \"Healthy\", \"Warning\"),  AvailableCase = case(Available == 100, \"Healthy\", \"Warning\")\r\n| extend Overall = case(ReadyCase == \"Healthy\" and UpdatedCase == \"Healthy\" and AvailableCase == \"Healthy\", \"Healthy\", \"Warning\")\r\n| extend OverallFilterStatus = case('{OverallFilter}' contains \"Healthy\", \"Healthy\", '{OverallFilter}' contains \"Warning\", \"Warning\", \"Healthy, Warning\")\r\n| where OverallFilterStatus has Overall\r\n| project Deployment, Namespace = k8sNamespace, Age, Ready, ReadyTrend, Updated, UpdatedTrend, Available,AvailableTrend\r\n| sort by Ready asc\r\n",
                    "size": 0,
                    "showAnalytics": true,
                    "timeContext": {
                      "durationMs": 86400000
                    },
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "{resourceType}",
                    "crossComponentResources": [
                      "{resource}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Age",
                          "formatter": 0,
                          "numberFormat": {
                            "unit": 25,
                            "options": {
                              "style": "decimal",
                              "useGrouping": false,
                              "maximumFractionDigits": 1
                            }
                          }
                        },
                        {
                          "columnMatch": "Ready",
                          "formatter": 18,
                          "formatOptions": {
                            "thresholdsOptions": "icons",
                            "thresholdsGrid": [
                              {
                                "operator": "==",
                                "thresholdValue": "100",
                                "representation": "success",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "==",
                                "thresholdValue": "NaN",
                                "representation": "more",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "Default",
                                "thresholdValue": null,
                                "representation": "2",
                                "text": "{0}{1}"
                              }
                            ]
                          },
                          "numberFormat": {
                            "unit": 1,
                            "options": {
                              "style": "decimal",
                              "useGrouping": false,
                              "maximumFractionDigits": 1
                            }
                          }
                        },
                        {
                          "columnMatch": "ReadyTrend",
                          "formatter": 9,
                          "formatOptions": {
                            "min": 0,
                            "max": 100,
                            "palette": "redGreen"
                          }
                        },
                        {
                          "columnMatch": "Updated",
                          "formatter": 18,
                          "formatOptions": {
                            "thresholdsOptions": "icons",
                            "thresholdsGrid": [
                              {
                                "operator": "==",
                                "thresholdValue": "100",
                                "representation": "success",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "==",
                                "thresholdValue": "NaN",
                                "representation": "more",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "Default",
                                "thresholdValue": null,
                                "representation": "warning",
                                "text": "{0}{1}"
                              }
                            ]
                          },
                          "numberFormat": {
                            "unit": 1,
                            "options": {
                              "style": "decimal",
                              "maximumFractionDigits": 1
                            }
                          }
                        },
                        {
                          "columnMatch": "UpdatedTrend",
                          "formatter": 9,
                          "formatOptions": {
                            "min": 0,
                            "max": 100,
                            "palette": "redGreen"
                          }
                        },
                        {
                          "columnMatch": "Available",
                          "formatter": 18,
                          "formatOptions": {
                            "thresholdsOptions": "icons",
                            "thresholdsGrid": [
                              {
                                "operator": "==",
                                "thresholdValue": "100",
                                "representation": "success",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "==",
                                "thresholdValue": "NaN",
                                "representation": "more",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "Default",
                                "thresholdValue": null,
                                "representation": "warning",
                                "text": "{0}{1}"
                              }
                            ]
                          },
                          "numberFormat": {
                            "unit": 1,
                            "options": {
                              "style": "decimal",
                              "maximumFractionDigits": 1
                            }
                          }
                        },
                        {
                          "columnMatch": "AvailableTrend",
                          "formatter": 9,
                          "formatOptions": {
                            "min": 0,
                            "max": 100,
                            "palette": "redGreen"
                          }
                        }
                      ],
                      "filter": true,
                      "sortBy": [
                        {
                          "itemKey": "Deployment",
                          "sortOrder": 2
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "Deployment"
                        },
                        {
                          "columnId": "Ready"
                        },
                        {
                          "columnId": "ReadyTrend"
                        },
                        {
                          "columnId": "Updated",
                          "label": "Up-to-date"
                        },
                        {
                          "columnId": "UpdatedTrend",
                          "label": "Up-to-dateTrend"
                        },
                        {
                          "columnId": "Available"
                        },
                        {
                          "columnId": "AvailableTrend"
                        }
                      ]
                    },
                    "sortBy": [
                      {
                        "itemKey": "Deployment",
                        "sortOrder": 2
                      }
                    ],
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "Ready",
                        "formatter": 18,
                        "formatOptions": {
                          "thresholdsOptions": "colors",
                          "thresholdsGrid": [
                            {
                              "operator": "==",
                              "thresholdValue": "1",
                              "representation": null,
                              "text": "{0}{1}"
                            },
                            {
                              "operator": "Default",
                              "thresholdValue": null,
                              "representation": null,
                              "text": "{0}{1}"
                            }
                          ]
                        }
                      },
                      "showBorder": false
                    }
                  },
                  "showPin": true,
                  "name": "Deployment Status Grid"
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "selectedTab",
              "comparison": "isEqualTo",
              "value": "Deployment"
            },
            "name": "deployments-tab"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "_No HPA data is currently available._"
                  },
                  "conditionalVisibility": {
                    "parameterName": "hpa",
                    "comparison": "isEqualTo"
                  },
                  "name": "no-hpas-text"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let ParsedData = materialize(\r\nInsightsMetrics\r\n| where Name contains \"hpa\"\r\n| extend Tags = parse_json(Tags)\r\n| extend ClusterId = Tags[\"container.azm.ms/clusterId\"]\r\n{clusterIdWhereClause}\r\n| extend HPAs = tostring(Tags.hpa), Deployment = tostring(Tags.targetName), k8sNamespace = tostring(Tags.k8sNamespace)\r\n| where HPAs in ({hpa})\r\n| where k8sNamespace in ({namespace})\r\n| extend lastScaleTime = todatetime(Tags.lastScaleTime)\r\n);\r\nlet ValData = ParsedData\r\n| make-series ValTrend = avg(Val) default=0 on TimeGenerated from {timeRange:start} to {timeRange:end} step {timeRange:grain} by k8sNamespace, HPAs;\r\nlet MinData = ParsedData\r\n| make-series MinTrend = avg(toint(Tags.spec_min_replicas)) default=0 on TimeGenerated from {timeRange:start} to {timeRange:end} step {timeRange:grain} by k8sNamespace, HPAs;\r\nlet MaxData = ParsedData\r\n| make-series MaxTrend = avg(toint(Tags.spec_max_replicas)) default=0 on TimeGenerated from {timeRange:start} to {timeRange:end} step {timeRange:grain} by k8sNamespace, HPAs;\r\nlet DesiredData = ParsedData\r\n| make-series DesiredTrend = avg(toint(Tags.status_desired_replicas)) default=0 on TimeGenerated from {timeRange:start} to {timeRange:end} step {timeRange:grain} by k8sNamespace, HPAs;\r\nParsedData\r\n| summarize arg_max(TimeGenerated,*) by k8sNamespace, HPAs\r\n| join kind = inner(ValData) on k8sNamespace, HPAs\r\n| join kind = inner(MinData) on k8sNamespace, HPAs\r\n| join kind = inner(MaxData) on k8sNamespace, HPAs\r\n| join kind = inner(DesiredData) on k8sNamespace, HPAs\r\n| extend currentMin = tostring(Tags.spec_min_replicas), currentMax =  tostring(Tags.spec_max_replicas), currentDesired = tostring(Tags.status_desired_replicas)\r\n| extend HPAStatus = case(Val == currentDesired, \"Healthy\", \"Warning\")\r\n| extend percentofMax = toint(Val)/toint(currentMax)\r\n| sort by percentofMax desc\r\n| project HPAs, Deployment, Namespace = k8sNamespace, HPAStatus, lastScaleTime, Val, ValTrend, currentMin, MinTrend, currentMax, MaxTrend, currentDesired, DesiredTrend",
                    "size": 0,
                    "showAnalytics": true,
                    "title": "Select a row to view more details",
                    "timeContext": {
                      "durationMs": 86400000
                    },
                    "exportFieldName": "HPAs",
                    "exportParameterName": "HPAFilter",
                    "queryType": 0,
                    "resourceType": "{resourceType}",
                    "crossComponentResources": [
                      "{resource}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "HPAStatus",
                          "formatter": 18,
                          "formatOptions": {
                            "thresholdsOptions": "icons",
                            "thresholdsGrid": [
                              {
                                "operator": "==",
                                "thresholdValue": "Warning",
                                "representation": "2",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "Default",
                                "thresholdValue": null,
                                "representation": "success",
                                "text": "{0}{1}"
                              }
                            ]
                          }
                        },
                        {
                          "columnMatch": "ValTrend",
                          "formatter": 9,
                          "formatOptions": {
                            "palette": "blue"
                          }
                        },
                        {
                          "columnMatch": "Trend",
                          "formatter": 9,
                          "formatOptions": {
                            "palette": "blue"
                          }
                        }
                      ],
                      "filter": true,
                      "sortBy": [
                        {
                          "itemKey": "currentMin",
                          "sortOrder": 1
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "HPAs"
                        },
                        {
                          "columnId": "Deployment"
                        },
                        {
                          "columnId": "HPAStatus"
                        },
                        {
                          "columnId": "lastScaleTime",
                          "label": "Last Scale Time"
                        },
                        {
                          "columnId": "Val",
                          "label": "Current Replicas"
                        },
                        {
                          "columnId": "ValTrend",
                          "label": "Current Over Time"
                        },
                        {
                          "columnId": "currentMin",
                          "label": "Min Replicas"
                        },
                        {
                          "columnId": "MinTrend",
                          "label": "Min Over Time"
                        },
                        {
                          "columnId": "currentMax",
                          "label": "Max Replicas"
                        },
                        {
                          "columnId": "MaxTrend",
                          "label": "Max Over Time"
                        },
                        {
                          "columnId": "currentDesired",
                          "label": "Desired Replicas"
                        },
                        {
                          "columnId": "DesiredTrend",
                          "label": "Desired Over Time"
                        }
                      ]
                    },
                    "sortBy": [
                      {
                        "itemKey": "currentMin",
                        "sortOrder": 1
                      }
                    ]
                  },
                  "conditionalVisibility": {
                    "parameterName": "hpa",
                    "comparison": "isNotEqualTo"
                  },
                  "showPin": true,
                  "name": "HPA Grid"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let ParsedData = materialize(\r\nInsightsMetrics\r\n| where Name contains \"hpa\"\r\n| extend Tags = parse_json(Tags)\r\n| extend ClusterId = Tags[\"container.azm.ms/clusterId\"]\r\n{clusterIdWhereClause}\r\n| where tostring(Tags.hpa) in ({hpa})\r\n| extend HPAs = tostring(Tags.hpa), Deployment = tostring(Tags.targetName), k8sNamespace = tostring(Tags.k8sNamespace)\r\n| where HPAs == '{HPAFilter}'\r\n| where k8sNamespace in ({namespace})\r\n);\r\nlet ValData = ParsedData\r\n| make-series ValTrend = avg(Val) default=0 on TimeGenerated from {timeRange:start} to {timeRange:end} step {timeRange:grain} by k8sNamespace, HPAs;\r\nlet MinData = ParsedData\r\n| make-series MinTrend = avg(toint(Tags.spec_min_replicas)) default=0 on TimeGenerated from {timeRange:start} to {timeRange:end} step {timeRange:grain} by k8sNamespace, HPAs;\r\nlet MaxData = ParsedData\r\n| make-series MaxTrend = avg(toint(Tags.spec_max_replicas)) default=0 on TimeGenerated from {timeRange:start} to {timeRange:end} step {timeRange:grain} by k8sNamespace, HPAs;\r\nlet DesiredData = ParsedData\r\n| make-series DesiredTrend = avg(toint(Tags.status_desired_replicas)) default=0 on TimeGenerated from {timeRange:start} to {timeRange:end} step {timeRange:grain} by k8sNamespace, HPAs;\r\nParsedData\r\n| join kind = inner(ValData) on k8sNamespace, HPAs\r\n| join kind = inner(MinData) on k8sNamespace, HPAs\r\n| join kind = inner(MaxData) on k8sNamespace, HPAs\r\n| join kind = inner(DesiredData) on k8sNamespace, HPAs\r\n| top 1 by TimeGenerated\r\n| project ValTrend, MinTrend, MaxTrend, DesiredTrend, TimeGenerated1",
                    "size": 0,
                    "aggregation": 5,
                    "title": "Full view for {HPAFilter}",
                    "timeContext": {
                      "durationMs": 14400000
                    },
                    "queryType": 0,
                    "resourceType": "{resourceType}",
                    "crossComponentResources": [
                      "{resource}"
                    ],
                    "visualization": "unstackedbar",
                    "chartSettings": {
                      "seriesLabelSettings": [
                        {
                          "seriesName": "ValTrend",
                          "label": "Current Replicas"
                        },
                        {
                          "seriesName": "MinTrend",
                          "label": "Min Replicas"
                        },
                        {
                          "seriesName": "MaxTrend",
                          "label": "Max Replicas"
                        },
                        {
                          "seriesName": "DesiredTrend",
                          "label": "Desired Replicas"
                        }
                      ],
                      "ySettings": {
                        "numberFormatSettings": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "useGrouping": true
                          }
                        },
                        "min": 0
                      }
                    }
                  },
                  "conditionalVisibility": {
                    "parameterName": "HPAFilter",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "HPA Detailed"
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "selectedTab",
              "comparison": "isEqualTo",
              "value": "HPA"
            },
            "name": "hpa-tab"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "parsedDCRInfo",
        "comparison": "isEqualTo",
        "value": ""
      },
      "name": "Workbook Content"
    }
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}