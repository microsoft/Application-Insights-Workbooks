{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "# CNS: METRICS FOR IP USAGE BY DELEGATED SUBNETS\n\n<p>The following metrics depict the CNS IP usage by delegated subnets.</p>\n<p>Each of the metrics is organised by Node, and the tallies in the bottom of the metric graph is sum of the respective metric count for the selected time range.</p>\n<p>For each metric, you have the ability to select:\n* The *Interval* i.e. the time gap between metric values.\n* The *Time Range* i.e. the start time of the metric representation, till the current time.\n* The *Node* i.e. the Node you wish to see the metrics for. The default is unset, which shows all Nodes.\n</p>\n***"
      },
      "name": "text - 0"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## IPs ALLOCATED FROM SUBNET"
            },
            "name": "text - 0"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "e98a3754-f231-4fc2-a70b-36723c3378b5",
                  "version": "KqlParameterItem/1.0",
                  "name": "interval",
                  "label": "Interval",
                  "type": 2,
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "jsonData": "[\n    { \"value\":\"5m\", \"label\":\"5 mins\", \"selected\":true },\n    { \"value\":\"10m\", \"label\":\"10 mins\" },\n    { \"value\":\"15m\", \"label\":\"15 mins\" },\n    { \"value\":\"30m\", \"label\":\"30 mins\" },\n    { \"value\":\"45m\", \"label\":\"45 mins\" },\n    { \"value\":\"60m\", \"label\":\"1 hr\" },\n    { \"value\":\"720m\", \"label\":\"12 hr\" },\n    { \"value\":\"1450m\", \"label\":\"1 day\" }\n]",
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "value": "15m"
                },
                {
                  "id": "eb2e0cdb-1de8-4eb4-a20a-6c862082f3e5",
                  "version": "KqlParameterItem/1.0",
                  "name": "timeRange",
                  "type": 4,
                  "value": {
                    "durationMs": 43200000
                  },
                  "typeSettings": {
                    "selectableValues": [
                      {
                        "durationMs": 300000
                      },
                      {
                        "durationMs": 900000
                      },
                      {
                        "durationMs": 1800000
                      },
                      {
                        "durationMs": 3600000
                      },
                      {
                        "durationMs": 14400000
                      },
                      {
                        "durationMs": 43200000
                      },
                      {
                        "durationMs": 86400000
                      },
                      {
                        "durationMs": 172800000
                      },
                      {
                        "durationMs": 259200000
                      },
                      {
                        "durationMs": 604800000
                      },
                      {
                        "durationMs": 1209600000
                      },
                      {
                        "durationMs": 2419200000
                      },
                      {
                        "durationMs": 2592000000
                      },
                      {
                        "durationMs": 5184000000
                      },
                      {
                        "durationMs": 7776000000
                      }
                    ],
                    "allowCustom": true
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "label": "Time Range"
                },
                {
                  "id": "bfb869d8-d9d2-4ef3-81a3-83bab1566982",
                  "version": "KqlParameterItem/1.0",
                  "name": "hostname",
                  "label": "Node",
                  "type": 2,
                  "query": "InsightsMetrics\n| where Name contains \"cx_ipam_pod_allocated_ips\"\n| where Namespace == \"prometheus\"\n| extend jsonprop = parse_json(Tags)\n| extend hostname = tostring(jsonprop.hostName)\n| distinct hostname\n| project hostname",
                  "value": null,
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "queryType": 0,
                  "resourceType": "microsoft.containerservice/managedclusters"
                },
                {
                  "id": "38268eb9-1729-4ef7-91e7-74320263ec17",
                  "version": "KqlParameterItem/1.0",
                  "name": "hostwhereclause",
                  "type": 1,
                  "isHiddenWhenLocked": true,
                  "criteriaData": [
                    {
                      "criteriaContext": {
                        "leftOperand": "hostname",
                        "operator": "is Empty",
                        "rightValType": "static",
                        "rightVal": "''",
                        "resultValType": "static",
                        "resultVal": "| where 1 == 1"
                      }
                    },
                    {
                      "criteriaContext": {
                        "operator": "Default",
                        "resultValType": "static",
                        "resultVal": "| where HostName == '{hostname}'"
                      }
                    }
                  ],
                  "timeContext": {
                    "durationMs": 86400000
                  }
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.containerservice/managedclusters"
            },
            "name": "parameters - 2"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "InsightsMetrics\n| where TimeGenerated < {timeRange:end} and TimeGenerated >= {timeRange:start}\n| where Name == \"cx_ipam_total_ips\"\n| where Namespace == \"prometheus\"\n| extend jsonprop = parse_json(Tags)\n| extend HostName = jsonprop.hostName\n{hostwhereclause}\n| extend podnet_arm_id = jsonprop.podnet_arm_id\n| project TimeGenerated, Val, podnet_arm_id, HostName\n| summarize count = count(Val) by bin(TimeGenerated, {interval}), tostring(HostName)\n\n",
              "size": 0,
              "queryType": 0,
              "resourceType": "microsoft.containerservice/managedclusters",
              "visualization": "categoricalbar",
              "chartSettings": {
                "xAxis": "TimeGenerated",
                "group": "HostName",
                "createOtherGroup": null
              }
            },
            "name": "query - 1"
          }
        ]
      },
      "name": "group - 1"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "***\n## IPs ASSIGNED TO POD"
            },
            "name": "text - 0"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "e98a3754-f231-4fc2-a70b-36723c3378b5",
                  "version": "KqlParameterItem/1.0",
                  "name": "interval",
                  "label": "Interval",
                  "type": 2,
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "jsonData": "[\n    { \"value\":\"5m\", \"label\":\"5 mins\", \"selected\":true },\n    { \"value\":\"10m\", \"label\":\"10 mins\" },\n    { \"value\":\"15m\", \"label\":\"15 mins\" },\n    { \"value\":\"30m\", \"label\":\"30 mins\" },\n    { \"value\":\"45m\", \"label\":\"45 mins\" },\n    { \"value\":\"60m\", \"label\":\"1 hr\" },\n    { \"value\":\"720m\", \"label\":\"12 hr\" },\n    { \"value\":\"1450m\", \"label\":\"1 day\" }\n]",
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "eb2e0cdb-1de8-4eb4-a20a-6c862082f3e5",
                  "version": "KqlParameterItem/1.0",
                  "name": "timeRange",
                  "type": 4,
                  "value": {
                    "durationMs": 14400000
                  },
                  "typeSettings": {
                    "selectableValues": [
                      {
                        "durationMs": 300000
                      },
                      {
                        "durationMs": 900000
                      },
                      {
                        "durationMs": 1800000
                      },
                      {
                        "durationMs": 3600000
                      },
                      {
                        "durationMs": 14400000
                      },
                      {
                        "durationMs": 43200000
                      },
                      {
                        "durationMs": 86400000
                      },
                      {
                        "durationMs": 172800000
                      },
                      {
                        "durationMs": 259200000
                      },
                      {
                        "durationMs": 604800000
                      },
                      {
                        "durationMs": 1209600000
                      },
                      {
                        "durationMs": 2419200000
                      },
                      {
                        "durationMs": 2592000000
                      },
                      {
                        "durationMs": 5184000000
                      },
                      {
                        "durationMs": 7776000000
                      }
                    ],
                    "allowCustom": true
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "label": "Time Range"
                },
                {
                  "id": "bfb869d8-d9d2-4ef3-81a3-83bab1566982",
                  "version": "KqlParameterItem/1.0",
                  "name": "hostname",
                  "label": "Node",
                  "type": 2,
                  "query": "InsightsMetrics\n| where Name contains \"cx_ipam_pod_allocated_ips\"\n| where Namespace == \"prometheus\"\n| extend jsonprop = parse_json(Tags)\n| extend hostname = tostring(jsonprop.hostName)\n| distinct hostname\n| project hostname",
                  "value": null,
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "queryType": 0,
                  "resourceType": "microsoft.containerservice/managedclusters"
                },
                {
                  "id": "38268eb9-1729-4ef7-91e7-74320263ec17",
                  "version": "KqlParameterItem/1.0",
                  "name": "hostwhereclause",
                  "type": 1,
                  "isHiddenWhenLocked": true,
                  "criteriaData": [
                    {
                      "criteriaContext": {
                        "leftOperand": "hostname",
                        "operator": "is Empty",
                        "rightValType": "static",
                        "rightVal": "''",
                        "resultValType": "static",
                        "resultVal": "| where 1 == 1"
                      }
                    },
                    {
                      "criteriaContext": {
                        "operator": "Default",
                        "resultValType": "static",
                        "resultVal": "| where HostName == '{hostname}'"
                      }
                    }
                  ],
                  "timeContext": {
                    "durationMs": 86400000
                  }
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.containerservice/managedclusters"
            },
            "name": "parameters - 2"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "InsightsMetrics\n| where TimeGenerated < {timeRange:end} and TimeGenerated >= {timeRange:start}\n| where Name == \"cx_ipam_available_ips\"\n| where Namespace == \"prometheus\"\n| extend jsonprop = parse_json(Tags)\n| extend HostName = jsonprop.hostName\n{hostwhereclause}\n| extend podnet_arm_id = jsonprop.podnet_arm_id\n| project TimeGenerated, Val, podnet_arm_id, HostName\n| summarize count = count(Val) by bin(TimeGenerated, {interval}), tostring(HostName)\n\n",
              "size": 0,
              "queryType": 0,
              "resourceType": "microsoft.containerservice/managedclusters",
              "visualization": "categoricalbar",
              "chartSettings": {
                "xAxis": "TimeGenerated",
                "group": "HostName",
                "createOtherGroup": null
              }
            },
            "name": "query - 1"
          }
        ]
      },
      "name": "group - 2"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "***\n## IPs RESERVED FOR FUTURE PODs"
            },
            "name": "text - 0"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "e98a3754-f231-4fc2-a70b-36723c3378b5",
                  "version": "KqlParameterItem/1.0",
                  "name": "interval",
                  "label": "Interval",
                  "type": 2,
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "jsonData": "[\n    { \"value\":\"5m\", \"label\":\"5 mins\", \"selected\":true },\n    { \"value\":\"10m\", \"label\":\"10 mins\" },\n    { \"value\":\"15m\", \"label\":\"15 mins\" },\n    { \"value\":\"30m\", \"label\":\"30 mins\" },\n    { \"value\":\"45m\", \"label\":\"45 mins\" },\n    { \"value\":\"60m\", \"label\":\"1 hr\" },\n    { \"value\":\"720m\", \"label\":\"12 hr\" },\n    { \"value\":\"1450m\", \"label\":\"1 day\" }\n]",
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "value": "15m"
                },
                {
                  "id": "eb2e0cdb-1de8-4eb4-a20a-6c862082f3e5",
                  "version": "KqlParameterItem/1.0",
                  "name": "timeRange",
                  "type": 4,
                  "value": {
                    "durationMs": 14400000
                  },
                  "typeSettings": {
                    "selectableValues": [
                      {
                        "durationMs": 300000
                      },
                      {
                        "durationMs": 900000
                      },
                      {
                        "durationMs": 1800000
                      },
                      {
                        "durationMs": 3600000
                      },
                      {
                        "durationMs": 14400000
                      },
                      {
                        "durationMs": 43200000
                      },
                      {
                        "durationMs": 86400000
                      },
                      {
                        "durationMs": 172800000
                      },
                      {
                        "durationMs": 259200000
                      },
                      {
                        "durationMs": 604800000
                      },
                      {
                        "durationMs": 1209600000
                      },
                      {
                        "durationMs": 2419200000
                      },
                      {
                        "durationMs": 2592000000
                      },
                      {
                        "durationMs": 5184000000
                      },
                      {
                        "durationMs": 7776000000
                      }
                    ],
                    "allowCustom": true
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "label": "Time Range"
                },
                {
                  "id": "bfb869d8-d9d2-4ef3-81a3-83bab1566982",
                  "version": "KqlParameterItem/1.0",
                  "name": "hostname",
                  "label": "Node",
                  "type": 2,
                  "query": "InsightsMetrics\n| where Name contains \"cx_ipam_pod_allocated_ips\"\n| where Namespace == \"prometheus\"\n| extend jsonprop = parse_json(Tags)\n| extend hostname = tostring(jsonprop.hostName)\n| distinct hostname\n| project hostname",
                  "value": null,
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "queryType": 0,
                  "resourceType": "microsoft.containerservice/managedclusters"
                },
                {
                  "id": "38268eb9-1729-4ef7-91e7-74320263ec17",
                  "version": "KqlParameterItem/1.0",
                  "name": "hostwhereclause",
                  "type": 1,
                  "isHiddenWhenLocked": true,
                  "criteriaData": [
                    {
                      "criteriaContext": {
                        "leftOperand": "hostname",
                        "operator": "is Empty",
                        "rightValType": "static",
                        "rightVal": "''",
                        "resultValType": "static",
                        "resultVal": "| where 1 == 1"
                      }
                    },
                    {
                      "criteriaContext": {
                        "operator": "Default",
                        "resultValType": "static",
                        "resultVal": "| where HostName == '{hostname}'"
                      }
                    }
                  ],
                  "timeContext": {
                    "durationMs": 86400000
                  }
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.containerservice/managedclusters"
            },
            "name": "parameters - 2"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "InsightsMetrics\n| where TimeGenerated < {timeRange:end} and TimeGenerated >= {timeRange:start}\n| where Name == \"cx_ipam_pod_allocated_ips\"\n| where Namespace == \"prometheus\"\n| extend jsonprop = parse_json(Tags)\n| extend HostName = jsonprop.hostName\n{hostwhereclause}\n| extend podnet_arm_id = jsonprop.podnet_arm_id\n| project TimeGenerated, Val, podnet_arm_id, HostName\n| summarize count = count(Val) by bin(TimeGenerated, {interval}), tostring(HostName)\n\n",
              "size": 0,
              "queryType": 0,
              "resourceType": "microsoft.containerservice/managedclusters",
              "visualization": "categoricalbar",
              "chartSettings": {
                "xAxis": "TimeGenerated",
                "group": "HostName",
                "createOtherGroup": null
              }
            },
            "name": "query - 1"
          }
        ]
      },
      "name": "group - 3"
    }
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}