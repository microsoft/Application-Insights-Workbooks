{
    "version": "Notebook/1.0",
    "items": [
      {
        "type": 12,
        "content": {
          "version": "NotebookGroup/1.0",
          "groupType": "editable",
          "items": [
            {
              "type": 1,
              "content": {
                "json": "# User Facing Diagnostics \nUFDs help identify issues that may affect call quality for users. They provide a way to examine various properties of a call to determine potential problems, such as poor network conditions or a muted microphone. When a User Facing Diagnostic event is triggered, it indicates that there may be an underlying issue impacting the user's experience. However, it's important to note that the output from User Facing Diagnostics is informational only and does not alter the calling stack or make any changes based on the diagnostics fired\n",
                "style": "info"
              },
              "name": "text - 0"
            },
            {
              "type": 1,
              "content": {
                "json": "Please note that all presented numbers in all the following visuals may be different from billing record, they are created with server and client logs, which may be prone to data loss"
              },
              "name": "disclaimer"
            },
            {
              "type": 9,
              "content": {
                "version": "KqlParameterItem/1.0",
                "parameters": [
                  {
                    "id": "7ba0f6c1-8f8c-447a-b616-25e6f748fc7e",
                    "version": "KqlParameterItem/1.0",
                    "name": "TimeRange",
                    "type": 4,
                    "description": "Define a time range to aggregate logs over",
                    "isRequired": true,
                    "typeSettings": {
                      "selectableValues": [
                        {
                          "durationMs": 300000
                        },
                        {
                          "durationMs": 900000
                        },
                        {
                          "durationMs": 1800000
                        },
                        {
                          "durationMs": 3600000
                        },
                        {
                          "durationMs": 14400000
                        },
                        {
                          "durationMs": 43200000
                        },
                        {
                          "durationMs": 86400000
                        },
                        {
                          "durationMs": 172800000
                        },
                        {
                          "durationMs": 259200000
                        },
                        {
                          "durationMs": 604800000
                        },
                        {
                          "durationMs": 1209600000
                        },
                        {
                          "durationMs": 2419200000
                        },
                        {
                          "durationMs": 2592000000
                        },
                        {
                          "durationMs": 5184000000
                        },
                        {
                          "durationMs": 7776000000
                        }
                      ],
                      "allowCustom": true
                    },
                    "value": {
                      "durationMs": 1209600000
                    },
                    "label": "Time Range"
                  },
                  {
                    "id": "8caaee6d-fdf7-450f-bcdf-7625dbfc35b8",
                    "version": "KqlParameterItem/1.0",
                    "name": "timeGranularity",
                    "label": "Duration Unit",
                    "type": 2,
                    "description": "Choose the time granularity to use to aggregate logs",
                    "isRequired": true,
                    "typeSettings": {
                      "additionalResourceOptions": [],
                      "showDefault": false
                    },
                    "jsonData": "[\n    { \"value\":\"bin(TimestampBin,startofday(TimestampBin))\", \"label\":\"Daily\" },\n    { \"value\":\"bin(TimestampBin,startofweek(TimestampBin))\", \"label\":\"Weekly\",\"selected\":true },\n    { \"value\":\"bin(TimestampBin,startofmonth(TimestampBin))\", \"label\":\"Monthly\" }\n]",
                    "value": "bin(TimestampBin,startofday(TimestampBin))"
                  },
                  {
                    "id": "93c44480-7e8c-495d-a7ed-d299c069c152",
                    "version": "KqlParameterItem/1.0",
                    "name": "DiagnosticChangedName",
                    "label": "Diagnostic Changed",
                    "type": 2,
                    "query": "let metricName_to_ufdDisplayName = (metricName:string) { \n     case( \n        metricName == 'reliability/api/UFD/recovery/NetworkReceiveQuality', 'NetworkReceiveQuality',\n        metricName == 'reliability/api/UFD/recovery/NetworkReconnect', 'NetworkReconnect',\n        metricName == 'reliability/api/UFD/recovery/NetworkSendQuality', 'NetworkSendQuality',\n        metricName == 'reliability/api/UFD/recovery/CameraStoppedUnexpectedly', 'CameraStoppedUnexpectedly',\n        metricName == 'reliability/api/UFD/recovery/MicrophoneNotFunctioning', 'MicrophoneNotFunctioning',\n        metricName == 'reliability/api/UFD/recovery/CameraFreeze', 'CameraFreeze',\n        metricName == 'reliability/api/UFD/recovery/MicrophonePermissionDenied', 'MicrophonePermissionDenied',\n        metricName == 'reliability/api/UFD/recovery/CameraPermissionDenied', 'CameraPermissionDenied',\n        metricName == 'reliability/api/UFD/recovery/CameraStartFailed', 'CameraStartFailed',\n        metricName == 'reliability/api/UFD/recovery/MicrophoneMuteUnexpectedly', 'MicrophoneMuteUnexpectedly',\n        metricName == 'reliability/api/UFD/recovery/NoSpeakerDevicesEnumerated', 'NoSpeakerDevicesEnumerated',\n        metricName == 'reliability/api/UFD/recovery/NoMicrophoneDevicesEnumerated', 'NoMicrophoneDevicesEnumerated',\n        ''\n    ) \n};\nACSCallingMetrics\n| distinct MetricName\n| where MetricName contains \"recovery\" and MetricName contains_cs \"UFD\"\n| extend ufd = metricName_to_ufdDisplayName(MetricName)\n| where isnotempty(ufd)\n| project ufd\n\n",
                    "typeSettings": {
                      "additionalResourceOptions": [],
                      "showDefault": false
                    },
                    "timeContext": {
                      "durationMs": 0
                    },
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.communication/communicationservices",
                    "value": null
                  },
                  {
                    "id": "9cad1f8e-5dd7-4caf-9ea8-ec97b41c7627",
                    "version": "KqlParameterItem/1.0",
                    "name": "SDKVersion",
                    "label": "SDK Version",
                    "type": 2,
                    "multiSelect": true,
                    "quote": "'",
                    "delimiter": ",",
                    "query": "ACSCallingMetrics\n| distinct SdkVersion\n",
                    "typeSettings": {
                      "additionalResourceOptions": [
                        "value::all"
                      ],
                      "selectAllValue": "[]",
                      "showDefault": false
                    },
                    "timeContext": {
                      "durationMs": 1209600000
                    },
                    "timeContextFromParameter": "TimeRange",
                    "defaultValue": "value::all",
                    "queryType": 0,
                    "resourceType": "microsoft.communication/communicationservices"
                  },
                  {
                    "id": "7c2c7f1d-cc5c-4fe6-8812-fa9852ea0b79",
                    "version": "KqlParameterItem/1.0",
                    "name": "platform",
                    "label": "SDK Platform",
                    "type": 2,
                    "multiSelect": true,
                    "quote": "'",
                    "delimiter": ",",
                    "query": "ACSCallingMetrics\n| distinct Platform",
                    "typeSettings": {
                      "additionalResourceOptions": [
                        "value::all"
                      ],
                      "selectAllValue": "[]"
                    },
                    "timeContext": {
                      "durationMs": 0
                    },
                    "timeContextFromParameter": "TimeRange",
                    "defaultValue": "value::all",
                    "queryType": 0,
                    "resourceType": "microsoft.communication/communicationservices"
                  },
                  {
                    "id": "06a757f9-a406-4a08-873a-812efeecb3ba",
                    "version": "KqlParameterItem/1.0",
                    "name": "ResultType",
                    "label": "Result Category",
                    "type": 2,
                    "multiSelect": true,
                    "quote": "'",
                    "delimiter": ",",
                    "query": "ACSCallingMetrics\n| distinct ResultType",
                    "typeSettings": {
                      "additionalResourceOptions": [
                        "value::all"
                      ],
                      "selectAllValue": "[]"
                    },
                    "timeContext": {
                      "durationMs": 0
                    },
                    "timeContextFromParameter": "TimeRange",
                    "defaultValue": "value::all",
                    "queryType": 0,
                    "resourceType": "microsoft.communication/communicationservices"
                  }
                ],
                "style": "pills",
                "queryType": 0,
                "resourceType": "microsoft.communication/communicationservices"
              },
              "name": "reliability parameter"
            },
            {
              "type": 1,
              "content": {
                "json": "Ask Copilot for help by selecting UFD in the table below",
                "style": "info"
              },
              "name": "text - 4"
            },
            {
              "type": 12,
              "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                  {
                    "type": 3,
                    "content": {
                      "version": "KqlItem/1.0",
                      "query": "let metricName_to_ufdDisplayName = (metricName:string) { \n     case( \n        metricName == 'reliability/api/UFD/recovery/NetworkReceiveQuality', 'NetworkReceiveQuality',\n        metricName == 'reliability/api/UFD/recovery/NetworkReconnect', 'NetworkReconnect',\n        metricName == 'reliability/api/UFD/recovery/NetworkSendQuality', 'NetworkSendQuality',\n        metricName == 'reliability/api/UFD/recovery/CameraStoppedUnexpectedly', 'CameraStoppedUnexpectedly',\n        metricName == 'reliability/api/UFD/recovery/MicrophoneNotFunctioning', 'MicrophoneNotFunctioning',\n        metricName == 'reliability/api/UFD/recovery/CameraFreeze', 'CameraFreeze',\n        metricName == 'reliability/api/UFD/recovery/MicrophonePermissionDenied', 'MicrophonePermissionDenied',\n        metricName == 'reliability/api/UFD/recovery/CameraPermissionDenied', 'CameraPermissionDenied',\n        metricName == 'reliability/api/UFD/recovery/CameraStartFailed', 'CameraStartFailed',\n        metricName == 'reliability/api/UFD/recovery/MicrophoneMuteUnexpectedly', 'MicrophoneMuteUnexpectedly',\n        metricName == 'reliability/api/UFD/recovery/NoSpeakerDevicesEnumerated', 'NoSpeakerDevicesEnumerated',\n        metricName == 'reliability/api/UFD/recovery/NoMicrophoneDevicesEnumerated', 'NoMicrophoneDevicesEnumerated',\n        ''\n    ) \n};\nlet sdkversion_selection = dynamic([{SDKVersion}]);\nlet resultType_selection = dynamic([{ResultType}]);\nlet platform_selection = dynamic([{platform}]);\nlet ufd_volume = \nACSCallingMetrics\n| extend UFD = metricName_to_ufdDisplayName(MetricName)\n| where isnotempty(UFD)\n| where array_length(sdkversion_selection) == 0 or SdkVersion in (sdkversion_selection)\n| where array_length(resultType_selection) == 0 or ResultType in (resultType_selection)\n| where array_length(platform_selection) == 0 or Platform in (platform_selection)\n| summarize arg_max(TimestampMax, *) by \n    MetricName, \n    DeviceBrowser, \n    DeviceOsName, \n    DeviceBrowserVersionMajor,\n    DeviceBrowserVersionMinor, \n    DeviceOsVersionMajor, \n    DeviceOsVersionMinor,\n    SdkVersion,\n    DeviceFamily, \n    DeviceBrand, \n    DeviceModel,\n    ResultType, \n    SubCode, \n    TimestampBin, \n    CallType,\n    Platform\n| summarize volume = sum(LegsDcount) by TimestampBin=format_datetime({timeGranularity}, \"yyyy-MM-dd \"), UFD\n| order by UFD, TimestampBin asc;\nlet ufd_recovery_rate =\nACSCallingMetrics\n| extend UFD = metricName_to_ufdDisplayName(MetricName)\n| where isnotempty(UFD)\n| where array_length(sdkversion_selection) == 0 or SdkVersion in (sdkversion_selection)\n| where array_length(resultType_selection) == 0 or ResultType in (resultType_selection)\n| where array_length(platform_selection) == 0 or Platform in (platform_selection)\n| summarize arg_max(TimestampMax, *) by \n    MetricName, \n    DeviceBrowser, \n    DeviceOsName, \n    DeviceBrowserVersionMajor,\n    DeviceBrowserVersionMinor, \n    DeviceOsVersionMajor, \n    DeviceOsVersionMinor,\n    SdkVersion,\n    DeviceFamily, \n    DeviceBrand, \n    DeviceModel,\n    ResultType, \n    SubCode, \n    TimestampBin, \n    CallType,\n    Platform\n| summarize success_rate = round(sum(SuccessLegsDcount)*100.0/sum(LegsDcount),4) by TimestampBin=format_datetime({timeGranularity}, \"yyyy-MM-dd \"), UFD\n| order by UFD, TimestampBin asc;\nlet pivot_total =\nufd_volume\n| evaluate pivot(TimestampBin, sum(volume), UFD);\nlet pivot_recovery_rate =\nufd_recovery_rate\n| evaluate pivot(TimestampBin, sum(success_rate), UFD);\npivot_total\n| join kind=inner pivot_recovery_rate on UFD\n| project-away UFD1\n| project PackedRecord = todynamic\n    (\n        replace_strings(\n            tostring(pack_all()),\n            dynamic([' 1', ' ']),\n            dynamic([' Recovery Rate', ' Volume'])\n        )\n    )\n| evaluate bag_unpack(PackedRecord)\n| extend copilot_prompt = strcat('In my Azure Communication Resources, what ', UFD, ' is in User Facing Diagnostics and how I could subscribe to the diagnosticChanged event to monitor when any user-facing diagnostic changes. Can you share how I can fix it?')\n| extend Copilot = 'Ask Copilot for help'\n| project-reorder UFD, Copilot, ['20*'] desc",
                      "size": 0,
                      "title": "UFDs Overview",
                      "timeContextFromParameter": "TimeRange",
                      "queryType": 0,
                      "resourceType": "microsoft.communication/communicationservices",
                      "gridSettings": {
                        "formatters": [
                          {
                            "columnMatch": "Copilot",
                            "formatter": 7,
                            "formatOptions": {
                              "linkTarget": "CopilotNudge",
                              "copilotNudgeActionSettings": {
                                "nudgeContent": "[\"copilot_prompt\"]"
                              }
                            }
                          },
                          {
                            "columnMatch": "2025-02-02 Recovery Rate",
                            "formatter": 0,
                            "numberFormat": {
                              "unit": 1,
                              "options": {
                                "style": "decimal"
                              }
                            }
                          },
                          {
                            "columnMatch": "2025-01-26 Recovery Rate",
                            "formatter": 0,
                            "numberFormat": {
                              "unit": 1,
                              "options": {
                                "style": "decimal"
                              }
                            }
                          },
                          {
                            "columnMatch": "2025-01-19 Recovery Rate",
                            "formatter": 0,
                            "numberFormat": {
                              "unit": 1,
                              "options": {
                                "style": "decimal"
                              }
                            }
                          },
                          {
                            "columnMatch": "metricName",
                            "formatter": 5
                          },
                          {
                            "columnMatch": "copilot_prompt",
                            "formatter": 5
                          },
                          {
                            "columnMatch": "2025-01-05 Recovery Rate",
                            "formatter": 0,
                            "numberFormat": {
                              "unit": 1,
                              "options": {
                                "style": "decimal"
                              }
                            }
                          },
                          {
                            "columnMatch": "2024-12-29 Recovery Rate",
                            "formatter": 0,
                            "numberFormat": {
                              "unit": 1,
                              "options": {
                                "style": "decimal"
                              }
                            }
                          },
                          {
                            "columnMatch": "Recovery Rate",
                            "formatter": 0,
                            "numberFormat": {
                              "unit": 1,
                              "options": {
                                "style": "decimal"
                              }
                            }
                          }
                        ]
                      }
                    },
                    "name": "ufd recovery rate"
                  },
                  {
                    "type": 3,
                    "content": {
                      "version": "KqlItem/1.0",
                      "query": "let metricName_to_ufdDisplayName = (metricName:string) { \n     case( \n        metricName == 'reliability/api/UFD/recovery/NetworkReceiveQuality', 'NetworkReceiveQuality',\n        metricName == 'reliability/api/UFD/recovery/NetworkReconnect', 'NetworkReconnect',\n        metricName == 'reliability/api/UFD/recovery/NetworkSendQuality', 'NetworkSendQuality',\n        metricName == 'reliability/api/UFD/recovery/CameraStoppedUnexpectedly', 'CameraStoppedUnexpectedly',\n        metricName == 'reliability/api/UFD/recovery/MicrophoneNotFunctioning', 'MicrophoneNotFunctioning',\n        metricName == 'reliability/api/UFD/recovery/CameraFreeze', 'CameraFreeze',\n        metricName == 'reliability/api/UFD/recovery/MicrophonePermissionDenied', 'MicrophonePermissionDenied',\n        metricName == 'reliability/api/UFD/recovery/CameraPermissionDenied', 'CameraPermissionDenied',\n        metricName == 'reliability/api/UFD/recovery/CameraStartFailed', 'CameraStartFailed',\n        metricName == 'reliability/api/UFD/recovery/MicrophoneMuteUnexpectedly', 'MicrophoneMuteUnexpectedly',\n        metricName == 'reliability/api/UFD/recovery/NoSpeakerDevicesEnumerated', 'NoSpeakerDevicesEnumerated',\n        metricName == 'reliability/api/UFD/recovery/NoMicrophoneDevicesEnumerated', 'NoMicrophoneDevicesEnumerated',\n        ''\n    ) \n};\nlet sdkversion_selection = dynamic([{SDKVersion}]);\nlet resultType_selection = dynamic([{ResultType}]);\nlet platform_selection = dynamic([{platform}]);\nACSCallingMetrics\n| extend UFD = metricName_to_ufdDisplayName(MetricName)\n| where isnotempty(UFD)\n| where array_length(sdkversion_selection) == 0 or SdkVersion in (sdkversion_selection)\n| where array_length(resultType_selection) == 0 or ResultType in (resultType_selection)\n| where array_length(platform_selection) == 0 or Platform in (platform_selection) \n| summarize arg_max(TimestampMax, *) by \n    MetricName, \n    DeviceBrowser, \n    DeviceOsName, \n    DeviceBrowserVersionMajor,\n    DeviceBrowserVersionMinor, \n    DeviceOsVersionMajor, \n    DeviceOsVersionMinor,\n    SdkVersion,\n    DeviceFamily, \n    DeviceBrand, \n    DeviceModel,\n    ResultType, \n    SubCode, \n    TimestampBin, \n    CallType,\n    Platform\n| summarize ['Recovery Rate'] = round(sum(SuccessLegsDcount)*100.0/sum(LegsDcount),4) by TimestampBin={timeGranularity}, UFD\n| order by UFD, TimestampBin asc;\n",
                      "size": 0,
                      "aggregation": 3,
                      "title": "UFDs recovery rate over time",
                      "timeContextFromParameter": "TimeRange",
                      "queryType": 0,
                      "resourceType": "microsoft.communication/communicationservices",
                      "visualization": "timechart",
                      "chartSettings": {
                        "xAxis": "TimestampBin",
                        "yAxis": [
                          "Recovery Rate"
                        ],
                        "showLegend": true,
                        "showDataPoints": true,
                        "ySettings": {
                          "numberFormatSettings": {
                            "unit": 1,
                            "options": {
                              "style": "decimal",
                              "useGrouping": true,
                              "maximumFractionDigits": 2
                            }
                          }
                        }
                      }
                    },
                    "name": "ufd recovery rate timeseries"
                  }
                ]
              },
              "conditionalVisibility": {
                "parameterName": "DiagnosticChangedName",
                "comparison": "isEqualTo",
                "value": ""
              },
              "name": "overview"
            },
            {
              "type": 12,
              "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                  {
                    "type": 3,
                    "content": {
                      "version": "KqlItem/1.0",
                      "query": "let metricName_to_ufdDisplayName = (metricName:string) { \n     case( \n        metricName == 'reliability/api/UFD/recovery/NetworkReceiveQuality', 'NetworkReceiveQuality',\n        metricName == 'reliability/api/UFD/recovery/NetworkReconnect', 'NetworkReconnect',\n        metricName == 'reliability/api/UFD/recovery/NetworkSendQuality', 'NetworkSendQuality',\n        metricName == 'reliability/api/UFD/recovery/CameraStoppedUnexpectedly', 'CameraStoppedUnexpectedly',\n        metricName == 'reliability/api/UFD/recovery/MicrophoneNotFunctioning', 'MicrophoneNotFunctioning',\n        metricName == 'reliability/api/UFD/recovery/CameraFreeze', 'CameraFreeze',\n        metricName == 'reliability/api/UFD/recovery/MicrophonePermissionDenied', 'MicrophonePermissionDenied',\n        metricName == 'reliability/api/UFD/recovery/CameraPermissionDenied', 'CameraPermissionDenied',\n        metricName == 'reliability/api/UFD/recovery/CameraStartFailed', 'CameraStartFailed',\n        metricName == 'reliability/api/UFD/recovery/MicrophoneMuteUnexpectedly', 'MicrophoneMuteUnexpectedly',\n        metricName == 'reliability/api/UFD/recovery/NoSpeakerDevicesEnumerated', 'NoSpeakerDevicesEnumerated',\n        metricName == 'reliability/api/UFD/recovery/NoMicrophoneDevicesEnumerated', 'NoMicrophoneDevicesEnumerated',\n        ''\n    ) \n};\nlet sdkversion_selection = dynamic([{SDKVersion}]);\nlet resultType_selection = dynamic([{ResultType}]);\nlet platform_selection = dynamic([{platform}]);\nlet selected_ufd = dynamic('{DiagnosticChangedName}');\nACSCallingMetrics\n| extend UFD = metricName_to_ufdDisplayName(MetricName)\n| where isnotempty(UFD)\n| where UFD == selected_ufd\n| where array_length(sdkversion_selection) == 0 or SdkVersion in (sdkversion_selection)\n| where array_length(resultType_selection) == 0 or ResultType in (resultType_selection)\n| where array_length(platform_selection) == 0 or Platform in (platform_selection) \n| summarize arg_max(TimestampMax, *) by \n    MetricName, \n    DeviceBrowser, \n    DeviceOsName, \n    DeviceBrowserVersionMajor,\n    DeviceBrowserVersionMinor, \n    DeviceOsVersionMajor, \n    DeviceOsVersionMinor,\n    SdkVersion,\n    DeviceFamily, \n    DeviceBrand, \n    DeviceModel,\n    ResultType, \n    SubCode, \n    TimestampBin, \n    CallType,\n    Platform\n| summarize volume = sum(LegsDcount), recovered = sum(SuccessLegsDcount), bad = sum(FailedLegsDcount), ['recovery rate'] = round(sum(SuccessLegsDcount)*100.0/sum(LegsDcount),4) by TimestampBin={timeGranularity}\n| order by TimestampBin asc;\n",
                      "size": 0,
                      "aggregation": 3,
                      "title": "{DiagnosticChangedName} Recovery Rate in {timeGranularity:label} bucket",
                      "timeContextFromParameter": "TimeRange",
                      "queryType": 0,
                      "resourceType": "microsoft.communication/communicationservices",
                      "gridSettings": {
                        "formatters": [
                          {
                            "columnMatch": "UFD",
                            "formatter": 7,
                            "formatOptions": {
                              "linkTarget": "CopilotNudge",
                              "copilotNudgeActionSettings": {
                                "nudgeContent": "Can you share how in my Azure Communication Resource what [\"UFD\"] is in User Facing Diagnostics and how I could subscribe to the diagnosticChanged event to monitor when any user-facing diagnostic changes. Can you share why these should be shown to the user in the application?"
                              }
                            }
                          },
                          {
                            "columnMatch": "recovery rate",
                            "formatter": 0,
                            "numberFormat": {
                              "unit": 1,
                              "options": {
                                "style": "decimal",
                                "maximumFractionDigits": 4
                              }
                            }
                          },
                          {
                            "columnMatch": "Recovery rate",
                            "formatter": 0,
                            "numberFormat": {
                              "unit": 1,
                              "options": {
                                "style": "decimal"
                              }
                            }
                          },
                          {
                            "columnMatch": "Total",
                            "formatter": 4,
                            "formatOptions": {
                              "palette": "amethyst"
                            }
                          },
                          {
                            "columnMatch": "DiagnosticChanged",
                            "formatter": 7,
                            "formatOptions": {
                              "linkTarget": "CopilotNudge",
                              "copilotNudgeActionSettings": {
                                "nudgeContent": "Can you share in my Azure Communication resource what [\"DiagnosticChanged\"] is in User Facing Diagnostics and how I could subscribe to the diagnosticChanged event to monitor when any user-facing diagnostic changes? Can you share why these should be shown to the user in the application?"
                              }
                            }
                          }
                        ]
                      }
                    },
                    "customWidth": "50",
                    "name": "ufd recovery rate"
                  },
                  {
                    "type": 3,
                    "content": {
                      "version": "KqlItem/1.0",
                      "query": "let metricName_to_ufdDisplayName = (metricName:string) { \n     case( \n        metricName == 'reliability/api/UFD/recovery/NetworkReceiveQuality', 'NetworkReceiveQuality',\n        metricName == 'reliability/api/UFD/recovery/NetworkReconnect', 'NetworkReconnect',\n        metricName == 'reliability/api/UFD/recovery/NetworkSendQuality', 'NetworkSendQuality',\n        metricName == 'reliability/api/UFD/recovery/CameraStoppedUnexpectedly', 'CameraStoppedUnexpectedly',\n        metricName == 'reliability/api/UFD/recovery/MicrophoneNotFunctioning', 'MicrophoneNotFunctioning',\n        metricName == 'reliability/api/UFD/recovery/CameraFreeze', 'CameraFreeze',\n        metricName == 'reliability/api/UFD/recovery/MicrophonePermissionDenied', 'MicrophonePermissionDenied',\n        metricName == 'reliability/api/UFD/recovery/CameraPermissionDenied', 'CameraPermissionDenied',\n        metricName == 'reliability/api/UFD/recovery/CameraStartFailed', 'CameraStartFailed',\n        metricName == 'reliability/api/UFD/recovery/MicrophoneMuteUnexpectedly', 'MicrophoneMuteUnexpectedly',\n        metricName == 'reliability/api/UFD/recovery/NoSpeakerDevicesEnumerated', 'NoSpeakerDevicesEnumerated',\n        metricName == 'reliability/api/UFD/recovery/NoMicrophoneDevicesEnumerated', 'NoMicrophoneDevicesEnumerated',\n        ''\n    ) \n};\nlet sdkversion_selection = dynamic([{SDKVersion}]);\nlet resultType_selection = dynamic([{ResultType}]);\nlet platform_selection = dynamic([{platform}]);\nlet selected_ufd = dynamic('{DiagnosticChangedName}');\nACSCallingMetrics\n| extend UFD = metricName_to_ufdDisplayName(MetricName)\n| where isnotempty(UFD)\n| where UFD == selected_ufd\n| where array_length(sdkversion_selection) == 0 or SdkVersion in (sdkversion_selection)\n| where array_length(resultType_selection) == 0 or ResultType in (resultType_selection)\n| where array_length(platform_selection) == 0 or Platform in (platform_selection) \n| summarize arg_max(TimestampMax, *) by \n    MetricName, \n    DeviceBrowser, \n    DeviceOsName, \n    DeviceBrowserVersionMajor,\n    DeviceBrowserVersionMinor, \n    DeviceOsVersionMajor, \n    DeviceOsVersionMinor,\n    SdkVersion,\n    DeviceFamily, \n    DeviceBrand, \n    DeviceModel,\n    ResultType, \n    SubCode, \n    TimestampBin, \n    CallType,\n    Platform\n| summarize recovered = sum(SuccessLegsDcount), bad = sum(FailedLegsDcount) by TimestampBin={timeGranularity}\n| order by TimestampBin asc;\n",
                      "size": 0,
                      "aggregation": 3,
                      "title": "{DiagnosticChangedName} Volume over time ",
                      "timeContextFromParameter": "TimeRange",
                      "queryType": 0,
                      "resourceType": "microsoft.communication/communicationservices",
                      "visualization": "timechart",
                      "chartSettings": {
                        "xAxis": "TimestampBin",
                        "yAxis": [
                          "bad",
                          "recovered"
                        ],
                        "showDataPoints": true
                      }
                    },
                    "customWidth": "50",
                    "name": "ufd recovery rate timeseries"
                  },
                  {
                    "type": 3,
                    "content": {
                      "version": "KqlItem/1.0",
                      "query": "let metricName_to_ufdDisplayName = (metricName:string) { \n     case( \n        metricName == 'reliability/api/UFD/recovery/NetworkReceiveQuality', 'NetworkReceiveQuality',\n        metricName == 'reliability/api/UFD/recovery/NetworkReconnect', 'NetworkReconnect',\n        metricName == 'reliability/api/UFD/recovery/NetworkSendQuality', 'NetworkSendQuality',\n        metricName == 'reliability/api/UFD/recovery/CameraStoppedUnexpectedly', 'CameraStoppedUnexpectedly',\n        metricName == 'reliability/api/UFD/recovery/MicrophoneNotFunctioning', 'MicrophoneNotFunctioning',\n        metricName == 'reliability/api/UFD/recovery/CameraFreeze', 'CameraFreeze',\n        metricName == 'reliability/api/UFD/recovery/MicrophonePermissionDenied', 'MicrophonePermissionDenied',\n        metricName == 'reliability/api/UFD/recovery/CameraPermissionDenied', 'CameraPermissionDenied',\n        metricName == 'reliability/api/UFD/recovery/CameraStartFailed', 'CameraStartFailed',\n        metricName == 'reliability/api/UFD/recovery/MicrophoneMuteUnexpectedly', 'MicrophoneMuteUnexpectedly',\n        metricName == 'reliability/api/UFD/recovery/NoSpeakerDevicesEnumerated', 'NoSpeakerDevicesEnumerated',\n        metricName == 'reliability/api/UFD/recovery/NoMicrophoneDevicesEnumerated', 'NoMicrophoneDevicesEnumerated',\n        ''\n    ) \n};\nlet sdkversion_selection = dynamic([{SDKVersion}]);\nlet resultType_selection = dynamic([{ResultType}]);\nlet platform_selection = dynamic([{platform}]);\nlet selected_ufd = dynamic('{DiagnosticChangedName}');\nACSCallingMetrics\n| extend UFD = metricName_to_ufdDisplayName(MetricName)\n| where isnotempty(UFD)\n| where UFD == selected_ufd\n| where array_length(sdkversion_selection) == 0 or SdkVersion in (sdkversion_selection)\n| where array_length(resultType_selection) == 0 or ResultType in (resultType_selection)\n| where array_length(platform_selection) == 0 or Platform in (platform_selection) \n| summarize arg_max(TimestampMax, *) by \n    MetricName, \n    DeviceBrowser, \n    DeviceOsName, \n    DeviceBrowserVersionMajor,\n    DeviceBrowserVersionMinor, \n    DeviceOsVersionMajor, \n    DeviceOsVersionMinor,\n    SdkVersion,\n    DeviceFamily, \n    DeviceBrand, \n    DeviceModel,\n    ResultType, \n    SubCode, \n    TimestampBin, \n    CallType,\n    Platform\n| summarize count() by SdkVersion\n",
                      "size": 1,
                      "title": "{DiagnosticChangedName} by SDK Version",
                      "timeContextFromParameter": "TimeRange",
                      "queryType": 0,
                      "resourceType": "microsoft.communication/communicationservices",
                      "visualization": "piechart"
                    },
                    "customWidth": "50",
                    "name": "UFD breakdown 1"
                  },
                  {
                    "type": 3,
                    "content": {
                      "version": "KqlItem/1.0",
                      "query": "let metricName_to_ufdDisplayName = (metricName:string) { \n     case( \n        metricName == 'reliability/api/UFD/recovery/NetworkReceiveQuality', 'NetworkReceiveQuality',\n        metricName == 'reliability/api/UFD/recovery/NetworkReconnect', 'NetworkReconnect',\n        metricName == 'reliability/api/UFD/recovery/NetworkSendQuality', 'NetworkSendQuality',\n        metricName == 'reliability/api/UFD/recovery/CameraStoppedUnexpectedly', 'CameraStoppedUnexpectedly',\n        metricName == 'reliability/api/UFD/recovery/MicrophoneNotFunctioning', 'MicrophoneNotFunctioning',\n        metricName == 'reliability/api/UFD/recovery/CameraFreeze', 'CameraFreeze',\n        metricName == 'reliability/api/UFD/recovery/MicrophonePermissionDenied', 'MicrophonePermissionDenied',\n        metricName == 'reliability/api/UFD/recovery/CameraPermissionDenied', 'CameraPermissionDenied',\n        metricName == 'reliability/api/UFD/recovery/CameraStartFailed', 'CameraStartFailed',\n        metricName == 'reliability/api/UFD/recovery/MicrophoneMuteUnexpectedly', 'MicrophoneMuteUnexpectedly',\n        metricName == 'reliability/api/UFD/recovery/NoSpeakerDevicesEnumerated', 'NoSpeakerDevicesEnumerated',\n        metricName == 'reliability/api/UFD/recovery/NoMicrophoneDevicesEnumerated', 'NoMicrophoneDevicesEnumerated',\n        ''\n    ) \n};\nlet sdkversion_selection = dynamic([{SDKVersion}]);\nlet resultType_selection = dynamic([{ResultType}]);\nlet platform_selection = dynamic([{platform}]);\nlet selected_ufd = dynamic('{DiagnosticChangedName}');\nACSCallingMetrics\n| extend UFD = metricName_to_ufdDisplayName(MetricName)\n| where isnotempty(UFD)\n| where UFD == selected_ufd\n| where array_length(sdkversion_selection) == 0 or SdkVersion in (sdkversion_selection)\n| where array_length(resultType_selection) == 0 or ResultType in (resultType_selection)\n| where array_length(platform_selection) == 0 or Platform in (platform_selection) \n| summarize arg_max(TimestampMax, *) by \n    MetricName, \n    DeviceBrowser, \n    DeviceOsName, \n    DeviceBrowserVersionMajor,\n    DeviceBrowserVersionMinor, \n    DeviceOsVersionMajor, \n    DeviceOsVersionMinor,\n    SdkVersion,\n    DeviceFamily, \n    DeviceBrand, \n    DeviceModel,\n    ResultType, \n    SubCode, \n    TimestampBin, \n    CallType,\n    Platform\n| summarize count() by Platform\n",
                      "size": 1,
                      "title": "{DiagnosticChangedName} by SDK Platform",
                      "timeContextFromParameter": "TimeRange",
                      "queryType": 0,
                      "resourceType": "microsoft.communication/communicationservices",
                      "visualization": "piechart"
                    },
                    "customWidth": "50",
                    "name": "UFD breakdown 2"
                  }
                ]
              },
              "conditionalVisibility": {
                "parameterName": "DiagnosticChangedName",
                "comparison": "isNotEqualTo",
                "value": ""
              },
              "name": "UFD drill down"
            },
            {
              "type": 1,
              "content": {
                "json": "Overview of each DiagnosticChanged [here](https://learn.microsoft.com/en-us/azure/communication-services/concepts/voice-video-calling/user-facing-diagnostics?pivots=platform-web)\n\nRecovery Rate indicates the rate that UFDs were fired and later stopped. In other words, it calculates how many **Good** DiagnosticQuality flag was fired after **Bad**/**Poor** DiagnosticQuality flags were issued. Recovery rate tells us that how many UFD events have improved. \n\nWhile UFDs help indentify user facing quality issues, resource owners should aim to improve quality by reducing UFD volume, and improve recovery rate. ",
                "style": "info"
              },
              "customWidth": "15",
              "name": "UFDs Good/Bad/Poor description"
            },
            {
              "type": 3,
              "content": {
                "version": "KqlItem/1.0",
                "query": "let ufd_map_doc_url = (ufd:string) { \n     case( \n        ufd == 'SpeakingWhileMicrophoneIsMuted', 'https://learn.microsoft.com/en-us/azure/communication-services/resources/troubleshooting/voice-video-calling/references/ufd/speaking-while-microphone-is-muted',\n        ufd == 'NetworkReceiveQuality', 'https://learn.microsoft.com/en-us/azure/communication-services/resources/troubleshooting/voice-video-calling/references/ufd/network-receive-quality',\n        ufd == 'CameraFreeze', 'https://learn.microsoft.com/en-us/azure/communication-services/resources/troubleshooting/voice-video-calling/references/ufd/camera-freeze',\n        ufd == 'MicrophonePermissionDenied', 'https://learn.microsoft.com/en-us/azure/communication-services/resources/troubleshooting/voice-video-calling/references/ufd/microphone-permission-denied',\n        ufd == 'CameraStoppedUnexpectedly', 'https://learn.microsoft.com/en-us/azure/communication-services/resources/troubleshooting/voice-video-calling/references/ufd/camera-stopped-unexpectedly',\n        ufd == 'MicrophoneNotFunctioning', 'https://learn.microsoft.com/en-us/azure/communication-services/resources/troubleshooting/voice-video-calling/references/ufd/microphone-not-functioning',\n        ufd == 'CameraPermissionDenied', 'https://learn.microsoft.com/en-us/azure/communication-services/resources/troubleshooting/voice-video-calling/references/ufd/camera-permission-denied',\n        ufd == 'CameraStartTimedOut', 'https://learn.microsoft.com/en-us/azure/communication-services/resources/troubleshooting/voice-video-calling/references/ufd/camera-start-timed-out',\n        ufd == 'NetworkReconnect', 'https://learn.microsoft.com/en-us/azure/communication-services/resources/troubleshooting/voice-video-calling/references/ufd/network-reconnect',\n        ufd == 'MicrophoneMuteUnexpectedly', 'https://learn.microsoft.com/en-us/azure/communication-services/resources/troubleshooting/voice-video-calling/references/ufd/microphone-mute-unexpectedly',\n        ufd == 'CapturerStoppedUnexpectedly', 'https://learn.microsoft.com/en-us/azure/communication-services/resources/troubleshooting/voice-video-calling/references/ufd/capturer-stopped-unexpectedly',\n        ufd == 'CameraStartFailed', 'https://learn.microsoft.com/en-us/azure/communication-services/resources/troubleshooting/voice-video-calling/references/ufd/camera-start-failed',\n        ufd == 'NetworkSendQuality', 'https://learn.microsoft.com/en-us/azure/communication-services/resources/troubleshooting/voice-video-calling/references/ufd/network-send-quality',\n        ufd == 'NoMicrophoneDevicesEnumerated', 'https://learn.microsoft.com/en-us/azure/communication-services/resources/troubleshooting/voice-video-calling/references/ufd/no-microphone-devices-enumerated',\n        ufd == 'CapturerStartFailed', 'https://learn.microsoft.com/en-us/azure/communication-services/resources/troubleshooting/voice-video-calling/references/ufd/capturer-start-failed',\n        ufd == 'NoSpeakerDevicesEnumerated', 'https://learn.microsoft.com/en-us/azure/communication-services/resources/troubleshooting/voice-video-calling/references/ufd/no-speaker-devices-enumerated',\n        ufd == 'ScreenshareRecordingDisabled', 'https://learn.microsoft.com/en-us/azure/communication-services/resources/troubleshooting/voice-video-calling/references/ufd/screenshare-recording-disabled',\n        ufd == 'NoNetwork', 'https://learn.microsoft.com/en-us/azure/communication-services/resources/troubleshooting/voice-video-calling/references/ufd/no-network',\n        ''\n    ) \n};\nlet ufd_map_definition = (ufd:string) { \n     case( \n        ufd == 'SpeakingWhileMicrophoneIsMuted', \"This event with a True value occurs when the SDK detects that the audio input volume isn't muted although the user did mute the microphone.\",\n        ufd == 'NetworkReceiveQuality', 'This event with a Bad value indicates the presence of network quality issues for incoming streams, as detected by the ACS Calling SDK.',\n        ufd == 'CameraFreeze', 'This event with a True value occurs when the SDK detects that the input framerate goes down to zero, causing the video output to appear frozen or not changing.',\n        ufd == 'MicrophonePermissionDenied', 'This event with a True value occurs when the SDK detects that the microphone permission was denied either at browser or OS level.',\n        ufd == 'CameraStoppedUnexpectedly', 'This event with a True value occurs when the SDK detects that the camera track was muted.',\n        ufd == 'MicrophoneNotFunctioning', 'This event with a True value occurs when the SDK detects that the microphone track was ended.',\n        ufd == 'CameraPermissionDenied', 'This event with a True value occurs when the SDK detects that the camera permission was denied either at browser layer or at Operating System level.',\n        ufd == 'CameraStartTimedOut', \"This event with a True value occurs when the SDK is unable to acquire the camera stream because the promise returned by getUserMedia browser method doesn't resolve within a certain period of time.\",\n        ufd == 'NetworkReconnect', 'This event with a Bad value occurs when the Interactive Connectivity Establishment (ICE) transport state on the connection is failed',\n        ufd == 'MicrophoneMuteUnexpectedly', 'This event with a True value occurs when the SDK detects that the microphone track was muted.',\n        ufd == 'CapturerStoppedUnexpectedly', 'This event with a True value occurs when the SDK detects that the screen sharing track was muted.',\n        ufd == 'CameraStartFailed', 'This event with a True value occurs when the SDK is unable to acquire the camera stream because the source is unavailable.',\n        ufd == 'NetworkSendQuality', 'This event with a Bad value indicates that there are network quality issues for outgoing streams, such as packet loss, as detected by the ACS Calling SDK.',\n        ufd == 'NoMicrophoneDevicesEnumerated', \"This event with a True value occurs when the browser API navigator.mediaDevices.enumerateDevices doesn't include any audio input devices.\",\n        ufd == 'CapturerStartFailed', 'This event with a True value occurs when the SDK is unable to acquire the screen sharing stream because the source is unavailable.',\n        ufd == 'NoSpeakerDevicesEnumerated', \"This event with a True value occurs when there's no speaker device presented in the device list returned by the browser API.\",\n        ufd == 'ScreenshareRecordingDisabled', 'This event with a True value occurs when the SDK detects that the screen sharing permission was denied in the browser or OS settings on macOS.',\n        ufd == 'NoNetwork', \"This event with a True value occurs when there's no network available for ICE candidates being gathered, which means there are network setup issues in the local environment, such as a disconnected Wi-Fi or Ethernet cable.\",\n        ''\n    ) \n};\nACSCallClientOperations\n| where OperationName == \"UserFacingDiagnostics\"\n| extend DiagnosticChanged = tostring(OperationPayload.DiagnosticChanged)\n| distinct DiagnosticChanged\n| extend UFD = DiagnosticChanged\n| extend ['Learn More'] = ufd_map_doc_url(DiagnosticChanged)\n| extend Definition = ufd_map_definition(DiagnosticChanged)\n",
                "size": 0,
                "title": "UFD definitions",
                "timeContextFromParameter": "TimeRange",
                "queryType": 0,
                "resourceType": "microsoft.communication/communicationservices",
                "gridSettings": {
                  "formatters": [
                    {
                      "columnMatch": "DiagnosticChanged",
                      "formatter": 5
                    },
                    {
                      "columnMatch": "Learn More",
                      "formatter": 5,
                      "formatOptions": {
                        "linkTarget": "Url",
                        "linkLabel": "Documentation"
                      }
                    },
                    {
                      "columnMatch": "Definition",
                      "formatter": 1,
                      "formatOptions": {
                        "customColumnWidthSetting": "80%"
                      }
                    }
                  ]
                }
              },
              "customWidth": "85",
              "name": "UFD definition"
            }
          ]
        },
        "name": "voice-video-ufd"
      }
    ],
    "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
  }