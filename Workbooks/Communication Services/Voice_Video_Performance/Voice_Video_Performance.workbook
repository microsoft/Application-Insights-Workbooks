{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "# Calling SDK Performance <br>\nPlease note that all presented numbers in all the following visuals may be different from billing record, they are created with server and client logs, which may be prone to data loss"
            },
            "name": "text - 6"
          },
          {
            "type": 1,
            "content": {
              "json": "This tab displays the latency to complete various API scenarios within the calling SDK. APIs of ACS SDK enable scenarios initiated by the application or their users. This page captures latencies for a specific scenario, latencies are aggregated across your entire resource. Scenario latency is measured from the initiation to the completion of each API scenario attempt. For example, 'Accept Incoming Call' displays the decile latency of the accept() API on the IncomingCall object exposed by the SDK. </br>\r\n\r\nSelect an individual \"API Scenario\" using the drop down filter for a detailed analysis.",
              "style": "info"
            },
            "name": "reliability explanation"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "7ba0f6c1-8f8c-447a-b616-25e6f748fc7e",
                  "version": "KqlParameterItem/1.0",
                  "name": "TimeRange",
                  "label": "Time Range",
                  "type": 4,
                  "description": "Define a time range to aggregate logs over",
                  "isRequired": true,
                  "typeSettings": {
                    "selectableValues": [
                      {
                        "durationMs": 300000
                      },
                      {
                        "durationMs": 900000
                      },
                      {
                        "durationMs": 1800000
                      },
                      {
                        "durationMs": 3600000
                      },
                      {
                        "durationMs": 14400000
                      },
                      {
                        "durationMs": 43200000
                      },
                      {
                        "durationMs": 86400000
                      },
                      {
                        "durationMs": 172800000
                      },
                      {
                        "durationMs": 259200000
                      },
                      {
                        "durationMs": 604800000
                      },
                      {
                        "durationMs": 1209600000
                      },
                      {
                        "durationMs": 2419200000
                      },
                      {
                        "durationMs": 2592000000
                      },
                      {
                        "durationMs": 5184000000
                      },
                      {
                        "durationMs": 7776000000
                      }
                    ],
                    "allowCustom": true
                  },
                  "value": {
                    "durationMs": 2419200000
                  }
                },
                {
                  "id": "8caaee6d-fdf7-450f-bcdf-7625dbfc35b8",
                  "version": "KqlParameterItem/1.0",
                  "name": "timeGranularity",
                  "label": "Duration Unit",
                  "type": 2,
                  "description": "Choose the time granularity to use to aggregate logs",
                  "isRequired": true,
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "jsonData": "[\n    { \"value\":\"bin(CallClientTimeStamp,startofday(CallClientTimeStamp))\", \"label\":\"Daily\" },\n    { \"value\":\"bin(CallClientTimeStamp,startofweek(CallClientTimeStamp))\", \"label\":\"Weekly\", \"selected\":true },\n    { \"value\":\"bin(CallClientTimeStamp,startofmonth(CallClientTimeStamp))\", \"label\":\"Monthly\" }\n]"
                },
                {
                  "id": "53b00664-18c3-4e34-bec9-27924025b70f",
                  "version": "KqlParameterItem/1.0",
                  "name": "Scenario",
                  "label": "API Scenario",
                  "type": 2,
                  "query": "let operationName_to_scenarioDisplayName = (operationName:string) { \n     case( \n        //operationName == 'StartCall', dynamic({\"value\": \"StartCall\", \"label\": \"Start Call\"}),\n        operationName == 'AcceptIncomingCall', dynamic({'value': 'AcceptIncomingCall', 'label': 'Accept Incoming Call'}),\n        operationName == 'Join', dynamic({'value': 'Join', 'label': 'Join'}),\n        operationName == 'StartVideo', dynamic({'value': 'StartVideo', 'label': 'Start Video'}),\n        operationName == 'StopVideo', dynamic({'value': 'StopVideo', 'label': 'Stop Video'}),\n        operationName == 'CallAgentInit', dynamic({'value': 'CallAgentInit', 'label': 'Call Agent Init'}),\n        operationName == 'HandleIncomingCall', dynamic({'value': 'HandleIncomingCall', 'label': 'Handle Incoming Call'}),\n        ''\n    )\n};\nlet scenarios = ACSCallClientOperations\n| distinct OperationName\n| extend Scenario = operationName_to_scenarioDisplayName(OperationName)\n| where isnotempty(Scenario)\n| project parse_json(Scenario);\nscenarios\n| project value = Scenario.value, label = Scenario.label\n",
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 0
                  },
                  "timeContextFromParameter": "TimeRange",
                  "queryType": 0,
                  "resourceType": "microsoft.communication/communicationservices",
                  "value": null
                },
                {
                  "id": "5d39b4eb-9960-4ea9-9f9b-b39f6c90e01a",
                  "version": "KqlParameterItem/1.0",
                  "name": "Percentile",
                  "type": 2,
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "jsonData": "[\r\n    { \"value\":10, \"label\":\"P10\" },\r\n    { \"value\":20, \"label\":\"P20\" },\r\n    { \"value\":50, \"label\":\"P50\", \"selected\": true},\r\n    { \"value\":75, \"label\":\"P75\" },\r\n    { \"value\":95, \"label\":\"P95\" },\r\n    { \"value\":99, \"label\":\"P99\" }\r\n]",
                  "timeContext": {
                    "durationMs": 2419200000
                  },
                  "timeContextFromParameter": "TimeRange",
                  "value": "95"
                },
                {
                  "id": "a63e4c6a-5726-4e16-8787-e5e32de41c82",
                  "version": "KqlParameterItem/1.0",
                  "name": "SDKVersion",
                  "label": "SDK Version",
                  "type": 2,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "query": "ACSCallClientOperations\n| distinct SdkVersion",
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "selectAllValue": "[]",
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 0
                  },
                  "timeContextFromParameter": "TimeRange",
                  "defaultValue": "value::all",
                  "queryType": 0,
                  "resourceType": "microsoft.communication/communicationservices"
                },
                {
                  "id": "964c0df4-718d-471f-8cca-0c18d3518f29",
                  "version": "KqlParameterItem/1.0",
                  "name": "platform",
                  "label": "SDK Platform",
                  "type": 2,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "query": "ACSCallClientOperations\n| extend sdk_platform = tostring(OperationPayload.SdkPlatform)\n| where isnotempty(sdk_platform) \n| distinct sdk_platform",
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "selectAllValue": "[]",
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 2419200000
                  },
                  "timeContextFromParameter": "TimeRange",
                  "defaultValue": "value::all",
                  "queryType": 0,
                  "resourceType": "microsoft.communication/communicationservices"
                },
                {
                  "id": "a2405bed-9f8e-43b9-b8d9-7959d21770f7",
                  "version": "KqlParameterItem/1.0",
                  "name": "ResultType",
                  "label": "Result Category",
                  "type": 2,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "query": "let cleanup_resulttype = (resultType:string) { \n     case( \n        resultType == 'Succeeded', 'Success',\n        resultType == 'Failed', 'ExpectedError',\n        resultType\n    )\n};\nACSCallClientOperations\n| extend ResultType = cleanup_resulttype(ResultType)\n| distinct ResultType",
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "selectAllValue": "[]",
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 0
                  },
                  "timeContextFromParameter": "TimeRange",
                  "defaultValue": "value::all",
                  "queryType": 0,
                  "resourceType": "microsoft.communication/communicationservices"
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.communication/communicationservices"
            },
            "name": "reliability parameter"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let operationName_to_scenarioDisplayName = (operationName:string) { \r\n     case( \r\n        //operationName == 'StartCall', 'StartCall',\r\n        operationName == 'AcceptIncomingCall', 'AcceptIncomingCall',\r\n        operationName == 'Join', 'Join',\r\n        operationName == 'StartVideo', 'StartVideo',\r\n        operationName == 'StopVideo', 'StopVideo',\r\n        operationName == 'CallAgentInit', 'CreateAgentInit',\r\n        operationName == 'Drop', 'Drop',\r\n        operationName == 'HandleIncomingCall', 'HandleIncomingCall',\r\n        ''\r\n    ) \r\n};\r\nlet cleanup_resulttype = (resultType:string) { \r\n     case( \r\n        resultType == 'Succeeded', 'Success',\r\n        resultType == 'Failed', 'ExpectedError',\r\n        resultType\r\n    )\r\n};\r\nlet sdkversion_selection = dynamic([{SDKVersion}]);\r\nlet platform_selection = dynamic([{platform}]);\r\nlet resultType_selection = dynamic([{ResultType}]);\r\nACSCallClientOperations\r\n| extend Scenario = operationName_to_scenarioDisplayName(OperationName), DurationMs = todouble(DurationMs), sdk_platform = tostring(OperationPayload.SdkPlatform)\r\n| where isnotempty(Scenario)\r\n| where isnotempty(DurationMs)\r\n| extend ResultType = cleanup_resulttype(ResultType)\r\n| where array_length(sdkversion_selection) == 0 or SdkVersion in (sdkversion_selection)\r\n| where array_length(platform_selection) == 0 or sdk_platform in (platform_selection)\r\n| where array_length(resultType_selection) == 0 or ResultType in (resultType_selection)\r\n| summarize performance = percentiles(DurationMs, {Percentile}) by CallClientTimeStamp={timeGranularity}, Scenario\r\n",
                    "size": 0,
                    "aggregation": 3,
                    "title": "{Percentile:label} performance",
                    "noDataMessage": "No performance logs found in the specified time range",
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.communication/communicationservices",
                    "visualization": "timechart",
                    "graphSettings": {
                      "type": 0,
                      "topContent": {
                        "columnMatch": "OperationName",
                        "formatter": 1
                      },
                      "centerContent": {
                        "columnMatch": "percentile_DurationMs_50",
                        "formatter": 1,
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "maximumSignificantDigits": 3,
                            "maximumFractionDigits": 2
                          }
                        }
                      }
                    },
                    "chartSettings": {
                      "xAxis": "CallClientTimeStamp",
                      "showMetrics": false,
                      "showLegend": true,
                      "showDataPoints": true,
                      "xSettings": {
                        "numberFormatSettings": {
                          "unit": 0,
                          "options": {
                            "style": "decimal",
                            "useGrouping": true
                          }
                        },
                        "label": ""
                      },
                      "ySettings": {
                        "numberFormatSettings": {
                          "unit": 23,
                          "options": {
                            "style": "decimal",
                            "useGrouping": false
                          }
                        }
                      }
                    },
                    "mapSettings": {
                      "locInfo": "LatLong",
                      "sizeSettings": "percentile_DurationMs_50",
                      "sizeAggregation": "Sum",
                      "legendMetric": "percentile_DurationMs_50",
                      "legendAggregation": "Sum",
                      "itemColorSettings": {
                        "type": "heatmap",
                        "colorAggregation": "Sum",
                        "nodeColorField": "percentile_DurationMs_50",
                        "heatmapPalette": "greenRed"
                      }
                    }
                  },
                  "name": "{Percentile} performance"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let operationName_to_scenarioDisplayName = (operationName:string) { \n     case( \n        //operationName == 'StartCall', 'StartCall',\n        operationName == 'AcceptIncomingCall', 'AcceptIncomingCall',\n        operationName == 'Join', 'Join',\n        operationName == 'StartVideo', 'StartVideo',\n        operationName == 'StopVideo', 'StopVideo',\n        operationName == 'CallAgentInit', 'CallAgentInit',\n        operationName == 'Drop', 'Drop',\n        operationName == 'HandleIncomingCall', 'HandleIncomingCall',\n        ''\n    ) \n};\nlet cleanup_resulttype = (resultType:string) { \n     case( \n        resultType == 'Succeeded', 'Success',\n        resultType == 'Failed', 'ExpectedError',\n        resultType\n    )\n};\nlet sdkversion_selection = dynamic([{SDKVersion}]);\nlet platform_selection = dynamic([{platform}]);\nlet resultType_selection = dynamic([{ResultType}]);\nlet unpivot = ACSCallClientOperations\n| extend Scenario = operationName_to_scenarioDisplayName(OperationName), DurationMs = todouble(DurationMs), sdk_platform = tostring(OperationPayload.SdkPlatform)\n| where isnotempty(Scenario)\n| where isnotempty(DurationMs)\n| extend ResultType = cleanup_resulttype(ResultType)\n| where array_length(sdkversion_selection) == 0 or SdkVersion in (sdkversion_selection)\n| where array_length(platform_selection) == 0 or sdk_platform in (platform_selection)\n| where array_length(resultType_selection) == 0 or ResultType in (resultType_selection)\n| summarize performance = percentiles(DurationMs, {Percentile}) by CallClientTimeStamp=format_datetime({timeGranularity}, \"yyyy-MM-dd \"), Scenario\n| order by Scenario, CallClientTimeStamp asc;\n//\nlet pivot_performance =\nunpivot\n| evaluate pivot(CallClientTimeStamp, sum(performance), Scenario);\n//\nlet pivot_change =\nunpivot\n| extend change =  round(iff(Scenario == prev(Scenario), performance - prev(performance), 0.0),2)\n| evaluate pivot(CallClientTimeStamp, sum(change), Scenario);\n//\nlet pivot_table =\npivot_change \n| join kind=inner pivot_performance on Scenario\n| project-away Scenario1\n| project PackedRecord = todynamic\n    (\n        replace_strings(\n            tostring(pack_all()),\n            dynamic([' 1', ' ']),\n            dynamic([' latency', ' change'])\n        )\n    )\n| evaluate bag_unpack(PackedRecord);\npivot_table\n| project-reorder S*, ['20*'] desc\n\n\n\n",
                    "size": 0,
                    "title": "{Percentile:label} latency of key scenarios {timeGranularity:label} trend",
                    "noDataMessage": "No reliability logs found in the specified time range",
                    "timeContextFromParameter": "TimeRange",
                    "exportFieldName": "Scenario",
                    "exportParameterName": "MetricName",
                    "queryType": 0,
                    "resourceType": "microsoft.communication/communicationservices",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "2025-05-18 latency",
                          "formatter": 0,
                          "numberFormat": {
                            "unit": 23,
                            "options": {
                              "style": "decimal"
                            }
                          }
                        },
                        {
                          "columnMatch": "change",
                          "formatter": 18,
                          "formatOptions": {
                            "thresholdsOptions": "icons",
                            "thresholdsGrid": [
                              {
                                "operator": ">",
                                "thresholdValue": "0",
                                "representation": "dot-redBright",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "<",
                                "thresholdValue": "0",
                                "representation": "dot-green",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "==",
                                "thresholdValue": "0",
                                "representation": "dot-gray",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "Default",
                                "thresholdValue": null,
                                "representation": null,
                                "text": "{0}{1}"
                              }
                            ],
                            "compositeBarSettings": {
                              "labelText": "",
                              "columnSettings": []
                            }
                          },
                          "numberFormat": {
                            "unit": 23,
                            "options": {
                              "style": "decimal"
                            }
                          }
                        },
                        {
                          "columnMatch": "2025-05-11 latency",
                          "formatter": 0,
                          "numberFormat": {
                            "unit": 23,
                            "options": {
                              "style": "decimal"
                            }
                          }
                        },
                        {
                          "columnMatch": "2025-05-04 latency",
                          "formatter": 0,
                          "numberFormat": {
                            "unit": 23,
                            "options": {
                              "style": "decimal"
                            }
                          }
                        },
                        {
                          "columnMatch": "2025-04-27 latency",
                          "formatter": 0,
                          "numberFormat": {
                            "unit": 23,
                            "options": {
                              "style": "decimal"
                            }
                          }
                        },
                        {
                          "columnMatch": "2025-04-20 latency",
                          "formatter": 0,
                          "numberFormat": {
                            "unit": 23,
                            "options": {
                              "style": "decimal"
                            }
                          }
                        },
                        {
                          "columnMatch": "2025-04-13 latency",
                          "formatter": 0,
                          "numberFormat": {
                            "unit": 23,
                            "options": {
                              "style": "decimal"
                            }
                          }
                        },
                        {
                          "columnMatch": "2025-04-06 latency",
                          "formatter": 0,
                          "numberFormat": {
                            "unit": 23,
                            "options": {
                              "style": "decimal"
                            }
                          }
                        },
                        {
                          "columnMatch": "latency",
                          "formatter": 0,
                          "numberFormat": {
                            "unit": 23,
                            "options": {
                              "style": "decimal"
                            }
                          }
                        },
                        {
                          "columnMatch": "performance",
                          "formatter": 2,
                          "numberFormat": {
                            "unit": 23,
                            "options": {
                              "style": "decimal"
                            }
                          }
                        }
                      ]
                    },
                    "sortBy": []
                  },
                  "name": "all Scenarios trend"
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "Scenario",
              "comparison": "isEqualTo",
              "value": ""
            },
            "name": "all metrics overview"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let operationName_to_scenarioDisplayName = (operationName:string) { \r\n     case( \r\n        operationName == 'StartCall', 'StartCall',\r\n        operationName == 'AcceptIncomingCall', 'AcceptIncomingCall',\r\n        operationName == 'Join', 'Join',\r\n        operationName == 'StartVideo', 'StartVideo',\r\n        operationName == 'StopVideo', 'StopVideo',\r\n        operationName == 'CallAgentInit', 'CreateAgentInit',\r\n        operationName == 'Drop', 'Drop',\r\n        operationName == 'HandleIncomingCall', 'HandleIncomingCall',\r\n        ''\r\n    ) \r\n};\r\nlet cleanup_resulttype = (resultType:string) { \r\n     case( \r\n        resultType == 'Succeeded', 'Success',\r\n        resultType == 'Failed', 'ExpectedError',\r\n        resultType\r\n    )\r\n};\r\nlet sdkversion_selection = dynamic([{SDKVersion}]);\r\nlet platform_selection = dynamic([{platform}]);\r\nlet resultType_selection = dynamic([{ResultType}]);\r\nlet selected_metric_performance = todynamic('{Scenario}');\r\nACSCallClientOperations\r\n| extend Scenario = operationName_to_scenarioDisplayName(OperationName), DurationMs = todouble(DurationMs), sdk_platform = tostring(OperationPayload.SdkPlatform)\r\n| where isnotempty(Scenario)\r\n| where Scenario == selected_metric_performance\r\n| extend ResultType = cleanup_resulttype(ResultType)\r\n| where isnotempty(DurationMs)\r\n| where array_length(sdkversion_selection) == 0 or SdkVersion in (sdkversion_selection)\r\n| where array_length(platform_selection) == 0 or sdk_platform in (platform_selection)\r\n| where array_length(resultType_selection) == 0 or ResultType in (resultType_selection)\r\n| summarize performance = percentiles(DurationMs, {Percentile}) by CallClientTimeStamp={timeGranularity}, Scenario\r\n",
                    "size": 0,
                    "aggregation": 3,
                    "title": "{Scenario:label} {timeGranularity:label} {Percentile:label} latency trend time chart",
                    "noDataMessage": "No Scenario logs found in the specified time range",
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.communication/communicationservices",
                    "visualization": "timechart",
                    "chartSettings": {
                      "xAxis": "CallClientTimeStamp",
                      "showMetrics": false,
                      "showDataPoints": true,
                      "xSettings": {
                        "numberFormatSettings": {
                          "unit": 0,
                          "options": {
                            "style": "decimal",
                            "useGrouping": true
                          }
                        }
                      },
                      "ySettings": {
                        "numberFormatSettings": {
                          "unit": 23,
                          "options": {
                            "style": "decimal",
                            "useGrouping": false,
                            "maximumFractionDigits": 2
                          }
                        }
                      }
                    }
                  },
                  "customWidth": "50",
                  "name": "individual reliability time chart",
                  "styleSettings": {
                    "margin": "5px"
                  }
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let cleanup_resulttype = (resultType:string) { \r\n     case( \r\n        resultType == 'Succeeded', 'Success',\r\n        resultType == 'Failed', 'ExpectedError',\r\n        resultType\r\n    )\r\n};\r\nlet sdkversion_selection = dynamic([{SDKVersion}]);\r\nlet platform_selection = dynamic([{platform}]);\r\nlet resultType_selection = dynamic([{ResultType}]);\r\nlet selected_metric_performance = todynamic('{Scenario}');\r\nACSCallClientOperations\r\n| extend DurationMs = todouble(DurationMs), sdk_platform = tostring(OperationPayload.SdkPlatform)\r\n| where isnotempty(OperationName)\r\n| where OperationName == selected_metric_performance\r\n| where isnotempty(DurationMs)\r\n| extend ResultType = cleanup_resulttype(ResultType)\r\n| where array_length(sdkversion_selection) == 0 or SdkVersion in (sdkversion_selection)\r\n| where array_length(platform_selection) == 0 or sdk_platform in (platform_selection)\r\n| where array_length(resultType_selection) == 0 or ResultType in (resultType_selection)\r\n| summarize volume = count() by CallClientTimeStamp = {timeGranularity}",
                    "size": 0,
                    "title": "{Scenario:label} {timeGranularity:label} call volume trend time chart",
                    "noDataMessage": "No Scenario logs found in the specified time range",
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.communication/communicationservices",
                    "visualization": "timechart",
                    "chartSettings": {
                      "xAxis": "CallClientTimeStamp",
                      "showMetrics": false,
                      "showDataPoints": true,
                      "xSettings": {
                        "scale": "time",
                        "label": ""
                      },
                      "ySettings": {
                        "label": ""
                      }
                    }
                  },
                  "customWidth": "50",
                  "name": "individual call volume time chart",
                  "styleSettings": {
                    "margin": "5px"
                  }
                },
                {
                  "type": 1,
                  "content": {
                    "json": "We suggest reviewing the highest volume participants with the longest durations in Call Diagnostics.",
                    "style": "info"
                  },
                  "name": "text - 5"
                },
                {
                  "type": 12,
                  "content": {
                    "version": "NotebookGroup/1.0",
                    "groupType": "editable",
                    "items": [
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "let cleanup_resulttype = (resultType:string) { \r\n     case( \r\n        resultType == 'Succeeded', 'Success',\r\n        resultType == 'Failed', 'ExpectedError',\r\n        resultType\r\n    )\r\n};\r\nlet sdkversion_selection = dynamic([{SDKVersion}]);\r\nlet platform_selection = dynamic([{platform}]);\r\nlet resultType_selection = dynamic([{ResultType}]);\r\nlet selected_metric_performance = todynamic('{Scenario}');\r\nACSCallClientOperations\r\n| where isnotempty(OperationName)\r\n| extend ResultType = cleanup_resulttype(ResultType)\r\n| extend DurationMs = todouble(DurationMs), sdk_platform = tostring(OperationPayload.SdkPlatform)\r\n| where array_length(sdkversion_selection) == 0 or SdkVersion in (sdkversion_selection)\r\n| where array_length(platform_selection) == 0 or sdk_platform in (platform_selection)\r\n| where array_length(resultType_selection) == 0 or ResultType in (resultType_selection)\r\n| where OperationName == selected_metric_performance\r\n| where isnotempty(DurationMs)\r\n| summarize percentile_DurationMs=percentiles(DurationMs, 50, 60, 70, 80, 90, 95, 99), ['Average Duration']=avg(DurationMs), ['Total Calls']=count() by ParticipantId, CallClientTimeStamp={timeGranularity}\r\n| extend \r\n    p50=percentile_DurationMs, \r\n    p60=percentile_DurationMs_60, \r\n    p70=percentile_DurationMs_70,\r\n    p80=percentile_DurationMs_80,\r\n    p90=percentile_DurationMs_90,\r\n    p95=percentile_DurationMs_95,\r\n    p99=percentile_DurationMs_99\r\n| project ['Participant ID']=ParticipantId, p50, p60, p70, p80, p90, p95, p99, ['Average Duration'], ['Total Calls']\r\n| top 50 by ['Total Calls']\r\n| order by ['Total Calls'] desc",
                          "size": 0,
                          "title": "Latency percentiles per user",
                          "noDataMessage": "No latency logs found in the specified time range",
                          "timeContextFromParameter": "TimeRange",
                          "exportFieldName": "SubCode",
                          "exportParameterName": "selected_subcode",
                          "queryType": 0,
                          "resourceType": "microsoft.communication/communicationservices",
                          "gridSettings": {
                            "formatters": [
                              {
                                "columnMatch": "p50",
                                "formatter": 0,
                                "numberFormat": {
                                  "unit": 23,
                                  "options": {
                                    "style": "decimal"
                                  }
                                }
                              },
                              {
                                "columnMatch": "p60",
                                "formatter": 0,
                                "numberFormat": {
                                  "unit": 23,
                                  "options": {
                                    "style": "decimal"
                                  }
                                }
                              },
                              {
                                "columnMatch": "p70",
                                "formatter": 0,
                                "numberFormat": {
                                  "unit": 23,
                                  "options": {
                                    "style": "decimal"
                                  }
                                }
                              },
                              {
                                "columnMatch": "p80",
                                "formatter": 0,
                                "numberFormat": {
                                  "unit": 23,
                                  "options": {
                                    "style": "decimal"
                                  }
                                }
                              },
                              {
                                "columnMatch": "p90",
                                "formatter": 0,
                                "numberFormat": {
                                  "unit": 23,
                                  "options": {
                                    "style": "decimal"
                                  }
                                }
                              },
                              {
                                "columnMatch": "p95",
                                "formatter": 0,
                                "numberFormat": {
                                  "unit": 23,
                                  "options": {
                                    "style": "decimal"
                                  }
                                }
                              },
                              {
                                "columnMatch": "p99",
                                "formatter": 0,
                                "numberFormat": {
                                  "unit": 23,
                                  "options": {
                                    "style": "decimal"
                                  }
                                }
                              },
                              {
                                "columnMatch": "Average Duration",
                                "formatter": 0,
                                "numberFormat": {
                                  "unit": 23,
                                  "options": {
                                    "style": "decimal"
                                  }
                                }
                              },
                              {
                                "columnMatch": "Copilot",
                                "formatter": 5,
                                "formatOptions": {
                                  "linkTarget": "CopilotNudge",
                                  "copilotNudgeActionSettings": {
                                    "nudgeContent": "[\"Copilot_prompt\"]"
                                  }
                                }
                              },
                              {
                                "columnMatch": "Copilot_prompt",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "Failure rate",
                                "formatter": 0,
                                "numberFormat": {
                                  "unit": 1,
                                  "options": {
                                    "style": "decimal"
                                  }
                                }
                              },
                              {
                                "columnMatch": "metricName",
                                "formatter": 5
                              }
                            ],
                            "rowLimit": 50,
                            "sortBy": [
                              {
                                "itemKey": "Participant ID",
                                "sortOrder": 1
                              }
                            ]
                          },
                          "sortBy": [
                            {
                              "itemKey": "Participant ID",
                              "sortOrder": 1
                            }
                          ]
                        },
                        "name": "Subcode breakdown"
                      }
                    ]
                  },
                  "conditionalVisibility": {
                    "parameterName": "Scenario",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "group - 3"
                },
                {
                  "type": 12,
                  "content": {
                    "version": "NotebookGroup/1.0",
                    "groupType": "editable",
                    "items": [
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "let cleanup_resulttype = (resultType:string) { \r\n     case( \r\n        resultType == 'Succeeded', 'Success',\r\n        resultType == 'Failed', 'ExpectedError',\r\n        resultType\r\n    )\r\n};\r\nlet sdkversion_selection = dynamic([{SDKVersion}]);\r\nlet platform_selection = dynamic([{platform}]);\r\nlet resultType_selection = dynamic([{ResultType}]);\r\nlet selected_metric_performance = todynamic('{Scenario}');\r\nACSCallClientOperations\r\n| where OperationName == selected_metric_performance\r\n| extend sdk_platform = tostring(OperationPayload.SdkPlatform)\r\n| where isnotempty(OperationName)\r\n| where isnotempty(DurationMs)\r\n| extend ResultType = cleanup_resulttype(ResultType)\r\n| where array_length(sdkversion_selection) == 0 or SdkVersion in (sdkversion_selection)\r\n| where array_length(platform_selection) == 0 or sdk_platform in (platform_selection)\r\n| where array_length(resultType_selection) == 0 or ResultType in (resultType_selection)\r\n| summarize ['count'] = dcount(OperationId) by ['Duration'] = bin(DurationMs, 1000)/10000\r\n",
                          "size": 0,
                          "title": "Count of latency in 1 sec time bucket (E.g. 0s column represents latency from 0s to .999s)",
                          "noDataMessage": "No latency logs found in the specified time range",
                          "timeContextFromParameter": "TimeRange",
                          "exportFieldName": "SubCode",
                          "exportParameterName": "selected_subcode",
                          "queryType": 0,
                          "resourceType": "microsoft.communication/communicationservices",
                          "visualization": "unstackedbar",
                          "gridSettings": {
                            "formatters": [
                              {
                                "columnMatch": "p50",
                                "formatter": 0,
                                "numberFormat": {
                                  "unit": 23,
                                  "options": {
                                    "style": "decimal"
                                  }
                                }
                              },
                              {
                                "columnMatch": "p60",
                                "formatter": 0,
                                "numberFormat": {
                                  "unit": 23,
                                  "options": {
                                    "style": "decimal"
                                  }
                                }
                              },
                              {
                                "columnMatch": "p70",
                                "formatter": 0,
                                "numberFormat": {
                                  "unit": 23,
                                  "options": {
                                    "style": "decimal"
                                  }
                                }
                              },
                              {
                                "columnMatch": "p80",
                                "formatter": 0,
                                "numberFormat": {
                                  "unit": 23,
                                  "options": {
                                    "style": "decimal"
                                  }
                                }
                              },
                              {
                                "columnMatch": "p90",
                                "formatter": 0,
                                "numberFormat": {
                                  "unit": 23,
                                  "options": {
                                    "style": "decimal"
                                  }
                                }
                              },
                              {
                                "columnMatch": "p95",
                                "formatter": 0,
                                "numberFormat": {
                                  "unit": 23,
                                  "options": {
                                    "style": "decimal"
                                  }
                                }
                              },
                              {
                                "columnMatch": "p99",
                                "formatter": 0,
                                "numberFormat": {
                                  "unit": 23,
                                  "options": {
                                    "style": "decimal"
                                  }
                                }
                              },
                              {
                                "columnMatch": "Average Duration",
                                "formatter": 0,
                                "numberFormat": {
                                  "unit": 23,
                                  "options": {
                                    "style": "decimal"
                                  }
                                }
                              },
                              {
                                "columnMatch": "Copilot",
                                "formatter": 5,
                                "formatOptions": {
                                  "linkTarget": "CopilotNudge",
                                  "copilotNudgeActionSettings": {
                                    "nudgeContent": "[\"Copilot_prompt\"]"
                                  }
                                }
                              },
                              {
                                "columnMatch": "Copilot_prompt",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "Failure rate",
                                "formatter": 0,
                                "numberFormat": {
                                  "unit": 1,
                                  "options": {
                                    "style": "decimal"
                                  }
                                }
                              },
                              {
                                "columnMatch": "metricName",
                                "formatter": 5
                              }
                            ],
                            "rowLimit": 50
                          },
                          "sortBy": [],
                          "tileSettings": {
                            "showBorder": false,
                            "titleContent": {
                              "columnMatch": "OperationName",
                              "formatter": 1
                            },
                            "leftContent": {
                              "columnMatch": "DurationMs",
                              "formatter": 12,
                              "formatOptions": {
                                "palette": "auto"
                              },
                              "numberFormat": {
                                "unit": 17,
                                "options": {
                                  "maximumSignificantDigits": 3,
                                  "maximumFractionDigits": 2
                                }
                              }
                            }
                          },
                          "graphSettings": {
                            "type": 0,
                            "topContent": {
                              "columnMatch": "OperationName",
                              "formatter": 1
                            },
                            "centerContent": {
                              "columnMatch": "DurationMs",
                              "formatter": 1,
                              "numberFormat": {
                                "unit": 17,
                                "options": {
                                  "maximumSignificantDigits": 3,
                                  "maximumFractionDigits": 2
                                }
                              }
                            }
                          },
                          "chartSettings": {
                            "xAxis": "Duration",
                            "yAxis": [
                              "count"
                            ],
                            "showMetrics": false,
                            "xSettings": {
                              "numberFormatSettings": {
                                "unit": 24,
                                "options": {
                                  "style": "decimal",
                                  "useGrouping": false
                                }
                              },
                              "label": "10 seconds"
                            },
                            "ySettings": {
                              "label": ""
                            }
                          }
                        },
                        "name": "Count of latency in 1 second time bucket"
                      }
                    ]
                  },
                  "name": "group - 2"
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "Scenario",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "Individual Scenario breakdown"
          },
          {
            "type": 1,
            "content": {
              "json": "**Latency threshold** is the recommended P95 decile time for an API to resolve. Measured from the moment an API is called to when an API resolves.",
              "style": "info"
            },
            "customWidth": "15",
            "name": "APIs description"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let api_map_definition = (api:string) { \n     case( \n        api == 'CallAgentInit', 'This API completes when the calling SDK successfully created the CallAgent object. If this fails, the reliability/api/Join or reliability/api/StartCall APIs can not be triggered.',\n        api == 'HandleIncomingCall', 'When the calling SDK successfully registers an `incomingCallReceived` event.',\n        api == 'AcceptIncomingCall', 'When user clicks \"Answer\" and the client successfully accepted and connected to an incoming call.',\n        api == 'Join', \"When the user's client is admitted to an existing call or meeting.\",\n        api == 'StartCall', \"When a user's client initiates a new call.\",\n        api == 'StartVideo', \"\tWhen a user's client successfully begins streaming video to remote participants.\",\n        api == 'StopVideo', 'When the calling SDK successfully stopped streaming video to remote participants.',\n        ''\n    ) \n};\nlet api_map_threshold = (api:string) { \n     case( \n        api == 'CallAgentInit', '2',\n        api == 'HandleIncomingCall', '2',\n        api == 'AcceptIncomingCall', '3',\n        api == 'Join', '5',\n        api == 'StartCall', '1',\n        api == 'StartVideo', '7',\n        api == 'StopVideo', '1',\n        ''\n    ) \n};\nACSCallClientOperations\n| where OperationName in ('Join', 'CallAgentInit', 'StopVideo', 'AcceptIncomingCall', 'HandleIncomingCall', 'StartVideo') //'StartCall'\n| distinct OperationName\n| extend ['Latency threshold (seconds)'] = api_map_threshold(OperationName), Definition = api_map_definition(OperationName)\n| project API = OperationName, ['Latency threshold (seconds)'], Definition\n",
              "size": 0,
              "title": "API definitions",
              "noDataMessage": "No performance logs found in the specified time range",
              "queryType": 0,
              "resourceType": "microsoft.communication/communicationservices",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "DiagnosticChanged",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "Learn More",
                    "formatter": 5,
                    "formatOptions": {
                      "linkTarget": "Url",
                      "linkLabel": "Documentation"
                    }
                  },
                  {
                    "columnMatch": "Definition",
                    "formatter": 1,
                    "formatOptions": {
                      "customColumnWidthSetting": "80%"
                    }
                  }
                ]
              }
            },
            "customWidth": "85",
            "name": "API definition"
          }
        ],
        "exportParameters": true
      },
      "name": "voice-video-reliability"
    }
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}