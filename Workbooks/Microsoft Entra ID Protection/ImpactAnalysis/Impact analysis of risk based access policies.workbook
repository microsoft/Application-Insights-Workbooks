{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "# Impact analysis of risk-based access policies"
      },
      "customWidth": "70",
      "name": "text - 0"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "18cbf1a8-0ab3-45a4-8374-079ef63b5e5d",
            "version": "KqlParameterItem/1.0",
            "name": "Worksapce",
            "type": 5,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "typeSettings": {
              "resourceTypeFilter": {
                "microsoft.operationalinsights/workspaces": true
              },
              "additionalResourceOptions": [
                "value::all"
              ]
            },
            "timeContext": {
              "durationMs": 86400000
            }
          },
          {
            "id": "bdda2209-a8d8-4976-ae4c-07002cc7d25b",
            "version": "KqlParameterItem/1.0",
            "name": "Guide",
            "type": 10,
            "isRequired": true,
            "typeSettings": {
              "additionalResourceOptions": []
            },
            "jsonData": "[\r\n    {\"value\": \"On\", \"label\": \"On\", \"selected\":true},\r\n    {\"value\": \"Off\", \"label\": \"Off\"}\r\n]",
            "timeContext": {
              "durationMs": 86400000
            }
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "customWidth": "30",
      "name": "parameters - 5"
    },
    {
      "type": 1,
      "content": {
        "json": "The only prerequisite to running this workbook is that you are capturing sign-in logs in Log Analytics. **No Conditional Access policies need to be in place to run this workbook.** ",
        "style": "warning"
      },
      "name": "text - 8"
    },
    {
      "type": 1,
      "content": {
        "json": "**Guide:** This workbook allows you to view the users and service principals impacted if a risk-based access policy were to be enabled WITHOUT the need for creating any policies or having policies in report-only mode. For example, you can see which users would have been impacted over the past 30 days if you had enabled a risk-based Conditional Access policy where high risk users are blocked. Note: Utilize the filters to manage the amount of historical data evaluated for impact. \r\n\r\nThere are two main sections in this workbook: \r\n1. The impact summary section is a high level view of the count of users, sign-ins or IP addresses that would be impacted if the associated policy was enabled in your environment.\r\n2. The impact details section will list out pertinent details of the users, sign-ins or IP addresses.\r\n\r\n**Prerequisite:** The only prerequisite is that you are capturing sign-in logs in Log Analytics. No Conditional Access policies need to be in place to run this workbook. \r\n\r\n**Additional Resources:** To learn more about deployment and configuring policies, please follow the links below: \r\n1. [Step 1: Review existing reports](https://learn.microsoft.com/en-us/entra/id-protection/how-to-deploy-identity-protection#step-1-review-existing-reports)\r\n2. [Step 2: Plan for Conditional Access risk policies](https://learn.microsoft.com/en-us/entra/id-protection/how-to-deploy-identity-protection#step-2-plan-for-conditional-access-risk-policies)\r\n3. [Step 3: Configure your policies](https://learn.microsoft.com/en-us/entra/id-protection/how-to-deploy-identity-protection#step-3-configure-your-policies)\r\n\r\n\r\n"
      },
      "conditionalVisibility": {
        "parameterName": "Guide",
        "comparison": "isEqualTo",
        "value": "On"
      },
      "name": "text - 1"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "4f97cbf0-5bdd-4ede-bcff-51610d02a7f8",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "label": "Time range",
            "type": 4,
            "isRequired": true,
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 300000
                },
                {
                  "durationMs": 900000
                },
                {
                  "durationMs": 1800000
                },
                {
                  "durationMs": 3600000
                },
                {
                  "durationMs": 14400000
                },
                {
                  "durationMs": 43200000
                },
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 172800000
                },
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 1209600000
                },
                {
                  "durationMs": 2419200000
                },
                {
                  "durationMs": 2592000000
                },
                {
                  "durationMs": 5184000000
                },
                {
                  "durationMs": 7776000000
                }
              ],
              "allowCustom": true
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "value": {
              "durationMs": 1209600000
            }
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "customWidth": "30",
      "name": "parameters - 5 - Copy"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## Impact summary of recommeded risk-based access policies"
            },
            "name": "text - 0"
          },
          {
            "type": 1,
            "content": {
              "json": "## User risk scenarios "
            },
            "customWidth": "50",
            "name": "text - 0 - Copy",
            "styleSettings": {
              "maxWidth": "50"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "## Sign-in risk & trusted network scenarios"
            },
            "customWidth": "50",
            "name": "text - 0 - Copy - Copy",
            "styleSettings": {
              "maxWidth": "50"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs \r\n| where ResultType == 0  \r\n| where RiskLevelAggregated == 'high' \r\n| where AppDisplayName <> \"Microsoft Authentication Broker\" \r\n| extend authRequirement = tostring(parse_json(AuthenticationRequirementPolicies)[1].requirementProvider) \r\n| distinct UserPrincipalName = tolower(UserPrincipalName)\r\n| summarize [\"Blocked high risk users\"] = count(UserPrincipalName)",
              "size": 3,
              "showAnalytics": true,
              "title": "1. High risk users not being blocked",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "gridSettings": {
                "rowLimit": 30
              },
              "sortBy": [],
              "tileSettings": {
                "titleContent": {},
                "leftContent": {
                  "columnMatch": "Blocked high risk users",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "maximumFractionDigits": 2,
                      "maximumSignificantDigits": 3
                    }
                  }
                },
                "showBorder": false,
                "rowLimit": 15
              },
              "textSettings": {
                "style": "bignumber"
              }
            },
            "customWidth": "25",
            "name": "Count of high risk users not being blocked by risk-based access policies",
            "styleSettings": {
              "margin": "0",
              "maxWidth": "25"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs \r\n| where ResultType == 0  \r\n| where RiskLevelAggregated == 'high' \r\n| where AppDisplayName <> \"Microsoft Authentication Broker\" \r\n| extend authRequirement = tostring(parse_json(AuthenticationRequirementPolicies)[1].requirementProvider) \r\n| distinct UserPrincipalName\r\n| summarize count(UserPrincipalName)",
              "size": 3,
              "showAnalytics": true,
              "title": "2. High risk users not prompted for password change",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "gridSettings": {
                "rowLimit": 30
              },
              "tileSettings": {
                "titleContent": {
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "count_UserPrincipalName",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "maximumFractionDigits": 2,
                      "maximumSignificantDigits": 3
                    }
                  }
                },
                "showBorder": false,
                "rowLimit": 15
              }
            },
            "customWidth": "25",
            "name": "High risk users not being prompted to change password"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs \r\n| where ResultType in (0) | where AppDisplayName <> \"Microsoft Authentication Broker\"  | where RiskLevelDuringSignIn in (\"high\") | distinct UserPrincipalName = tolower(UserPrincipalName)\r\n| count",
              "size": 3,
              "showAnalytics": true,
              "title": "1. High risk sign-ins not being blocked",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "gridSettings": {
                "rowLimit": 30
              },
              "sortBy": [],
              "tileSettings": {
                "titleContent": {},
                "leftContent": {
                  "columnMatch": "Count",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "maximumFractionDigits": 2,
                      "maximumSignificantDigits": 3
                    }
                  }
                },
                "showBorder": false
              }
            },
            "customWidth": "25",
            "name": "Count of users with high risk sign-ins not being blocked byrisk-based access policies",
            "styleSettings": {
              "margin": "0",
              "maxWidth": "25"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let strauthreq = SigninLogs \r\n| where ResultType in (50074)| where RiskLevelDuringSignIn in (\"high\") | where AuthenticationRequirementPolicies !has \"riskBasedPolicy\" | distinct CorrelationId; \r\nSigninLogs | where ResultType in (0) | where AppDisplayName <> \"Microsoft Authentication Broker\"  | where RiskLevelDuringSignIn in (\"high\") | where CorrelationId !in (strauthreq) | extend authRequirement = tostring(parse_json(AuthenticationRequirementPolicies)[1].requirementProvider) | where authRequirement <> \"riskBasedPolicy\" | distinct UserPrincipalName = tolower(UserPrincipalName)\r\n| count",
              "size": 3,
              "showAnalytics": true,
              "title": "2. High risk sign-ins not remediated using multifactor authentication",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "gridSettings": {
                "rowLimit": 30
              },
              "tileSettings": {
                "titleContent": {
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "Count",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "maximumFractionDigits": 2,
                      "maximumSignificantDigits": 3
                    }
                  }
                },
                "showBorder": false
              }
            },
            "customWidth": "25",
            "name": "Count of users with high risk sign-ins not being prompted for MFA by risk-based access policies"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs \r\n| where AuthenticationRequirementPolicies has \"riskBasedPolicy\" \r\n| where ResultType == 50142 | distinct UserPrincipalName = tolower(UserPrincipalName)\r\n| summarize count(UserPrincipalName)",
              "size": 3,
              "showAnalytics": true,
              "title": "3. Users that changed password",
              "noDataMessage": "no result type 50142 found",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {},
                "leftContent": {
                  "columnMatch": "count_UserPrincipalName",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "maximumFractionDigits": 2,
                      "maximumSignificantDigits": 3
                    }
                  }
                },
                "showBorder": false,
                "rowLimit": 15
              }
            },
            "customWidth": "25",
            "name": "Count of users that changed password due to risk-based access policies"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs \r\n| where ResultType !in (0,50074,50140,50097) | where AppDisplayName <> \"Microsoft Authentication Broker\"   \r\n| where (RiskState == \"atRisk\" and RiskLevelAggregated in (\"high\")) or ResultType == 530032 | extend authRequirement = tostring(parse_json(AuthenticationRequirementPolicies)[1].requirementProvider) | where authRequirement <> \"riskBasedPolicy\"| distinct UserPrincipalName\r\n| summarize count(UserPrincipalName)",
              "size": 3,
              "showAnalytics": true,
              "title": "4. High risk users not successfully signing-in",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "gridSettings": {
                "sortBy": [
                  {
                    "itemKey": "RiskLevelAggregated",
                    "sortOrder": 1
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "RiskLevelAggregated",
                  "sortOrder": 1
                }
              ],
              "tileSettings": {
                "titleContent": {},
                "leftContent": {
                  "columnMatch": "count_UserPrincipalName",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "maximumFractionDigits": 2,
                      "maximumSignificantDigits": 3
                    }
                  }
                },
                "showBorder": false
              }
            },
            "customWidth": "25",
            "name": "Count of users not successfully signing-in due to risk-based access policies"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs  | where RiskDetail == \"userPassedMFADrivenByRiskBasedPolicy\" | where ResultType in (0) | where AppDisplayName <> \"Microsoft Authentication Broker\" | distinct TimeGenerated, UserPrincipalName\r\n|count",
              "size": 3,
              "showAnalytics": true,
              "title": "3. Risky sign-ins remediated by multifactor authentication",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {},
                "leftContent": {
                  "columnMatch": "Count",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "maximumFractionDigits": 2,
                      "maximumSignificantDigits": 3
                    }
                  }
                },
                "showBorder": false
              }
            },
            "customWidth": "25",
            "name": "Count of risky sign-ins remediated by MFA"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//SigninLogs | where ResultType !in (0,50074,50140,50053,50126,50097,70044,53000,50173,50129) and ResultDescription <> \"Other\" | where AppDisplayName <> \"Microsoft Authentication Broker\" | where RiskLevelDuringSignIn in (\"low\",\"medium\",\"high\")   | extend authRequirement = tostring(parse_json(AuthenticationRequirementPolicies)[1].requirementProvider) | project TimeGenerated,ResultType, ResultDescription,AppDisplayName, UserPrincipalName,UserType, RiskLevelAggregated, RiskLevelDuringSignIn, RiskState, RiskDetail, RiskEventTypes_V2, ConditionalAccessStatus, AuthenticationRequirement\r\nSigninLogs \r\n| where ResultType == 53003 or AuthenticationRequirementPolicies has \"riskBasedPolicy\"\r\n| where ResultType !in (0,50074,50140,50053,50126,50097,70044,53000,50173,50129) and ResultDescription <> \"Other\" | where AppDisplayName <> \"Microsoft Authentication Broker\"  \r\n| where RiskLevelDuringSignIn in (\"high\")  | distinct UserPrincipalName\r\n|count",
              "size": 3,
              "showAnalytics": true,
              "title": "4. High risk sign-ins not successful",
              "noDataMessage": "no result type 50142 found",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {},
                "leftContent": {
                  "columnMatch": "Count",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "maximumFractionDigits": 2,
                      "maximumSignificantDigits": 3
                    }
                  }
                },
                "showBorder": false
              }
            },
            "customWidth": "25",
            "name": "Count of high risk sign-ins not successful due to risk-based access policies"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs  \r\n| where RiskState == \"remediated\" | where ResultType in (0) | where AppDisplayName <> \"Microsoft Authentication Broker\" | where RiskDetail == \"userChangedPasswordOnPremises\" | project TimeGenerated, UserPrincipalName,UserType, RiskLevelAggregated, RiskLevelDuringSignIn, RiskState, RiskDetail, RiskEventTypes_V2\r\n|summarize count(UserPrincipalName)",
              "size": 3,
              "showAnalytics": true,
              "title": "5. User risk remediated by on-premise password reset",
              "noDataMessage": "Consider on-premises password reset to remediate user risks setting",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {},
                "leftContent": {
                  "columnMatch": "count_UserPrincipalName",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "maximumFractionDigits": 2,
                      "maximumSignificantDigits": 3
                    }
                  }
                },
                "showBorder": false
              }
            },
            "customWidth": "25",
            "name": "Count of users risk remediated by On-Premise Password Reset - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs  \r\n| where RiskState == \"remediated\" \r\n| where ResultType in (0) \r\n| where AppDisplayName <> \"Microsoft Authentication Broker\" \r\n| where RiskDetail == \"userPerformedSecuredPasswordReset\" \r\n| project TimeGenerated, UserPrincipalName,UserType, RiskLevelAggregated, RiskLevelDuringSignIn, RiskState, RiskDetail, RiskEventTypes_V2\r\n|summarize count(UserPrincipalName)",
              "size": 3,
              "showAnalytics": true,
              "title": "6. User risk remediated by password reset",
              "noDataMessage": "Count of users risk remediated by Password Reset",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {},
                "leftContent": {
                  "columnMatch": "count_UserPrincipalName",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "maximumFractionDigits": 2,
                      "maximumSignificantDigits": 3
                    }
                  }
                },
                "showBorder": false
              }
            },
            "customWidth": "25",
            "name": "Count of users risk remediated by Password Reset"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n//| where TimeGenerated > ago(30d)\r\n| where ResultType == \"0\"\r\n| where HomeTenantId == ResourceTenantId and UserType <> \"Guest\"\r\n| where NetworkLocationDetails !contains \"trustedNamedLocation\"\r\n| distinct IPAddress, UserPrincipalName\r\n| summarize UniqueUserCount = count() by IPAddress\r\n| where UniqueUserCount >= 10 \r\n| summarize count(IPAddress)",
              "size": 3,
              "showAnalytics": true,
              "title": "5. IP addresses not trusted",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "gridSettings": {
                "sortBy": [
                  {
                    "itemKey": "RiskLevelAggregated",
                    "sortOrder": 1
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "RiskLevelAggregated",
                  "sortOrder": 1
                }
              ],
              "tileSettings": {
                "titleContent": {},
                "leftContent": {
                  "columnMatch": "count_IPAddress",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "maximumFractionDigits": 2,
                      "maximumSignificantDigits": 3
                    }
                  }
                },
                "showBorder": false
              }
            },
            "customWidth": "25",
            "name": "Count of IP addresses with multiple user not trusted that might impact sign-in risk"
          }
        ]
      },
      "name": "Impact Summary"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## Impact details: User risk scenerios"
            },
            "name": "text - 0 - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs \r\n| where ResultType == 0  \r\n| where RiskLevelAggregated == 'high' and RiskState == \"atRisk\"\r\n| where AppDisplayName <> \"Microsoft Authentication Broker\" \r\n| extend authRequirement = tostring(parse_json(AuthenticationRequirementPolicies)[1].requirementProvider) \r\n| distinct ResultType, ResultDescription,AppDisplayName, UserDisplayName, UserPrincipalName = tolower(UserPrincipalName),UserType, RiskLevelAggregated, RiskLevelDuringSignIn,   RiskEventTypes_V2\r\n| summarize  Applications=make_set(AppDisplayName),\r\n[\"User risk level\"]=make_set(RiskLevelAggregated), \r\n[\"Sign-in risk level\"] = make_set(RiskLevelDuringSignIn),\r\n[\"Risk types\"]=make_set(RiskEventTypes_V2)\r\n by UserDisplayName,UserPrincipalName, UserType\r\n | project [\"User display name\"] = UserDisplayName,[\"User principal name\"] = UserPrincipalName, [\"User type\"] = UserType, [\"User risk level\"], [\"Sign-in risk level\"], [\"Risk types\"],Applications",
              "size": 3,
              "title": "1. High risk users not being blocked by risk-based access policy",
              "timeContextFromParameter": "TimeRange",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "rowLimit": 15
              },
              "sortBy": []
            },
            "name": "High risk users not being blocked by risk-based access policy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs \r\n| where ResultType == 0  \r\n| where RiskState == \"atRisk\" and RiskLevelAggregated == 'high' \r\n| where AppDisplayName <> \"Microsoft Authentication Broker\" \r\n| extend authRequirement = tostring(parse_json(AuthenticationRequirementPolicies)[1].requirementProvider) \r\n| distinct ResultType, ResultDescription,AppDisplayName, UserDisplayName, UserPrincipalName = tolower(UserPrincipalName),UserType, RiskLevelAggregated, RiskLevelDuringSignIn,   RiskEventTypes_V2\r\n| summarize  Applications=make_set(AppDisplayName),\r\n[\"User risk level\"]=make_set(RiskLevelAggregated), \r\n[\"Sign-in risk level\"] = make_set(RiskLevelDuringSignIn),\r\n[\"Risk types\"]=make_set(RiskEventTypes_V2)\r\n by UserDisplayName,UserPrincipalName, UserType\r\n| project [\"User display name\"] = UserDisplayName,[\"User principal name\"] = UserPrincipalName, [\"User type\"] = UserType, [\"User risk level\"], [\"Sign-in risk level\"], [\"Risk types\"],Applications",
              "size": 3,
              "title": "2. High risk users not being prompted to change password by risk-based access policy",
              "timeContextFromParameter": "TimeRange",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "gridSettings": {
                "rowLimit": 15
              }
            },
            "name": "High risk users not being prompted to change password by risk-based access policy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs \r\n| where AuthenticationRequirementPolicies has \"riskBasedPolicy\" \r\n| where ResultType == 50142 \r\n| distinct ResultType, ResultDescription,AppDisplayName, UserDisplayName,UserPrincipalName,UserType, RiskLevelAggregated, RiskLevelDuringSignIn, RiskState, RiskDetail, RiskEventTypes_V2\r\n| summarize  Applications=make_list(AppDisplayName) by [\"User display name\"] = UserDisplayName,[\"User principal name\"] = UserPrincipalName, [\"User type\"] = UserType, [\"User risk level\"] = RiskLevelAggregated,  [\"Sign-in risk level\"] = RiskLevelDuringSignIn,   [\"Risk types\"] = RiskEventTypes_V2, [\"Result type\"] = ResultType, [\"Result description\"] = ResultDescription",
              "size": 3,
              "title": "3. Users that changed password due to risk-based access policy",
              "timeContextFromParameter": "TimeRange",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "rowLimit": 15
              }
            },
            "name": "Users that changed password due to risk-based access policy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs \r\n| where ResultType !in (0,50074,50140,50097) \r\n| where AppDisplayName <> \"Microsoft Authentication Broker\"   \r\n| where RiskState == \"atRisk\" and RiskLevelAggregated in (\"high\") and ConditionalAccessStatus <> \"notApplied\"\r\n| extend authRequirement = tostring(parse_json(AuthenticationRequirementPolicies)[1].requirementProvider) \r\n| where authRequirement <> \"riskBasedPolicy\"\r\n| distinct ResultType, ResultDescription,AppDisplayName, UserDisplayName, UserPrincipalName = tolower(UserPrincipalName),UserType, RiskLevelAggregated, RiskLevelDuringSignIn,   RiskEventTypes_V2,RiskDetail\r\n| summarize  Applications=make_set(AppDisplayName),\r\n[\"User risk level\"]=make_set(RiskLevelAggregated), \r\n[\"Sign-in risk level\"] = make_set(RiskLevelDuringSignIn),\r\n[\"Risk types\"]=make_set(RiskEventTypes_V2)\r\n by UserDisplayName,UserPrincipalName, UserType, RiskDetail,ResultType, ResultDescription\r\n| project [\"User display name\"] = UserDisplayName,[\"User principal name\"] = UserPrincipalName, [\"User type\"] = UserType, [\"User risk level\"], [\"Sign-in risk level\"], [\"Risk types\"], [\"Risk detail\"] = RiskDetail,Applications, [\"Result type\"] = ResultType, [\"Result description\"] = ResultDescription",
              "size": 3,
              "title": "4. Risky users not successfully signing-in due to risk-based access policy",
              "timeContextFromParameter": "TimeRange",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "rowLimit": 15
              },
              "sortBy": []
            },
            "name": "Risky users not successfully signing-in due to risk-based access policy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs \r\n| where RiskState == \"remediated\" | where ResultType in (0) | where AppDisplayName <> \"Microsoft Authentication Broker\" | where RiskDetail == \"userChangedPasswordOnPremises\" \r\n| distinct ResultType, ResultDescription,AppDisplayName, UserDisplayName, UserPrincipalName = tolower(UserPrincipalName),UserType, RiskLevelAggregated, RiskLevelDuringSignIn,   RiskEventTypes_V2,RiskDetail\r\n| summarize  Applications=make_set(AppDisplayName),\r\n[\"User Risk Level\"]=make_set(RiskLevelAggregated), \r\n[\"Sign-in Risk Level\"] = make_set(RiskLevelDuringSignIn),\r\n[\"Risk Types\"]=make_set(RiskEventTypes_V2)\r\n by UserDisplayName,UserPrincipalName, UserType, RiskDetail,ResultType, ResultDescription\r\n | project [\"User Display Name\"] = UserDisplayName,[\"User Principal Name\"] = UserPrincipalName, [\"User Type\"] = UserType, [\"User Risk Level\"], [\"Sign-in Risk Level\"], [\"Risk Types\"], [\"Risk Detail\"] = RiskDetail,Applications, [\"Result Type\"] = ResultType, [\"Result Description\"] = ResultDescription",
              "size": 3,
              "title": "5. Users risk remediated by on-premise password reset",
              "noDataMessage": "The query returned no results. Consider on-premises password reset to remediate user risk.",
              "timeContextFromParameter": "TimeRange",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "rowLimit": 15
              }
            },
            "name": "Users Risk remediated by on-premise password reset"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs \r\n| where RiskState == \"remediated\" | where ResultType in (0) | where AppDisplayName <> \"Microsoft Authentication Broker\" | where RiskDetail == \"userPerformedSecuredPasswordReset\" \r\n| distinct ResultType, ResultDescription,AppDisplayName, UserDisplayName, UserPrincipalName = tolower(UserPrincipalName),UserType, RiskLevelAggregated, RiskLevelDuringSignIn,   RiskEventTypes_V2,RiskDetail\r\n| summarize  Applications=make_set(AppDisplayName),\r\n[\"User Risk Level\"]=make_set(RiskLevelAggregated), \r\n[\"Sign-in Risk Level\"] = make_set(RiskLevelDuringSignIn),\r\n[\"Risk Types\"]=make_set(RiskEventTypes_V2)\r\n by UserDisplayName,UserPrincipalName, UserType, RiskDetail\r\n | project [\"User Display Name\"] = UserDisplayName,[\"User Principal Name\"] = UserPrincipalName, [\"User Type\"] = UserType,[\"Risk Detail\"] = RiskDetail, [\"User Risk Level\"], [\"Sign-in Risk Level\"], [\"Risk Types\"],Applications",
              "size": 3,
              "title": "6. Users risk remediated by password reset",
              "noDataMessage": "The query returned no results. Consider password reset to remediate user risk.",
              "timeContextFromParameter": "TimeRange",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "rowLimit": 15,
                "sortBy": [
                  {
                    "itemKey": "RiskDetail",
                    "sortOrder": 1
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "RiskDetail",
                  "sortOrder": 1
                }
              ]
            },
            "name": "Users risk remediated by password reset"
          }
        ]
      },
      "name": "Impact Details: User Risk"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## Impact details: Sign-in risk policy scenerios"
            },
            "name": "text - 0"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs \r\n| where ResultType in (0) | where AppDisplayName <> \"Microsoft Authentication Broker\"  | where RiskLevelDuringSignIn in (\"high\") \r\n| distinct ResultType, ResultDescription,AppDisplayName, UserDisplayName, UserPrincipalName = tolower(UserPrincipalName),UserType, RiskLevelAggregated, RiskLevelDuringSignIn,   RiskEventTypes_V2\r\n| summarize  Applications=make_set(AppDisplayName),\r\n[\"User risk level\"]=make_set(RiskLevelAggregated), \r\n[\"Risk types\"]=make_set(RiskEventTypes_V2)\r\n by UserDisplayName,UserPrincipalName, UserType,  [\"Sign-in risk level\"] = RiskLevelDuringSignIn\r\n | project [\"User display name\"] = UserDisplayName,[\"User principal name\"] = UserPrincipalName, [\"User type\"] = UserType, [\"User risk level\"], [\"Sign-in risk level\"], [\"Risk types\"],Applications",
              "size": 3,
              "title": "1. High risk sign-ins not being blocked by risk-based access policy",
              "timeContextFromParameter": "TimeRange",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "gridSettings": {
                "rowLimit": 15
              }
            },
            "name": "High risk sign-ins not being blocked by risk-based access policy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let strauthreq = SigninLogs \r\n| where ResultType in (50074)\r\n| where RiskLevelDuringSignIn in (\"high\") \r\n| where AuthenticationRequirementPolicies !has \"riskBasedPolicy\" | distinct CorrelationId; SigninLogs | where RiskState <> \"remediated\" | where ResultType in (0) | where AppDisplayName <> \"Microsoft Authentication Broker\"  | where RiskLevelDuringSignIn in (\"high\") | where CorrelationId !in (strauthreq) | extend authRequirement = tostring(parse_json(AuthenticationRequirementPolicies)[1].requirementProvider) | where authRequirement <> \"riskBasedPolicy\" \r\n| distinct ResultType, ResultDescription,AppDisplayName, UserDisplayName, UserPrincipalName = tolower(UserPrincipalName),UserType, RiskLevelAggregated, RiskLevelDuringSignIn,   RiskEventTypes_V2\r\n| summarize  Applications=make_set(AppDisplayName),\r\n[\"User risk level\"]=make_set(RiskLevelAggregated), \r\n[\"Risk types\"]=make_set(RiskEventTypes_V2)\r\n by UserDisplayName,UserPrincipalName, UserType,  [\"Sign-in risk level\"] = RiskLevelDuringSignIn\r\n | project [\"User display name\"] = UserDisplayName,[\"User principal name\"] = UserPrincipalName, [\"User type\"] = UserType, [\"User risk level\"], [\"Sign-in risk level\"], [\"Risk types\"],Applications",
              "size": 3,
              "title": "2. High risk sign-ins not self-remediating using multifactor authentication by risk-based access policy",
              "timeContextFromParameter": "TimeRange",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "gridSettings": {
                "rowLimit": 15
              },
              "sortBy": []
            },
            "name": "High risk sign-ins not being prompted for MFA by risk-based access policy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//SigninLogs | where ResultType !in (0,50074,50140,50053,50126,50097,70044,53000,50173,50129) and ResultDescription <> \"Other\" | where AppDisplayName <> \"Microsoft Authentication Broker\" | where RiskLevelDuringSignIn in (\"low\",\"medium\",\"high\")   | extend authRequirement = tostring(parse_json(AuthenticationRequirementPolicies)[1].requirementProvider) | project TimeGenerated,ResultType, ResultDescription,AppDisplayName, UserPrincipalName,UserType, RiskLevelAggregated, RiskLevelDuringSignIn, RiskState, RiskDetail, RiskEventTypes_V2, ConditionalAccessStatus, AuthenticationRequirement\r\nSigninLogs \r\n| where ResultType == 53003 or AuthenticationRequirementPolicies has \"riskBasedPolicy\"  and ConditionalAccessStatus <> \"notApplied\"\r\n| where ResultType !in (0,50074,50140,50053,50126,50097,70044,53000,50173,50129) and ResultDescription <> \"Other\" | where AppDisplayName <> \"Microsoft Authentication Broker\"  \r\n| where RiskLevelDuringSignIn in (\"high\")  \r\n| extend Policy = tostring(parse_json(AuthenticationRequirementPolicies)[1].requirementProvider)  \r\n| distinct ResultType, ResultDescription,AppDisplayName, UserDisplayName, UserPrincipalName = tolower(UserPrincipalName),UserType, RiskLevelAggregated, RiskLevelDuringSignIn,   RiskEventTypes_V2\r\n| summarize  Applications=make_set(AppDisplayName),\r\n[\"User risk level\"]=make_set(RiskLevelAggregated), \r\n[\"Risk types\"]=make_set(RiskEventTypes_V2)\r\n by UserDisplayName,UserPrincipalName, UserType,  [\"Sign-in risk level\"] = RiskLevelDuringSignIn,ResultType, ResultDescription\r\n | project [\"User display name\"] = UserDisplayName,[\"User principal name\"] = UserPrincipalName, [\"User type\"] = UserType, [\"User risk level\"], [\"Sign-in risk level\"], [\"Risk types\"],Applications, [\"Result type\"] = ResultType, [\"Result description\"] = ResultDescription",
              "size": 3,
              "title": "3. Risky sign-ins not successfull due to risk-based access policy",
              "timeContextFromParameter": "TimeRange",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "gridSettings": {
                "rowLimit": 15
              },
              "sortBy": []
            },
            "name": "Risky sign-ins not successfull due to risk-based access policy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "\r\nSigninLogs  | where RiskDetail == \"userPassedMFADrivenByRiskBasedPolicy\" | where ResultType in (0) | where AppDisplayName <> \"Microsoft Authentication Broker\" \r\n| distinct ResultType, ResultDescription,AppDisplayName, UserDisplayName,UserPrincipalName,UserType, RiskLevelAggregated, RiskLevelDuringSignIn, RiskState, RiskDetail, RiskEventTypes_V2\r\n| summarize  Applications=make_list(AppDisplayName) by [\"User display name\"] = UserDisplayName,[\"User principal name\"] = UserPrincipalName, [\"User type\"] = UserType, [\"Risk detail\"] = RiskDetail,[\"User risk level\"] = RiskLevelAggregated,  [\"Sign-in risk level\"] = RiskLevelDuringSignIn,   [\"Risk types\"] = RiskEventTypes_V2, [\"Result type\"] = ResultType, [\"Result description\"] = ResultDescription",
              "size": 3,
              "title": "4. Risky sign-ins remediated by multifactor authentication",
              "timeContextFromParameter": "TimeRange",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "gridSettings": {
                "rowLimit": 15
              },
              "sortBy": []
            },
            "name": "Risky sign-ins remediated by MFA"
          }
        ]
      },
      "name": "Sign-in risk"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## Impact details: Trusted network\r\n\r\nConfigured trusted network locations are used by Identity Protection in some risk detections to reduce false positives.\r\n\r\nSummary of IP addresses that are not listed as a trusted network that could be due to the number of unique users signing in from the IP. Use the autonomous system number (ASN) to help identify the owner of the network to determine if it should be listed as trusted for Conditional Access policies."
            },
            "name": "text - 0"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n//| where TimeGenerated > ago(30d)\r\n| where ResultType == \"0\"\r\n| where HomeTenantId == ResourceTenantId and UserType <> \"Guest\"\r\n| where NetworkLocationDetails !contains \"trustedNamedLocation\"\r\n| extend TrustedLocation = tostring(iff(NetworkLocationDetails contains 'trustedNamedLocation', 'trustedNamedLocation',''))\r\n| extend isIPv6 = tostring(iff(IPAddress matches regex @\"(([\\d|\\w]{1,4}\\:){7}[\\d|\\w]{1,4})\",'Yes','No'))\r\n| distinct IPAddress, TrustedLocation, UserPrincipalName, isIPv6, AutonomousSystemNumber, Location\r\n| summarize UniqueUserCount = count() by IPAddress, TrustedLocation, isIPv6, AutonomousSystemNumber, Location\r\n| where UniqueUserCount >= 4\r\n| sort by UniqueUserCount desc \r\n| project  [\"IP address\"] = IPAddress, [\"Unique user count\"] = UniqueUserCount, [\"Trusted location\"] = TrustedLocation, [\"is IPv6\"] = isIPv6, [\"Autonomous system number (ASN)\"] = AutonomousSystemNumber, Location",
              "size": 3,
              "showAnalytics": true,
              "title": "5. IP addresses not listed as trusted network",
              "timeContextFromParameter": "TimeRange",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "gridSettings": {
                "rowLimit": 15
              }
            },
            "name": "Trusted network"
          }
        ]
      },
      "name": "group - 2"
    }
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
