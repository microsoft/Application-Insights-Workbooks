{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "# Sensitive Operations Report - Apps, Service Principals and Federation Settings"
      },
      "customWidth": "85",
      "name": "text - 2"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "00422c2b-b3bb-4bc1-b81a-54ab484f9a74",
            "version": "KqlParameterItem/1.0",
            "name": "Workspace",
            "type": 5,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "value": [
              "value::all"
            ],
            "typeSettings": {
              "resourceTypeFilter": {
                "microsoft.operationalinsights/workspaces": true
              },
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            }
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "customWidth": "15",
      "name": "parameters - 3"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "paragraph",
        "links": [
          {
            "id": "f02d3e95-c5e9-48ff-b4cf-3c1268b9ef5f",
            "cellValue": "https://aka.ms/SensitiveOperationsWorkbookDocs",
            "linkTarget": "Url",
            "linkLabel": "Learn more",
            "preText": "This workbook is intended to help identify suspicious application and service principal activity that may indicate compromises in your environment. ",
            "postText": " about best practices to protect M365 from attacks.",
            "style": "link"
          }
        ]
      },
      "name": "links - 7"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Modified application and service principal credentials/authentication methods",
        "expandable": true,
        "items": [
          {
            "type": 1,
            "content": {
              "json": "# Modified Application and Service Principal Credentials/Authentication Methods\r\n\r\nApplications and service principals can have multiple authentication methods that are simultaneously valid. It's important to monitor updates to your service principal authentication methods in case bad actors are adding new rogue credentials to allow themselves to authenticate as that service principal."
            },
            "name": "text - 1"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "41bb729a-1f00-463c-a600-ce6c15823f73",
                  "version": "KqlParameterItem/1.0",
                  "name": "TimeRange",
                  "type": 4,
                  "isRequired": true,
                  "value": {
                    "durationMs": 172800000
                  },
                  "typeSettings": {
                    "selectableValues": [
                      {
                        "durationMs": 86400000
                      },
                      {
                        "durationMs": 172800000
                      },
                      {
                        "durationMs": 604800000
                      },
                      {
                        "durationMs": 1209600000
                      },
                      {
                        "durationMs": 2592000000
                      },
                      {
                        "durationMs": 5184000000
                      },
                      {
                        "durationMs": 7776000000
                      }
                    ]
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "timeContextFromParameter": "TimeRange"
                },
                {
                  "id": "fbee76f5-de17-4d80-844b-b01d2613d996",
                  "version": "KqlParameterItem/1.0",
                  "name": "OperationNameParam",
                  "label": "Operation name",
                  "type": 2,
                  "isRequired": true,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "value": [
                    "value::all"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "showDefault": false
                  },
                  "jsonData": "[\r\n    {\"value\": \"Add service principal credentials\", \"label\": \"Add service principal credentials\"},\r\n    {\"value\": \"Update application – Certificates and secrets management \", \"label\": \"Update application – Certificates and secrets management \"}\r\n]",
                  "timeContext": {
                    "durationMs": 2592000000
                  }
                },
                {
                  "id": "87e2dbcd-6d21-430e-a1f4-470c3dcd3892",
                  "version": "KqlParameterItem/1.0",
                  "name": "credential",
                  "label": "Credential",
                  "type": 2,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "query": "AuditLogs\r\n| where TimeGenerated {TimeRange:value}\r\n| where Category == \"ApplicationManagement\"\r\n| where \"{OperationNameParam}\" has OperationName\r\n| where OperationName != \"Add service principal\" and OperationName != \"Update application\"\r\n| mv-expand target = TargetResources\r\n| mv-expand modifiedProperty = target.modifiedProperties\r\n| extend newValue = tostring(modifiedProperty.newValue)\r\n| extend oldValue = tostring(modifiedProperty.oldValue)\r\n| extend set1 = parse_json(newValue)\r\n| extend set2 = parse_json(oldValue)\r\n| extend diff = set_difference(set1, set2)\r\n| where isnotempty(diff)\r\n| parse diff with * \"KeyIdentifier=\" keyIdentifier:string \",KeyType=\" keyType:string \",KeyUsage=\" keyUsage:string \",DisplayName=\" keyDisplayName:string \"]\" *\r\n| project credential = case(keyType != \"\", keyType, \"Other/not logged\")\r\n| summarize by credential",
                  "crossComponentResources": [
                    "{Workspace}"
                  ],
                  "value": [
                    "value::all"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 172800000
                  },
                  "timeContextFromParameter": "TimeRange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                },
                {
                  "id": "4d58037a-e6d3-4506-acd2-e8cb3fecf66d",
                  "version": "KqlParameterItem/1.0",
                  "name": "Actor",
                  "type": 1,
                  "value": "All"
                },
                {
                  "id": "cdd0f13b-af82-48ec-b726-873f86f60365",
                  "version": "KqlParameterItem/1.0",
                  "name": "ExcludeActor",
                  "label": "Exclude actor",
                  "type": 1,
                  "value": "None"
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "parameters - 2"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AuditLogs\r\n| where TimeGenerated {TimeRange:value}\r\n| where Category == \"ApplicationManagement\"\r\n| where \"{OperationNameParam}\" has OperationName\r\n| where OperationName != \"Add service principal\" and OperationName != \"Update application\"\r\n| extend Actor = iff(isnotempty(InitiatedBy.user.userPrincipalName),tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName))\r\n| where Actor contains \"{Actor:escape}\" or \"{Actor:escape}\" == \"All\"\r\n| where Actor != \"{ExcludeActor:escape}\" or \"{ExcludeActor:escape}\" == \"None\"\r\n| mv-expand target = TargetResources\r\n| mv-expand modifiedProperty = target.modifiedProperties\r\n| extend newValue = tostring(modifiedProperty.newValue)\r\n| extend oldValue = tostring(modifiedProperty.oldValue)\r\n| extend set1 = parse_json(newValue)\r\n| extend set2 = parse_json(oldValue)\r\n| extend diff = set_difference(set1, set2)\r\n| where isnotempty(diff)\r\n| parse diff with * \"KeyIdentifier=\" keyIdentifier:string \",KeyType=\" keyType:string \",KeyUsage=\" keyUsage:string \",DisplayName=\" keyDisplayName:string \"]\" *\r\n| project TimeGenerated, OperationName, Actor = iff(isnotempty(InitiatedBy.user.userPrincipalName),tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName)), Actor_Type = case(isnotnull(InitiatedBy[\"user\"]), \"User\", \"App\"), Service_Principal_Name = tostring(target.displayName), credential = case(keyType != \"\", keyType, \"Other/not logged\"), Service_Principal_ID = target.id, Result\r\n| where \"{credential}\" has credential\r\n| summarize count() by Service_Principal_Name, credential\r\n| summarize count() by credential\r\n| sort by credential asc",
              "size": 4,
              "title": "Number of application and service principals updated by authentication method ({TimeRange:label})",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "credential",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "count_",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                },
                "showBorder": true
              }
            },
            "name": "query - 3"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AuditLogs\r\n| where TimeGenerated {TimeRange:value}\r\n| where Category == \"ApplicationManagement\"\r\n| where \"{OperationNameParam}\" has OperationName\r\n| where OperationName != \"Add service principal\" and OperationName != \"Update application\"\r\n| extend Actor = iff(isnotempty(InitiatedBy.user.userPrincipalName),tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName))\r\n| where Actor contains \"{Actor:escape}\" or \"{Actor:escape}\" == \"All\"\r\n| where Actor != \"{ExcludeActor:escape}\" or \"{ExcludeActor:escape}\" == \"None\"\r\n| mv-expand target = TargetResources\r\n| mv-expand modifiedProperty = target.modifiedProperties\r\n| extend newValue = tostring(modifiedProperty.newValue)\r\n| extend oldValue = tostring(modifiedProperty.oldValue)\r\n| extend set1 = parse_json(newValue)\r\n| extend set2 = parse_json(oldValue)\r\n| extend diff = set_difference(set1, set2)\r\n| where isnotempty(diff)\r\n| parse diff with * \"KeyIdentifier=\" keyIdentifier:string \",KeyType=\" keyType:string \",KeyUsage=\" keyUsage:string \",DisplayName=\" keyDisplayName:string \"]\" *\r\n| project TimeGenerated, OperationName, Actor = iff(isnotempty(InitiatedBy.user.userPrincipalName),tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName)), Actor_Type = case(isnotnull(InitiatedBy[\"user\"]), \"User\", \"App\"), Service_Principal_Name = tostring(target.displayName), credential = case(keyType != \"\", keyType, \"Other/not logged\"), Service_Principal_ID = target.id, Result\r\n| where \"{credential}\" has credential\r\n| summarize ServicePrincipalsChanged = dcount(Service_Principal_Name) by Actor, Actor_Type\r\n| sort by ServicePrincipalsChanged desc",
              "size": 1,
              "title": "Top actors updating authentication methods ({TimeRange:label})",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "ServicePrincipalsChanged",
                    "formatter": 8,
                    "formatOptions": {
                      "palette": "red"
                    }
                  }
                ],
                "filter": true
              },
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "modifiedProperty",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "count_",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                },
                "showBorder": true
              }
            },
            "customWidth": "50",
            "name": "query - 3 - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AuditLogs\r\n| where TimeGenerated {TimeRange:value}\r\n| where Category == \"ApplicationManagement\"\r\n| where \"{OperationNameParam}\" has OperationName\r\n| where OperationName != \"Add service principal\" and OperationName != \"Update application\"\r\n| extend Actor = iff(isnotempty(InitiatedBy.user.userPrincipalName),tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName))\r\n| where Actor contains \"{Actor:escape}\" or \"{Actor:escape}\" == \"All\"\r\n| where Actor != \"{ExcludeActor:escape}\" or \"{ExcludeActor:escape}\" == \"None\"\r\n| mv-expand target = TargetResources\r\n| mv-expand modifiedProperty = target.modifiedProperties\r\n| extend newValue = tostring(modifiedProperty.newValue)\r\n| extend oldValue = tostring(modifiedProperty.oldValue)\r\n| extend set1 = parse_json(newValue)\r\n| extend set2 = parse_json(oldValue)\r\n| extend diff = set_difference(set1, set2)\r\n| where isnotempty(diff)\r\n| parse diff with * \"KeyIdentifier=\" keyIdentifier:string \",KeyType=\" keyType:string \",KeyUsage=\" keyUsage:string \",DisplayName=\" keyDisplayName:string \"]\" *\r\n| project TimeGenerated, OperationName, Actor = iff(isnotempty(InitiatedBy.user.userPrincipalName),tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName)), Actor_Type = case(isnotnull(InitiatedBy[\"user\"]), \"User\", \"App\"), Service_Principal_Name = target.displayName, credential = case(keyType != \"\", keyType, \"Other/not logged\"), Service_Principal_ID = target.id, Result\r\n| where \"{credential}\" has credential\r\n| summarize count() by bin(TimeGenerated, 1d)\r\n| sort by TimeGenerated desc",
              "size": 1,
              "title": "Updates to service principal authentication methods over time",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "timechart",
              "tileSettings": {
                "showBorder": false
              },
              "graphSettings": {
                "type": 0
              },
              "chartSettings": {
                "xAxis": "TimeGenerated",
                "yAxis": [
                  "count_"
                ],
                "xSettings": {
                  "numberFormatSettings": {
                    "unit": 0,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true
                    }
                  }
                }
              }
            },
            "customWidth": "50",
            "name": "query - 5"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AuditLogs\r\n| where TimeGenerated {TimeRange:value}\r\n| where Category == \"ApplicationManagement\"\r\n| where \"{OperationNameParam}\" has OperationName\r\n| where OperationName != \"Add service principal\" and OperationName != \"Update application\"\r\n| extend Actor = iff(isnotempty(InitiatedBy.user.userPrincipalName),tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName))\r\n| where Actor contains \"{Actor:escape}\" or \"{Actor:escape}\" == \"All\"\r\n| where Actor != \"{ExcludeActor:escape}\" or \"{ExcludeActor:escape}\" == \"None\"\r\n| mv-expand target = TargetResources\r\n| mv-expand modifiedProperty = target.modifiedProperties\r\n| extend newValue = tostring(modifiedProperty.newValue)\r\n| extend oldValue = tostring(modifiedProperty.oldValue)\r\n| extend set1 = parse_json(newValue)\r\n| extend set2 = parse_json(oldValue)\r\n| extend diff = set_difference(set1, set2)\r\n| where isnotempty(diff)\r\n| parse diff with * \"KeyIdentifier=\" keyIdentifier:string \",KeyType=\" keyType:string \",KeyUsage=\" keyUsage:string \",DisplayName=\" keyDisplayName:string \"]\" *\r\n| project TimeGenerated, OperationName, Actor = iff(isnotempty(InitiatedBy.user.userPrincipalName),tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName)), Actor_Type = case(isnotnull(InitiatedBy[\"user\"]), \"User\", \"App\"), Service_Principal_Name = target.displayName, credential = case(keyType != \"\", keyType, \"Other/not logged\"), Service_Principal_ID = target.id, Result\r\n| where \"{credential}\" has credential\r\n| sort by TimeGenerated desc\r\n",
              "size": 0,
              "title": "Recent updates to application/service principal authentication methods",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "gridSettings": {
                "filter": true
              }
            },
            "name": "query - 0"
          },
          {
            "type": 1,
            "content": {
              "json": "_____________________________________________"
            },
            "name": "text - 6"
          }
        ]
      },
      "name": "Service principals"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "New permissions granted to service principals",
        "expandable": true,
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## New permissions granted to service principals\r\n\r\nThis section monitors for changes to OAuth 2.0 permissions granted to Service Principals. For example, this alert will trigger when a Service Principal is granted Application (AppOnly) permissions to read mail through the Microsoft Graph API. When this occurs, the Service Principal is added to an App Role with a value of Mail.Read. \r\n\r\nAn attacker could elevate their privileges by using a compromised account to grant new permissions to a Service Principal they control, or by tricking a user into granting permissions. Investigations should focus on high privilege permissions that either grant access to sensitive data, or represent opportunities for lateral movement by attackers.\r\n\r\nThe first view in this section focuses specifically on Application permissions, which generally (but not always) represent higher risk. The second view is broader- it includes Delegated (App+User) permissions grants and additional audit events."
            },
            "name": "text - 0"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "54c95e1f-b654-4f29-bf74-1f14812ed938",
                  "version": "KqlParameterItem/1.0",
                  "name": "TimeRange",
                  "type": 4,
                  "isRequired": true,
                  "value": {
                    "durationMs": 172800000
                  },
                  "typeSettings": {
                    "selectableValues": [
                      {
                        "durationMs": 86400000
                      },
                      {
                        "durationMs": 172800000
                      },
                      {
                        "durationMs": 604800000
                      },
                      {
                        "durationMs": 1209600000
                      },
                      {
                        "durationMs": 2592000000
                      },
                      {
                        "durationMs": 5184000000
                      },
                      {
                        "durationMs": 7776000000
                      }
                    ],
                    "allowCustom": true
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "80d9f8f1-5928-44fc-8b50-b94f1fd4585a",
                  "version": "KqlParameterItem/1.0",
                  "name": "ClientApp",
                  "type": 1,
                  "value": "All"
                },
                {
                  "id": "2cadd1cb-53b7-41bb-b81f-e5dfcfdd4176",
                  "version": "KqlParameterItem/1.0",
                  "name": "Resource",
                  "type": 1,
                  "value": "All"
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "parameters - 4"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AuditLogs\r\n| where TimeGenerated {TimeRange:value}\r\n| where OperationName == \"Add app role assignment to service principal\"\r\n| project TimeGenerated, ClientApp = tostring(TargetResources[0].modifiedProperties[4].newValue), Resource = tostring(TargetResources[0].displayName), Role_Added = tostring(TargetResources[0].modifiedProperties[1].newValue), Explanation = tostring(TargetResources[0].modifiedProperties[2].newValue), InitiatingUserOrApp = iff(isnotempty(InitiatedBy.user.userPrincipalName),tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName))\r\n| where ClientApp contains \"{ClientApp:escape}\" or \"{ClientApp:escape}\" == \"All\"\r\n| where Resource contains \"{Resource:escape}\" or \"{Resource:escape}\" == \"All\"\r\n| summarize by ClientApp, Resource, Role_Added, Explanation, InitiatingUserOrApp, TimeGenerated",
              "size": 0,
              "title": "New Application (AppOnly) permissions added to service principals",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Resource",
                    "formatter": 5
                  }
                ],
                "filter": true,
                "hierarchySettings": {
                  "treeType": 1,
                  "groupBy": [
                    "Resource",
                    "ClientApp"
                  ],
                  "expandTopLevel": true
                }
              }
            },
            "name": "query - 5"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "cafff20d-feb7-4278-8fbf-3f93d4b422de",
                  "version": "KqlParameterItem/1.0",
                  "name": "TimeRange",
                  "type": 4,
                  "isRequired": true,
                  "value": {
                    "durationMs": 172800000
                  },
                  "typeSettings": {
                    "selectableValues": [
                      {
                        "durationMs": 43200000
                      },
                      {
                        "durationMs": 86400000
                      },
                      {
                        "durationMs": 172800000
                      },
                      {
                        "durationMs": 604800000
                      },
                      {
                        "durationMs": 1209600000
                      },
                      {
                        "durationMs": 2592000000
                      },
                      {
                        "durationMs": 5184000000
                      },
                      {
                        "durationMs": 7776000000
                      }
                    ]
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "e1c39ee2-fff3-40be-9bd9-7135f3e8b46d",
                  "version": "KqlParameterItem/1.0",
                  "name": "Operation",
                  "type": 2,
                  "isRequired": true,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "value": [
                    "value::all"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "showDefault": false
                  },
                  "jsonData": "[\r\n    {\"value\": \"Consent to application\", \"label\": \"Consent to application\"},\r\n    {\"value\": \"Add app role assignment to service principal\", \"label\": \"Add app role assignment to service principal\"},    \r\n    {\"value\": \"Add delegated permission grant\", \"label\": \"Add delegated permission grant\"}\r\n]",
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "f899aaae-f278-4f5c-a665-9aba1ba92b9f",
                  "version": "KqlParameterItem/1.0",
                  "name": "InitiatingUserOrApp",
                  "type": 1,
                  "value": "All",
                  "timeContext": {
                    "durationMs": 86400000
                  }
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "parameters - 2"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AuditLogs\r\n| where TimeGenerated {TimeRange:value}\r\n| where \"{Operation}\" has OperationName\r\n| extend InitiatingUserOrApp = iff(isnotempty(InitiatedBy.user.userPrincipalName),tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName))\r\n| where InitiatingUserOrApp contains \"{InitiatingUserOrApp:escape}\" or \"{InitiatingUserOrApp:escape}\" == \"All\"\r\n| extend ClientApp = case(OperationName == \"Consent to application\", TargetResources[0].displayName, OperationName == \"Add app role assignment to service principal\", TargetResources[1].id, OperationName == \"Add delegated permission grant\", TargetResources[1].id, \"Not logged\")\r\n| extend Resource = case(OperationName == \"Consent to application\", \"Not logged\", OperationName == \"Add app role assignment to service principal\", TargetResources[0].displayName, OperationName == \"Add delegated permission grant\", TargetResources[0].displayName, \"Not logged\")\r\n| project TimeGenerated, InitiatingUserOrApp, OperationName, ClientApp, Resource, Result\r\n| sort by TimeGenerated desc\r\n",
              "size": 0,
              "title": "Recent app permissions activity",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ]
            },
            "name": "Recent app permissions activity"
          },
          {
            "type": 1,
            "content": {
              "json": "________________________________________________"
            },
            "name": "text - 5"
          }
        ]
      },
      "name": "Permissions"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Directory role and group membership updates to service principals",
        "expandable": true,
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## Directory role and group membership updates to service principals\r\n\r\nThis section monitors for Service Principals being as members of Directory Roles (admin roles) or Groups. For example, this alert will trigger when a Service Principal is added to the Company Administrator or Application Administrator role. \r\n \r\nAn attacker could elevate their privileges by adding a Service Principal they control to a high privileged role or a group that is used to protect access to sensitive resources. Investigations should focus on administrator rules and Groups that either grant access to sensitive data or represent opportunities for lateral movement by attackers.\r\n"
            },
            "name": "text - 0"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "3baa6f39-71c9-4f06-a58c-465104de8a16",
                  "version": "KqlParameterItem/1.0",
                  "name": "TimeRange",
                  "type": 4,
                  "isRequired": true,
                  "value": {
                    "durationMs": 172800000
                  },
                  "typeSettings": {
                    "selectableValues": [
                      {
                        "durationMs": 86400000
                      },
                      {
                        "durationMs": 172800000
                      },
                      {
                        "durationMs": 604800000
                      },
                      {
                        "durationMs": 1209600000
                      },
                      {
                        "durationMs": 2592000000
                      },
                      {
                        "durationMs": 5184000000
                      },
                      {
                        "durationMs": 7776000000
                      }
                    ]
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "e7a8c646-6800-40c4-9c21-445384a6a5bc",
                  "version": "KqlParameterItem/1.0",
                  "name": "Operation",
                  "type": 2,
                  "isRequired": true,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "value": [
                    "Add member to role"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "showDefault": false
                  },
                  "jsonData": "[\r\n    {\"value\": \"Add member to role\", \"label\": \"Add member to role\"},\r\n    {\"value\": \"Add eligible member to role\", \"label\": \"Add eligible member to role\"},\r\n    {\"value\": \"Add scoped member to role\", \"label\": \"Add scoped member to role\"},\r\n    {\"value\": \"Add member to group\", \"label\": \"Add member to group\"}\r\n]",
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "16bfa3f9-044a-4c17-b5a4-4116acc7a725",
                  "version": "KqlParameterItem/1.0",
                  "name": "InitiatingUserOrApp",
                  "type": 1,
                  "value": "All",
                  "timeContext": {
                    "durationMs": 86400000
                  }
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "parameters - 2"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AuditLogs\r\n| where TimeGenerated {TimeRange:value}\r\n| extend InitiatingUserOrApp = iff(isnotempty(InitiatedBy.user.userPrincipalName),tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName))\r\n| where InitiatingUserOrApp contains \"{InitiatingUserOrApp:escape}\" or \"{InitiatingUserOrApp:escape}\" == \"All\"\r\n| extend type = tostring(TargetResources[0].type)\r\n| where type == \"ServicePrincipal\"\r\n| where \"{Operation}\" has OperationName \r\n| project TimeGenerated, InitiatingUserOrApp, OperationName, ServicePrincipalDisplayName = TargetResources[0].displayName, GroupOrRoleNameAddedTo = TargetResources[0].modifiedProperties[1].newValue\r\n",
              "size": 0,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "sortBy": []
            },
            "name": "query - 1"
          }
        ]
      },
      "name": "group - 6"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Modified federation settings ",
        "expandable": true,
        "items": [
          {
            "type": 1,
            "content": {
              "json": "# Modified federation settings\r\n\r\nThis section monitors when a user or application modifies the federation settings on the domain. For example, this alert will trigger when a new Active Directory Federated Service (ADFS) TrustedRealm object, such as a signing certificate, is added to the domain. Modification to domain federation settings should be rare. Confirm the added or modified target domain/URL is legitimate administrator behavior.\r\n- To understand why an authorized user may update settings for a federated domain in Office 365, Azure, or Intune, see: https://docs.microsoft.com/office365/troubleshoot/active-directory/update-federated-domain-office-365.\r\n- For details on security realms that accept security tokens, see the ADFS Proxy Protocol (MS-ADFSPP) specification: https://docs.microsoft.com/openspecs/windows_protocols/ms-adfspp/e7b9ea73-1980-4318-96a6-da559486664b."
            },
            "name": "text - 2"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "b448e249-c85d-43d0-ba64-c552a62baad4",
                  "version": "KqlParameterItem/1.0",
                  "name": "TimeRange",
                  "type": 4,
                  "isRequired": true,
                  "value": {
                    "durationMs": 172800000
                  },
                  "typeSettings": {
                    "selectableValues": [
                      {
                        "durationMs": 43200000
                      },
                      {
                        "durationMs": 86400000
                      },
                      {
                        "durationMs": 172800000
                      },
                      {
                        "durationMs": 604800000
                      },
                      {
                        "durationMs": 1209600000
                      },
                      {
                        "durationMs": 2592000000
                      },
                      {
                        "durationMs": 5184000000
                      },
                      {
                        "durationMs": 7776000000
                      }
                    ]
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "2529872f-38b3-4409-b511-ceb5258fc338",
                  "version": "KqlParameterItem/1.0",
                  "name": "Operation",
                  "type": 2,
                  "isRequired": true,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "value": [
                    "value::all"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "showDefault": false
                  },
                  "jsonData": "[\r\n    {\"value\": \"Set domain authentication\", \"label\": \"Set domain authentication\"},\r\n    {\"value\": \"Set federation settings on domain\", \"label\": \"Set federation settings on domain\"},\r\n    {\"value\": \"Add unverified domain\", \"label\": \"Add unverified domain\"},\r\n    {\"value\": \"Add verified domain\", \"label\": \"Add verified domain\"},\r\n    {\"value\": \"Verify domain\", \"label\": \"Verify domain\"}\r\n]",
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "86b52c65-055d-4a6a-a52f-b1d69e1f3c0f",
                  "version": "KqlParameterItem/1.0",
                  "name": "InitiatingUserOrApp",
                  "type": 1,
                  "value": "All",
                  "timeContext": {
                    "durationMs": 86400000
                  }
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "parameters - 1"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "  AuditLogs\r\n  | where TimeGenerated {TimeRange:value}\r\n  | where \"{Operation}\" has OperationName\r\n  //| where Result =~ \"success\"   // commenting out, as it may be interesting to capture failed attempts\r\n  | extend targetDisplayName = tostring(TargetResources[0].displayName)\r\n  | extend UserAgent = iff(AdditionalDetails[0].key == \"User-Agent\",tostring(AdditionalDetails[0].value),\"\")\r\n  | extend InitiatingUserOrApp = iff(isnotempty(InitiatedBy.user.userPrincipalName),tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName))\r\n  | where InitiatingUserOrApp contains \"{InitiatingUserOrApp:escape}\" or \"{InitiatingUserOrApp:escape}\" == \"All\"\r\n  | project-reorder TimeGenerated, OperationName, InitiatingUserOrApp, AADOperationType, targetDisplayName, TargetResources, Result, UserAgent, CorrelationId, TenantId, AADTenantId\r\n  | sort by TimeGenerated desc\r\n",
              "size": 0,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ]
            },
            "name": "query - 0"
          },
          {
            "type": 1,
            "content": {
              "json": "________________________"
            },
            "name": "text - 7"
          }
        ]
      },
      "name": "Federation"
    }
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}