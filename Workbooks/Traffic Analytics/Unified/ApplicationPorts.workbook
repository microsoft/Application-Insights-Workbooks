{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "f79d5185-6941-488e-a728-3beaec49f9d4",
            "version": "KqlParameterItem/1.0",
            "name": "timeInterval",
            "label": "Time Interval",
            "type": 4,
            "description": "Select time interval to get data",
            "isRequired": true,
            "value": {
              "durationMs": 86400000
            },
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 1800000
                },
                {
                  "durationMs": 3600000
                },
                {
                  "durationMs": 43200000
                },
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 1209600000
                },
                {
                  "durationMs": 2592000000
                }
              ],
              "allowCustom": true
            }
          },
          {
            "id": "530edde2-9bce-4a98-9e2c-97f6f22b46df",
            "version": "KqlParameterItem/1.0",
            "name": "FlowType",
            "label": "Flow Type",
            "type": 2,
            "description": "Select a type of Flowlog",
            "isRequired": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "jsonData": "[\r\n    { \"value\":\"both\", \"label\":\"NSG and VNet flow logs\", \"selected\":true },\r\n    { \"value\":\"nsg\", \"label\":\"NSG flow logs\" },\r\n    { \"value\":\"vnet\", \"label\":\"VNet flow logs\" }\r\n]"
          },
          {
            "id": "5f59846f-1e06-4f6f-b52f-d06bb63b97fb",
            "version": "KqlParameterItem/1.0",
            "name": "workspace",
            "label": "Log Analytics Workspace",
            "type": 5,
            "description": "Select a workspace where Traffic Analytics is configured",
            "isRequired": true,
            "isGlobal": true,
            "query": "Resources\r\n| where type=~ \"microsoft.network/networkwatchers/flowlogs\"\r\n| where properties.flowAnalyticsConfiguration.networkWatcherFlowAnalyticsConfiguration.enabled == true\r\n| project wsResourceId = tolower(properties.flowAnalyticsConfiguration.networkWatcherFlowAnalyticsConfiguration.workspaceResourceId)\r\n| distinct wsResourceId\r\n| project wsResourceId, wsName = tolower(split(wsResourceId, '/')[8])\r\n",
            "crossComponentResources": [
              "value::all"
            ],
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "value": null
          },
          {
            "id": "ed680843-d803-4a08-9608-27b729cd537d",
            "version": "KqlParameterItem/1.0",
            "name": "Units",
            "label": "Display Unit",
            "type": 2,
            "description": "Display units for analysis of your traffic flows.",
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "jsonData": "[\r\n    { \"value\":\"flows\", \"label\":\"Flows\", \"selected\":true },\r\n    { \"value\":\"bytes\", \"label\":\"Bytes\" },\r\n    { \"value\":\"packets\", \"label\":\"Packets\"}\r\n]"
          },
          {
            "id": "553b6a62-5413-4f6f-b50f-bd2db686aa33",
            "version": "KqlParameterItem/1.0",
            "name": "portRange",
            "label": "Ports Range",
            "type": 2,
            "description": "Select one or more ports range",
            "isRequired": true,
            "multiSelect": true,
            "quote": "",
            "delimiter": ",",
            "query": "datatable (id: int)\r\n[0,\r\n1,\r\n2,\r\n3,\r\n4,\r\n5,\r\n6,\r\n7,\r\n8,\r\n9,\r\n10,\r\n11,\r\n12,\r\n13,\r\n14,\r\n15,\r\n16,\r\n17,\r\n18,\r\n19,\r\n20,\r\n21,\r\n22,\r\n23,\r\n24,\r\n25,\r\n26,\r\n27,\r\n28,\r\n29,\r\n30,\r\n31,\r\n32,\r\n33,\r\n34,\r\n35,\r\n36,\r\n37,\r\n38,\r\n39,\r\n40,\r\n41,\r\n42,\r\n43,\r\n44,\r\n45,\r\n46,\r\n47,\r\n48,\r\n49,\r\n50,\r\n51,\r\n52,\r\n53,\r\n54,\r\n55,\r\n56,\r\n57,\r\n58,\r\n59,\r\n60,\r\n61,\r\n62,\r\n63,\r\n64,\r\n65]\r\n| project value = strcat(tostring(id*1000), '-', tostring(min_of(65535, id*1000+999))), label = strcat(tostring(id*1000), '-', tostring(min_of(65535, id*1000+999))), selected = 1",
            "crossComponentResources": [
              "{workspace}"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "selectAllValue": "*",
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 1800000
            },
            "defaultValue": "value::all",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          },
          {
            "id": "f3c20382-2b69-4d56-911b-0d9fee794a9c",
            "version": "KqlParameterItem/1.0",
            "name": "isNSGTopologySchemaPresent",
            "type": 1,
            "description": "Schema Check",
            "isRequired": true,
            "query": "let SchemaTable = view () { print isPresent = 'false' };\r\nunion isfuzzy = true SchemaTable, (AzureNetworkAnalytics_CL | take 1 | project isPresent = iff(iscolumnexists('DiscoveryRegion_s'), 'true', 'false')) \r\n| top 1 by isPresent",
            "crossComponentResources": [
              "{workspace}"
            ],
            "isHiddenWhenLocked": true,
            "defaultValue": "value::all",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          },
          {
            "id": "84e0ab54-be7e-454d-b382-624f4c18d5b9",
            "version": "KqlParameterItem/1.0",
            "name": "isNSGFlowSchemaPresent",
            "type": 1,
            "description": "Schema Check",
            "isRequired": true,
            "query": "let SchemaTable = view () { print isPresent = 'false' };\r\nunion isfuzzy = true SchemaTable, (AzureNetworkAnalytics_CL | take 1 | project isPresent = iff(iscolumnexists('AllowedInFlows_d'), 'true', 'false')) \r\n| top 1 by isPresent",
            "crossComponentResources": [
              "{workspace}"
            ],
            "isHiddenWhenLocked": true,
            "defaultValue": "value::all",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          },
          {
            "id": "8ba132ac-8838-476c-8eb2-ed42aa2aa983",
            "version": "KqlParameterItem/1.0",
            "name": "isVNetTopologySchemaPresent",
            "type": 1,
            "description": "Schema Check",
            "isRequired": true,
            "query": "let SchemaTable = view () { print isPresent = 'false' };\r\nunion isfuzzy = true SchemaTable, (NTATopologyDetails | take 1 | project isPresent = iff(iscolumnexists('DiscoveryRegion'), 'true', 'false')) \r\n| top 1 by isPresent",
            "crossComponentResources": [
              "{workspace}"
            ],
            "isHiddenWhenLocked": true,
            "defaultValue": "value::all",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          },
          {
            "id": "397f54e8-ba8e-4388-a81b-9ad843e6e917",
            "version": "KqlParameterItem/1.0",
            "name": "isVNetFlowSchemaPresent",
            "type": 1,
            "description": "Schema Check",
            "isRequired": true,
            "query": "let SchemaTable = view () { print isPresent = 'false' };\r\nunion isfuzzy = true SchemaTable, (NTANetAnalytics | getschema | summarize c=count() | project isPresent = iff(c > 0, 'true', 'false')) \r\n| top 1 by isPresent",
            "crossComponentResources": [
              "{workspace}"
            ],
            "isHiddenWhenLocked": true,
            "defaultValue": "value::all",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          },
          {
            "id": "ef9c7fec-3283-4cdd-8db2-166e0a461559",
            "version": "KqlParameterItem/1.0",
            "name": "portRangeCheckLine",
            "type": 1,
            "description": "Port range filter",
            "isRequired": true,
            "isHiddenWhenLocked": true,
            "criteriaData": [
              {
                "criteriaContext": {
                  "leftOperand": "portRange",
                  "operator": "is Empty",
                  "rightValType": "param",
                  "resultValType": "static",
                  "resultVal": "//skip"
                }
              },
              {
                "criteriaContext": {
                  "leftOperand": "portRange",
                  "operator": "==",
                  "rightValType": "static",
                  "rightVal": "*",
                  "resultValType": "static",
                  "resultVal": "//skip"
                }
              },
              {
                "criteriaContext": {
                  "operator": "Default",
                  "resultValType": "static",
                  "resultVal": "| extend portRangeList = split(\"{portRange}\", ',') | mv-expand portRangeList to typeof(string) | extend portRangeBegin = toint(split(portRangeList, '-')[0]), portRangeEnd = toint(split(portRangeList, '-')[1]) | where portRangeBegin <= portToCheck and portToCheck <= portRangeEnd"
                }
              }
            ]
          },
          {
            "id": "fd9e1ff9-a35c-4a95-845d-d8c6ed101a73",
            "version": "KqlParameterItem/1.0",
            "name": "binningTime",
            "type": 2,
            "isRequired": true,
            "query": "datatable (id:int) [1]\r\n| project value = strcat(max_of({timeInterval:seconds}/3000, 1), 'm'), label = strcat(max_of({timeInterval:seconds}/3000, 1), 'm'), selected = 1",
            "crossComponentResources": [
              "{workspace}"
            ],
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 1800000
            },
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "parameters - 2"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "3a316914-57a8-40de-b308-1d5abc01ec76",
                  "version": "KqlParameterItem/1.0",
                  "name": "QueryType",
                  "type": 1,
                  "isHiddenWhenLocked": true,
                  "criteriaData": [
                    {
                      "criteriaContext": {
                        "leftOperand": "FlowType",
                        "operator": "==",
                        "rightValType": "static",
                        "rightVal": "NSG",
                        "resultValType": "static",
                        "resultVal": "{isNSGTopologySchemaPresent},NSG"
                      }
                    },
                    {
                      "criteriaContext": {
                        "leftOperand": "FlowType",
                        "operator": "==",
                        "rightValType": "static",
                        "rightVal": "VNet",
                        "resultValType": "static",
                        "resultVal": "{isVNetTopologySchemaPresent},VNet"
                      }
                    },
                    {
                      "criteriaContext": {
                        "operator": "Default",
                        "resultValType": "static",
                        "resultVal": "{isNSGTopologySchemaPresent},NSG,{isVNetTopologySchemaPresent},VNet"
                      }
                    }
                  ],
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "b1715201-f711-4a92-bf97-4720b2e295c7",
                  "version": "KqlParameterItem/1.0",
                  "name": "SubscriptionQueryToRun",
                  "type": 1,
                  "isHiddenWhenLocked": true,
                  "criteriaData": [
                    {
                      "criteriaContext": {
                        "leftOperand": "QueryType",
                        "operator": "==",
                        "rightValType": "static",
                        "rightVal": "true,NSG",
                        "resultValType": "static",
                        "resultVal": "AzureNetworkAnalytics_CL | extend timecheck = iff({timeInterval:seconds} < 86400, TimeGenerated between (datetime_add('day', -1, todatetime('{timeInterval:endISO}')) .. todatetime('{timeInterval:endISO}')), TimeGenerated between (todatetime('{timeInterval:startISO}') .. todatetime('{timeInterval:endISO}'))) | where SubType_s == 'StatusMessage' and ComponentType_s == 'Topology' | distinct Subscription_g, SubscriptionName_s | project Subscription = Subscription_g, SubscriptionName = SubscriptionName_s, selected = 1"
                      }
                    },
                    {
                      "criteriaContext": {
                        "leftOperand": "QueryType",
                        "operator": "==",
                        "rightValType": "static",
                        "rightVal": "true,VNet",
                        "resultValType": "static",
                        "resultVal": "NTATopologyDetails | extend timecheck = iff({timeInterval:seconds} < 86400, TimeGenerated between (datetime_add('day', -1, todatetime('{timeInterval:endISO}')) .. todatetime('{timeInterval:endISO}')), TimeGenerated between (todatetime('{timeInterval:startISO}') .. todatetime('{timeInterval:endISO}'))) | where timecheck | where SubType == 'StatusMessage' and ComponentType == 'Topology' | distinct Subscription, SubscriptionName | project Subscription, SubscriptionName, selected = 1"
                      }
                    },
                    {
                      "criteriaContext": {
                        "leftOperand": "QueryType",
                        "operator": "==",
                        "rightValType": "static",
                        "rightVal": "false,NSG,true,VNet",
                        "resultValType": "static",
                        "resultVal": "NTATopologyDetails | extend timecheck = iff({timeInterval:seconds} < 86400, TimeGenerated between (datetime_add('day', -1, todatetime('{timeInterval:endISO}')) .. todatetime('{timeInterval:endISO}')), TimeGenerated between (todatetime('{timeInterval:startISO}') .. todatetime('{timeInterval:endISO}'))) | where timecheck | where SubType == 'StatusMessage' and ComponentType == 'Topology' | distinct Subscription, SubscriptionName | project Subscription, SubscriptionName, selected = 1"
                      }
                    },
                    {
                      "criteriaContext": {
                        "leftOperand": "QueryType",
                        "operator": "==",
                        "rightValType": "static",
                        "rightVal": "true,NSG,false,VNet",
                        "resultValType": "static",
                        "resultVal": "AzureNetworkAnalytics_CL | extend timecheck = iff({timeInterval:seconds} < 86400, TimeGenerated between (datetime_add('day', -1, todatetime('{timeInterval:endISO}')) .. todatetime('{timeInterval:endISO}')), TimeGenerated between (todatetime('{timeInterval:startISO}') .. todatetime('{timeInterval:endISO}'))) | where SubType_s == 'StatusMessage' and ComponentType_s == 'Topology' | distinct Subscription_g, SubscriptionName_s | project Subscription = Subscription_g, SubscriptionName = SubscriptionName_s, selected = 1"
                      }
                    },
                    {
                      "criteriaContext": {
                        "leftOperand": "QueryType",
                        "operator": "==",
                        "rightValType": "static",
                        "rightVal": "true,NSG,true,VNet",
                        "resultValType": "static",
                        "resultVal": "let nsg = AzureNetworkAnalytics_CL  | extend timecheck = iff({timeInterval:seconds} < 86400, TimeGenerated between (datetime_add('day', -1, todatetime('{timeInterval:endISO}')) .. todatetime('{timeInterval:endISO}')), TimeGenerated between (todatetime('{timeInterval:startISO}') .. todatetime('{timeInterval:endISO}'))) | where SubType_s == 'StatusMessage' and ComponentType_s == 'Topology'      | distinct Subscription_g, SubscriptionName_s      | project Subscription = Subscription_g, SubscriptionName = SubscriptionName_s;   let vnet = NTATopologyDetails | extend timecheck = iff({timeInterval:seconds} < 86400, TimeGenerated between (datetime_add('day', -1, todatetime('{timeInterval:endISO}')) .. todatetime('{timeInterval:endISO}')), TimeGenerated between (todatetime('{timeInterval:startISO}') .. todatetime('{timeInterval:endISO}'))) | where timecheck | where SubType == 'StatusMessage' and ComponentType == 'Topology'    | distinct Subscription, SubscriptionName    | project Subscription, SubscriptionName;   nsg | union vnet | distinct Subscription, SubscriptionName, selected =1;"
                      }
                    },
                    {
                      "criteriaContext": {
                        "operator": "Default",
                        "resultValType": "static",
                        "resultVal": "false"
                      }
                    }
                  ],
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "2868d085-4cca-4e79-93a2-d27006b832c6",
                  "version": "KqlParameterItem/1.0",
                  "name": "TopologyConditionVNet",
                  "type": 1,
                  "description": "VNets in these subscriptions are configured to send their flow logs to the selected Log Analytics workspace. Select subscriptions, to analyze traffic from those subscriptions.",
                  "isRequired": true,
                  "query": "NTATopologyDetails \r\n| extend timecheck = iff({timeInterval:seconds} < 86400, TimeGenerated between (datetime_add('day', -1, todatetime('{timeInterval:endISO}')) .. todatetime('{timeInterval:endISO}')), TimeGenerated between (todatetime('{timeInterval:startISO}') .. todatetime('{timeInterval:endISO}')))\r\n| where timecheck\r\n| where SubType == 'StatusMessage' and ComponentType =='Topology' and Status =='Completed' \r\n| project Subscription, DiscoveryRegion, TimeProcessed \r\n| where isnotempty(Subscription) and isnotempty(DiscoveryRegion) and isnotempty(TimeProcessed)\r\n| summarize arg_max(TimeProcessed, *) by Subscription \r\n| project value = strcat(Subscription, ',', DiscoveryRegion, ',', TimeProcessed), selected = 1;",
                  "crossComponentResources": [
                    "{workspace}"
                  ],
                  "isHiddenWhenLocked": true,
                  "defaultValue": "value::all",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                },
                {
                  "version": "KqlParameterItem/1.0",
                  "name": "TopologyConditionNSG",
                  "type": 1,
                  "description": "VNets in these subscriptions are configured to send their flow logs to the selected Log Analytics workspace. Select subscriptions, to analyze traffic from those subscriptions.",
                  "query": "AzureNetworkAnalytics_CL \r\n| where SubType_s == 'StatusMessage' and ComponentType_s =='Topology' and Status_s =='Completed' \r\n| project Subscription_g, DiscoveryRegion_s, TimeProcessed_t\r\n| where isnotempty(Subscription_g) and isnotempty(DiscoveryRegion_s) and isnotempty(TimeProcessed_t)\r\n| summarize arg_max(TimeProcessed_t, *) by Subscription_g \r\n| project value = strcat(Subscription_g, ',', DiscoveryRegion_s, ',', TimeProcessed_t), selected = 1;",
                  "crossComponentResources": [
                    "{workspace}"
                  ],
                  "isHiddenWhenLocked": true,
                  "defaultValue": "value::all",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "id": "1e310513-a332-4175-85a8-844c28aa5f2a"
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "conditionalVisibility": {
              "parameterName": "timeInterval",
              "comparison": "isEqualTo",
              "value": "set"
            },
            "name": "parameters - 9"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "crossComponentResources": [
                "{workspace}"
              ],
              "parameters": [
                {
                  "id": "a24b1d2a-f7b6-439d-8e05-945ca7444e43",
                  "version": "KqlParameterItem/1.0",
                  "name": "subscriptions",
                  "label": "Discovered Subscriptions",
                  "type": 2,
                  "description": "VNets in these subscriptions are configured to send their flow logs to the selected Log Analytics workspace. Select subscriptions, to analyze traffic from those subscriptions.",
                  "isRequired": true,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "query": "{SubscriptionQueryToRun}",
                  "crossComponentResources": [
                    "{workspace}"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "selectAllValue": "*",
                    "showDefault": false
                  },
                  "defaultValue": "value::all",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                },
                {
                  "id": "20fbdbdd-cd15-43a4-9c33-e7bfc3f86811",
                  "version": "KqlParameterItem/1.0",
                  "name": "RGQueryToRun",
                  "type": 1,
                  "isHiddenWhenLocked": true,
                  "criteriaData": [
                    {
                      "criteriaContext": {
                        "leftOperand": "QueryType",
                        "operator": "==",
                        "rightValType": "static",
                        "rightVal": "true,NSG",
                        "resultValType": "static",
                        "resultVal": "AzureNetworkAnalytics_CL | where iff({timeInterval:seconds} < 86400, TimeGenerated between (datetime_add('day', -1, todatetime('{timeInterval:endISO}')) .. todatetime('{timeInterval:endISO}')), TimeGenerated between (todatetime('{timeInterval:startISO}') .. todatetime('{timeInterval:endISO}'))) | where SubType_s  =='Topology' and ResourceType !in ('VirtualSubnetwork','VirtualNetworkGatewayConnection','RemoteGatewayConnection', 'Route','NetworkAnalytics','VirtualNetworkPeering','NetworkSecurityGroupRule','SubnetworkConnection') | where iff(\"{subscriptions}\" == \"'*'\", true, Subscription_g in~ ({subscriptions})) | project rgName = tostring(split(Name_s,'/')[0]), Subscription_g | distinct rgName, Subscription_g | project value = rgName, label = rgName, selected = 1"
                      }
                    },
                    {
                      "criteriaContext": {
                        "leftOperand": "QueryType",
                        "operator": "==",
                        "rightValType": "static",
                        "rightVal": "true,VNet",
                        "resultValType": "static",
                        "resultVal": "NTATopologyDetails | where iff({timeInterval:seconds} < 86400, TimeGenerated between (datetime_add('day', -1, todatetime('{timeInterval:endISO}')) .. todatetime('{timeInterval:endISO}')), TimeGenerated between (todatetime('{timeInterval:startISO}') .. todatetime('{timeInterval:endISO}'))) | where SubType  =='Topology' and AzureResourceType !in ('VirtualSubnetwork','VirtualNetworkGatewayConnection','RemoteGatewayConnection', 'Route','NetworkAnalytics','VirtualNetworkPeering','NetworkSecurityGroupRule','SubnetworkConnection') | where iff(\"{subscriptions}\" == \"'*'\", true, Subscription in~ ({subscriptions})) | project rgName = tostring(split(Name,'/')[0]), Subscription | distinct rgName, Subscription | project value = rgName, label = rgName, selected = 1"
                      }
                    },
                    {
                      "criteriaContext": {
                        "leftOperand": "QueryType",
                        "operator": "==",
                        "rightValType": "static",
                        "rightVal": "false,NSG,true,VNet",
                        "resultValType": "static",
                        "resultVal": "NTATopologyDetails | where iff({timeInterval:seconds} < 86400, TimeGenerated between (datetime_add('day', -1, todatetime('{timeInterval:endISO}')) .. todatetime('{timeInterval:endISO}')), TimeGenerated between (todatetime('{timeInterval:startISO}') .. todatetime('{timeInterval:endISO}'))) | where SubType  =='Topology' and AzureResourceType !in ('VirtualSubnetwork','VirtualNetworkGatewayConnection','RemoteGatewayConnection', 'Route','NetworkAnalytics','VirtualNetworkPeering','NetworkSecurityGroupRule','SubnetworkConnection') | where iff(\"{subscriptions}\" == \"'*'\", true, Subscription in~ ({subscriptions})) | project rgName = tostring(split(Name,'/')[0]), Subscription | distinct rgName, Subscription | project value = rgName, label = rgName, selected = 1"
                      }
                    },
                    {
                      "criteriaContext": {
                        "leftOperand": "QueryType",
                        "operator": "==",
                        "rightValType": "static",
                        "rightVal": "true,NSG,false,VNet",
                        "resultValType": "static",
                        "resultVal": "AzureNetworkAnalytics_CL | where iff({timeInterval:seconds} < 86400, TimeGenerated between (datetime_add('day', -1, todatetime('{timeInterval:endISO}')) .. todatetime('{timeInterval:endISO}')), TimeGenerated between (todatetime('{timeInterval:startISO}') .. todatetime('{timeInterval:endISO}'))) | where SubType_s  =='Topology' and ResourceType !in ('VirtualSubnetwork','VirtualNetworkGatewayConnection','RemoteGatewayConnection', 'Route','NetworkAnalytics','VirtualNetworkPeering','NetworkSecurityGroupRule','SubnetworkConnection') | where iff(\"{subscriptions}\" == \"'*'\", true, Subscription_g in~ ({subscriptions})) | project rgName = tostring(split(Name_s,'/')[0]), Subscription_g | distinct rgName, Subscription_g | project value = rgName, label = rgName, selected = 1"
                      }
                    },
                    {
                      "criteriaContext": {
                        "leftOperand": "QueryType",
                        "operator": "==",
                        "rightValType": "static",
                        "rightVal": "true,NSG,true,VNet",
                        "resultValType": "static",
                        "resultVal": "let nsg = AzureNetworkAnalytics_CL | where iff({timeInterval:seconds} < 86400, TimeGenerated between (datetime_add('day', -1, todatetime('{timeInterval:endISO}')) .. todatetime('{timeInterval:endISO}')), TimeGenerated between (todatetime('{timeInterval:startISO}') .. todatetime('{timeInterval:endISO}'))) | where SubType_s  =='Topology' and ResourceType !in ('VirtualSubnetwork','VirtualNetworkGatewayConnection','RemoteGatewayConnection', 'Route','NetworkAnalytics','VirtualNetworkPeering','NetworkSecurityGroupRule','SubnetworkConnection') | where iff(\"{subscriptions}\" == \"'*'\", true, Subscription_g in~ ({subscriptions})) | project rgName = tostring(split(Name_s,'/')[0]), Subscription_g | distinct rgName, Subscription_g | project value = rgName, label = rgName, selected = 1; let vnet = NTATopologyDetails | where iff({timeInterval:seconds} < 86400, TimeGenerated between (datetime_add('day', -1, todatetime('{timeInterval:endISO}')) .. todatetime('{timeInterval:endISO}')), TimeGenerated between (todatetime('{timeInterval:startISO}') .. todatetime('{timeInterval:endISO}'))) | where SubType  =='Topology' and AzureResourceType !in ('VirtualSubnetwork','VirtualNetworkGatewayConnection','RemoteGatewayConnection', 'Route','NetworkAnalytics','VirtualNetworkPeering','NetworkSecurityGroupRule','SubnetworkConnection') | where iff(\"{subscriptions}\" == \"'*'\", true, Subscription in~ ({subscriptions})) | project rgName = tostring(split(Name,'/')[0]), Subscription | distinct rgName, Subscription | project value = rgName, label = rgName, selected = 1; nsg | union vnet"
                      }
                    },
                    {
                      "criteriaContext": {
                        "operator": "Default",
                        "resultValType": "static",
                        "resultVal": "false"
                      }
                    }
                  ],
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "0ebfeaf0-fcaa-4500-8f59-1b34f60d43f8",
                  "version": "KqlParameterItem/1.0",
                  "name": "resourceGroups",
                  "type": 2,
                  "description": "VNets in these subscriptions are configured to send their flow logs to the selected Log Analytics workspace. Select subscriptions, to analyze traffic from those subscriptions.",
                  "isRequired": true,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "query": "{RGQueryToRun}",
                  "crossComponentResources": [
                    "{workspace}"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "selectAllValue": "*",
                    "showDefault": false
                  },
                  "defaultValue": "value::all",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "label": "Resource Groups"
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "conditionalVisibility": {
              "parameterName": "SubscriptionQueryToRun",
              "comparison": "isNotEqualTo",
              "value": "false"
            },
            "name": "parameters - 9 - Copy"
          },
          {
            "type": 1,
            "content": {
              "json": "We could not find any data in this workspace for selected time interval. Try after 20-30 mins.\r\n 1. Please try changing the time interval for current workspace selection.\r\n 2. Select a different workspace or try after 20-30 mins.\r\n 3. Please try changing the Flowlog Type for current workspace selection.",
              "style": "info"
            },
            "conditionalVisibility": {
              "parameterName": "SubscriptionQueryToRun",
              "comparison": "isEqualTo",
              "value": "false"
            },
            "name": "InfoBubble"
          }
        ],
        "exportParameters": true
      },
      "name": "Filters"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let ApplicationProtocols = \r\nNTANetAnalytics\r\n| where SubType == 'FlowLog'\r\n    and FaSchemaVersion == '3'\r\nand FlowStartTime between (datetime('{timeInterval:startISO}') .. datetime('{timeInterval:endISO}'))\r\n    //filters\r\n    | where iff(\"{subscriptions}\" == \"'*'\", true, (SrcSubscription in~ ({subscriptions}) or DestSubscription in~ ({subscriptions})))\r\n    | extend Subnet1Split = split(SrcSubnet, '/'), Subnet2Split = split(DestSubnet, '/')\r\n    | extend rg1ToCheck = Subnet1Split[0], rg2ToCheck = Subnet2Split[0]\r\n    | where iff(\"{resourceGroups}\" == \"'*'\", true, (rg1ToCheck in~ ({resourceGroups}) or rg2ToCheck in~ ({resourceGroups})))\r\n    //filters\r\n| extend isMaliciousFlow = (FlowType == 'MaliciousFlow')\r\n| extend CountryOrRegion = iif(FlowType == 'AzurePublic', AzureRegion, Country)\r\n| extend \r\n    AllowedInboundBytesAtSrc = iff(FlowStatus == 'Allowed' and FlowDirection == 'Outbound', tolong(BytesDestToSrc), 0), \r\n    BlockedInboundBytesAtSrc = iff(FlowStatus == 'Denied' and FlowDirection == 'Outbound', tolong(BytesDestToSrc), 0), \r\n    AllowedOutboundBytesAtSrc = iff(FlowStatus == 'Allowed' and FlowDirection == 'Outbound', tolong(BytesSrcToDest), 0), \r\n    BlockedOutboundBytesAtSrc = iff(FlowStatus == 'Denied' and FlowDirection == 'Outbound', tolong(BytesSrcToDest), 0), \r\n    AllowedInboundBytesAtDest = iff(FlowStatus == 'Allowed' and FlowDirection == 'Inbound', tolong(BytesDestToSrc), 0), \r\n    BlockedInboundBytesAtDest = iff(FlowStatus == 'Denied' and FlowDirection == 'Inbound', tolong(BytesDestToSrc), 0), \r\n    AllowedOutboundBytesAtDest = iff(FlowStatus == 'Allowed' and FlowDirection == 'Inbound', tolong(BytesSrcToDest), 0), \r\n    BlockedOutboundBytesAtDest = iff(FlowStatus == 'Denied' and FlowDirection == 'Inbound', tolong(BytesSrcToDest), 0)\r\n| extend \r\n    AllowedInboundPacketsAtSrc = iff(FlowStatus == 'Allowed' and FlowDirection == 'Outbound', tolong(PacketsDestToSrc), 0), \r\n    BlockedInboundPacketsAtSrc = iff(FlowStatus == 'Denied' and FlowDirection == 'Outbound', tolong(PacketsDestToSrc), 0), \r\n    AllowedOutboundPacketsAtSrc = iff(FlowStatus == 'Allowed' and FlowDirection == 'Outbound', tolong(PacketsSrcToDest), 0), \r\n    BlockedOutboundPacketsAtSrc = iff(FlowStatus == 'Denied' and FlowDirection == 'Outbound', tolong(PacketsSrcToDest), 0), \r\n    AllowedInboundPacketsAtDest = iff(FlowStatus == 'Allowed' and FlowDirection == 'Inbound', tolong(PacketsDestToSrc), 0), \r\n    BlockedInboundPacketsAtDest = iff(FlowStatus == 'Denied' and FlowDirection == 'Inbound', tolong(PacketsDestToSrc), 0), \r\n    AllowedOutboundPacketsAtDest = iff(FlowStatus == 'Allowed' and FlowDirection == 'Inbound', tolong(PacketsSrcToDest), 0), \r\n    BlockedOutboundPacketsAtDest = iff(FlowStatus == 'Denied' and FlowDirection == 'Inbound', tolong(PacketsSrcToDest), 0)\r\n| extend FlowDirection = iif(FlowType in ('InterVNet', 'IntraVNet'), '', FlowDirection)\r\n| summarize \r\n    AllowedInbound = sum(AllowedInFlows), \r\n    BlockedInbound = sum(DeniedInFlows), \r\n    AllowedOutbound = sum(AllowedOutFlows), \r\n    BlockedOutbound = sum(DeniedOutFlows),\r\n    AllowedInboundBytesAtSrc = sum(AllowedInboundBytesAtSrc), \r\n    BlockedInboundBytesAtSrc = sum(BlockedInboundBytesAtSrc), \r\n    AllowedOutboundBytesAtSrc = sum(AllowedOutboundBytesAtSrc), \r\n    BlockedOutboundBytesAtSrc = sum(BlockedOutboundBytesAtSrc), \r\n    AllowedInboundBytesAtDest = sum(AllowedInboundBytesAtDest), \r\n    BlockedInboundBytesAtDest = sum(BlockedInboundBytesAtDest), \r\n    AllowedOutboundBytesAtDest = sum(AllowedOutboundBytesAtDest), \r\n    BlockedOutboundBytesAtDest = sum(BlockedOutboundBytesAtDest),\r\n    AllowedInboundPacketsAtSrc = sum(AllowedInboundPacketsAtSrc), \r\n    BlockedInboundPacketsAtSrc = sum(BlockedInboundPacketsAtSrc), \r\n    AllowedOutboundPacketsAtSrc = sum(AllowedOutboundPacketsAtSrc), \r\n    BlockedOutboundPacketsAtSrc = sum(BlockedOutboundPacketsAtSrc), \r\n    AllowedInboundPacketsAtDest = sum(AllowedInboundPacketsAtDest), \r\n    BlockedInboundPacketsAtDest = sum(BlockedInboundPacketsAtDest), \r\n    AllowedOutboundPacketsAtDest = sum(AllowedOutboundPacketsAtDest), \r\n    BlockedOutboundPacketsAtDest = sum(BlockedOutboundPacketsAtDest)\r\n    by\r\n    SrcIp,\r\n    SrcSubscription,\r\n    SrcNic,\r\n    DestIp,\r\n    DestSubscription,\r\n    DestNic,\r\n    FlowDirection,\r\n    L4Protocol,\r\n    DestPort,\r\n    CountryOrRegion,\r\n    isMaliciousFlow,\r\n    L7Protocol\r\n    | extend AllowedOutbound_inferred = max_of(AllowedOutbound, AllowedInbound + BlockedInbound)\r\n    | extend Outbound = AllowedOutbound_inferred + BlockedOutbound, Inbound = AllowedOutbound_inferred\r\n    | extend FlowCount = max_of(Inbound, Outbound)\r\n    | extend AllowedOutboundBytesAtSrc_inferred = max_of(AllowedOutboundBytesAtSrc, AllowedInboundBytesAtDest + BlockedInboundBytesAtDest)\r\n    | extend AllowedOutboundBytesAtDest_inferred = max_of(AllowedOutboundBytesAtDest, AllowedInboundBytesAtSrc + BlockedInboundBytesAtSrc)\r\n    | extend OutboundBytesAtSrc = AllowedOutboundBytesAtSrc_inferred + BlockedOutboundBytesAtSrc, InboundBytesAtSrc = AllowedOutboundBytesAtDest_inferred\r\n    | extend OutboundBytesAtDest = AllowedOutboundBytesAtDest_inferred + BlockedOutboundBytesAtDest, InboundBytesAtDest = AllowedOutboundBytesAtSrc_inferred\r\n    | extend BytesCount = max_of(OutboundBytesAtSrc, InboundBytesAtDest) + max_of(OutboundBytesAtDest, InboundBytesAtSrc)\r\n    | extend AllowedOutboundPacketsAtSrc_inferred = max_of(AllowedOutboundPacketsAtSrc, AllowedInboundPacketsAtDest + BlockedInboundPacketsAtDest)\r\n    | extend AllowedOutboundPacketsAtDest_inferred = max_of(AllowedOutboundPacketsAtDest, AllowedInboundPacketsAtSrc + BlockedInboundPacketsAtSrc)\r\n    | extend OutboundPacketsAtSrc = AllowedOutboundPacketsAtSrc_inferred + BlockedOutboundPacketsAtSrc, InboundPacketsAtSrc = AllowedOutboundPacketsAtDest_inferred\r\n    | extend OutboundPacketsAtDest = AllowedOutboundPacketsAtDest_inferred + BlockedOutboundPacketsAtDest, InboundPacketsAtDest = AllowedOutboundPacketsAtSrc_inferred\r\n    | extend PacketsCount = max_of(OutboundPacketsAtSrc, InboundPacketsAtDest) + max_of(OutboundPacketsAtDest, InboundPacketsAtSrc)\r\n    | extend \r\n    AllowedTraffic = tolong(AllowedInbound) + tolong(AllowedOutbound),\r\n    BlockedTraffic = tolong(BlockedInbound) + tolong(BlockedOutbound)\r\n    // fork part 2 Bytes:\r\n    | extend \r\n    AllowedTrafficBytes = tolong(AllowedInboundBytesAtDest) + tolong(AllowedInboundBytesAtSrc) + tolong(AllowedOutboundBytesAtSrc) + tolong(AllowedOutboundBytesAtDest),\r\n    BlockedTrafficBytes = tolong(BlockedInboundBytesAtDest) + tolong(BlockedInboundBytesAtSrc) + tolong(BlockedOutboundBytesAtSrc) + tolong(BlockedOutboundBytesAtDest) \r\n    // fork part 3 Packets:\r\n    | extend \r\n    AllowedTrafficPackets = tolong(AllowedInboundPacketsAtDest) + tolong(AllowedInboundPacketsAtSrc) + tolong(AllowedOutboundPacketsAtSrc) + tolong(AllowedOutboundPacketsAtDest),\r\n    BlockedTrafficPackets = tolong(BlockedInboundPacketsAtDest) + tolong(BlockedInboundPacketsAtSrc) + tolong(BlockedOutboundPacketsAtSrc) + tolong(BlockedOutboundPacketsAtDest)\r\n    | summarize \r\n    // summarize for flows\r\n    AllowedTraffic = sum(AllowedTraffic), \r\n    BlockedTraffic = sum(BlockedTraffic),\r\n    MaliciousFlow = sum(iff(isMaliciousFlow, AllowedTraffic + BlockedTraffic, 0)),\r\n    TotalFlow = sum(FlowCount),\r\n    // summarize for bytes\r\n    AllowedBytes = sum(AllowedTrafficBytes), \r\n    BlockedBytes = sum(BlockedTrafficBytes),\r\n    MaliciousBytes = sum(iff(isMaliciousFlow, AllowedTrafficBytes + BlockedTrafficBytes, 0)),\r\n    TotalBytes = sum(BytesCount),\r\n    // summarize for packets\r\n    AllowedPackets = sum(AllowedTrafficPackets),\r\n    BlockedPackets = sum(BlockedTrafficPackets),\r\n    MaliciousPackets = sum(iff(isMaliciousFlow, AllowedTrafficPackets + BlockedTrafficPackets, 0)),\r\n    TotalPackets = sum(PacketsCount) \r\n    by L7Protocol, DestPort\r\n| summarize totalTraffic = iff('{Units:value}' =~ 'bytes', sum(TotalBytes), iff('{Units:value}' =~ 'packets', sum(TotalPackets), sum(TotalFlow))),\r\nallowedTraffic = iff('{Units:value}' =~ 'bytes', sum(AllowedBytes), iff('{Units:value}' =~ 'packets', sum(AllowedPackets), sum(AllowedTraffic))),\r\nmaliciousTraffic = iff('{Units:value}' =~ 'bytes', sum(MaliciousBytes), iff('{Units:value}' =~ 'packets', sum(MaliciousPackets), sum(MaliciousFlow))),\r\nblockedTraffic = iff('{Units:value}' =~ 'bytes', sum(BlockedBytes), iff('{Units:value}' =~ 'packets', sum(BlockedPackets), sum(BlockedTraffic)));\r\n union (\r\n        ApplicationProtocols\r\n        | project ColumnName = 'TotalTraffic', Value = totalTraffic\r\n    ),\r\n    (\r\n        ApplicationProtocols\r\n        | project ColumnName = 'AllowedTraffic', Value = allowedTraffic\r\n    ),\r\n    (\r\n        ApplicationProtocols\r\n        | project ColumnName = 'Malicious Traffic', Value = maliciousTraffic\r\n    ),\r\n    (\r\n        ApplicationProtocols\r\n        | project ColumnName = 'Blocked Traffic', Value = blockedTraffic\r\n    )",
                    "size": 3,
                    "noDataMessage": "The Application Insights resource you selected has no data.",
                    "timeContextFromParameter": "timeInterval",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{workspace}"
                    ],
                    "visualization": "tiles",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "ColumnName",
                        "formatter": 1,
                        "tooltipFormat": {
                          "tooltip": "Total Traffic of all IPs"
                        }
                      },
                      "subtitleContent": {
                        "columnMatch": "Value",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "auto"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal"
                          }
                        }
                      },
                      "rightContent": {
                        "columnMatch": "totalTraffic",
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal"
                          }
                        }
                      },
                      "secondaryContent": {
                        "columnMatch": "Column2",
                        "formatter": 1
                      },
                      "showBorder": false,
                      "sortCriteriaField": "ColumnName",
                      "sortOrderField": 2,
                      "size": "auto"
                    }
                  },
                  "conditionalVisibility": {
                    "parameterName": "FlowType",
                    "comparison": "isEqualTo",
                    "value": "vnet"
                  },
                  "name": "ApplicationProtocolsVNet"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let ApplicationProtocols = \r\nAzureNetworkAnalytics_CL\r\n| where SubType_s == 'FlowLog'\r\n    and (FASchemaVersion_s == '1' or FASchemaVersion_s == '2')\r\nand FlowStartTime_t between (datetime('{timeInterval:startISO}') .. datetime('{timeInterval:endISO}'))\r\n    //filters\r\n    | where iff(\"{subscriptions}\" == \"'*'\", true, (Subscription1_g in~ ({subscriptions}) or Subscription2_g in~ ({subscriptions})))\r\n    | extend Subnet1Split = split(Subnet1_s, '/'), Subnet2Split = split(Subnet2_s, '/')\r\n    | extend rg1ToCheck = Subnet1Split[0], rg2ToCheck = Subnet2Split[0]\r\n    | where iff(\"{resourceGroups}\" == \"'*'\", true, (rg1ToCheck in~ ({resourceGroups}) or rg2ToCheck in~ ({resourceGroups})))\r\n    //filters\r\n| extend isMaliciousFlow = (FlowType_s == 'MaliciousFlow')\r\n| extend CountryOrRegion = iif(FlowType_s == 'AzurePublic', AzureRegion_s, Country_s)\r\n| extend \r\n    AllowedInboundBytesAtSrc = iff(FlowStatus_s == 'Allowed' and FlowDirection_s == 'Outbound', tolong(InboundBytes_d), 0), \r\n    BlockedInboundBytesAtSrc = iff(FlowStatus_s == 'Denied' and FlowDirection_s == 'Outbound', tolong(InboundBytes_d), 0), \r\n    AllowedOutboundBytesAtSrc = iff(FlowStatus_s == 'Allowed' and FlowDirection_s == 'Outbound', tolong(OutboundBytes_d), 0), \r\n    BlockedOutboundBytesAtSrc = iff(FlowStatus_s == 'Denied' and FlowDirection_s == 'Outbound', tolong(OutboundBytes_d), 0), \r\n    AllowedInboundBytesAtDest = iff(FlowStatus_s == 'Allowed' and FlowDirection_s == 'Inbound', tolong(InboundBytes_d), 0), \r\n    BlockedInboundBytesAtDest = iff(FlowStatus_s == 'Denied' and FlowDirection_s == 'Inbound', tolong(InboundBytes_d), 0), \r\n    AllowedOutboundBytesAtDest = iff(FlowStatus_s == 'Allowed' and FlowDirection_s == 'Inbound', tolong(OutboundBytes_d), 0), \r\n    BlockedOutboundBytesAtDest = iff(FlowStatus_s == 'Denied' and FlowDirection_s == 'Inbound', tolong(OutboundBytes_d), 0)\r\n| extend \r\n    AllowedInboundPacketsAtSrc = iff(FlowStatus_s == 'Allowed' and FlowDirection_s == 'Outbound', tolong(InboundPackets_d), 0), \r\n    BlockedInboundPacketsAtSrc = iff(FlowStatus_s == 'Denied' and FlowDirection_s == 'Outbound', tolong(InboundPackets_d), 0), \r\n    AllowedOutboundPacketsAtSrc = iff(FlowStatus_s == 'Allowed' and FlowDirection_s == 'Outbound', tolong(OutboundPackets_d), 0), \r\n    BlockedOutboundPacketsAtSrc = iff(FlowStatus_s == 'Denied' and FlowDirection_s == 'Outbound', tolong(OutboundPackets_d), 0), \r\n    AllowedInboundPacketsAtDest = iff(FlowStatus_s == 'Allowed' and FlowDirection_s == 'Inbound', tolong(InboundPackets_d), 0), \r\n    BlockedInboundPacketsAtDest = iff(FlowStatus_s == 'Denied' and FlowDirection_s == 'Inbound', tolong(InboundPackets_d), 0), \r\n    AllowedOutboundPacketsAtDest = iff(FlowStatus_s == 'Allowed' and FlowDirection_s == 'Inbound', tolong(OutboundPackets_d), 0), \r\n    BlockedOutboundPacketsAtDest = iff(FlowStatus_s == 'Denied' and FlowDirection_s == 'Inbound', tolong(OutboundPackets_d), 0)\r\n| extend FlowDirection_s = iif(FlowType_s in ('InterVNet', 'IntraVNet'), '', FlowDirection_s)\r\n| summarize \r\n    AllowedInbound = sum(AllowedInFlows_d), \r\n    BlockedInbound = sum(DeniedInFlows_d), \r\n    AllowedOutbound = sum(AllowedOutFlows_d), \r\n    BlockedOutbound = sum(DeniedOutFlows_d),\r\n    AllowedInboundBytesAtSrc = sum(AllowedInboundBytesAtSrc), \r\n    BlockedInboundBytesAtSrc = sum(BlockedInboundBytesAtSrc), \r\n    AllowedOutboundBytesAtSrc = sum(AllowedOutboundBytesAtSrc), \r\n    BlockedOutboundBytesAtSrc = sum(BlockedOutboundBytesAtSrc), \r\n    AllowedInboundBytesAtDest = sum(AllowedInboundBytesAtDest), \r\n    BlockedInboundBytesAtDest = sum(BlockedInboundBytesAtDest), \r\n    AllowedOutboundBytesAtDest = sum(AllowedOutboundBytesAtDest), \r\n    BlockedOutboundBytesAtDest = sum(BlockedOutboundBytesAtDest),\r\n    AllowedInboundPacketsAtSrc = sum(AllowedInboundPacketsAtSrc), \r\n    BlockedInboundPacketsAtSrc = sum(BlockedInboundPacketsAtSrc), \r\n    AllowedOutboundPacketsAtSrc = sum(AllowedOutboundPacketsAtSrc), \r\n    BlockedOutboundPacketsAtSrc = sum(BlockedOutboundPacketsAtSrc), \r\n    AllowedInboundPacketsAtDest = sum(AllowedInboundPacketsAtDest), \r\n    BlockedInboundPacketsAtDest = sum(BlockedInboundPacketsAtDest), \r\n    AllowedOutboundPacketsAtDest = sum(AllowedOutboundPacketsAtDest), \r\n    BlockedOutboundPacketsAtDest = sum(BlockedOutboundPacketsAtDest)\r\n    by\r\n    SrcIP_s,\r\n    Subscription1_g,\r\n    NIC1_s,\r\n    DestIP_s,\r\n    Subscription2_g,\r\n    NIC2_s,\r\n    FlowDirection_s,\r\n    L4Protocol_s,\r\n    DestPort_d,\r\n    CountryOrRegion,\r\n    isMaliciousFlow,\r\n    L7Protocol_s\r\n    | extend AllowedOutbound_inferred = max_of(AllowedOutbound, AllowedInbound + BlockedInbound)\r\n    | extend Outbound = AllowedOutbound_inferred + BlockedOutbound, Inbound = AllowedOutbound_inferred\r\n    | extend FlowCount = tolong(max_of(Inbound, Outbound))\r\n    | extend AllowedOutboundBytesAtSrc_inferred = max_of(AllowedOutboundBytesAtSrc, AllowedInboundBytesAtDest + BlockedInboundBytesAtDest)\r\n    | extend AllowedOutboundBytesAtDest_inferred = max_of(AllowedOutboundBytesAtDest, AllowedInboundBytesAtSrc + BlockedInboundBytesAtSrc)\r\n    | extend OutboundBytesAtSrc = AllowedOutboundBytesAtSrc_inferred + BlockedOutboundBytesAtSrc, InboundBytesAtSrc = AllowedOutboundBytesAtDest_inferred\r\n    | extend OutboundBytesAtDest = AllowedOutboundBytesAtDest_inferred + BlockedOutboundBytesAtDest, InboundBytesAtDest = AllowedOutboundBytesAtSrc_inferred\r\n    | extend BytesCount = tolong(max_of(OutboundBytesAtSrc, InboundBytesAtDest) + max_of(OutboundBytesAtDest, InboundBytesAtSrc))\r\n    | extend AllowedOutboundPacketsAtSrc_inferred = max_of(AllowedOutboundPacketsAtSrc, AllowedInboundPacketsAtDest + BlockedInboundPacketsAtDest)\r\n    | extend AllowedOutboundPacketsAtDest_inferred = max_of(AllowedOutboundPacketsAtDest, AllowedInboundPacketsAtSrc + BlockedInboundPacketsAtSrc)\r\n    | extend OutboundPacketsAtSrc = AllowedOutboundPacketsAtSrc_inferred + BlockedOutboundPacketsAtSrc, InboundPacketsAtSrc = AllowedOutboundPacketsAtDest_inferred\r\n    | extend OutboundPacketsAtDest = AllowedOutboundPacketsAtDest_inferred + BlockedOutboundPacketsAtDest, InboundPacketsAtDest = AllowedOutboundPacketsAtSrc_inferred\r\n    | extend PacketsCount = tolong(max_of(OutboundPacketsAtSrc, InboundPacketsAtDest) + max_of(OutboundPacketsAtDest, InboundPacketsAtSrc))\r\n    | extend \r\n    AllowedTraffic = tolong(AllowedInbound) + tolong(AllowedOutbound),\r\n    BlockedTraffic = tolong(BlockedInbound) + tolong(BlockedOutbound)\r\n    // fork part 2 Bytes:\r\n    | extend \r\n    AllowedTrafficBytes = tolong(AllowedInboundBytesAtDest) + tolong(AllowedInboundBytesAtSrc) + tolong(AllowedOutboundBytesAtSrc) + tolong(AllowedOutboundBytesAtDest),\r\n    BlockedTrafficBytes = tolong(BlockedInboundBytesAtDest) + tolong(BlockedInboundBytesAtSrc) + tolong(BlockedOutboundBytesAtSrc) + tolong(BlockedOutboundBytesAtDest) \r\n    // fork part 3 Packets:\r\n    | extend \r\n    AllowedTrafficPackets = tolong(AllowedInboundPacketsAtDest) + tolong(AllowedInboundPacketsAtSrc) + tolong(AllowedOutboundPacketsAtSrc) + tolong(AllowedOutboundPacketsAtDest),\r\n    BlockedTrafficPackets = tolong(BlockedInboundPacketsAtDest) + tolong(BlockedInboundPacketsAtSrc) + tolong(BlockedOutboundPacketsAtSrc) + tolong(BlockedOutboundPacketsAtDest)\r\n    | summarize \r\n    // summarize for flows\r\n    AllowedTraffic = sum(AllowedTraffic), \r\n    BlockedTraffic = sum(BlockedTraffic),\r\n    MaliciousFlow = sum(iff(isMaliciousFlow, AllowedTraffic + BlockedTraffic, 0)),\r\n    TotalFlow = sum(FlowCount),\r\n    // summarize for bytes\r\n    AllowedBytes = sum(AllowedTrafficBytes), \r\n    BlockedBytes = sum(BlockedTrafficBytes),\r\n    MaliciousBytes = sum(iff(isMaliciousFlow, AllowedTrafficBytes + BlockedTrafficBytes, 0)),\r\n    TotalBytes = sum(BytesCount),\r\n    // summarize for packets\r\n    AllowedPackets = sum(AllowedTrafficPackets),\r\n    BlockedPackets = sum(BlockedTrafficPackets),\r\n    MaliciousPackets = sum(iff(isMaliciousFlow, AllowedTrafficPackets + BlockedTrafficPackets, 0)),\r\n    TotalPackets = sum(PacketsCount)\r\n    by L7Protocol_s, DestPort_d\r\n    | summarize totalTraffic = iff('{Units:value}' =~ 'bytes', sum(TotalBytes), iff('{Units:value}' =~ 'packets', sum(TotalPackets), sum(TotalFlow))),\r\nallowedTraffic = iff('{Units:value}' =~ 'bytes', sum(AllowedBytes), iff('{Units:value}' =~ 'packets', sum(AllowedPackets), sum(AllowedTraffic))),\r\nmaliciousTraffic = iff('{Units:value}' =~ 'bytes', sum(MaliciousBytes), iff('{Units:value}' =~ 'packets', sum(MaliciousPackets), sum(MaliciousFlow))),\r\nblockedTraffic = iff('{Units:value}' =~ 'bytes', sum(BlockedBytes), iff('{Units:value}' =~ 'packets', sum(BlockedPackets), sum(BlockedTraffic)));\r\n union (\r\n        ApplicationProtocols\r\n        | project ColumnName = 'TotalTraffic', Value = totalTraffic\r\n    ),\r\n    (\r\n        ApplicationProtocols\r\n        | project ColumnName = 'AllowedTraffic', Value = allowedTraffic\r\n    ),\r\n    (\r\n        ApplicationProtocols\r\n        | project ColumnName = 'Malicious Traffic', Value = maliciousTraffic\r\n    ),\r\n    (\r\n        ApplicationProtocols\r\n        | project ColumnName = 'Blocked Traffic', Value = blockedTraffic\r\n    )",
                    "size": 3,
                    "noDataMessage": "The Application Insights resource you selected has no data.",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{workspace}"
                    ],
                    "visualization": "tiles",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "ColumnName",
                        "formatter": 1,
                        "tooltipFormat": {
                          "tooltip": "Total Traffic of all IPs"
                        }
                      },
                      "subtitleContent": {
                        "columnMatch": "Value",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "auto"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal"
                          }
                        }
                      },
                      "secondaryContent": {
                        "columnMatch": "Column2",
                        "formatter": 1
                      },
                      "showBorder": false,
                      "sortCriteriaField": "ColumnName",
                      "sortOrderField": 2,
                      "size": "auto"
                    }
                  },
                  "conditionalVisibility": {
                    "parameterName": "FlowType",
                    "comparison": "isEqualTo",
                    "value": "nsg"
                  },
                  "name": "ApplicationProtocolsNSG"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let ApplicationProtocolsNSG = \r\nAzureNetworkAnalytics_CL\r\n| where SubType_s == 'FlowLog'\r\n    and (FASchemaVersion_s == '1' or FASchemaVersion_s == '2')\r\nand FlowStartTime_t between (datetime('{timeInterval:startISO}') .. datetime('{timeInterval:endISO}'))\r\n    //filters\r\n    | where iff(\"{subscriptions}\" == \"'*'\", true, (Subscription1_g in~ ({subscriptions}) or Subscription2_g in~ ({subscriptions})))\r\n    | extend Subnet1Split = split(Subnet1_s, '/'), Subnet2Split = split(Subnet2_s, '/')\r\n    | extend rg1ToCheck = Subnet1Split[0], rg2ToCheck = Subnet2Split[0]\r\n    | where iff(\"{resourceGroups}\" == \"'*'\", true, (rg1ToCheck in~ ({resourceGroups}) or rg2ToCheck in~ ({resourceGroups})))\r\n    //filters\r\n| extend isMaliciousFlow = (FlowType_s == 'MaliciousFlow')\r\n| extend CountryOrRegion = iif(FlowType_s == 'AzurePublic', AzureRegion_s, Country_s)\r\n| extend \r\n    AllowedInboundBytesAtSrc = iff(FlowStatus_s == 'Allowed' and FlowDirection_s == 'Outbound', tolong(InboundBytes_d), 0), \r\n    BlockedInboundBytesAtSrc = iff(FlowStatus_s == 'Denied' and FlowDirection_s == 'Outbound', tolong(InboundBytes_d), 0), \r\n    AllowedOutboundBytesAtSrc = iff(FlowStatus_s == 'Allowed' and FlowDirection_s == 'Outbound', tolong(OutboundBytes_d), 0), \r\n    BlockedOutboundBytesAtSrc = iff(FlowStatus_s == 'Denied' and FlowDirection_s == 'Outbound', tolong(OutboundBytes_d), 0), \r\n    AllowedInboundBytesAtDest = iff(FlowStatus_s == 'Allowed' and FlowDirection_s == 'Inbound', tolong(InboundBytes_d), 0), \r\n    BlockedInboundBytesAtDest = iff(FlowStatus_s == 'Denied' and FlowDirection_s == 'Inbound', tolong(InboundBytes_d), 0), \r\n    AllowedOutboundBytesAtDest = iff(FlowStatus_s == 'Allowed' and FlowDirection_s == 'Inbound', tolong(OutboundBytes_d), 0), \r\n    BlockedOutboundBytesAtDest = iff(FlowStatus_s == 'Denied' and FlowDirection_s == 'Inbound', tolong(OutboundBytes_d), 0)\r\n| extend \r\n    AllowedInboundPacketsAtSrc = iff(FlowStatus_s == 'Allowed' and FlowDirection_s == 'Outbound', tolong(InboundPackets_d), 0), \r\n    BlockedInboundPacketsAtSrc = iff(FlowStatus_s == 'Denied' and FlowDirection_s == 'Outbound', tolong(InboundPackets_d), 0), \r\n    AllowedOutboundPacketsAtSrc = iff(FlowStatus_s == 'Allowed' and FlowDirection_s == 'Outbound', tolong(OutboundPackets_d), 0), \r\n    BlockedOutboundPacketsAtSrc = iff(FlowStatus_s == 'Denied' and FlowDirection_s == 'Outbound', tolong(OutboundPackets_d), 0), \r\n    AllowedInboundPacketsAtDest = iff(FlowStatus_s == 'Allowed' and FlowDirection_s == 'Inbound', tolong(InboundPackets_d), 0), \r\n    BlockedInboundPacketsAtDest = iff(FlowStatus_s == 'Denied' and FlowDirection_s == 'Inbound', tolong(InboundPackets_d), 0), \r\n    AllowedOutboundPacketsAtDest = iff(FlowStatus_s == 'Allowed' and FlowDirection_s == 'Inbound', tolong(OutboundPackets_d), 0), \r\n    BlockedOutboundPacketsAtDest = iff(FlowStatus_s == 'Denied' and FlowDirection_s == 'Inbound', tolong(OutboundPackets_d), 0)\r\n| extend FlowDirection_s = iif(FlowType_s in ('InterVNet', 'IntraVNet'), '', FlowDirection_s)\r\n| summarize \r\n    AllowedInbound = sum(AllowedInFlows_d), \r\n    BlockedInbound = sum(DeniedInFlows_d), \r\n    AllowedOutbound = sum(AllowedOutFlows_d), \r\n    BlockedOutbound = sum(DeniedOutFlows_d),\r\n    AllowedInboundBytesAtSrc = sum(AllowedInboundBytesAtSrc), \r\n    BlockedInboundBytesAtSrc = sum(BlockedInboundBytesAtSrc), \r\n    AllowedOutboundBytesAtSrc = sum(AllowedOutboundBytesAtSrc), \r\n    BlockedOutboundBytesAtSrc = sum(BlockedOutboundBytesAtSrc), \r\n    AllowedInboundBytesAtDest = sum(AllowedInboundBytesAtDest), \r\n    BlockedInboundBytesAtDest = sum(BlockedInboundBytesAtDest), \r\n    AllowedOutboundBytesAtDest = sum(AllowedOutboundBytesAtDest), \r\n    BlockedOutboundBytesAtDest = sum(BlockedOutboundBytesAtDest),\r\n    AllowedInboundPacketsAtSrc = sum(AllowedInboundPacketsAtSrc), \r\n    BlockedInboundPacketsAtSrc = sum(BlockedInboundPacketsAtSrc), \r\n    AllowedOutboundPacketsAtSrc = sum(AllowedOutboundPacketsAtSrc), \r\n    BlockedOutboundPacketsAtSrc = sum(BlockedOutboundPacketsAtSrc), \r\n    AllowedInboundPacketsAtDest = sum(AllowedInboundPacketsAtDest), \r\n    BlockedInboundPacketsAtDest = sum(BlockedInboundPacketsAtDest), \r\n    AllowedOutboundPacketsAtDest = sum(AllowedOutboundPacketsAtDest), \r\n    BlockedOutboundPacketsAtDest = sum(BlockedOutboundPacketsAtDest)\r\n    by\r\n    SrcIP_s,\r\n    Subscription1_g,\r\n    NIC1_s,\r\n    DestIP_s,\r\n    Subscription2_g,\r\n    NIC2_s,\r\n    FlowDirection_s,\r\n    L4Protocol_s,\r\n    DestPort_d,\r\n    CountryOrRegion,\r\n    isMaliciousFlow,\r\n    L7Protocol_s\r\n    | extend AllowedOutbound_inferred = max_of(AllowedOutbound, AllowedInbound + BlockedInbound)\r\n    | extend Outbound = AllowedOutbound_inferred + BlockedOutbound, Inbound = AllowedOutbound_inferred\r\n    | extend FlowCount = tolong(max_of(Inbound, Outbound))\r\n    | extend AllowedOutboundBytesAtSrc_inferred = max_of(AllowedOutboundBytesAtSrc, AllowedInboundBytesAtDest + BlockedInboundBytesAtDest)\r\n    | extend AllowedOutboundBytesAtDest_inferred = max_of(AllowedOutboundBytesAtDest, AllowedInboundBytesAtSrc + BlockedInboundBytesAtSrc)\r\n    | extend OutboundBytesAtSrc = AllowedOutboundBytesAtSrc_inferred + BlockedOutboundBytesAtSrc, InboundBytesAtSrc = AllowedOutboundBytesAtDest_inferred\r\n    | extend OutboundBytesAtDest = AllowedOutboundBytesAtDest_inferred + BlockedOutboundBytesAtDest, InboundBytesAtDest = AllowedOutboundBytesAtSrc_inferred\r\n    | extend BytesCount = tolong(max_of(OutboundBytesAtSrc, InboundBytesAtDest) + max_of(OutboundBytesAtDest, InboundBytesAtSrc))\r\n    | extend AllowedOutboundPacketsAtSrc_inferred = max_of(AllowedOutboundPacketsAtSrc, AllowedInboundPacketsAtDest + BlockedInboundPacketsAtDest)\r\n    | extend AllowedOutboundPacketsAtDest_inferred = max_of(AllowedOutboundPacketsAtDest, AllowedInboundPacketsAtSrc + BlockedInboundPacketsAtSrc)\r\n    | extend OutboundPacketsAtSrc = AllowedOutboundPacketsAtSrc_inferred + BlockedOutboundPacketsAtSrc, InboundPacketsAtSrc = AllowedOutboundPacketsAtDest_inferred\r\n    | extend OutboundPacketsAtDest = AllowedOutboundPacketsAtDest_inferred + BlockedOutboundPacketsAtDest, InboundPacketsAtDest = AllowedOutboundPacketsAtSrc_inferred\r\n    | extend PacketsCount = tolong(max_of(OutboundPacketsAtSrc, InboundPacketsAtDest) + max_of(OutboundPacketsAtDest, InboundPacketsAtSrc))\r\n    | extend \r\n    AllowedTraffic = tolong(AllowedInbound) + tolong(AllowedOutbound),\r\n    BlockedTraffic = tolong(BlockedInbound) + tolong(BlockedOutbound)\r\n    // fork part 2 Bytes:\r\n    | extend \r\n    AllowedTrafficBytes = tolong(AllowedInboundBytesAtDest) + tolong(AllowedInboundBytesAtSrc) + tolong(AllowedOutboundBytesAtSrc) + tolong(AllowedOutboundBytesAtDest),\r\n    BlockedTrafficBytes = tolong(BlockedInboundBytesAtDest) + tolong(BlockedInboundBytesAtSrc) + tolong(BlockedOutboundBytesAtSrc) + tolong(BlockedOutboundBytesAtDest) \r\n    // fork part 3 Packets:\r\n    | extend \r\n    AllowedTrafficPackets = tolong(AllowedInboundPacketsAtDest) + tolong(AllowedInboundPacketsAtSrc) + tolong(AllowedOutboundPacketsAtSrc) + tolong(AllowedOutboundPacketsAtDest),\r\n    BlockedTrafficPackets = tolong(BlockedInboundPacketsAtDest) + tolong(BlockedInboundPacketsAtSrc) + tolong(BlockedOutboundPacketsAtSrc) + tolong(BlockedOutboundPacketsAtDest)\r\n    | summarize \r\n    // summarize for flows\r\n    AllowedTraffic = sum(AllowedTraffic), \r\n    BlockedTraffic = sum(BlockedTraffic),\r\n    MaliciousFlow = sum(iff(isMaliciousFlow, AllowedTraffic + BlockedTraffic, 0)),\r\n    TotalFlow = sum(FlowCount),\r\n    // summarize for bytes\r\n    AllowedBytes = sum(AllowedTrafficBytes), \r\n    BlockedBytes = sum(BlockedTrafficBytes),\r\n    MaliciousBytes = sum(iff(isMaliciousFlow, AllowedTrafficBytes + BlockedTrafficBytes, 0)),\r\n    TotalBytes = sum(BytesCount),\r\n    // summarize for packets\r\n    AllowedPackets = sum(AllowedTrafficPackets),\r\n    BlockedPackets = sum(BlockedTrafficPackets),\r\n    MaliciousPackets = sum(iff(isMaliciousFlow, AllowedTrafficPackets + BlockedTrafficPackets, 0)),\r\n    TotalPackets = sum(PacketsCount)\r\n    by L7Protocol_s, DestPort_d\r\n    | summarize totalTraffic = iff('{Units:value}' =~ 'bytes', sum(TotalBytes), iff('{Units:value}' =~ 'packets', sum(TotalPackets), sum(TotalFlow))),\r\nallowedTraffic = iff('{Units:value}' =~ 'bytes', sum(AllowedBytes), iff('{Units:value}' =~ 'packets', sum(AllowedPackets), sum(AllowedTraffic))),\r\nmaliciousTraffic = iff('{Units:value}' =~ 'bytes', sum(MaliciousBytes), iff('{Units:value}' =~ 'packets', sum(MaliciousPackets), sum(MaliciousFlow))),\r\nblockedTraffic = iff('{Units:value}' =~ 'bytes', sum(BlockedBytes), iff('{Units:value}' =~ 'packets', sum(BlockedPackets), sum(BlockedTraffic)));\r\nlet ApplicationProtocolsVNet = \r\nNTANetAnalytics\r\n| where SubType == 'FlowLog'\r\n    and FaSchemaVersion == '3'\r\nand FlowStartTime between (datetime('{timeInterval:startISO}') .. datetime('{timeInterval:endISO}'))\r\n    //filters\r\n    | where iff(\"{subscriptions}\" == \"'*'\", true, (SrcSubscription in~ ({subscriptions}) or DestSubscription in~ ({subscriptions})))\r\n    | extend Subnet1Split = split(SrcSubnet, '/'), Subnet2Split = split(DestSubnet, '/')\r\n    | extend rg1ToCheck = Subnet1Split[0], rg2ToCheck = Subnet2Split[0]\r\n    | where iff(\"{resourceGroups}\" == \"'*'\", true, (rg1ToCheck in~ ({resourceGroups}) or rg2ToCheck in~ ({resourceGroups})))\r\n    //filters\r\n| extend isMaliciousFlow = (FlowType == 'MaliciousFlow')\r\n| extend CountryOrRegion = iif(FlowType == 'AzurePublic', AzureRegion, Country)\r\n| extend \r\n    AllowedInboundBytesAtSrc = iff(FlowStatus == 'Allowed' and FlowDirection == 'Outbound', tolong(BytesDestToSrc), 0), \r\n    BlockedInboundBytesAtSrc = iff(FlowStatus == 'Denied' and FlowDirection == 'Outbound', tolong(BytesDestToSrc), 0), \r\n    AllowedOutboundBytesAtSrc = iff(FlowStatus == 'Allowed' and FlowDirection == 'Outbound', tolong(BytesSrcToDest), 0), \r\n    BlockedOutboundBytesAtSrc = iff(FlowStatus == 'Denied' and FlowDirection == 'Outbound', tolong(BytesSrcToDest), 0), \r\n    AllowedInboundBytesAtDest = iff(FlowStatus == 'Allowed' and FlowDirection == 'Inbound', tolong(BytesDestToSrc), 0), \r\n    BlockedInboundBytesAtDest = iff(FlowStatus == 'Denied' and FlowDirection == 'Inbound', tolong(BytesDestToSrc), 0), \r\n    AllowedOutboundBytesAtDest = iff(FlowStatus == 'Allowed' and FlowDirection == 'Inbound', tolong(BytesSrcToDest), 0), \r\n    BlockedOutboundBytesAtDest = iff(FlowStatus == 'Denied' and FlowDirection == 'Inbound', tolong(BytesSrcToDest), 0)\r\n| extend \r\n    AllowedInboundPacketsAtSrc = iff(FlowStatus == 'Allowed' and FlowDirection == 'Outbound', tolong(PacketsDestToSrc), 0), \r\n    BlockedInboundPacketsAtSrc = iff(FlowStatus == 'Denied' and FlowDirection == 'Outbound', tolong(PacketsDestToSrc), 0), \r\n    AllowedOutboundPacketsAtSrc = iff(FlowStatus == 'Allowed' and FlowDirection == 'Outbound', tolong(PacketsSrcToDest), 0), \r\n    BlockedOutboundPacketsAtSrc = iff(FlowStatus == 'Denied' and FlowDirection == 'Outbound', tolong(PacketsSrcToDest), 0), \r\n    AllowedInboundPacketsAtDest = iff(FlowStatus == 'Allowed' and FlowDirection == 'Inbound', tolong(PacketsDestToSrc), 0), \r\n    BlockedInboundPacketsAtDest = iff(FlowStatus == 'Denied' and FlowDirection == 'Inbound', tolong(PacketsDestToSrc), 0), \r\n    AllowedOutboundPacketsAtDest = iff(FlowStatus == 'Allowed' and FlowDirection == 'Inbound', tolong(PacketsSrcToDest), 0), \r\n    BlockedOutboundPacketsAtDest = iff(FlowStatus == 'Denied' and FlowDirection == 'Inbound', tolong(PacketsSrcToDest), 0)\r\n| extend FlowDirection = iif(FlowType in ('InterVNet', 'IntraVNet'), '', FlowDirection)\r\n| summarize \r\n    AllowedInbound = sum(AllowedInFlows), \r\n    BlockedInbound = sum(DeniedInFlows), \r\n    AllowedOutbound = sum(AllowedOutFlows), \r\n    BlockedOutbound = sum(DeniedOutFlows),\r\n    AllowedInboundBytesAtSrc = sum(AllowedInboundBytesAtSrc), \r\n    BlockedInboundBytesAtSrc = sum(BlockedInboundBytesAtSrc), \r\n    AllowedOutboundBytesAtSrc = sum(AllowedOutboundBytesAtSrc), \r\n    BlockedOutboundBytesAtSrc = sum(BlockedOutboundBytesAtSrc), \r\n    AllowedInboundBytesAtDest = sum(AllowedInboundBytesAtDest), \r\n    BlockedInboundBytesAtDest = sum(BlockedInboundBytesAtDest), \r\n    AllowedOutboundBytesAtDest = sum(AllowedOutboundBytesAtDest), \r\n    BlockedOutboundBytesAtDest = sum(BlockedOutboundBytesAtDest),\r\n    AllowedInboundPacketsAtSrc = sum(AllowedInboundPacketsAtSrc), \r\n    BlockedInboundPacketsAtSrc = sum(BlockedInboundPacketsAtSrc), \r\n    AllowedOutboundPacketsAtSrc = sum(AllowedOutboundPacketsAtSrc), \r\n    BlockedOutboundPacketsAtSrc = sum(BlockedOutboundPacketsAtSrc), \r\n    AllowedInboundPacketsAtDest = sum(AllowedInboundPacketsAtDest), \r\n    BlockedInboundPacketsAtDest = sum(BlockedInboundPacketsAtDest), \r\n    AllowedOutboundPacketsAtDest = sum(AllowedOutboundPacketsAtDest), \r\n    BlockedOutboundPacketsAtDest = sum(BlockedOutboundPacketsAtDest)\r\n    by\r\n    SrcIp,\r\n    SrcSubscription,\r\n    SrcNic,\r\n    DestIp,\r\n    DestSubscription,\r\n    DestNic,\r\n    FlowDirection,\r\n    L4Protocol,\r\n    DestPort,\r\n    CountryOrRegion,\r\n    isMaliciousFlow,\r\n    L7Protocol\r\n    | extend AllowedOutbound_inferred = max_of(AllowedOutbound, AllowedInbound + BlockedInbound)\r\n    | extend Outbound = AllowedOutbound_inferred + BlockedOutbound, Inbound = AllowedOutbound_inferred\r\n    | extend FlowCount = max_of(Inbound, Outbound)\r\n    | extend AllowedOutboundBytesAtSrc_inferred = max_of(AllowedOutboundBytesAtSrc, AllowedInboundBytesAtDest + BlockedInboundBytesAtDest)\r\n    | extend AllowedOutboundBytesAtDest_inferred = max_of(AllowedOutboundBytesAtDest, AllowedInboundBytesAtSrc + BlockedInboundBytesAtSrc)\r\n    | extend OutboundBytesAtSrc = AllowedOutboundBytesAtSrc_inferred + BlockedOutboundBytesAtSrc, InboundBytesAtSrc = AllowedOutboundBytesAtDest_inferred\r\n    | extend OutboundBytesAtDest = AllowedOutboundBytesAtDest_inferred + BlockedOutboundBytesAtDest, InboundBytesAtDest = AllowedOutboundBytesAtSrc_inferred\r\n    | extend BytesCount = max_of(OutboundBytesAtSrc, InboundBytesAtDest) + max_of(OutboundBytesAtDest, InboundBytesAtSrc)\r\n    | extend AllowedOutboundPacketsAtSrc_inferred = max_of(AllowedOutboundPacketsAtSrc, AllowedInboundPacketsAtDest + BlockedInboundPacketsAtDest)\r\n    | extend AllowedOutboundPacketsAtDest_inferred = max_of(AllowedOutboundPacketsAtDest, AllowedInboundPacketsAtSrc + BlockedInboundPacketsAtSrc)\r\n    | extend OutboundPacketsAtSrc = AllowedOutboundPacketsAtSrc_inferred + BlockedOutboundPacketsAtSrc, InboundPacketsAtSrc = AllowedOutboundPacketsAtDest_inferred\r\n    | extend OutboundPacketsAtDest = AllowedOutboundPacketsAtDest_inferred + BlockedOutboundPacketsAtDest, InboundPacketsAtDest = AllowedOutboundPacketsAtSrc_inferred\r\n    | extend PacketsCount = max_of(OutboundPacketsAtSrc, InboundPacketsAtDest) + max_of(OutboundPacketsAtDest, InboundPacketsAtSrc)\r\n    | extend \r\n    AllowedTraffic = tolong(AllowedInbound) + tolong(AllowedOutbound),\r\n    BlockedTraffic = tolong(BlockedInbound) + tolong(BlockedOutbound)\r\n    // fork part 2 Bytes:\r\n    | extend \r\n    AllowedTrafficBytes = tolong(AllowedInboundBytesAtDest) + tolong(AllowedInboundBytesAtSrc) + tolong(AllowedOutboundBytesAtSrc) + tolong(AllowedOutboundBytesAtDest),\r\n    BlockedTrafficBytes = tolong(BlockedInboundBytesAtDest) + tolong(BlockedInboundBytesAtSrc) + tolong(BlockedOutboundBytesAtSrc) + tolong(BlockedOutboundBytesAtDest) \r\n    // fork part 3 Packets:\r\n    | extend \r\n    AllowedTrafficPackets = tolong(AllowedInboundPacketsAtDest) + tolong(AllowedInboundPacketsAtSrc) + tolong(AllowedOutboundPacketsAtSrc) + tolong(AllowedOutboundPacketsAtDest),\r\n    BlockedTrafficPackets = tolong(BlockedInboundPacketsAtDest) + tolong(BlockedInboundPacketsAtSrc) + tolong(BlockedOutboundPacketsAtSrc) + tolong(BlockedOutboundPacketsAtDest)\r\n    | summarize \r\n    // summarize for flows\r\n    AllowedTraffic = sum(AllowedTraffic), \r\n    BlockedTraffic = sum(BlockedTraffic),\r\n    MaliciousFlow = sum(iff(isMaliciousFlow, AllowedTraffic + BlockedTraffic, 0)),\r\n    TotalFlow = sum(FlowCount),\r\n    // summarize for bytes\r\n    AllowedBytes = sum(AllowedTrafficBytes), \r\n    BlockedBytes = sum(BlockedTrafficBytes),\r\n    MaliciousBytes = sum(iff(isMaliciousFlow, AllowedTrafficBytes + BlockedTrafficBytes, 0)),\r\n    TotalBytes = sum(BytesCount),\r\n    // summarize for packets\r\n    AllowedPackets = sum(AllowedTrafficPackets),\r\n    BlockedPackets = sum(BlockedTrafficPackets),\r\n    MaliciousPackets = sum(iff(isMaliciousFlow, AllowedTrafficPackets + BlockedTrafficPackets, 0)),\r\n    TotalPackets = sum(PacketsCount) \r\n    by L7Protocol, DestPort\r\n| summarize totalTraffic = iff('{Units:value}' =~ 'bytes', sum(TotalBytes), iff('{Units:value}' =~ 'packets', sum(TotalPackets), sum(TotalFlow))),\r\nallowedTraffic = iff('{Units:value}' =~ 'bytes', sum(AllowedBytes), iff('{Units:value}' =~ 'packets', sum(AllowedPackets), sum(AllowedTraffic))),\r\nmaliciousTraffic = iff('{Units:value}' =~ 'bytes', sum(MaliciousBytes), iff('{Units:value}' =~ 'packets', sum(MaliciousPackets), sum(MaliciousFlow))),\r\nblockedTraffic = iff('{Units:value}' =~ 'bytes', sum(BlockedBytes), iff('{Units:value}' =~ 'packets', sum(BlockedPackets), sum(BlockedTraffic)));\r\nlet FinalTraffic = ApplicationProtocolsNSG\r\n| union ApplicationProtocolsVNet\r\n| summarize TotalTraffic = sum(totalTraffic), AllowedTraffic = sum(allowedTraffic), MaliciousTraffic = sum(maliciousTraffic), BlockedTraffic = sum(blockedTraffic);\r\n union (\r\n        FinalTraffic\r\n        | project ColumnName = 'TotalTraffic', Value = TotalTraffic\r\n    ),\r\n    (\r\n        FinalTraffic\r\n        | project ColumnName = 'AllowedTraffic', Value = AllowedTraffic\r\n    ),\r\n    (\r\n        FinalTraffic\r\n        | project ColumnName = 'Malicious Traffic', Value = MaliciousTraffic\r\n    ),\r\n    (\r\n        FinalTraffic\r\n        | project ColumnName = 'Blocked Traffic', Value = BlockedTraffic\r\n    )",
                    "size": 0,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{workspace}"
                    ],
                    "visualization": "tiles",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "ColumnName",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "Value",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "auto"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "maximumSignificantDigits": 3,
                            "maximumFractionDigits": 2
                          }
                        }
                      },
                      "showBorder": false
                    }
                  },
                  "conditionalVisibility": {
                    "parameterName": "FlowType",
                    "comparison": "isEqualTo",
                    "value": "both"
                  },
                  "showPin": false,
                  "name": "UnionTraffic"
                }
              ]
            },
            "name": "MetricsSplit"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "## APPLICATION PORTS"
                  },
                  "name": "text - 5"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let ValueWithUnit = (x:real, precision:int) {\r\n    iff(x < 1000, strcat(tostring(round(x, precision)), ''), \r\n    iff(x < 1000000, strcat(tostring(round(x/1000, precision)), ' K'), \r\n    iff(x < 1000000000, strcat(tostring(round(x/1000000, precision)), ' M'), \r\n    iff(x < 1000000000000, strcat(tostring(round(x/1000000000, precision)), ' B'), \r\n    iff(x < 1000000000000000, strcat(tostring(round(x/1000000000000, precision)), ' t'), \r\n    strcat(tostring(round(x/1000000000000000, precision)), ' q'))))))\r\n};\r\nlet common = AzureNetworkAnalytics_CL\r\n| where SubType_s == 'FlowLog' and (FASchemaVersion_s == '1' or FASchemaVersion_s == '2')\r\n// filter begins\r\n| where TimeGenerated between (todatetime('{timeInterval:startISO}') .. datetime_add('day', 7, todatetime('{timeInterval:endISO}'))) and FlowStartTime_t between (datetime('{timeInterval:startISO}') .. datetime('{timeInterval:endISO}'))\r\n| where iff(\"{subscriptions}\" == \"'*'\", true, (Subscription1_g in~ ({subscriptions}) or Subscription2_g in~ ({subscriptions})))\r\n| extend Subnet1Split = split(Subnet1_s, '/'), Subnet2Split = split(Subnet2_s, '/')\r\n| extend rg1ToCheck = Subnet1Split[0], rg2ToCheck = Subnet2Split[0]\r\n| where iff(\"{resourceGroups}\" == \"'*'\", true, (rg1ToCheck in~ ({resourceGroups}) or rg2ToCheck in~ ({resourceGroups})))\r\n| extend\r\n    portToCheck = DestPort_d\r\n    {portRangeCheckLine}\r\n// filter ends\r\n| extend isMaliciousFlow = (FlowType_s == 'MaliciousFlow')\r\n| extend CountryOrRegion = iif(FlowType_s == 'AzurePublic', AzureRegion_s, Country_s)\r\n| extend \r\n    AllowedInboundBytesAtSrc = iff(FlowStatus_s == 'A' and FlowDirection_s == 'O', tolong(InboundBytes_d), 0), \r\n    BlockedInboundBytesAtSrc = iff(FlowStatus_s == 'D' and FlowDirection_s == 'O', tolong(InboundBytes_d), 0), \r\n    AllowedOutboundBytesAtSrc = iff(FlowStatus_s == 'A' and FlowDirection_s == 'O', tolong(OutboundBytes_d), 0), \r\n    BlockedOutboundBytesAtSrc = iff(FlowStatus_s == 'D' and FlowDirection_s == 'O', tolong(OutboundBytes_d), 0), \r\n    AllowedInboundBytesAtDest = iff(FlowStatus_s == 'A' and FlowDirection_s == 'I', tolong(InboundBytes_d), 0), \r\n    BlockedInboundBytesAtDest = iff(FlowStatus_s == 'D' and FlowDirection_s == 'I', tolong(InboundBytes_d), 0), \r\n    AllowedOutboundBytesAtDest = iff(FlowStatus_s == 'A' and FlowDirection_s == 'I', tolong(OutboundBytes_d), 0), \r\n    BlockedOutboundBytesAtDest = iff(FlowStatus_s == 'D' and FlowDirection_s == 'I', tolong(OutboundBytes_d), 0)\r\n| extend \r\n    AllowedInboundPacketsAtSrc = iff(FlowStatus_s == 'A' and FlowDirection_s == 'O', tolong(InboundPackets_d), 0), \r\n    BlockedInboundPacketsAtSrc = iff(FlowStatus_s == 'D' and FlowDirection_s == 'O', tolong(InboundPackets_d), 0), \r\n    AllowedOutboundPacketsAtSrc = iff(FlowStatus_s == 'A' and FlowDirection_s == 'O', tolong(OutboundPackets_d), 0), \r\n    BlockedOutboundPacketsAtSrc = iff(FlowStatus_s == 'D' and FlowDirection_s == 'O', tolong(OutboundPackets_d), 0), \r\n    AllowedInboundPacketsAtDest = iff(FlowStatus_s == 'A' and FlowDirection_s == 'I', tolong(InboundPackets_d), 0), \r\n    BlockedInboundPacketsAtDest = iff(FlowStatus_s == 'D' and FlowDirection_s == 'I', tolong(InboundPackets_d), 0), \r\n    AllowedOutboundPacketsAtDest = iff(FlowStatus_s == 'A' and FlowDirection_s == 'I', tolong(OutboundPackets_d), 0), \r\n    BlockedOutboundPacketsAtDest = iff(FlowStatus_s == 'D' and FlowDirection_s == 'I', tolong(OutboundPackets_d), 0)\r\n| extend FlowDirection_s = iif(FlowType_s in ('InterVNet', 'IntraVNet'), '', FlowDirection_s)\r\n| summarize \r\n    AllowedInbound = sum(AllowedInFlows_d),\r\n    BlockedInbound = sum(DeniedInFlows_d), \r\n    AllowedOutbound = sum(AllowedOutFlows_d),\r\n    BlockedOutbound = sum(DeniedOutFlows_d),\r\n    AllowedInboundBytesAtSrc = sum(AllowedInboundBytesAtSrc),\r\n    BlockedInboundBytesAtSrc = sum(BlockedInboundBytesAtSrc), \r\n    AllowedOutboundBytesAtSrc = sum(AllowedOutboundBytesAtSrc),\r\n    BlockedOutboundBytesAtSrc = sum(BlockedOutboundBytesAtSrc), \r\n    AllowedInboundBytesAtDest = sum(AllowedInboundBytesAtDest),\r\n    BlockedInboundBytesAtDest = sum(BlockedInboundBytesAtDest), \r\n    AllowedOutboundBytesAtDest = sum(AllowedOutboundBytesAtDest),\r\n    BlockedOutboundBytesAtDest = sum(BlockedOutboundBytesAtDest),\r\n    AllowedInboundPacketsAtSrc = sum(AllowedInboundPacketsAtSrc),\r\n    BlockedInboundPacketsAtSrc = sum(BlockedInboundPacketsAtSrc), \r\n    AllowedOutboundPacketsAtSrc = sum(AllowedOutboundPacketsAtSrc),\r\n    BlockedOutboundPacketsAtSrc = sum(BlockedOutboundPacketsAtSrc), \r\n    AllowedInboundPacketsAtDest = sum(AllowedInboundPacketsAtDest),\r\n    BlockedInboundPacketsAtDest = sum(BlockedInboundPacketsAtDest), \r\n    AllowedOutboundPacketsAtDest = sum(AllowedOutboundPacketsAtDest),\r\n    BlockedOutboundPacketsAtDest = sum(BlockedOutboundPacketsAtDest)\r\n    by\r\n    SrcIP_s,\r\n    Subscription1_g,\r\n    NIC1_s,\r\n    DestIP_s,\r\n    Subscription2_g,\r\n    NIC2_s,\r\n    FlowDirection_s,\r\n    L4Protocol_s,\r\n    DestPort_d,\r\n    CountryOrRegion,\r\n    isMaliciousFlow,\r\n    L7Protocol_s\r\n| extend AllowedOutbound_inferred = max_of(AllowedOutbound, AllowedInbound + BlockedInbound)\r\n| extend\r\n    Outbound = AllowedOutbound_inferred + BlockedOutbound,\r\n    Inbound = AllowedOutbound_inferred\r\n| extend FlowCount = max_of(Inbound, Outbound)\r\n| extend AllowedOutboundBytesAtSrc_inferred = max_of(AllowedOutboundBytesAtSrc, AllowedInboundBytesAtDest + BlockedInboundBytesAtDest)\r\n| extend AllowedOutboundBytesAtDest_inferred = max_of(AllowedOutboundBytesAtDest, AllowedInboundBytesAtSrc + BlockedInboundBytesAtSrc)\r\n| extend\r\n    OutboundBytesAtSrc = AllowedOutboundBytesAtSrc_inferred + BlockedOutboundBytesAtSrc,\r\n    InboundBytesAtSrc = AllowedOutboundBytesAtDest_inferred\r\n| extend\r\n    OutboundBytesAtDest = AllowedOutboundBytesAtDest_inferred + BlockedOutboundBytesAtDest,\r\n    InboundBytesAtDest = AllowedOutboundBytesAtSrc_inferred\r\n| extend BytesCount = max_of(OutboundBytesAtSrc, InboundBytesAtDest) + max_of(OutboundBytesAtDest, InboundBytesAtSrc)\r\n| extend AllowedOutboundPacketsAtSrc_inferred = max_of(AllowedOutboundPacketsAtSrc, AllowedInboundPacketsAtDest + BlockedInboundPacketsAtDest)\r\n| extend AllowedOutboundPacketsAtDest_inferred = max_of(AllowedOutboundPacketsAtDest, AllowedInboundPacketsAtSrc + BlockedInboundPacketsAtSrc)\r\n| extend\r\n    OutboundPacketsAtSrc = AllowedOutboundPacketsAtSrc_inferred + BlockedOutboundPacketsAtSrc,\r\n    InboundPacketsAtSrc = AllowedOutboundPacketsAtDest_inferred\r\n| extend\r\n    OutboundPacketsAtDest = AllowedOutboundPacketsAtDest_inferred + BlockedOutboundPacketsAtDest,\r\n    InboundPacketsAtDest = AllowedOutboundPacketsAtSrc_inferred\r\n| extend PacketsCount = max_of(OutboundPacketsAtSrc, InboundPacketsAtDest) + max_of(OutboundPacketsAtDest, InboundPacketsAtSrc)\r\n| summarize \r\n    //\r\n    totalAllowedInbound = sum(AllowedInbound), \r\n    totalBlockedInbound = sum(BlockedInbound), \r\n    totalInboundMalicious = sum(iif(isMaliciousFlow, tolong(Inbound), 0)), \r\n    totalAllowedInboundMalicious = sum(iif(isMaliciousFlow, tolong(AllowedInbound), 0)), \r\n    totalBlockededInboundMalicious = sum(iif(isMaliciousFlow, tolong(BlockedInbound), 0)), \r\n    totalInbound = sum(Inbound),\r\n    TotalFlow = sum(FlowCount),\r\n    //\r\n    totalAllowedInboundBytes = sum(AllowedInboundBytesAtDest), \r\n    totalBlockedInboundBytes = sum(BlockedInboundBytesAtDest), \r\n    totalInboundMaliciousBytes = sum(iif(isMaliciousFlow, tolong(InboundBytesAtDest), 0)), \r\n    totalAllowedInboundMaliciousBytes = sum(iif(isMaliciousFlow, tolong(AllowedInboundBytesAtDest), 0)), \r\n    totalBlockededInboundMaliciousBytes = sum(iif(isMaliciousFlow, tolong(BlockedInboundBytesAtDest), 0)), \r\n    totalAllowedOutboundBytes = sum(AllowedOutboundBytesAtDest), \r\n    totalBlockedOutboundBytes = sum(BlockedOutboundBytesAtDest), \r\n    totalOutboundMaliciousBytes = sum(iif(isMaliciousFlow, tolong(OutboundBytesAtDest), 0)), \r\n    totalAllowedOutboundMaliciousBytes = sum(iif(isMaliciousFlow, tolong(AllowedOutboundBytesAtDest), 0)), \r\n    totalBlockededOutboundMaliciousBytes = sum(iif(isMaliciousFlow, tolong(BlockedOutboundBytesAtDest), 0)), \r\n    totalInboundBytesAtDest = sum(InboundBytesAtDest), \r\n    totalOutboundBytesAtDest = sum(OutboundBytesAtDest),\r\n    TotalBytes = sum(BytesCount),\r\n    //\r\n    totalAllowedInboundPackets = sum(AllowedInboundPacketsAtDest), \r\n    totalBlockedInboundPackets = sum(BlockedInboundPacketsAtDest), \r\n    totalInboundMaliciousPackets = sum(iif(isMaliciousFlow, tolong(InboundPacketsAtDest), 0)), \r\n    totalAllowedInboundMaliciousPackets = sum(iif(isMaliciousFlow, tolong(AllowedInboundPacketsAtDest), 0)), \r\n    totalBlockededInboundMaliciousPackets = sum(iif(isMaliciousFlow, tolong(BlockedInboundPacketsAtDest), 0)), \r\n    totalAllowedOutboundPackets = sum(AllowedOutboundPacketsAtDest), \r\n    totalBlockedOutboundPackets = sum(BlockedOutboundPacketsAtDest), \r\n    totalOutboundMaliciousPackets = sum(iif(isMaliciousFlow, tolong(OutboundPacketsAtDest), 0)), \r\n    totalAllowedOutboundMaliciousPackets = sum(iif(isMaliciousFlow, tolong(AllowedOutboundPacketsAtDest), 0)), \r\n    totalBlockededOutboundMaliciousPackets = sum(iif(isMaliciousFlow, tolong(BlockedOutboundPacketsAtDest), 0)), \r\n    totalInboundPackets = sum(InboundPacketsAtDest), \r\n    totalOutboundPackets = sum(OutboundPacketsAtDest),\r\n    TotalPackets = sum(PacketsCount)\r\n    //\r\n    by L7Protocol_s, DestPort_d\r\n| extend TotalTraffic = iff('{Units:value}' =~ 'bytes', TotalBytes, iff('{Units:value}' =~ 'packets', TotalPackets, tolong(TotalFlow)))\r\n| where TotalTraffic > 0\r\n| project\r\n    L7Protocol_s,\r\n    DestPort_d,\r\n    protocolInfo = strcat(L7Protocol_s, '#', toint(DestPort_d)),\r\n    trafficForSorting = TotalTraffic,\r\n    totalInbound = iff('{Units:value}' =~ 'bytes', strcat('Egress : ', format_bytes(totalOutboundBytesAtDest, 3), ' Ingress : ', format_bytes(totalInboundBytesAtDest, 3)), iff('{Units:value}' =~ 'packets', strcat('Egress : ', ValueWithUnit(totalOutboundPackets, 3), ' Ingress : ', ValueWithUnit(totalInboundPackets, 3)), ValueWithUnit(totalInbound, 3))),\r\n    allowedInbound = iff('{Units:value}' =~ 'bytes', strcat('Egress : ', format_bytes(totalAllowedOutboundBytes, 3), ' Ingress : ', format_bytes(totalAllowedInboundBytes, 3)), iff('{Units:value}' =~ 'packets', strcat('Egress : ', ValueWithUnit(totalAllowedOutboundPackets, 3), ' Ingress : ', ValueWithUnit(totalAllowedInboundPackets, 3)), ValueWithUnit(totalAllowedInbound, 3))),\r\n    blockedInbound = iff('{Units:value}' =~ 'bytes', strcat('Egress : ', format_bytes(totalBlockedOutboundBytes, 3), ' Ingress : ', format_bytes(totalBlockedInboundBytes, 3)), iff('{Units:value}' =~ 'packets', strcat('Egress : ', ValueWithUnit(totalBlockedOutboundPackets, 3), ' Ingress : ', ValueWithUnit(totalBlockedInboundPackets, 3)), ValueWithUnit(totalBlockedInbound, 3))),\r\n    totalMalicious = iff('{Units:value}' =~ 'bytes', strcat('Egress : ', format_bytes(totalOutboundMaliciousBytes, 3), ' Ingress : ', format_bytes(totalInboundMaliciousBytes, 3)), iff('{Units:value}' =~ 'packets', strcat('Egress : ', ValueWithUnit(totalOutboundMaliciousPackets, 3), ' Ingress : ', ValueWithUnit(totalInboundMaliciousPackets, 3)), ValueWithUnit(totalInboundMalicious, 3))),\r\n    allowedMalicious = iff('{Units:value}' =~ 'bytes', strcat('Egress : ', format_bytes(totalAllowedOutboundMaliciousBytes, 3), ' Ingress : ', format_bytes(totalAllowedInboundMaliciousBytes, 3)), iff('{Units:value}' =~ 'packets', strcat('Egress : ', ValueWithUnit(totalAllowedOutboundMaliciousPackets, 3), ' Ingress : ', ValueWithUnit(totalAllowedInboundMaliciousPackets, 3)), ValueWithUnit(totalAllowedInboundMalicious, 3))),\r\n    blockedMalicious = iff('{Units:value}' =~ 'bytes', strcat('Egress : ', format_bytes(totalBlockededOutboundMaliciousBytes, 3), ' Ingress : ', format_bytes(totalBlockededInboundMaliciousBytes, 3)), iff('{Units:value}' =~ 'packets', strcat('Egress : ', ValueWithUnit(totalBlockededOutboundMaliciousPackets, 3), ' Ingress : ', ValueWithUnit(totalBlockededInboundMaliciousPackets, 3)), ValueWithUnit(totalBlockededInboundMalicious, 3)));\r\nlet topTalking = \r\n    AzureNetworkAnalytics_CL\r\n    | where SubType_s == 'FlowLog' and  (FASchemaVersion_s == '1' or FASchemaVersion_s == '2')\r\n    // filter begins\r\n    | where TimeGenerated between (todatetime('{timeInterval:startISO}') .. datetime_add('day', 7, todatetime('{timeInterval:endISO}'))) and FlowStartTime_t between (datetime('{timeInterval:startISO}') .. datetime('{timeInterval:endISO}'))\r\n    | where iff(\"{subscriptions}\" == \"'*'\", true, (Subscription1_g in~ ({subscriptions}) or Subscription2_g in~ ({subscriptions})))\r\n    | extend Subnet1Split = split(Subnet1_s, '/'), Subnet2Split = split(Subnet2_s, '/')\r\n    | extend rg1ToCheck = Subnet1Split[0], rg2ToCheck = Subnet2Split[0]\r\n    | where iff(\"{resourceGroups}\" == \"'*'\", true, (rg1ToCheck in~ ({resourceGroups}) or rg2ToCheck in~ ({resourceGroups})))\r\n    | extend\r\n         portToCheck = DestPort_d\r\n         {portRangeCheckLine}\r\n    // filter ends\r\n    | extend protocolInfo = strcat(L7Protocol_s, '#', toint(DestPort_d))\r\n    | where isnotempty(VM2_s)\r\n    | extend CountryOrRegion = iif(FlowType_s == 'AzurePublic', AzureRegion_s, Country_s)\r\n    | extend\r\n        AllowedInboundBytesAtSrc = iff(FlowStatus_s == 'A' and FlowDirection_s == 'O', tolong(InboundBytes_d), 0),\r\n        BlockedInboundBytesAtSrc = iff(FlowStatus_s == 'D' and FlowDirection_s == 'O', tolong(InboundBytes_d), 0),\r\n        AllowedOutboundBytesAtSrc = iff(FlowStatus_s == 'A' and FlowDirection_s == 'O', tolong(OutboundBytes_d), 0),\r\n        BlockedOutboundBytesAtSrc = iff(FlowStatus_s == 'D' and FlowDirection_s == 'O', tolong(OutboundBytes_d), 0),\r\n        AllowedInboundBytesAtDest = iff(FlowStatus_s == 'A' and FlowDirection_s == 'I', tolong(InboundBytes_d), 0),\r\n        BlockedInboundBytesAtDest = iff(FlowStatus_s == 'D' and FlowDirection_s == 'I', tolong(InboundBytes_d), 0),\r\n        AllowedOutboundBytesAtDest = iff(FlowStatus_s == 'A' and FlowDirection_s == 'I', tolong(OutboundBytes_d), 0),\r\n        BlockedOutboundBytesAtDest = iff(FlowStatus_s == 'D' and FlowDirection_s == 'I', tolong(OutboundBytes_d), 0)\r\n    | extend FlowDirection_s = iif(FlowType_s in ('InterVNet', 'IntraVNet'), '', FlowDirection_s)\r\n    | extend\r\n        AllowedInboundPacketsAtSrc = iff(FlowStatus_s == 'A' and FlowDirection_s == 'O', tolong(InboundPackets_d), 0),\r\n        BlockedInboundPacketsAtSrc = iff(FlowStatus_s == 'D' and FlowDirection_s == 'O', tolong(InboundPackets_d), 0),\r\n        AllowedOutboundPacketsAtSrc = iff(FlowStatus_s == 'A' and FlowDirection_s == 'O', tolong(OutboundPackets_d), 0),\r\n        BlockedOutboundPacketsAtSrc = iff(FlowStatus_s == 'D' and FlowDirection_s == 'O', tolong(OutboundPackets_d), 0),\r\n        AllowedInboundPacketsAtDest = iff(FlowStatus_s == 'A' and FlowDirection_s == 'I', tolong(InboundPackets_d), 0),\r\n        BlockedInboundPacketsAtDest = iff(FlowStatus_s == 'D' and FlowDirection_s == 'I', tolong(InboundPackets_d), 0),\r\n        AllowedOutboundPacketsAtDest = iff(FlowStatus_s == 'A' and FlowDirection_s == 'I', tolong(OutboundPackets_d), 0),\r\n        BlockedOutboundPacketsAtDest = iff(FlowStatus_s == 'D' and FlowDirection_s == 'I', tolong(OutboundPackets_d), 0)\r\n    | summarize \r\n        AllowedInbound = sum(AllowedInFlows_d),\r\n        BlockedInbound = sum(DeniedInFlows_d), \r\n        AllowedOutbound = sum(AllowedOutFlows_d),\r\n        BlockedOutbound = sum(DeniedOutFlows_d),\r\n        AllowedInboundBytesAtSrc = sum(AllowedInboundBytesAtSrc),\r\n        BlockedInboundBytesAtSrc = sum(BlockedInboundBytesAtSrc),\r\n        AllowedOutboundBytesAtSrc = sum(AllowedOutboundBytesAtSrc),\r\n        BlockedOutboundBytesAtSrc = sum(BlockedOutboundBytesAtSrc),\r\n        AllowedInboundBytesAtDest = sum(AllowedInboundBytesAtDest),\r\n        BlockedInboundBytesAtDest = sum(BlockedInboundBytesAtDest),\r\n        AllowedOutboundBytesAtDest = sum(AllowedOutboundBytesAtDest),\r\n        BlockedOutboundBytesAtDest = sum(BlockedOutboundBytesAtDest),\r\n        AllowedInboundPacketsAtSrc = sum(AllowedInboundPacketsAtSrc),\r\n        BlockedInboundPacketsAtSrc = sum(BlockedInboundPacketsAtSrc),\r\n        AllowedOutboundPacketsAtSrc = sum(AllowedOutboundPacketsAtSrc),\r\n        BlockedOutboundPacketsAtSrc = sum(BlockedOutboundPacketsAtSrc),\r\n        AllowedInboundPacketsAtDest = sum(AllowedInboundPacketsAtDest),\r\n        BlockedInboundPacketsAtDest = sum(BlockedInboundPacketsAtDest),\r\n        AllowedOutboundPacketsAtDest = sum(AllowedOutboundPacketsAtDest),\r\n        BlockedOutboundPacketsAtDest = sum(BlockedOutboundPacketsAtDest)\r\n        by\r\n        SrcIP_s,\r\n        Subscription1_g,\r\n        NIC1_s,\r\n        DestIP_s,\r\n        Subscription2_g,\r\n        NIC2_s,\r\n        FlowDirection_s,\r\n        L4Protocol_s,\r\n        DestPort_d,\r\n        CountryOrRegion,\r\n        VM2_s,\r\n        protocolInfo\r\n    | extend AllowedOutbound_inferred = max_of(AllowedOutbound, AllowedInbound + BlockedInbound)\r\n    | extend\r\n        Outbound = AllowedOutbound_inferred + BlockedOutbound,\r\n        Inbound = AllowedOutbound_inferred\r\n    | extend FlowCount = max_of(Inbound, Outbound)\r\n    | extend AllowedOutboundBytesAtSrc_inferred = max_of(AllowedOutboundBytesAtSrc, AllowedInboundBytesAtDest + BlockedInboundBytesAtDest)\r\n    | extend AllowedOutboundBytesAtDest_inferred = max_of(AllowedOutboundBytesAtDest, AllowedInboundBytesAtSrc + BlockedInboundBytesAtSrc)\r\n    | extend\r\n        OutboundBytesAtSrc = AllowedOutboundBytesAtSrc_inferred + BlockedOutboundBytesAtSrc,\r\n        InboundBytesAtSrc = AllowedOutboundBytesAtDest_inferred\r\n    | extend\r\n        OutboundBytesAtDest = AllowedOutboundBytesAtDest_inferred + BlockedOutboundBytesAtDest,\r\n        InboundBytesAtDest = AllowedOutboundBytesAtSrc_inferred\r\n    | extend BytesCount = max_of(OutboundBytesAtSrc, InboundBytesAtDest) + max_of(OutboundBytesAtDest, InboundBytesAtSrc)\r\n    | extend AllowedOutboundPacketsAtSrc_inferred = max_of(AllowedOutboundPacketsAtSrc, AllowedInboundPacketsAtDest + BlockedInboundPacketsAtDest)\r\n    | extend AllowedOutboundPacketsAtDest_inferred = max_of(AllowedOutboundPacketsAtDest, AllowedInboundPacketsAtSrc + BlockedInboundPacketsAtSrc)\r\n    | extend\r\n        OutboundPacketsAtSrc = AllowedOutboundPacketsAtSrc_inferred + BlockedOutboundPacketsAtSrc,\r\n        InboundPacketsAtSrc = AllowedOutboundPacketsAtDest_inferred\r\n    | extend\r\n        OutboundPacketsAtDest = AllowedOutboundPacketsAtDest_inferred + BlockedOutboundPacketsAtDest,\r\n        InboundPacketsAtDest = AllowedOutboundPacketsAtSrc_inferred\r\n    | extend PacketsCount = max_of(OutboundPacketsAtSrc, InboundPacketsAtDest) + max_of(OutboundPacketsAtDest, InboundPacketsAtSrc)\r\n    | summarize totalTraffic = sum(iff('{Units:value}' =~ 'bytes', BytesCount, iff('{Units:value}' =~ 'packets', PacketsCount, tolong(FlowCount)))) by host = strcat(Subscription2_g, '#', VM2_s, '#', DestIP_s), protocolInfo\r\n    | top-nested of protocolInfo by max(1), top-nested 3 of host by max(totalTraffic)\r\n    | summarize topTalkingPairs = strcat_array(make_list(strcat(split(host, '#')[2], ' (', split(split(host, '#')[1], '/')[1], ')')), ', ') by protocolInfo\r\n    | project protocolInfo, topTalkingPairs;\r\nlet topMalicious = \r\n    AzureNetworkAnalytics_CL\r\n    | where SubType_s == 'FlowLog' and  (FASchemaVersion_s == '1' or FASchemaVersion_s == '2')\r\n    // filter begins\r\n    | where TimeGenerated between (todatetime('{timeInterval:startISO}') .. datetime_add('day', 7, todatetime('{timeInterval:endISO}'))) and FlowStartTime_t between (datetime('{timeInterval:startISO}') .. datetime('{timeInterval:endISO}'))\r\n    | where iff(\"{subscriptions}\" == \"'*'\", true, (Subscription1_g in~ ({subscriptions}) or Subscription2_g in~ ({subscriptions})))\r\n    | extend Subnet1Split = split(Subnet1_s, '/'), Subnet2Split = split(Subnet2_s, '/')\r\n    | extend rg1ToCheck = Subnet1Split[0], rg2ToCheck = Subnet2Split[0]\r\n    | where iff(\"{resourceGroups}\" == \"'*'\", true, (rg1ToCheck in~ ({resourceGroups}) or rg2ToCheck in~ ({resourceGroups})))\r\n    | extend vnet1ToCheck = Subnet1Split[1], vnet2ToCheck = Subnet2Split[1]\r\n    | extend\r\n         portToCheck = DestPort_d\r\n         {portRangeCheckLine}\r\n    // filter ends\r\n    | extend protocolInfo = strcat(L7Protocol_s, '#', toint(DestPort_d))\r\n    | where FlowType_s == 'MaliciousFlow'\r\n    | extend MaliciousIp = iif(isnotempty(VM2_s), SrcIP_s, DestIP_s)\r\n    | summarize totalMalicious = iff('{Units:value}' =~ 'bytes', sum(InboundBytes_d + OutboundBytes_d), iff('{Units:value}' =~ 'packets', sum(InboundPackets_d + OutboundPackets_d), sum(AllowedOutFlows_d + DeniedOutFlows_d + AllowedInFlows_d + DeniedInFlows_d)))\r\n        by MaliciousIp, Country_s, protocolInfo\r\n    | top-nested of protocolInfo by max(1),\r\n    top-nested 3 of partnerInfo = strcat(MaliciousIp, '#', Country_s) by max(totalMalicious)\r\n    | project protocolInfo, partnerInfo\r\n    | summarize topMaliciousPairs = strcat_array(make_list(strcat(split(partnerInfo, '#')[0], ' (', split(partnerInfo, '#')[1], ')')), ',') by protocolInfo\r\n    | project protocolInfo, topMaliciousPairs;\r\ncommon\r\n| join kind=leftouter topTalking on $left.protocolInfo == $right.protocolInfo\r\n| join kind=leftouter topMalicious on $left.protocolInfo == $right.protocolInfo\r\n| sort by trafficForSorting desc\r\n| project\r\n    L7Protocol = L7Protocol_s,\r\n    DestPort = DestPort_d,\r\n    topTalkingPairs,\r\n    topMaliciousPairs,\r\n    totalInbound,\r\n    allowedInbound,\r\n    blockedInbound,\r\n    totalMalicious,\r\n    allowedMalicious,\r\n    blockedMalicious",
                    "size": 0,
                    "aggregation": 2,
                    "showAnnotations": true,
                    "showAnalytics": true,
                    "noDataMessage": "No data to display",
                    "timeContextFromParameter": "timeInterval",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{workspace}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "aggregatedTotalFlow",
                          "formatter": 19,
                          "formatOptions": {
                            "palette": "orange",
                            "timelineSettings": {
                              "timelineStartColumn": "Time"
                            }
                          }
                        }
                      ]
                    }
                  },
                  "conditionalVisibility": {
                    "parameterName": "FlowType",
                    "comparison": "isEqualTo",
                    "value": "nsg"
                  },
                  "name": "ProtocolsNSG"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let ValueWithUnit = (x:real, precision:int) {\r\n    iff(x < 1000, strcat(tostring(round(x, precision)), ''), \r\n    iff(x < 1000000, strcat(tostring(round(x/1000, precision)), ' K'), \r\n    iff(x < 1000000000, strcat(tostring(round(x/1000000, precision)), ' M'), \r\n    iff(x < 1000000000000, strcat(tostring(round(x/1000000000, precision)), ' B'), \r\n    iff(x < 1000000000000000, strcat(tostring(round(x/1000000000000, precision)), ' t'), \r\n    strcat(tostring(round(x/1000000000000000, precision)), ' q'))))))\r\n};\r\nlet common = \r\n    NTANetAnalytics\r\n    | where SubType == 'FlowLog' and FaSchemaVersion == '3'\r\n    // filter begins\r\n    | where TimeGenerated between (todatetime('{timeInterval:startISO}') .. datetime_add('day', 7, todatetime('{timeInterval:endISO}'))) and FlowStartTime between (datetime('{timeInterval:startISO}') .. datetime('{timeInterval:endISO}'))\r\n    | where iff(\"{subscriptions}\" == \"'*'\", true, (SrcSubscription in~ ({subscriptions}) or DestSubscription in~ ({subscriptions})))\r\n    | extend Subnet1Split = split(SrcSubnet, '/'), Subnet2Split = split(DestSubnet, '/')\r\n    | extend rg1ToCheck = Subnet1Split[0], rg2ToCheck = Subnet2Split[0]\r\n    | where iff(\"{resourceGroups}\" == \"'*'\", true, (rg1ToCheck in~ ({resourceGroups}) or rg2ToCheck in~ ({resourceGroups})))\r\n    | extend vnet1ToCheck = Subnet1Split[1], vnet2ToCheck = Subnet2Split[1]\r\n    | extend portToCheck = DestPort\r\n    {portRangeCheckLine}\r\n    // filter ends\r\n    | extend isMaliciousFlow = (FlowType == 'MaliciousFlow')\r\n    | extend CountryOrRegion = iif(FlowType == 'AzurePublic', AzureRegion, Country)\r\n    | extend \r\n    AllowedInboundBytesAtSrc = iff(FlowStatus == 'Allowed' and FlowDirection == 'Outbound', tolong(BytesDestToSrc), 0), \r\n    BlockedInboundBytesAtSrc = iff(FlowStatus == 'Denied' and FlowDirection == 'Outbound', tolong(BytesDestToSrc), 0), \r\n    AllowedOutboundBytesAtSrc = iff(FlowStatus == 'Allowed' and FlowDirection == 'Outbound', tolong(BytesSrcToDest), 0), \r\n    BlockedOutboundBytesAtSrc = iff(FlowStatus == 'Denied' and FlowDirection == 'Outbound', tolong(BytesSrcToDest), 0), \r\n    AllowedInboundBytesAtDest = iff(FlowStatus == 'Allowed' and FlowDirection == 'Inbound', tolong(BytesDestToSrc), 0), \r\n    BlockedInboundBytesAtDest = iff(FlowStatus == 'Denied' and FlowDirection == 'Inbound', tolong(BytesDestToSrc), 0), \r\n    AllowedOutboundBytesAtDest = iff(FlowStatus == 'Allowed' and FlowDirection == 'Inbound', tolong(BytesSrcToDest), 0), \r\n    BlockedOutboundBytesAtDest = iff(FlowStatus == 'Denied' and FlowDirection == 'Inbound', tolong(BytesSrcToDest), 0)\r\n    | extend \r\n    AllowedInboundPacketsAtSrc = iff(FlowStatus == 'Allowed' and FlowDirection == 'Outbound', tolong(PacketsDestToSrc), 0), \r\n    BlockedInboundPacketsAtSrc = iff(FlowStatus == 'Denied' and FlowDirection == 'Outbound', tolong(PacketsDestToSrc), 0), \r\n    AllowedOutboundPacketsAtSrc = iff(FlowStatus == 'Allowed' and FlowDirection == 'Outbound', tolong(PacketsSrcToDest), 0), \r\n    BlockedOutboundPacketsAtSrc = iff(FlowStatus == 'Denied' and FlowDirection == 'Outbound', tolong(PacketsSrcToDest), 0), \r\n    AllowedInboundPacketsAtDest = iff(FlowStatus == 'Allowed' and FlowDirection == 'Inbound', tolong(PacketsDestToSrc), 0), \r\n    BlockedInboundPacketsAtDest = iff(FlowStatus == 'Denied' and FlowDirection == 'Inbound', tolong(PacketsDestToSrc), 0), \r\n    AllowedOutboundPacketsAtDest = iff(FlowStatus == 'Allowed' and FlowDirection == 'Inbound', tolong(PacketsSrcToDest), 0), \r\n    BlockedOutboundPacketsAtDest = iff(FlowStatus == 'Denied' and FlowDirection == 'Inbound', tolong(PacketsSrcToDest), 0)\r\n    | extend FlowDirection = iif(FlowType in ('InterVNet', 'IntraVNet'), '', FlowDirection)\r\n    | summarize \r\n    AllowedInbound = sum(AllowedInFlows), BlockedInbound = sum(DeniedInFlows), \r\n    AllowedOutbound = sum(AllowedOutFlows), BlockedOutbound = sum(DeniedOutFlows),\r\n    AllowedInboundBytesAtSrc = sum(AllowedInboundBytesAtSrc), BlockedInboundBytesAtSrc = sum(BlockedInboundBytesAtSrc), \r\n    AllowedOutboundBytesAtSrc = sum(AllowedOutboundBytesAtSrc), BlockedOutboundBytesAtSrc = sum(BlockedOutboundBytesAtSrc), \r\n    AllowedInboundBytesAtDest = sum(AllowedInboundBytesAtDest), BlockedInboundBytesAtDest = sum(BlockedInboundBytesAtDest), \r\n    AllowedOutboundBytesAtDest = sum(AllowedOutboundBytesAtDest), BlockedOutboundBytesAtDest = sum(BlockedOutboundBytesAtDest),\r\n    AllowedInboundPacketsAtSrc = sum(AllowedInboundPacketsAtSrc), BlockedInboundPacketsAtSrc = sum(BlockedInboundPacketsAtSrc), \r\n    AllowedOutboundPacketsAtSrc = sum(AllowedOutboundPacketsAtSrc), BlockedOutboundPacketsAtSrc = sum(BlockedOutboundPacketsAtSrc), \r\n    AllowedInboundPacketsAtDest = sum(AllowedInboundPacketsAtDest), BlockedInboundPacketsAtDest = sum(BlockedInboundPacketsAtDest), \r\n    AllowedOutboundPacketsAtDest = sum(AllowedOutboundPacketsAtDest), BlockedOutboundPacketsAtDest = sum(BlockedOutboundPacketsAtDest)\r\n    by SrcIp, SrcSubscription, SrcNic, DestIp, DestSubscription, DestNic, FlowDirection, L4Protocol, DestPort, CountryOrRegion, isMaliciousFlow, L7Protocol\r\n    | extend AllowedOutbound_inferred = max_of(AllowedOutbound, AllowedInbound + BlockedInbound)\r\n    | extend Outbound = AllowedOutbound_inferred + BlockedOutbound, Inbound = AllowedOutbound_inferred\r\n    | extend FlowCount = max_of(Inbound, Outbound)\r\n    | extend AllowedOutboundBytesAtSrc_inferred = max_of(AllowedOutboundBytesAtSrc, AllowedInboundBytesAtDest + BlockedInboundBytesAtDest)\r\n    | extend AllowedOutboundBytesAtDest_inferred = max_of(AllowedOutboundBytesAtDest, AllowedInboundBytesAtSrc + BlockedInboundBytesAtSrc)\r\n    | extend OutboundBytesAtSrc = AllowedOutboundBytesAtSrc_inferred + BlockedOutboundBytesAtSrc, InboundBytesAtSrc = AllowedOutboundBytesAtDest_inferred\r\n    | extend OutboundBytesAtDest = AllowedOutboundBytesAtDest_inferred + BlockedOutboundBytesAtDest, InboundBytesAtDest = AllowedOutboundBytesAtSrc_inferred\r\n    | extend BytesCount = max_of(OutboundBytesAtSrc, InboundBytesAtDest) + max_of(OutboundBytesAtDest, InboundBytesAtSrc)\r\n    | extend AllowedOutboundPacketsAtSrc_inferred = max_of(AllowedOutboundPacketsAtSrc, AllowedInboundPacketsAtDest + BlockedInboundPacketsAtDest)\r\n    | extend AllowedOutboundPacketsAtDest_inferred = max_of(AllowedOutboundPacketsAtDest, AllowedInboundPacketsAtSrc + BlockedInboundPacketsAtSrc)\r\n    | extend OutboundPacketsAtSrc = AllowedOutboundPacketsAtSrc_inferred + BlockedOutboundPacketsAtSrc, InboundPacketsAtSrc = AllowedOutboundPacketsAtDest_inferred\r\n    | extend OutboundPacketsAtDest = AllowedOutboundPacketsAtDest_inferred + BlockedOutboundPacketsAtDest, InboundPacketsAtDest = AllowedOutboundPacketsAtSrc_inferred\r\n    | extend PacketsCount = max_of(OutboundPacketsAtSrc, InboundPacketsAtDest) + max_of(OutboundPacketsAtDest, InboundPacketsAtSrc)\r\n    | summarize \r\n    //\r\n    totalAllowedInbound = sum(AllowedInbound), \r\n    totalBlockedInbound = sum(BlockedInbound), \r\n    totalInboundMalicious = sum(iif(isMaliciousFlow, tolong(Inbound), 0)), \r\n    totalAllowedInboundMalicious = sum(iif(isMaliciousFlow, tolong(AllowedInbound), 0)), \r\n    totalBlockededInboundMalicious = sum(iif(isMaliciousFlow, tolong(BlockedInbound), 0)), \r\n    totalInbound = sum(Inbound),\r\n    TotalFlow = sum(FlowCount),\r\n    //\r\n    totalAllowedInboundBytes = sum(AllowedInboundBytesAtDest), \r\n    totalBlockedInboundBytes = sum(BlockedInboundBytesAtDest), \r\n    totalInboundMaliciousBytes = sum(iif(isMaliciousFlow, tolong(InboundBytesAtDest), 0)), \r\n    totalAllowedInboundMaliciousBytes = sum(iif(isMaliciousFlow, tolong(AllowedInboundBytesAtDest), 0)), \r\n    totalBlockededInboundMaliciousBytes = sum(iif(isMaliciousFlow, tolong(BlockedInboundBytesAtDest), 0)), \r\n    totalAllowedOutboundBytes = sum(AllowedOutboundBytesAtDest), \r\n    totalBlockedOutboundBytes = sum(BlockedOutboundBytesAtDest), \r\n    totalOutboundMaliciousBytes = sum(iif(isMaliciousFlow, tolong(OutboundBytesAtDest), 0)), \r\n    totalAllowedOutboundMaliciousBytes = sum(iif(isMaliciousFlow, tolong(AllowedOutboundBytesAtDest), 0)), \r\n    totalBlockededOutboundMaliciousBytes = sum(iif(isMaliciousFlow, tolong(BlockedOutboundBytesAtDest), 0)), \r\n    totalInboundBytesAtDest = sum(InboundBytesAtDest), \r\n    totalOutboundBytesAtDest = sum(OutboundBytesAtDest),\r\n    TotalBytes = sum(BytesCount),\r\n    //\r\n    totalAllowedInboundPackets = sum(AllowedInboundPacketsAtDest), \r\n    totalBlockedInboundPackets = sum(BlockedInboundPacketsAtDest), \r\n    totalInboundMaliciousPackets = sum(iif(isMaliciousFlow, tolong(InboundPacketsAtDest), 0)), \r\n    totalAllowedInboundMaliciousPackets = sum(iif(isMaliciousFlow, tolong(AllowedInboundPacketsAtDest), 0)), \r\n    totalBlockededInboundMaliciousPackets = sum(iif(isMaliciousFlow, tolong(BlockedInboundPacketsAtDest), 0)), \r\n    totalAllowedOutboundPackets = sum(AllowedOutboundPacketsAtDest), \r\n    totalBlockedOutboundPackets = sum(BlockedOutboundPacketsAtDest), \r\n    totalOutboundMaliciousPackets = sum(iif(isMaliciousFlow, tolong(OutboundPacketsAtDest), 0)), \r\n    totalAllowedOutboundMaliciousPackets = sum(iif(isMaliciousFlow, tolong(AllowedOutboundPacketsAtDest), 0)), \r\n    totalBlockededOutboundMaliciousPackets = sum(iif(isMaliciousFlow, tolong(BlockedOutboundPacketsAtDest), 0)), \r\n    totalInboundPackets = sum(InboundPacketsAtDest), \r\n    totalOutboundPackets = sum(OutboundPacketsAtDest),\r\n    TotalPackets = sum(PacketsCount)\r\n    //\r\n    by L7Protocol, DestPort\r\n    | extend TotalTraffic = iff('{Units:value}' =~ 'bytes', TotalBytes, iff('{Units:value}' =~ 'packets', TotalPackets, tolong(TotalFlow)))\r\n    | where TotalTraffic > 0\r\n    | project L7Protocol, DestPort, protocolInfo = strcat(L7Protocol, '#', toint(DestPort)), trafficForSorting = TotalTraffic,\r\n    totalInbound = iff('{Units:value}' =~ 'bytes', strcat('Egress : ', format_bytes(totalOutboundBytesAtDest, 3), ' Ingress : ', format_bytes(totalInboundBytesAtDest, 3)), iff('{Units:value}' =~ 'packets', strcat('Egress : ', ValueWithUnit(totalOutboundPackets, 3), ' Ingress : ', ValueWithUnit(totalInboundPackets, 3)), ValueWithUnit(totalInbound, 3))),\r\n    allowedInbound = iff('{Units:value}' =~ 'bytes', strcat('Egress : ', format_bytes(totalAllowedOutboundBytes, 3), ' Ingress : ', format_bytes(totalAllowedInboundBytes, 3)), iff('{Units:value}' =~ 'packets', strcat('Egress : ', ValueWithUnit(totalAllowedOutboundPackets, 3), ' Ingress : ', ValueWithUnit(totalAllowedInboundPackets, 3)), ValueWithUnit(totalAllowedInbound, 3))),\r\n    blockedInbound = iff('{Units:value}' =~ 'bytes', strcat('Egress : ', format_bytes(totalBlockedOutboundBytes, 3), ' Ingress : ', format_bytes(totalBlockedInboundBytes, 3)), iff('{Units:value}' =~ 'packets', strcat('Egress : ', ValueWithUnit(totalBlockedOutboundPackets, 3), ' Ingress : ', ValueWithUnit(totalBlockedInboundPackets, 3)), ValueWithUnit(totalBlockedInbound, 3))),\r\n    totalMalicious = iff('{Units:value}' =~ 'bytes', strcat('Egress : ', format_bytes(totalOutboundMaliciousBytes, 3), ' Ingress : ', format_bytes(totalInboundMaliciousBytes, 3)), iff('{Units:value}' =~ 'packets', strcat('Egress : ', ValueWithUnit(totalOutboundMaliciousPackets, 3), ' Ingress : ', ValueWithUnit(totalInboundMaliciousPackets, 3)), ValueWithUnit(totalInboundMalicious, 3))),\r\n    allowedMalicious = iff('{Units:value}' =~ 'bytes', strcat('Egress : ', format_bytes(totalAllowedOutboundMaliciousBytes, 3), ' Ingress : ', format_bytes(totalAllowedInboundMaliciousBytes, 3)), iff('{Units:value}' =~ 'packets', strcat('Egress : ', ValueWithUnit(totalAllowedOutboundMaliciousPackets, 3), ' Ingress : ', ValueWithUnit(totalAllowedInboundMaliciousPackets, 3)), ValueWithUnit(totalAllowedInboundMalicious, 3))),\r\n    blockedMalicious = iff('{Units:value}' =~ 'bytes', strcat('Egress : ', format_bytes(totalBlockededOutboundMaliciousBytes, 3), ' Ingress : ', format_bytes(totalBlockededInboundMaliciousBytes, 3)), iff('{Units:value}' =~ 'packets', strcat('Egress : ', ValueWithUnit(totalBlockededOutboundMaliciousPackets, 3), ' Ingress : ', ValueWithUnit(totalBlockededInboundMaliciousPackets, 3)), ValueWithUnit(totalBlockededInboundMalicious, 3)));\r\nlet topTalking = \r\n    NTANetAnalytics\r\n    | where SubType == 'FlowLog' and FaSchemaVersion == '3'\r\n    // filter begins\r\n    | where TimeGenerated between (todatetime('{timeInterval:startISO}') .. datetime_add('day', 7, todatetime('{timeInterval:endISO}'))) and FlowStartTime between (datetime('{timeInterval:startISO}') .. datetime('{timeInterval:endISO}'))\r\n    | where iff(\"{subscriptions}\" == \"'*'\", true, (SrcSubscription in~ ({subscriptions}) or DestSubscription in~ ({subscriptions})))\r\n    | extend Subnet1Split = split(SrcSubnet, '/'), Subnet2Split = split(DestSubnet, '/')\r\n    | extend rg1ToCheck = Subnet1Split[0], rg2ToCheck = Subnet2Split[0]\r\n    | where iff(\"{resourceGroups}\" == \"'*'\", true, (rg1ToCheck in~ ({resourceGroups}) or rg2ToCheck in~ ({resourceGroups})))\r\n    | extend vnet1ToCheck = Subnet1Split[1], vnet2ToCheck = Subnet2Split[1]\r\n    | extend portToCheck = DestPort\r\n    {portRangeCheckLine}\r\n    // filter ends\r\n    | extend protocolInfo = strcat(L7Protocol, '#', toint(DestPort))\r\n    | where isnotempty(DestVm)\r\n    | extend CountryOrRegion = iif(FlowType == 'AzurePublic', AzureRegion, Country)\r\n    | extend AllowedInboundBytesAtSrc = iff(FlowStatus == 'Allowed' and FlowDirection == 'Outbound', tolong(BytesDestToSrc), 0), BlockedInboundBytesAtSrc = iff(FlowStatus == 'Denied' and FlowDirection == 'Outbound', tolong(BytesDestToSrc), 0), AllowedOutboundBytesAtSrc = iff(FlowStatus == 'Allowed' and FlowDirection == 'Outbound', tolong(BytesSrcToDest), 0), BlockedOutboundBytesAtSrc = iff(FlowStatus == 'Denied' and FlowDirection == 'Outbound', tolong(BytesSrcToDest), 0), AllowedInboundBytesAtDest = iff(FlowStatus == 'Allowed' and FlowDirection == 'Inbound', tolong(BytesDestToSrc), 0), BlockedInboundBytesAtDest = iff(FlowStatus == 'Denied' and FlowDirection == 'Inbound', tolong(BytesDestToSrc), 0), AllowedOutboundBytesAtDest = iff(FlowStatus == 'Allowed' and FlowDirection == 'Inbound', tolong(BytesSrcToDest), 0), BlockedOutboundBytesAtDest = iff(FlowStatus == 'Denied' and FlowDirection == 'Inbound', tolong(BytesSrcToDest), 0)\r\n    | extend FlowDirection = iif(FlowType in ('InterVNet', 'IntraVNet'), '', FlowDirection)\r\n    | extend AllowedInboundPacketsAtSrc = iff(FlowStatus == 'Allowed' and FlowDirection == 'Outbound', tolong(PacketsDestToSrc), 0), BlockedInboundPacketsAtSrc = iff(FlowStatus == 'Denied' and FlowDirection == 'Outbound', tolong(PacketsDestToSrc), 0), AllowedOutboundPacketsAtSrc = iff(FlowStatus == 'Allowed' and FlowDirection == 'Outbound', tolong(PacketsSrcToDest), 0), BlockedOutboundPacketsAtSrc = iff(FlowStatus == 'Denied' and FlowDirection == 'Outbound', tolong(PacketsSrcToDest), 0), AllowedInboundPacketsAtDest = iff(FlowStatus == 'Allowed' and FlowDirection == 'Inbound', tolong(PacketsDestToSrc), 0), BlockedInboundPacketsAtDest = iff(FlowStatus == 'Denied' and FlowDirection == 'Inbound', tolong(PacketsDestToSrc), 0), AllowedOutboundPacketsAtDest = iff(FlowStatus == 'Allowed' and FlowDirection == 'Inbound', tolong(PacketsSrcToDest), 0), BlockedOutboundPacketsAtDest = iff(FlowStatus == 'Denied' and FlowDirection == 'Inbound', tolong(PacketsSrcToDest), 0)\r\n    | summarize \r\n    AllowedInbound = sum(AllowedInFlows), BlockedInbound = sum(DeniedInFlows), \r\n    AllowedOutbound = sum(AllowedOutFlows), BlockedOutbound = sum(DeniedOutFlows),\r\n    AllowedInboundBytesAtSrc = sum(AllowedInboundBytesAtSrc), BlockedInboundBytesAtSrc = sum(BlockedInboundBytesAtSrc), AllowedOutboundBytesAtSrc = sum(AllowedOutboundBytesAtSrc), BlockedOutboundBytesAtSrc = sum(BlockedOutboundBytesAtSrc), AllowedInboundBytesAtDest = sum(AllowedInboundBytesAtDest), BlockedInboundBytesAtDest = sum(BlockedInboundBytesAtDest), AllowedOutboundBytesAtDest = sum(AllowedOutboundBytesAtDest), BlockedOutboundBytesAtDest = sum(BlockedOutboundBytesAtDest),\r\n    AllowedInboundPacketsAtSrc = sum(AllowedInboundPacketsAtSrc), BlockedInboundPacketsAtSrc = sum(BlockedInboundPacketsAtSrc), AllowedOutboundPacketsAtSrc = sum(AllowedOutboundPacketsAtSrc), BlockedOutboundPacketsAtSrc = sum(BlockedOutboundPacketsAtSrc), AllowedInboundPacketsAtDest = sum(AllowedInboundPacketsAtDest), BlockedInboundPacketsAtDest = sum(BlockedInboundPacketsAtDest), AllowedOutboundPacketsAtDest = sum(AllowedOutboundPacketsAtDest), BlockedOutboundPacketsAtDest = sum(BlockedOutboundPacketsAtDest)\r\n    by SrcIp, SrcSubscription, SrcNic, DestIp, DestSubscription, DestNic, FlowDirection, L4Protocol, DestPort, CountryOrRegion, DestVm, protocolInfo\r\n    | extend AllowedOutbound_inferred = max_of(AllowedOutbound, AllowedInbound + BlockedInbound)\r\n    | extend Outbound = AllowedOutbound_inferred + BlockedOutbound, Inbound = AllowedOutbound_inferred\r\n    | extend FlowCount = max_of(Inbound, Outbound)\r\n    | extend AllowedOutboundBytesAtSrc_inferred = max_of(AllowedOutboundBytesAtSrc, AllowedInboundBytesAtDest + BlockedInboundBytesAtDest)\r\n    | extend AllowedOutboundBytesAtDest_inferred = max_of(AllowedOutboundBytesAtDest, AllowedInboundBytesAtSrc + BlockedInboundBytesAtSrc)\r\n    | extend OutboundBytesAtSrc = AllowedOutboundBytesAtSrc_inferred + BlockedOutboundBytesAtSrc, InboundBytesAtSrc = AllowedOutboundBytesAtDest_inferred\r\n    | extend OutboundBytesAtDest = AllowedOutboundBytesAtDest_inferred + BlockedOutboundBytesAtDest, InboundBytesAtDest = AllowedOutboundBytesAtSrc_inferred\r\n    | extend BytesCount = max_of(OutboundBytesAtSrc, InboundBytesAtDest) + max_of(OutboundBytesAtDest, InboundBytesAtSrc)\r\n    | extend AllowedOutboundPacketsAtSrc_inferred = max_of(AllowedOutboundPacketsAtSrc, AllowedInboundPacketsAtDest + BlockedInboundPacketsAtDest)\r\n    | extend AllowedOutboundPacketsAtDest_inferred = max_of(AllowedOutboundPacketsAtDest, AllowedInboundPacketsAtSrc + BlockedInboundPacketsAtSrc)\r\n    | extend OutboundPacketsAtSrc = AllowedOutboundPacketsAtSrc_inferred + BlockedOutboundPacketsAtSrc, InboundPacketsAtSrc = AllowedOutboundPacketsAtDest_inferred\r\n    | extend OutboundPacketsAtDest = AllowedOutboundPacketsAtDest_inferred + BlockedOutboundPacketsAtDest, InboundPacketsAtDest = AllowedOutboundPacketsAtSrc_inferred\r\n    | extend PacketsCount = max_of(OutboundPacketsAtSrc, InboundPacketsAtDest) + max_of(OutboundPacketsAtDest, InboundPacketsAtSrc)\r\n    | summarize totalTraffic = sum(iff('{Units:value}' =~ 'bytes', BytesCount, iff('{Units:value}' =~ 'packets', PacketsCount, tolong(FlowCount)))) by host = strcat(DestSubscription, '#', DestVm, '#', DestIp), protocolInfo\r\n    | top-nested of protocolInfo by max(1), top-nested 3 of host by max(totalTraffic)\r\n    | summarize topTalkingPairs = strcat_array(make_list(strcat(split(host, '#')[2],' (',split(split(host, '#')[1], '/')[1],')')), ', ') by protocolInfo\r\n    | project protocolInfo, topTalkingPairs;\r\nlet topMalicious = \r\n    NTANetAnalytics\r\n    | where SubType == 'FlowLog' and FaSchemaVersion == '3'\r\n    // filter begins\r\n    | where TimeGenerated between (todatetime('{timeInterval:startISO}') .. datetime_add('day', 7, todatetime('{timeInterval:endISO}'))) and FlowStartTime between (datetime('{timeInterval:startISO}') .. datetime('{timeInterval:endISO}'))\r\n    | where iff(\"{subscriptions}\" == \"'*'\", true, (SrcSubscription in~ ({subscriptions}) or DestSubscription in~ ({subscriptions})))\r\n    | extend Subnet1Split = split(SrcSubnet, '/'), Subnet2Split = split(DestSubnet, '/')\r\n    | extend rg1ToCheck = Subnet1Split[0], rg2ToCheck = Subnet2Split[0]\r\n    | where iff(\"{resourceGroups}\" == \"'*'\", true, (rg1ToCheck in~ ({resourceGroups}) or rg2ToCheck in~ ({resourceGroups})))\r\n    | extend vnet1ToCheck = Subnet1Split[1], vnet2ToCheck = Subnet2Split[1]\r\n    | extend portToCheck = DestPort\r\n    {portRangeCheckLine}\r\n    // filter ends\r\n    | extend protocolInfo = strcat(L7Protocol, '#', toint(DestPort))\r\n    | where FlowType == 'MaliciousFlow'\r\n    | extend MaliciousIp = iif(isnotempty(DestVm), SrcIp, DestIp)\r\n    | summarize totalMalicious = iff('{Units:value}' =~ 'bytes', sum(BytesDestToSrc + BytesSrcToDest), iff('{Units:value}' =~ 'packets', sum(PacketsDestToSrc + PacketsSrcToDest), sum(AllowedOutFlows + DeniedOutFlows + AllowedInFlows + DeniedInFlows)))\r\n    by MaliciousIp, Country, protocolInfo\r\n    | top-nested of protocolInfo by max(1), top-nested 3 of partnerInfo = strcat(MaliciousIp, '#', Country) by max(totalMalicious)\r\n    | project protocolInfo, partnerInfo\r\n    | summarize topMaliciousPairs = strcat_array(make_list(strcat(split(partnerInfo, '#')[0],' (',split(partnerInfo, '#')[1],')')), ',') by protocolInfo\r\n    | project protocolInfo, topMaliciousPairs;\r\ncommon\r\n| join kind=leftouter topTalking on $left.protocolInfo == $right.protocolInfo\r\n| join kind=leftouter topMalicious on $left.protocolInfo == $right.protocolInfo\r\n| sort by trafficForSorting desc\r\n| project L7Protocol, DestPort, topTalkingPairs, topMaliciousPairs, totalInbound, allowedInbound, blockedInbound, totalMalicious, allowedMalicious, blockedMalicious",
                    "size": 0,
                    "aggregation": 2,
                    "showAnnotations": true,
                    "showAnalytics": true,
                    "noDataMessage": "No data to display",
                    "timeContextFromParameter": "timeInterval",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{workspace}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "aggregatedTotalFlow",
                          "formatter": 19,
                          "formatOptions": {
                            "palette": "orange",
                            "timelineSettings": {
                              "timelineStartColumn": "Time"
                            }
                          }
                        }
                      ]
                    }
                  },
                  "conditionalVisibility": {
                    "parameterName": "FlowType",
                    "comparison": "isEqualTo",
                    "value": "vnet"
                  },
                  "name": "ProtocolsVNet"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"20ede9a2-f003-444a-bae0-cf78aa242209\",\"mergeType\":\"union\",\"leftTable\":\"ProtocolsNSG\",\"rightTable\":\"ProtocolsVNet\"}],\"projectRename\":[{\"originalName\":\"[ProtocolsNSG].L7Protocol\",\"mergedName\":\"L7Protocol\",\"fromId\":\"20ede9a2-f003-444a-bae0-cf78aa242209\"},{\"originalName\":\"[ProtocolsNSG].DestPort\",\"mergedName\":\"DestPort\",\"fromId\":\"20ede9a2-f003-444a-bae0-cf78aa242209\"},{\"originalName\":\"[ProtocolsNSG].topTalkingPairs\",\"mergedName\":\"topTalkingPairs\",\"fromId\":\"20ede9a2-f003-444a-bae0-cf78aa242209\"},{\"originalName\":\"[ProtocolsNSG].topMaliciousPairs\",\"mergedName\":\"topMaliciousPairs\",\"fromId\":\"20ede9a2-f003-444a-bae0-cf78aa242209\"},{\"originalName\":\"[ProtocolsNSG].totalInbound\",\"mergedName\":\"totalInbound\",\"fromId\":\"20ede9a2-f003-444a-bae0-cf78aa242209\"},{\"originalName\":\"[ProtocolsNSG].allowedInbound\",\"mergedName\":\"allowedInbound\",\"fromId\":\"20ede9a2-f003-444a-bae0-cf78aa242209\"},{\"originalName\":\"[ProtocolsNSG].blockedInbound\",\"mergedName\":\"blockedInbound\",\"fromId\":\"20ede9a2-f003-444a-bae0-cf78aa242209\"},{\"originalName\":\"[ProtocolsNSG].totalMalicious\",\"mergedName\":\"totalMalicious\",\"fromId\":\"20ede9a2-f003-444a-bae0-cf78aa242209\"},{\"originalName\":\"[ProtocolsNSG].allowedMalicious\",\"mergedName\":\"allowedMalicious\",\"fromId\":\"20ede9a2-f003-444a-bae0-cf78aa242209\"},{\"originalName\":\"[ProtocolsNSG].blockedMalicious\",\"mergedName\":\"blockedMalicious\",\"fromId\":\"20ede9a2-f003-444a-bae0-cf78aa242209\"},{\"originalName\":\"L7Protocol\",\"mergedName\":\"L7Protocol\",\"fromId\":\"unknown\"},{\"originalName\":\"DestPort\",\"mergedName\":\"DestPort\",\"fromId\":\"unknown\"},{\"originalName\":\"topTalkingPairs\",\"mergedName\":\"topTalkingPairs\",\"fromId\":\"unknown\"},{\"originalName\":\"topMaliciousPairs\",\"mergedName\":\"topMaliciousPairs\",\"fromId\":\"unknown\"},{\"originalName\":\"totalInbound\",\"mergedName\":\"totalInbound\",\"fromId\":\"unknown\"},{\"originalName\":\"allowedInbound\",\"mergedName\":\"allowedInbound\",\"fromId\":\"unknown\"},{\"originalName\":\"blockedInbound\",\"mergedName\":\"blockedInbound\",\"fromId\":\"unknown\"},{\"originalName\":\"totalMalicious\",\"mergedName\":\"totalMalicious\",\"fromId\":\"unknown\"},{\"originalName\":\"allowedMalicious\",\"mergedName\":\"allowedMalicious\",\"fromId\":\"unknown\"},{\"originalName\":\"blockedMalicious\",\"mergedName\":\"blockedMalicious\",\"fromId\":\"unknown\"}]}",
                    "size": 0,
                    "queryType": 7
                  },
                  "conditionalVisibility": {
                    "parameterName": "FlowType",
                    "comparison": "isEqualTo",
                    "value": "both"
                  },
                  "showPin": false,
                  "name": "query - 4"
                }
              ]
            },
            "name": "ApplicationPortsGrid"
          }
        ],
        "exportParameters": true
      },
      "name": "group - 5"
    }
  ],
  "fallbackResourceIds": [
    "azure monitor"
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
