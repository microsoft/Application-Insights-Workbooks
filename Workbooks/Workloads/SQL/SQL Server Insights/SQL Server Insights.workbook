{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "crossComponentResources": [
          "{MonitoringProfileSub}"
        ],
        "parameters": [
          {
            "id": "af2af70b-7ea5-40a0-be60-2d87c0d17ed8",
            "version": "KqlParameterItem/1.0",
            "name": "MonitoringProfileSub",
            "label": "Subscription",
            "type": 6,
            "isRequired": true,
            "query": "Resources\n| summarize Count = countif(type =~ 'Microsoft.Insights/dataCollectionRules' and tags contains 'SqlInsights') by subscriptionId\n| order by Count desc\n| extend Row = row_number()\n| project value = subscriptionId, label = subscriptionId, selected = Row == 1",
            "crossComponentResources": [
              "value::all"
            ],
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "de2c48ff-8e1b-411d-8153-d6a97797336b",
            "version": "KqlParameterItem/1.0",
            "name": "MonitoringProfile",
            "label": "Monitoring profile",
            "type": 5,
            "isRequired": true,
            "query": "Resources\n| where type =~ 'Microsoft.Insights/dataCollectionRules' and tags contains 'SqlInsights'\n| order by resourceGroup asc, tolower(name) asc\n| extend Row = row_number()\n//| project value = id, label = id, selected = Row == 1, group = resourceGroup",
            "crossComponentResources": [
              "{MonitoringProfileSub}"
            ],
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "value": null
          },
          {
            "id": "0cebb139-7c97-434a-b077-07704c77c295",
            "version": "KqlParameterItem/1.0",
            "name": "Associations",
            "type": 2,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"{MonitoringProfile}/associations?api-version=2019-11-01-preview\",\"urlParams\":[],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.value\",\"columns\":[{\"path\":\"id\",\"columnid\":\"Id\"}]}}]}",
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "defaultValue": "value::all",
            "queryType": 12,
            "value": [
              "value::all"
            ]
          },
          {
            "id": "0a9b1be7-5981-4d35-9b5e-fd7c7f9e80ef",
            "version": "KqlParameterItem/1.0",
            "name": "Workspaces",
            "type": 5,
            "isRequired": true,
            "query": "Resources\n| where id =~ '{MonitoringProfile}'\n| project la = properties.destinations.logAnalytics\n| mvexpand la limit 400\n| project id = tostring (la.workspaceResourceId)\n| project value = id, label = id, selected = true",
            "crossComponentResources": [
              "{MonitoringProfileSub}"
            ],
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "0b697882-249b-4053-9807-9e654383d2a5",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "label": "Time range",
            "type": 4,
            "isRequired": true,
            "value": {
              "durationMs": 14400000
            },
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 900000
                },
                {
                  "durationMs": 1800000
                },
                {
                  "durationMs": 3600000
                },
                {
                  "durationMs": 14400000
                },
                {
                  "durationMs": 43200000
                },
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 172800000
                },
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 1209600000
                },
                {
                  "durationMs": 2592000000
                }
              ]
            }
          },
          {
            "id": "c7688036-0080-4174-94ae-51b64b5211d9",
            "version": "KqlParameterItem/1.0",
            "name": "OnboardedComputers",
            "type": 5,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "Resources\r\n| take 1\r\n| project associations = dynamic([{Associations}])\r\n| mvexpand associations limit 400\r\n| project id = tolower(extract(@'(?i)/subscriptions/.+/resourcegroups/.+/providers/microsoft.compute/virtualmachines/(.+)/providers/microsoft.insights/datacollectionruleassociations/.+', 1, tostring(associations)))\r\n| project value = id, label = id, selected = true\r\n\r\n",
            "crossComponentResources": [
              "{MonitoringProfileSub}"
            ],
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "4cc2a2af-8213-45d4-84bd-0728a196fdee",
            "version": "KqlParameterItem/1.0",
            "name": "CommonErrors",
            "type": 1,
            "isRequired": true,
            "value": "[\n  {\n    \"key\": \"login error\",\n    \"action\": \"SQL login error\",\n    \"description\": \"The SQL login credentials used by your monitoring VM appears to be incorrect. Please refer to [our documentation<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" viewBox=\\\"0 0 16 16\\\" height=\\\"12\\\" width=\\\"12\\\" style=\\\"margin: 0px 0px -2px 3px\\\">\\r\\n  <path d=\\\"M14.3,1.5H10V.5h6v6H15V2.2l-8,8-.7-.7Z\\\" />\\r\\n  <path d=\\\"M11,8.5v5a.9.9,0,0,1-.787,1,.948.948,0,0,1-.213,0H2a.9.9,0,0,1-1-.787A.948.948,0,0,1,1,13.5v-7a.9.9,0,0,1,.787-1A.948.948,0,0,1,2,5.5H8l1-1H2a2,2,0,0,0-2,2v7a2,2,0,0,0,2,2h8a2,2,0,0,0,2-2v-6Z\\\" />\\r\\n</svg>](https://aka.ms/azuresqlinsights/tsg/sqlloginerror) for creating the telegraf user, the permissions it needs, and setting the configuration on your monitoring VM. If using a Key Vault to store the password as a secret, please confirm it is using the correct value.\"\n  },\n  {\n    \"key\": \"Unable to open tcp connection with host\",\n    \"action\": \"Connection error\",\n    \"description\": \"Your monitoring VM does not appear to have access to the following SQL resource. Please refer to [our documentation<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" viewBox=\\\"0 0 16 16\\\" height=\\\"12\\\" width=\\\"12\\\" style=\\\"margin: 0px 0px -2px 3px\\\">\\r\\n  <path d=\\\"M14.3,1.5H10V.5h6v6H15V2.2l-8,8-.7-.7Z\\\" />\\r\\n  <path d=\\\"M11,8.5v5a.9.9,0,0,1-.787,1,.948.948,0,0,1-.213,0H2a.9.9,0,0,1-1-.787A.948.948,0,0,1,1,13.5v-7a.9.9,0,0,1,.787-1A.948.948,0,0,1,2,5.5H8l1-1H2a2,2,0,0,0-2,2v7a2,2,0,0,0,2,2h8a2,2,0,0,0,2-2v-6Z\\\" />\\r\\n</svg>](https://aka.ms/azuresqlinsights/tsg/connectionerror) for enabling network access for your monitoring VM to access your SQL resource.\"\n  },\n  {\n    \"key\": \"does not have secrets get permission on Key Vault\",\n    \"action\": \"Key Vault permission error\",\n    \"description\": \"The monitoring VM does not have get permission on the Key vault secret provided in your monitoring profile. To correct this, trigger 'Configure' for the monitoring VM, specifying the Key Vault resources needed. Please refer to [our documentation<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" viewBox=\\\"0 0 16 16\\\" height=\\\"12\\\" width=\\\"12\\\" style=\\\"margin: 0px 0px -2px 3px\\\">\\r\\n  <path d=\\\"M14.3,1.5H10V.5h6v6H15V2.2l-8,8-.7-.7Z\\\" />\\r\\n  <path d=\\\"M11,8.5v5a.9.9,0,0,1-.787,1,.948.948,0,0,1-.213,0H2a.9.9,0,0,1-1-.787A.948.948,0,0,1,1,13.5v-7a.9.9,0,0,1,.787-1A.948.948,0,0,1,2,5.5H8l1-1H2a2,2,0,0,0-2,2v7a2,2,0,0,0,2,2h8a2,2,0,0,0,2-2v-6Z\\\" />\\r\\n</svg>]( https://aka.ms/azuresqlinsights/tsg/kvpermission) for more details.\"\n  },\n  {\n    \"key\": \"SecretNotFound\",\n    \"action\": \"Key Vault secret error\",\n    \"description\": \"The name of the Key Vault secret provided in your monitoring profile appears to be incorrect. Please refer to [our documentation<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" viewBox=\\\"0 0 16 16\\\" height=\\\"12\\\" width=\\\"12\\\" style=\\\"margin: 0px 0px -2px 3px\\\">\\r\\n  <path d=\\\"M14.3,1.5H10V.5h6v6H15V2.2l-8,8-.7-.7Z\\\" />\\r\\n  <path d=\\\"M11,8.5v5a.9.9,0,0,1-.787,1,.948.948,0,0,1-.213,0H2a.9.9,0,0,1-1-.787A.948.948,0,0,1,1,13.5v-7a.9.9,0,0,1,.787-1A.948.948,0,0,1,2,5.5H8l1-1H2a2,2,0,0,0-2,2v7a2,2,0,0,0,2,2h8a2,2,0,0,0,2-2v-6Z\\\" />\\r\\n</svg>](https://aka.ms/azuresqlinsights/tsg/kvnosecret) for providing the Key Vault secret name and setting the configuration on your monitoring VM.\"\n  },\n  {\n    \"key\": \"disabled secret\",\n    \"action\": \"Key Vault disabled secret error\",\n    \"description\": \"The Key vault secret your are trying to access has been disabled.  To correct this, you can either re-enable the secret from your Key Vault or create a new one. If you create a new secret, you will need to update your monitoring profile to reference it. Please refer to [our documentation<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" viewBox=\\\"0 0 16 16\\\" height=\\\"12\\\" width=\\\"12\\\" style=\\\"margin: 0px 0px -2px 3px\\\">\\r\\n  <path d=\\\"M14.3,1.5H10V.5h6v6H15V2.2l-8,8-.7-.7Z\\\" />\\r\\n  <path d=\\\"M11,8.5v5a.9.9,0,0,1-.787,1,.948.948,0,0,1-.213,0H2a.9.9,0,0,1-1-.787A.948.948,0,0,1,1,13.5v-7a.9.9,0,0,1,.787-1A.948.948,0,0,1,2,5.5H8l1-1H2a2,2,0,0,0-2,2v7a2,2,0,0,0,2,2h8a2,2,0,0,0,2-2v-6Z\\\" />\\r\\n</svg>](https://aka.ms/azuresqlinsights/tsg/kvsecretdisabled) for more details.\"\n  },\n  {\n    \"key\": \"user does not have permission\",\n    \"action\": \"User does not have permission\",\n    \"description\": \"The user does not have permission to view the database state. To correct this, you need to grant VIEW DATABASE STATE permissions by running <code>GRANT VIEW DATABASE STATE TO [<username>];<//code>. Please refer to [our documentation<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" viewBox=\\\"0 0 16 16\\\" height=\\\"12\\\" width=\\\"12\\\" style=\\\"margin: 0px 0px -2px 3px\\\">\\r\\n  <path d=\\\"M14.3,1.5H10V.5h6v6H15V2.2l-8,8-.7-.7Z\\\" />\\r\\n  <path d=\\\"M11,8.5v5a.9.9,0,0,1-.787,1,.948.948,0,0,1-.213,0H2a.9.9,0,0,1-1-.787A.948.948,0,0,1,1,13.5v-7a.9.9,0,0,1,.787-1A.948.948,0,0,1,2,5.5H8l1-1H2a2,2,0,0,0-2,2v7a2,2,0,0,0,2,2h8a2,2,0,0,0,2-2v-6Z\\\" />\\r\\n</svg>](https://aka.ms/azuresqlinsights/tsg/userpermission)for more details.\"\n  },\n  {\n    \"key\": \"is not allowed to access the server\",\n    \"action\": \"Firewall is blocking access\",\n    \"description\": \"The SQL DB firewall is blocking access to the server.  To correct this, use the Windows Azure Management Portal or run sp_set_firewall_rule on the master database to create a firewall rule for this IP address or address range. It may take up to five minutes for this change to take effect. Please refer to [our documentation<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" viewBox=\\\"0 0 16 16\\\" height=\\\"12\\\" width=\\\"12\\\" style=\\\"margin: 0px 0px -2px 3px\\\">\\r\\n  <path d=\\\"M14.3,1.5H10V.5h6v6H15V2.2l-8,8-.7-.7Z\\\" />\\r\\n  <path d=\\\"M11,8.5v5a.9.9,0,0,1-.787,1,.948.948,0,0,1-.213,0H2a.9.9,0,0,1-1-.787A.948.948,0,0,1,1,13.5v-7a.9.9,0,0,1,.787-1A.948.948,0,0,1,2,5.5H8l1-1H2a2,2,0,0,0-2,2v7a2,2,0,0,0,2,2h8a2,2,0,0,0,2-2v-6Z\\\" />\\r\\n</svg>](https://aka.ms/azuresqlinsights/tsg/firewall) for more details.\"\n  },\n  {\n    \"key\": \"The server was not found or was not accessible\",\n    \"action\": \"Client machine is not in Virtual Network\",\n    \"description\": \"The server was not found or was not accessible. It is possible that the client machine is not in the Virtual network. Please refer to [our documentation<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" viewBox=\\\"0 0 16 16\\\" height=\\\"12\\\" width=\\\"12\\\" style=\\\"margin: 0px 0px -2px 3px\\\">\\r\\n  <path d=\\\"M14.3,1.5H10V.5h6v6H15V2.2l-8,8-.7-.7Z\\\" />\\r\\n  <path d=\\\"M11,8.5v5a.9.9,0,0,1-.787,1,.948.948,0,0,1-.213,0H2a.9.9,0,0,1-1-.787A.948.948,0,0,1,1,13.5v-7a.9.9,0,0,1,.787-1A.948.948,0,0,1,2,5.5H8l1-1H2a2,2,0,0,0-2,2v7a2,2,0,0,0,2,2h8a2,2,0,0,0,2-2v-6Z\\\" />\\r\\n</svg>](https://aka.ms/azuresqlinsights/tsg/virtualnetwork) for more details.\"\n  },\n\t{\n    \"key\": \"did not complete within its flush interval\",\n    \"action\": \"Data cannot be flushed within flush interval\",\n    \"description\": \"Data collected by Telegraf could not be flushed to Azure Monitor agent within the flush interval of 10 seconds. This does not mean any data is lost and no action is needed.\"\n  },\n\t{\n\t\t\"key\": \"Failed to get Key Vault secret for Key Vault: https://mykeyvault.vault.azure.net/\",\n\t\t\"action\": \"Using default Key Vault path\",\n\t\t\"description\": \"One or more of your connection strings for this monitoring VM is referencing a Key Vault secret.  The URL you are using as the path to the Key Vault has our default url of 'https://mykeyvault.vault.azure.net'.  You can either update your connection string to include the password and not reference a Key Vault or use the recommended setup of storing the secret in a Key Vault.  If using a Key Vault, please update the monitoring VM configuration with the correct URL for your Key Vault(s).\"\n\t}\n]",
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "multiLineText": true,
              "editorLanguage": "json",
              "multiLineHeight": 10
            }
          },
          {
            "id": "26db4e3e-bd1c-4242-8a88-52550bf4e2f5",
            "version": "KqlParameterItem/1.0",
            "name": "AlertTemplates",
            "type": 1,
            "value": "[\r\n    {\r\n        \"name\": \"Azure MI and SQL Server Log file utilization\",\r\n        \"description\": \"Fired when Azure MI and SQL Server Log file utilization percentage exceeds the specified threshold. Looks at the 95th percentile value over 5 minutes, and if it exceeds the threshold over 3 consecutive time periods the alert is triggered. For more details on alert rule templates, refer to [this document<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" viewBox=\\\"0 0 16 16\\\" height=\\\"12\\\" width=\\\"12\\\" style=\\\"margin: 0px 0px -2px 3px\\\">\\r\\n  <path d=\\\"M14.3,1.5H10V.5h6v6H15V2.2l-8,8-.7-.7Z\\\" />\\r\\n  <path d=\\\"M11,8.5v5a.9.9,0,0,1-.787,1,.948.948,0,0,1-.213,0H2a.9.9,0,0,1-1-.787A.948.948,0,0,1,1,13.5v-7a.9.9,0,0,1,.787-1A.948.948,0,0,1,2,5.5H8l1-1H2a2,2,0,0,0-2,2v7a2,2,0,0,0,2,2h8a2,2,0,0,0,2-2v-6Z\\\" />\\r\\n</svg>](https://aka.ms/azuresqlinsights/docs/alertruletemplates).\",\r\n        \"author\": \"Microsoft\",\r\n        \"uniqueTag\": \"sql-log-file-utilization\",\r\n        \"recommendationLevel\": 2,\r\n\t\t\"severity\": \"2\",\r\n        \"applyTo\": [],\r\n        \"alertTemplate\": {\r\n            \"type\": \"log-metric-measurement\",\r\n            \"query\": \"InsightsMetrics | where Namespace =~ 'sqlserver_performance' | extend Tags = todynamic(Tags) | where tostring(Tags.['azm.ms/dcrId']) == '{DcrId}' | extend Counter = tostring(Tags.counter), Database = tostring(Tags.database_name), Instance = tostring(Tags.sql_instance), Object = tostring(Tags.object), Database_Type = tostring(Tags.measurement_db_type) | where Database_Type != 'AzureSQLDB' and Counter == 'Percent Log Used' | summarize AggregatedValue = percentile(Val,95) by bin(TimeGenerated, 5m), tostring(Instance), tostring(Database) //| where AggregatedValue > {AlertThreshold}\",\r\n            \"thresholdOperator\": \"GreaterThan\",\r\n            \"defaultThreshold\": \"90\",\r\n            \"alertUnit\": \"percent\",\r\n            \"metricMeasurement\": {\r\n                \"thresholdOperator\": \"GreaterThan\",\r\n                \"threshold\": \"3\",\r\n                \"metricTriggerType\": \"Consecutive\",\r\n                \"metricColumn\": \"Instance,Database\"\r\n            }\r\n        }\r\n    },\r\n    {\r\n        \"name\": \"Azure DB and Azure MI CPU utilization percent\",\r\n        \"description\": \"Fired when Azure DB or Azure MI CPU utilization percentage from your service tier exceeds the specified threshold.  Looks at the 95th percentile value over 5 minutes, and if it exceeds the threshold over 3 consecutive time periods the alert is triggered.  For more details on alert rule templates, refer to [this document<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" viewBox=\\\"0 0 16 16\\\" height=\\\"12\\\" width=\\\"12\\\" style=\\\"margin: 0px 0px -2px 3px\\\">\\r\\n  <path d=\\\"M14.3,1.5H10V.5h6v6H15V2.2l-8,8-.7-.7Z\\\" />\\r\\n  <path d=\\\"M11,8.5v5a.9.9,0,0,1-.787,1,.948.948,0,0,1-.213,0H2a.9.9,0,0,1-1-.787A.948.948,0,0,1,1,13.5v-7a.9.9,0,0,1,.787-1A.948.948,0,0,1,2,5.5H8l1-1H2a2,2,0,0,0-2,2v7a2,2,0,0,0,2,2h8a2,2,0,0,0,2-2v-6Z\\\" />\\r\\n</svg>](https://aka.ms/azuresqlinsights/docs/alertruletemplates).\",\r\n        \"author\": \"Microsoft\",\r\n        \"uniqueTag\": \"sql-cpu-utilization-percent\",\r\n        \"recommendationLevel\": 2,\r\n\t\t\"severity\": \"2\",\r\n        \"applyTo\": [],\r\n        \"alertTemplate\": {\r\n            \"type\": \"log-metric-measurement\",\r\n            \"query\": \"InsightsMetrics | where Namespace == 'sqlserver_azure_db_resource_stats' and Name == 'avg_cpu_percent' | extend Tags = todynamic(Tags) | where tostring(Tags.['azm.ms/dcrId']) == '{DcrId}' | extend Instance = Tags.sql_instance, Database = Tags.database_name | summarize AggregatedValue = percentile(Val,95) by bin(TimeGenerated, 5m), tostring(Instance), tostring(Database) //| where AggregatedValue > {AlertThreshold}\",\r\n            \"thresholdOperator\": \"GreaterThan\",\r\n            \"defaultThreshold\": \"90\",\r\n            \"alertUnit\": \"percent\",\r\n            \"metricMeasurement\": {\r\n                \"thresholdOperator\": \"GreaterThan\",\r\n                \"threshold\": \"3\",\r\n                \"metricTriggerType\": \"Consecutive\",\r\n                \"metricColumn\": \"Instance,Database\"\r\n            }\r\n        }\r\n    },\r\n    {\r\n        \"name\": \"Azure DB Instance CPU utilization percent\",\r\n        \"description\": \"Fired when Azure DB Instance CPU utilization percentage from your service tier exceeds the specified threshold.  Looks at the 95th percentile value over 5 minutes, and if it exceeds the threshold over 3 consecutive time periods the alert is triggered.  For more details on alert rule templates, refer to [this document<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" viewBox=\\\"0 0 16 16\\\" height=\\\"12\\\" width=\\\"12\\\" style=\\\"margin: 0px 0px -2px 3px\\\">\\r\\n  <path d=\\\"M14.3,1.5H10V.5h6v6H15V2.2l-8,8-.7-.7Z\\\" />\\r\\n  <path d=\\\"M11,8.5v5a.9.9,0,0,1-.787,1,.948.948,0,0,1-.213,0H2a.9.9,0,0,1-1-.787A.948.948,0,0,1,1,13.5v-7a.9.9,0,0,1,.787-1A.948.948,0,0,1,2,5.5H8l1-1H2a2,2,0,0,0-2,2v7a2,2,0,0,0,2,2h8a2,2,0,0,0,2-2v-6Z\\\" />\\r\\n</svg>](https://aka.ms/azuresqlinsights/docs/alertruletemplates).\",\r\n        \"author\": \"Microsoft\",\r\n        \"uniqueTag\": \"sql-instance-cpu-utilization-percent\",\r\n        \"recommendationLevel\": 2,\r\n\t\t\"severity\": \"2\",\r\n        \"applyTo\": [],\r\n        \"alertTemplate\": {\r\n            \"type\": \"log-metric-measurement\",\r\n            \"query\": \"InsightsMetrics | where Namespace == 'sqlserver_azure_db_resource_stats' and Name == 'avg_instance_cpu_percent' | extend Tags = todynamic(Tags) | where tostring(Tags.['azm.ms/dcrId']) == '{DcrId}' | extend Instance = Tags.sql_instance, Database = Tags.database_name | summarize AggregatedValue = percentile(Val,95) by bin(TimeGenerated, 5m), tostring(Instance), tostring(Database) //| where AggregatedValue > {AlertThreshold}\",\r\n            \"thresholdOperator\": \"GreaterThan\",\r\n            \"defaultThreshold\": \"90\",\r\n            \"alertUnit\": \"percent\",\r\n            \"metricMeasurement\": {\r\n                \"thresholdOperator\": \"GreaterThan\",\r\n                \"threshold\": \"3\",\r\n                \"metricTriggerType\": \"Consecutive\",\r\n                \"metricColumn\": \"Instance,Database\"\r\n            }\r\n        }\r\n    },\r\n    {\r\n        \"name\": \"Azure DB Data IO utilization\",\r\n        \"description\": \"Fired when Azure DB Data IO utilization percentage exceeds the specified threshold. Looks at the 95th percentile value over 5 minutes, and if it exceeds the threshold over 3 consecutive time periods the alert is triggered. For more details on alert rule templates, refer to [this document<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" viewBox=\\\"0 0 16 16\\\" height=\\\"12\\\" width=\\\"12\\\" style=\\\"margin: 0px 0px -2px 3px\\\">\\r\\n  <path d=\\\"M14.3,1.5H10V.5h6v6H15V2.2l-8,8-.7-.7Z\\\" />\\r\\n  <path d=\\\"M11,8.5v5a.9.9,0,0,1-.787,1,.948.948,0,0,1-.213,0H2a.9.9,0,0,1-1-.787A.948.948,0,0,1,1,13.5v-7a.9.9,0,0,1,.787-1A.948.948,0,0,1,2,5.5H8l1-1H2a2,2,0,0,0-2,2v7a2,2,0,0,0,2,2h8a2,2,0,0,0,2-2v-6Z\\\" />\\r\\n</svg>](https://aka.ms/azuresqlinsights/docs/alertruletemplates).\",\r\n        \"author\": \"Microsoft\",\r\n        \"uniqueTag\": \"sql-data-io-utilization\",\r\n        \"recommendationLevel\": 4,\r\n\t\t\"severity\": \"4\",\r\n        \"applyTo\": [],\r\n        \"alertTemplate\": {\r\n            \"type\": \"log-metric-measurement\",\r\n            \"query\": \"InsightsMetrics | where Namespace == 'sqlserver_azure_db_resource_stats' and Name == 'avg_data_io_percent' | extend Tags = todynamic(Tags) | where tostring(Tags.['azm.ms/dcrId']) == '{DcrId}' | extend Instance = Tags.sql_instance, Database = Tags.database_name | summarize AggregatedValue = percentile(Val,95) by bin(TimeGenerated, 5m), tostring(Instance), tostring(Database) //| where AggregatedValue > {AlertThreshold}\",\r\n            \"thresholdOperator\": \"GreaterThan\",\r\n            \"defaultThreshold\": \"95\",\r\n            \"alertUnit\": \"percent\",\r\n            \"metricMeasurement\": {\r\n                \"thresholdOperator\": \"GreaterThan\",\r\n                \"threshold\": \"3\",\r\n                \"metricTriggerType\": \"Consecutive\",\r\n                \"metricColumn\": \"Instance,Database\"\r\n            }\r\n        }\r\n    },\r\n    {\r\n        \"name\": \"Azure DB Log write utilization\",\r\n        \"description\": \"Fired when Azure DB Log write utilization percentage exceeds the specified threshold. Looks at the 95th percentile value over 5 minutes, and if it exceeds the threshold over 3 consecutive time periods the alert is triggered. For more details on alert rule templates, refer to [this document<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" viewBox=\\\"0 0 16 16\\\" height=\\\"12\\\" width=\\\"12\\\" style=\\\"margin: 0px 0px -2px 3px\\\">\\r\\n  <path d=\\\"M14.3,1.5H10V.5h6v6H15V2.2l-8,8-.7-.7Z\\\" />\\r\\n  <path d=\\\"M11,8.5v5a.9.9,0,0,1-.787,1,.948.948,0,0,1-.213,0H2a.9.9,0,0,1-1-.787A.948.948,0,0,1,1,13.5v-7a.9.9,0,0,1,.787-1A.948.948,0,0,1,2,5.5H8l1-1H2a2,2,0,0,0-2,2v7a2,2,0,0,0,2,2h8a2,2,0,0,0,2-2v-6Z\\\" />\\r\\n</svg>](https://aka.ms/azuresqlinsights/docs/alertruletemplates).\",\r\n        \"author\": \"Microsoft\",\r\n        \"uniqueTag\": \"sql-log-write-utilization\",\r\n        \"recommendationLevel\": 4,\r\n\t\t\"severity\": \"4\",\r\n        \"applyTo\": [],\r\n        \"alertTemplate\": {\r\n            \"type\": \"log-metric-measurement\",\r\n            \"query\": \"InsightsMetrics | where Namespace == 'sqlserver_azure_db_resource_stats' and Name == 'avg_log_write_percent' | extend Tags = todynamic(Tags) | where tostring(Tags.['azm.ms/dcrId']) == '{DcrId}' | extend Instance = Tags.sql_instance, Database = Tags.database_name | summarize AggregatedValue = percentile(Val,95) by bin(TimeGenerated, 5m), tostring(Instance), tostring(Database) //| where AggregatedValue > {AlertThreshold}\",\r\n            \"thresholdOperator\": \"GreaterThan\",\r\n            \"defaultThreshold\": \"95\",\r\n            \"alertUnit\": \"percent\",\r\n            \"metricMeasurement\": {\r\n                \"thresholdOperator\": \"GreaterThan\",\r\n                \"threshold\": \"3\",\r\n                \"metricTriggerType\": \"Consecutive\",\r\n                \"metricColumn\": \"Instance,Database\"\r\n            }\r\n        }\r\n    },\r\n    {\r\n        \"name\": \"Azure DB XTP storage utilization\",\r\n        \"description\": \"Fired when Azure DB XTP storage utilization percentage exceeds the specified threshold. Looks at the 95th percentile value over 5 minutes, and if it exceeds the threshold over 3 consecutive time periods the alert is triggered. For more details on alert rule templates, refer to [this document<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" viewBox=\\\"0 0 16 16\\\" height=\\\"12\\\" width=\\\"12\\\" style=\\\"margin: 0px 0px -2px 3px\\\">\\r\\n  <path d=\\\"M14.3,1.5H10V.5h6v6H15V2.2l-8,8-.7-.7Z\\\" />\\r\\n  <path d=\\\"M11,8.5v5a.9.9,0,0,1-.787,1,.948.948,0,0,1-.213,0H2a.9.9,0,0,1-1-.787A.948.948,0,0,1,1,13.5v-7a.9.9,0,0,1,.787-1A.948.948,0,0,1,2,5.5H8l1-1H2a2,2,0,0,0-2,2v7a2,2,0,0,0,2,2h8a2,2,0,0,0,2-2v-6Z\\\" />\\r\\n</svg>](https://aka.ms/azuresqlinsights/docs/alertruletemplates).\",\r\n        \"author\": \"Microsoft\",\r\n        \"uniqueTag\": \"sql-xtp-storage-utilization\",\r\n        \"recommendationLevel\": 2,\r\n\t\t\"severity\": \"2\",\r\n        \"applyTo\": [],\r\n        \"alertTemplate\": {\r\n            \"type\": \"log-metric-measurement\",\r\n            \"query\": \"InsightsMetrics | where Namespace == 'sqlserver_azure_db_resource_stats' and Name == 'xtp_storage_percent' | extend Tags = todynamic(Tags) | where tostring(Tags.['azm.ms/dcrId']) == '{DcrId}' | extend Instance = Tags.sql_instance, Database = Tags.database_name | summarize AggregatedValue = percentile(Val,95) by bin(TimeGenerated, 5m), tostring(Instance), tostring(Database) //| where AggregatedValue > {AlertThreshold}\",\r\n            \"thresholdOperator\": \"GreaterThan\",\r\n            \"defaultThreshold\": \"80\",\r\n            \"alertUnit\": \"percent\",\r\n            \"metricMeasurement\": {\r\n                \"thresholdOperator\": \"GreaterThan\",\r\n                \"threshold\": \"3\",\r\n                \"metricTriggerType\": \"Consecutive\",\r\n                \"metricColumn\": \"Instance,Database\"\r\n            }\r\n        }\r\n    },\r\n    {\r\n        \"name\": \"Azure DB Max worker utilization\",\r\n        \"description\": \"Fired when Azure DB Max worker utilization percentage exceeds the specified threshold. Looks at the 95th percentile value over 5 minutes, and if it exceeds the threshold over 3 consecutive time periods the alert is triggered. For more details on alert rule templates, refer to [this document<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" viewBox=\\\"0 0 16 16\\\" height=\\\"12\\\" width=\\\"12\\\" style=\\\"margin: 0px 0px -2px 3px\\\">\\r\\n  <path d=\\\"M14.3,1.5H10V.5h6v6H15V2.2l-8,8-.7-.7Z\\\" />\\r\\n  <path d=\\\"M11,8.5v5a.9.9,0,0,1-.787,1,.948.948,0,0,1-.213,0H2a.9.9,0,0,1-1-.787A.948.948,0,0,1,1,13.5v-7a.9.9,0,0,1,.787-1A.948.948,0,0,1,2,5.5H8l1-1H2a2,2,0,0,0-2,2v7a2,2,0,0,0,2,2h8a2,2,0,0,0,2-2v-6Z\\\" />\\r\\n</svg>](https://aka.ms/azuresqlinsights/docs/alertruletemplates).\",\r\n        \"author\": \"Microsoft\",\r\n        \"uniqueTag\": \"sql-max-worker-utilization\",\r\n        \"recommendationLevel\": 2,\r\n\t\t\"severity\": \"2\",\r\n        \"applyTo\": [],\r\n        \"alertTemplate\": {\r\n            \"type\": \"log-metric-measurement\",\r\n            \"query\": \"InsightsMetrics | where Namespace == 'sqlserver_azure_db_resource_stats' and Name == 'max_worker_percent' | extend Tags = todynamic(Tags) | where tostring(Tags.['azm.ms/dcrId']) == '{DcrId}' | extend Instance = Tags.sql_instance, Database = Tags.database_name | summarize AggregatedValue = percentile(Val,95) by bin(TimeGenerated, 5m), tostring(Instance), tostring(Database) //| where AggregatedValue > {AlertThreshold}\",\r\n            \"thresholdOperator\": \"GreaterThan\",\r\n            \"defaultThreshold\": \"70\",\r\n            \"alertUnit\": \"percent\",\r\n            \"metricMeasurement\": {\r\n                \"thresholdOperator\": \"GreaterThan\",\r\n                \"threshold\": \"3\",\r\n                \"metricTriggerType\": \"Consecutive\",\r\n                \"metricColumn\": \"Instance,Database\"\r\n            }\r\n        }\r\n    }\r\n]\r\n",
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "multiLineText": true,
              "editorLanguage": "json"
            }
          },
          {
            "id": "5ab26f46-621e-490a-bab3-fbd51ed11e0d",
            "version": "KqlParameterItem/1.0",
            "name": "AlertCount",
            "type": 1,
            "isRequired": true,
            "query": "AlertsManagementResources\r\n| where type =~ 'microsoft.alertsmanagement/alerts'\r\n| where properties.essentials.startDateTime {TimeRange}\r\n| where subscriptionId == '{Workspaces:subscription}'\r\n| extend AlertRule=tolower(tostring(properties.essentials.alertRule))\r\n| join kind=inner (Resources | where type =~ 'microsoft.insights/scheduledQueryRules'\r\n| extend profileId=tolower(tags.['profile-id'])\r\n| where profileId == tolower('{MonitoringProfile}')\r\n| project AlertRule=tolower(id)) on AlertRule\r\n| summarize Count=tostring(count())",
            "crossComponentResources": [
              "value::selected"
            ],
            "isHiddenWhenLocked": true,
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "e9a0ea45-aeb2-4f85-a6d0-c02d3311f946",
            "version": "KqlParameterItem/1.0",
            "name": "HealthQuery",
            "type": 1,
            "value": "    | where TimeGenerated > ago(10m) and isnotempty(tostring(Tags.sql_instance)) and Namespace == 'sqlserver_server_properties' and Name == 'uptime'",
            "isHiddenWhenLocked": true
          },
          {
            "id": "a2a03457-c4ee-458a-83e5-3cc47afe9c27",
            "version": "KqlParameterItem/1.0",
            "name": "AddMonitorVMLink",
            "type": 1,
            "value": "Community-Workbooks/Workloads/SQL/Add monitoring virtual machine",
            "isHiddenWhenLocked": true
          },
          {
            "id": "f9c13bab-367e-4919-881e-8ed52d311774",
            "version": "KqlParameterItem/1.0",
            "name": "HasComputerWithoutData",
            "type": 1,
            "query": "let Computers = dynamic([{OnboardedComputers}]);\r\nlet TotalComputers = InsightsMetrics\r\n| take 1\r\n| project TotalComputersCol = array_length(Computers), jk=1;\r\nInsightsMetrics\r\n| where Computer in~ ({OnboardedComputers})\r\n| extend Tags = todynamic(Tags)\r\n{HealthQuery}\r\n| summarize ComputerWithMetrics=dcount(Computer)\r\n| extend jk=1\r\n| join (TotalComputers) on jk\r\n| project iff(toint(TotalComputersCol) == toint(ComputerWithMetrics), 'false','true')\r\n\r\n",
            "crossComponentResources": [
              "{Workspaces}"
            ],
            "isHiddenWhenLocked": true,
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          },
          {
            "id": "a1c0bc0f-afb6-4bb5-8888-7ddda0dd2150",
            "version": "KqlParameterItem/1.0",
            "name": "HasComputerWithErrors",
            "type": 1,
            "query": "WorkloadDiagnosticLogs\r\n| where TimeGenerated > ago(10m)\r\n| where Status == 'Error'\r\n| summarize errors_count=count() by bin(TimeGenerated, 5m), Computer\r\n| summarize ComputerErrorBuckets=countif(errors_count > 0) by Computer\r\n| summarize ComputerWithErrors=countif(ComputerErrorBuckets >= 2)\r\n| project iff(toint(ComputerWithErrors) > 0, 'true','false')\r\n\r\n",
            "crossComponentResources": [
              "{Workspaces}"
            ],
            "isHiddenWhenLocked": true,
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          },
          {
            "id": "58fd96d7-a006-4308-a366-664d2d26baee",
            "version": "KqlParameterItem/1.0",
            "name": "checkMonitoringProfileStyle",
            "type": 1,
            "value": "null",
            "isHiddenWhenLocked": true,
            "criteriaData": [
              {
                "criteriaContext": {
                  "leftOperand": "HasComputerWithoutData",
                  "operator": "==",
                  "rightValType": "static",
                  "rightVal": "true",
                  "resultValType": "static",
                  "resultVal": "error"
                }
              },
              {
                "criteriaContext": {
                  "leftOperand": "HasComputerWithoutData",
                  "operator": "is Empty",
                  "rightValType": "param",
                  "resultValType": "static",
                  "resultVal": "error"
                }
              },
              {
                "criteriaContext": {
                  "leftOperand": "HasComputerWithErrors",
                  "operator": "==",
                  "rightValType": "static",
                  "rightVal": "true",
                  "resultValType": "static",
                  "resultVal": "warning"
                }
              },
              {
                "criteriaContext": {
                  "operator": "Default",
                  "rightValType": "param",
                  "resultValType": "static",
                  "resultVal": "null"
                }
              }
            ]
          }
        ],
        "style": "above",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources"
      },
      "customWidth": "0",
      "name": "parameters - 0",
      "styleSettings": {
        "margin": "15px 0 0 0"
      }
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "nav",
        "links": [
          {
            "id": "86f5a193-5333-4ee4-bab3-bc7d2072774a",
            "linkTarget": "WorkbookTemplate",
            "linkLabel": "Alerts ({AlertCount})",
            "style": "primary",
            "linkIsContextBlade": true,
            "workbookContext": {
              "componentIdSource": "workbook",
              "resourceIdsSource": "workbook",
              "templateIdSource": "static",
              "templateId": "Community-Workbooks/Workloads/Alerts",
              "typeSource": "static",
              "type": "workload-insights",
              "gallerySource": "static",
              "gallery": "Azure Monitor",
              "locationSource": "default",
              "passSpecificParams": true,
              "templateParameters": [
                {
                  "name": "MonitoringProfile",
                  "source": "parameter",
                  "value": "MonitoringProfile"
                },
                {
                  "name": "TimeRange",
                  "source": "parameter",
                  "value": "TimeRange"
                },
                {
                  "name": "AlertTemplates",
                  "source": "parameter",
                  "value": "AlertTemplates"
                }
              ]
            }
          },
          {
            "id": "8a20242a-c536-4b22-a012-10128ad5fa92",
            "linkTarget": "WorkbookTemplate",
            "linkLabel": "Create new profile",
            "style": "secondary",
            "linkIsContextBlade": true,
            "workbookContext": {
              "componentIdSource": "workbook",
              "resourceIdsSource": "workbook",
              "templateIdSource": "static",
              "templateId": "Community-Workbooks/Workloads/SQL/Create new profile",
              "typeSource": "static",
              "type": "workload-insights",
              "gallerySource": "static",
              "gallery": "Azure Monitor",
              "locationSource": "default"
            }
          }
        ]
      },
      "conditionalVisibilities": [
        {
          "parameterName": "MonitoringProfile",
          "comparison": "isNotEqualTo"
        },
        {
          "parameterName": "AlertCount",
          "comparison": "isNotEqualTo"
        }
      ],
      "customWidth": "0",
      "name": "Secondary Create new profile",
      "styleSettings": {
        "margin": "35px 0 0 -5px"
      }
    },
    {
      "type": 1,
      "content": {
        "json": "[Database watcher (preview)](https://aka.ms/dbwatcher) is the recommended monitoring solution for scenarios that require low data collection latency, estate-level monitoring, comprehensive monitoring data including query-level details, and low per-database cost for larger environments.\r\n\r\nAt this time, database watcher supports Azure SQL Database and Azure SQL Managed Instance.",
        "style": "upsell"
      },
      "name": "Database watcher message"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<span style=\"font-size:2em\"> Onboarding to Azure Monitor SQL Insights (Preview) </span>\r\n\r\nSQL insights offers you a flexible canvas for telemery collection, analysis, and rich custom visualization. You can customize telemetry collection and frequency, and also combine data from multiple sources into a single monitoring experience for your entire SQL estate. SQL insights is enterprise-ready and easily scales to meet your resource requirements. This feature is available in preview for SQL Database, SQL Managed Instance and SQL Server on Azure Virtual Machines.\r\n\r\nYou will be billed based on the amount of data ingested into Log Analytics and your data retention settings.\r\n\r\n[Learn more about SQL performance monitoring<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 16 16\" height=\"12\" width=\"12\" style=\"margin: 0px 0px -2px 3px\">\r\n  <path d=\"M14.3,1.5H10V.5h6v6H15V2.2l-8,8-.7-.7Z\" />\r\n  <path d=\"M11,8.5v5a.9.9,0,0,1-.787,1,.948.948,0,0,1-.213,0H2a.9.9,0,0,1-1-.787A.948.948,0,0,1,1,13.5v-7a.9.9,0,0,1,.787-1A.948.948,0,0,1,2,5.5H8l1-1H2a2,2,0,0,0-2,2v7a2,2,0,0,0,2,2h8a2,2,0,0,0,2-2v-6Z\" />\r\n</svg>](https://aka.ms/azuresqlinsights/docs)\r\n\r\n[Learn more about pricing<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 16 16\" height=\"12\" width=\"12\" style=\"margin: 0px 0px -2px 3px\">\r\n  <path d=\"M14.3,1.5H10V.5h6v6H15V2.2l-8,8-.7-.7Z\" />\r\n  <path d=\"M11,8.5v5a.9.9,0,0,1-.787,1,.948.948,0,0,1-.213,0H2a.9.9,0,0,1-1-.787A.948.948,0,0,1,1,13.5v-7a.9.9,0,0,1,.787-1A.948.948,0,0,1,2,5.5H8l1-1H2a2,2,0,0,0-2,2v7a2,2,0,0,0,2,2h8a2,2,0,0,0,2-2v-6Z\" />\r\n</svg>](https://aka.ms/azuresqlinsights/pricing)"
            },
            "name": "Onboarding Message"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "nav",
              "links": [
                {
                  "id": "58ec103a-1e3e-4c34-9556-800bac876ecf",
                  "linkTarget": "WorkbookTemplate",
                  "linkLabel": "Create new profile",
                  "style": "primary",
                  "linkIsContextBlade": true,
                  "workbookContext": {
                    "componentIdSource": "workbook",
                    "resourceIdsSource": "workbook",
                    "templateIdSource": "static",
                    "templateId": "Community-Workbooks/Workloads/SQL/Create new profile",
                    "typeSource": "static",
                    "type": "workload-insights",
                    "gallerySource": "static",
                    "gallery": "Azure Monitor",
                    "locationSource": "default"
                  }
                }
              ]
            },
            "customWidth": "0",
            "conditionalVisibility": {
              "parameterName": "MonitoringProfile",
              "comparison": "isEqualTo"
            },
            "name": "Primary Create new profile - in Onboarding",
            "styleSettings": {
              "margin": "0px 0px 0px -10px",
              "padding": "20px 0px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "![Sample Image](https://raw.githubusercontent.com/microsoft/Application-Insights-Workbooks/master/Documentation/Images/AzureSQLOnboard.png)"
            },
            "name": "Azure SQL DB sample image",
            "styleSettings": {
              "padding": "0px",
              "showBorder": true
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "MonitoringProfile",
        "comparison": "isEqualTo"
      },
      "name": "Onboarding page"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "tabs",
        "links": [
          {
            "id": "37f0d44c-c4f4-44e6-ad23-63ddfdfe6386",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Overview",
            "subTarget": "Overview",
            "style": "link"
          },
          {
            "id": "65469e9c-6f35-4325-bb27-0a80e061d1af",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Manage profile",
            "subTarget": "Manage profile",
            "style": "link"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "MonitoringProfile",
        "comparison": "isNotEqualTo"
      },
      "name": "links - 3",
      "styleSettings": {
        "margin": "15px 0 0 0"
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "If you encounter persistent errors collecting data, and/or seeing the \"Not Collecting\" status message, we suggest deleting and recreating the monitoring profile and the monitoring VM. Make sure to closely follow the steps in [Enable SQL Insights](https://go.microsoft.com/fwlink/?linkid=2193900). This will resolve a number of known issues you may encounter during preview.",
              "style": "info"
            },
            "name": "text - 3"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "Looks like you don't have any monitoring virtual machines associated with this profile. Please associate one or more from the `Manage profile` tab.",
                    "style": "warning"
                  },
                  "conditionalVisibilities": [
                    {
                      "parameterName": "MonitoringProfile",
                      "comparison": "isNotEqualTo"
                    },
                    {
                      "parameterName": "OnboardedComputers",
                      "comparison": "isEqualTo"
                    }
                  ],
                  "name": "text - 0 - Copy",
                  "styleSettings": {
                    "margin": "20px 0 0 0"
                  }
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "OnboardedComputers",
              "comparison": "isEqualTo",
              "value": ""
            },
            "name": "Onboarding message"
          },
          {
            "type": 1,
            "content": {
              "json": "We are encountering errors collecting monitoring data from your SQL resources. Select the __Manage profile__ tab for more details.",
              "style": "{checkMonitoringProfileStyle}"
            },
            "conditionalVisibilities": [
              {
                "parameterName": "checkMonitoringProfileStyle",
                "comparison": "isNotEqualTo",
                "value": "null"
              },
              {
                "parameterName": "OnboardedComputers",
                "comparison": "isNotEqualTo"
              }
            ],
            "name": "Collection Errors"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let dbsInGroup = datatable(Type:string)[\r\n  \"Databases\"\r\n];\r\nlet data = InsightsMetrics\r\n| where Computer in~ ({OnboardedComputers})\r\n| where Namespace contains 'sqlserver_server_properties' and Name in~ ('uptime', 'engine_edition')\r\n| extend Tags = todynamic(Tags)\r\n| extend Database = tostring(Tags.database_name), Instance = tostring(Tags.sql_instance)\r\n| extend DatabaseKey = iff(Database == Instance, Database, strcat(Database, ' on ', Instance)), Replica = tostring(iff(Tags.replica_updateability == 'READ_WRITE', 'primary', 'secondary'));\r\ndata\r\n| summarize (LastTimestamp, Val) = arg_max(TimeGenerated, Val) by Name, Database, Instance, Computer, Replica\r\n| extend Val = iff(Name == 'uptime', iff(LastTimestamp < now() - 10m , 0.0, 1.0), Val)\r\n| summarize CurrentOnline = sumif(Val, Name == 'uptime'),\r\n    EngineEdition = sumif(Val, Name == 'engine_edition')\r\n  by Database, Instance, Computer, Replica\r\n| where EngineEdition == 5\r\n| summarize Online = sum(CurrentOnline), Total = count()\r\n| extend Type = \"Databases\", Unhealthy = Total - Online\r\n| join kind = rightouter (dbsInGroup) on Type\r\n| extend Online = iff(Type == '', 0.0, Online),\r\n    Unhealthy = iff(Type == '', 0.0, Unhealthy),\r\n    Total = iff(Type == '', 0, Total),\r\n    Type = Type1\r\n\r\n",
                    "size": 4,
                    "title": "Azure SQL Database",
                    "timeContext": {
                      "durationMs": 0
                    },
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspaces}"
                    ],
                    "visualization": "tiles",
                    "sortBy": [],
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "Type",
                        "formatter": 1,
                        "formatOptions": {
                          "linkTarget": "WorkbookTemplate",
                          "workbookContext": {
                            "componentIdSource": "workbook",
                            "resourceIdsSource": "parameter",
                            "resourceIds": "MonitoringProfile",
                            "templateIdSource": "static",
                            "templateId": "Community-Workbooks/Workloads/SQL/Azure SQL Databases",
                            "typeSource": "static",
                            "type": "workload-insights",
                            "gallerySource": "static",
                            "gallery": "Azure Monitor",
                            "locationSource": "default",
                            "passSpecificParams": true,
                            "templateParameters": [
                              {
                                "name": "MonitoringProfile",
                                "source": "parameter",
                                "value": "MonitoringProfile"
                              },
                              {
                                "name": "TimeRange",
                                "source": "parameter",
                                "value": "TimeRange"
                              },
                              {
                                "name": "SqlType",
                                "source": "column",
                                "value": "Type"
                              },
                              {
                                "name": "CommonErrors",
                                "source": "parameter",
                                "value": "CommonErrors"
                              }
                            ]
                          }
                        }
                      },
                      "subtitleContent": {
                        "columnMatch": "Subtitle",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "Green",
                        "formatter": 22,
                        "formatOptions": {
                          "compositeBarSettings": {
                            "labelText": "[\"Total\"] database(s)",
                            "columnSettings": [
                              {
                                "columnName": "Online",
                                "color": "green"
                              },
                              {
                                "columnName": "Unhealthy",
                                "color": "yellow"
                              }
                            ]
                          }
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "useGrouping": false,
                            "maximumFractionDigits": 1
                          }
                        }
                      },
                      "secondaryContent": {
                        "columnMatch": "Currently unhealthy dbs",
                        "formatter": 18,
                        "formatOptions": {
                          "thresholdsOptions": "icons",
                          "thresholdsGrid": [
                            {
                              "operator": ">",
                              "thresholdValue": "0",
                              "representation": "critical",
                              "text": "{0}{1}"
                            },
                            {
                              "operator": "Default",
                              "thresholdValue": null,
                              "representation": "Blank",
                              "text": ""
                            }
                          ]
                        },
                        "numberFormat": {
                          "unit": 0,
                          "options": {
                            "style": "decimal",
                            "useGrouping": false
                          }
                        }
                      },
                      "showBorder": false
                    }
                  },
                  "name": "Azure SQL Database"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let dbsInGroup = datatable(Type:string)[\r\n  \"Instances\"\r\n];\r\nlet data = InsightsMetrics\r\n| where Computer in~ ({OnboardedComputers})\r\n| where Namespace contains 'sqlserver_server_properties'\r\n| extend Tags = todynamic(Tags)\r\n| extend Database = tostring(Tags.database_name), Instance = tostring(Tags.sql_instance), Replica = tostring(iff(Tags.replica_updateability == 'READ_WRITE', 'primary', 'secondary'))\r\n| extend DatabaseKey = iff(Database == Instance, Database, strcat(Database, ' on ', Instance));\r\ndata\r\n| summarize (LastTimestamp, Val) = arg_max(TimeGenerated, Val) by Name, Database, Instance, Computer, Replica\r\n| extend Val = iff(LastTimestamp < now() - 10m and Name != 'engine_edition', 0.0, Val)\r\n| summarize CurrentOnline = sumif(Val, Name == 'db_online'),\r\n    CurrentUnhealthy = sumif(Val, Name in~ ('db_offline', 'db_recovering', 'db_recoveryPending', 'db_restoring', 'db_suspect')),\r\n    EngineEdition = sumif(Val, Name == 'engine_edition')\r\n  by Database, Instance, Computer, Replica\r\n| extend CurrentOnline = iff(EngineEdition == 5 and CurrentOnline > 0, 1.0, CurrentOnline)\r\n| extend Key = strcat(Computer, '/', Instance, '/', Database)\r\n| join kind = inner (data\r\n    | summarize OverallOnline = minif(Val, Name == 'db_online'),\r\n                OverallUnhealthy = maxif(Val, Name in~ ('db_offline', 'db_recovering', 'db_recoveryPending', 'db_restoring', 'db_suspect')),\r\n                EngineEdition = sumif(Val, Name == 'engine_edition')\r\n    by Key = strcat(Computer, '/', Instance, '/', Database)\r\n) on Key\r\n| extend CurrentOnline = iff(EngineEdition == 5 and CurrentOnline > 0, 1.0, CurrentOnline), OverallOnline = iff(EngineEdition == 5 and OverallOnline > 0, 1.0, OverallOnline)\r\n| project-away Key, Key1, EngineEdition1\r\n| extend Type = case(\r\n            EngineEdition in (1, 2, 3, 4), 'SQL Server instances',\r\n            EngineEdition in (5, 6, 9), 'Databases',\r\n            EngineEdition == 8, 'Instances',\r\n            'Other')\r\n| project Database = strcat(Instance, '/', Database), Green = CurrentOnline, Yellow = OverallUnhealthy - CurrentUnhealthy, Red = CurrentUnhealthy, Total = CurrentOnline + CurrentUnhealthy, Gray =  (OverallOnline + OverallUnhealthy) - (CurrentOnline + CurrentUnhealthy), Type, Computer\r\n| summarize Green = sum(Green), Yellow = sum(Yellow), Red = sum(Red), Gray = sum(Gray), Total = sum(Total) by Type\r\n| join kind = rightouter(dbsInGroup) on Type\r\n| extend Type = iff(Type == '', Type1, Type),\r\n    Yellow = iff(Type == '', 0.0, Yellow),\r\n    Red = iff(Type == '', 0.0, Red),\r\n    Gray = iff(Type == '', 0.0, Gray),\r\n    Green = iff(Type == '', 0.0, Green),\r\n    Total = iff(Type == '', 0.0, Total)\r\n| summarize ['Online dbs'] = sum(Green), ['Previously unhealthy dbs'] = sum(Yellow), ['Currently unhealthy dbs'] = sum(Red), [\"No telemetry dbs\"] = sum(Gray), Total = sum(Total) by Type\r\n| extend Subtitle = '━━━'\r\n| order by ['Currently unhealthy dbs'] desc, [\"No telemetry dbs\"] desc, ['Previously unhealthy dbs'] desc, ['Online dbs'] desc\r\n",
                    "size": 4,
                    "title": "Azure SQL Managed Instance",
                    "timeContext": {
                      "durationMs": 0
                    },
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspaces}"
                    ],
                    "visualization": "tiles",
                    "sortBy": [],
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "Type",
                        "formatter": 1,
                        "formatOptions": {
                          "linkTarget": "WorkbookTemplate",
                          "workbookContext": {
                            "componentIdSource": "workbook",
                            "resourceIdsSource": "parameter",
                            "resourceIds": "MonitoringProfile",
                            "templateIdSource": "static",
                            "templateId": "Community-Workbooks/Workloads/SQL/Azure SQL Managed Instances",
                            "typeSource": "static",
                            "type": "workload-insights",
                            "gallerySource": "static",
                            "gallery": "Azure Monitor",
                            "locationSource": "default",
                            "passSpecificParams": true,
                            "templateParameters": [
                              {
                                "name": "MonitoringProfile",
                                "source": "parameter",
                                "value": "MonitoringProfile"
                              },
                              {
                                "name": "TimeRange",
                                "source": "parameter",
                                "value": "TimeRange"
                              },
                              {
                                "name": "SqlType",
                                "source": "column",
                                "value": "Type"
                              },
                              {
                                "name": "CommonErrors",
                                "source": "parameter",
                                "value": "CommonErrors"
                              }
                            ]
                          }
                        }
                      },
                      "leftContent": {
                        "columnMatch": "Green",
                        "formatter": 22,
                        "formatOptions": {
                          "compositeBarSettings": {
                            "labelText": "[\"Total\"] database(s)",
                            "columnSettings": [
                              {
                                "columnName": "Online dbs",
                                "color": "green"
                              },
                              {
                                "columnName": "No telemetry dbs",
                                "color": "orange"
                              },
                              {
                                "columnName": "Previously unhealthy dbs",
                                "color": "yellow"
                              },
                              {
                                "columnName": "Currently unhealthy dbs",
                                "color": "redBright"
                              }
                            ]
                          }
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "useGrouping": false,
                            "maximumFractionDigits": 1
                          }
                        }
                      },
                      "secondaryContent": {
                        "columnMatch": "Currently unhealthy dbs",
                        "formatter": 18,
                        "formatOptions": {
                          "thresholdsOptions": "icons",
                          "thresholdsGrid": [
                            {
                              "operator": ">",
                              "thresholdValue": "0",
                              "representation": "4",
                              "text": "{0}{1} offline"
                            },
                            {
                              "operator": "Default",
                              "thresholdValue": null,
                              "representation": "Blank",
                              "text": ""
                            }
                          ]
                        },
                        "numberFormat": {
                          "unit": 0,
                          "options": {
                            "style": "decimal",
                            "useGrouping": false
                          }
                        }
                      },
                      "showBorder": false
                    }
                  },
                  "name": "Azure SQL Managed Instance"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let dbsInGroup = datatable(Type: string)[\r\n    \"SQL Server instances\",\r\n    \"Availability groups\"\r\n    ];\r\nlet aGdata = InsightsMetrics\r\n    | where Computer in~ ({OnboardedComputers})\r\n    | where Namespace == \"sqlserver_hadr_replica_states\" and Name == \"role\" and Val == \"1\"\r\n    | extend Tags = todynamic(Tags)\r\n    | extend SyncHealth = tostring(Tags.ag_synchronization_health_desc)\r\n    | extend GroupId = tostring(Tags.group_id), GroupName = tostring(Tags.group_name);\r\nlet aGStatus = aGdata\r\n    | where TimeGenerated between(ago(10m)..now())\r\n    | extend isHealthy = iff(SyncHealth == \"HEALTHY\", 1, 0)\r\n    | summarize CurrentOnline = min(isHealthy), CurrentTotal = max(isHealthy) by GroupId, Computer, GroupName\r\n    | join kind = inner (\r\n        aGdata\r\n        | extend isHealthy = iff(SyncHealth == \"HEALTHY\", 1, 0)\r\n        | summarize OverallOnline = min(isHealthy), OverallTotal = max(isHealthy) by GroupId, Computer, GroupName)\r\n        on GroupId\r\n    | extend Type = \"Availability groups\"\r\n    | extend OverallUnhealthy = OverallTotal - OverallOnline\r\n    | extend CurrentUnhealthy = CurrentTotal - CurrentOnline\r\n    | project Green = CurrentOnline, Yellow = OverallUnhealthy - CurrentUnhealthy, Red = CurrentUnhealthy, Total = CurrentTotal, Gray =  (OverallTotal) - (CurrentTotal), Type, Computer\r\n    | summarize Green = sum(Green), Yellow = sum(Yellow), Red = sum(Red), Gray = sum(Gray), Total = sum(Total) by Type;\r\nlet data = InsightsMetrics\r\n    | where Computer in~ ({OnboardedComputers})\r\n    | where Namespace contains 'sqlserver_server_properties'\r\n    | extend Tags = todynamic(Tags)\r\n    | extend Database = tostring(Tags.database_name), Instance = tostring(Tags.sql_instance)\r\n    | extend DatabaseKey = iff(Database == Instance, Database, strcat(Database, ' on ', Instance));\r\ndata\r\n| summarize (LastTimestamp, Val) = arg_max(TimeGenerated, Val) by Name, Database, Instance, Computer\r\n| extend Val = iff(LastTimestamp < now() - 10m and Name != 'engine_edition', 0.0, Val)\r\n| summarize CurrentOnline = sumif(Val, Name == 'db_online'),\r\n    CurrentUnhealthy = sumif(Val, Name in~ ('db_offline', 'db_recovering', 'db_recoveryPending', 'db_restoring', 'db_suspect')),\r\n    EngineEdition = sumif(Val, Name == 'engine_edition')\r\n    by Database, Instance, Computer\r\n| extend CurrentOnline = iff(EngineEdition == 5 and CurrentOnline > 0, 1.0, CurrentOnline)\r\n| extend Key = strcat(Computer, '/', Instance, '/', Database)\r\n| join kind = inner (\r\n    data\r\n    | summarize OverallOnline = minif(Val, Name == 'db_online'),\r\n        OverallUnhealthy = maxif(Val, Name in~ ('db_offline', 'db_recovering', 'db_recoveryPending', 'db_restoring', 'db_suspect')),\r\n        EngineEdition = sumif(Val, Name == 'engine_edition')\r\n        by Key = strcat(Computer, '/', Instance, '/', Database)\r\n    )\r\n    on Key\r\n| extend CurrentOnline = iff(EngineEdition == 5 and CurrentOnline > 0, 1.0, CurrentOnline), OverallOnline = iff(EngineEdition == 5 and OverallOnline > 0, 1.0, OverallOnline)\r\n| project-away Key, Key1, EngineEdition1\r\n| extend Type = case(\r\n    EngineEdition in (1, 2, 3, 4), 'SQL Server instances',\r\n    EngineEdition in (5, 6, 9), 'Databases',\r\n    EngineEdition == 8, 'Instances',\r\n    'Other')\r\n| project Database = strcat(Instance, '/', Database), Green = CurrentOnline, Yellow = OverallUnhealthy - CurrentUnhealthy, Red = CurrentUnhealthy, Total = CurrentOnline + CurrentUnhealthy, Gray =  (OverallOnline + OverallUnhealthy) - (CurrentOnline + CurrentUnhealthy), Type, Computer\r\n| summarize Green = sum(Green), Yellow = sum(Yellow), Red = sum(Red), Gray = sum(Gray), Total = sum(Total) by Type\r\n| join kind = rightouter (dbsInGroup) on Type\r\n| extend Type = iff(Type == '', Type1, Type),\r\n    Yellow = iff(Type == '', 0, tolong(Yellow)),\r\n    Red = iff(Type == '', 0, tolong(Red)),\r\n    Gray = iff(Type == '', 0, tolong(Gray)),\r\n    Green = iff(Type == '', 0, tolong(Green)),\r\n    Total = iff(Type == '', 0, tolong(Total))\r\n| join kind = leftouter (aGStatus) on Type\r\n| extend Yellow = iff(isempty(Yellow1), Yellow, tolong(Yellow1)),\r\n    Red = iff(isempty(Red1), Red, tolong(Red1)),\r\n    Gray = iff(isempty(Gray1), Gray, tolong(Gray1)),\r\n    Green = iff(isempty(Green1), Green, tolong(Green1)),\r\n    Total = iff(isempty(Total1), Total, tolong(Total1))\r\n| summarize ['Online dbs'] = sum(Green), ['Previously unhealthy dbs'] = sum(Yellow), ['Currently unhealthy dbs'] = sum(Red), [\"No telemetry dbs\"] = sum(Gray), Total = sum(Total) by Type\r\n| extend Subtitle = '━━━'\r\n| extend TemplateLink = case(Type == 'SQL Server instances', 'Community-Workbooks/Workloads/SQL/SQL Servers', 'Community-Workbooks/Workloads/SQL/Availability groups')\r\n| extend Units = case(Type == 'SQL Server instances', 'database(s)', 'availability group(s)')\r\n| order by ['Currently unhealthy dbs'] desc, [\"No telemetry dbs\"] desc, ['Previously unhealthy dbs'] desc, ['Online dbs'] desc, ['Type'] desc\r\n",
                    "size": 4,
                    "title": "SQL Server",
                    "timeContext": {
                      "durationMs": 0
                    },
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspaces}"
                    ],
                    "visualization": "tiles",
                    "sortBy": [],
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "Type",
                        "formatter": 1,
                        "formatOptions": {
                          "linkTarget": "WorkbookTemplate",
                          "workbookContext": {
                            "componentIdSource": "workbook",
                            "resourceIdsSource": "parameter",
                            "resourceIds": "MonitoringProfile",
                            "templateIdSource": "column",
                            "templateId": "TemplateLink",
                            "typeSource": "static",
                            "type": "workload-insights",
                            "gallerySource": "static",
                            "gallery": "Azure Monitor",
                            "locationSource": "default",
                            "passSpecificParams": true,
                            "templateParameters": [
                              {
                                "name": "MonitoringProfile",
                                "source": "parameter",
                                "value": "MonitoringProfile"
                              },
                              {
                                "name": "TimeRange",
                                "source": "parameter",
                                "value": "TimeRange"
                              },
                              {
                                "name": "SqlType",
                                "source": "column",
                                "value": "Type"
                              },
                              {
                                "name": "CommonErrors",
                                "source": "parameter",
                                "value": "CommonErrors"
                              }
                            ]
                          }
                        }
                      },
                      "leftContent": {
                        "columnMatch": "Green",
                        "formatter": 22,
                        "formatOptions": {
                          "compositeBarSettings": {
                            "labelText": "[\"Total\"] [\"Units\"]",
                            "columnSettings": [
                              {
                                "columnName": "Online dbs",
                                "color": "green"
                              },
                              {
                                "columnName": "No telemetry dbs",
                                "color": "orange"
                              },
                              {
                                "columnName": "Previously unhealthy dbs",
                                "color": "yellow"
                              },
                              {
                                "columnName": "Currently unhealthy dbs",
                                "color": "redBright"
                              }
                            ]
                          }
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "useGrouping": false,
                            "maximumFractionDigits": 1
                          }
                        }
                      },
                      "secondaryContent": {
                        "columnMatch": "Currently unhealthy dbs",
                        "formatter": 18,
                        "formatOptions": {
                          "thresholdsOptions": "icons",
                          "thresholdsGrid": [
                            {
                              "operator": ">",
                              "thresholdValue": "0",
                              "representation": "critical",
                              "text": "{0}{1} offline"
                            },
                            {
                              "operator": "Default",
                              "thresholdValue": null,
                              "representation": "Blank",
                              "text": ""
                            }
                          ]
                        },
                        "numberFormat": {
                          "unit": 0,
                          "options": {
                            "style": "decimal",
                            "useGrouping": false
                          }
                        }
                      },
                      "showBorder": false
                    }
                  },
                  "name": "SQL Server"
                }
              ]
            },
            "conditionalVisibilities": [
              {
                "parameterName": "OnboardedComputers",
                "comparison": "isNotEqualTo"
              },
              {
                "parameterName": "Workspaces",
                "comparison": "isNotEqualTo"
              }
            ],
            "name": "OnboardedComputers"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "Overview"
      },
      "name": "Overview",
      "styleSettings": {
        "margin": "15px 0 0 0"
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "template",
        "loadFromTemplateId": "Community-Workbooks/Workloads/Enable monitoring",
        "items": []
      },
      "conditionalVisibilities": [
        {
          "parameterName": "MonitoringProfile",
          "comparison": "isNotEqualTo"
        },
        {
          "parameterName": "selectedTab",
          "comparison": "isEqualTo",
          "value": "Manage profile"
        }
      ],
      "name": "Manage profile"
    }
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}