{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "# Guide to using this workbook\r\n\r\nUse this workbook to better understand how frequent users in your tenant are getting prompted for reauthentication and gain insights on how to reduce multi-factor (MFA) prompts based on the devices, authentication methods and applications users are using.\r\n\r\nIf the graphs below are not rendering, please make sure you have selected a working Workbook and Subscription in the filters below.\r\n\r\n"
            },
            "name": "text - 1"
          },
          {
            "type": 1,
            "content": {
              "json": "# Filters"
            },
            "name": "text - 2"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "a73b569b-6b9a-4980-9def-c8ee8add51f0",
                  "version": "KqlParameterItem/1.0",
                  "name": "Workbook",
                  "type": 5,
                  "isRequired": true,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "value": [
					"value::all"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "showDefault": false
                  },
                  "defaultValue": "value::all"
                },
                {
                  "id": "3db1324f-e565-4b23-9992-46fe4ba3909d",
                  "version": "KqlParameterItem/1.0",
                  "name": "Subscription",
                  "type": 6,
                  "isRequired": true,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "value": [
                    "value::all"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "includeAll": false,
                    "showDefault": false
                  }
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "parameters - 4"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "4ce4eed0-580a-4ec2-9043-3872fafcdd0f",
                  "version": "KqlParameterItem/1.0",
                  "name": "Time",
                  "type": 4,
                  "isRequired": true,
                  "value": {
                    "durationMs": 604800000
                  },
                  "typeSettings": {
                    "selectableValues": [
                      {
                        "durationMs": 3600000
                      },
                      {
                        "durationMs": 86400000
                      },
                      {
                        "durationMs": 604800000
                      },
                      {
                        "durationMs": 2592000000
                      },
                      {
                        "durationMs": 7776000000
                      }
                    ]
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "d90371c2-48fc-460f-8368-c81c220a37a7",
                  "version": "KqlParameterItem/1.0",
                  "name": "AuthMethod",
                  "type": 2,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "showDefault": false
                  },
                  "jsonData": "[\r\n    { \"value\":\"Password\", \"label\":\"Password\" },\r\n    { \"value\":\"Previously satisfied\", \"label\":\"Previously Satisfied\" },\r\n    { \"value\":\"X.509 Certificate\", \"label\":\"X.509 Certificate\" },\r\n    { \"value\":\"Mobile app notification\", \"label\":\"Mobile App Notification\"},\r\n    { \"value\":\"Text message\", \"label\":\"Text Message\" },\r\n    { \"value\":\"Phone call approval (Authentication phone)\", \"label\":\"Phone Call Approval\" },\r\n    { \"value\":\"Windows Hello for Business\", \"label\":\"Windows Hello for Business\"},\r\n    { \"value\":\"OAUTH verification code\", \"label\":\"Passwordless\"},\r\n    { \"value\":\"Phone call approval (Office phone)\", \"label\":\"Office Phone Call Approval\"},\r\n    { \"value\":\"FIDO2 security key\", \"label\":\"FIDO2 Security Key\" },\r\n    { \"value\":\"Temporary Access Pass\", \"label\":\"Temporary Access Pass\" },\r\n    { \"value\":\"Passwordless phone sign-in\", \"label\":\"Passwordless Phone SignIn\",\"selected\":true }\r\n]",
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "timeContextFromParameter": "Time",
                  "defaultValue": "value::all"
                },
                {
                  "id": "d0572ef9-28b3-43b2-94aa-2a2550ac799b",
                  "version": "KqlParameterItem/1.0",
                  "name": "DeviceState",
                  "type": 2,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "showDefault": false
                  },
                  "jsonData": "[\r\n    { \"value\":\"Unmanaged\", \"label\":\"Unmanaged\" },\r\n    { \"value\":\"Azure AD registered\", \"label\":\"Azure AD registered\" },\r\n     { \"value\":\"Azure AD joined\", \"label\":\"Azure AD Joined\" },\r\n    { \"value\":\"Hybrid Azure AD joined\", \"label\":\"Hybrid Azure AD joined\", \"selected\":true }\r\n]",
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "defaultValue": "value::all",
                  "value": [
                    "value::all"
                  ]
                },
                {
                  "id": "6df9b54e-5fdd-43bd-8686-ec78f74383ab",
                  "version": "KqlParameterItem/1.0",
                  "name": "App",
                  "type": 1,
                  "description": "Default value is All apps",
                  "value": "",
                  "timeContext": {
                    "durationMs": 604800000
                  },
                  "timeContextFromParameter": "Time",
                  "defaultValue": "value::all"
                },
                {
                  "id": "adfbe329-1f53-4edb-ba08-6e9002bf9be0",
                  "version": "KqlParameterItem/1.0",
                  "name": "User",
                  "type": 1,
                  "description": "Default value is All users",
                  "value": "",
                  "timeContext": {
                    "durationMs": 604800000
                  },
                  "timeContextFromParameter": "Time",
                  "defaultValue": "value::all"
                },
                {
                  "id": "77c07866-4973-42d5-b697-446f44da5724",
                  "version": "KqlParameterItem/1.0",
                  "name": "AuthStatus",
                  "type": 2,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "showDefault": false
                  },
                  "jsonData": "[\r\n    { \"value\":\"Success\", \"label\":\"Success\" },\r\n    { \"value\":\"Failure\", \"label\":\"Failure\", \"selected\":true }\r\n]",
                  "timeContext": {
                    "durationMs": 604800000
                  },
                  "timeContextFromParameter": "Time",
                  "defaultValue": "value::all"
                },
                {
                  "id": "c8b2d139-eb66-40ff-9e51-79cc4588f7c8",
                  "version": "KqlParameterItem/1.0",
                  "name": "OS",
                  "type": 1,
                  "description": "Default value is All OS",
                  "timeContext": {
                    "durationMs": 604800000
                  },
                  "timeContextFromParameter": "Time"
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "customWidth": "100",
            "name": "parameters - 13",
            "styleSettings": {
              "margin": "0"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "\r\n\r\n# Authentication prompts by authentication method\r\n### Count of authentication methods excludes previously satisfied and unknown authentication methods"
            },
            "name": "text - 3"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "\r\n\r\nlet TotalAuthPrompts = SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)\r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n    |extend OperatingSystem = ParsedFields2.operatingSystem\r\n    |extend OS = tostring(OperatingSystem)\r\n    |extend Status = ParsedFields.succeeded\r\n    |extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\")\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n| where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus}) \r\n|where AuthMethod != \"Previously satisfied\"\r\n    and  AuthMethod != \"\"\r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\";\r\nlet AuthPromptSummary = TotalAuthPrompts | summarize Stage = \"Total authentication prompts\", CountPrompts=count();\r\nlet SuccessPrompts = TotalAuthPrompts\r\n    |where AuthStatus == \"Success\";\r\nlet SuccessSummary = SuccessPrompts | summarize Stage = \"Successes\", CountPrompts=count();\r\nlet FailurePrompts = TotalAuthPrompts\r\n| where AuthStatus != \"Success\";\r\nlet FailureSummary = FailurePrompts\r\n| summarize Stage = \"Failures\", CountPrompts=count();\r\nunion AuthPromptSummary,SuccessSummary, FailureSummary\r\n| sort by CountPrompts desc",
              "size": 3,
              "color": "blue",
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "Time",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "tiles",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "UserDisplayName",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "25ch"
                    }
                  },
                  {
                    "columnMatch": "AppDisplayName",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "30ch"
                    }
                  },
                  {
                    "columnMatch": "SigninStatus",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "20ch"
                    }
                  },
                  {
                    "columnMatch": "CountPrompts",
                    "formatter": 2,
                    "formatOptions": {
                      "customColumnWidthSetting": "20ch"
                    }
                  }
                ]
              },
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "Stage",
                  "formatter": 3,
                  "numberFormat": {
                    "unit": 0,
                    "options": {
                      "style": "decimal"
                    }
                  }
                },
                "leftContent": {
                  "columnMatch": "CountPrompts",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "maximumFractionDigits": 2,
                      "maximumSignificantDigits": 3
                    }
                  }
                },
                "showBorder": false,
                "size": "auto"
              }
            },
            "customWidth": "100",
            "showPin": false,
            "name": "query - 13"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let baseQuery = materialize(SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)   \r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\"\r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n);\r\nlet totalCount = toscalar(baseQuery | count);\r\nbaseQuery\r\n|summarize Count = count(AuthMethod) * 100.0 /totalCount by AuthMethod\r\n",
              "size": 3,
              "showAnalytics": true,
              "title": "% Authentication prompts by method",
              "timeContext": {
                "durationMs": 604800000
              },
              "timeContextFromParameter": "Time",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "piechart",
              "gridSettings": {
                "sortBy": [
                  {
                    "itemKey": "AuthMethCount",
                    "sortOrder": 2
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "AuthMethCount",
                  "sortOrder": 2
                }
              ],
              "chartSettings": {
                "xAxis": "AuthMethod",
                "yAxis": [
                  "Count"
                ],
                "seriesLabelSettings": [
                  {
                    "seriesName": "Mobile app notification",
                    "label": "Authenticator App",
                    "color": "orange"
                  }
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 1,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true,
                      "maximumFractionDigits": 1
                    }
                  }
                }
              }
            },
            "customWidth": "35",
            "showPin": true,
            "name": "query - 1"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)\r\n    |extend SuccessfulSignin = ParsedFields.succeeded   \r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\" \r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n|summarize AuthMethCount = count() by bin (TimeGenerated, 1d), AuthMethod",
              "size": 0,
              "showAnalytics": true,
              "title": "Daily authentication prompts by method",
              "timeContext": {
                "durationMs": 604800000
              },
              "timeContextFromParameter": "Time",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "unstackedbar",
              "chartSettings": {
                "yAxis": [
                  "AuthMethCount"
                ],
                "seriesLabelSettings": [
                  {
                    "seriesName": "Mobile app notification",
                    "label": "Authenticator App",
                    "color": "orange"
                  }
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 0,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true
                    }
                  }
                }
              }
            },
            "customWidth": "65",
            "showPin": true,
            "name": "query - 2"
          },
          {
            "type": 1,
            "content": {
              "json": "# Authentication prompts by device\r\n"
            },
            "name": "text - 4"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let baseQuery = materialize(SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)\r\n    |extend SuccessfulSignin = ParsedFields.succeeded   \r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\"\r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n);\r\nlet totalCount = toscalar(baseQuery | count);\r\nbaseQuery\r\n|summarize Count = count(AuthMethod) * 100.0 /totalCount by OS\r\n",
              "size": 3,
              "showAnalytics": true,
              "title": "% Authentication prompts by operating system",
              "timeContext": {
                "durationMs": 604800000
              },
              "timeContextFromParameter": "Time",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "yAxis": [
                  "Count"
                ],
                "seriesLabelSettings": [
                  {
                    "seriesName": "Windows 10",
                    "color": "orange"
                  },
                  {
                    "seriesName": "iOS 14",
                    "color": "magenta"
                  },
                  {
                    "seriesName": "Android",
                    "color": "pink"
                  },
                  {
                    "seriesName": "MacOS",
                    "color": "gray"
                  },
                  {
                    "seriesName": "Windows 8",
                    "color": "redDark"
                  },
                  {
                    "seriesName": "",
                    "label": "Unknown OS",
                    "color": "blue"
                  },
                  {
                    "seriesName": "Windows",
                    "color": "blueDark"
                  }
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 1,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true,
                      "maximumFractionDigits": 1
                    }
                  }
                }
              }
            },
            "customWidth": "35",
            "showPin": true,
            "name": "query - 3"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)\r\n    |extend SuccessfulSignin = ParsedFields.succeeded   \r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\" \r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n|summarize Count = count(AuthMethod) by bin (TimeGenerated, 1h), OS\r\n",
              "size": 0,
              "showAnalytics": true,
              "title": "Hourly authentication prompts by operating system",
              "timeContext": {
                "durationMs": 604800000
              },
              "timeContextFromParameter": "Time",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "barchart",
              "chartSettings": {
                "yAxis": [
                  "Count"
                ],
                "seriesLabelSettings": [
                  {
                    "seriesName": "Windows 10",
                    "color": "orange"
                  },
                  {
                    "seriesName": "iOS 14",
                    "color": "purple"
                  },
                  {
                    "seriesName": "MacOs",
                    "color": "blueDark"
                  },
                  {
                    "seriesName": "Android",
                    "color": "pink"
                  },
                  {
                    "seriesName": "Windows 8",
                    "color": "red"
                  },
                  {
                    "seriesName": "<empty>",
                    "label": "Unknown OS",
                    "color": "blue"
                  },
                  {
                    "seriesName": "Windows",
                    "color": "blueDark"
                  },
                  {
                    "seriesName": "Other",
                    "color": "gray"
                  }
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 0,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true
                    }
                  }
                }
              }
            },
            "customWidth": "65",
            "showPin": true,
            "name": "query - 4"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let baseQuery = materialize(SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)   \r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\" \r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n);\r\nlet totalCount = toscalar(baseQuery | count);\r\nbaseQuery\r\n|summarize Count = count(AuthMethod) * 100.0 /totalCount by DeviceState\r\n",
              "size": 3,
              "showAnalytics": true,
              "title": "% Authentication prompts by device state",
              "timeContext": {
                "durationMs": 604800000
              },
              "timeContextFromParameter": "Time",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "piechart",
              "tileSettings": {
                "showBorder": false,
                "titleContent": {
                  "columnMatch": "DeviceState",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "Count",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "chartSettings": {
                "yAxis": [
                  "Count"
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 1,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true,
                      "maximumFractionDigits": 1
                    }
                  }
                }
              }
            },
            "customWidth": "35",
            "showPin": true,
            "name": "query - 5"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)\r\n    |extend SuccessfulSignin = ParsedFields.succeeded   \r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\" \r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n|summarize Count = count(AuthMethod) by bin(TimeGenerated, 1h), DeviceState",
              "size": 0,
              "showAnalytics": true,
              "title": "Hourly authentication prompts by device state",
              "timeContext": {
                "durationMs": 604800000
              },
              "timeContextFromParameter": "Time",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "barchart",
              "tileSettings": {
                "showBorder": false,
                "titleContent": {
                  "columnMatch": "DeviceState",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "Count",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "Unmanaged",
                    "color": "blue"
                  },
                  {
                    "seriesName": "Hybrid Azure AD joined",
                    "color": "turquoise"
                  },
                  {
                    "seriesName": "Azure AD registered",
                    "color": "magenta"
                  }
                ]
              }
            },
            "customWidth": "65",
            "showPin": true,
            "name": "query - 6"
          },
          {
            "type": 1,
            "content": {
              "json": "# Authentication prompts by user\r\n### Tip: To investigate the top prompted users, filter this report by user"
            },
            "name": "text - 5"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let baseQuery = materialize(\r\nSigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n|extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n|extend AuthMethod = tostring(AuthenticationMethod)\r\n|extend ParsedFields2=parse_json(DeviceDetail)\r\n|extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\"\r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState})\r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\")\r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n);\r\nlet totalCount = toscalar(baseQuery | count);\r\nbaseQuery\r\n|summarize Count = count(AuthMethod) * 100.0 /totalCount by UserDisplayName",
              "size": 3,
              "showAnalytics": true,
              "title": "% Authentication prompts by user",
              "timeContext": {
                "durationMs": 604800000
              },
              "timeContextFromParameter": "Time",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "Other",
                    "label": "All Other Users",
                    "color": "blueDark"
                  },
                  {
                    "seriesName": "On-Premises Directory Synchronization Service Account",
                    "color": "gray"
                  },
                  {
                    "seriesName": "Adam Steenwyk",
                    "color": "blue"
                  },
                  {
                    "seriesName": "Adrian Drumea",
                    "color": "orange"
                  },
                  {
                    "seriesName": "Abigail Brown",
                    "color": "purple"
                  },
                  {
                    "seriesName": "Abhijeet Kumar Sinha",
                    "color": "red"
                  },
                  {
                    "seriesName": "Tracy Shi",
                    "color": "magenta"
                  }
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 1,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true,
                      "maximumFractionDigits": 1
                    }
                  }
                }
              }
            },
            "customWidth": "35",
            "showPin": true,
            "name": "query - 7"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)\r\n    |extend SuccessfulSignin = ParsedFields.succeeded   \r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\"\r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n| summarize CountPrompts = count(AuthMethod) by bin(TimeGenerated,1h), UserDisplayName\r\n\r\n",
              "size": 0,
              "showAnalytics": true,
              "title": "Hourly authentication prompts by user",
              "timeContext": {
                "durationMs": 604800000
              },
              "timeContextFromParameter": "Time",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "barchart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "Other",
                    "label": "All Other Users",
                    "color": "blueDark"
                  },
                  {
                    "seriesName": "On-Premises Directory Synchronization Service Account",
                    "color": "gray"
                  },
                  {
                    "seriesName": "Adam Steenwyk",
                    "color": "blue"
                  },
                  {
                    "seriesName": "Adrian Drumea",
                    "color": "orange"
                  },
                  {
                    "seriesName": "Abigail Brown",
                    "color": "magenta"
                  },
                  {
                    "seriesName": "Abhijeet Kumar Sinha",
                    "color": "red"
                  }
                ]
              }
            },
            "customWidth": "65",
            "showPin": true,
            "name": "query - 8"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)\r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n    |extend OperatingSystem = ParsedFields2.operatingSystem\r\n    |extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\"\r\n    and  AuthMethod != \"\"\r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n|summarize CountPrompts = count(AuthMethod) by UserDisplayName, AppDisplayName, AuthStatus\r\n|order by CountPrompts desc\r\n\r\n\r\n\r\n",
              "size": 1,
              "showAnalytics": true,
              "title": "Authentication prompts per user",
              "timeContext": {
                "durationMs": 604800000
              },
              "timeContextFromParameter": "Time",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "UserDisplayName",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "60ch"
                    }
                  },
                  {
                    "columnMatch": "AppDisplayName",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    }
                  },
                  {
                    "columnMatch": "AuthStatus",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    }
                  },
                  {
                    "columnMatch": "CountPrompts",
                    "formatter": 1,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "100",
            "showPin": true,
            "name": "query - 9"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)   \r\n|extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\"\r\n    and  AuthMethod != \"\"\r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})  \r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState})\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n|project AuthMethod, CorrelationId, UserId\r\n|summarize CountPrompts = count(AuthMethod), DistinctUsers = dcount(UserId), DistinctCorrelationIds = dcount(CorrelationId)\r\n|extend AvgeragePromptperUser = toreal(CountPrompts)/toreal(DistinctUsers)\r\n|project AvgeragePromptperUser\r\n\r\n\r\n\r\n",
              "size": 3,
              "title": "Average authentication prompts per user",
              "timeContext": {
                "durationMs": 604800000
              },
              "timeContextFromParameter": "Time",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "AvgeragePromptperUser",
                    "formatter": 1,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal",
                        "maximumFractionDigits": 0
                      }
                    }
                  }
                ],
                "sortBy": [
                  {
                    "itemKey": "$gen_number_AvgeragePromptperUser_0",
                    "sortOrder": 1
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "AvgeragePromptperUser",
                    "label": "Average"
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "$gen_number_AvgeragePromptperUser_0",
                  "sortOrder": 1
                }
              ],
              "tileSettings": {
                "showBorder": false
              },
              "chartSettings": {
                "yAxis": [
                  "Count"
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 0,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true
                    }
                  }
                }
              }
            },
            "customWidth": "40",
            "showPin": true,
            "name": "query - 10"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)   \r\n|extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\"\r\n    and  AuthMethod != \"\"\r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})  \r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState})\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n| summarize CountPrompts = count(AuthMethod) by UserDisplayName\r\n| summarize percentiles(CountPrompts,50,80)\r\n| project  Median = percentile_CountPrompts_50\r\n\r\n\r\n\r\n",
              "size": 4,
              "title": "Median authentication prompts per user",
              "timeContext": {
                "durationMs": 604800000
              },
              "timeContextFromParameter": "Time",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Median",
                    "formatter": 1
                  },
                  {
                    "columnMatch": "AvgeragePromptperApp",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal",
                        "maximumFractionDigits": 0
                      }
                    }
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "Median",
                    "label": "Median"
                  }
                ]
              },
              "tileSettings": {
                "showBorder": false
              },
              "chartSettings": {
                "yAxis": [
                  "Count"
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 0,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true
                    }
                  }
                }
              }
            },
            "customWidth": "35",
            "showPin": true,
            "name": "query - 11"
          },
          {
            "type": 1,
            "content": {
              "json": "Note: A high count of failures per user can skew the average so consider both the average and the median when analyzing the data. The median represents the 50th percentile, where 50% of the users  have prompts equal to or less than the median value."
            },
            "customWidth": "25",
            "name": "text - 6"
          },
          {
            "type": 1,
            "content": {
              "json": "# Authentication prompts by application\r\n### Tip: To investigate the top prompted apps, filter this report by AppID and look at “Authentication policy” graph to understand what triggers multiple authentication requests."
            },
            "name": "text - 7"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let baseQuery = materialize(SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)  \r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\"\r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n);\r\nlet totalCount = toscalar(baseQuery | count);\r\nbaseQuery\r\n|summarize Count = count(AuthMethod) * 100.0 /totalCount by AppDisplayName\r\n\r\n",
              "size": 3,
              "showAnalytics": true,
              "title": "% Authenticaton prompts by app",
              "timeContext": {
                "durationMs": 604800000
              },
              "timeContextFromParameter": "Time",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "piechart",
              "gridSettings": {
                "sortBy": [
                  {
                    "itemKey": "CountPrompts",
                    "sortOrder": 2
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "CountPrompts",
                  "sortOrder": 2
                }
              ],
              "chartSettings": {
                "yAxis": [
                  "Count"
                ],
                "seriesLabelSettings": [
                  {
                    "seriesName": "Azure Portal",
                    "color": "blue"
                  },
                  {
                    "seriesName": "My Apps",
                    "color": "blueDark"
                  },
                  {
                    "seriesName": "Microsoft Graph PowerShell",
                    "color": "orange"
                  },
                  {
                    "seriesName": "Microsoft Teams Web Client",
                    "color": "gray"
                  },
                  {
                    "seriesName": "Microsoft Authenticator App",
                    "color": "greenDark"
                  },
                  {
                    "seriesName": "Other",
                    "label": "All Other Apps",
                    "color": "purple"
                  },
                  {
                    "seriesName": "Office 365 Exchange Online",
                    "color": "orange"
                  },
                  {
                    "seriesName": "My Access",
                    "color": "pink"
                  },
                  {
                    "seriesName": "Azure Active Directory PowerShell",
                    "color": "purple"
                  }
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 1,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true,
                      "maximumFractionDigits": 1
                    }
                  }
                }
              }
            },
            "customWidth": "35",
            "showPin": true,
            "name": "query - 12"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)\r\n    |extend SuccessfulSignin = ParsedFields.succeeded   \r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\" \r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n| summarize CountPrompts = count(AuthMethod) by bin(TimeGenerated, 1h), AppDisplayName\r\n",
              "size": 0,
              "showAnalytics": true,
              "title": "Hourly authentication prompts by application",
              "timeContext": {
                "durationMs": 604800000
              },
              "timeContextFromParameter": "Time",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "barchart",
              "gridSettings": {
                "sortBy": [
                  {
                    "itemKey": "CountPrompts",
                    "sortOrder": 2
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "CountPrompts",
                  "sortOrder": 2
                }
              ],
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "Azure Portal",
                    "color": "blue"
                  },
                  {
                    "seriesName": "My Apps",
                    "color": "purple"
                  },
                  {
                    "seriesName": "Microsoft Graph PowerShell",
                    "color": "blueDark"
                  },
                  {
                    "seriesName": "Microsoft Teams Web Client",
                    "color": "lightBlue"
                  },
                  {
                    "seriesName": "Microsoft Authenticator App",
                    "color": "greenDark"
                  },
                  {
                    "seriesName": "Other",
                    "label": "All Other Apps",
                    "color": "red"
                  },
                  {
                    "seriesName": "Office 365 Exchange Online",
                    "color": "orange"
                  },
                  {
                    "seriesName": "My Access",
                    "color": "pink"
                  },
                  {
                    "seriesName": "Azure Active Directory PowerShell",
                    "color": "magenta"
                  }
                ]
              }
            },
            "customWidth": "65",
            "showPin": true,
            "name": "query - 13"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)   \r\n|extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\"\r\n    and  AuthMethod != \"\"\r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})  \r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState})\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n|project AuthMethod, CorrelationId, AppDisplayName, AuthStatus\r\n|summarize CountPrompts = count(AuthMethod) by AppDisplayName, AuthStatus\r\n\r\n\r\n\r\n\r\n",
              "size": 1,
              "showAnalytics": true,
              "title": "Authentication prompts per application",
              "timeContext": {
                "durationMs": 604800000
              },
              "timeContextFromParameter": "Time",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "AppDisplayName",
                    "formatter": 1,
                    "formatOptions": {
                      "customColumnWidthSetting": "60ch"
                    }
                  },
                  {
                    "columnMatch": "AuthStatus",
                    "formatter": 1,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    }
                  },
                  {
                    "columnMatch": "CountPrompts",
                    "formatter": 1,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    }
                  }
                ],
                "filter": true,
                "sortBy": [
                  {
                    "itemKey": "CountPrompts",
                    "sortOrder": 2
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "AppDisplayName",
                    "label": "Application display name"
                  },
                  {
                    "columnId": "AuthStatus",
                    "label": "Authentication status"
                  },
                  {
                    "columnId": "CountPrompts",
                    "label": "Count of pormpts"
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "CountPrompts",
                  "sortOrder": 2
                }
              ]
            },
            "customWidth": "100",
            "showPin": true,
            "name": "query - 14"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)   \r\n|extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\"\r\n    and  AuthMethod != \"\"\r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})  \r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState})\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n|project AuthMethod, CorrelationId, AppDisplayName\r\n|summarize CountPrompts = count(AuthMethod), DistinctApps = dcount(AppDisplayName), DistinctCorrelationIds = dcount(CorrelationId)\r\n|extend AvgeragePromptperApp = toreal(CountPrompts)/toreal(DistinctApps)\r\n|project AvgeragePromptperApp\r\n\r\n\r\n\r\n",
              "size": 4,
              "title": "Average authentication prompts per app",
              "timeContext": {
                "durationMs": 604800000
              },
              "timeContextFromParameter": "Time",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "AvgeragePromptperApp",
                    "formatter": 1,
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal",
                        "maximumFractionDigits": 0
                      }
                    }
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "AvgeragePromptperApp",
                    "label": "Average"
                  }
                ]
              },
              "tileSettings": {
                "showBorder": false
              },
              "chartSettings": {
                "yAxis": [
                  "Count"
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 0,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true
                    }
                  }
                }
              }
            },
            "customWidth": "35",
            "showPin": true,
            "name": "query - 15"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)   \r\n|extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\"\r\n    and  AuthMethod != \"\"\r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})  \r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState})\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n| summarize CountPrompts = count(AuthMethod) by AppDisplayName\r\n| summarize percentiles(CountPrompts,50,80)\r\n| project  Median = percentile_CountPrompts_50\r\n\r\n\r\n\r\n",
              "size": 4,
              "title": "Median authentication prompts per app",
              "timeContext": {
                "durationMs": 604800000
              },
              "timeContextFromParameter": "Time",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Median",
                    "formatter": 1
                  },
                  {
                    "columnMatch": "AvgeragePromptperApp",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal",
                        "maximumFractionDigits": 0
                      }
                    }
                  }
                ]
              },
              "tileSettings": {
                "showBorder": false
              },
              "chartSettings": {
                "yAxis": [
                  "Count"
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 0,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true
                    }
                  }
                }
              }
            },
            "customWidth": "35",
            "showPin": true,
            "name": "query - 16"
          },
          {
            "type": 1,
            "content": {
              "json": "Note: A high count of failures per application can skew the average so consider both the average and the median when analyzing the data. The median represents the 50th percentile, where 50% of the applications have prompts equal to or less than the median value."
            },
            "customWidth": "25",
            "name": "text - 8"
          },
          {
            "type": 1,
            "content": {
              "json": "# Authentications by policy\r\n### Authentication policies describe how MFA is enforced and can include Conditional Acces, Security Defaults, Per User MFA, App requires MFA, and others. \r\n\r\n### \"App requires MFA\" occurs when the application itself enforce the policy and requires a fresh MFA.\r\n"
            },
            "name": "text - 9"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let baseQuery = materialize(SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)\r\n    |extend SuccessfulSignin = ParsedFields.succeeded   \r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|mv-expand ParsedFields3 = parse_json(AuthenticationRequirementPolicies)\r\n    |extend AuthReqPolicy = ParsedFields3.detail\r\n    |extend AuthPolicy = tostring(AuthReqPolicy)\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\" \r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n);\r\nlet totalCount = toscalar(baseQuery | count);\r\nbaseQuery\r\n|summarize Count = count(AuthMethod) * 100.0 /totalCount by AuthPolicy\r\n",
              "size": 3,
              "showAnalytics": true,
              "title": "% Authentication by policy type",
              "timeContext": {
                "durationMs": 604800000
              },
              "timeContextFromParameter": "Time",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "piechart",
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "AuthPolicy",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "Count",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                },
                "showBorder": false
              },
              "chartSettings": {
                "yAxis": [
                  "Count"
                ],
                "createOtherGroup": null,
                "seriesLabelSettings": [
                  {
                    "seriesName": "App requires MFA",
                    "label": "Client-side policy (App requires MFA)",
                    "color": "orange"
                  },
                  {
                    "seriesName": "Conditional Access",
                    "color": "blue"
                  },
                  {
                    "seriesName": "Identity Protection",
                    "color": "blueDark"
                  }
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 1,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true,
                      "maximumFractionDigits": 1
                    }
                  }
                }
              }
            },
            "customWidth": "35",
            "showPin": true,
            "name": "query - 17"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)\r\n    |extend SuccessfulSignin = ParsedFields.succeeded   \r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|mv-expand ParsedFields3 = parse_json(AuthenticationRequirementPolicies)\r\n    |extend AuthReqPolicy = ParsedFields3.detail\r\n    |extend AuthPolicy = tostring(AuthReqPolicy)\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\" \r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n|summarize Count = count(AuthMethod) by bin(TimeGenerated,1h),AuthPolicy\r\n",
              "size": 0,
              "title": "Hourly prompts by authentication policy",
              "timeContext": {
                "durationMs": 604800000
              },
              "timeContextFromParameter": "Time",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "barchart",
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "AuthPolicy",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "Count",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                },
                "showBorder": false
              },
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "Conditional Access",
                    "color": "blue"
                  },
                  {
                    "seriesName": "Identity Protection",
                    "color": "blueDark"
                  },
                  {
                    "seriesName": "App requires MFA",
                    "label": "Client-side policy (App requires MFA)",
                    "color": "orange"
                  }
                ]
              }
            },
            "customWidth": "65",
            "name": "query - 18"
          },
          {
            "type": 1,
            "content": {
              "json": "# ADFS Authentications"
            },
            "name": "text - 10"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let baseQuery = materialize(ADFSSignInLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)\r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n);\r\nlet totalCount = toscalar(baseQuery | count);\r\nbaseQuery\r\n|summarize Count = count(AuthMethod) * 100.0 /totalCount by AuthMethod",
              "size": 3,
              "showAnalytics": true,
              "title": "% ADFS  authentications by method",
              "timeContext": {
                "durationMs": 604800000
              },
              "timeContextFromParameter": "Time",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "piechart",
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "AuthPolicy",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "Count",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                },
                "showBorder": false
              },
              "chartSettings": {
                "yAxis": [
                  "Count"
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 1,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true,
                      "maximumFractionDigits": 1
                    }
                  }
                }
              }
            },
            "customWidth": "35",
            "showPin": true,
            "name": "query - 19"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "ADFSSignInLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)\r\n|summarize Count = count(AuthMethod) by bin(TimeGenerated,1h)\r\n",
              "size": 0,
              "title": "Hourly ADFS authentications",
              "timeContext": {
                "durationMs": 604800000
              },
              "timeContextFromParameter": "Time",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "barchart",
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "AuthPolicy",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "Count",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                },
                "showBorder": false
              }
            },
            "customWidth": "65",
            "name": "query - 20"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let ADFSAuth = toscalar(\r\nADFSSignInLogs\r\n| summarize ADFSCount = count());\r\nSigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)\r\n    |extend SuccessfulSignin = ParsedFields.succeeded   \r\n|mv-expand ParsedFields3 = parse_json(AuthenticationRequirementPolicies)\r\n    |extend AuthReqPolicy = ParsedFields3.detail\r\n    |extend AuthPolicy = tostring(AuthReqPolicy)\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\" \r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n|summarize ['Conditional Access'] = countif(AuthPolicy == \"Conditional Access\"),['Identity Protection'] = countif(AuthPolicy == \"Identity Protection\"), ['Client-side policy (App requires MFA)'] = countif(AuthPolicy == \"App requires MFA\")\r\n|project ['Conditional Access'], ['Identity Protection'], ['Client-side policy (App requires MFA)'], ADFSAuth",
              "size": 3,
              "showAnalytics": true,
              "title": "Summary of count by authentication policy",
              "timeContext": {
                "durationMs": 604800000
              },
              "timeContextFromParameter": "Time",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Conditional Access",
                    "formatter": 1,
                    "formatOptions": {
                      "customColumnWidthSetting": "30ch"
                    }
                  },
                  {
                    "columnMatch": "Identity Protection",
                    "formatter": 1,
                    "formatOptions": {
                      "customColumnWidthSetting": "30ch"
                    }
                  },
                  {
                    "columnMatch": "Client-side policy (App requires MFA)",
                    "formatter": 1,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    }
                  },
                  {
                    "columnMatch": "ADFSAuth",
                    "formatter": 1,
                    "formatOptions": {
                      "customColumnWidthSetting": "30ch"
                    }
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "ADFSAuth",
                    "label": "ADFS authentication"
                  }
                ]
              },
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "AuthPolicy",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "Count",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                },
                "showBorder": false
              },
              "chartSettings": {
                "createOtherGroup": 10
              }
            },
            "customWidth": "100",
            "showPin": true,
            "name": "query - 21"
          },
          {
            "type": 1,
            "content": {
              "json": "# Insights"
            },
            "name": "text - 11"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "## Managed devices\r\n\r\nFor improved user experience, we to enable single sign-on using managed devices. Learn more: Plan your Azure Active Directory device deployment | Microsoft Docs - https://docs.microsoft.com/en-us/azure/active-directory/devices/plan-device-deployment"
                  },
                  "customWidth": "55",
                  "name": "text - 12"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)   \r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n    |extend DeviceId = ParsedFields2.deviceId\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\" \r\n|summarize TotalDeviceCount = count(tostring(DeviceDetail)), ManagedCount = countif(DeviceState != \"Unmanaged\")\r\n|project ['% Managed Devices'] = (1.0 * ManagedCount / TotalDeviceCount), ['# Managed Devices'] = ManagedCount",
                    "size": 3,
                    "title": "Managed Devices",
                    "timeContext": {
                      "durationMs": 604800000
                    },
                    "timeContextFromParameter": "Time",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workbook}"
                    ],
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "% Managed Devices",
                          "formatter": 1,
                          "formatOptions": {
                            "customColumnWidthSetting": "35ch"
                          },
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "percent",
                              "minimumFractionDigits": 2
                            }
                          }
                        },
                        {
                          "columnMatch": "# Managed Devices",
                          "formatter": 1,
                          "formatOptions": {
                            "customColumnWidthSetting": "35ch"
                          }
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "% Managed Devices",
                          "label": "% Managed devices"
                        },
                        {
                          "columnId": "# Managed Devices",
                          "label": "# Managed devices"
                        }
                      ]
                    },
                    "tileSettings": {
                      "showBorder": false
                    }
                  },
                  "customWidth": "45",
                  "name": "query - 22"
                },
                {
                  "type": 1,
                  "content": {
                    "json": "## Windows Hello for Business\r\n\r\nTo reduce authentication prompts and improve user experience on Windows 10 and above, we recommend using Windows Hello for Business. Learn more: Windows Hello for Business Overview - Microsoft 365 Security | Microsoft Docs - https://docs.microsoft.com/en-us/windows/security/identity-protection/hello-for-business/hello-overview"
                  },
                  "customWidth": "55",
                  "name": "text - 13"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)   \r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\" //and AuthMethod != \"Password\"\r\n|where OS contains \"Windows\" or OS contains \"windows\"\r\n|summarize TotalCountWindows = count(), WHFBCount = countif(AuthMethod contains \"Windows Hello for Business\")\r\n|project ['% WHFB'] = (1.0 * WHFBCount / TotalCountWindows), ['# Windows Devices']= TotalCountWindows",
                    "size": 3,
                    "title": "WHFB authentications",
                    "timeContext": {
                      "durationMs": 604800000
                    },
                    "timeContextFromParameter": "Time",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workbook}"
                    ],
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "% WHFB",
                          "formatter": 1,
                          "formatOptions": {
                            "customColumnWidthSetting": "35ch"
                          },
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "percent",
                              "maximumFractionDigits": 2
                            }
                          }
                        },
                        {
                          "columnMatch": "# Windows Devices",
                          "formatter": 1,
                          "formatOptions": {
                            "customColumnWidthSetting": "35ch"
                          }
                        },
                        {
                          "columnMatch": "% Unmanaged Devices",
                          "formatter": 1,
                          "formatOptions": {
                            "customColumnWidthSetting": "35ch"
                          },
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal",
                              "maximumFractionDigits": 1
                            }
                          }
                        },
                        {
                          "columnMatch": "Percent of Unmanaged Devices",
                          "formatter": 1,
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal",
                              "maximumFractionDigits": 1
                            }
                          }
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "# Windows Devices",
                          "label": "# of Windows devices"
                        }
                      ]
                    },
                    "tileSettings": {
                      "showBorder": false
                    }
                  },
                  "customWidth": "45",
                  "name": "query - 23",
                  "styleSettings": {
                    "margin": "0"
                  }
                },
                {
                  "type": 1,
                  "content": {
                    "json": "## Android / iOS\r\n\r\nThe Authenticator app serves as a token broker and can reduce authentication prompts. For improved user experience and reduce prompts on mobile devices, we recommend using the Microsoft Authenticator. Learn more: Microsoft Authenticator app authentication method - Azure Active Directory | Microsoft Docs - https://docs.microsoft.com/en-us/azure/active-directory/authentication/concept-authentication-authenticator-app"
                  },
                  "customWidth": "55",
                  "name": "text - 14"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)   \r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\" \r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n|extend AuthAppOpp = case(AuthMethod == \"Phone call approval (Authentication phone)\", \"Opportunity\", AuthMethod == \"Text message\", \"Opportunity\", AuthMethod == \"Mobile app notification\", \"Opportunity\",\"StrongAuth\")\r\n|summarize TotalCount = count(), TotalAuthAppOpp = countif(AuthAppOpp != \"StrongAuth\"), AuthenticatorApp = countif(AuthMethod contains \"Mobile app notification\")\r\n|project ['% Authenticator App Sign-Ins'] = (1.0 * AuthenticatorApp/TotalAuthAppOpp)\r\n",
                    "size": 3,
                    "title": "Authenticator app sign-ins on mobile",
                    "timeContext": {
                      "durationMs": 604800000
                    },
                    "timeContextFromParameter": "Time",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workbook}"
                    ],
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "% Authenticator App Sign-Ins",
                          "formatter": 1,
                          "formatOptions": {
                            "customColumnWidthSetting": "60%"
                          },
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "percent",
                              "maximumFractionDigits": 2
                            }
                          }
                        },
                        {
                          "columnMatch": "% Unmanaged Devices",
                          "formatter": 1,
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal",
                              "maximumFractionDigits": 1
                            }
                          }
                        },
                        {
                          "columnMatch": "Percent of Unmanaged Devices",
                          "formatter": 0,
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal",
                              "maximumFractionDigits": 1
                            }
                          }
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "% Authenticator App Sign-Ins",
                          "label": "% Authenticator app sign-ins"
                        }
                      ]
                    },
                    "tileSettings": {
                      "showBorder": false
                    }
                  },
                  "customWidth": "45",
                  "name": "query - 24"
                },
                {
                  "type": 1,
                  "content": {
                    "json": "## MacOS\r\n\r\nOn MacOs we recommend the Microsoft Enterprise SSO plug-in for Apple devices. http://aka.ms/AADAppleSSO\r\n\r\n"
                  },
                  "customWidth": "55",
                  "name": "text - 15"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)\r\n    |extend SuccessfulSignin = ParsedFields.succeeded   \r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\"\r\n|where OS contains \"MacOs\" or OS contains \"Mac\"\r\n|summarize TotalMacCount = count() by UserDisplayName\r\n|summarize ['Avg Prompts Per Mac User'] = avg(TotalMacCount)\r\n|project ['Avg Prompts Per Mac User'] ",
                    "size": 3,
                    "title": " MacOS user authentication prompts",
                    "timeContext": {
                      "durationMs": 604800000
                    },
                    "timeContextFromParameter": "Time",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workbook}"
                    ],
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Avg Prompts Per Mac User",
                          "formatter": 1,
                          "formatOptions": {
                            "customColumnWidthSetting": "30ch"
                          },
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal",
                              "maximumFractionDigits": 2
                            }
                          }
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "Avg Prompts Per Mac User",
                          "label": "Average prompts per Mac user"
                        }
                      ]
                    }
                  },
                  "customWidth": "45",
                  "name": "query - 25"
                }
              ]
            },
            "name": "group - 5"
          }
        ]
      },
      "customWidth": "100",
      "name": "group - 19"
    }
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
