{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "# Authentication Prompts Analysis \r\n\r\nUse this workbook to better understand how frequent users in your tenant are getting prompted for reauthentication and gain insights on how to reduce multi-factor (MFA) prompts based on the devices, authentication methods and applications users are using.\r\n\r\nTip: If the graphs below are not rendering, make sure you have selected a working Log Analytics Workspace and Subscription in the filters below.\r\n\r\n"
            },
            "name": "text - 1"
          },
          {
            "type": 1,
            "content": {
              "json": "## Filters"
            },
            "name": "text - 2"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "a73b569b-6b9a-4980-9def-c8ee8add51f0",
                  "version": "KqlParameterItem/1.0",
                  "name": "Workbook",
                  "type": 5,
                  "isRequired": true,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "value": [
                    "value::all"
                  ],
                  "typeSettings": {
                    "resourceTypeFilter": {
                      "microsoft.operationalinsights/workspaces": true
                    },
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "showDefault": false
                  },
                  "defaultValue": "value::all",
                  "label": "Workspace"
                },
                {
                  "id": "3db1324f-e565-4b23-9992-46fe4ba3909d",
                  "version": "KqlParameterItem/1.0",
                  "name": "Subscription",
                  "type": 6,
                  "isRequired": true,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "value": [
                    "value::all"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "includeAll": false,
                    "showDefault": false
                  }
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "parameters - 4"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "4ce4eed0-580a-4ec2-9043-3872fafcdd0f",
                  "version": "KqlParameterItem/1.0",
                  "name": "Time",
                  "type": 4,
                  "isRequired": true,
                  "value": {
                    "durationMs": 604800000
                  },
                  "typeSettings": {
                    "selectableValues": [
                      {
                        "durationMs": 3600000
                      },
                      {
                        "durationMs": 86400000
                      },
                      {
                        "durationMs": 604800000
                      },
                      {
                        "durationMs": 2592000000
                      },
                      {
                        "durationMs": 7776000000
                      }
                    ]
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "d90371c2-48fc-460f-8368-c81c220a37a7",
                  "version": "KqlParameterItem/1.0",
                  "name": "AuthMethod",
                  "type": 2,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "showDefault": false
                  },
                  "jsonData": "[\r\n    { \"value\":\"Password\", \"label\":\"Password\" },\r\n    { \"value\":\"Previously satisfied\", \"label\":\"Previously Satisfied\" },\r\n    { \"value\":\"X.509 Certificate\", \"label\":\"X.509 Certificate\" },\r\n    { \"value\":\"Mobile app notification\", \"label\":\"Mobile App Notification\"},\r\n    { \"value\":\"Text message\", \"label\":\"Text Message\" },\r\n    { \"value\":\"Phone call approval (Authentication phone)\", \"label\":\"Phone Call Approval\" },\r\n    { \"value\":\"Windows Hello for Business\", \"label\":\"Windows Hello for Business\"},\r\n    { \"value\":\"OAUTH verification code\", \"label\":\"Passwordless\"},\r\n    { \"value\":\"Phone call approval (Office phone)\", \"label\":\"Office Phone Call Approval\"},\r\n    { \"value\":\"FIDO2 security key\", \"label\":\"FIDO2 Security Key\" },\r\n    { \"value\":\"Temporary Access Pass\", \"label\":\"Temporary Access Pass\" },\r\n    { \"value\":\"Passwordless phone sign-in\", \"label\":\"Passwordless Phone SignIn\",\"selected\":true }\r\n]",
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "timeContextFromParameter": "Time",
                  "defaultValue": "value::all",
                  "value": [
                    "value::all"
                  ]
                },
                {
                  "id": "d0572ef9-28b3-43b2-94aa-2a2550ac799b",
                  "version": "KqlParameterItem/1.0",
                  "name": "DeviceState",
                  "type": 2,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "showDefault": false
                  },
                  "jsonData": "[\r\n    { \"value\":\"Unmanaged\", \"label\":\"Unmanaged\" },\r\n    { \"value\":\"Azure AD registered\", \"label\":\"Azure AD registered\" },\r\n     { \"value\":\"Azure AD joined\", \"label\":\"Azure AD Joined\" },\r\n    { \"value\":\"Hybrid Azure AD joined\", \"label\":\"Hybrid Azure AD joined\", \"selected\":true }\r\n]",
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "defaultValue": "value::all",
                  "value": [
                    "value::all"
                  ]
                },
                {
                  "id": "6df9b54e-5fdd-43bd-8686-ec78f74383ab",
                  "version": "KqlParameterItem/1.0",
                  "name": "App",
                  "type": 1,
                  "description": "Default value is All apps",
                  "value": "",
                  "timeContext": {
                    "durationMs": 604800000
                  },
                  "timeContextFromParameter": "Time",
                  "defaultValue": "value::all"
                },
                {
                  "id": "adfbe329-1f53-4edb-ba08-6e9002bf9be0",
                  "version": "KqlParameterItem/1.0",
                  "name": "User",
                  "type": 1,
                  "description": "Default value is All users",
                  "value": "",
                  "timeContext": {
                    "durationMs": 604800000
                  },
                  "timeContextFromParameter": "Time",
                  "defaultValue": "value::all"
                },
                {
                  "id": "77c07866-4973-42d5-b697-446f44da5724",
                  "version": "KqlParameterItem/1.0",
                  "name": "AuthStatus",
                  "type": 2,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "showDefault": false
                  },
                  "jsonData": "[\r\n    { \"value\":\"Success\", \"label\":\"Success\" },\r\n    { \"value\":\"Failure\", \"label\":\"Failure\", \"selected\":true }\r\n]",
                  "timeContext": {
                    "durationMs": 604800000
                  },
                  "timeContextFromParameter": "Time",
                  "defaultValue": "value::all"
                },
                {
                  "id": "c8b2d139-eb66-40ff-9e51-79cc4588f7c8",
                  "version": "KqlParameterItem/1.0",
                  "name": "OS",
                  "type": 1,
                  "description": "Default value is All OS",
                  "timeContext": {
                    "durationMs": 604800000
                  },
                  "timeContextFromParameter": "Time"
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "customWidth": "100",
            "name": "parameters - 13",
            "styleSettings": {
              "margin": "0"
            }
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "## Authentication Prompts Summary"
                  },
                  "name": "text - 2"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let TotalAuthPrompts = SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)\r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n    |extend OperatingSystem = ParsedFields2.operatingSystem\r\n    |extend OS = tostring(OperatingSystem)\r\n    |extend Status = ParsedFields.succeeded\r\n    |extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\")\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n| where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus}) \r\n|where AuthMethod != \"Previously satisfied\"\r\n    and  AuthMethod != \"\"\r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\";\r\nlet AuthPromptSummary = TotalAuthPrompts | summarize Stage = \"Total authentication prompts\", CountPrompts=count();\r\nlet SuccessPrompts = TotalAuthPrompts|where AuthStatus == \"Success\";\r\nlet SuccessSummary = SuccessPrompts | summarize Stage = \"Successes\", CountPrompts=count();\r\nlet FailurePrompts = TotalAuthPrompts| where AuthStatus != \"Success\";\r\nlet FailureSummary = FailurePrompts| summarize Stage = \"Failures\", CountPrompts=count();\r\nlet RequestIDCount = TotalAuthPrompts |distinct OriginalRequestId |summarize Stage = \"Original RequestIDs\", CountPrompts=count();\r\nunion AuthPromptSummary,SuccessSummary,FailureSummary\r\n|sort by CountPrompts desc\r\n\r\n",
                    "size": 3,
                    "color": "blue",
                    "timeContext": {
                      "durationMs": 0
                    },
                    "timeContextFromParameter": "Time",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workbook}"
                    ],
                    "visualization": "tiles",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "UserDisplayName",
                          "formatter": 0,
                          "formatOptions": {
                            "customColumnWidthSetting": "25ch"
                          }
                        },
                        {
                          "columnMatch": "AppDisplayName",
                          "formatter": 0,
                          "formatOptions": {
                            "customColumnWidthSetting": "30ch"
                          }
                        },
                        {
                          "columnMatch": "SigninStatus",
                          "formatter": 0,
                          "formatOptions": {
                            "customColumnWidthSetting": "20ch"
                          }
                        },
                        {
                          "columnMatch": "CountPrompts",
                          "formatter": 2,
                          "formatOptions": {
                            "customColumnWidthSetting": "20ch"
                          }
                        }
                      ]
                    },
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "Stage",
                        "formatter": 3,
                        "formatOptions": {
                          "palette": "blue"
                        },
                        "numberFormat": {
                          "unit": 0,
                          "options": {
                            "style": "decimal"
                          }
                        }
                      },
                      "leftContent": {
                        "columnMatch": "CountPrompts",
                        "formatter": 12,
                        "formatOptions": {
                          "min": 0,
                          "max": 1,
                          "palette": "blue"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "maximumFractionDigits": 1,
                            "maximumSignificantDigits": 3
                          }
                        }
                      },
                      "showBorder": false,
                      "sortCriteriaField": "Stage",
                      "sortOrderField": 2,
                      "size": "auto"
                    }
                  },
                  "showPin": false,
                  "name": "query - 13"
                },
                {
                  "type": 1,
                  "content": {
                    "json": "Count of authentication methods excludes \"previously satisfied\" and \"unknown\" methods.",
                    "style": "warning"
                  },
                  "customWidth": "45",
                  "name": "text - 39"
                }
              ]
            },
            "name": "Tiles"
          },
          {
            "type": 1,
            "content": {
              "json": "## Authentication prompts by authentication method\r\nTo investigate methods causing the most prompts, filter this report by AuthMethod.\r\n"
            },
            "name": "text - 3"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let baseQuery = materialize(SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)   \r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\"\r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n);\r\nlet totalCount = toscalar(baseQuery | count);\r\nbaseQuery\r\n|summarize Count = count(AuthMethod) * 100.0 /totalCount by AuthMethod\r\n",
              "size": 3,
              "title": "% Prompts by method",
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "Time",
              "exportFieldName": "",
              "exportParameterName": "SelectedAuthMethod",
              "exportDefaultValue": "{ \"series\":\"All\"}",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "piechart",
              "gridSettings": {
                "sortBy": [
                  {
                    "itemKey": "AuthMethCount",
                    "sortOrder": 2
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "AuthMethCount",
                  "sortOrder": 2
                }
              ],
              "chartSettings": {
                "xAxis": "AuthMethod",
                "yAxis": [
                  "Count"
                ],
                "seriesLabelSettings": [
                  {
                    "seriesName": "Mobile app notification",
                    "label": "Authenticator App",
                    "color": "orange"
                  }
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 1,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true,
                      "maximumFractionDigits": 1
                    }
                  }
                }
              }
            },
            "customWidth": "35",
            "showPin": true,
            "name": "query - 1"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)\r\n| mv-expand ParsedMethod = parse_json(tostring('{SelectedAuthMethod}'))\r\n| extend SelectedAuthMethod = ParsedMethod.series\r\n    |where SelectedAuthMethod == 'All' or (AuthMethod == SelectedAuthMethod)\r\n    |where AuthMethod != '' \r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n    |extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\"\r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|extend Status = ParsedFields.succeeded\r\n    |extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n|where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n|where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n|where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|summarize AuthMethCount = count() by bin (TimeGenerated, 1d), AuthMethod",
              "size": 0,
              "showAnalytics": true,
              "title": "Daily prompts by method",
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "Time",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "unstackedbar",
              "chartSettings": {
                "yAxis": [
                  "AuthMethCount"
                ],
                "seriesLabelSettings": [
                  {
                    "seriesName": "Mobile app notification",
                    "label": "Authenticator App",
                    "color": "orange"
                  }
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 0,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true
                    }
                  }
                }
              }
            },
            "customWidth": "65",
            "showPin": true,
            "name": "query - 2"
          },
          {
            "type": 1,
            "content": {
              "json": "## Authentication prompts by device\r\nTo investigate the top prompted devices, filter this report by operating system and device.\r\n"
            },
            "name": "text - 4"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let baseQuery = materialize(SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)\r\n    |extend SuccessfulSignin = ParsedFields.succeeded   \r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\"\r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n);\r\nlet totalCount = toscalar(baseQuery | count);\r\nbaseQuery\r\n|summarize Count = count(AuthMethod) * 100.0 /totalCount by OS\r\n",
              "size": 3,
              "showAnalytics": true,
              "title": "% Prompts by operating system",
              "timeContext": {
                "durationMs": 604800000
              },
              "timeContextFromParameter": "Time",
              "exportParameterName": "SelectedOS",
              "exportDefaultValue": "{ \"series\":\"All OS\"}",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "yAxis": [
                  "Count"
                ],
                "seriesLabelSettings": [
                  {
                    "seriesName": "Windows 10",
                    "color": "blue"
                  },
                  {
                    "seriesName": "iOS 14",
                    "color": "pink"
                  },
                  {
                    "seriesName": "Android",
                    "color": "blueDark"
                  },
                  {
                    "seriesName": "MacOS",
                    "color": "turquoise"
                  },
                  {
                    "seriesName": "Windows 8",
                    "color": "purpleDark"
                  },
                  {
                    "seriesName": "",
                    "label": "Unknown OS",
                    "color": "orange"
                  },
                  {
                    "seriesName": "Windows",
                    "color": "greenDark"
                  },
                  {
                    "seriesName": "iOS 15",
                    "color": "purple"
                  },
                  {
                    "seriesName": "Other",
                    "color": "blueDarkDark"
                  }
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 1,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true,
                      "maximumFractionDigits": 1
                    }
                  }
                }
              }
            },
            "customWidth": "35",
            "showPin": true,
            "name": "query - 3"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)  \r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|mv-expand ParsedOS = parse_json(tostring('{SelectedOS}'))\r\n|extend SelectedOS = ParsedOS.series\r\n|where SelectedOS == 'All OS' or OS == SelectedOS and isnotempty(OS)\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\" \r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n|summarize Count = count(AuthMethod) by bin (TimeGenerated, 1h), OS\r\n\r\n\r\n\r\n\r\n",
              "size": 0,
              "showAnalytics": true,
              "title": "Hourly prompts by operating system",
              "timeContext": {
                "durationMs": 604800000
              },
              "timeContextFromParameter": "Time",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "barchart",
              "chartSettings": {
                "yAxis": [
                  "Count"
                ],
                "seriesLabelSettings": [
                  {
                    "seriesName": "Windows 10",
                    "color": "blue"
                  },
                  {
                    "seriesName": "iOS 14",
                    "color": "pink"
                  },
                  {
                    "seriesName": "MacOs",
                    "color": "turquoise"
                  },
                  {
                    "seriesName": "Android",
                    "color": "blueDark"
                  },
                  {
                    "seriesName": "Windows 8",
                    "color": "purpleDark"
                  },
                  {
                    "seriesName": "<empty>",
                    "label": "Unknown OS",
                    "color": "orange"
                  },
                  {
                    "seriesName": "Windows",
                    "color": "greenDark"
                  },
                  {
                    "seriesName": "Other",
                    "color": "blueDarkDark"
                  },
                  {
                    "seriesName": "iOS 15",
                    "color": "purple"
                  }
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 0,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true
                    }
                  }
                }
              }
            },
            "customWidth": "65",
            "showPin": true,
            "name": "query - 4"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let baseQuery = materialize(SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)   \r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\" \r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n);\r\nlet totalCount = toscalar(baseQuery | count);\r\nbaseQuery\r\n|summarize Count = count(AuthMethod) * 100.0 /totalCount by DeviceState\r\n",
              "size": 3,
              "showAnalytics": true,
              "title": "% Prompts by device state",
              "timeContext": {
                "durationMs": 604800000
              },
              "timeContextFromParameter": "Time",
              "exportParameterName": "SelectedState",
              "exportDefaultValue": "{ \"series\":\"All\"}",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "piechart",
              "tileSettings": {
                "showBorder": false,
                "titleContent": {
                  "columnMatch": "DeviceState",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "Count",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "chartSettings": {
                "yAxis": [
                  "Count"
                ],
                "seriesLabelSettings": [
                  {
                    "seriesName": "Unmanaged",
                    "color": "blue"
                  },
                  {
                    "seriesName": "Azure AD joined",
                    "color": "orange"
                  },
                  {
                    "seriesName": "Hybrid Azure AD joined",
                    "color": "blueDark"
                  },
                  {
                    "seriesName": "Azure AD registered",
                    "color": "turquoise"
                  }
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 1,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true,
                      "maximumFractionDigits": 1
                    }
                  }
                }
              }
            },
            "customWidth": "35",
            "showPin": true,
            "name": "query - 5"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)\r\n|extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n    |mv-expand ParsedState = parse_json(tostring('{SelectedState}'))\r\n| extend SelectedState = ParsedState.series\r\n| where SelectedState == 'All' or (DeviceState == SelectedState)\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n    |extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\" \r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n|summarize Count = count(AuthMethod) by bin(TimeGenerated, 1h), DeviceState",
              "size": 0,
              "showAnalytics": true,
              "title": "Hourly prompts by device state",
              "timeContext": {
                "durationMs": 604800000
              },
              "timeContextFromParameter": "Time",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "barchart",
              "tileSettings": {
                "showBorder": false,
                "titleContent": {
                  "columnMatch": "DeviceState",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "Count",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "Unmanaged",
                    "color": "blue"
                  },
                  {
                    "seriesName": "Hybrid Azure AD joined",
                    "color": "blueDark"
                  },
                  {
                    "seriesName": "Azure AD registered",
                    "color": "turquoise"
                  },
                  {
                    "seriesName": "Azure AD joined",
                    "color": "orange"
                  }
                ]
              }
            },
            "customWidth": "65",
            "showPin": true,
            "name": "query - 6"
          },
          {
            "type": 1,
            "content": {
              "json": "## Authentication prompts by user\r\nTo investigate the top prompted users, filter this report by user."
            },
            "name": "text - 5"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let baseQuery = materialize(\r\nSigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n|extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n|extend AuthMethod = tostring(AuthenticationMethod)\r\n|extend ParsedFields2=parse_json(DeviceDetail)\r\n|extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\"\r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState})\r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\")\r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n);\r\nlet totalCount = toscalar(baseQuery | count);\r\nbaseQuery\r\n|summarize Count = count(AuthMethod) * 100.0 /totalCount by UserDisplayName",
              "size": 3,
              "showAnalytics": true,
              "title": "% Prompts by user",
              "timeContext": {
                "durationMs": 604800000
              },
              "timeContextFromParameter": "Time",
              "exportFieldName": "",
              "exportParameterName": "SelectedUser",
              "exportDefaultValue": "{ \"series\":\"All users\"}",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "Other",
                    "label": "All Other Users",
                    "color": "blue"
                  },
                  {
                    "seriesName": "On-Premises Directory Synchronization Service Account",
                    "color": "orange"
                  },
                  {
                    "seriesName": "Adam Steenwyk",
                    "color": "blueDark"
                  },
                  {
                    "seriesName": "Adrian Drumea",
                    "color": "turquoise"
                  },
                  {
                    "seriesName": "Abigail Brown",
                    "color": "purpleDark"
                  },
                  {
                    "seriesName": "Abhijeet Kumar Sinha",
                    "color": "pink"
                  },
                  {
                    "seriesName": "Tracy Shi",
                    "color": "greenDark"
                  },
                  {
                    "seriesName": "Joey Cruz",
                    "color": "lightBlue"
                  },
                  {
                    "seriesName": "Joseph Run",
                    "color": "purple"
                  }
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 1,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true,
                      "maximumFractionDigits": 1
                    }
                  }
                }
              }
            },
            "customWidth": "35",
            "showPin": true,
            "name": "query - 7"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod) \r\n|extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n    |extend OS = tostring(OperatingSystem)\r\n| extend ParsedUsers = parse_json('{SelectedUser}')\r\n| extend SelectedUser = ParsedUsers.series\r\n|where SelectedUser == 'All users' or (UserDisplayName == SelectedUser)\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\"\r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n|summarize CountPrompts = count(AuthMethod) by bin(TimeGenerated,1h), UserDisplayName\r\n\r\n",
              "size": 0,
              "showAnalytics": true,
              "title": "Hourly prompts by user",
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "Time",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "barchart",
              "chartSettings": {
                "xAxis": "TimeGenerated",
                "seriesLabelSettings": [
                  {
                    "seriesName": "Other",
                    "label": "All Other Users",
                    "color": "blue"
                  },
                  {
                    "seriesName": "On-Premises Directory Synchronization Service Account",
                    "color": "orange"
                  },
                  {
                    "seriesName": "Adam Steenwyk",
                    "color": "blueDark"
                  },
                  {
                    "seriesName": "Adrian Drumea",
                    "color": "turquoise"
                  },
                  {
                    "seriesName": "Abigail Brown",
                    "color": "purpleDark"
                  },
                  {
                    "seriesName": "Abhijeet Kumar Sinha",
                    "color": "pink"
                  },
                  {
                    "seriesName": "Joey Cruz",
                    "color": "lightBlue"
                  },
                  {
                    "seriesName": "Joseph Run",
                    "color": "purple"
                  },
                  {
                    "seriesName": "Joey Cruz (HE/HIM)",
                    "label": "Joey Cruz",
                    "color": "lightBlue"
                  },
                  {
                    "seriesName": "Cedric Blomart",
                    "color": "brown"
                  },
                  {
                    "seriesName": "Salman Salem (IFG)",
                    "color": "green"
                  },
                  {
                    "seriesName": "Alex Remo",
                    "color": "grayBlue"
                  }
                ]
              }
            },
            "customWidth": "65",
            "showPin": true,
            "name": "query - 8"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)\r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n    |extend OperatingSystem = ParsedFields2.operatingSystem\r\n    |extend OS = tostring(OperatingSystem)\r\n|extend ParsedUsers = parse_json('{SelectedUser}')\r\n|extend SelectedUser = ParsedUsers.series\r\n|where SelectedUser == 'All users' or (UserDisplayName == SelectedUser)\r\n|where AuthMethod != \"Previously satisfied\"\r\n    and  AuthMethod != \"\"\r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n|summarize CountPrompts = count(AuthMethod) by UserDisplayName, AppDisplayName, AuthStatus, OriginalRequestId, TimeGenerated\r\n|order by CountPrompts desc\r\n\r\n\r\n\r\n",
              "size": 1,
              "showAnalytics": true,
              "title": "Prompts by user",
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "Time",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "UserDisplayName",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "60ch"
                    }
                  },
                  {
                    "columnMatch": "AppDisplayName",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    }
                  },
                  {
                    "columnMatch": "AuthStatus",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    }
                  },
                  {
                    "columnMatch": "CountPrompts",
                    "formatter": 1,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "100",
            "showPin": true,
            "name": "query - 9"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)   \r\n|extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\"\r\n    and  AuthMethod != \"\"\r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n| where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus}) \r\n|project AuthMethod, CorrelationId, UserId\r\n|summarize CountPrompts = count(AuthMethod), DistinctUsers = dcount(UserId), DistinctCorrelationIds = dcount(CorrelationId)\r\n|extend AvgeragePromptperUser = toreal(CountPrompts)/toreal(DistinctUsers)\r\n|project AvgeragePromptperUser\r\n\r\n\r\n\r\n",
              "size": 3,
              "title": "Average prompts for users",
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "Time",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "tiles",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "AvgeragePromptperUser",
                    "formatter": 1,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal",
                        "maximumFractionDigits": 0
                      }
                    }
                  }
                ],
                "sortBy": [
                  {
                    "itemKey": "$gen_number_AvgeragePromptperUser_0",
                    "sortOrder": 1
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "AvgeragePromptperUser",
                    "label": "Average"
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "$gen_number_AvgeragePromptperUser_0",
                  "sortOrder": 1
                }
              ],
              "tileSettings": {
                "titleContent": {},
                "leftContent": {
                  "columnMatch": "AvgeragePromptperUser",
                  "formatter": 12,
                  "formatOptions": {
                    "min": 10,
                    "palette": "orange"
                  },
                  "numberFormat": {
                    "unit": 0,
                    "options": {
                      "style": "decimal",
                      "maximumFractionDigits": 1
                    }
                  }
                },
                "showBorder": false,
                "size": "full"
              },
              "chartSettings": {
                "yAxis": [
                  "Count"
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 0,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true
                    }
                  }
                }
              }
            },
            "customWidth": "25",
            "showPin": true,
            "name": "query - 10"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)   \r\n|extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\"\r\n    and  AuthMethod != \"\"\r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n| summarize CountPrompts = count(AuthMethod) by UserDisplayName\r\n| summarize percentiles(CountPrompts,50,80)\r\n| project  Median = percentile_CountPrompts_50\r\n\r\n\r\n\r\n",
              "size": 3,
              "title": "Median prompts for users",
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "Time",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "tiles",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Median",
                    "formatter": 1
                  },
                  {
                    "columnMatch": "AvgeragePromptperApp",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal",
                        "maximumFractionDigits": 0
                      }
                    }
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "Median",
                    "label": "Median"
                  }
                ]
              },
              "tileSettings": {
                "titleContent": {},
                "leftContent": {
                  "columnMatch": "Median",
                  "formatter": 12,
                  "formatOptions": {
                    "min": 3,
                    "palette": "orange"
                  },
                  "numberFormat": {
                    "unit": 0,
                    "options": {
                      "style": "decimal",
                      "maximumFractionDigits": 1
                    }
                  }
                },
                "showBorder": false,
                "size": "full"
              },
              "chartSettings": {
                "yAxis": [
                  "Count"
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 0,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true
                    }
                  }
                }
              }
            },
            "customWidth": "25",
            "showPin": true,
            "name": "query - 11"
          },
          {
            "type": 1,
            "content": {
              "json": "A high count of failures per user can skew the average so consider both the average and the median when analyzing the data. The median represents the 50th percentile, where 50% of the users  have prompts equal to or less than the median value.",
              "style": "info"
            },
            "customWidth": "45",
            "name": "text - 6"
          },
          {
            "type": 1,
            "content": {
              "json": "## Authentication prompts by application\r\nTo investigate the top prompted apps, filter this report by AppID and look at “Authentication policy” graph to understand what triggers multiple authentication requests."
            },
            "name": "text - 7"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let baseQuery = materialize(SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)  \r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\"\r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n);\r\nlet totalCount = toscalar(baseQuery | count);\r\nbaseQuery\r\n|summarize Count = count(AuthMethod) * 100.0 /totalCount by AppDisplayName\r\n\r\n",
              "size": 3,
              "showAnalytics": true,
              "title": "% Prompts by application",
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "Time",
              "exportParameterName": "SelectedApp",
              "exportDefaultValue": "{ \"series\":\"All apps\"}",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "piechart",
              "gridSettings": {
                "sortBy": [
                  {
                    "itemKey": "CountPrompts",
                    "sortOrder": 2
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "CountPrompts",
                  "sortOrder": 2
                }
              ],
              "chartSettings": {
                "yAxis": [
                  "Count"
                ],
                "seriesLabelSettings": [
                  {
                    "seriesName": "Azure Portal",
                    "color": "blue"
                  },
                  {
                    "seriesName": "My Apps",
                    "color": "purpleDark"
                  },
                  {
                    "seriesName": "Microsoft Graph PowerShell",
                    "color": "turquoise"
                  },
                  {
                    "seriesName": "Microsoft Teams Web Client",
                    "color": "purple"
                  },
                  {
                    "seriesName": "Microsoft Authenticator App",
                    "color": "blueDarkDark"
                  },
                  {
                    "seriesName": "Other",
                    "label": "All Other Apps",
                    "color": "orange"
                  },
                  {
                    "seriesName": "Office 365 Exchange Online",
                    "color": "blueDark"
                  },
                  {
                    "seriesName": "My Access",
                    "color": "greenDark"
                  },
                  {
                    "seriesName": "Azure Active Directory PowerShell",
                    "color": "pink"
                  },
                  {
                    "seriesName": "Conditional Access Auth Context DotNet Demo",
                    "color": "turquoise"
                  }
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 1,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true,
                      "maximumFractionDigits": 1
                    }
                  }
                }
              }
            },
            "customWidth": "35",
            "showPin": true,
            "name": "query - 12"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod) \r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|extend ParsedApps = parse_json('{SelectedApp}')\r\n|extend SelectedApp = ParsedApps.series\r\n|where SelectedApp == 'All apps' or (AppDisplayName == SelectedApp)\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\" \r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n| summarize CountPrompts = count(AuthMethod) by bin(TimeGenerated, 1h), AppDisplayName\r\n",
              "size": 0,
              "showAnalytics": true,
              "title": "Hourly prompts by application",
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "Time",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "barchart",
              "gridSettings": {
                "sortBy": [
                  {
                    "itemKey": "CountPrompts",
                    "sortOrder": 2
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "CountPrompts",
                  "sortOrder": 2
                }
              ],
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "Azure Portal",
                    "color": "blue"
                  },
                  {
                    "seriesName": "My Apps",
                    "color": "purpleDark"
                  },
                  {
                    "seriesName": "Microsoft Graph PowerShell",
                    "color": "blueDark"
                  },
                  {
                    "seriesName": "Microsoft Teams Web Client",
                    "color": "lightBlue"
                  },
                  {
                    "seriesName": "Microsoft Authenticator App",
                    "color": "greenDark"
                  },
                  {
                    "seriesName": "Other",
                    "label": "All Other Apps",
                    "color": "orange"
                  },
                  {
                    "seriesName": "Office 365 Exchange Online",
                    "color": "blueDark"
                  },
                  {
                    "seriesName": "My Access",
                    "color": "pink"
                  },
                  {
                    "seriesName": "Azure Active Directory PowerShell",
                    "color": "pink"
                  },
                  {
                    "seriesName": "Conditional Access Auth Context DotNet Demo",
                    "color": "turquoise"
                  },
                  {
                    "seriesName": "Microsoft Office 365 Portal",
                    "color": "orange"
                  }
                ]
              }
            },
            "customWidth": "65",
            "showPin": true,
            "name": "query - 13"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)   \r\n|extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|extend ParsedApps = parse_json('{SelectedApp}')\r\n|extend SelectedApp = ParsedApps.series\r\n|where SelectedApp == 'All apps' or (AppDisplayName == SelectedApp)\r\n|where AuthMethod != \"Previously satisfied\"\r\n    and  AuthMethod != \"\"\r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})  \r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState})\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n|project AuthMethod, CorrelationId, AppDisplayName, AuthStatus, OriginalRequestId, TimeGenerated\r\n|summarize CountPrompts = count(AuthMethod) by AppDisplayName, AuthStatus, OriginalRequestId, TimeGenerated\r\n|order by CountPrompts desc\r\n\r\n\r\n\r\n\r\n",
              "size": 1,
              "showAnalytics": true,
              "title": "Prompts by application",
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "Time",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "AppDisplayName",
                    "formatter": 1,
                    "formatOptions": {
                      "customColumnWidthSetting": "60ch"
                    }
                  },
                  {
                    "columnMatch": "AuthStatus",
                    "formatter": 1,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    }
                  },
                  {
                    "columnMatch": "CountPrompts",
                    "formatter": 1,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    }
                  }
                ],
                "filter": true,
                "sortBy": [
                  {
                    "itemKey": "CountPrompts",
                    "sortOrder": 2
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "AppDisplayName",
                    "label": "Application display name"
                  },
                  {
                    "columnId": "AuthStatus",
                    "label": "Authentication status"
                  },
                  {
                    "columnId": "CountPrompts",
                    "label": "Count of pormpts"
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "CountPrompts",
                  "sortOrder": 2
                }
              ]
            },
            "customWidth": "100",
            "showPin": true,
            "name": "query - 14"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)   \r\n|extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\"\r\n    and  AuthMethod != \"\"\r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n|project AuthMethod, CorrelationId, AppDisplayName\r\n|summarize CountPrompts = count(AuthMethod), DistinctApps = dcount(AppDisplayName), DistinctCorrelationIds = dcount(CorrelationId)\r\n|extend AvgeragePromptperApp = toreal(CountPrompts)/toreal(DistinctApps)\r\n|project AvgeragePromptperApp\r\n\r\n\r\n\r\n",
              "size": 3,
              "title": "Average prompts for applications",
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "Time",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "tiles",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "AvgeragePromptperApp",
                    "formatter": 1,
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal",
                        "maximumFractionDigits": 0
                      }
                    }
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "AvgeragePromptperApp",
                    "label": "Average"
                  }
                ]
              },
              "tileSettings": {
                "titleContent": {},
                "leftContent": {
                  "columnMatch": "AvgeragePromptperApp",
                  "formatter": 12,
                  "formatOptions": {
                    "min": 40,
                    "palette": "blueDark"
                  },
                  "numberFormat": {
                    "unit": 0,
                    "options": {
                      "style": "decimal",
                      "maximumFractionDigits": 1
                    }
                  }
                },
                "showBorder": false,
                "size": "full"
              },
              "chartSettings": {
                "yAxis": [
                  "Count"
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 0,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true
                    }
                  }
                }
              }
            },
            "customWidth": "25",
            "showPin": true,
            "name": "query - 15"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)   \r\n|extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\"\r\n    and  AuthMethod != \"\"\r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n| summarize CountPrompts = count(AuthMethod) by AppDisplayName\r\n| summarize percentiles(CountPrompts,50,80)\r\n| project  Median = percentile_CountPrompts_50\r\n\r\n\r\n\r\n",
              "size": 3,
              "title": "Median prompts for applications",
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "Time",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "tiles",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Median",
                    "formatter": 1
                  },
                  {
                    "columnMatch": "AvgeragePromptperApp",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal",
                        "maximumFractionDigits": 0
                      }
                    }
                  }
                ]
              },
              "tileSettings": {
                "titleContent": {},
                "leftContent": {
                  "columnMatch": "Median",
                  "formatter": 12,
                  "formatOptions": {
                    "min": 3,
                    "palette": "blueDark"
                  },
                  "numberFormat": {
                    "unit": 0,
                    "options": {
                      "style": "decimal",
                      "maximumFractionDigits": 1
                    }
                  }
                },
                "showBorder": false,
                "size": "full"
              },
              "chartSettings": {
                "yAxis": [
                  "Count"
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 0,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true
                    }
                  }
                }
              }
            },
            "customWidth": "25",
            "showPin": true,
            "name": "query - 16"
          },
          {
            "type": 1,
            "content": {
              "json": "A high count of failures per application can skew the average so consider both the average and the median when analyzing the data. The median represents the 50th percentile, where 50% of the applications have prompts equal to or less than the median value.",
              "style": "info"
            },
            "customWidth": "45",
            "name": "text - 8"
          },
          {
            "type": 1,
            "content": {
              "json": "# Authentication prompts by process detail\r\nUse the process detail graphs to understand what triggers multiple authentication requests. Since each sign-in can have multiple process details, the total count of process details will difer the total count the visuals above."
            },
            "name": "text - 7 - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let baseQuery = materialize(SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)  \r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|mv-expand ParsedFields3 = parse_json(AuthenticationProcessingDetails)\r\n|extend AuthProcKey = tostring(ParsedFields3.key)\r\n|extend AuthProcValue = tostring(ParsedFields3.value)\r\n|where AuthProcValue != \"False\"\r\n|extend ProcValue2 = iif(AuthProcKey contains \"Oauth Scope\", strcat(AuthProcKey,\" \",AuthProcValue),AuthProcKey)\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\"\r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n);\r\nlet totalCount = toscalar(baseQuery | count);\r\nbaseQuery\r\n|summarize Count = count(AuthMethod) * 100.0 /totalCount by ProcValue2\r\n",
              "size": 3,
              "showAnalytics": true,
              "title": "% Prompts by process detail",
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "Time",
              "exportParameterName": "SelectedProcess",
              "exportDefaultValue": "{ \"series\":\"All\"}",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart",
              "chartSettings": {
                "yAxis": [
                  "Count"
                ],
                "seriesLabelSettings": [
                  {
                    "seriesName": "Oauth Scope Info ",
                    "color": "blue"
                  },
                  {
                    "seriesName": "Azure AD App Authentication Library",
                    "color": "orange"
                  },
                  {
                    "seriesName": "Login Hint Present",
                    "color": "blueDark"
                  },
                  {
                    "seriesName": "Other",
                    "label": "All other process details",
                    "color": "turquoise"
                  },
                  {
                    "seriesName": "Azure VNet private IP address",
                    "color": "red"
                  },
                  {
                    "seriesName": "Oauth Scope Info [\"user_impersonation\"]",
                    "label": "User Impersonation",
                    "color": "pink"
                  },
                  {
                    "seriesName": "Oauth Scope Info [\"Directory.AccessAsUser.All\",\"Directory.Read.All\",\"Directory.ReadWrite.All\",\"email\",\"openid\",\"PrivilegedAccess.Read.AzureAD\",\"PrivilegedAccess.Read.AzureADGroup\",\"PrivilegedAccess.Read.AzureResources\",\"PrivilegedAccess.ReadWrite.AzureAD\",\"PrivilegedAccess.ReadWrite.AzureADGroup\",\"PrivilegedAccess.ReadWrite.AzureResources\",\"profile\",\"User.Invite.All\",\"User.Read\",\"User.Read.All\",\"User.ReadWrite.All\"]",
                    "label": "Privilege Acess",
                    "color": "purpleDark"
                  }
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 1,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true,
                      "maximumFractionDigits": 1
                    }
                  }
                }
              }
            },
            "customWidth": "35",
            "showPin": true,
            "name": "query - 36"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)  \r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|mv-expand ParsedFields3 = parse_json(AuthenticationProcessingDetails)\r\n|extend AuthProcKey = tostring(ParsedFields3.key)\r\n|extend AuthProcValue = tostring(ParsedFields3.value)\r\n|where AuthProcValue != \"False\"\r\n|extend ProcValue2 = iif(AuthProcKey contains \"Oauth Scope\", strcat(AuthProcKey,\" \",AuthProcValue),AuthProcKey)\r\n| mv-expand ParsedProcess = parse_json(tostring('{SelectedProcess}'))\r\n| extend SelectedProcess = ParsedProcess.series\r\n| where SelectedProcess == 'All' or (ProcValue2 == SelectedProcess)\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\"\r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n|summarize Count = count(AuthMethod) by bin(TimeGenerated,1h), ProcValue2\r\n",
              "size": 0,
              "showAnalytics": true,
              "title": "Hourly Prompts by process detail",
              "noDataMessage": "Bar chart will not render if you have more than one selection in the pie chart or have chosen \"All Other\".",
              "noDataMessageStyle": 4,
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "Time",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "barchart",
              "chartSettings": {
                "yAxis": [
                  "Count"
                ],
                "seriesLabelSettings": [
                  {
                    "seriesName": "Oauth Scope Info ",
                    "label": "Oauth Scope Info ",
                    "color": "blue"
                  },
                  {
                    "seriesName": "Azure AD App Authentication Library",
                    "color": "orange"
                  },
                  {
                    "seriesName": "Login Hint Present",
                    "color": "blueDark"
                  },
                  {
                    "seriesName": "Other",
                    "label": "All other process details",
                    "color": "turquoise"
                  },
                  {
                    "seriesName": "Azure VNet private IP address",
                    "color": "red"
                  },
                  {
                    "seriesName": "Oauth Scope Info [\"user_impersonation\"]",
                    "label": "User Impersonation ",
                    "color": "pink"
                  },
                  {
                    "seriesName": "Oauth Scope Info [\"Directory.AccessAsUser.All\",\"Directory.Read.All\",\"Directory.ReadWrite.All\",\"email\",\"openid\",\"PrivilegedAccess.Read.AzureAD\",\"PrivilegedAccess.Read.AzureADGroup\",\"PrivilegedAccess.Read.AzureResources\",\"PrivilegedAccess.ReadWrite.AzureAD\",\"PrivilegedAccess.ReadWrite.AzureADGroup\",\"PrivilegedAccess.ReadWrite.AzureResources\",\"profile\",\"User.Invite.All\",\"User.Read\",\"User.Read.All\",\"User.ReadWrite.All\"]",
                    "label": "Privilege Access",
                    "color": "purpleDark"
                  },
                  {
                    "seriesName": "Ip Addresses in ClientAndUserJsonWebToken used for IpCaPolicyInstantEnforcement",
                    "label": "IP CA Policy",
                    "color": "greenDark"
                  },
                  {
                    "seriesName": "Client IP Seen By Resource",
                    "color": "blueDarkDark"
                  },
                  {
                    "seriesName": "Oauth Scope Info [\"AuditLog.Create\",\"Chat.Read\",\"DataLossPreventionPolicy.Evaluate\",\"Directory.Read.All\",\"EduRoster.ReadBasic\",\"Files.ReadWrite.All\",\"Group.ReadWrite.All\",\"Notes.Create\",\"OnlineMeetings.Read\",\"OnlineMeetings.ReadWrite\",\"People.Read\",\"SensitiveInfoType.Detect\",\"SensitiveInfoType.Read.All\",\"SensitivityLabel.Evaluate\",\"User.Invite.All\",\"User.Read\",\"User.ReadBasic.All\"]",
                    "label": "Sensitive Info",
                    "color": "green"
                  },
                  {
                    "seriesName": "Domain Hint Present",
                    "color": "gray"
                  }
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 0,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true,
                      "maximumFractionDigits": 1
                    }
                  }
                }
              }
            },
            "customWidth": "65",
            "showPin": true,
            "name": "query - 36 - Copy"
          },
          {
            "type": 1,
            "content": {
              "json": "## Count of Interactive and Non-interactive Sign-ins using TLS\r\nIf you have Legacy TLS in your environment,[click here](https://docs.microsoft.com/en-us/troubleshoot/azure/active-directory/enable-support-tls-environment?tabs=azure-monitor) to learn how to enable TLS 1.2 before Azure AD TLS 1.0/1.1 is deprecated.\r\n"
            },
            "name": "text - 38"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Interactive sign-ins only\r\nSigninLogs\r\n| where AuthenticationProcessingDetails has \"Legacy TLS\"\r\n    and AuthenticationProcessingDetails has \"True\"\r\n| extend JsonAuthProcDetails = parse_json(AuthenticationProcessingDetails)\r\n| mv-apply JsonAuthProcDetails on (\r\n    where JsonAuthProcDetails.key startswith \"Legacy TLS\"\r\n    | project HasLegacyTls=JsonAuthProcDetails.value\r\n)\r\n| where HasLegacyTls == true\r\n\r\n\r\n",
              "size": 3,
              "showAnalytics": true,
              "title": "Interactive Legacy TLS",
              "noDataMessage": "Zero Interactive TLS Sign-ins",
              "noDataMessageStyle": 3,
              "timeContext": {
                "durationMs": 604800000
              },
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles"
            },
            "customWidth": "50",
            "showPin": true,
            "name": "query - 36 - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Non-interactive sign-ins\r\nAADNonInteractiveUserSignInLogs\r\n| where AuthenticationProcessingDetails has \"Legacy TLS\"\r\n    and AuthenticationProcessingDetails has \"True\"\r\n| extend JsonAuthProcDetails = parse_json(AuthenticationProcessingDetails)\r\n| mv-apply JsonAuthProcDetails on (\r\n    where JsonAuthProcDetails.key startswith \"Legacy TLS\"\r\n    | project HasLegacyTls=JsonAuthProcDetails.value\r\n)\r\n| where HasLegacyTls == true\r\n\r\n\r\n",
              "size": 3,
              "showAnalytics": true,
              "title": "Non-Interactive Legacy TLS",
              "noDataMessage": "Zero Non-Interactive TLS Sign-ins",
              "noDataMessageStyle": 3,
              "timeContext": {
                "durationMs": 604800000
              },
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles"
            },
            "customWidth": "50",
            "showPin": true,
            "name": "query - 36 - Copy - Copy - Copy"
          },
          {
            "type": 1,
            "content": {
              "json": "## Authentications prompts by policy\r\nAuthentication policies describe how MFA is enforced and can include Conditional Acces, Security Defaults, Per User MFA, App requires MFA, and others. \r\n\r\n\"App requires MFA\" occurs when the application itself enforce the policy and requires a fresh MFA.\r\n\r\n"
            },
            "name": "text - 9"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let policyData = SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n|extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n|extend AuthMethod = tostring(AuthenticationMethod)\r\n|extend ParsedFields2=parse_json(DeviceDetail)\r\n|extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|mv-expand ParsedFields3 = parse_json(AuthenticationRequirementPolicies)\r\n|extend AuthReqPolicy = ParsedFields3.detail\r\n|extend AuthPolicy = tostring(AuthReqPolicy)\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\"\r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\")\r\n|project AuthPolicy, UserDisplayName, AppDisplayName;\r\nlet adfsData = ADFSSignInLogs\r\n|mv-expand PF=parse_json(AuthenticationDetails)\r\n|extend AuthDetail = PF.authenticationMethodDetail\r\n|extend AuthPolicy = tostring(AuthDetail)\r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|extend Status = PF.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\")\r\n|project AuthPolicy, AuthStatus, AppDisplayName, UserDisplayName;\r\nlet basequery = materialize(\r\nunion policyData, adfsData\r\n|summarize totalCount = count() by AuthPolicy\r\n);\r\nlet total = toscalar(\r\nbasequery\r\n| summarize sum(totalCount)\r\n);\r\nbasequery\r\n| extend pct = totalCount*100.0/total",
              "size": 3,
              "showAnalytics": true,
              "title": "Prompts by authentication policy",
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "Time",
              "exportParameterName": "SelectedPolicy",
              "exportDefaultValue": "{ \"series\":\"All\"}",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "piechart",
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "AuthPolicy",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "Count",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                },
                "showBorder": false
              },
              "chartSettings": {
                "yAxis": [
                  "pct"
                ],
                "seriesLabelSettings": [
                  {
                    "seriesName": "Forms Authentication",
                    "label": "ADFS",
                    "color": "blue"
                  },
                  {
                    "seriesName": "",
                    "label": "Blank",
                    "color": "redDark"
                  },
                  {
                    "seriesName": "Conditional Access",
                    "color": "orange"
                  },
                  {
                    "seriesName": "Per-user MFA",
                    "color": "blueDark"
                  },
                  {
                    "seriesName": "Identity Protection",
                    "color": "pink"
                  },
                  {
                    "seriesName": "Other",
                    "label": "All Other",
                    "color": "greenDark"
                  },
                  {
                    "seriesName": "App requires MFA",
                    "color": "turquoise"
                  },
                  {
                    "seriesName": "Resource requires MFA",
                    "color": "purpleDark"
                  }
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 1,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true,
                      "maximumFractionDigits": 1
                    }
                  }
                }
              }
            },
            "customWidth": "35",
            "showPin": true,
            "name": "query - 19 - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let policyData = SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)  \r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|mv-expand ParsedFields3 = parse_json(AuthenticationRequirementPolicies)\r\n    |extend AuthReqPolicy = ParsedFields3.detail\r\n    |extend AuthPolicy = tostring(AuthReqPolicy)\r\n| mv-expand ParsedPolicy = parse_json(tostring('{SelectedPolicy}'))\r\n| extend SelectedPolicy = ParsedPolicy.series\r\n| where SelectedPolicy == 'All' or (AuthPolicy == SelectedPolicy)    \r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\" \r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n|project TimeGenerated, AuthPolicy, UserDisplayName, AppDisplayName;\r\n//|summarize policyCount = count() by AuthPolicy;\r\nlet adfsData = ADFSSignInLogs\r\n|mv-expand PF=parse_json(AuthenticationDetails)\r\n|extend AuthDetail = PF.authenticationMethodDetail\r\n|extend AuthPolicy = tostring(AuthDetail) \r\n| mv-expand ParsedPolicy = parse_json(tostring('{SelectedPolicy}'))\r\n| extend SelectedPolicy = ParsedPolicy.series\r\n| where SelectedPolicy == 'All' or (AuthPolicy == SelectedPolicy)   \r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n|extend Status = PF.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n|project TimeGenerated,AuthPolicy, AuthStatus, AppDisplayName, UserDisplayName;\r\nunion policyData, adfsData\r\n|summarize Count = count() by bin(TimeGenerated,1h),AuthPolicy",
              "size": 0,
              "showAnalytics": true,
              "title": "Hourly prompts by authentication policy",
              "noDataMessage": "Bar chart will not render if you have more than one selection in the pie chart or have chosen \"All Other\".",
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "Time",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workbook}"
              ],
              "visualization": "barchart",
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "AuthPolicy",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "Count",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                },
                "showBorder": false
              },
              "chartSettings": {
                "xAxis": "TimeGenerated",
                "yAxis": [
                  "Count"
                ],
                "seriesLabelSettings": [
                  {
                    "seriesName": "Forms Authentication",
                    "label": "ADFS",
                    "color": "blue"
                  },
                  {
                    "seriesName": "",
                    "label": "Blank",
                    "color": "redDark"
                  },
                  {
                    "seriesName": "Conditional Access",
                    "color": "orange"
                  },
                  {
                    "seriesName": "Per-user MFA",
                    "color": "blueDark"
                  },
                  {
                    "seriesName": "Identity Protection",
                    "color": "pink"
                  },
                  {
                    "seriesName": "Other",
                    "label": "All Other Policies",
                    "color": "greenDark"
                  },
                  {
                    "seriesName": "<empty>",
                    "label": "Blank",
                    "color": "redDark"
                  },
                  {
                    "seriesName": "Resource requires MFA",
                    "color": "purpleDark"
                  },
                  {
                    "seriesName": "App requires MFA",
                    "color": "turquoise"
                  }
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 0,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true,
                      "maximumFractionDigits": 1
                    }
                  }
                }
              }
            },
            "customWidth": "65",
            "showPin": true,
            "name": "query - 19 - Copy - Copy"
          },
          {
            "type": 1,
            "content": {
              "json": "## Recommendations for reducing prompts and improving user experience"
            },
            "name": "text - 11"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "### Managed devices\r\n\r\nFor improved user experience, we recommend enabling single sign-on using managed devices. Learn more: [Plan your Azure Active Directory device deployment]( https://docs.microsoft.com/en-us/azure/active-directory/devices/plan-device-deployment)"
                  },
                  "customWidth": "100",
                  "name": "text - 12"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)   \r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n    |extend DeviceId = ParsedFields2.deviceId\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\" \r\n|summarize TotalDeviceCount = count(tostring(DeviceDetail)), ManagedCount = countif(DeviceState != \"Unmanaged\")\r\n|project ['% Managed Devices'] = (1.0 * ManagedCount / TotalDeviceCount), ['# Managed Devices'] = ManagedCount\r\n",
                    "size": 3,
                    "title": "%      |      Count of Managed Devices",
                    "timeContext": {
                      "durationMs": 0
                    },
                    "timeContextFromParameter": "Time",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workbook}"
                    ],
                    "visualization": "tiles",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "% Managed Devices",
                          "formatter": 1,
                          "formatOptions": {
                            "customColumnWidthSetting": "35ch"
                          },
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "percent",
                              "minimumFractionDigits": 2
                            }
                          }
                        },
                        {
                          "columnMatch": "# Managed Devices",
                          "formatter": 1,
                          "formatOptions": {
                            "customColumnWidthSetting": "35ch"
                          }
                        }
                      ]
                    },
                    "tileSettings": {
                      "titleContent": {
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "% Managed Devices",
                        "formatter": 12,
                        "formatOptions": {
                          "min": 0,
                          "palette": "turquoise"
                        },
                        "numberFormat": {
                          "unit": 0,
                          "options": {
                            "style": "percent"
                          }
                        }
                      },
                      "rightContent": {
                        "columnMatch": "# Managed Devices",
                        "formatter": 12,
                        "formatOptions": {
                          "min": 0,
                          "palette": "turquoise"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal"
                          }
                        },
                        "tooltipFormat": {}
                      },
                      "showBorder": false,
                      "size": "auto"
                    }
                  },
                  "customWidth": "100",
                  "name": "Managed Devices"
                },
                {
                  "type": 1,
                  "content": {
                    "json": "#### Windows Hello for Business\r\n\r\nTo reduce authentication prompts and improve user experience on Windows 10 and above, we recommend using Windows Hello for Business. Learn more: [Windows Hello for Business Overview - Microsoft 365 Security]( https://docs.microsoft.com/en-us/windows/security/identity-protection/hello-for-business/hello-overview)"
                  },
                  "customWidth": "100",
                  "name": "text - 13"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)   \r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\" //and AuthMethod != \"Password\"\r\n|where OS contains \"Windows\" or OS contains \"windows\"\r\n|summarize TotalCountWindows = count(), WHFBCount = countif(AuthMethod contains \"Windows Hello for Business\")\r\n|project ['% WHFB'] = (1.0 * WHFBCount / TotalCountWindows), ['# Windows Devices']= TotalCountWindows",
                    "size": 3,
                    "title": "% WHFB | Count of Windows Devices",
                    "timeContext": {
                      "durationMs": 0
                    },
                    "timeContextFromParameter": "Time",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workbook}"
                    ],
                    "visualization": "tiles",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "% WHFB",
                          "formatter": 1,
                          "formatOptions": {
                            "customColumnWidthSetting": "35ch"
                          },
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "percent",
                              "maximumFractionDigits": 2
                            }
                          }
                        },
                        {
                          "columnMatch": "# Windows Devices",
                          "formatter": 1,
                          "formatOptions": {
                            "customColumnWidthSetting": "35ch"
                          }
                        }
                      ]
                    },
                    "tileSettings": {
                      "titleContent": {},
                      "leftContent": {
                        "columnMatch": "% WHFB",
                        "formatter": 12,
                        "formatOptions": {
                          "min": -100,
                          "palette": "purpleDark"
                        },
                        "numberFormat": {
                          "unit": 0,
                          "options": {
                            "style": "percent",
                            "minimumFractionDigits": 1
                          }
                        }
                      },
                      "rightContent": {
                        "columnMatch": "# Windows Devices",
                        "formatter": 12,
                        "formatOptions": {
                          "min": 0,
                          "palette": "purpleDark"
                        },
                        "numberFormat": {
                          "unit": 0,
                          "options": {
                            "style": "decimal"
                          }
                        }
                      },
                      "showBorder": false,
                      "size": "auto"
                    }
                  },
                  "customWidth": "100",
                  "name": "WHFB",
                  "styleSettings": {
                    "margin": "0"
                  }
                },
                {
                  "type": 1,
                  "content": {
                    "json": "#### Mobile Authentications\r\n\r\nThe Authenticator app serves as a token broker and can reduce authentication prompts on Android and iOS. For improved user experience and reduce prompts on mobile devices, we recommend using the Microsoft Authenticator. Learn more: [Microsoft Authenticator app authentication method - Azure Active Directory](https://docs.microsoft.com/en-us/azure/active-directory/authentication/concept-authentication-authenticator-app)"
                  },
                  "customWidth": "100",
                  "name": "text - 14"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod)   \r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\" \r\n|where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n|where AuthMethod in ({AuthMethod}) or '*' in ({AuthMethod})\r\n|where DeviceState in ({DeviceState}) or '*' in ({DeviceState}) \r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| where \"{OS:escape}\" == \"All OS\" or OS contains \"{OS:escape}\"\r\n|extend Status = ParsedFields.succeeded\r\n|extend AuthStatus = case(Status == \"true\", \"Success\", \"Failure\") \r\n|where AuthStatus in ({AuthStatus}) or '*' in ({AuthStatus})\r\n|extend AuthAppOpp = case(AuthMethod == \"Phone call approval (Authentication phone)\", \"Opportunity\", AuthMethod == \"Text message\", \"Opportunity\", AuthMethod == \"Mobile app notification\", \"Opportunity\",\"StrongAuth\")\r\n|summarize TotalCount = count(), TotalAuthAppOpp = countif(AuthAppOpp != \"StrongAuth\"), AuthenticatorApp = countif(AuthMethod contains \"Mobile app notification\")\r\n|project ['% Authenticator App Sign-Ins'] = (1.0 * AuthenticatorApp/TotalAuthAppOpp), TotalCount\r\n",
                    "size": 3,
                    "title": "%  Auth App Authentications  | Count of Android/iOS Devices",
                    "timeContext": {
                      "durationMs": 0
                    },
                    "timeContextFromParameter": "Time",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workbook}"
                    ],
                    "visualization": "tiles",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "% Authenticator App Sign-Ins",
                          "formatter": 1,
                          "formatOptions": {
                            "customColumnWidthSetting": "60%"
                          },
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "percent",
                              "maximumFractionDigits": 2
                            }
                          }
                        }
                      ]
                    },
                    "tileSettings": {
                      "titleContent": {},
                      "leftContent": {
                        "columnMatch": "% Authenticator App Sign-Ins",
                        "formatter": 12,
                        "formatOptions": {
                          "min": 0,
                          "palette": "pink"
                        },
                        "numberFormat": {
                          "unit": 0,
                          "options": {
                            "style": "percent",
                            "maximumFractionDigits": 1
                          }
                        }
                      },
                      "rightContent": {
                        "columnMatch": "TotalCount",
                        "formatter": 12,
                        "formatOptions": {
                          "min": 0,
                          "palette": "pink"
                        }
                      },
                      "showBorder": false,
                      "size": "auto"
                    }
                  },
                  "customWidth": "100",
                  "name": "Mobile"
                },
                {
                  "type": 1,
                  "content": {
                    "json": "#### Mac OS Authentications\r\n\r\nOn MacOs we recommend the Microsoft Enterprise SSO plug-in for Apple devices. http://aka.ms/AADAppleSSO\r\n\r\n"
                  },
                  "customWidth": "100",
                  "name": "text - 15"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SigninLogs\r\n|mv-expand ParsedFields=parse_json(AuthenticationDetails)\r\n    |extend AuthenticationMethod = ParsedFields.authenticationMethod\r\n    |extend AuthMethod = tostring(AuthenticationMethod) \r\n    |extend ParsedFields2=parse_json(DeviceDetail)\r\n    |extend DeviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n|extend OperatingSystem = ParsedFields2.operatingSystem\r\n|extend OS = tostring(OperatingSystem)\r\n|where AuthMethod != \"Previously satisfied\" and AuthMethod != \"\"\r\n|summarize totalCount = count(), macAuth = countif(OS contains \"Mac\")\r\n|project ['% MAC Authentications'] = (1.0 * macAuth/ totalCount), ['# MAC Authentications'] = macAuth",
                    "size": 3,
                    "title": "% | Count of Mac Authentications",
                    "timeContext": {
                      "durationMs": 0
                    },
                    "timeContextFromParameter": "Time",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workbook}"
                    ],
                    "visualization": "tiles",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Avg Prompts for Mac Users",
                          "formatter": 1,
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal",
                              "maximumFractionDigits": 0
                            }
                          }
                        },
                        {
                          "columnMatch": "Avg Prompts Per Mac User",
                          "formatter": 1,
                          "formatOptions": {
                            "customColumnWidthSetting": "30ch"
                          },
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal",
                              "maximumFractionDigits": 1
                            }
                          }
                        }
                      ]
                    },
                    "tileSettings": {
                      "titleContent": {},
                      "leftContent": {
                        "columnMatch": "% MAC Authentications",
                        "formatter": 12,
                        "formatOptions": {
                          "min": 0,
                          "palette": "greenDarkDark"
                        },
                        "numberFormat": {
                          "unit": 0,
                          "options": {
                            "style": "percent",
                            "maximumFractionDigits": 1
                          }
                        }
                      },
                      "rightContent": {
                        "columnMatch": "# MAC Authentications",
                        "formatter": 12,
                        "formatOptions": {
                          "min": 0,
                          "palette": "greenDarkDark"
                        },
                        "numberFormat": {
                          "unit": 0,
                          "options": {
                            "style": "decimal",
                            "maximumFractionDigits": 1
                          }
                        }
                      },
                      "showBorder": false,
                      "size": "auto"
                    }
                  },
                  "customWidth": "100",
                  "name": "MacOS"
                }
              ]
            },
            "customWidth": "100",
            "name": "Insights"
          }
        ],
        "exportParameters": true
      },
      "name": "group - 0"
    }
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}