{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "## Cross Tenant Access Activity - Inbound and Outbound External Azure AD Tenant Activity\r\nUsing this workbook, a tenant administrator can visualize the inbound and outbound activity involving their users accessing external tenants (outbound) and/or users from external Azure AD tenants accessing their local resources."
      },
      "customWidth": "70",
      "name": "text - 0"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "d7eea88a-376f-45df-9339-8f064b529a35",
            "version": "KqlParameterItem/1.0",
            "name": "Workspace",
            "type": 5,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "typeSettings": {
              "resourceTypeFilter": {
                "microsoft.operationalinsights/workspaces": true
              },
              "additionalResourceOptions": [
                "value::all"
              ]
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "defaultValue": "value::all",
            "value": [
              "value::all"
            ]
          },
          {
            "id": "a4a63c13-cca3-40e9-a572-35240c8d6366",
            "version": "KqlParameterItem/1.0",
            "name": "Guide",
            "type": 10,
            "isRequired": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "jsonData": "[\r\n    {\"value\": \"On\", \"label\": \"On\", \"selected\":true},\r\n    {\"value\": \"Off\", \"label\": \"Off\"}\r\n]"
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "customWidth": "30",
      "name": "parameters - 5"
    },
    {
      "type": 1,
      "content": {
        "json": "### Steps for discovery of cross tenant access activity\r\nAs businesses collaborate across organizations,  they access external tenant resources or invite external users to access local resources using Azure AD B2B.\r\n\r\nUtilizing the the sign-in log telemetry, a tenant administrator can visualize and review the inbound and outbound cross-tenant activity.\r\n- **Outbound Access** - Local users in this tenant who are accessing resources in external tenants utilizing Azure AD B2B\r\n- **Inbound Access** - External users who have been invited to access local resources in this tenant utilizing Azure AD B2B\r\n\r\nSign-in events from the interactive SigninLogs log for specified applications by their ResourceIdentity are evaluated to provide insights into the inbound and outbound activity for this tenant.  Information is presented for the ExternalTenantId from the log events to visualize the activity between the this tenant and the associated external tenant."
      },
      "conditionalVisibility": {
        "parameterName": "Guide",
        "comparison": "isEqualTo",
        "value": "On"
      },
      "name": "text_guide_overview"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "e9e16a64-894c-4422-984e-0aa79948508e",
                  "version": "KqlParameterItem/1.0",
                  "name": "TimeRange",
                  "label": "Time range",
                  "type": 4,
                  "description": "Time range in days to query sign-in logs",
                  "isRequired": true,
                  "value": {
                    "durationMs": 2419200000
                  },
                  "typeSettings": {
                    "selectableValues": [
                      {
                        "durationMs": 3600000
                      },
                      {
                        "durationMs": 43200000
                      },
                      {
                        "durationMs": 86400000
                      },
                      {
                        "durationMs": 172800000
                      },
                      {
                        "durationMs": 259200000
                      },
                      {
                        "durationMs": 604800000
                      },
                      {
                        "durationMs": 1209600000
                      },
                      {
                        "durationMs": 2419200000
                      },
                      {
                        "durationMs": 2592000000
                      },
                      {
                        "durationMs": 5184000000
                      },
                      {
                        "durationMs": 7776000000
                      }
                    ]
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "e3f77b73-ead5-44f9-a882-6d823e067641",
                  "version": "KqlParameterItem/1.0",
                  "name": "ExternalTenantId",
                  "label": "External Tenant ID",
                  "value": "All external tenants",
                  "type": 1,
                  "description": "TenantID for external tenant as HomeTenantId or ResourceTenantId"
                },
                {
                  "id": "95045f76-0a92-4c71-a043-b1ae94654c7a",
                  "version": "KqlParameterItem/1.0",
                  "name": "User",
                  "label": "User principal name",
                  "value": "All users",
                  "type": 1,
                  "description": "Userprincipal name to scope workbook"
                },
                {
                  "id": "bc650409-aed8-4a57-858a-e66aae99fcbe",
                  "version": "KqlParameterItem/1.0",
                  "name": "Application",
                  "value": "All applications",
                  "type": 1,
                  "description": "Application name for the resource being accessed"
                },
                {
                  "id": "fb794c49-1575-4d05-a587-2ac800991e47",
                  "version": "KqlParameterItem/1.0",
                  "name": "Status",
                  "type": 2,
                  "description": "Sign-in result is Success, Failure, or All",
                  "isRequired": true,
                  "value": "All",
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "jsonData": "[\r\n    {\"value\": \"All\", \"label\": \"All\"},\r\n    {\"value\": \"Success\", \"label\": \"Success\"},\r\n    {\"value\": \"Failure\", \"label\": \"Failure\"}\r\n]"
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "parameters"
          },
          {
            "type": 1,
            "content": {
              "json": "# Step 1 - Select external tenant\r\nIn the table below, select the External Tenant to focus on the details for the inbound and outbound activity with that external tenant."
            },
            "conditionalVisibility": {
              "parameterName": "Guide",
              "comparison": "isEqualTo",
              "value": "On"
            },
            "name": "text_guide_step1_overview"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let outboundActivity = SigninLogs\r\n| project\r\n    TimeGenerated,\r\n    UserPrincipalName,\r\n    ResourceTenantId,\r\n    AADTenantId,\r\n    Id,\r\n    HomeTenantId,\r\n    ResourceDisplayName,\r\n    ResourceIdentity,\r\n    Status,\r\n    UserId\r\n| where UserId != \"00000000-0000-0000-0000-000000000000\"\r\n| where TimeGenerated {TimeRange:value}\r\n| where \"{User:escape}\" == \"All users\" or UserPrincipalName has \"{User:escape}\"\r\n| where \"{Application:escape}\" == \"All applications\" or ResourceDisplayName has \"{Application:escape}\"\r\n| where \"{ExternalTenantId:escape}\" == \"All external tenants\" or ResourceTenantId has \"{ExternalTenantId:escape}\"\r\n| extend status = case(Status.errorCode == 0, \"Success\", \"Failure\")\r\n| where \"{Status}\" == status or \"{Status}\" == \"All\"\r\n| where HomeTenantId != ''\r\n| where ResourceTenantId != AADTenantId\r\n| summarize OutboundUsers = dcount(UserPrincipalName), OutboundSignInsTotal = dcount(Id), OutboundSignInsFailure = countif(status == 'Failure'), OutboundApps = dcount(ResourceIdentity) by ResourceTenantId\r\n| project OutboundUsers,\r\n    OutboundSignInsTotal,\r\n    OutboundSignInsFailure,\r\n    OutboundApps,\r\n    ExternalTenantId = ResourceTenantId;\r\nlet inboundActivity = SigninLogs\r\n|project TimeGenerated,\r\n    UserPrincipalName,\r\n    HomeTenantId,\r\n    AADTenantId,\r\n    Id,\r\n    ResourceTenantId,\r\n    ResourceDisplayName,\r\n    ResourceIdentity,\r\n    Status,\r\n    UserId\r\n| where UserId != \"00000000-0000-0000-0000-000000000000\"\r\n| where \"{User:escape}\" == \"All users\" or UserPrincipalName has \"{User:escape}\"\r\n| where \"{Application:escape}\" == \"All applications\" or ResourceDisplayName has \"{Application:escape}\"\r\n| where \"{ExternalTenantId:escape}\" == \"All external tenants\" or HomeTenantId has \"{ExternalTenantId:escape}\"\r\n| where HomeTenantId != ''\r\n| where HomeTenantId != AADTenantId\r\n| extend status = case(Status.errorCode == 0, \"Success\", \"Failure\")\r\n| where \"{Status}\" == status or \"{Status}\" == \"All\"\r\n| summarize InboundUsers = dcount(UserPrincipalName), InboundSignInsTotal = dcount(Id), InboundSignInsFailure = countif(status == 'Failure'), InboundApps = dcount(ResourceIdentity) by HomeTenantId\r\n| project InboundUsers,\r\n    InboundSignInsTotal,\r\n    InboundSignInsFailure,\r\n    InboundApps,\r\n    ExternalTenantId = HomeTenantId;\r\noutboundActivity\r\n| join kind=fullouter inboundActivity on ExternalTenantId\r\n| project\r\nExternalTenantId = coalesce(ExternalTenantId, ExternalTenantId1),\r\nOutboundSignInsTotal,\r\nOutboundSignInsFailure,\r\nOutboundUsers,\r\nOutboundApps,\r\nInboundSignInsTotal,\r\nInboundSignInsFailure,\r\nInboundUsers,\r\nInboundApps",
              "size": 0,
              "showAnalytics": true,
              "timeContext": {
                "durationMs": 2419200000
              },
              "timeContextFromParameter": "TimeRange",
              "exportFieldName": "ExternalTenantId",
              "exportParameterName": "SelectedTenantId",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "ExternalTenantId",
                    "formatter": 1,
                    "formatOptions": {
                      "customColumnWidthSetting": "42ch"
                    }
                  },
                  {
                    "columnMatch": "OutboundSignInsTotal",
                    "formatter": 4,
                    "formatOptions": {
                      "palette": "blue",
                      "customColumnWidthSetting": "10%"
                    },
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal"
                      },
                      "emptyValCustomText": "0"
                    }
                  },
                  {
                    "columnMatch": "OutboundSignInsFailure",
                    "formatter": 4,
                    "formatOptions": {
                      "palette": "blueDark",
                      "customColumnWidthSetting": "10%"
                    }
                  },
                  {
                    "columnMatch": "OutboundUsers",
                    "formatter": 4,
                    "formatOptions": {
                      "palette": "blue",
                      "customColumnWidthSetting": "10%"
                    },
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal"
                      },
                      "emptyValCustomText": "0"
                    }
                  },
                  {
                    "columnMatch": "OutboundApps",
                    "formatter": 4,
                    "formatOptions": {
                      "palette": "blue",
                      "customColumnWidthSetting": "10%"
                    },
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal"
                      },
                      "emptyValCustomText": "0"
                    }
                  },
                  {
                    "columnMatch": "InboundSignInsTotal",
                    "formatter": 4,
                    "formatOptions": {
                      "palette": "orange",
                      "customColumnWidthSetting": "10%"
                    },
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal"
                      },
                      "emptyValCustomText": "0"
                    }
                  },
                  {
                    "columnMatch": "InboundSignInsFailure",
                    "formatter": 4,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "10%"
                    },
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal"
                      },
                      "emptyValCustomText": "0"
                    }
                  },
                  {
                    "columnMatch": "InboundUsers",
                    "formatter": 4,
                    "formatOptions": {
                      "palette": "orange",
                      "customColumnWidthSetting": "10%"
                    },
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal"
                      },
                      "emptyValCustomText": "0"
                    }
                  },
                  {
                    "columnMatch": "InboundApps",
                    "formatter": 4,
                    "formatOptions": {
                      "palette": "orange",
                      "customColumnWidthSetting": "10%"
                    },
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal"
                      },
                      "emptyValCustomText": "0"
                    }
                  }
                ],
                "rowLimit": 10000,
                "filter": true,
                "sortBy": [
                  {
                    "itemKey": "$gen_bar_OutboundSignInsFailure_2",
                    "sortOrder": 2
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "ExternalTenantId",
                    "label": "External Tenant"
                  },
                  {
                    "columnId": "OutboundSignInsTotal",
                    "label": "Outbound Sign-Ins Total"
                  },
                  {
                    "columnId": "OutboundSignInsFailure",
                    "label": "Outbound Sign-In Failures"
                  },
                  {
                    "columnId": "OutboundUsers",
                    "label": "Outbound Users"
                  },
                  {
                    "columnId": "OutboundApps",
                    "label": "Outbound Apps"
                  },
                  {
                    "columnId": "InboundSignInsTotal",
                    "label": "Inbound Sign-Ins Total"
                  },
                  {
                    "columnId": "InboundSignInsFailure",
                    "label": "Inbound Sign-In Failures"
                  },
                  {
                    "columnId": "InboundUsers",
                    "label": "Inbound Users"
                  },
                  {
                    "columnId": "InboundApps",
                    "label": "Inbound Apps"
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "$gen_bar_OutboundSignInsFailure_2",
                  "sortOrder": 2
                }
              ]
            },
            "customWidth": "100",
            "name": "query_overview"
          }
        ],
        "exportParameters": true
      },
      "name": "group_overview"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "# Step 2 - Select outbound or inbound activity\r\nWhen external users are invited to access resources in this local tenant using Azure AD B2B from external Azure AD tenants,  this is considered #inbound# access activity.\r\nWhen users local to this tenant, are invited to access resources in external tenants,  this is considered outbound access activity.\r\n\r\nYou can use the tabs below to review the inbound and outbound access activity after selected a tenant from the above overview list."
                  },
                  "conditionalVisibility": {
                    "parameterName": "Guide",
                    "comparison": "isEqualTo",
                    "value": "On"
                  },
                  "name": "text_guide_step2_activityscope"
                },
                {
                  "type": 11,
                  "content": {
                    "version": "LinkItem/1.0",
                    "style": "tabs",
                    "links": [
                      {
                        "id": "51b55d19-33e1-4ce9-99e3-ef4ef8f392f1",
                        "cellValue": "activityScope",
                        "linkTarget": "parameter",
                        "linkLabel": "Outbound activity",
                        "subTarget": "outbound",
                        "preText": "",
                        "style": "link"
                      },
                      {
                        "id": "2e1cc8a6-12b9-43e7-a108-15a9ad3d3365",
                        "cellValue": "activityScope",
                        "linkTarget": "parameter",
                        "linkLabel": "Inbound activity",
                        "subTarget": "inbound",
                        "style": "link"
                      }
                    ]
                  },
                  "name": "link_activityScope"
                }
              ],
              "exportParameters": true
            },
            "name": "group_activity_selection"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Outbound activity details for selected external tenant",
              "items": [
                {
                  "type": 12,
                  "content": {
                    "version": "NotebookGroup/1.0",
                    "groupType": "editable",
                    "items": [
                      {
                        "type": 1,
                        "content": {
                          "json": "### Outbound Sign-In Status Guide\r\n\r\nLocal users who are accessing resources in external tenants may be blocked based on the policy settings of this tenant or the external tenant.    By reviewing the sign-in status of outbound activity admins can determine if they need to work with the external tenant admin to resolve unexpected sign-in failures based on the reason for the failure.\r\n\r\nAdditional information to aid in understanding sign-in results and controls availiable can be found below:\r\n\r\n- [Azure AD Authentication and authorization error codes](https://docs.microsoft.com/en-us/azure/active-directory/develop/reference-aadsts-error-codes)\r\n- [Restrict access to a tenant](https://docs.microsoft.com/en-us/azure/active-directory/manage-apps/tenant-restrictions)\r\n- [Azure AD Conditional Access documentation](https://docs.microsoft.com/en-us/azure/active-directory/conditional-access/)\r\n- [Identity Protection and B2B Users](https://docs.microsoft.com/en-us/azure/active-directory/identity-protection/concept-identity-protection-b2b)\r\n"
                        },
                        "conditionalVisibility": {
                          "parameterName": "Guide",
                          "comparison": "isEqualTo",
                          "value": "On"
                        },
                        "showPin": false,
                        "name": "text_guide_signinstatus_outbound"
                      },
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "SigninLogs\r\n| project\r\n    TimeGenerated,\r\n    UserPrincipalName,\r\n    ResourceTenantId,\r\n    AADTenantId,\r\n    Id,\r\n    HomeTenantId,\r\n    ResourceDisplayName,\r\n    ResourceIdentity,\r\n    Status,\r\n    AppDisplayName,\r\n    UserId,\r\n    ResultDescription\r\n| where UserId != \"00000000-0000-0000-0000-000000000000\"\r\n| where \"{User:escape}\" == \"All users\" or UserPrincipalName has \"{User:escape}\"\r\n| where \"{Application:escape}\" == \"All applications\" or ResourceDisplayName has \"{Application:escape}\"\r\n| where \"{ExternalTenantId:escape}\" == \"All external tenants\" or ResourceTenantId has \"{ExternalTenantId:escape}\"\r\n| extend status = case(Status.errorCode == 0, \"Success\", \"Failure\")\r\n| where \"{Status}\" == status or \"{Status}\" == \"All\"\r\n| extend statusCode = Status.errorCode\r\n| extend statusReason = case(status == \"Success\", \"Success\",tostring(Status.failureReason))\r\n| where HomeTenantId != ''\r\n| where ResourceTenantId ==\"{SelectedTenantId:escape}\"\r\n| summarize statusCount = count(), OutboundAppUsers = dcount(UserPrincipalName) by tostring(statusReason),tostring(statusCode), status\r\n| sort by statusCount desc \r\n| project statusCount, status,statusCode,\r\n    statusReason",
                          "size": 0,
                          "showAnalytics": true,
                          "title": "Outbound Sign-In Status Summary for Selected External Tenant",
                          "noDataMessage": "Please select an external tenant ID with outbound sign-in activity",
                          "timeContext": {
                            "durationMs": 2419200000
                          },
                          "timeContextFromParameter": "TimeRange",
                          "queryType": 0,
                          "resourceType": "microsoft.operationalinsights/workspaces",
                          "crossComponentResources": [
                            "{Workspace}"
                          ],
                          "gridSettings": {
                            "formatters": [
                              {
                                "columnMatch": "statusCount",
                                "formatter": 4,
                                "formatOptions": {
                                  "palette": "magenta",
                                  "customColumnWidthSetting": "10%"
                                }
                              },
                              {
                                "columnMatch": "status",
                                "formatter": 18,
                                "formatOptions": {
                                  "thresholdsOptions": "icons",
                                  "thresholdsGrid": [
                                    {
                                      "operator": "==",
                                      "thresholdValue": "Failure",
                                      "representation": "failed",
                                      "text": "{0}{1}"
                                    },
                                    {
                                      "operator": "==",
                                      "thresholdValue": "Success",
                                      "representation": "success",
                                      "text": "{0}{1}"
                                    },
                                    {
                                      "operator": "Default",
                                      "thresholdValue": null,
                                      "representation": "unknown",
                                      "text": "{0}{1}"
                                    }
                                  ]
                                }
                              },
                              {
                                "columnMatch": "statusCode",
                                "formatter": 1
                              },
                              {
                                "columnMatch": "statusReason",
                                "formatter": 1,
                                "formatOptions": {
                                  "customColumnWidthSetting": "60%"
                                }
                              }
                            ],
                            "labelSettings": [
                              {
                                "columnId": "statusCount",
                                "label": "Status Count"
                              },
                              {
                                "columnId": "status",
                                "label": "Status"
                              },
                              {
                                "columnId": "statusCode",
                                "label": "Status Code"
                              },
                              {
                                "columnId": "statusReason",
                                "label": "Status Reason"
                              }
                            ]
                          }
                        },
                        "conditionalVisibilities": [
                          {
                            "parameterName": "activityScope",
                            "comparison": "isNotEqualTo",
                            "value": "inbound"
                          },
                          {
                            "parameterName": "SelectedTenantId",
                            "comparison": "isNotEqualTo",
                            "value": "null"
                          }
                        ],
                        "name": "query_signinstatus_outbound"
                      }
                    ]
                  },
                  "name": "group_outbound_signin"
                },
                {
                  "type": 12,
                  "content": {
                    "version": "NotebookGroup/1.0",
                    "groupType": "editable",
                    "items": [
                      {
                        "type": 1,
                        "content": {
                          "json": "# Step 3 - Review applications accessed in the external tenant\r\nAfter selecting the external tenant above, select an application below to filter by users accessing that application in **Step 4**."
                        },
                        "customWidth": "60",
                        "conditionalVisibility": {
                          "parameterName": "Guide",
                          "comparison": "isEqualTo",
                          "value": "On"
                        },
                        "name": "text_guide_step3_outbound"
                      },
                      {
                        "type": 1,
                        "content": {
                          "json": "# Step 4 - Review users accessing the selected application in the external tenant\r\nReview the list of users who are accessing the resource in the external tenant."
                        },
                        "customWidth": "40",
                        "conditionalVisibility": {
                          "parameterName": "Guide",
                          "comparison": "isEqualTo",
                          "value": "On"
                        },
                        "name": "text_guide_step4_outbound"
                      },
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "SigninLogs\r\n| project\r\n    TimeGenerated,\r\n    UserPrincipalName,\r\n    ResourceTenantId,\r\n    AADTenantId,\r\n    Id,\r\n    HomeTenantId,\r\n    ResourceDisplayName,\r\n    ResourceIdentity,\r\n    Status,\r\n    AppDisplayName,\r\n    UserId\r\n| where UserId != \"00000000-0000-0000-0000-000000000000\"\r\n| where \"{User:escape}\" == \"All users\" or UserPrincipalName has \"{User:escape}\"\r\n| where \"{Application:escape}\" == \"All applications\" or ResourceDisplayName has \"{Application:escape}\"\r\n| where \"{ExternalTenantId:escape}\" == \"All external tenants\" or ResourceTenantId has \"{ExternalTenantId:escape}\"\r\n| extend status = case(Status.errorCode == 0, \"Success\", \"Failure\")\r\n| where \"{Status}\" == status or \"{Status}\" == \"All\"\r\n| where HomeTenantId != ''\r\n| where ResourceTenantId ==\"{SelectedTenantId:escape}\"\r\n| summarize OutboundAppSignInsTotal = dcount(Id) , OutboundSignInsFailure = countif(status == 'Failure'), OutboundAppUsers = dcount(UserPrincipalName) by ResourceIdentity,ResourceDisplayName\r\n| sort by OutboundAppSignInsTotal desc\r\n| project ResourceIdentity,\r\n    ResourceDisplayName,\r\n    OutboundAppUsers,\r\n    OutboundAppSignInsTotal,\r\n    OutboundSignInsFailure",
                          "size": 0,
                          "showAnalytics": true,
                          "title": "Outbound application activity by selected tenant",
                          "noDataMessage": "Please select an external tenant ID with outbound sign-in activity",
                          "timeContext": {
                            "durationMs": 2419200000
                          },
                          "timeContextFromParameter": "TimeRange",
                          "exportFieldName": "ResourceIdentity",
                          "exportParameterName": "SelectedAppId",
                          "exportDefaultValue": "All apps",
                          "showExportToExcel": true,
                          "queryType": 0,
                          "resourceType": "microsoft.operationalinsights/workspaces",
                          "crossComponentResources": [
                            "{Workspace}"
                          ],
                          "gridSettings": {
                            "formatters": [
                              {
                                "columnMatch": "ResourceIdentity",
                                "formatter": 1
                              },
                              {
                                "columnMatch": "ResourceDisplayName",
                                "formatter": 1
                              },
                              {
                                "columnMatch": "OutboundAppUsers",
                                "formatter": 4,
                                "formatOptions": {
                                  "palette": "orange"
                                }
                              },
                              {
                                "columnMatch": "OutboundAppSignInsTotal",
                                "formatter": 4,
                                "formatOptions": {
                                  "palette": "blue"
                                }
                              },
                              {
                                "columnMatch": "OutboundSignInsFailure",
                                "formatter": 4,
                                "formatOptions": {
                                  "palette": "redDark"
                                }
                              },
                              {
                                "columnMatch": "Resource Tenant",
                                "formatter": 5
                              }
                            ],
                            "rowLimit": 10000,
                            "filter": true,
                            "sortBy": [
                              {
                                "itemKey": "$gen_bar_OutboundAppUsers_2",
                                "sortOrder": 1
                              }
                            ],
                            "labelSettings": [
                              {
                                "columnId": "ResourceIdentity",
                                "label": "External App Id"
                              },
                              {
                                "columnId": "ResourceDisplayName",
                                "label": "External App Display Name"
                              },
                              {
                                "columnId": "OutboundAppUsers",
                                "label": "Outbound App Users"
                              },
                              {
                                "columnId": "OutboundAppSignInsTotal",
                                "label": "Outbound App Sign-Ins Total"
                              },
                              {
                                "columnId": "OutboundSignInsFailure",
                                "label": "Outbound App Sign-Ins Failures"
                              }
                            ]
                          },
                          "sortBy": [
                            {
                              "itemKey": "$gen_bar_OutboundAppUsers_2",
                              "sortOrder": 1
                            }
                          ]
                        },
                        "customWidth": "60",
                        "conditionalVisibilities": [
                          {
                            "parameterName": "ActivityScope",
                            "comparison": "isNotEqualTo",
                            "value": "inbound"
                          },
                          {
                            "parameterName": "SelectedTenantId",
                            "comparison": "isNotEqualTo",
                            "value": "null"
                          }
                        ],
                        "name": "query_apps_outbound"
                      },
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "SigninLogs\r\n| project\r\n    TimeGenerated,\r\n    UserPrincipalName,\r\n    ResourceTenantId,\r\n    AADTenantId,\r\n    Id,\r\n    HomeTenantId,\r\n    ResourceDisplayName,\r\n    ResourceIdentity,\r\n    Status,\r\n    AppDisplayName,\r\n    UserId\r\n| where UserId != \"00000000-0000-0000-0000-000000000000\"\r\n| where \"{User:escape}\" == \"All users\" or UserPrincipalName has \"{User:escape}\"\r\n| where \"{Application:escape}\" == \"All applications\" or ResourceDisplayName has \"{Application:escape}\"\r\n| where \"{ExternalTenantId:escape}\" == \"All external tenants\" or ResourceTenantId has \"{ExternalTenantId:escape}\"\r\n| extend status = case(Status.errorCode == 0, \"Success\", \"Failure\")\r\n| where \"{Status}\" == status or \"{Status}\" == \"All\"\r\n| where HomeTenantId != ''\r\n| where ResourceTenantId ==\"{SelectedTenantId:escape}\"\r\n| where \"{SelectedAppId:escape}\" == \"All apps\" or ResourceIdentity has \"{SelectedAppId:escape}\"\r\n| summarize OutboundAppUserSignInsTotal = dcount(Id) , OutboundAppUserSignInsFailure = countif(status == 'Failure') by UserPrincipalName\r\n| sort by OutboundAppUserSignInsTotal desc\r\n| project UserPrincipalName,\r\nOutboundAppUserSignInsTotal,\r\nOutboundAppUserSignInsFailure",
                          "size": 0,
                          "showAnalytics": true,
                          "title": "Outbound user activity by selected application",
                          "noDataMessage": "Please select an external tenant ID with outbound sign-in activity",
                          "timeContext": {
                            "durationMs": 2419200000
                          },
                          "timeContextFromParameter": "TimeRange",
                          "exportFieldName": "UserPrincipalName",
                          "exportParameterName": "user",
                          "showExportToExcel": true,
                          "queryType": 0,
                          "resourceType": "microsoft.operationalinsights/workspaces",
                          "crossComponentResources": [
                            "{Workspace}"
                          ],
                          "gridSettings": {
                            "formatters": [
                              {
                                "columnMatch": "UserPrincipalName",
                                "formatter": 1,
                                "formatOptions": {
                                  "customColumnWidthSetting": "20%"
                                }
                              },
                              {
                                "columnMatch": "OutboundAppUserSignInsTotal",
                                "formatter": 4,
                                "formatOptions": {
                                  "palette": "blue",
                                  "customColumnWidthSetting": "30%"
                                }
                              },
                              {
                                "columnMatch": "OutboundAppUserSignInsFailure",
                                "formatter": 4,
                                "formatOptions": {
                                  "palette": "redDark",
                                  "customColumnWidthSetting": "30%"
                                }
                              }
                            ],
                            "rowLimit": 500,
                            "filter": true,
                            "labelSettings": [
                              {
                                "columnId": "UserPrincipalName",
                                "label": "User ID"
                              },
                              {
                                "columnId": "OutboundAppUserSignInsTotal",
                                "label": "Outbound App Sign-In Total"
                              },
                              {
                                "columnId": "OutboundAppUserSignInsFailure",
                                "label": "Outbound App Sign-in Failures"
                              }
                            ]
                          }
                        },
                        "customWidth": "40",
                        "conditionalVisibility": {
                          "parameterName": "SelectedTenantId",
                          "comparison": "isNotEqualTo",
                          "value": "null"
                        },
                        "name": "query_outbound_users"
                      }
                    ]
                  },
                  "name": "group_outbound_appuser"
                }
              ]
            },
            "conditionalVisibilities": [
              {
                "parameterName": "activityScope",
                "comparison": "isNotEqualTo",
                "value": "inbound"
              },
              {
                "parameterName": "SelectedTenantId",
                "comparison": "isNotEqualTo",
                "value": "null"
              }
            ],
            "name": "group_outbound"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Inbound activity details for selected external tenant",
              "items": [
                {
                  "type": 12,
                  "content": {
                    "version": "NotebookGroup/1.0",
                    "groupType": "editable",
                    "items": [
                      {
                        "type": 1,
                        "content": {
                          "json": "### Inbound sign-in status guide\r\n\r\nReview the sign-in status results for users from external tenants accessing applications in this local tenant.   Policies defined by the local tenant or the external tenant may impact successful sign-in and may require collaboration with the external tenant admin to resolve.\r\n\r\nAdditional information to aid in understanding sign-in results and controls availiable can be found below:\r\n\r\n- [Azure AD Authentication and authorization error codes](https://docs.microsoft.com/en-us/azure/active-directory/develop/reference-aadsts-error-codes)\r\n- [Restrict access to a tenant](https://docs.microsoft.com/en-us/azure/active-directory/manage-apps/tenant-restrictions)\r\n- [Azure AD Conditional Access documentation](https://docs.microsoft.com/en-us/azure/active-directory/conditional-access/)\r\n- [Identity Protection and B2B Users](https://docs.microsoft.com/en-us/azure/active-directory/identity-protection/concept-identity-protection-b2b)"
                        },
                        "conditionalVisibility": {
                          "parameterName": "Guide",
                          "comparison": "isEqualTo",
                          "value": "On"
                        },
                        "name": "text_guide_inbound_signinstatus"
                      },
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "SigninLogs\r\n| project\r\n    TimeGenerated,\r\n    UserPrincipalName,\r\n    ResourceTenantId,\r\n    AADTenantId,\r\n    Id,\r\n    HomeTenantId,\r\n    ResourceDisplayName,\r\n    ResourceIdentity,\r\n    Status,\r\n    AppDisplayName,\r\n    UserId,\r\n    ResultDescription\r\n| where UserId != \"00000000-0000-0000-0000-000000000000\"\r\n| where \"{User:escape}\" == \"All users\" or UserPrincipalName has \"{User:escape}\"\r\n| where \"{Application:escape}\" == \"All applications\" or ResourceDisplayName has \"{Application:escape}\"\r\n| where \"{ExternalTenantId:escape}\" == \"All external tenants\" or HomeTenantId has \"{ExternalTenantId:escape}\"\r\n| extend status = case(Status.errorCode == 0, \"Success\", \"Failure\")\r\n| where \"{Status}\" == status or \"{Status}\" == \"All\"\r\n| extend statusCode = Status.errorCode\r\n| extend statusReason = case(status == \"Success\", \"Success\",tostring(Status.failureReason))\r\n| where HomeTenantId == \"{SelectedTenantId:escape}\"\r\n| where ResourceTenantId == AADTenantId\r\n| summarize statusCount = count(), OutboundAppUsers = dcount(UserPrincipalName) by tostring(statusReason),tostring(statusCode), status\r\n| sort by statusCount desc\r\n| project statusCount, status,statusCode,\r\n    statusReason",
                          "size": 0,
                          "showAnalytics": true,
                          "title": "Inbound sign-in status summary for selected external tenant",
                          "noDataMessage": "Please select an external tenant ID with inbound sign-in activity",
                          "timeContext": {
                            "durationMs": 2419200000
                          },
                          "timeContextFromParameter": "TimeRange",
                          "showExportToExcel": true,
                          "queryType": 0,
                          "resourceType": "microsoft.operationalinsights/workspaces",
                          "crossComponentResources": [
                            "{Workspace}"
                          ],
                          "gridSettings": {
                            "formatters": [
                              {
                                "columnMatch": "statusCount",
                                "formatter": 4,
                                "formatOptions": {
                                  "palette": "magenta",
                                  "customColumnWidthSetting": "10%"
                                }
                              },
                              {
                                "columnMatch": "status",
                                "formatter": 18,
                                "formatOptions": {
                                  "thresholdsOptions": "icons",
                                  "thresholdsGrid": [
                                    {
                                      "operator": "==",
                                      "thresholdValue": "Failure",
                                      "representation": "failed",
                                      "text": "{0}{1}"
                                    },
                                    {
                                      "operator": "==",
                                      "thresholdValue": "Success",
                                      "representation": "success",
                                      "text": "{0}{1}"
                                    },
                                    {
                                      "operator": "Default",
                                      "thresholdValue": null,
                                      "representation": "unknown",
                                      "text": "{0}{1}"
                                    }
                                  ]
                                }
                              },
                              {
                                "columnMatch": "statusCode",
                                "formatter": 1
                              },
                              {
                                "columnMatch": "statusReason",
                                "formatter": 1,
                                "formatOptions": {
                                  "customColumnWidthSetting": "60%"
                                }
                              }
                            ],
                            "filter": true,
                            "labelSettings": [
                              {
                                "columnId": "statusCount",
                                "label": "Sign-In Status Count"
                              },
                              {
                                "columnId": "status",
                                "label": "Status"
                              },
                              {
                                "columnId": "statusCode",
                                "label": "Sign-In Status Code"
                              },
                              {
                                "columnId": "statusReason",
                                "label": "Sign-In Status Reason"
                              }
                            ]
                          },
                          "sortBy": []
                        },
                        "conditionalVisibilities": [
                          {
                            "parameterName": "activityScope",
                            "comparison": "isNotEqualTo",
                            "value": "outbound"
                          },
                          {
                            "parameterName": "SelectedTenantID",
                            "comparison": "isNotEqualTo",
                            "value": "null"
                          }
                        ],
                        "name": "query_inbound_signinstatus"
                      }
                    ]
                  },
                  "name": "group_inbound_signin"
                },
                {
                  "type": 12,
                  "content": {
                    "version": "NotebookGroup/1.0",
                    "groupType": "editable",
                    "items": [
                      {
                        "type": 1,
                        "content": {
                          "json": "# Step 3 - Review local applications accessed from the external tenant\r\nAfter selecting the external tenant above, select an application below to filter by external users accessing that application in **Step 4**."
                        },
                        "customWidth": "60",
                        "conditionalVisibility": {
                          "parameterName": "Guide",
                          "comparison": "isEqualTo",
                          "value": "On"
                        },
                        "name": "text_guide_step3_inbound"
                      },
                      {
                        "type": 1,
                        "content": {
                          "json": "# Step 4 - Review external users accessing the selected local application from the external tenant\r\nReview the list of external users who are accessing the local resource from the external tenant."
                        },
                        "customWidth": "40",
                        "conditionalVisibility": {
                          "parameterName": "Guide",
                          "comparison": "isEqualTo",
                          "value": "On"
                        },
                        "name": "text_guide_step4_inbound"
                      },
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "SigninLogs\r\n| project\r\n    TimeGenerated,\r\n    UserPrincipalName,\r\n    ResourceTenantId,\r\n    AADTenantId,\r\n    Id,\r\n    HomeTenantId,\r\n    ResourceDisplayName,\r\n    ResourceIdentity,\r\n    Status,\r\n    AppDisplayName,\r\n    UserId\r\n| where UserId != \"00000000-0000-0000-0000-000000000000\"\r\n//| where TimeGenerated {TimeRange:value}\r\n| where \"{User:escape}\" == \"All users\" or UserPrincipalName has \"{User:escape}\"\r\n| where \"{Application:escape}\" == \"All applications\" or ResourceDisplayName has \"{Application:escape}\"\r\n| where \"{ExternalTenantId:escape}\" == \"All external tenants\" or HomeTenantId has \"{ExternalTenantId:escape}\"\r\n| extend status = case(Status.errorCode == 0, \"Success\", \"Failure\")\r\n| where \"{Status}\" == status or \"{Status}\" == \"All\"\r\n| where HomeTenantId ==\"{SelectedTenantId:escape}\"\r\n| where ResourceTenantId == AADTenantId\r\n| summarize InboundAppSignInsTotal = dcount(Id) , InboundSignInsFailure = countif(status == 'Failure'), InboundAppUsers = dcount(UserPrincipalName) by ResourceIdentity,ResourceDisplayName\r\n| sort by InboundAppSignInsTotal desc\r\n| project ResourceIdentity,\r\n    ResourceDisplayName,\r\n    InboundAppUsers,\r\n    InboundAppSignInsTotal,\r\n    InboundSignInsFailure",
                          "size": 0,
                          "showAnalytics": true,
                          "title": "Inbound Application Activity By Selected Tenant",
                          "noDataMessage": "Please select an external tenant ID with inbound sign-in activity",
                          "timeContext": {
                            "durationMs": 2419200000
                          },
                          "timeContextFromParameter": "TimeRange",
                          "exportFieldName": "ResourceIdentity",
                          "exportParameterName": "SelectedAppId",
                          "exportDefaultValue": "All apps",
                          "showExportToExcel": true,
                          "queryType": 0,
                          "resourceType": "microsoft.operationalinsights/workspaces",
                          "crossComponentResources": [
                            "{Workspace}"
                          ],
                          "gridSettings": {
                            "formatters": [
                              {
                                "columnMatch": "ResourceIdentity",
                                "formatter": 1
                              },
                              {
                                "columnMatch": "ResourceDisplayName",
                                "formatter": 1
                              },
                              {
                                "columnMatch": "InboundAppUsers",
                                "formatter": 4,
                                "formatOptions": {
                                  "palette": "orange"
                                }
                              },
                              {
                                "columnMatch": "InboundAppSignInsTotal",
                                "formatter": 4,
                                "formatOptions": {
                                  "palette": "blue"
                                }
                              },
                              {
                                "columnMatch": "InboundSignInsFailure",
                                "formatter": 4,
                                "formatOptions": {
                                  "palette": "redDark"
                                }
                              },
                              {
                                "columnMatch": "Resource Tenant",
                                "formatter": 5
                              }
                            ],
                            "rowLimit": 10000,
                            "sortBy": [
                              {
                                "itemKey": "$gen_bar_InboundAppUsers_2",
                                "sortOrder": 2
                              }
                            ],
                            "labelSettings": [
                              {
                                "columnId": "ResourceIdentity",
                                "label": "Local App Id"
                              },
                              {
                                "columnId": "ResourceDisplayName",
                                "label": "Local App Display Name"
                              },
                              {
                                "columnId": "InboundAppUsers",
                                "label": "Inbound App Users"
                              },
                              {
                                "columnId": "InboundAppSignInsTotal",
                                "label": "Inbound App Sign-Ins Total"
                              },
                              {
                                "columnId": "InboundSignInsFailure",
                                "label": "Inbound App Sign-Ins Failures"
                              }
                            ]
                          },
                          "sortBy": [
                            {
                              "itemKey": "$gen_bar_InboundAppUsers_2",
                              "sortOrder": 2
                            }
                          ]
                        },
                        "customWidth": "60",
                        "conditionalVisibility": {
                          "parameterName": "ActivityScope",
                          "comparison": "isNotEqualTo",
                          "value": "outbound"
                        },
                        "name": "query_apps_inbound"
                      },
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "SigninLogs\r\n| project\r\n    TimeGenerated,\r\n    UserPrincipalName,\r\n    ResourceTenantId,\r\n    AADTenantId,\r\n    Id,\r\n    HomeTenantId,\r\n    ResourceDisplayName,\r\n    ResourceIdentity,\r\n    Status,\r\n    AppDisplayName,\r\n    UserId\r\n| where UserId != \"00000000-0000-0000-0000-000000000000\"\r\n| where TimeGenerated {TimeRange:value}\r\n| where \"{User:escape}\" == \"All users\" or UserPrincipalName has \"{User:escape}\"\r\n| where \"{Application:escape}\" == \"All applications\" or ResourceDisplayName has \"{Application:escape}\"\r\n| where \"{ExternalTenantId:escape}\" == \"All external tenants\" or ResourceTenantId has \"{ExternalTenantId:escape}\"\r\n| extend status = case(Status.errorCode == 0, \"Success\", \"Failure\")\r\n| where \"{Status}\" == status or \"{Status}\" == \"All\"\r\n| where HomeTenantId == \"{SelectedTenantId:escape}\"\r\n| where ResourceTenantId == AADTenantId\r\n| where \"{SelectedAppId:escape}\" == \"All apps\" or ResourceIdentity has \"{SelectedAppId:escape}\"\r\n| summarize InboundAppUserSignInsTotal = dcount(Id) , InboundAppUserSignInsFailure = countif(status == 'Failure') by UserPrincipalName\r\n| sort by InboundAppUserSignInsTotal desc\r\n| project UserPrincipalName,\r\nInboundAppUserSignInsTotal,\r\nInboundAppUserSignInsFailure",
                          "size": 0,
                          "showAnalytics": true,
                          "title": "Inbound user activity by selected application",
                          "noDataMessage": "Please select an external tenant ID with inbound sign-in activity",
                          "timeContext": {
                            "durationMs": 2419200000
                          },
                          "timeContextFromParameter": "TimeRange",
                          "exportFieldName": "UserPrincipalName",
                          "exportParameterName": "user",
                          "showExportToExcel": true,
                          "queryType": 0,
                          "resourceType": "microsoft.operationalinsights/workspaces",
                          "crossComponentResources": [
                            "{Workspace}"
                          ],
                          "gridSettings": {
                            "formatters": [
                              {
                                "columnMatch": "UserPrincipalName",
                                "formatter": 1,
                                "formatOptions": {
                                  "customColumnWidthSetting": "20%"
                                }
                              },
                              {
                                "columnMatch": "InboundAppUserSignInsTotal",
                                "formatter": 4,
                                "formatOptions": {
                                  "palette": "blue",
                                  "customColumnWidthSetting": "30%"
                                }
                              },
                              {
                                "columnMatch": "InboundAppUserSignInsFailure",
                                "formatter": 4,
                                "formatOptions": {
                                  "palette": "redDark",
                                  "customColumnWidthSetting": "30%"
                                }
                              }
                            ],
                            "rowLimit": 500,
                            "filter": true,
                            "labelSettings": [
                              {
                                "columnId": "UserPrincipalName",
                                "label": "User ID"
                              },
                              {
                                "columnId": "InboundAppUserSignInsTotal",
                                "label": "Inbound App Sign-Ins Total"
                              },
                              {
                                "columnId": "InboundAppUserSignInsFailure",
                                "label": "Inbound App Sign-Ins Failures"
                              }
                            ]
                          }
                        },
                        "customWidth": "40",
                        "conditionalVisibility": {
                          "parameterName": "SelectedTenantId",
                          "comparison": "isNotEqualTo",
                          "value": "null"
                        },
                        "name": "query_users_inbound"
                      }
                    ]
                  },
                  "name": "group_inbound_appuser"
                }
              ],
              "exportParameters": true
            },
            "conditionalVisibilities": [
              {
                "parameterName": "activityScope",
                "comparison": "isNotEqualTo",
                "value": "outbound"
              },
              {
                "parameterName": "SelectedTenantId",
                "comparison": "isNotEqualTo",
                "value": "null"
              }
            ],
            "name": "group_inbound"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "SelectedTenantId",
        "comparison": "isNotEqualTo",
        "value": ""
      },
      "name": "group_selectedtenant"
    },
    {
      "type": 1,
      "content": {
        "json": "# Select external tenant from above table to view more details",
        "style": "info"
      },
      "conditionalVisibility": {
        "parameterName": "SelectedTenantId",
        "comparison": "isEqualTo"
      },
      "name": "text_selecttenant"
    }
  ],

  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}