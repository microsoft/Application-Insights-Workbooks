{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "crossComponentResources": [
          "value::all"
        ],
        "parameters": [
          {
            "id": "88df9a87-9c9f-4b69-918e-eb6d70e5c1c6",
            "version": "KqlParameterItem/1.0",
            "name": "SqlMonitoringProfile",
            "type": 1,
            "description": "Set the default subscription retrieved from SQL Server Insights Template",
            "value": "",
            "isHiddenWhenLocked": true,
            "timeContext": {
              "durationMs": 86400000
            }
          },
          {
            "id": "38e8be22-d88c-4a9e-8933-f84f495e1aef",
            "version": "KqlParameterItem/1.0",
            "name": "MonitoringProfile",
            "type": 5,
            "isRequired": true,
            "value": null,
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            }
          },
          {
            "id": "8f5b97db-4d2a-49d4-9f49-a73a9b002ab7",
            "version": "KqlParameterItem/1.0",
            "name": "Associations",
            "type": 2,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "jsonData": "[]",
            "timeContext": {
              "durationMs": 86400000
            }
          },
          {
            "id": "5a0e004e-b906-40e2-9d95-ed370245eaef",
            "version": "KqlParameterItem/1.0",
            "name": "ResourceGroup",
            "type": 5,
            "isRequired": true,
            "query": "Resources\r\n| where id =~ '{MonitoringProfile}'\r\n| project rg = strcat('/subscriptions/', subscriptionId, '/resourceGroups/', resourceGroup)\r\n| project value = rg, label = rg, selected = true",
            "crossComponentResources": [
              "value::all"
            ],
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "7bae1632-f3b2-402e-b4ca-5d9870343c3c",
            "version": "KqlParameterItem/1.0",
            "name": "Workspaces",
            "type": 5,
            "isRequired": true,
            "value": null,
            "typeSettings": {
              "additionalResourceOptions": []
            },
            "timeContext": {
              "durationMs": 86400000
            }
          },
          {
            "id": "4cc2a2af-8213-45d4-84bd-0728a196fdee",
            "version": "KqlParameterItem/1.0",
            "name": "CommonErrors",
            "type": 1,
            "isRequired": true,
            "value": "",
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "multiLineText": true,
              "editorLanguage": "json"
            }
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.resourcegraph/resources"
      },
      "conditionalVisibility": {
        "parameterName": "visible",
        "comparison": "isEqualTo",
        "value": "false"
      },
      "name": "parameters - 1"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "crossComponentResources": [
                "value::all"
              ],
              "parameters": [
                {
                  "id": "55ca83d6-c66a-4869-a02f-4f8dcfa1a67e",
                  "version": "KqlParameterItem/1.0",
                  "name": "ResourceGroup",
                  "label": "Resource group",
                  "type": 5,
                  "isRequired": true,
                  "query": "Resources\r\n| where id =~ '{MonitoringProfile}'\r\n| project rg = strcat('/subscriptions/', subscriptionId, '/resourceGroups/', resourceGroup)\r\n| project value = rg, label = rg, selected = true",
                  "crossComponentResources": [
                    "value::all"
                  ],
                  "isHiddenWhenLocked": true,
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources"
                }
              ],
              "style": "above",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources"
            },
            "name": "parameters - 2"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "nav",
              "links": [
                {
                  "id": "040d1ae4-6692-4937-9588-20a7ae073808",
                  "cellValue": "{MonitoringProfile}",
                  "linkTarget": "Resource",
                  "linkLabel": "{MonitoringProfile:name}",
                  "preText": "Profile: ",
                  "style": "link"
                },
                {
                  "id": "98b6e325-9253-40c1-aac5-871e26dc2db1",
                  "cellValue": "{Workspaces}",
                  "linkTarget": "Resource",
                  "linkLabel": "{Workspaces:name}",
                  "preText": "Workspace: ",
                  "style": "link"
                }
              ]
            },
            "name": "Resource links"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "nav",
              "links": [
                {
                  "id": "657f86c3-9ab9-4c46-abb2-48c6ccfe70bb",
                  "linkTarget": "WorkbookTemplate",
                  "linkLabel": "Add monitoring machine",
                  "style": "primary",
                  "linkIsContextBlade": true,
                  "workbookContext": {
                    "componentIdSource": "workbook",
                    "resourceIdsSource": "parameter",
                    "resourceIds": "MonitoringProfile",
                    "templateIdSource": "static",
                    "templateId": "Community-Workbooks/Workloads-AMA/Add monitoring virtual machine",
                    "typeSource": "static",
                    "type": "workload-onboarding",
                    "gallerySource": "static",
                    "gallery": "Azure Monitor",
                    "locationSource": "default",
                    "passSpecificParams": true,
                    "templateParameters": [
                      {
                        "name": "MonitoringProfile",
                        "source": "parameter",
                        "value": "MonitoringProfile"
                      },
                      {
                        "name": "SqlMonitoringProfile",
                        "source": "parameter",
                        "value": "SqlMonitoringProfile"
                      }
                    ]
                  }
                },
                {
                  "id": "051b7a37-019a-47ca-903b-ec53dad7d0f5",
                  "linkTarget": "WorkbookTemplate",
                  "linkLabel": "Edit Profile",
                  "style": "secondary",
                  "linkIsContextBlade": true,
                  "workbookContext": {
                    "componentIdSource": "workbook",
                    "resourceIdsSource": "parameter",
                    "resourceIds": "MonitoringProfile",
                    "templateIdSource": "static",
                    "templateId": "Community-Workbooks/Workloads-AMA/Edit profile",
                    "typeSource": "static",
                    "type": "workload-onboarding",
                    "gallerySource": "static",
                    "gallery": "Azure Monitor",
                    "locationSource": "default"
                  }
                }
              ]
            },
            "name": "Action links",
            "styleSettings": {
              "margin": "10px 0 5px -10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Operation\r\n| where Detail !contains \"mssql: Incorrect syntax near ','.\"\r\n| summarize Errors = countif(OperationStatus == 'Error'), All = count() by _ResourceId\r\n| join kind=fullouter(\r\n    InsightsMetrics\r\n    | extend Tags = todynamic(Tags)\r\n    | extend SqlInstance = tostring(Tags.sql_instance)\r\n    | where TimeGenerated > ago(10m) and isnotempty(SqlInstance) and Namespace == 'sqlserver_server_properties' and Name == 'uptime'\r\n    | summarize by _ResourceId, HasMetrics = true)\r\n    on _ResourceId\r\n| project Vm = iff(isempty(_ResourceId), _ResourceId1, _ResourceId), Errors, All, HasMetrics, Status = iff(HasMetrics, iff(Errors < 1 or isempty(Errors), 'Collecting', 'Collecting with errors'), 'Not Collecting'), LogsFilter = iff(Errors < 1 or isempty(Errors), \"All Logs\", \"Errors\")",
              "size": 0,
              "title": "VMs receiving metrics in the last 10 minutes",
              "noDataMessage": "No SQL Insights metrics are being sent to this workspace",
              "noDataMessageStyle": 4,
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspaces}"
              ],
              "gridSettings": {
                "filter": true
              }
            },
            "conditionalVisibility": {
              "parameterName": "visible",
              "comparison": "isNotEqualTo"
            },
            "showPin": false,
            "name": "Health query"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\n| take 1\n| project associations = dynamic([{Associations}])\n| mvexpand associations limit 400\n| project id = tolower(extract(@'(?i)(.+)/providers/microsoft.insights/datacollectionruleassociations/.+', 1, tostring(associations)))\n| join kind = inner (Resources\n  | where type =~ 'microsoft.compute/virtualmachines'\n  | extend id = tolower(id)\n  ) on id\n| project Vm = id, Subscription = strcat('/subscriptions/', subscriptionId), ResourceGroup = strcat('/subscriptions/', subscriptionId, '/resourceGroups/', resourceGroup), location = location, Action = 'Configure'",
              "size": 0,
              "title": "Monitoring state",
              "noDataMessage": "This profile does not have any associated monitoring virtual machines. Associate one using the Add monitoring machine button.",
              "noDataMessageStyle": 4,
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "value::all"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "ResourceGroup",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "location",
                    "formatter": 17
                  },
                  {
                    "columnMatch": "Action",
                    "formatter": 7,
                    "formatOptions": {
                      "linkTarget": "WorkbookTemplate",
                      "linkIsContextBlade": true,
                      "workbookContext": {
                        "componentIdSource": "workbook",
                        "resourceIdsSource": "column",
                        "resourceIds": "Vm",
                        "templateIdSource": "static",
                        "templateId": "Community-Workbooks/Workloads-AMA/Update monitoring vm config",
                        "typeSource": "static",
                        "type": "workload-onboarding",
                        "gallerySource": "static",
                        "gallery": "Azure Monitor",
                        "locationSource": "default",
                        "passSpecificParams": true,
                        "templateParameters": [
                          {
                            "name": "VirtualMachine",
                            "source": "column",
                            "value": "Vm"
                          }
                        ]
                      }
                    }
                  }
                ],
                "filter": true,
                "labelSettings": [
                  {
                    "columnId": "Vm",
                    "label": "Virtual machine"
                  },
                  {
                    "columnId": "ResourceGroup",
                    "label": "Resource group"
                  },
                  {
                    "columnId": "location",
                    "label": "Location"
                  }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "visible",
              "comparison": "isNotEqualTo"
            },
            "showPin": false,
            "name": "Vm query"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"3005d536-cf5e-4719-8aca-2e5d4cabd0ad\",\"mergeType\":\"rightouter\",\"leftTable\":\"Health query\",\"rightTable\":\"Vm query\",\"leftColumn\":\"Vm\",\"rightColumn\":\"Vm\"}],\"projectRename\":[{\"originalName\":\"[Health query].Healthy\",\"mergedName\":\"Healthy\",\"fromId\":\"unknown\"},{\"originalName\":\"[Health query].Errors\",\"mergedName\":\"Errors\",\"fromId\":\"unknown\"},{\"originalName\":\"[Health query].Vm\",\"mergedName\":\"Vm\",\"fromId\":\"3005d536-cf5e-4719-8aca-2e5d4cabd0ad\"},{\"originalName\":\"[Vm query].Vm\",\"mergedName\":\"Virtual machine\",\"fromId\":\"3005d536-cf5e-4719-8aca-2e5d4cabd0ad\"},{\"originalName\":\"[Health query].Status\",\"mergedName\":\"Status\",\"fromId\":\"3005d536-cf5e-4719-8aca-2e5d4cabd0ad\"},{\"originalName\":\"[Vm query].Subscription\",\"mergedName\":\"Subscription\",\"fromId\":\"3005d536-cf5e-4719-8aca-2e5d4cabd0ad\"},{\"originalName\":\"[Vm query].ResourceGroup\",\"mergedName\":\"Resource group\",\"fromId\":\"3005d536-cf5e-4719-8aca-2e5d4cabd0ad\"},{\"originalName\":\"[Vm query].location\",\"mergedName\":\"Location\",\"fromId\":\"3005d536-cf5e-4719-8aca-2e5d4cabd0ad\"},{\"originalName\":\"[Vm query].Action\",\"mergedName\":\"Action\",\"fromId\":\"3005d536-cf5e-4719-8aca-2e5d4cabd0ad\"},{\"originalName\":\"[Health query].All\",\"mergedName\":\"All\",\"fromId\":\"unknown\"},{\"originalName\":\"[Health query].HasMetrics\",\"mergedName\":\"HasMetrics\",\"fromId\":\"unknown\"},{\"originalName\":\"[Health query].Action\",\"mergedName\":\"Action\",\"fromId\":\"unknown\"},{\"originalName\":\"[Health query].LogsFilter\",\"mergedName\":\"LogsFilter\",\"fromId\":\"unknown\"}]}",
              "size": 0,
              "title": "Monitoring state",
              "noDataMessage": "This profile does not have any associated monitoring virtual machines. Associate one using the Add monitoring machine button.",
              "noDataMessageStyle": 4,
              "queryType": 7,
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Errors",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "Vm",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "Status",
                    "formatter": 18,
                    "formatOptions": {
                      "linkTarget": "WorkbookTemplate",
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "Collecting with errors",
                          "representation": "2",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Collecting",
                          "representation": "success",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "4",
                          "text": "{0}{1}"
                        }
                      ],
                      "workbookContext": {
                        "componentIdSource": "workbook",
                        "resourceIdsSource": "column",
                        "resourceIds": "Virtual machine",
                        "templateIdSource": "static",
                        "templateId": "Community-Workbooks/Workloads-AMA/Troubleshoot SQL logs",
                        "typeSource": "static",
                        "type": "workload-onboarding",
                        "gallerySource": "static",
                        "gallery": "Azure Monitor",
                        "locationSource": "default",
                        "passSpecificParams": true,
                        "templateParameters": [
                          {
                            "name": "SqlMonitoringProfile",
                            "source": "parameter",
                            "value": "SqlMonitoringProfile"
                          },
                          {
                            "name": "TimeRange",
                            "source": "parameter",
                            "value": "TimeRange"
                          },
                          {
                            "name": "Status",
                            "source": "column",
                            "value": "Status"
                          },
                          {
                            "name": "MonitoringProfile",
                            "source": "parameter",
                            "value": "MonitoringProfile"
                          },
                          {
                            "name": "Associations",
                            "source": "parameter",
                            "value": "Associations"
                          },
                          {
                            "name": "Workspaces",
                            "source": "parameter",
                            "value": "Workspaces"
                          },
                          {
                            "name": "OnboardedComputers",
                            "source": "parameter",
                            "value": "OnboardedComputers"
                          },
                          {
                            "name": "LogsFilter",
                            "source": "column",
                            "value": "LogsFilter"
                          },
                          {
                            "name": "CommonErrors",
                            "source": "parameter",
                            "value": "CommonErrors"
                          }
                        ]
                      }
                    },
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal",
                        "useGrouping": false
                      },
                      "emptyValCustomText": "Not Collecting"
                    }
                  },
                  {
                    "columnMatch": "Subscription",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "Resource group",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "Location",
                    "formatter": 17
                  },
                  {
                    "columnMatch": "Action",
                    "formatter": 7,
                    "formatOptions": {
                      "linkTarget": "WorkbookTemplate",
                      "linkIsContextBlade": true,
                      "workbookContext": {
                        "componentIdSource": "workbook",
                        "resourceIdsSource": "column",
                        "resourceIds": "Virtual machine",
                        "templateIdSource": "static",
                        "templateId": "Community-Workbooks/Workloads-AMA/Update monitoring vm config",
                        "typeSource": "static",
                        "type": "workload-onboarding",
                        "gallerySource": "static",
                        "gallery": "Azure Monitor",
                        "locationSource": "default",
                        "passSpecificParams": true,
                        "templateParameters": [
                          {
                            "name": "VirtualMachine",
                            "source": "column",
                            "value": "Virtual machine"
                          }
                        ]
                      }
                    }
                  },
                  {
                    "columnMatch": "All",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "HasMetrics",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "LogsFilter",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "Virtual machine1",
                    "formatter": 5
                  }
                ],
                "filter": true
              }
            },
            "showPin": false,
            "name": "Monitoring state"
          }
        ]
      },
      "name": "group - 0"
    }
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}