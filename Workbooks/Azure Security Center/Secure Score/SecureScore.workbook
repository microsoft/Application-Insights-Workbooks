{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "## Secure Score + Security Recommendations (Preview)"
      },
      "name": "Title"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "ae721cb1-e030-4e02-8839-9c6a00f66c8a",
            "version": "KqlParameterItem/1.0",
            "name": "Workspace",
            "type": 5,
            "description": "Select workspace",
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "resources\r\n| where type =~ 'microsoft.operationalinsights/workspaces'\r\n| project id",
            "crossComponentResources": [
              "value::all"
            ],
            "value": [],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "4f3a03fd-9968-4ee7-b6bc-d04d3bbe14a8",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "label": "Time Range",
            "type": 4,
            "description": "Select a time range",
            "isRequired": true,
            "value": {
              "durationMs": 2592000000
            },
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 1209600000
                },
                {
                  "durationMs": 2419200000
                },
                {
                  "durationMs": 2592000000
                }
              ],
              "allowCustom": true
            }
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "Parameters"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "**How to configure this workbook**  ",
              "style": "warning"
            },
            "name": "Title"
          },
          {
            "type": 1,
            "content": {
              "json": "To use the Secure Score + Security recommendation workbook, you should first configure **continuous export** to export data to a Log Analytics workspace:\r\n\r\n1. From Security Center's sidebar, select **Pricing & settings**.\r\n2. Select the specific subscription for which you want to configure the data export.\r\n3. From the sidebar of the settings page for that subscription, select **Continuous Export**.\r\n4. Select **Log Analytics workspace** as export target.\r\n5. Select the following data types: **Security recommendations** and **Secure Score (Preview)**\r\n6. Select both **Streaming** and **Snapshots** on export frequency.\r\n7. Select **Save**.\r\n\r\n[See also on our docuemntation](https://docs.microsoft.com/en-us/azure/security-center/continuous-export?tabs=azure-portal#set-up-a-continuous-export)\r\n\r\n> **Notes**\r\n* To get full visabulity, you should wait at least a week to get snapshot of the current state\r\n* To deploy your continuous export configurations across your organization, [use the supplied Azure Policy 'DeployIfNotExist' policies described here to create and configure continuous export procedures](https://docs.microsoft.com/en-us/azure/security-center/continuous-export?tabs=azure-policy#set-up-a-continuous-export)"
            },
            "showPin": false,
            "name": "Instructions"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Workspace",
        "comparison": "isEqualTo"
      },
      "name": "Configuration"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<svg viewBox=\"0 0 19 19\" width=\"20\" class=\"fxt-escapeShadow\" role=\"presentation\" focusable=\"false\" xmlns:svg=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" aria-hidden=\"true\"><g><path fill=\"#1b93eb\" d=\"M16.82 8.886c0 4.81-5.752 8.574-7.006 9.411a.477.477 0 01-.523 0C8.036 17.565 2.18 13.7 2.18 8.886V3.135a.451.451 0 01.42-.419C7.2 2.612 6.154.625 9.5.625s2.3 1.987 6.8 2.091a.479.479 0 01.523.419z\"></path><path fill=\"url(#0024423711759027356)\" d=\"M16.192 8.99c0 4.392-5.333 7.947-6.483 8.575a.319.319 0 01-.418 0c-1.15-.732-6.483-4.183-6.483-8.575V3.762a.575.575 0 01.313-.523C7.2 3.135 6.258 1.357 9.4 1.357s2.2 1.882 6.274 1.882a.45.45 0 01.419.418z\"></path><path d=\"M9.219 5.378a.313.313 0 01.562 0l.875 1.772a.314.314 0 00.236.172l1.957.284a.314.314 0 01.174.535l-1.416 1.38a.312.312 0 00-.09.278l.334 1.949a.313.313 0 01-.455.33l-1.75-.92a.314.314 0 00-.292 0l-1.75.92a.313.313 0 01-.455-.33L7.483 9.8a.312.312 0 00-.09-.278L5.977 8.141a.314.314 0 01.174-.535l1.957-.284a.314.314 0 00.236-.172z\" class=\"msportalfx-svg-c01\"></path></g></svg>&nbsp;<span style=\"font-family: Open Sans; font-weight: 620; font-size: 14px;font-style: bold;margin:-10px -304px 0px 0px;position: relative;top:-5px\"> Current score trends per subscription (not affected by the time range parameter)\r\n</span>"
            },
            "customWidth": "50",
            "name": "text - 3"
          },
          {
            "type": 1,
            "content": {
              "json": "<svg viewBox=\"0 0 19 19\" width=\"20\" class=\"fxt-escapeShadow\" role=\"presentation\" focusable=\"false\" xmlns:svg=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" aria-hidden=\"true\"><g><path fill=\"#1b93eb\" d=\"M16.82 8.886c0 4.81-5.752 8.574-7.006 9.411a.477.477 0 01-.523 0C8.036 17.565 2.18 13.7 2.18 8.886V3.135a.451.451 0 01.42-.419C7.2 2.612 6.154.625 9.5.625s2.3 1.987 6.8 2.091a.479.479 0 01.523.419z\"></path><path fill=\"url(#0024423711759027356)\" d=\"M16.192 8.99c0 4.392-5.333 7.947-6.483 8.575a.319.319 0 01-.418 0c-1.15-.732-6.483-4.183-6.483-8.575V3.762a.575.575 0 01.313-.523C7.2 3.135 6.258 1.357 9.4 1.357s2.2 1.882 6.274 1.882a.45.45 0 01.419.418z\"></path><path d=\"M9.219 5.378a.313.313 0 01.562 0l.875 1.772a.314.314 0 00.236.172l1.957.284a.314.314 0 01.174.535l-1.416 1.38a.312.312 0 00-.09.278l.334 1.949a.313.313 0 01-.455.33l-1.75-.92a.314.314 0 00-.292 0l-1.75.92a.313.313 0 01-.455-.33L7.483 9.8a.312.312 0 00-.09-.278L5.977 8.141a.314.314 0 01.174-.535l1.957-.284a.314.314 0 00.236-.172z\" class=\"msportalfx-svg-c01\"></path></g></svg>&nbsp;<span style=\"font-family: Open Sans; font-weight: 620; font-size: 14px;font-style: bold;margin:-10px 0px 0px 0px;position: relative;top:-3px;left:-4px;\"> Aggregated score for all subscriptions overtime\r\n</span> <br>\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Here we can add additional notes if needed. \r\nTo see more details, go to the **Usage** tab."
            },
            "customWidth": "50",
            "name": "text - 4"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SecureScores\r\n| extend Day = startofday(TimeGenerated)\r\n| summarize arg_max(TimeGenerated, *) by Day, SecureScoresSubscriptionId\r\n| summarize arg_max(Day, *) by SecureScoresSubscriptionId\r\n| join kind = fullouter(\r\n    SecureScores\r\n    | extend Day = startofday(TimeGenerated)\r\n    | summarize arg_max(TimeGenerated, *) by Day, SecureScoresSubscriptionId\r\n    | where Day == startofday(now() - 7d)\r\n    | project OldScoreSevenDays = PercentageScore, SecureScoresSubscriptionId\r\n) on SecureScoresSubscriptionId\r\n| join kind = fullouter(\r\n    SecureScores\r\n    | extend Day = startofday(TimeGenerated)\r\n    | summarize arg_max(TimeGenerated, *) by Day, SecureScoresSubscriptionId\r\n    | where Day == startofday(now() - 30d)\r\n    | project OldMonthScore = PercentageScore, SecureScoresSubscriptionId\r\n) on SecureScoresSubscriptionId\r\n| extend diffSevenDays = tostring(((PercentageScore - OldScoreSevenDays) / OldScoreSevenDays) * 100)\r\n| extend diffSevenDays = iff(isempty(diffSevenDays), \"\", diffSevenDays)\r\n| extend diffMonth = tostring(((PercentageScore - OldMonthScore) / OldMonthScore) * 100)\r\n| extend diffMonth = iff(isempty(diffMonth), \"\", diffMonth)\r\n| project SecureScoresSubscriptionId, CurrentScore = round(PercentageScore*100), todouble(diffSevenDays), todouble(diffMonth)",
              "size": 0,
              "showAnalytics": true,
              "exportFieldName": "SecureScoresSubscriptionId",
              "exportParameterName": "selectedSubscription",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "SecureScoresSubscriptionId",
                    "formatter": 15,
                    "formatOptions": {
                      "linkTarget": null,
                      "showIcon": true,
                      "customColumnWidthSetting": "25ch"
                    }
                  },
                  {
                    "columnMatch": "CurrentScore",
                    "formatter": 8,
                    "formatOptions": {
                      "min": 0,
                      "max": 100,
                      "palette": "redGreen",
                      "customColumnWidthSetting": "20ch"
                    },
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal",
                        "useGrouping": false
                      }
                    }
                  },
                  {
                    "columnMatch": "diffSevenDays",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "<",
                          "thresholdValue": "0",
                          "representation": "trenddown"
                        },
                        {
                          "operator": ">",
                          "thresholdValue": "0",
                          "representation": "trendup",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "is Empty",
                          "thresholdValue": "0",
                          "representation": "Normal",
                          "text": "N/A"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "Blank",
                          "text": "{0}{1}"
                        }
                      ],
                      "customColumnWidthSetting": "20ch"
                    },
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal",
                        "useGrouping": false
                      }
                    }
                  },
                  {
                    "columnMatch": "diffMonth",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "<",
                          "thresholdValue": "0",
                          "representation": "trenddown",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": ">",
                          "thresholdValue": "0",
                          "representation": "trendup",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "is Empty",
                          "thresholdValue": "0",
                          "representation": "Normal",
                          "text": "N/A"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "more",
                          "text": "{0}{1}"
                        }
                      ],
                      "customColumnWidthSetting": "20ch"
                    },
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal",
                        "useGrouping": false
                      }
                    }
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "SecureScoresSubscriptionId",
                    "label": "Subscription Name"
                  },
                  {
                    "columnId": "CurrentScore",
                    "label": "Current Score %"
                  },
                  {
                    "columnId": "diffSevenDays",
                    "label": "7 Days Change"
                  },
                  {
                    "columnId": "diffMonth",
                    "label": "30 Days Change"
                  }
                ]
              }
            },
            "customWidth": "50",
            "showPin": true,
            "name": "ScoreTrends"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SecureScores\r\n| where MaxScore>0\r\n| extend subscriptionScore = CurrentScore/MaxScore\r\n| extend subScoreXsubWeight = subscriptionScore*Weight\r\n| summarize upperValue = sum(subScoreXsubWeight), underValue = sum(todouble(Weight)) by bin(TimeGenerated, 1d)\r\n| extend overallScore = round(100*((upperValue)/(underValue)))\r\n| project overallScore, TimeGenerated",
              "size": 0,
              "aggregation": 3,
              "showAnnotations": true,
              "timeContext": {
                "durationMs": 5529600000
              },
              "timeContextFromParameter": "TimeRange",
              "timeBrushParameterName": "TimeRange",
              "timeBrushExportOnlyWhenBrushed": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "timechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "overallScore",
                    "label": "Overall Score",
                    "color": "lightBlue"
                  }
                ],
                "ySettings": {
                  "min": 0,
                  "max": 100
                }
              }
            },
            "customWidth": "50",
            "name": "ScoreOvertime"
          },
          {
            "type": 1,
            "content": {
              "json": "ðŸ’¡ Selected filter for **subscription:** {selectedSubscription}"
            },
            "customWidth": "50",
            "name": "SubSelected"
          },
          {
            "type": 1,
            "content": {
              "json": "ðŸ’¡ Selected filter for **timerange:** {selectedTimeRange}"
            },
            "customWidth": "50",
            "name": "text - 5"
          }
        ],
        "exportParameters": true
      },
      "conditionalVisibility": {
        "parameterName": "Workspace",
        "comparison": "isNotEqualTo"
      },
      "name": "SecureScore"
    },
    {
      "type": 1,
      "content": {
        "json": "---"
      },
      "conditionalVisibility": {
        "parameterName": "Workspace",
        "comparison": "isNotEqualTo"
      },
      "name": "LineSeparator1"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<svg viewBox=\"0 0 18 18\" width=\"20\" class=\"fxt-escapeShadow\" role=\"presentation\" focusable=\"false\" xmlns:svg=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" aria-hidden=\"true\"><g><path fill=\"url(#ae5004eb-b3cc-4afc-9498-a0eb145de4dc)\" d=\"M6.437 1.856l-.292-.292a.5.5 0 00-.707 0L2.606 4.392 1.441 3.229a.5.5 0 00-.707 0l-.293.293a.5.5 0 000 .707l1.812 1.815a.5.5 0 00.354.146.5.5 0 00.353-.146l3.477-3.481a.5.5 0 000-.707z\"></path><rect width=\"10.366\" height=\"1.895\" x=\"7.339\" y=\"2.949\" fill=\"#a3a3a3\" rx=\".923\"></rect><rect width=\"10.366\" height=\"1.895\" x=\"7.339\" y=\"8.073\" fill=\"#a3a3a3\" rx=\".923\"></rect><rect width=\"10.366\" height=\"1.895\" x=\"7.339\" y=\"13.196\" fill=\"#a3a3a3\" rx=\".923\"></rect><path fill=\"url(#a1226368-080a-4756-9af4-a472e9b2c59c)\" d=\"M6.437 7.053l-.292-.293a.5.5 0 00-.707 0L2.606 9.588 1.441 8.425a.5.5 0 00-.707 0l-.293.293a.5.5 0 000 .707l1.812 1.815a.5.5 0 00.354.147.5.5 0 00.353-.147l3.477-3.48a.5.5 0 000-.707z\"></path><path fill=\"url(#a87a55b1-552d-4fae-9ce3-1c309da31213)\" d=\"M6.437 12.249l-.292-.293a.5.5 0 00-.354-.146.494.494 0 00-.353.146l-2.832 2.828-1.165-1.163a.5.5 0 00-.707 0l-.293.292a.5.5 0 000 .707l1.812 1.815a.5.5 0 00.707 0l3.477-3.48a.5.5 0 000-.706z\"></path></g></svg>&nbsp;<span style=\"font-family: Open Sans; font-weight: 620; font-size: 14px;font-style: bold;margin:-10px -304px 0px 0px;position: relative;top:-5px\"> Top 10 unhealthy recommendations\r\n</span>"
            },
            "customWidth": "50",
            "name": "text - 2"
          },
          {
            "type": 1,
            "content": {
              "json": "<svg viewBox=\"0 0 34 28\" width=\"20\" class=\"fxt-escapeShadow\" role=\"presentation\" focusable=\"false\" xmlns:svg=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" aria-hidden=\"true\"><g><path fill=\"#949494\" d=\"M2.44 22.93a.19.19 0 000 .13.24.24 0 00.09.08l1.73 1 2.93 1.69a.25.25 0 00.19 0 .31.31 0 00.16-.11l1-1.68a.21.21 0 000-.17.22.22 0 00-.11-.14L5 21.78a.24.24 0 01-.08-.09.21.21 0 010-.12V6.14a.16.16 0 010-.12.24.24 0 01.08-.09L8.46 4a.22.22 0 00.11-.14.2.2 0 000-.17L7.57 2l-.06-.08h-.09a.17.17 0 00-.1 0h-.1L4.35 3.53l-1.79 1a.24.24 0 00-.09.08.18.18 0 000 .12z\"></path><path fill=\"#a3a3a3\" d=\"M4.89 6L5 5.93 8.42 4a.18.18 0 00.07 0 .18.18 0 000-.08.17.17 0 000-.1.11.11 0 000-.08L7.52 2a.22.22 0 000-.08.16.16 0 00-.08-.06h-.1a.29.29 0 00-.1 0L4.31 3.53l-1.78 1a.09.09 0 00-.09.08l1.34.77zm3.53 17.7L5 21.75a.35.35 0 01-.11-.13l-2.44 1.49h.08l1.72 1 3 1.66a.19.19 0 00.09 0h.09l.09-.05.06-.07 1-1.68a.15.15 0 000-.09.24.24 0 000-.08.18.18 0 00-.05-.07s-.08-.03-.11-.03z\"></path><path fill=\"#949494\" d=\"M32.51 22.93a.21.21 0 010 .12.2.2 0 01-.09.09l-1.73 1-2.93 1.69a.25.25 0 01-.19 0 .31.31 0 01-.16-.11l-1-1.68a.25.25 0 010-.17.21.21 0 01.1-.14l3.45-1.95a.26.26 0 00.11-.21V6.14A.19.19 0 0030 6l-.08-.08L26.48 4a.21.21 0 01-.1-.14.25.25 0 010-.17l1-1.68.06-.08h.09a.16.16 0 01.1 0h.1l2.87 1.6 1.79 1a.24.24 0 01.09.08.27.27 0 010 .12z\"></path><path fill=\"#a3a3a3\" d=\"M30.06 6L30 5.93 26.53 4h-.08v-.08a.34.34 0 010-.1.2.2 0 010-.08l1-1.68a.22.22 0 01.05-.08.16.16 0 01.08-.06h.1a.29.29 0 01.1 0l2.88 1.66 1.78 1a.09.09 0 01.09.08l-1.34.77zm-3.53 17.7L30 21.75a.26.26 0 00.1-.13l2.43 1.49h-.08l-1.72 1-3 1.66h-.18a.26.26 0 01-.09-.05l-.06-.07-1-1.68a.28.28 0 010-.09.24.24 0 010-.08.18.18 0 01.05-.07.12.12 0 01.08-.03z\"></path><path d=\"M25.57 14.31H14.48a.86.86 0 01-.87-.77.79.79 0 01.87-.67h11.09a.79.79 0 01.87.67.86.86 0 01-.87.77zm0-5.61H14.48a.86.86 0 01-.87-.77.79.79 0 01.87-.67h11.09a.79.79 0 01.87.67.86.86 0 01-.87.77zm0 11.22H14.48a.86.86 0 01-.87-.77.79.79 0 01.87-.67h11.09a.79.79 0 01.87.67.86.86 0 01-.87.77z\" class=\"msportalfx-svg-c03\"></path><path d=\"M8.44 7.73l.62-.63 1.27 1.26 2.52-2.52.63.63-3.15 3.15zm0 5.62l.62-.63L10.33 14l2.52-2.52.63.63-3.15 3.15zm0 5.61l.62-.63 1.27 1.26 2.52-2.52.63.63-3.15 3.15z\" class=\"msportalfx-svg-c13\"></path></g></svg>&nbsp;<span style=\"font-family: Open Sans; font-weight: 620; font-size: 14px;font-style: bold;margin:-10px -304px 0px 0px;position: relative;top:-5px\"> Security controls over time (weekly)\r\n</span>\r\n\r\n"
            },
            "customWidth": "50",
            "name": "text - 3"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SecurityRecommendation\r\n|Â whereÂ RecommendationStateÂ Â =~Â \"Unhealthy\"\r\n|Â summarizeÂ UnhealthyCountÂ = dcount(AssessedResourceId)Â byÂ RecommendationName, RecommendationId\r\n| sort by UnhealthyCount desc\r\n| take 10",
              "size": 0,
              "timeContext": {
                "durationMs": 5529600000
              },
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "RecommendationName",
                    "formatter": 7,
                    "formatOptions": {
                      "linkTarget": "OpenBlade",
                      "linkIsContextBlade": false,
                      "bladeOpenContext": {
                        "bladeName": "RecommendationsBlade",
                        "extensionName": "Microsoft_Azure_Security",
                        "bladeParameters": [
                          {
                            "name": "assessmentKey",
                            "source": "column",
                            "value": "RecommendationId"
                          }
                        ]
                      },
                      "customColumnWidthSetting": "70ch"
                    },
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal",
                        "useGrouping": false
                      }
                    },
                    "tooltipFormat": {
                      "tooltip": "View recommendation '{0}'"
                    }
                  },
                  {
                    "columnMatch": "RecommendationId",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "UnhealthyCount",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "palette": "blue",
                      "compositeBarSettings": {
                        "labelText": "",
                        "columnSettings": []
                      },
                      "customColumnWidthSetting": "25ch"
                    }
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "RecommendationName",
                    "label": "Recommendation Name"
                  },
                  {
                    "columnId": "UnhealthyCount",
                    "label": "Unhealthy Count"
                  }
                ]
              },
              "tileSettings": {
                "showBorder": false,
                "titleContent": {
                  "columnMatch": "RecommendationName",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "UnhealthyCount",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "graphSettings": {
                "type": 0,
                "topContent": {
                  "columnMatch": "RecommendationName",
                  "formatter": 1
                },
                "centerContent": {
                  "columnMatch": "UnhealthyCount",
                  "formatter": 1,
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              }
            },
            "customWidth": "50",
            "name": "query - 7"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let SubscriptionsWeight = SecureScores \r\n    | summarize arg_max(TimeGenerated, *) by SecureScoresSubscriptionId\r\n    | extend SubscriptionWeight = Weight\r\n    | project SecureScoresSubscriptionId, SubscriptionWeight;\r\nSecureScoreControls\r\n| where MaxScore > 0 and IsSnapshot == true\r\n| extend Week = startofweek(TimeGenerated)\r\n| summarize arg_max(TimeGenerated, *) by SecureScoresSubscriptionId, ControlId, Week\r\n| join kind=inner SubscriptionsWeight  on SecureScoresSubscriptionId\r\n| extend WeightedControlScore = PercentageScore * SubscriptionWeight\r\n| summarize WeightedAvgPerControl = sum(WeightedControlScore)/sum(SubscriptionWeight)*100 by ControlId, ControlName, Week\r\n| order by WeightedAvgPerControl desc",
              "size": 0,
              "aggregation": 3,
              "showAnnotations": true,
              "timeContext": {
                "durationMs": 5529600000
              },
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "graphSettings": {
                "type": 0,
                "topContent": {
                  "columnMatch": "ControlId",
                  "formatter": 1
                },
                "centerContent": {
                  "columnMatch": "WeightedAvgPerControl",
                  "formatter": 1,
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "chartSettings": {
                "group": "ControlName",
                "createOtherGroup": 0,
                "showLegend": true,
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 1,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true
                    }
                  },
                  "min": 0,
                  "max": 100
                }
              }
            },
            "customWidth": "50",
            "name": "Controls"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Workspace",
        "comparison": "isNotEqualTo"
      },
      "name": "group - 8"
    },
    {
      "type": 1,
      "content": {
        "json": "---"
      },
      "conditionalVisibility": {
        "parameterName": "Workspace",
        "comparison": "isNotEqualTo"
      },
      "name": "LineSeparator2"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<svg viewBox=\"0 0 18 18\" width=\"20\" class=\"fxt-escapeShadow\" role=\"presentation\" focusable=\"false\" xmlns:svg=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" aria-hidden=\"true\"><g><path fill=\"url(#18748923018756614)\" d=\"M1.9.947h14.21v16.106a.947.947 0 01-.947.947H2.842a.947.947 0 01-.947-.947z\"></path><path d=\"M3.8.944h10.42V15.2a.949.949 0 01-.947.95H4.746a.949.949 0 01-.946-.95z\" class=\"msportalfx-svg-c01\"></path><path fill=\"#0078d4\" d=\"M7.579.474a.474.474 0 10-.947 0v.947a.474.474 0 10.947 0zm-1.895 0a.474.474 0 10-.947 0v.947a.474.474 0 10.947 0zm5.684 0a.474.474 0 10-.947 0v.947a.474.474 0 10.947 0zm-1.894 0a.474.474 0 00-.948 0v.947a.474.474 0 00.948 0zm3.789 0a.474.474 0 10-.947 0v.947a.474.474 0 10.947 0z\"></path><path fill=\"#005ba1\" d=\"M11.368 13.737a.474.474 0 10-.947 0v.947a.474.474 0 10.947 0zm1.895-2.837a.474.474 0 10-.947 0v3.789a.474.474 0 10.947 0zm-7.579 2.837a.474.474 0 10-.947 0v.947a.474.474 0 10.947 0zm1.895-1.895a.474.474 0 10-.947 0v2.842a.474.474 0 10.947 0zm1.895.947a.474.474 0 00-.948 0v1.895a.474.474 0 00.948 0z\"></path><path fill=\"#b796f9\" d=\"M10.976 12.147l-3.824-1.912-1.774 1.775-.335-.335L7.059 9.66l3.754 1.877 1.779-2.668.395.262-2.011 3.016z\"></path><path fill=\"#773adc\" d=\"M7.105 10.421a.474.474 0 10-.473-.474.474.474 0 00.473.474zM9 11.374a.477.477 0 10-.474-.476.475.475 0 00.474.476zm1.9.948a.477.477 0 10-.474-.477.475.475 0 00.474.477zm-5.689-.006a.474.474 0 10-.474-.474.474.474 0 00.474.474zm7.578-2.837A.477.477 0 1012.316 9a.475.475 0 00.473.479z\"></path><path fill=\"#1b93eb\" d=\"M11.368 5.487c0 1.541-1.86 2.746-2.266 3.014a.154.154 0 01-.17 0c-.406-.234-2.3-1.473-2.3-3.014V3.646a.144.144 0 01.135-.134c1.489-.034 1.15-.67 2.233-.67s.744.636 2.2.67a.154.154 0 01.169.134z\"></path><path fill=\"url(#381967167170842)\" d=\"M10.9 5.52c0 1.284-1.489 2.288-1.814 2.512a.119.119 0 01-.135 0C8.621 7.836 7.105 6.8 7.105 5.52V3.986a.118.118 0 01.109-.112c1.186-.028.92-.558 1.786-.558s.6.53 1.759.558a.125.125 0 01.136.112z\"></path><path d=\"M8.914 3.972a.1.1 0 01.172 0l.332.707a.094.094 0 00.071.054l.75.114a.1.1 0 01.053.16l-.548.562a.1.1 0 00-.026.081l.129.789a.1.1 0 01-.139.1l-.662-.366a.1.1 0 00-.092 0l-.662.366a.1.1 0 01-.139-.1l.129-.789a.1.1 0 00-.026-.081l-.548-.562a.1.1 0 01.053-.16l.75-.114a.094.094 0 00.071-.054z\" class=\"msportalfx-svg-c01\"></path></g></svg>&nbsp;<span style=\"font-family: Open Sans; font-weight: 620; font-size: 14px;font-style: bold;margin:-10px 0px 0px 0px;position: relative;top:-3px;left:-4px;\"> Recommendations changes over time\r\n</span> <br>\r\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Select a recommendation from thee list to get its changes"
            },
            "name": "text - 2"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let unhealthy = SecurityRecommendation\r\n| where RecommendationState == 'Unhealthy'\r\n| where isnotempty(RecommendationId) and isnotempty(RecommendationName)\r\n| summarize arg_max(TimeGenerated, *) by RecommendationId, AssessedResourceId;\r\nlet notApplicable = SecurityRecommendation\r\n| where RecommendationState == 'NotApplicable'\r\n| where isnotempty(RecommendationId) and isnotempty(RecommendationName)\r\n| summarize arg_max(TimeGenerated, *) by RecommendationId, AssessedResourceId;\r\nlet healthy = SecurityRecommendation \r\n| where RecommendationState == 'Healthy'\r\n| where isnotempty(RecommendationId) and isnotempty(RecommendationName)\r\n| summarize arg_max(TimeGenerated, *) by RecommendationId, AssessedResourceId;\r\nlet NotHealthy = SecurityRecommendation \r\n| where RecommendationState !~ 'Healthy'\r\n| where isnotempty(RecommendationId) and isnotempty(RecommendationName)\r\n| summarize arg_max(TimeGenerated, *) by RecommendationId, AssessedResourceId;\r\nlet NotUnhealthy = SecurityRecommendation \r\n| where RecommendationState !~ 'Unhealthy'\r\n| where isnotempty(RecommendationId) and isnotempty(RecommendationName)\r\n| summarize arg_max(TimeGenerated, *) by RecommendationId, AssessedResourceId;\r\nlet NotNotApplicable = SecurityRecommendation \r\n| where RecommendationState !~ 'NotApplicable'\r\n| where isnotempty(RecommendationId) and isnotempty(RecommendationName)\r\n| summarize arg_max(TimeGenerated, *) by RecommendationId, AssessedResourceId;\r\nlet 1_to_Healthy = \r\n    NotHealthy\r\n    | join healthy on RecommendationId, AssessedResourceId\r\n    | where TimeGenerated < TimeGenerated1\r\n    | summarize ToHealthyCount = count() by RecommendationId, RecommendationName;\r\n//1_to_Healthy\r\nlet 2_to_Unhealthy = \r\n    NotUnhealthy\r\n    | join unhealthy on RecommendationId, AssessedResourceId\r\n    | where TimeGenerated < TimeGenerated1\r\n    | summarize ToUnhealthyCount = count() by RecommendationId, RecommendationName;\r\n//2_to_Unhealthy\r\nlet 3_to_NotApplicable = \r\n    NotNotApplicable\r\n    | join notApplicable on RecommendationId, AssessedResourceId\r\n    | where TimeGenerated < TimeGenerated1\r\n    | summarize ToNotApplicableCount = count() by RecommendationId, RecommendationName;\r\n// JOIN\r\nunion 1_to_Healthy, 2_to_Unhealthy,  3_to_NotApplicable\r\n//| where RecommendationId == \"d57a4221-a804-52ca-3dea-768284f06bb7\" and RecommendationName == \"Disk encryption should be applied on virtual machines\"\r\n| summarize ToUnhealthyCount = sum(ToUnhealthyCount), ToHealthyCount = sum(ToHealthyCount), ToNotApplicableCount = sum(ToNotApplicableCount) by RecommendationId, RecommendationName\r\n| order by ToUnhealthyCount desc",
              "size": 0,
              "timeContext": {
                "durationMs": 5529600000
              },
              "timeContextFromParameter": "TimeRange",
              "exportedParameters": [
                {
                  "fieldName": "RecommendationId",
                  "parameterName": "RecommendationId"
                },
                {
                  "fieldName": "RecommendationName",
                  "parameterName": "RecommendationName",
                  "parameterType": 1
                }
              ],
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "RecommendationId",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "RecommendationName",
                    "formatter": 7,
                    "formatOptions": {
                      "linkTarget": "OpenBlade",
                      "linkIsContextBlade": false,
                      "bladeOpenContext": {
                        "bladeName": "RecommendationsBlade",
                        "extensionName": "Microsoft_Azure_Security",
                        "bladeParameters": [
                          {
                            "name": "assessmentKey",
                            "source": "column",
                            "value": "RecommendationId"
                          }
                        ]
                      },
                      "customColumnWidthSetting": "100ch"
                    }
                  },
                  {
                    "columnMatch": "UnhealthyCount",
                    "formatter": 8,
                    "formatOptions": {
                      "palette": "redBright"
                    }
                  },
                  {
                    "columnMatch": "HealthyCount",
                    "formatter": 8,
                    "formatOptions": {
                      "palette": "green"
                    }
                  },
                  {
                    "columnMatch": "NotApplicableCount",
                    "formatter": 8,
                    "formatOptions": {
                      "palette": "gray"
                    }
                  },
                  {
                    "columnMatch": "AssessedResourceId",
                    "formatter": 13,
                    "formatOptions": {
                      "linkTarget": null,
                      "showIcon": true
                    }
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "RecommendationId"
                  },
                  {
                    "columnId": "RecommendationName",
                    "label": "Recommendation Name"
                  },
                  {
                    "columnId": "ToUnhealthyCount",
                    "label": "To Unhealthy"
                  },
                  {
                    "columnId": "ToHealthyCount",
                    "label": "To Healthy"
                  },
                  {
                    "columnId": "ToNotApplicableCount",
                    "label": "To Not Applicable"
                  }
                ]
              },
              "sortBy": []
            },
            "name": "RecommendationStatusChanges"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let unhealthy = SecurityRecommendation\r\n| where RecommendationState == 'Unhealthy'   \r\n| where isnotempty(RecommendationId) and isnotempty(RecommendationName)\r\n| summarize arg_max(TimeGenerated, *) by RecommendationId, AssessedResourceId\r\n| project UnhealthyRecommendationId = RecommendationId, UnhealthyResourceId = AssessedResourceId, UnhealhyTime =  TimeGenerated;\r\nlet notApplicable = SecurityRecommendation\r\n| where RecommendationState == 'NotApplicable'\r\n| where isnotempty(RecommendationId) and isnotempty(RecommendationName)\r\n| summarize arg_max(TimeGenerated, *) by RecommendationId, AssessedResourceId\r\n| project NARecommendationId = RecommendationId, NAResourceId = AssessedResourceId, NATime =  TimeGenerated;\r\nlet healthy = SecurityRecommendation \r\n| where RecommendationState == 'Healthy'\r\n| where isnotempty(RecommendationId) and isnotempty(RecommendationName)\r\n| summarize arg_max(TimeGenerated, *) by RecommendationId, AssessedResourceId\r\n| project HealthyRecommendationId = RecommendationId, HealthyResourceId = AssessedResourceId, HealhyTime =  TimeGenerated;\r\nlet NotHealthy = SecurityRecommendation \r\n| where RecommendationState !~ 'Healthy'\r\n| where isnotempty(RecommendationId) and isnotempty(RecommendationName)\r\n| summarize arg_max(TimeGenerated, *) by RecommendationId, AssessedResourceId;\r\n//| project RecommendationName, Description, RecommendationState, TimeGenerated, RecommendationSeverity, AssessedResourceId, RecommendationId;\r\nlet NotUnhealthy = SecurityRecommendation \r\n| where RecommendationState !~ 'Unhealthy'\r\n| where isnotempty(RecommendationId) and isnotempty(RecommendationName)\r\n| summarize arg_max(TimeGenerated, *) by RecommendationId, AssessedResourceId;\r\n//| project RecommendationName, Description, RecommendationState, TimeGenerated, RecommendationSeverity, AssessedResourceId, RecommendationId;\r\nlet NotNotApplicable = SecurityRecommendation \r\n| where RecommendationState !~ 'NotApplicable'\r\n| where isnotempty(RecommendationId) and isnotempty(RecommendationName)\r\n| summarize arg_max(TimeGenerated, *) by RecommendationId, AssessedResourceId;\r\n//| project RecommendationName, Description, RecommendationState, TimeGenerated, RecommendationSeverity, AssessedResourceId, RecommendationId;\r\nlet 1_to_Healthy = \r\n    NotHealthy\r\n    | extend orignalState = RecommendationState\r\n    | join healthy on $left.RecommendationId == $right.HealthyRecommendationId, $left.AssessedResourceId == $right.HealthyResourceId\r\n    | where TimeGenerated < HealhyTime\r\n    | extend update = \"To Healthy\"\r\n    | project RecommendationId, RecommendationName, Description, OriginalState = RecommendationState, TimeGenerated, RecommendationSeverity, AssessedResourceId, update, RecommendationLink;\r\n//1_to_Healthy\r\nlet 2_to_Unhealthy = \r\n    NotUnhealthy\r\n    | extend orignalState = RecommendationState\r\n    | join unhealthy on $left.RecommendationId == $right.UnhealthyRecommendationId, $left.AssessedResourceId == $right.UnhealthyResourceId\r\n    | where TimeGenerated < UnhealhyTime\r\n    | extend update = \"To Unhealthy\"\r\n    | project RecommendationId, RecommendationName, Description, OriginalState = RecommendationState, TimeGenerated, RecommendationSeverity, AssessedResourceId, update, RecommendationLink;\r\n//2_to_Unhealthy\r\nlet 3_to_NotApplicable = \r\n    NotNotApplicable\r\n    | extend orignalState = RecommendationState\r\n    | join notApplicable on $left.RecommendationId == $right.NARecommendationId, $left.AssessedResourceId == $right.NAResourceId\r\n    | where TimeGenerated < NATime\r\n    | extend update = \"To Not Applicable\"\r\n    | extend NotApplicableReason = iff(isempty(NotApplicableReason), \"NA\", NotApplicableReason)\r\n    | project RecommendationId, RecommendationName, Description, OriginalState = RecommendationState, TimeGenerated, RecommendationSeverity, AssessedResourceId, update,RecommendationLink, NotApplicableReason;\r\n// JOIN\r\nunion 1_to_Healthy, 2_to_Unhealthy, 3_to_NotApplicable\r\n| extend FullRecommendationLink = strcat(\"http://\",RecommendationLink)\r\n| extend AssessedResourceId = iff(AssessedResourceId==\"N/A\", extract(\".*onPremiseMachines/(.+)\",1, url_decode(RecommendationLink)), AssessedResourceId)\r\n| project-away RecommendationLink\r\n| where RecommendationId == '{RecommendationId}'",
              "size": 0,
              "title": "Changes for \"{RecommendationName}\"",
              "timeContext": {
                "durationMs": 5529600000
              },
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "RecommendationId",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "Description",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "NotApplicableReason",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "30ch"
                    }
                  },
                  {
                    "columnMatch": "FullRecommendationLink",
                    "formatter": 7,
                    "formatOptions": {
                      "linkTarget": "Url",
                      "linkLabel": "View",
                      "linkIsContextBlade": false
                    }
                  }
                ],
                "rowLimit": 1000,
                "hierarchySettings": {
                  "treeType": 1,
                  "groupBy": [
                    "update"
                  ]
                },
                "sortBy": [
                  {
                    "itemKey": "$gen_link_AssessedResourceId_7",
                    "sortOrder": 1
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "RecommendationId"
                  },
                  {
                    "columnId": "RecommendationName",
                    "label": "Recommendation Name"
                  },
                  {
                    "columnId": "Description"
                  },
                  {
                    "columnId": "OriginalState",
                    "label": "Original State"
                  },
                  {
                    "columnId": "TimeGenerated",
                    "label": "Time Generated"
                  },
                  {
                    "columnId": "RecommendationSeverity",
                    "label": "Severity"
                  },
                  {
                    "columnId": "AssessedResourceId",
                    "label": "Resource"
                  },
                  {
                    "columnId": "update",
                    "label": "Updated State"
                  },
                  {
                    "columnId": "NotApplicableReason",
                    "label": "Reason"
                  },
                  {
                    "columnId": "FullRecommendationLink",
                    "label": "View Recommendation"
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "$gen_link_AssessedResourceId_7",
                  "sortOrder": 1
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "RecommendationId",
              "comparison": "isNotEqualTo"
            },
            "name": "ChangeLogDetails"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Workspace",
        "comparison": "isNotEqualTo"
      },
      "name": "ChangeLog"
    }
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}