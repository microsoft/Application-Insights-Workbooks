{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "\r\n<span style=\"font-size:40px;\"> Why is my Highest RU Consuming Shard spiking to 100% ? </span>\r\n\r\n<br>\r\n\r\n## Step 1. Let's understand what Highest RU Consuming Shard means in Cosmos DB"
      },
      "name": "text - 0"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<span style=\"font-size:15px;\"> To give some background, the way Cosmos DB distributes  throughput is by evenly splitting the throughput across all shard key ranges.</span>\r\n\r\n<br/> \r\n\r\n<span style=\"font-size:15px;\">\r\nFor example, if the max throughput is 20,000 RU/s and there are two shard key ranges, P1 and P2, each shard is capable of scaling to 10,000 RU/s. </span>\r\n\r\n\r\n<br/> \r\n\r\n<span style=\"font-size:15px;\">\r\nIn the scenario to your right, you'll see 2 shards, where P1 goes up to 10K RU/s (100% utilization for that shard in a given second) and P2 reaches 2K RU/s (20% utilization for that shard in a given second). </span>"
            },
            "customWidth": "30",
            "name": "text - 0",
            "styleSettings": {
              "padding": "20px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"1.0.0\",\"content\":\"{ \\\"throughput\\\": {\\r\\n    \\\"partitions\\\": [ \\r\\n      { \\\"partitions\\\": \\\"P1\\\",\\r\\n        \\\"RUs\\\": \\\"10000\\\"\\r\\n      },\\r\\n      { \\\"partitions\\\": \\\"P2\\\",\\r\\n        \\\"RUs\\\": \\\"2000\\\"\\r\\n      }\\r\\n    ]\\r\\n  }\\r\\n}\",\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.throughput.partitions\",\"columns\":[]}}]}",
              "size": 0,
              "title": "Per Second Shard Usage Snapshot",
              "queryType": 8,
              "visualization": "barchart",
              "graphSettings": {
                "type": 0,
                "topContent": {
                  "columnMatch": "partitions",
                  "formatter": 1
                },
                "centerContent": {
                  "columnMatch": "RUs",
                  "formatter": 1,
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "chartSettings": {
                "xAxis": "partitions",
                "yAxis": [
                  "RUs"
                ],
                "showLegend": true,
                "customThresholdLine": "10000",
                "customThresholdLineStyle": 1
              },
              "mapSettings": {
                "locInfo": "LatLong",
                "sizeSettings": "RUs",
                "sizeAggregation": "Sum",
                "legendMetric": "RUs",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "RUs",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "greenRed"
                }
              }
            },
            "customWidth": "70",
            "name": "query - 5"
          }
        ]
      },
      "customWidth": "50",
      "name": "group - 1"
    },
    {
      "type": 1,
      "content": {
        "json": "<br/>\r\n\r\n<span style=\"font-size:15px;\"> The Highest RU Consuming Shard metric is used to see how well saturated the shard key ranges are with respect to your traffic. This metric provides a per second view of the maximum throughput utilization for shard key range. In the example to your left, you can see the Highest RU Consuming Shard graph spiking to 100% at 3PM. </span>\r\n\r\n<br/> \r\n\r\n<span style=\"font-size:15px;\">\r\nIn a given second, if P1 has used 10,000 RUs, and P2 2,000 RUs, the normalized utilization is the MAX(10000 RU / 10,000 RU, 2000 RU / 10,000 RU) = 1.0 or 100% </span>"
      },
      "customWidth": "15",
      "name": "text - 0 - Copy",
      "styleSettings": {
        "padding": "20px"
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "{\"version\":\"1.0.0\",\"content\":\"{ \\\"throughput\\\": {\\r\\n    \\\"partitions\\\": [ \\r\\n      { \\\"Date\\\": \\\"11AM\\\",\\r\\n        \\\"Highest RU Consuming Shard\\\": \\\"0\\\"\\r\\n      },\\r\\n      { \\\"Date\\\": \\\"12PM\\\",\\r\\n        \\\"Highest RU Consuming Shard\\\": \\\"0\\\"\\r\\n      },\\r\\n\\t        { \\\"Date\\\": \\\"1PM\\\",\\r\\n        \\\"Highest RU Consuming Shard\\\": \\\"0\\\"\\r\\n      },\\r\\n\\r\\n\\t  { \\\"Date\\\": \\\"2PM\\\",\\r\\n        \\\"Highest RU Consuming Shard\\\": \\\"0\\\"\\r\\n      },\\r\\n      { \\\"Date\\\": \\\"3PM\\\",\\r\\n        \\\"Highest RU Consuming Shard\\\": \\\"1\\\"\\r\\n      },\\r\\n\\t        { \\\"Date\\\": \\\"4PM\\\",\\r\\n        \\\"Highest RU Consuming Shard\\\": \\\"0\\\"\\r\\n      },\\r\\n\\t  { \\\"Date\\\": \\\"5PM\\\",\\r\\n        \\\"Highest RU Consuming Shard\\\": \\\"0\\\"\\r\\n      },\\r\\n      { \\\"Date\\\": \\\"6PM\\\",\\r\\n        \\\"Highest RU Consuming Shard\\\": \\\"0\\\"\\r\\n      },\\r\\n\\t        { \\\"Date\\\": \\\"7PM\\\",\\r\\n        \\\"Highest RU Consuming Shard\\\": \\\"0\\\"\\r\\n      }\\r\\n\\t  \\r\\n    ]\\r\\n  }\\r\\n}\",\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.throughput.partitions\",\"columns\":[]}}]}",
        "size": 0,
        "title": "Highest RU Consuming Shard",
        "queryType": 8,
        "visualization": "linechart",
        "chartSettings": {
          "xAxis": "Date",
          "yAxis": [
            "Highest RU Consuming Shard",
            "Date"
          ],
          "showMetrics": false,
          "showLegend": true,
          "seriesLabelSettings": [
            {
              "seriesName": "NormalizedRU",
              "label": "Normalized RU"
            },
            {
              "seriesName": "Date",
              "label": "TimeRange"
            }
          ],
          "showDataPoints": true,
          "ySettings": {
            "numberFormatSettings": {
              "unit": 1,
              "options": {
                "style": "decimal",
                "useGrouping": true
              }
            }
          }
        }
      },
      "customWidth": "35",
      "name": "query - 6"
    },
    {
      "type": 1,
      "content": {
        "json": "---"
      },
      "name": "text - 6"
    },
    {
      "type": 1,
      "content": {
        "json": "# Step 2. Select a Database and/or Collection and time range you'd like to investigate\r\n\r\n<span style=\"font-size:15px;\">  Now let's take a look at the Highest RU Consuming Shard for your account. This metric can tell you whether you have shard skewness or hot shards within a database or collection.  </span>\r\n\r\n<span style=\"font-size:15px;\">\r\nEach __PartitionKeyRangeId__ maps to a one physical shard: \r\n\r\n- If you see consistent or continuous spiking of physical shards to 100% (view Highest RU Consuming Shard (%) By PartitionKeyRangeID line graph on the left) OR \r\n- There is one PartitionKeyRangeId that has significantly higher Highest RU Consuming Shard than others (for example, one is consistently at 100%, but others are at 30% or less, view Highest RU Consuming Shard (Max) Heat Map chart on the right) this can be a sign of a hot shard or shard skewness.  </span>\r\n\r\n<span style=\"font-size:15px; font-weight:bold;\"> Note: For shared throughput databases, only select the relevant database without drilling down to the container level. </span> \r\n<!-- (filtering at colleciton level wont work) TO-DO -->\r\n\r\n<span style=\"color:green;font-size:15px;\"> In general, for a production workload, if you see infrequent spikes, and your end to end latency is acceptable, this is a healthy sign that the RU/s are being fully utilized. **No action is required.** </span>"
      },
      "name": "text - 11"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "aa83f370-5c47-4eb5-b44a-fedcad97f71b",
            "version": "KqlParameterItem/1.0",
            "name": "Resources",
            "label": "Azure Cosmos DB",
            "type": 5,
            "isRequired": true,
            "value": "/subscriptions/86886548-0a7c-430b-b16f-014095647de4/resourceGroups/khelan/providers/Microsoft.DocumentDb/databaseAccounts/testing-intern",
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [
                "value::1"
              ],
              "showDefault": false
            }
          },
          {
            "id": "f5e823d5-9ac2-4aa2-9553-46f0529f9f2f",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "label": "Time Range",
            "type": 4,
            "isRequired": true,
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 300000
                },
                {
                  "durationMs": 900000
                },
                {
                  "durationMs": 1800000
                },
                {
                  "durationMs": 3600000
                },
                {
                  "durationMs": 14400000
                },
                {
                  "durationMs": 43200000
                },
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 172800000
                },
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 604800000
                }
              ],
              "allowCustom": true
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "value": {
              "durationMs": 43200000
            }
          },
          {
            "id": "d39fabbe-e275-42c7-bf2c-dda5a139eb82",
            "version": "KqlParameterItem/1.0",
            "name": "EnabledApiTypes",
            "type": 1,
            "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"{Resources}\",\"urlParams\":[{\"key\":\"api-version\",\"value\":\"2021-01-15\"}],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"properties.EnabledApiTypes\",\"columns\":[]}}]}",
            "isHiddenWhenLocked": true,
            "queryType": 12
          },
          {
            "id": "3bd5e0c6-988c-4e44-81d1-ed78c142f18c",
            "version": "KqlParameterItem/1.0",
            "name": "ApiDatabases",
            "type": 1,
            "isHiddenWhenLocked": true,
            "criteriaData": [
              {
                "criteriaContext": {
                  "leftOperand": "EnabledApiTypes",
                  "operator": "==",
                  "rightValType": "static",
                  "rightVal": "Sql",
                  "resultValType": "static",
                  "resultVal": "sqlDatabases"
                }
              },
              {
                "criteriaContext": {
                  "leftOperand": "EnabledApiTypes",
                  "operator": "contains",
                  "rightValType": "static",
                  "rightVal": "MongoDB",
                  "resultValType": "static",
                  "resultVal": "mongodbDatabases"
                }
              },
              {
                "criteriaContext": {
                  "leftOperand": "EnabledApiTypes",
                  "operator": "contains",
                  "rightValType": "static",
                  "rightVal": "Cassandra",
                  "resultValType": "static",
                  "resultVal": "cassandraKeyspaces"
                }
              },
              {
                "criteriaContext": {
                  "leftOperand": "EnabledApiTypes",
                  "operator": "contains",
                  "rightValType": "static",
                  "rightVal": "Gremlin",
                  "resultValType": "static",
                  "resultVal": "gremlinDatabases"
                }
              },
              {
                "criteriaContext": {
                  "leftOperand": "EnabledApiTypes",
                  "operator": "contains",
                  "rightValType": "static",
                  "rightVal": "Table",
                  "resultValType": "static",
                  "resultVal": "tables"
                }
              },
              {
                "criteriaContext": {
                  "operator": "Default",
                  "rightValType": "param",
                  "resultValType": "static",
                  "resultVal": "sqlDatabases"
                }
              }
            ]
          },
          {
            "id": "82f8fb72-8e01-4516-8115-b62082df1e44",
            "version": "KqlParameterItem/1.0",
            "name": "Database",
            "type": 2,
            "description": "When the value is \"unset\" or not selected, the data being displayed is at the account level.",
            "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"{Resources}/{ApiDatabases}\",\"urlParams\":[{\"key\":\"api-version\",\"value\":\"2020-04-01\"}],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.value.*.properties.resource.id\",\"columns\":[]}}]}",
            "value": "v2",
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "queryType": 12
          },
          {
            "id": "1d0f2571-063a-479e-b26e-9afef931399b",
            "version": "KqlParameterItem/1.0",
            "name": "ResourceId",
            "type": 1,
            "query": "Resources\r\n| where type == 'microsoft.documentdb/databaseaccounts'\r\n| where id == '{Resources}'\r\n| project resource_id = toupper (id)",
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "label": ""
          },
          {
            "id": "848c0cd2-f809-4f44-8137-fc40f202bae9",
            "version": "KqlParameterItem/1.0",
            "name": "input",
            "type": 1,
            "value": ""
          }
        ],
        "style": "above",
        "queryType": 12
      },
      "name": "Container",
      "styleSettings": {
        "margin": "0px"
      }
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "de82b52e-d754-4581-a086-eb0aff726309",
            "version": "KqlParameterItem/1.0",
            "name": "APIContainerType",
            "type": 1,
            "isHiddenWhenLocked": true,
            "criteriaData": [
              {
                "criteriaContext": {
                  "leftOperand": "ApiDatabases",
                  "operator": "==",
                  "rightValType": "static",
                  "rightVal": "cassandraKeyspaces",
                  "resultValType": "static",
                  "resultVal": "tables"
                }
              },
              {
                "criteriaContext": {
                  "leftOperand": "ApiDatabases",
                  "operator": "==",
                  "rightValType": "static",
                  "rightVal": "gremlinDatabases",
                  "resultValType": "static",
                  "resultVal": "graphs"
                }
              },
              {
                "criteriaContext": {
                  "leftOperand": "ApiDatabases",
                  "operator": "==",
                  "rightValType": "static",
                  "rightVal": "mongodbDatabases",
                  "resultValType": "static",
                  "resultVal": "collections"
                }
              },
              {
                "criteriaContext": {
                  "leftOperand": "ApiDatabases",
                  "operator": "==",
                  "rightValType": "static",
                  "rightVal": "sqlDatabases",
                  "resultValType": "static",
                  "resultVal": "containers"
                }
              },
              {
                "criteriaContext": {
                  "operator": "Default",
                  "rightValType": "param",
                  "resultValType": "static",
                  "resultVal": "containers"
                }
              }
            ]
          },
          {
            "id": "0abe0edd-1fb0-46fb-b7f2-6c0c21245fda",
            "version": "KqlParameterItem/1.0",
            "name": "Container",
            "type": 2,
            "description": "When the value is \"unset\" or not selected, the data being displayed is at the database level.",
            "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"{Resources}/{ApiDatabases}/{Database:label}/{APIContainerType}\",\"urlParams\":[{\"key\":\"api-version\",\"value\":\"2020-04-01\"},{\"key\":\"\",\"value\":\"\"}],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.value.*.properties.resource.id\",\"columns\":[]}}]}",
            "value": null,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "queryType": 12
          },
          {
            "id": "3612d3a0-c4f8-43fd-a692-48ff3f4cfcb0",
            "version": "KqlParameterItem/1.0",
            "name": "throttle",
            "type": 1
          }
        ],
        "style": "pills",
        "queryType": 12
      },
      "conditionalVisibilities": [
        {
          "parameterName": "Database",
          "comparison": "isNotEqualTo"
        },
        {
          "parameterName": "ApiDatabases",
          "comparison": "isNotEqualTo",
          "value": "tables"
        }
      ],
      "name": "parameters - 11"
    },
    {
      "type": 10,
      "content": {
        "chartId": "workbook73fbc5f1-3789-4bf5-b0b1-ea8a2480a6bc",
        "version": "MetricsItem/2.0",
        "size": 0,
        "chartType": 0,
        "resourceType": "microsoft.documentdb/databaseaccounts",
        "metricScope": 0,
        "resourceIds": [
          "/subscriptions/86886548-0a7c-430b-b16f-014095647de4/resourceGroups/khelan/providers/Microsoft.DocumentDb/databaseAccounts/testing-intern"
        ],
        "timeContextFromParameter": "TimeRange",
        "timeContext": {
          "durationMs": 43200000
        },
        "metrics": [
          {
            "namespace": "microsoft.documentdb/databaseaccounts",
            "metric": "microsoft.documentdb/databaseaccounts-Requests-MongoRequests",
            "aggregation": 7
          }
        ],
        "filters": [
          {
            "id": "1",
            "key": "DatabaseName",
            "operator": 0,
            "valueParam": "Database"
          },
          {
            "id": "2",
            "key": "CollectionName",
            "operator": 0,
            "valueParam": "Container"
          }
        ],
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Subscription",
              "formatter": 5
            },
            {
              "columnMatch": "Name",
              "formatter": 13,
              "formatOptions": {
                "linkTarget": "Resource"
              }
            },
            {
              "columnMatch": ".*\\/Total Requests$",
              "formatter": 1
            },
            {
              "columnMatch": "microsoft.documentdb/databaseaccounts-Requests-TotalRequests Timeline",
              "formatter": 5
            },
            {
              "columnMatch": "microsoft.documentdb/databaseaccounts-Requests-TotalRequests",
              "formatter": 1,
              "numberFormat": {
                "unit": 0,
                "options": null
              }
            },
            {
              "columnMatch": "microsoft.documentdb/databaseaccounts-Requests-MongoRequests Timeline",
              "formatter": 5
            },
            {
              "columnMatch": "microsoft.documentdb/databaseaccounts-Requests-MongoRequests",
              "formatter": 1,
              "numberFormat": {
                "unit": 0,
                "options": null
              }
            }
          ],
          "rowLimit": 10000,
          "labelSettings": [
            {
              "columnId": "Subscription",
              "label": "Subscription/Database/Collection"
            },
            {
              "columnId": "Name",
              "label": "Collections"
            },
            {
              "columnId": "microsoft.documentdb/databaseaccounts-Requests-MongoRequests",
              "label": "Mongo Requests (Count)"
            },
            {
              "columnId": "microsoft.documentdb/databaseaccounts-Requests-MongoRequests Timeline",
              "label": "Mongo Requests Timeline"
            }
          ]
        }
      },
      "conditionalVisibility": {
        "parameterName": "Test",
        "comparison": "isNotEqualTo"
      },
      "name": "metric - 17"
    },
    {
      "type": 10,
      "content": {
        "chartId": "workbook73fbc5f1-3789-4bf5-b0b1-ea8a2480a6bc",
        "version": "MetricsItem/2.0",
        "size": 0,
        "chartType": 0,
        "resourceType": "microsoft.documentdb/databaseaccounts",
        "metricScope": 0,
        "resourceIds": [
          "/subscriptions/86886548-0a7c-430b-b16f-014095647de4/resourceGroups/khelan/providers/Microsoft.DocumentDb/databaseAccounts/testing-intern"
        ],
        "timeContextFromParameter": "TimeRange",
        "timeContext": {
          "durationMs": 43200000
        },
        "metrics": [
          {
            "namespace": "microsoft.documentdb/databaseaccounts",
            "metric": "microsoft.documentdb/databaseaccounts-Requests-MongoRequests",
            "aggregation": 7,
            "splitBy": "ErrorCode",
            "splitBySortOrder": false,
            "splitByLimit": null
          }
        ],
        "filters": [
          {
            "id": "1",
            "key": "ErrorCode",
            "operator": 0,
            "values": [
              "50"
            ]
          },
          {
            "id": "2",
            "key": "DatabaseName",
            "operator": 0,
            "valueParam": "Database"
          },
          {
            "id": "5",
            "key": "CollectionName",
            "operator": 0,
            "valueParam": "Container"
          }
        ],
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Subscription",
              "formatter": 5
            },
            {
              "columnMatch": "Name",
              "formatter": 13,
              "formatOptions": {
                "linkTarget": "Resource"
              }
            },
            {
              "columnMatch": ".*\\/Total Requests$",
              "formatter": 1
            },
            {
              "columnMatch": ".*\\/Mongo Requests$",
              "formatter": 1
            }
          ],
          "rowLimit": 10000,
          "labelSettings": [
            {
              "columnId": "Subscription",
              "label": "Subscription/Database/Collection"
            },
            {
              "columnId": "Name",
              "label": "Collections"
            }
          ]
        }
      },
      "conditionalVisibility": {
        "parameterName": "Test",
        "comparison": "isNotEqualTo"
      },
      "name": "metric - 17 - Copy"
    },
    {
      "type": 10,
      "content": {
        "chartId": "workbook57618cd6-c456-42da-9c2d-15735c98a89a",
        "version": "MetricsItem/2.0",
        "size": 1,
        "chartType": 2,
        "resourceType": "microsoft.documentdb/databaseaccounts",
        "metricScope": 0,
        "resourceParameter": "Resources",
        "resourceIds": [
          "{Resources}"
        ],
        "timeContextFromParameter": "TimeRange",
        "timeContext": {
          "durationMs": 43200000
        },
        "metrics": [
          {
            "namespace": "microsoft.documentdb/databaseaccounts",
            "metric": "microsoft.documentdb/databaseaccounts-Requests-NormalizedRUConsumption",
            "aggregation": 3,
            "splitBy": "PartitionKeyRangeId"
          }
        ],
        "title": "Highest RU Consuming Shard (%) By PartitionKeyRangeID",
        "filters": [
          {
            "id": "1",
            "key": "DatabaseName",
            "operator": 0,
            "valueParam": "Database"
          },
          {
            "id": "2",
            "key": "CollectionName",
            "operator": 0,
            "valueParam": "Container"
          }
        ],
        "timeBrushParameterName": "timebrush",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "$gen_group",
              "formatter": 13,
              "formatOptions": {
                "linkTarget": null,
                "showIcon": true
              }
            },
            {
              "columnMatch": "Subscription",
              "formatter": 5
            },
            {
              "columnMatch": "Name",
              "formatter": 13,
              "formatOptions": {
                "linkTarget": "Resource",
                "showIcon": true
              }
            },
            {
              "columnMatch": ".*\\/Normalized RU Consumption$",
              "formatter": 1
            },
            {
              "columnMatch": "microsoft.documentdb/databaseaccounts-Requests-NormalizedRUConsumption",
              "formatter": 1,
              "numberFormat": {
                "unit": 1,
                "options": null
              }
            },
            {
              "columnMatch": "microsoft.documentdb/databaseaccounts-Requests-NormalizedRUConsumption Timeline",
              "formatter": 5
            }
          ],
          "rowLimit": 10000,
          "hierarchySettings": {
            "treeType": 1,
            "groupBy": [
              "Subscription",
              "1/Normalized RU Consumption"
            ],
            "finalBy": "Subscription"
          },
          "labelSettings": [
            {
              "columnId": "Subscription",
              "label": "Subscription/Database/Collection"
            }
          ]
        }
      },
      "customWidth": "50",
      "showPin": true,
      "name": "Highest RU Consuming Shard By PartitionKeyRangeID"
    },
    {
      "type": 10,
      "content": {
        "chartId": "workbookcd5b6601-f1cf-44ae-88c4-156eac04b5ac",
        "version": "MetricsItem/2.0",
        "size": 1,
        "chartType": 0,
        "resourceType": "microsoft.documentdb/databaseaccounts",
        "metricScope": 0,
        "resourceParameter": "Resources",
        "resourceIds": [
          "{Resources}"
        ],
        "timeContextFromParameter": "TimeRange",
        "timeContext": {
          "durationMs": 43200000
        },
        "metrics": [
          {
            "namespace": "microsoft.documentdb/databaseaccounts",
            "metric": "microsoft.documentdb/databaseaccounts-Requests-NormalizedRUConsumption",
            "aggregation": 3,
            "splitBy": "PartitionKeyRangeId",
            "splitBySortOrder": -1,
            "splitByLimit": 5
          }
        ],
        "title": "Highest RU Consuming Shard (Max) Heat Map By PartitionKeyRangeID",
        "gridFormatType": 1,
        "filters": [
          {
            "id": "1",
            "key": "CollectionName",
            "operator": 0,
            "valueParam": "Container"
          },
          {
            "id": "2",
            "key": "DatabaseName",
            "operator": 0,
            "valueParam": "Database"
          }
        ],
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "$gen_group",
              "formatter": 13,
              "formatOptions": {
                "linkTarget": null,
                "showIcon": true
              }
            },
            {
              "columnMatch": "Subscription",
              "formatter": 5
            },
            {
              "columnMatch": "Name",
              "formatter": 5,
              "formatOptions": {
                "linkTarget": "Resource"
              }
            },
            {
              "columnMatch": "Metric",
              "formatter": 5
            },
            {
              "columnMatch": "Aggregation",
              "formatter": 5
            },
            {
              "columnMatch": "Segment Field",
              "formatter": 5
            },
            {
              "columnMatch": "Segment",
              "formatter": 5
            },
            {
              "columnMatch": "Value",
              "formatter": 8,
              "formatOptions": {
                "min": 0,
                "max": 100,
                "palette": "coldHot",
                "customColumnWidthSetting": "300px"
              },
              "numberFormat": {
                "unit": 1,
                "options": {
                  "style": "decimal",
                  "useGrouping": false
                }
              }
            },
            {
              "columnMatch": "Timeline",
              "formatter": 9,
              "formatOptions": {
                "min": 0,
                "palette": "blue",
                "customColumnWidthSetting": "300px"
              }
            },
            {
              "columnMatch": ".*\\/Normalized RU Consumption$",
              "formatter": 1
            },
            {
              "columnMatch": "microsoft.documentdb/databaseaccounts-Requests-NormalizedRUConsumption Timeline",
              "formatter": 5
            },
            {
              "columnMatch": "microsoft.documentdb/databaseaccounts-Requests-NormalizedRUConsumption",
              "formatter": 1,
              "numberFormat": {
                "unit": 1,
                "options": null
              }
            }
          ],
          "rowLimit": 10000,
          "hierarchySettings": {
            "treeType": 1,
            "groupBy": [
              "Segment Field"
            ],
            "expandTopLevel": true,
            "finalBy": "Segment"
          },
          "labelSettings": [
            {
              "columnId": "Subscription",
              "label": "Subscription/Database/Collection"
            },
            {
              "columnId": "Name",
              "label": "Collections"
            },
            {
              "columnId": "Segment",
              "label": "Collection"
            },
            {
              "columnId": "Value",
              "label": "Provisioned Throughput"
            }
          ]
        }
      },
      "customWidth": "50",
      "name": "Highest RU Consuming Shard Heat Map"
    },
    {
      "type": 1,
      "content": {
        "json": "---"
      },
      "name": "text - 12 - Copy"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"b02cf143-be2e-4131-8418-0808e573409d\",\"mergeType\":\"innerunique\",\"leftTable\":\"metric - 17\",\"rightTable\":\"metric - 17 - Copy\",\"leftColumn\":\"Name\",\"rightColumn\":\"Name\"}],\"projectRename\":[{\"originalName\":\"[metric - 17].microsoft.documentdb/databaseaccounts-Requests-MongoRequests\",\"mergedName\":\"MongoRequests\",\"fromId\":\"unknown\"},{\"originalName\":\"[metric - 17].microsoft.documentdb/databaseaccounts-Requests-MongoRequests Timeline\",\"mergedName\":\"microsoft.documentdb/databaseaccounts-Requests-MongoRequests Timeline\",\"fromId\":\"unknown\"},{\"originalName\":\"[metric - 17 - Copy].50/Mongo Requests\",\"mergedName\":\"50\",\"fromId\":\"unknown\"},{\"originalName\":\"[Added column]\",\"mergedName\":\"result\",\"fromId\":null,\"isNewItem\":true,\"newItemData\":[{\"criteriaContext\":{\"leftOperand\":\"50\",\"operator\":\"is Empty\",\"rightValType\":\"static\",\"rightVal\":\"0\",\"resultValType\":\"static\",\"resultVal\":\"0\"}},{\"criteriaContext\":{\"operator\":\"Default\",\"rightValType\":\"column\",\"resultValType\":\"expression\",\"resultVal\":\" ([\\\"50\\\"])/[\\\"MongoRequests\\\"]\"}}]},{\"originalName\":\"[metric - 17 - Copy].409/Total Requests\"},{\"originalName\":\"[metric - 17 - Copy].200/Total Requests\"},{\"originalName\":\"[metric - 17 - Copy].429/Total Requests\"},{\"originalName\":\"[metric - 17 - Copy].201/Total Requests\"},{\"originalName\":\"[metric - 17].microsoft.documentdb/databaseaccounts-Requests-TotalRequests\"},{\"originalName\":\"[metric - 17 - Copy].Name\"},{\"originalName\":\"[metric - 17 - Copy].Subscription\"},{\"originalName\":\"[metric - 17].microsoft.documentdb/databaseaccounts-Requests-TotalRequests Timeline\"},{\"originalName\":\"[metric - 17].Name\"},{\"originalName\":\"[metric - 17].Subscription\"}]}",
        "size": 3,
        "title": "Throttled Request Percentage",
        "showRefreshButton": true,
        "exportFieldName": "result",
        "exportParameterName": "ThrottledRequestPercentage",
        "exportDefaultValue": "",
        "queryType": 7,
        "visualization": "tiles",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Subscription/Database/Collection",
              "formatter": 5
            },
            {
              "columnMatch": "Name",
              "formatter": 5
            },
            {
              "columnMatch": "Total Requests",
              "formatter": 5
            },
            {
              "columnMatch": "Total Requests Timeline",
              "formatter": 5,
              "formatOptions": {
                "aggregation": "Average"
              }
            },
            {
              "columnMatch": "Subscription/Database/Collection1",
              "formatter": 5
            },
            {
              "columnMatch": "Name1",
              "formatter": 5
            },
            {
              "columnMatch": "201/Total Requests",
              "formatter": 5
            },
            {
              "columnMatch": "429",
              "formatter": 5
            },
            {
              "columnMatch": "200/Total Requests",
              "formatter": 5
            },
            {
              "columnMatch": "409/Total Requests",
              "formatter": 5
            },
            {
              "columnMatch": "Added column",
              "formatter": 0,
              "numberFormat": {
                "unit": 0,
                "options": {
                  "style": "percent"
                }
              }
            },
            {
              "columnMatch": "Added column1",
              "formatter": 5
            }
          ],
          "sortBy": [
            {
              "itemKey": "$gen_number_Added column_10",
              "sortOrder": 1
            }
          ],
          "labelSettings": [
            {
              "columnId": "Added column",
              "label": "Throttled Request Percentage"
            }
          ]
        },
        "sortBy": [
          {
            "itemKey": "$gen_number_Added column_10",
            "sortOrder": 1
          }
        ],
        "tileSettings": {
          "titleContent": {
            "formatter": 5,
            "numberFormat": {
              "unit": 0,
              "options": {
                "style": "decimal"
              }
            }
          },
          "leftContent": {
            "columnMatch": "result",
            "formatter": 12,
            "formatOptions": {
              "palette": "auto"
            },
            "numberFormat": {
              "unit": 0,
              "options": {
                "style": "percent",
                "maximumFractionDigits": 1,
                "maximumSignificantDigits": 3
              }
            }
          },
          "showBorder": true
        }
      },
      "customWidth": "100",
      "name": "Throttled Request Percentage Tile",
      "styleSettings": {
        "maxWidth": "100"
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"408459e3-8f3f-4a18-bdd8-94094b64c11a\",\"mergeType\":\"table\",\"leftTable\":\"Throttled Request Percentage Tile\"}],\"projectRename\":[{\"originalName\":\"[Added column]\",\"mergedName\":\"percentage\",\"fromId\":null,\"isNewItem\":true,\"newItemData\":[{\"criteriaContext\":{\"leftOperand\":\"result\",\"operator\":\">=\",\"rightValType\":\"static\",\"rightVal\":\"0.05\",\"resultValType\":\"static\",\"resultVal\":\"1\"}},{\"criteriaContext\":{\"operator\":\"Default\",\"rightValType\":\"column\",\"resultValType\":\"static\",\"resultVal\":\"0\"}}]},{\"originalName\":\"[Throttled Request Percentage Tile].result\",\"mergedName\":\"result\",\"fromId\":\"408459e3-8f3f-4a18-bdd8-94094b64c11a\"},{\"originalName\":\"[Throttled Request Percentage Tile].50\"},{\"originalName\":\"[Throttled Request Percentage Tile].microsoft.documentdb/databaseaccounts-Requests-MongoRequests Timeline\"},{\"originalName\":\"[Throttled Request Percentage Tile].MongoRequests\"}]}",
        "size": 0,
        "queryType": 7
      },
      "name": "query - 26"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "a241ab01-1913-42b5-ac41-68c200ed76e2",
            "version": "KqlParameterItem/1.0",
            "name": "IsThrottled",
            "type": 1,
            "isGlobal": true,
            "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"408459e3-8f3f-4a18-bdd8-94094b64c127\",\"mergeType\":\"table\",\"leftTable\":\"query - 26\"}],\"projectRename\":[{\"originalName\":\"[query - 26].percentage\",\"mergedName\":\"percentage\",\"fromId\":\"408459e3-8f3f-4a18-bdd8-94094b64c127\"},{\"originalName\":\"[query - 26].result\",\"mergedName\":\"result\",\"fromId\":\"408459e3-8f3f-4a18-bdd8-94094b64c127\"},{\"originalName\":\"[query - 19].50\"},{\"originalName\":\"[query - 19].microsoft.documentdb/databaseaccounts-Requests-MongoRequests Timeline\"},{\"originalName\":\"[query - 19].MongoRequests\"}]}",
            "timeContext": {
              "durationMs": 2592000000
            },
            "queryType": 7
          }
        ],
        "style": "pills",
        "queryType": 7
      },
      "conditionalVisibility": {
        "parameterName": "isThrottled",
        "comparison": "isEqualTo",
        "value": "-212"
      },
      "name": "parameters - 20"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "# Step 3: View your Throttled Request Percentage on specific collection\r\n\r\nThe throttled request percentage is calculated by dividing your total number of request in a given time period by the number of requests that return 50 as the Error Code. \r\n\r\nYou can enable the Server Side Retry (SSR) feature and let the server retry these operations automatically. The requests are retried after a short delay for all collections in your account. This feature is a convenient alternative to handling rate-limiting errors in the client application.\r\n\r\nRequests are retried continuously (over and over again) until a 60-second timeout is reached. If the timeout is reached, the client will receive an ExceededTimeLimit exception (50).\r\n\r\n<span style=\"color:green\"> If your throttled request percentage is 1-5% and your end to end latency is acceptable, this is a healthy sign that your RU/s are being fully utilized. **No action is required.** </span>",
              "style": "success"
            },
            "customWidth": "100",
            "name": "Throttled Percentage",
            "styleSettings": {
              "maxWidth": "100"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "IsThrottled",
        "comparison": "isEqualTo",
        "value": "0"
      },
      "name": "Throttled Percentage"
    },
    {
      "type": 1,
      "content": {
        "json": "# Step 3: View your Throttled Request Percentage on specific collection\r\n\r\nYour throttled request percentage is calculated by dividing your total number of request in a given time period by the number of requests that return 50 as the Error Code. \r\n\r\n<span style=\"color:red\"> Your throttled percentage is greater than 5%. **Action is required. Please move forward to the next troubleshooting steps.** </span>\r\n\r\n",
        "style": "warning"
      },
      "conditionalVisibility": {
        "parameterName": "IsThrottled",
        "comparison": "isEqualTo",
        "value": "1"
      },
      "name": "text - 19"
    },
    {
      "type": 1,
      "content": {
        "json": "---"
      },
      "name": "text - 12"
    },
    {
      "type": 1,
      "content": {
        "json": "# Step 4. Enable Log Analytics for additional troubleshooting\r\n\r\nUse Azure Diagnostic Logs to identify which requests are returning 429s and how many RUs they consumed. This sample query aggregates at the minute level."
      },
      "conditionalVisibility": {
        "parameterName": "IsThrottled",
        "comparison": "isEqualTo",
        "value": "1"
      },
      "name": "Log Analytics Workspace"
    },
    {
      "type": 1,
      "content": {
        "json": "Important\r\nEnabling diagnostic logs incurs a separate charge for the Log Analytics service, which is billed based on the volume of data ingested. It's recommended you turn on diagnostic logs for a limited amount of time for debugging, and turn off when no longer required. See pricing page for details.",
        "style": "info"
      },
      "conditionalVisibility": {
        "parameterName": "IsThrottled",
        "comparison": "isEqualTo",
        "value": "1"
      },
      "name": "text - 24"
    },
    {
      "type": 1,
      "content": {
        "json": "Turn on <a href=\"https://docs.microsoft.com/en-us/azure/cosmos-db/cosmosdb-monitor-resource-logs \">Log Analytics </a> along with MongoRequest Category enabled\r\n\r\n## Once it is enabled then you would be able to select the workspace from the dropdown below"
      },
      "conditionalVisibility": {
        "parameterName": "IsThrottled",
        "comparison": "isEqualTo",
        "value": "1"
      },
      "name": "text - 25"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "crossComponentResources": [
          "value::all"
        ],
        "parameters": [
          {
            "id": "43a7b8db-707f-4f94-bea9-4fe38b8e1c16",
            "version": "KqlParameterItem/1.0",
            "name": "LogAnalyticsWorkspace",
            "label": "Log Analytics Workspace",
            "type": 5,
            "query": "resources\r\n| where type == \"microsoft.operationalinsights/workspaces\"\r\n| project id",
            "crossComponentResources": [
              "value::all"
            ],
            "value": "/subscriptions/86886548-0a7c-430b-b16f-014095647de4/resourceGroups/DefaultResourceGroup-EUS/providers/Microsoft.OperationalInsights/workspaces/DefaultWorkspace-86886548-0a7c-430b-b16f-014095647de4-EUS",
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          }
        ],
        "style": "pills",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources"
      },
      "conditionalVisibility": {
        "parameterName": "IsThrottled",
        "comparison": "isEqualTo",
        "value": "1"
      },
      "name": "parameters - 21"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "//AzureDiagnostics\r\n//| where ResourceProvider==\"MICROSOFT.DOCUMENTDB\" and Category == 'PartitionKeyStatistics'\r\n\r\nCDBMongoRequests\r\n| where _ResourceId == tolower('{ResourceId}')\r\n| where DatabaseName == '{Database}'\r\n| summarize throttledOperations = dcountif(ActivityId, ErrorCode == 50), totalOperations = dcount(ActivityId), totalConsumedRUPerMinute = sum(todouble(RequestCharge)) by OperationName, CollectionName, bin(TimeGenerated, 1min)\r\n| extend averageRUPerOperation = 1.0 * totalConsumedRUPerMinute / totalOperations \r\n| extend fractionOf429s = 1.0 * throttledOperations / totalOperations\r\n| order by fractionOf429s desc\r\n\r\n\r\n\r\n\r\n\r\n//|",
        "size": 0,
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "{LogAnalyticsWorkspace}"
        ],
        "gridSettings": {
          "rowLimit": 500
        }
      },
      "conditionalVisibilities": [
        {
          "parameterName": "IsThrottled",
          "comparison": "isEqualTo",
          "value": "1"
        },
        {
          "parameterName": "Container",
          "comparison": "isEqualTo"
        }
      ],
      "name": "query - 14"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "//AzureDiagnostics\r\n//| where ResourceProvider==\"MICROSOFT.DOCUMENTDB\" and Category == 'PartitionKeyStatistics'\r\n\r\nCDBMongoRequests\r\n| where _ResourceId == tolower('{ResourceId}')\r\n| where DatabaseName == '{Database}' and CollectionName == '{Container}'\r\n| summarize throttledOperations = dcountif(ActivityId, ErrorCode == 50), totalOperations = dcount(ActivityId), totalConsumedRUPerMinute = sum(todouble(RequestCharge)) by OperationName, CollectionName, bin(TimeGenerated, 1min)\r\n| extend averageRUPerOperation = 1.0 * totalConsumedRUPerMinute / totalOperations \r\n| extend fractionOf429s = 1.0 * throttledOperations / totalOperations\r\n| order by fractionOf429s desc\r\n\r\n\r\n\r\n\r\n\r\n//|",
        "size": 0,
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "/subscriptions/86886548-0a7c-430b-b16f-014095647de4/resourceGroups/khelan/providers/Microsoft.DocumentDb/databaseAccounts/testing-intern"
        ],
        "gridSettings": {
          "rowLimit": 500
        }
      },
      "conditionalVisibilities": [
        {
          "parameterName": "IsThrottled",
          "comparison": "isEqualTo",
          "value": "1"
        },
        {
          "parameterName": "Container",
          "comparison": "isNotEqualTo"
        }
      ],
      "name": "query - 14 - Copy"
    },
    {
      "type": 1,
      "content": {
        "json": "# Use the Azure Cosmos DB capacity planner\r\nYou can use the Azure Cosmos DB capacity planner to understand what is the best provisioned throughput based on your workload (volume and type of operations and size of documents). You can customize further the calculations by providing sample data to get a more accurate estimation.\r\n\r\n## 50s on create, replace, or upsert document requests\r\nBy default, in the SQL API, all properties are indexed by default. Tune the <a href=\"https://docs.microsoft.com/azure/cosmos-db/index-policy\">indexing policy</a> to only index the properties needed. This will lower the Request Units required per create document operation, which will reduce the likelihood of seeing 50s or allow you to achieve higher operations per second for the same amount of provisioned RU/s.\r\n\r\n## 50s on query document requests\r\nFollow the guidance to <a href=\"https://docs.microsoft.com/azure/cosmos-db/sql/troubleshoot-query-performance#querys-ru-charge-is-too-high\">troubleshoot queries with high RU charge</a>\r\n\r\n## 50s on execute stored procedures\r\n<a href=\"https://docs.microsoft.com/azure/cosmos-db/sql/stored-procedures-triggers-udfs\">Stored procedures</a> are intended for operations that require write transactions across a partition key value. It is not recommended to use stored procedures for a large number of read or query operations. For best performance, these read or query operations should be done on the client-side, using the Cosmos SDKs."
      },
      "conditionalVisibility": {
        "parameterName": "IsThrottled",
        "comparison": "isEqualTo",
        "value": "1"
      },
      "name": "text - 23"
    }
  ],
  "fallbackResourceIds": [
    "/subscriptions/86886548-0a7c-430b-b16f-014095647de4/resourceGroups/khelan/providers/Microsoft.DocumentDb/databaseAccounts/testing-intern"
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}