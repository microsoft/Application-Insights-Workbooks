{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "095e1fe3-574e-43e3-a993-d3df4d956294",
                  "version": "KqlParameterItem/1.0",
                  "name": "Subscription",
                  "type": 6,
                  "isRequired": true,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "includeAll": true,
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "defaultValue": "value::all",
                  "value": [
                    "value::all"
                  ]
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "parameters - complianceTab"
          }
        ],
        "exportParameters": true
      },
      "name": "Compliance status filters"
    },
    {
      "type": 1,
      "content": {
        "json": "# Machines distribution by OS and Resource type"
      },
      "name": "text - MachinesDistribution"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "resources \r\n| where type =~ \"microsoft.compute/virtualmachines\" or type =~ \"microsoft.hybridcompute/machines\"\r\n| extend osType = coalesce(tostring(properties.osName), tostring(properties.osType), tostring(properties.storageProfile.osDisk.osType))\r\n| summarize\r\ntotal = count(),\r\nazureWindows = countif(type =~ \"microsoft.compute/virtualmachines\" and osType =~ \"Windows\"),\r\nazureLinux = countif(type =~ \"microsoft.compute/virtualmachines\" and osType =~ \"Linux\"),\r\narcWindows = countif(type =~ \"microsoft.hybridcompute/machines\" and osType =~ \"Windows\"),\r\narcLinux = countif(type =~ \"microsoft.hybridcompute/machines\" and osType =~ \"Linux\")\r\n| project machinePack = pack(\"Total\", total, \"Azure virtual machines - Linux\", azureLinux, \"Arc-enabled servers - Linux\", arcLinux, \"Azure virtual machines - Windows\", azureWindows, \"Arc-enabled servers - Windows\", arcWindows)\r\n| mv-expand machinePack\r\n| extend machine = tostring(bag_keys(machinePack)[0])\r\n| extend tileRank = case(machine == \"Total\", 0, machine == \"Azure virtual machines - Windows\", 1, machine == \"Azure virtual machines - Linux\", 2, machine == \"Arc-enabled servers - Windows\", 4, machine == \"Arc-enabled servers - Linux\", 5, 6)\r\n| extend count_ = tolong(machinePack[machine])\r\n| project machine, tileRank, count_ ",
        "size": 4,
        "noDataMessage": "No Machines found.",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "{Subscription}"
        ],
        "visualization": "tiles",
        "tileSettings": {
          "titleContent": {
            "columnMatch": "machine",
            "formatter": 1
          },
          "leftContent": {
            "columnMatch": "count_",
            "formatter": 12,
            "formatOptions": {
              "palette": "auto",
              "linkTarget": "OpenBlade",
              "bladeOpenContext": {
                "bladeName": "UpdateCenterMachinesBlade",
                "extensionName": "Microsoft_Azure_Automation",
                "bladeJsonParameters": "{}"
              }
            },
            "numberFormat": {
              "unit": 17,
              "options": {
                "style": "decimal",
                "maximumFractionDigits": 2,
                "maximumSignificantDigits": 3
              }
            }
          },
          "showBorder": false,
          "sortCriteriaField": "tileRank",
          "sortOrderField": 1,
          "size": "auto"
        }
      },
      "name": "Total machines view",
      "styleSettings": {
        "padding": "-30px",
        "showBorder": true
      }
    },
    {
      "type": 1,
      "content": {
        "json": "# Security and Critical update compliance status"
      },
      "name": "text - SecurityAndCriticalUpdateComplianceStatus"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "resources\r\n| where type =~ \"microsoft.compute/virtualmachines\" or type =~ \"microsoft.hybridcompute/machines\"\r\n| project vmId = tolower(id)\r\n| join kind = leftouter (\r\n    patchassessmentresources\r\n    | where type =~ \"microsoft.compute/virtualmachines/patchassessmentresults\" or type =~ \"microsoft.hybridcompute/machines/patchassessmentresults\"\r\n    | extend status = tostring(properties.status)\r\n    | where status =~ \"Succeeded\"\r\n    | parse id with resourceId '/patchAssessmentResults/' *\r\n    | extend vmId = tolower(resourceId)\r\n) on vmId\r\n| extend ComplianceStatus = case(isempty(properties), \"No updates data\", toint(properties.availablePatchCountByClassification.security) > 0 or toint(properties.availablePatchCountByClassification.critical) > 0, \"Non-Compliant\", \"Compliant\")\r\n| summarize dcount(vmId) by ComplianceStatus",
              "size": 3,
              "title": "Compliance status of machines",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "Compliant",
                    "color": "green"
                  },
                  {
                    "seriesName": "Non-Compliant",
                    "color": "red"
                  },
                  {
                    "seriesName": "No updates data",
                    "color": "orangeDark"
                  }
                ]
              }
            },
            "customWidth": "50",
            "name": "Security and critical update compliance",
            "styleSettings": {
              "maxWidth": "35%"
            }
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources\r\n| where type =~ \"microsoft.compute/virtualmachines\"\r\n| project vmId = tolower(id)\r\n| join kind = leftouter (\r\n    patchassessmentresources\r\n    | where type =~ \"microsoft.compute/virtualmachines/patchassessmentresults\"\r\n    | extend status = tostring(properties.status)\r\n    | where status =~ \"Succeeded\"\r\n    | parse id with resourceId '/patchAssessmentResults/' *\r\n    | extend vmId = tolower(resourceId)\r\n) on vmId\r\n| extend ComplianceStatus = case(isempty(properties), \"No updates data\", toint(properties.availablePatchCountByClassification.security) > 0 or toint(properties.availablePatchCountByClassification.critical) > 0, \"Non-Compliant\", \"Compliant\")\r\n| summarize dcount(vmId) by ComplianceStatus",
                    "size": 4,
                    "title": "Azure virtual machines compliance",
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "visualization": "piechart",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "resourceType",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "compliancePercentage",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "hotCold"
                        },
                        "numberFormat": {
                          "unit": 1,
                          "options": {
                            "style": "decimal"
                          }
                        }
                      },
                      "rightContent": {
                        "columnMatch": "unit",
                        "formatter": 1
                      },
                      "secondaryContent": {
                        "columnMatch": "totalMachinesString"
                      },
                      "showBorder": false,
                      "size": "auto"
                    },
                    "graphSettings": {
                      "type": 2,
                      "topContent": {
                        "columnMatch": "resourceType",
                        "formatter": 1
                      },
                      "centerContent": {
                        "columnMatch": "compliancePercentage",
                        "formatter": 1,
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "maximumFractionDigits": 2,
                            "maximumSignificantDigits": 3
                          }
                        }
                      },
                      "bottomContent": {
                        "columnMatch": "totalMachinesString"
                      },
                      "nodeIdField": "resourceType",
                      "graphOrientation": 3,
                      "showOrientationToggles": false,
                      "nodeSize": null,
                      "staticNodeSize": 100,
                      "colorSettings": {
                        "nodeColorField": "compliancePercentage",
                        "type": 1,
                        "colorPalette": "default",
                        "emptyValueColor": "gray"
                      },
                      "hivesMargin": 20,
                      "edgeColorSettings": null
                    },
                    "chartSettings": {
                      "seriesLabelSettings": [
                        {
                          "seriesName": "No updates data",
                          "color": "orangeDark"
                        },
                        {
                          "seriesName": "Compliant",
                          "color": "green"
                        },
                        {
                          "seriesName": "Non-Compliant",
                          "color": "red"
                        }
                      ]
                    }
                  },
                  "name": "Security and Critical update compliance by resource type - Azure"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources\r\n| where type =~ \"microsoft.hybridcompute/machines\"\r\n| project vmId = tolower(id)\r\n| join kind = leftouter (\r\n    patchassessmentresources\r\n    | where type =~ \"microsoft.hybridcompute/machines/patchassessmentresults\"\r\n    | extend status = tostring(properties.status)\r\n    | where status =~ \"Succeeded\"\r\n    | parse id with resourceId '/patchAssessmentResults/' *\r\n    | extend vmId = tolower(resourceId)\r\n) on vmId\r\n| extend ComplianceStatus = case(isempty(properties), \"No updates data\", toint(properties.availablePatchCountByClassification.security) > 0 or toint(properties.availablePatchCountByClassification.critical) > 0, \"Non-Compliant\", \"Compliant\")\r\n| summarize dcount(vmId) by ComplianceStatus",
                    "size": 4,
                    "title": "Arc-enabled servers compliance",
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "visualization": "piechart",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "resourceType",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "compliancePercentage",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "hotCold"
                        },
                        "numberFormat": {
                          "unit": 1,
                          "options": {
                            "style": "decimal"
                          }
                        }
                      },
                      "rightContent": {
                        "columnMatch": "unit",
                        "formatter": 1
                      },
                      "secondaryContent": {
                        "columnMatch": "totalMachinesString"
                      },
                      "showBorder": false,
                      "size": "auto"
                    },
                    "graphSettings": {
                      "type": 2,
                      "topContent": {
                        "columnMatch": "resourceType",
                        "formatter": 1
                      },
                      "centerContent": {
                        "columnMatch": "compliancePercentage",
                        "formatter": 1,
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "maximumFractionDigits": 2,
                            "maximumSignificantDigits": 3
                          }
                        }
                      },
                      "bottomContent": {
                        "columnMatch": "totalMachinesString"
                      },
                      "nodeIdField": "resourceType",
                      "graphOrientation": 3,
                      "showOrientationToggles": false,
                      "nodeSize": null,
                      "staticNodeSize": 100,
                      "colorSettings": {
                        "nodeColorField": "compliancePercentage",
                        "type": 1,
                        "colorPalette": "default",
                        "emptyValueColor": "gray"
                      },
                      "hivesMargin": 20,
                      "edgeColorSettings": null
                    },
                    "chartSettings": {
                      "seriesLabelSettings": [
                        {
                          "seriesName": "No updates data",
                          "color": "orangeDark"
                        },
                        {
                          "seriesName": "Non-Compliant",
                          "color": "red"
                        },
                        {
                          "seriesName": "Compliant",
                          "color": "green"
                        }
                      ]
                    }
                  },
                  "name": "Security and Critical update compliance by resource type - Arc"
                }
              ]
            },
            "customWidth": "50",
            "name": "Compliance percentages",
            "styleSettings": {
              "maxWidth": "30%"
            }
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources\r\n| where type =~ \"microsoft.compute/virtualmachines\" or type =~ \"microsoft.hybridcompute/machines\"\r\n| extend osType = coalesce(tostring(properties.osName), tostring(properties.osType), tostring(properties.storageProfile.osDisk.osType))\r\n| where osType =~ \"windows\"\r\n| project vmId = tolower(id)\r\n| join kind=leftouter (\r\n    patchassessmentresources\r\n    | where type =~ \"microsoft.compute/virtualmachines/patchassessmentresults\" or type =~ \"microsoft.hybridcompute/machines/patchassessmentresults\"\r\n    | extend status = tostring(properties.status)\r\n    | where status =~ \"Succeeded\"\r\n    | parse id with resourceId '/patchAssessmentResults/' *\r\n    | extend vmId = tolower(resourceId)\r\n    | project vmId, properties\r\n) on vmId\r\n| extend ComplianceStatus = case(isempty(properties), \"No updates data\", toint(properties.availablePatchCountByClassification.security) > 0 or toint(properties.availablePatchCountByClassification.critical) > 0, \"Non-Compliant\", \"Compliant\")\r\n| summarize dcount(vmId) by ComplianceStatus",
                    "size": 4,
                    "title": "Windows machines compliance",
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "visualization": "piechart",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "osType",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "compliancePercentage",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "hotCold"
                        },
                        "numberFormat": {
                          "unit": 1,
                          "options": {
                            "style": "decimal",
                            "maximumFractionDigits": 2,
                            "maximumSignificantDigits": 3
                          }
                        }
                      },
                      "secondaryContent": {
                        "columnMatch": "totalMachinesString"
                      },
                      "showBorder": false
                    },
                    "graphSettings": {
                      "type": 2,
                      "topContent": {
                        "columnMatch": "resourceType",
                        "formatter": 1
                      },
                      "centerContent": {
                        "columnMatch": "compliancePercentage",
                        "formatter": 1,
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "maximumFractionDigits": 2,
                            "maximumSignificantDigits": 3
                          }
                        }
                      },
                      "bottomContent": {
                        "columnMatch": "totalMachinesString"
                      },
                      "nodeIdField": "resourceType",
                      "graphOrientation": 3,
                      "showOrientationToggles": false,
                      "nodeSize": null,
                      "staticNodeSize": 100,
                      "colorSettings": {
                        "nodeColorField": "compliancePercentage",
                        "type": 1,
                        "colorPalette": "default",
                        "emptyValueColor": "gray"
                      },
                      "hivesMargin": 20,
                      "edgeColorSettings": null
                    },
                    "chartSettings": {
                      "seriesLabelSettings": [
                        {
                          "seriesName": "No updates data",
                          "color": "orangeDark"
                        },
                        {
                          "seriesName": "Compliant",
                          "color": "green"
                        },
                        {
                          "seriesName": "Non-Compliant",
                          "color": "red"
                        }
                      ]
                    }
                  },
                  "name": "Security and Critical update compliance by OS type - Windows"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources\r\n| where type =~ \"microsoft.compute/virtualmachines\" or type =~ \"microsoft.hybridcompute/machines\"\r\n| extend osType = coalesce(tostring(properties.osName), tostring(properties.osType), tostring(properties.storageProfile.osDisk.osType))\r\n| where osType =~ \"linux\"\r\n| project vmId = tolower(id)\r\n| join kind=leftouter (\r\n    patchassessmentresources\r\n    | where type =~ \"microsoft.compute/virtualmachines/patchassessmentresults\" or type =~ \"microsoft.hybridcompute/machines/patchassessmentresults\"\r\n    | extend status = tostring(properties.status)\r\n    | where status =~ \"Succeeded\"\r\n    | parse id with resourceId '/patchAssessmentResults/' *\r\n    | extend vmId = tolower(resourceId)\r\n    | project vmId, properties\r\n) on vmId\r\n| extend ComplianceStatus = case(isempty(properties), \"No updates data\", toint(properties.availablePatchCountByClassification.security) > 0 or toint(properties.availablePatchCountByClassification.critical) > 0, \"Non-Compliant\", \"Compliant\")\r\n| summarize dcount(vmId) by ComplianceStatus",
                    "size": 4,
                    "title": "Linux machines compliance",
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "visualization": "piechart",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "osType",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "compliancePercentage",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "hotCold"
                        },
                        "numberFormat": {
                          "unit": 1,
                          "options": {
                            "style": "decimal",
                            "maximumFractionDigits": 2,
                            "maximumSignificantDigits": 3
                          }
                        }
                      },
                      "secondaryContent": {
                        "columnMatch": "totalMachinesString"
                      },
                      "showBorder": false
                    },
                    "graphSettings": {
                      "type": 2,
                      "topContent": {
                        "columnMatch": "resourceType",
                        "formatter": 1
                      },
                      "centerContent": {
                        "columnMatch": "compliancePercentage",
                        "formatter": 1,
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "maximumFractionDigits": 2,
                            "maximumSignificantDigits": 3
                          }
                        }
                      },
                      "bottomContent": {
                        "columnMatch": "totalMachinesString"
                      },
                      "nodeIdField": "resourceType",
                      "graphOrientation": 3,
                      "showOrientationToggles": false,
                      "nodeSize": null,
                      "staticNodeSize": 100,
                      "colorSettings": {
                        "nodeColorField": "compliancePercentage",
                        "type": 1,
                        "colorPalette": "default",
                        "emptyValueColor": "gray"
                      },
                      "hivesMargin": 20,
                      "edgeColorSettings": null
                    },
                    "chartSettings": {
                      "seriesLabelSettings": [
                        {
                          "seriesName": "No updates data",
                          "color": "orangeDark"
                        },
                        {
                          "seriesName": "Non-Compliant",
                          "color": "red"
                        },
                        {
                          "seriesName": "Compliant",
                          "color": "green"
                        }
                      ]
                    }
                  },
                  "name": "Security and Critical update compliance by OS type - Linux"
                }
              ]
            },
            "name": "Compliance by OS type",
            "styleSettings": {
              "maxWidth": "33.33%"
            }
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "### <u>**Action(s):**</u>"
                  },
                  "name": "text - Actions"
                },
                {
                  "type": 11,
                  "content": {
                    "version": "LinkItem/1.0",
                    "style": "paragraph",
                    "links": [
                      {
                        "id": "d083f872-c4a4-4653-a153-9e476b7bb099",
                        "linkTarget": "OpenBlade",
                        "linkLabel": "Schedule update",
                        "preText": "",
                        "postText": "or",
                        "style": "link",
                        "bladeOpenContext": {
                          "bladeName": "CreateMaintenanceConfiguration.ReactView",
                          "extensionName": "Microsoft_Azure_Maintenance",
                          "bladeParameters": [
                            {
                              "name": "scope",
                              "source": "static",
                              "value": "InGuestPatch"
                            }
                          ]
                        }
                      },
                      {
                        "id": "6f7cb705-7a0f-487a-96c4-4ba416f25b99",
                        "linkTarget": "OpenBlade",
                        "linkLabel": "One-time update",
                        "preText": "trigger ",
                        "postText": "to stay compliant.",
                        "style": "link",
                        "bladeOpenContext": {
                          "bladeName": "UpdateCenterInstallUpdatesBlade",
                          "extensionName": "Microsoft_Azure_Automation",
                          "bladeJsonParameters": "{\r\n\t\"ids\": [],\r\n\t\"subs\": [],\r\n\t\"source\": \"AUMReportsComplianceViewTab_SecurityAndCritical\"\r\n}"
                        }
                      }
                    ]
                  },
                  "name": "links - patchTriggerAction"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources\r\n| where type =~ \"microsoft.compute/virtualmachines\" or type =~ \"microsoft.hybridcompute/machines\"\r\n| extend os = tolower(coalesce(properties.osName, properties.osType, properties.storageProfile.osDisk.osType))\r\n| extend patchSettingsObject = iff(os == \"windows\", properties.osProfile.windowsConfiguration.patchSettings, properties.osProfile.linuxConfiguration.patchSettings)\r\n| extend assessmentMode = tostring(patchSettingsObject.assessmentMode)\r\n| extend PeriodicAssessment = iff(assessmentMode =~ \"AutomaticByPlatform\", \"Enabled\", \"Disabled\")\r\n| summarize PeriodicAssessmentEnablementPercentage = round(todouble(countif(PeriodicAssessment == \"Disabled\")) / count() * 100, 2)\r\n| project paRecommendation = strcat(\"**\", PeriodicAssessmentEnablementPercentage, \"% of machines do not have periodic assessment enabled.**\", \" Enable periodic assessment to stay up to date with the patch compliance of your VMs. [Learn more](https://aka.ms/PeriodicAssessmentLearnMore)\")",
                    "size": 3,
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "visualization": "card",
                    "textSettings": {
                      "style": "markdown"
                    }
                  },
                  "name": "query - PercentageOfPeriodicAssessmentEnabled"
                },
                {
                  "type": 11,
                  "content": {
                    "version": "LinkItem/1.0",
                    "style": "paragraph",
                    "links": [
                      {
                        "id": "485cae23-63ce-4120-8d04-b40d15433d1a",
                        "linkTarget": "OpenBlade",
                        "linkLabel": "Enable Periodic assessment now",
                        "style": "primary",
                        "bladeOpenContext": {
                          "bladeName": "UpdateCenterUpdateSettingsBlade",
                          "extensionName": "Microsoft_Azure_Automation",
                          "bladeJsonParameters": "{\r\n\t\"ids\": [],\r\n\t\"source\": \"AUMReportsRecommendationsTab\"\r\n}"
                        }
                      }
                    ]
                  },
                  "name": "links - UpdateSettingsBlade"
                }
              ]
            },
            "name": "Compliance status action"
          }
        ]
      },
      "name": "Compliance status",
      "styleSettings": {
        "margin": "0 0 0 10px",
        "showBorder": true
      }
    },
    {
      "type": 1,
      "content": {
        "json": "# Overall update compliance status"
      },
      "name": "text - OverallUpdateComplianceStatus"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "resources\r\n| where type =~ \"microsoft.compute/virtualmachines\" or type =~ \"microsoft.hybridcompute/machines\"\r\n| project vmId = tolower(id)\r\n| join kind=leftouter (\r\n    patchassessmentresources\r\n    | where type =~ \"microsoft.compute/virtualmachines/patchassessmentresults\" or type =~ \"microsoft.hybridcompute/machines/patchassessmentresults\"\r\n    | extend status = tostring(properties.status)\r\n    | where status =~ \"Succeeded\"\r\n    | parse id with resourceId '/patchAssessmentResults/' *\r\n    | extend vmId = tolower(resourceId)\r\n    | project vmId, properties\r\n) on vmId\r\n| extend ComplianceStatus = case(isnull(properties), \"No updates data\" ,toint(properties.availablePatchCountByClassification.security) > 0 or toint(properties.availablePatchCountByClassification.critical) > 0\r\n                                    or toint(properties.availablePatchCountByClassification.updateRollup) > 0 or toint(properties.availablePatchCountByClassification.featurePack) > 0\r\n                                    or toint(properties.availablePatchCountByClassification.servicePack) > 0 or toint(properties.availablePatchCountByClassification.definition) > 0\r\n                                    or toint(properties.availablePatchCountByClassification.tools) > 0 or toint(properties.availablePatchCountByClassification.updates) > 0\r\n                                    or toint(properties.availablePatchCountByClassification.other) > 0, \"Non-Compliant\", \"Compliant\")\r\n| summarize dcount(vmId) by ComplianceStatus",
              "size": 3,
              "title": "Compliance status of machines",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "Compliant",
                    "color": "green"
                  },
                  {
                    "seriesName": "Non-Compliant",
                    "color": "red"
                  },
                  {
                    "seriesName": "No updates data",
                    "color": "orangeDark"
                  }
                ]
              }
            },
            "customWidth": "50",
            "name": "Overall update compliance",
            "styleSettings": {
              "maxWidth": "35%"
            }
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources\r\n| where type =~ \"microsoft.compute/virtualmachines\"\r\n| project vmId = tolower(id)\r\n| join kind = leftouter (\r\n    patchassessmentresources\r\n    | where type =~ \"microsoft.compute/virtualmachines/patchassessmentresults\"\r\n    | extend status = tostring(properties.status)\r\n    | where status =~ \"Succeeded\"\r\n    | parse id with resourceId '/patchAssessmentResults/' *\r\n    | extend vmId = tolower(resourceId)\r\n) on vmId\r\n| extend ComplianceStatus = case(isnull(properties), \"No updates data\" ,toint(properties.availablePatchCountByClassification.security) > 0 or toint(properties.availablePatchCountByClassification.critical) > 0\r\n                                    or toint(properties.availablePatchCountByClassification.updateRollup) > 0 or toint(properties.availablePatchCountByClassification.featurePack) > 0\r\n                                    or toint(properties.availablePatchCountByClassification.servicePack) > 0 or toint(properties.availablePatchCountByClassification.definition) > 0\r\n                                    or toint(properties.availablePatchCountByClassification.tools) > 0 or toint(properties.availablePatchCountByClassification.updates) > 0\r\n                                    or toint(properties.availablePatchCountByClassification.other) > 0, \"Non-Compliant\", \"Compliant\")\r\n| summarize dcount(vmId) by ComplianceStatus",
                    "size": 4,
                    "title": "Azure virtual machines compliance",
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "visualization": "piechart",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "resourceType",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "compliancePercentage",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "hotCold"
                        },
                        "numberFormat": {
                          "unit": 1,
                          "options": {
                            "style": "decimal"
                          }
                        }
                      },
                      "rightContent": {
                        "columnMatch": "unit",
                        "formatter": 1
                      },
                      "secondaryContent": {
                        "columnMatch": "totalMachinesString"
                      },
                      "showBorder": false,
                      "size": "auto"
                    },
                    "graphSettings": {
                      "type": 2,
                      "topContent": {
                        "columnMatch": "resourceType",
                        "formatter": 1
                      },
                      "centerContent": {
                        "columnMatch": "compliancePercentage",
                        "formatter": 1,
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "maximumFractionDigits": 2,
                            "maximumSignificantDigits": 3
                          }
                        }
                      },
                      "bottomContent": {
                        "columnMatch": "totalMachinesString"
                      },
                      "nodeIdField": "resourceType",
                      "graphOrientation": 3,
                      "showOrientationToggles": false,
                      "nodeSize": null,
                      "staticNodeSize": 100,
                      "colorSettings": {
                        "nodeColorField": "compliancePercentage",
                        "type": 1,
                        "colorPalette": "default",
                        "emptyValueColor": "gray"
                      },
                      "hivesMargin": 20,
                      "edgeColorSettings": null
                    },
                    "chartSettings": {
                      "seriesLabelSettings": [
                        {
                          "seriesName": "No updates data",
                          "color": "orangeDark"
                        },
                        {
                          "seriesName": "Non-Compliant",
                          "color": "red"
                        },
                        {
                          "seriesName": "Compliant",
                          "color": "green"
                        }
                      ]
                    }
                  },
                  "name": "Overall update compliance by resource type - Azure"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources\r\n| where type =~ \"microsoft.hybridcompute/machines\"\r\n| project vmId = tolower(id)\r\n| join kind = leftouter (\r\n    patchassessmentresources\r\n    | where type =~ \"microsoft.hybridcompute/machines/patchassessmentresults\"\r\n    | extend status = tostring(properties.status)\r\n    | where status =~ \"Succeeded\"\r\n    | parse id with resourceId '/patchAssessmentResults/' *\r\n    | extend vmId = tolower(resourceId)\r\n) on vmId\r\n| extend ComplianceStatus = case(isnull(properties), \"No updates data\" ,toint(properties.availablePatchCountByClassification.security) > 0 or toint(properties.availablePatchCountByClassification.critical) > 0\r\n                                    or toint(properties.availablePatchCountByClassification.updateRollup) > 0 or toint(properties.availablePatchCountByClassification.featurePack) > 0\r\n                                    or toint(properties.availablePatchCountByClassification.servicePack) > 0 or toint(properties.availablePatchCountByClassification.definition) > 0\r\n                                    or toint(properties.availablePatchCountByClassification.tools) > 0 or toint(properties.availablePatchCountByClassification.updates) > 0\r\n                                    or toint(properties.availablePatchCountByClassification.other) > 0, \"Non-Compliant\", \"Compliant\")\r\n| summarize dcount(vmId) by ComplianceStatus",
                    "size": 4,
                    "title": "Arc-enabled servers compliance",
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "visualization": "piechart",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "resourceType",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "compliancePercentage",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "hotCold"
                        },
                        "numberFormat": {
                          "unit": 1,
                          "options": {
                            "style": "decimal"
                          }
                        }
                      },
                      "rightContent": {
                        "columnMatch": "unit",
                        "formatter": 1
                      },
                      "secondaryContent": {
                        "columnMatch": "totalMachinesString"
                      },
                      "showBorder": false,
                      "size": "auto"
                    },
                    "graphSettings": {
                      "type": 2,
                      "topContent": {
                        "columnMatch": "resourceType",
                        "formatter": 1
                      },
                      "centerContent": {
                        "columnMatch": "compliancePercentage",
                        "formatter": 1,
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "maximumFractionDigits": 2,
                            "maximumSignificantDigits": 3
                          }
                        }
                      },
                      "bottomContent": {
                        "columnMatch": "totalMachinesString"
                      },
                      "nodeIdField": "resourceType",
                      "graphOrientation": 3,
                      "showOrientationToggles": false,
                      "nodeSize": null,
                      "staticNodeSize": 100,
                      "colorSettings": {
                        "nodeColorField": "compliancePercentage",
                        "type": 1,
                        "colorPalette": "default",
                        "emptyValueColor": "gray"
                      },
                      "hivesMargin": 20,
                      "edgeColorSettings": null
                    },
                    "chartSettings": {
                      "seriesLabelSettings": [
                        {
                          "seriesName": "No updates data",
                          "color": "orangeDark"
                        },
                        {
                          "seriesName": "Non-Compliant",
                          "color": "red"
                        },
                        {
                          "seriesName": "Compliant",
                          "color": "green"
                        }
                      ]
                    }
                  },
                  "name": "Overall update compliance by resource type - Arc"
                }
              ]
            },
            "customWidth": "50",
            "name": "Overall Compliance percentages by resource types",
            "styleSettings": {
              "maxWidth": "30%"
            }
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources\r\n| where type =~ \"microsoft.compute/virtualmachines\" or type =~ \"microsoft.hybridcompute/machines\"\r\n| extend osType = coalesce(tostring(properties.osName), tostring(properties.osType), tostring(properties.storageProfile.osDisk.osType))\r\n| where osType =~ \"windows\"\r\n| project vmId = tolower(id)\r\n| join kind = leftouter (\r\n    patchassessmentresources\r\n    | where type =~ \"microsoft.compute/virtualmachines/patchassessmentresults\" or type =~ \"microsoft.hybridcompute/machines/patchassessmentresults\"\r\n    | extend status = tostring(properties.status)\r\n    | where status =~ \"Succeeded\"\r\n    | parse id with resourceId '/patchAssessmentResults/' *\r\n    | extend vmId = tolower(resourceId)\r\n) on vmId\r\n| extend ComplianceStatus = case(isnull(properties), \"No updates data\" ,toint(properties.availablePatchCountByClassification.security) > 0 or toint(properties.availablePatchCountByClassification.critical) > 0\r\n                                    or toint(properties.availablePatchCountByClassification.updateRollup) > 0 or toint(properties.availablePatchCountByClassification.featurePack) > 0\r\n                                    or toint(properties.availablePatchCountByClassification.servicePack) > 0 or toint(properties.availablePatchCountByClassification.definition) > 0\r\n                                    or toint(properties.availablePatchCountByClassification.tools) > 0 or toint(properties.availablePatchCountByClassification.updates) > 0\r\n                                    or toint(properties.availablePatchCountByClassification.other) > 0, \"Non-Compliant\", \"Compliant\")\r\n| summarize dcount(vmId) by ComplianceStatus",
                    "size": 4,
                    "title": "Windows machines compliance",
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "visualization": "piechart",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "resourceType",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "compliancePercentage",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "hotCold"
                        },
                        "numberFormat": {
                          "unit": 1,
                          "options": {
                            "style": "decimal"
                          }
                        }
                      },
                      "rightContent": {
                        "columnMatch": "unit",
                        "formatter": 1
                      },
                      "secondaryContent": {
                        "columnMatch": "totalMachinesString"
                      },
                      "showBorder": false,
                      "size": "auto"
                    },
                    "graphSettings": {
                      "type": 2,
                      "topContent": {
                        "columnMatch": "resourceType",
                        "formatter": 1
                      },
                      "centerContent": {
                        "columnMatch": "compliancePercentage",
                        "formatter": 1,
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "maximumFractionDigits": 2,
                            "maximumSignificantDigits": 3
                          }
                        }
                      },
                      "bottomContent": {
                        "columnMatch": "totalMachinesString"
                      },
                      "nodeIdField": "resourceType",
                      "graphOrientation": 3,
                      "showOrientationToggles": false,
                      "nodeSize": null,
                      "staticNodeSize": 100,
                      "colorSettings": {
                        "nodeColorField": "compliancePercentage",
                        "type": 1,
                        "colorPalette": "default",
                        "emptyValueColor": "gray"
                      },
                      "hivesMargin": 20,
                      "edgeColorSettings": null
                    },
                    "chartSettings": {
                      "seriesLabelSettings": [
                        {
                          "seriesName": "No updates data",
                          "color": "orangeDark"
                        },
                        {
                          "seriesName": "Non-Compliant",
                          "color": "red"
                        },
                        {
                          "seriesName": "Compliant",
                          "color": "green"
                        }
                      ]
                    }
                  },
                  "name": "Overall update compliance by OS type - Windows"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources\r\n| where type =~ \"microsoft.compute/virtualmachines\" or type =~ \"microsoft.hybridcompute/machines\"\r\n| extend osType = coalesce(tostring(properties.osName), tostring(properties.osType), tostring(properties.storageProfile.osDisk.osType))\r\n| where osType =~ \"linux\"\r\n| project vmId = tolower(id)\r\n| join kind = leftouter (\r\n    patchassessmentresources\r\n    | where type =~ \"microsoft.compute/virtualmachines/patchassessmentresults\" or type =~ \"microsoft.hybridcompute/machines/patchassessmentresults\"\r\n    | extend status = tostring(properties.status)\r\n    | where status =~ \"Succeeded\"\r\n    | parse id with resourceId '/patchAssessmentResults/' *\r\n    | extend vmId = tolower(resourceId)\r\n) on vmId\r\n| extend ComplianceStatus = case(isnull(properties), \"No updates data\" ,toint(properties.availablePatchCountByClassification.security) > 0 or toint(properties.availablePatchCountByClassification.critical) > 0\r\n                                    or toint(properties.availablePatchCountByClassification.updateRollup) > 0 or toint(properties.availablePatchCountByClassification.featurePack) > 0\r\n                                    or toint(properties.availablePatchCountByClassification.servicePack) > 0 or toint(properties.availablePatchCountByClassification.definition) > 0\r\n                                    or toint(properties.availablePatchCountByClassification.tools) > 0 or toint(properties.availablePatchCountByClassification.updates) > 0\r\n                                    or toint(properties.availablePatchCountByClassification.other) > 0, \"Non-Compliant\", \"Compliant\")\r\n| summarize dcount(vmId) by ComplianceStatus",
                    "size": 4,
                    "title": "Linux machines compliance",
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "visualization": "piechart",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "resourceType",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "compliancePercentage",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "hotCold"
                        },
                        "numberFormat": {
                          "unit": 1,
                          "options": {
                            "style": "decimal"
                          }
                        }
                      },
                      "rightContent": {
                        "columnMatch": "unit",
                        "formatter": 1
                      },
                      "secondaryContent": {
                        "columnMatch": "totalMachinesString"
                      },
                      "showBorder": false,
                      "size": "auto"
                    },
                    "graphSettings": {
                      "type": 2,
                      "topContent": {
                        "columnMatch": "resourceType",
                        "formatter": 1
                      },
                      "centerContent": {
                        "columnMatch": "compliancePercentage",
                        "formatter": 1,
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "maximumFractionDigits": 2,
                            "maximumSignificantDigits": 3
                          }
                        }
                      },
                      "bottomContent": {
                        "columnMatch": "totalMachinesString"
                      },
                      "nodeIdField": "resourceType",
                      "graphOrientation": 3,
                      "showOrientationToggles": false,
                      "nodeSize": null,
                      "staticNodeSize": 100,
                      "colorSettings": {
                        "nodeColorField": "compliancePercentage",
                        "type": 1,
                        "colorPalette": "default",
                        "emptyValueColor": "gray"
                      },
                      "hivesMargin": 20,
                      "edgeColorSettings": null
                    },
                    "chartSettings": {
                      "seriesLabelSettings": [
                        {
                          "seriesName": "No updates data",
                          "color": "orangeDark"
                        },
                        {
                          "seriesName": "Non-Compliant",
                          "color": "red"
                        },
                        {
                          "seriesName": "Compliant",
                          "color": "green"
                        }
                      ]
                    }
                  },
                  "name": "Overall update compliance by OS type - Linux"
                }
              ]
            },
            "customWidth": "50",
            "name": "Overall Compliance percentages by OS type",
            "styleSettings": {
              "maxWidth": "30%"
            }
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "### <u>**Action(s):**</u>"
                  },
                  "name": "text - Actions2"
                },
                {
                  "type": 11,
                  "content": {
                    "version": "LinkItem/1.0",
                    "style": "paragraph",
                    "links": [
                      {
                        "id": "d083f872-c4a4-4653-a153-9e476b7bb099",
                        "linkTarget": "OpenBlade",
                        "linkLabel": "Schedule update",
                        "preText": "",
                        "postText": "or",
                        "style": "link",
                        "bladeOpenContext": {
                          "bladeName": "CreateMaintenanceConfiguration.ReactView",
                          "extensionName": "Microsoft_Azure_Maintenance",
                          "bladeParameters": [
                            {
                              "name": "scope",
                              "source": "static",
                              "value": "InGuestPatch"
                            }
                          ]
                        }
                      },
                      {
                        "id": "6f7cb705-7a0f-487a-96c4-4ba416f25b99",
                        "linkTarget": "OpenBlade",
                        "linkLabel": "One-time update",
                        "preText": "trigger ",
                        "postText": "to stay compliant.",
                        "style": "link",
                        "bladeOpenContext": {
                          "bladeName": "UpdateCenterInstallUpdatesBlade",
                          "extensionName": "Microsoft_Azure_Automation",
                          "bladeJsonParameters": "{\r\n\t\"ids\": [],\r\n\t\"subs\": [],\r\n\t\"source\": \"AUMReportsComplianceViewTab_Overall\"\r\n}"
                        }
                      }
                    ]
                  },
                  "name": "links - patchTriggerAction2"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources\r\n| where type =~ \"microsoft.compute/virtualmachines\" or type =~ \"microsoft.hybridcompute/machines\"\r\n| extend os = tolower(coalesce(properties.osName, properties.osType, properties.storageProfile.osDisk.osType))\r\n| extend patchSettingsObject = iff(os == \"windows\", properties.osProfile.windowsConfiguration.patchSettings, properties.osProfile.linuxConfiguration.patchSettings)\r\n| extend assessmentMode = tostring(patchSettingsObject.assessmentMode)\r\n| extend PeriodicAssessment = iff(assessmentMode =~ \"AutomaticByPlatform\", \"Enabled\", \"Disabled\")\r\n| summarize PeriodicAssessmentEnablementPercentage = round(todouble(countif(PeriodicAssessment == \"Disabled\")) / count() * 100, 2)\r\n| project paRecommendation = strcat(\"**\", PeriodicAssessmentEnablementPercentage, \"% of machines do not have periodic assessment enabled.**\", \" Enable periodic assessment to stay up to date with the patch compliance of your VMs. [Learn more](https://aka.ms/PeriodicAssessmentLearnMore)\")",
                    "size": 3,
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "visualization": "card",
                    "textSettings": {
                      "style": "markdown"
                    }
                  },
                  "name": "query - PercentageOfPeriodicAssessmentEnabled2"
                },
                {
                  "type": 11,
                  "content": {
                    "version": "LinkItem/1.0",
                    "style": "paragraph",
                    "links": [
                      {
                        "id": "485cae23-63ce-4120-8d04-b40d15433d1a",
                        "linkTarget": "OpenBlade",
                        "linkLabel": "Enable Periodic assessment now",
                        "style": "primary",
                        "bladeOpenContext": {
                          "bladeName": "UpdateCenterUpdateSettingsBlade",
                          "extensionName": "Microsoft_Azure_Automation",
                          "bladeJsonParameters": "{\r\n\t\"ids\": [],\r\n\t\"source\": \"AUMReportsRecommendationsTab\"\r\n}"
                        }
                      }
                    ]
                  },
                  "name": "links - updateSettingsBladeAction2"
                }
              ]
            },
            "name": "Compliance status action"
          }
        ]
      },
      "name": "Overall Compliance status",
      "styleSettings": {
        "margin": "0 0 0 10px",
        "showBorder": true
      }
    }
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}