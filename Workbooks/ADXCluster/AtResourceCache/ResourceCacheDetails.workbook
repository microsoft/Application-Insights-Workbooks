{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "version": "KqlParameterItem/1.0",
            "name": "Resource",
            "label": "ADX-Cluster",
            "type": 5,
            "isRequired": true,
            "value": "value::1",
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "resourceTypeFilter": {
                "microsoft.kusto/clusters": true
              },
              "additionalResourceOptions": [
                "value::1"
              ],
              "showDefault": false
            }
          },
          {
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "label": "Time range",
            "type": 4,
            "isRequired": true,
            "value": {
              "durationMs": 604800000
            },
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 900000
                },
                {
                  "durationMs": 1800000
                },
                {
                  "durationMs": 3600000
                },
                {
                  "durationMs": 14400000
                },
                {
                  "durationMs": 43200000
                },
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 172800000
                },
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 604800000
                }
              ],
              "allowCustom": false
            }
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.kusto/clusters"
      },
      "name": "parameters - 0",
      "styleSettings": {
        "margin": "15px 0 0 0"
      }
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "version": "KqlParameterItem/1.0",
            "name": "CacheLogs",
            "type": 1,
            "isRequired": true,
            "query": "let hasNonEmptyTable = (T:string, T2:string) \r\n{ \r\n   toscalar( \r\n   union isfuzzy=true \r\n   ( table(T) | where TimeGenerated > ago(30d) | take 1 | count as Count ),\r\n   ( table(T2) | take 1 | count as Count),\r\n   (print Count=0) \r\n   | summarize sum(Count) \r\n   ) > 0\r\n};\r\nlet TableName = 'ADXTableDetails';\r\nlet TableName2 = 'ADXTableUsageStatistics';\r\nprint  IsPresent=iif(hasNonEmptyTable(TableName,TableName2 ), \"present\", \"not present\")",
            "crossComponentResources": [
              "{Resource}"
            ],
            "isHiddenWhenLocked": true,
            "queryType": 0,
            "resourceType": "microsoft.kusto/clusters"
          },
          {
            "version": "KqlParameterItem/1.0",
            "name": "TableLogsStartDate",
            "type": 1,
            "query": "ADXTableDetails\r\n| summarize minTime=format_datetime(min(TimeGenerated), 'MM/dd/yy [hh:mm tt]')\r\n| extend formatedDate=replace(@'\\[', @',', tostring(minTime))\r\n| extend formatedDate=replace(@'\\]', @'', formatedDate)\r\n| project formatedDate",
            "queryType": 0,
            "resourceType": "microsoft.kusto/clusters"
          },
          {
            "version": "KqlParameterItem/1.0",
            "name": "cacheRecommendation",
            "type": 1,
            "isRequired": true,
            "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"/subscriptions/{Resource:subscription}/providers/Microsoft.Advisor/recommendations\",\"urlParams\":[{\"key\":\"api-version\",\"value\":\"2017-04-19\"},{\"key\":\"$filter\",\"value\":\" ResourceId eq {Resource:value} and (RecommendationTypeGuid eq 'f011adf6-475a-48c9-bf26-8db051cb6964' or RecommendationTypeGuid eq '947a627a-532d-44f8-8e23-4f365a80a2ba' or RecommendationTypeGuid eq '389653ce-d564-4b95-aac4-ca30e1602536'  or RecommendationTypeGuid eq '9a3ea211-a282-4ab6-a63b-81024975b796')\"}],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.value[*]\",\"columns\":[]}}]}",
            "isHiddenWhenLocked": true,
            "queryType": 12
          }
        ],
        "style": "above",
        "queryType": 12
      },
      "conditionalVisibility": {
        "parameterName": "1",
        "comparison": "isEqualTo",
        "value": "2"
      },
      "name": "parameters - 4"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<svg viewBox=\"0 0 18 18\" width=\"20\" class=\"fxt-escapeShadow\" role=\"presentation\" focusable=\"false\" xmlns:svg=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" aria-hidden=\"true\"><g><defs></defs><path d=\"M17.5 9.44a3.85 3.85 0 0 0-3.32-3.74A4.85 4.85 0 0 0 9.23 1a5 5 0 0 0-4.75 3.29 4.58 4.58 0 0 0-4 4.46 4.66 4.66 0 0 0 4.79 4.53 3 3 0 0 0 .42 0h7.75a.64.64 0 0 0 .2 0 3.9 3.9 0 0 0 3.86-3.84z\" fill=\"url(#9b4b971a-fb5a-4299-ab97-14581e9298eb)\"></path><path d=\"M14.53 15.14l-2 2.14a.26.26 0 0 1-.44-.14l-1.21-5.9A.26.26 0 0 1 11 11l1.32-.54a.26.26 0 0 1 .33.13l1.95 4.3a.24.24 0 0 1-.07.25z\" fill=\"#37c2b1\"></path><path d=\"M8 15.14l2 2.14a.26.26 0 0 0 .44-.14l1.21-5.9a.26.26 0 0 0-.15-.28l-1.32-.54a.26.26 0 0 0-.33.13l-1.95 4.3a.24.24 0 0 0 .1.29z\" fill=\"#42e8ca\"></path><path d=\"M11.58 6l.26-.22a.41.41 0 0 1 .57.05.37.37 0 0 1 .07.12l.12.32a.42.42 0 0 0 .45.26l.33-.06a.41.41 0 0 1 .47.33.33.33 0 0 1 0 .14l-.06.33a.42.42 0 0 0 .26.45l.32.11a.42.42 0 0 1 .24.53.75.75 0 0 1-.07.12l-.22.25a.42.42 0 0 0 0 .52l.22.26a.4.4 0 0 1-.06.57.41.41 0 0 1-.11.07l-.32.12a.4.4 0 0 0-.26.45l.06.33a.39.39 0 0 1-.33.46.33.33 0 0 1-.14 0h-.33a.4.4 0 0 0-.45.26l-.12.31a.4.4 0 0 1-.52.24.37.37 0 0 1-.12-.07l-.25-.25a.4.4 0 0 0-.52 0l-.26.21a.4.4 0 0 1-.57-.05.24.24 0 0 1-.07-.12l-.12-.31a.39.39 0 0 0-.45-.26l-.33.06a.41.41 0 0 1-.47-.34.29.29 0 0 1 0-.13l.06-.33a.4.4 0 0 0-.26-.45l-.31-.12a.42.42 0 0 1-.29-.5.75.75 0 0 1 .07-.12l.22-.26a.42.42 0 0 0 0-.52l-.22-.25a.41.41 0 0 1 .06-.58.23.23 0 0 1 .12-.06l.31-.12a.42.42 0 0 0 .26-.45L8.8 7a.41.41 0 0 1 .33-.47h.14l.33.06a.41.41 0 0 0 .45-.26l.12-.33a.41.41 0 0 1 .52-.24l.12.07.26.22a.41.41 0 0 0 .51-.05z\" fill=\"#005ba1\"></path><circle cx=\"11.33\" cy=\"9.02\" r=\"2.36\" fill=\"#ffca00\"></circle></g></svg> &nbsp;<span style=\"font-family: Open Sans; font-weight: 620; font-size: 14px;font-style: bold;margin:-10px -304px 0px 0px;position: relative;top:-5px;left:-4px\">Advisor cache recommendations \r\n</span> \r\n<span style=\"font-family: Open Sans; margin:-10px -304px 0px 0px;position: relative;top:-5px;left:10px\"><br>Advisor recommendations are based on the last 30 days of usage. The recommendations are not affected by the time range parameter\r\n</span> "
            },
            "customWidth": "100",
            "conditionalVisibility": {
              "parameterName": "cacheRecommendation",
              "comparison": "isNotEqualTo"
            },
            "name": "cache text"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "advisorresources\r\n| where type =~ \"microsoft.advisor/recommendations\"\r\n| parse id with * \"providers/Microsoft.Kusto/Clusters/\" cluster_name \"/providers/Microsoft.Advisor/\" *\r\n| where cluster_name =~ '{Resource:name}'\r\n| project stableId = name, id, properties\r\n| join kind=leftouter\r\n(advisorresources \r\n| where type=~'microsoft.advisor/suppressions'\r\n| parse id with * \"providers/Microsoft.Kusto/Clusters/\" cluster_name \"/providers/Microsoft.Advisor/\" *\r\n| where cluster_name =~ '{Resource:name}'\r\n| extend tokens = split(id, '/')\r\n| extend stableId = iff(array_length(tokens) > 3, tokens[(array_length(tokens)-3)], '')\r\n| extend expirationTimeStamp = todatetime(iff(strcmp(tostring(properties.ttl), '-1') == 0,'9999-12-31', properties.expirationTimeStamp))\r\n| where expirationTimeStamp > now()\r\n| project stableId, expirationTimeStamp)\r\non stableId\r\n| where properties.recommendationTypeId in(\"947a627a-532d-44f8-8e23-4f365a80a2ba\",\"f011adf6-475a-48c9-bf26-8db051cb6964\",\"389653ce-d564-4b95-aac4-ca30e1602536\",\"9a3ea211-a282-4ab6-a63b-81024975b796\")\r\n| where isnull(expirationTimeStamp)\r\n| summarize Count = count() by tostring(properties.category)",
              "size": 4,
              "noDataMessage": "You are following all of the cache recommendations for this cluster",
              "noDataMessageStyle": 3,
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Resource}"
              ],
              "visualization": "tiles",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "properties_extendedProperties_tableName",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "20%"
                    }
                  },
                  {
                    "columnMatch": "properties_shortDescription_solution",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "25%"
                    }
                  },
                  {
                    "columnMatch": "properties_extendedProperties_description",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "35%"
                    }
                  },
                  {
                    "columnMatch": "properties_category",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "20%"
                    }
                  },
                  {
                    "columnMatch": "Description",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "30%"
                    }
                  }
                ]
              },
              "sortBy": [],
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "reco_type",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "Count",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "none"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "maximumFractionDigits": 2,
                      "maximumSignificantDigits": 3
                    }
                  }
                },
                "secondaryContent": {
                  "columnMatch": "properties_category",
                  "formatter": 1
                },
                "showBorder": false
              }
            },
            "customWidth": "100",
            "conditionalVisibility": {
              "parameterName": "cacheRecommendation",
              "comparison": "isNotEqualTo"
            },
            "name": "Advisor Cache Recommendations",
            "styleSettings": {
              "margin": "-20px 0px 0px 0px"
            }
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "paragraph",
              "links": [
                {
                  "cellValue": "{Resource}",
                  "linkTarget": "Resource",
                  "linkLabel": "Advisor recommendations page >",
                  "subTarget": "resourceadvisor",
                  "style": "link"
                }
              ]
            },
            "customWidth": "51",
            "conditionalVisibility": {
              "parameterName": "cacheRecommendation",
              "comparison": "isNotEqualTo"
            },
            "name": "advisor link",
            "styleSettings": {
              "margin": "-57px 0px 0px 14px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "<span style=\"font-family: Open Sans; font-weight: 620; font-size: 14px;font-style: bold;margin:-10px 0px 0px 0px;position: relative;top:-5px\">Table usage and cache details\r\n</span><br>This page presents data based on the Time Range parameter. You can change the Time Range parameter to present data starting from {TableLogsStartDate} (based on your oldest diagnostic logs data).\r\n</span><br>The table name and the cache policy columns refresh every 8 hours.\r\n</span><br>Notice that the queries statistics only reflect queries that scanned data. Queries that fail, or have a future time operator do not scan any data, and therefore would not be included in the queries statistics."
            },
            "name": "Header Cache"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let TableUsageStatsWithLookBack = ADXTableUsageStatistics\r\n| where TimeGenerated  {TimeRange}\r\n| extend LookBackPeriod = datetime_diff('day', StartedOn, MinCreatedOn) \r\n| summarize CountQueries=count() by DatabaseName, TableName, LookBackPeriod;\r\nlet sumAllQueries = TableUsageStatsWithLookBack | summarize sumQueries=sum(CountQueries) by DatabaseName, TableName;\r\nlet percentileLookBackTable= TableUsageStatsWithLookBack | summarize percentile_LookbackDuration_ = percentilesw(LookBackPeriod, CountQueries, 95) by DatabaseName, TableName;\r\nlet defaultRetention = 365d * 10;\r\nADXTableDetails \r\n| where TimeGenerated>=ago(1d) // so we filter out tables that are deprecated\r\n| extend table_name_join_key = iff(EntityType == \"MaterializedView\", strcat(\"_MV_\", TableName), TableName)\r\n| summarize arg_max(TimeGenerated, *) by DatabaseName, TableName\r\n| extend RetentionPolicy = iff(isnull(RetentionPolicy) or RetentionPolicy == \"null\", defaultRetention, totimespan(parse_json(tostring(RetentionPolicy)).SoftDeletePeriod)),\r\n        CachingPolicy = iff(isnull(CachingPolicy) or RetentionPolicy == \"null\", defaultRetention, totimespan(parse_json(tostring(CachingPolicy)).DataHotSpan))\r\n        | extend ActiveCachingPolicy = min_of(CachingPolicy, RetentionPolicy)\r\n| join kind = leftouter (percentileLookBackTable) on DatabaseName, $left.table_name_join_key == $right.TableName\r\n| join kind = leftouter (sumAllQueries) on DatabaseName,  $left.table_name_join_key == $right.TableName\r\n| where DatabaseName != \"KustoMonitoringPersistentDatabase\"\r\n| top 351 by HotExtentSize desc\r\n| extend clickToSeeTimechart = \"Click to see the timechart\"\r\n| extend difference = toint(format_timespan(ActiveCachingPolicy, 'd'))-percentile_LookbackDuration_\r\n| extend difference2 = iif(isnull(difference),\"nq\",iif(difference<0,\"i\",iif(difference>0,\"d\",\"e\")))\r\n| project DatabaseName, TableName, CacheSize = HotExtentSize, format_timespan(ActiveCachingPolicy, 'd'),  \r\nsumQueries=sumQueries,QueryPeriod = percentile_LookbackDuration_, difference2, clickToSeeTimechart, table_name_join_key",
              "size": 0,
              "showAnalytics": true,
              "exportedParameters": [
                {
                  "fieldName": "DatabaseName",
                  "parameterName": "DatabaseName",
                  "parameterType": 1
                },
                {
                  "fieldName": "TableName",
                  "parameterName": "TableName",
                  "parameterType": 1
                },
                {
                  "fieldName": "table_name_join_key",
                  "parameterName": "table_name_join_key",
                  "parameterType": 1
                }
              ],
              "queryType": 0,
              "resourceType": "microsoft.kusto/clusters",
              "crossComponentResources": [
                "{Resource}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "DatabaseName",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "10%"
                    }
                  },
                  {
                    "columnMatch": "TableName",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "10%"
                    }
                  },
                  {
                    "columnMatch": "CacheSize",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "palette": "blue",
                      "customColumnWidthSetting": "10%"
                    },
                    "numberFormat": {
                      "unit": 36,
                      "options": {
                        "style": "decimal",
                        "useGrouping": false
                      }
                    }
                  },
                  {
                    "columnMatch": "CachingPolicy",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "palette": "purple",
                      "customColumnWidthSetting": "10%"
                    }
                  },
                  {
                    "columnMatch": "sumQueries",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "palette": "pink",
                      "customColumnWidthSetting": "10%"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal",
                        "useGrouping": true
                      },
                      "emptyValCustomText": "0"
                    }
                  },
                  {
                    "columnMatch": "QueryPeriod",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "palette": "turquoise",
                      "customColumnWidthSetting": "30%"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal",
                        "useGrouping": false
                      },
                      "emptyValCustomText": "-"
                    }
                  },
                  {
                    "columnMatch": "difference2",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "e",
                          "representation": "Check",
                          "text": "The actual usage lookback is equal to the cache policy"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "i",
                          "representation": "trendup",
                          "text": "The actual usage lookback exceeds the cache policy"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "d",
                          "representation": "trenddown",
                          "text": "The actual usage lookback is below the cache policy"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "nq",
                          "representation": "Disable",
                          "text": "0 queries have been run on the table. Please be aware that the minimum recommended cache policy is 1 day (rather than 0, since internal data grooming operations access the extents (from the hot cache or blob storage). For example: extent rebuilding and merging, materialized views materialization, update policy operations (if the update policy uses a join with another table)."
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "success",
                          "text": "{0}{1}"
                        }
                      ],
                      "customColumnWidthSetting": "20%"
                    },
                    "tooltipFormat": {
                      "tooltip": "{0}"
                    }
                  },
                  {
                    "columnMatch": "clickToSeeTimechart",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "Diagnostics",
                          "text": "Click to see the usage histogram below the grid"
                        }
                      ],
                      "customColumnWidthSetting": "15%"
                    },
                    "tooltipFormat": {
                      "tooltip": "{0}"
                    }
                  },
                  {
                    "columnMatch": "table_name_join_key",
                    "formatter": 5
                  }
                ],
                "rowLimit": 350,
                "filter": true,
                "sortBy": [
                  {
                    "itemKey": "$gen_thresholds_difference2_6",
                    "sortOrder": 1
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "DatabaseName",
                    "label": "Database name"
                  },
                  {
                    "columnId": "TableName",
                    "label": "Table name"
                  },
                  {
                    "columnId": "CacheSize",
                    "label": "Hot cache size (hot extents)"
                  },
                  {
                    "columnId": "ActiveCachingPolicy",
                    "label": "Cache policy (days)"
                  },
                  {
                    "columnId": "sumQueries",
                    "label": "Total number of queries"
                  },
                  {
                    "columnId": "QueryPeriod",
                    "label": "Actual queries lookback period (days) (95th percentile)"
                  },
                  {
                    "columnId": "difference2",
                    "label": "Usage compared to caching policy"
                  },
                  {
                    "columnId": "clickToSeeTimechart",
                    "label": "Usage histogram"
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "$gen_thresholds_difference2_6",
                  "sortOrder": 1
                }
              ]
            },
            "name": "TableSizesGrid",
            "styleSettings": {
              "margin": "-27px 0px 0px 0px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "ðŸ’¡ Click on a row to see the usage histogram\r\n"
            },
            "conditionalVisibility": {
              "parameterName": "DatabaseName",
              "comparison": "isEqualTo"
            },
            "name": "ClickOnTheCacheGridText"
          },
          {
            "type": 1,
            "content": {
              "json": "<span style=\"font-family: Open Sans; font-weight: 620; font-size: 14px;font-style: bold;margin:-10px -304px 0px 0px;position: relative;top:-5px\">&nbsp;&nbsp;Query lookback period (x-axis) and number of queries (y-axis)\r\n</span><br>\r\n&nbsp;&nbsp;The x-axis represents the actual query lookback period. If there's a wide range of values, the x-axis might display negative values for scale purposes only. "
            },
            "conditionalVisibility": {
              "parameterName": "DatabaseName",
              "comparison": "isNotEqualTo"
            },
            "name": "cache histogram title",
            "styleSettings": {
              "margin": "10px 0px 0px 0px "
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let defaultRetention = 365d * 10;\r\nlet CachePolicyTable= ADXTableDetails \r\n| where TimeGenerated>=ago(1d)\r\n| where DatabaseName == '{DatabaseName}'  \r\n| where TableName == '{TableName}' | summarize arg_max(TimeGenerated, *) by DatabaseName, TableName\r\n| extend table_name_join_key = iff(EntityType == \"MaterializedView\", strcat(\"_MV_\", TableName), TableName)\r\n| extend RetentionPolicy = iff(isnull(RetentionPolicy) or RetentionPolicy == \"null\", defaultRetention, totimespan(parse_json(tostring(RetentionPolicy)).SoftDeletePeriod)),\r\nCachingPolicy = iff(isnull(CachingPolicy) or RetentionPolicy == \"null\", defaultRetention, totimespan(parse_json(tostring(CachingPolicy)).DataHotSpan))\r\n| extend ActiveCachingPolicy = min_of(CachingPolicy, RetentionPolicy)\r\n| project DatabaseName, table_name_join_key,activeCachePolicyInDays =ActiveCachingPolicy;\r\n\r\nADXTableUsageStatistics\r\n| where TimeGenerated  {TimeRange} \r\n| where DatabaseName == '{DatabaseName}' \r\n| where TableName == '{table_name_join_key}' \r\n| extend NumberOfDaysBefore = datetime_diff('day', StartedOn, MinCreatedOn)\r\n| summarize Count=count() by DatabaseName, TableName,NumberOfDaysBefore \r\n| join kind = leftouter (CachePolicyTable) on DatabaseName, $left.TableName == $right.table_name_join_key\r\n| extend activeCacheInDays= activeCachePolicyInDays/1d\r\n| sort by NumberOfDaysBefore asc\r\n| extend CacheType = iff(NumberOfDaysBefore <= activeCacheInDays, 'InCache', 'OutOfCache')\r\n| extend CumSum = row_cumsum(Count);",
              "size": 0,
              "showAnalytics": true,
              "noDataMessage": "There were no queries on this table",
              "exportedParameters": [
                {
                  "fieldName": "x",
                  "parameterName": "x",
                  "parameterType": 1
                },
                {
                  "fieldName": "NumberOfDaysBefore",
                  "parameterName": "NumberOfDaysBefore",
                  "parameterType": 1
                }
              ],
              "queryType": 0,
              "resourceType": "microsoft.kusto/clusters",
              "visualization": "barchart",
              "chartSettings": {
                "xAxis": "NumberOfDaysBefore",
                "yAxis": [
                  "Count"
                ],
                "group": "CacheType",
                "createOtherGroup": 100,
                "showLegend": true,
                "seriesLabelSettings": [
                  {
                    "seriesName": "InCache",
                    "label": "In Cache",
                    "color": "blue",
                    "comment": ""
                  },
                  {
                    "seriesName": "OutOfCache",
                    "label": "Out of Cache",
                    "color": "orange",
                    "comment": ""
                  }
                ],
                "xSettings": {
                  "numberFormatSettings": {
                    "unit": 27,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true
                    }
                  }
                },
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true
                    }
                  }
                }
              }
            },
            "conditionalVisibility": {
              "parameterName": "DatabaseName",
              "comparison": "isNotEqualTo"
            },
            "name": "CacheHistogram",
            "styleSettings": {
              "margin": "-30px 0px 0px 0px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "<span style=\"font-family: Open Sans; font-weight: 620; font-size: 14px;font-style: bold;margin:-10px -304px 0px 0px;position: relative;top:-5px\">&nbsp;&nbsp;Query lookback period and % of queries (tabular view)\r\n\r\n"
            },
            "conditionalVisibility": {
              "parameterName": "DatabaseName",
              "comparison": "isNotEqualTo"
            },
            "name": "Cache Header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let defaultRetention = 365d * 10;\r\n// calculation for potential cache saving (valid only for tables with steady ingestion)\r\n//let DataInCacheOneDay = toscalar(ADXTableDetails\r\n//| where DatabaseName == '{DatabaseName}' \r\n//| where TableName == '{TableName}'\r\n//| summarize arg_max(TimeGenerated, *) by '{DatabaseName}', '{TableName}'\r\n//| extend RetentionPolicy = iff(isnull(RetentionPolicy) or RetentionPolicy == \"null\", defaultRetention, totimespan(parse_json(tostring(RetentionPolicy)).SoftDeletePeriod)),CachingPolicy = iff(isnull(CachingPolicy) or RetentionPolicy == \"null\", defaultRetention, totimespan(parse_json(tostring(CachingPolicy)).DataHotSpan))\r\n//        | extend ActiveCachingPolicy = min_of(CachingPolicy, RetentionPolicy)\r\n//      | extend CacheStart = now() - ActiveCachingPolicy , CacheEnd = now() \r\n//    | extend DataInCacheStart = iff(isnull(MinExtentsCreationTime), MinExtentsCreationTime, max_of(CacheStart, MinExtentsCreationTime)), DataInCacheEnd = iff(isnull(MaxExtentsCreationTime), MaxExtentsCreationTime, min_of(CacheEnd, MaxExtentsCreationTime)) \r\n//      | extend TimespanOfDataInCache = iff(HotExtentSize == 0, time(0m), bin(DataInCacheEnd - DataInCacheStart, 1d) +1d) \r\n//| extend ActualCachingeTimeInDays = TimespanOfDataInCache/1d \r\n//| project DataInCacheSizeForOneDay = iff(ActualCachingeTimeInDays > 1, HotExtentSize/ActualCachingeTimeInDays, HotExtentSize));\r\n\r\nlet QueriesPerDaysBeforeTable = ADXTableUsageStatistics \r\n| where TimeGenerated  {TimeRange}\r\n| where DatabaseName == '{DatabaseName}' \r\n| where TableName == '{table_name_join_key}' \r\n| extend NumberOfDaysBefore = datetime_diff('day', StartedOn, MinCreatedOn)\r\n| summarize Count=count() by DatabaseName, TableName,NumberOfDaysBefore \r\n| sort by NumberOfDaysBefore asc\r\n| extend CumSum = row_cumsum(Count);\r\nlet total = toscalar(QueriesPerDaysBeforeTable | summarize max(CumSum));\r\n\r\nQueriesPerDaysBeforeTable | extend clickToSeeTimechart = \"Click to see the timechart\" | project NumberOfDaysBefore,Count, actualQueriesInCache = Count / toreal(total)*100.0, potentialQueriesInCache = CumSum / toreal(total)*100.0, clickToSeeTimechart  //, potentialCacheSize = DataInCacheOneDay*NumberOfDaysBefore;\r\n",
              "size": 0,
              "showAnalytics": true,
              "noDataMessage": "There were no queries on this table",
              "exportFieldName": "NumberOfDaysBefore",
              "exportParameterName": "LookbackPeriod",
              "queryType": 0,
              "resourceType": "microsoft.kusto/clusters",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "NumberOfDaysBefore",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "0",
                          "text": "<1 day"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "Blank",
                          "text": "{0} {1}"
                        }
                      ],
                      "customColumnWidthSetting": "20%"
                    },
                    "numberFormat": {
                      "unit": 27,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Count",
                    "formatter": 1,
                    "formatOptions": {
                      "aggregation": "Count",
                      "customColumnWidthSetting": "20%"
                    }
                  },
                  {
                    "columnMatch": "actualQueriesInCache",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "max": 100,
                      "palette": "gray",
                      "customColumnWidthSetting": "20%"
                    },
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal",
                        "useGrouping": false
                      }
                    }
                  },
                  {
                    "columnMatch": "potentialQueriesInCache",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "max": 100,
                      "palette": "gray",
                      "customColumnWidthSetting": "20%"
                    },
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal",
                        "useGrouping": false
                      }
                    }
                  },
                  {
                    "columnMatch": "clickToSeeTimechart",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "Person",
                          "text": "Click to see user details below the grid"
                        }
                      ],
                      "customColumnWidthSetting": "20%"
                    },
                    "tooltipFormat": {
                      "tooltip": "{0}"
                    }
                  },
                  {
                    "columnMatch": "potentialCacheSize",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "palette": "yellow",
                      "customColumnWidthSetting": "84.7143ch"
                    },
                    "numberFormat": {
                      "unit": 2,
                      "options": {
                        "style": "decimal",
                        "useGrouping": false
                      }
                    }
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "NumberOfDaysBefore",
                    "label": "Lookback period"
                  },
                  {
                    "columnId": "Count",
                    "label": "Number of queries"
                  },
                  {
                    "columnId": "actualQueriesInCache",
                    "label": "% of queries (not aggregated)"
                  },
                  {
                    "columnId": "potentialQueriesInCache",
                    "label": "Aggregated % of queries"
                  },
                  {
                    "columnId": "clickToSeeTimechart",
                    "label": "User details"
                  }
                ]
              },
              "sortBy": []
            },
            "conditionalVisibility": {
              "parameterName": "DatabaseName",
              "comparison": "isNotEqualTo"
            },
            "name": "Cache Details per Query Look Back Period",
            "styleSettings": {
              "margin": "-50px 0px 0px 0px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "ðŸ’¡ Click on a row on the above table to see user details "
            },
            "conditionalVisibilities": [
              {
                "parameterName": "LookbackPeriod",
                "comparison": "isEqualTo"
              },
              {
                "parameterName": "DatabaseName",
                "comparison": "isNotEqualTo"
              }
            ],
            "name": "ClickOnTheCacheLookbackGridText"
          },
          {
            "type": 1,
            "content": {
              "json": "<span style=\"font-family: Open Sans; font-weight: 620; font-size: 14px;font-style: bold;margin:-10px -304px 0px 0px;position: relative;top:-5px\">&nbsp;&nbsp;User and query count information per selected query lookback period\r\n\r\n"
            },
            "conditionalVisibility": {
              "parameterName": "LookbackPeriod",
              "comparison": "isNotEqualTo"
            },
            "name": "User Details Cache Header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let defaultRetention = 365d * 10;\r\nADXTableUsageStatistics \r\n    | where TimeGenerated  {TimeRange}\r\n    | where DatabaseName == '{DatabaseName}' \r\n    | where TableName == '{table_name_join_key}' \r\n    | extend NumberOfDaysBefore = datetime_diff('day', StartedOn, MinCreatedOn)\r\n    | where NumberOfDaysBefore == iff('{LookbackPeriod}'== \"<1\",0,tolong('{LookbackPeriod}'))\r\n    | summarize Count=count() by User, ApplicationName\r\n    | top 10 by Count\r\n",
              "size": 0,
              "showAnalytics": true,
              "noDataMessage": "There were no queries on this table",
              "queryType": 0,
              "resourceType": "microsoft.kusto/clusters",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Count",
                    "formatter": 1,
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal",
                        "useGrouping": false
                      }
                    },
                    "tooltipFormat": {
                      "tooltip": "The amount of queries the tuple of user and application ran for the selected lookbackperiod"
                    }
                  },
                  {
                    "columnMatch": "NumberOfDaysBefore",
                    "formatter": 1,
                    "formatOptions": {
                      "customColumnWidthSetting": "20ch"
                    },
                    "numberFormat": {
                      "unit": 27,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "actualQueriesInCache",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "max": 100,
                      "palette": "gray",
                      "customColumnWidthSetting": "363px"
                    },
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal",
                        "useGrouping": false
                      }
                    }
                  },
                  {
                    "columnMatch": "potentialQueriesInCache",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "max": 100,
                      "palette": "gray",
                      "customColumnWidthSetting": "599px"
                    },
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal",
                        "useGrouping": false
                      }
                    }
                  },
                  {
                    "columnMatch": "potentialCacheSize",
                    "formatter": 4,
                    "formatOptions": {
                      "palette": "yellow",
                      "customColumnWidthSetting": "84.7143ch"
                    },
                    "numberFormat": {
                      "unit": 2,
                      "options": {
                        "style": "decimal",
                        "useGrouping": false
                      }
                    }
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "Count",
                    "label": "Query count for selected lookback period"
                  }
                ]
              },
              "sortBy": []
            },
            "conditionalVisibility": {
              "parameterName": "LookbackPeriod",
              "comparison": "isNotEqualTo"
            },
            "name": "Cache User details per Query Look Back Period",
            "styleSettings": {
              "margin": "-50px 0px 0px 0px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "CacheLogs",
        "comparison": "isEqualTo",
        "value": "present"
      },
      "name": "CacheDetailsGoup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "There is no relevant log data for the selected time range</br>\r\nAdditional monitoring coverage for tables is based on platform logs (diagnostic logs).</br>If you have not activated additional monitoring, you must enable the **ADXTableDetails** and **ADXTableUsageStatistics** diagnostic settings and send them to Log Analytics. [Learn more](https://docs.microsoft.com/en-us/azure/data-explorer/using-diagnostic-logs?tabs=commands-and-queries#set-up-diagnostic-logs-for-an-azure-data-explorer-cluster)",
              "style": "upsell"
            },
            "name": "text - 0"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "paragraph",
              "links": [
                {
                  "cellValue": "{Resource}",
                  "linkTarget": "Resource",
                  "linkLabel": "Configure Logs for Monitoring >",
                  "subTarget": "diagnostics",
                  "style": "primary"
                }
              ]
            },
            "name": "On Boarding Button Tables"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "CacheLogs",
        "comparison": "isEqualTo",
        "value": "not present"
      },
      "name": "On Boarding Message Group-Tables"
    },
    {
      "type": 1,
      "content": {
        "json": "<img src=\"https://raw.githubusercontent.com/microsoft/Application-Insights-Workbooks/master/Documentation/Images/ADXClusterCacheSample.png\" alt=\"Sample image is unavailable\" style=\"width:1250px;\"/>"
      },
      "conditionalVisibility": {
        "parameterName": "CacheLogs",
        "comparison": "isEqualTo",
        "value": "not present"
      },
      "name": "sample image"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "Loading",
              "style": "info"
            },
            "name": "LoadingCacheGroup"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "CacheLogs",
        "comparison": "isEqualTo"
      },
      "name": "On Boarding Message Group-Tables - Copy"
    }
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
