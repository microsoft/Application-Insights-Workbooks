{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "9a841aa3-338a-4759-af6a-6e05f5def218",
            "version": "KqlParameterItem/1.0",
            "name": "Subscription",
            "label": "Subscriptions",
            "type": 6,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "includeAll": false,
              "showDefault": false
            },
            "defaultValue": "value::all"
          },
          {
            "id": "84d3f66b-1f8a-4bbd-ba23-bb6690fe10a3",
            "version": "KqlParameterItem/1.0",
            "name": "CurrentWorkbooksResource",
            "type": 5,
            "description": "The current IoT resource from which this workbook was opened.",
            "isRequired": true,
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "resourceTypeFilter": {
                "microsoft.devices/iothubs": true
              },
              "additionalResourceOptions": [
                "value::1"
              ],
              "showDefault": false
            },
            "defaultValue": "value::1",
            "label": "Current IoT resource"
          },
          {
            "id": "31596d7b-c0a9-448f-b3cc-a3a906cb9d48",
            "version": "KqlParameterItem/1.0",
            "name": "ResourceType",
            "type": 7,
            "isRequired": true,
            "value": "microsoft.devices/iothubs",
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "jsonData": "[\"microsoft.devices/iothubs\"]",
            "defaultValue": "value::1"
          },
          {
            "id": "f60ea0a0-3703-44ca-a59b-df0246423f41",
            "version": "KqlParameterItem/1.0",
            "name": "IoTResources",
            "label": "IoT resources",
            "type": 5,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "Resources\r\n| where type == '{ResourceType}'\r\n| order by name asc\r\n| extend Rank = row_number()\r\n| project value = id, label = name, selected = id =~ \"{CurrentWorkbooksResource}\", group = resourceGroup",
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "c30f3f07-6d01-4109-9765-70e1260768b1",
            "version": "KqlParameterItem/1.0",
            "name": "timeRange",
            "label": "Time range",
            "type": 4,
            "isRequired": true,
            "value": {
              "durationMs": 7200000
            },
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 3600000
                },
                {
                  "durationMs": 7200000
                },
                {
                  "durationMs": 14400000
                },
                {
                  "durationMs": 43200000
                },
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 172800000
                },
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 1209600000
                },
                {
                  "durationMs": 2592000000
                }
              ],
              "allowCustom": true
            }
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "{ResourceType}"
      },
      "customWidth": "0",
      "name": "fleet view parameters",
      "styleSettings": {
        "margin": "0px",
        "padding": "0px"
      }
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "nav",
        "links": [
          {
            "id": "dce88bb5-9e4a-4e39-b843-e89a951aacca",
            "cellValue": "https://forms.office.com/r/72TsdCZ8mF",
            "linkTarget": "Url",
            "linkLabel": "Give feedback",
            "preText": "ðŸ™‚",
            "postText": "",
            "style": "link"
          }
        ]
      },
      "customWidth": "15",
      "name": "give feedback",
      "styleSettings": {
        "margin": "2px 4px",
        "padding": "10px 0px 0px 0px"
      }
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "a7c83525-3069-4165-b556-d2d29378900a",
            "version": "KqlParameterItem/1.0",
            "name": "InsightsMetricsExist",
            "label": "Insights Metrics Exist",
            "type": 1,
            "description": "Checks if the InsightsMetrics table exists yet to conditionally inform visibility of other items in the workbook.",
            "query": "let hasNonEmptyTable = (T:string) \n{ \n   toscalar( union isfuzzy=true ( table(T) | count as Count ), (print Count=0) | summarize sum(Count) ) > 0\n};\nlet TableName = 'InsightsMetrics';\nprint IsPresent=iif(hasNonEmptyTable(TableName), \"yes\", \"no\")",
            "crossComponentResources": [
              "{IoTResources}"
            ],
            "isHiddenWhenLocked": true,
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "timeRange",
            "queryType": 0,
            "resourceType": "{ResourceType}"
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "{ResourceType}"
      },
      "customWidth": "0",
      "name": "onboarding instructions"
    },
    {
      "type": 1,
      "content": {
        "json": "# No metrics data from IoT Edge devices detected in the {timeRange:label}\n\n## Please on-board with instructions at **[aka.ms/edgemon-docs](https://aka.ms/edgemon-docs)**\n\n<br>\nðŸ’¡*If you've just on-boarded,  it can take up to 15 minutes for data to be displayed.*"
      },
      "conditionalVisibility": {
        "parameterName": "InsightsMetricsExist",
        "comparison": "isEqualTo",
        "value": "no"
      },
      "name": "no-metrics-data-message"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "tabs",
              "links": [
                {
                  "id": "b0791589-c9e0-414b-b095-12dec3091e9c",
                  "cellValue": "SelectedTab",
                  "linkTarget": "parameter",
                  "linkLabel": "Summary Report",
                  "subTarget": "summaryview",
                  "style": "link"
                },
                {
                  "id": "206b2787-2c53-42fd-8d0b-7d56e9c11603",
                  "cellValue": "SelectedTab",
                  "linkTarget": "parameter",
                  "linkLabel": "Settings",
                  "subTarget": "settings",
                  "style": "link"
                }
              ]
            },
            "name": "top level navigation"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "060313e0-e2a6-4cc1-98fb-70d6cdd8c198",
                  "version": "KqlParameterItem/1.0",
                  "name": "ShowTips",
                  "label": "Show Tips",
                  "type": 10,
                  "isRequired": true,
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "jsonData": "[\r\n    { \"value\" : \"false\", \"label\" : \"No\", \"selected\" : true },\r\n    { \"value\" : \"true\", \"label\" : \"Yes\" }\r\n]"
                }
              ],
              "style": "formVertical",
              "queryType": 0,
              "resourceType": "{ResourceType}"
            },
            "conditionalVisibility": {
              "parameterName": "SelectedTab",
              "comparison": "isEqualTo",
              "value": "settings"
            },
            "name": "show tip parameter",
            "styleSettings": {
              "margin": "0px 12px",
              "padding": "0px 10px"
            }
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "debf8921-313c-4d44-910e-bf15585440cd",
                  "version": "KqlParameterItem/1.0",
                  "name": "qlenThreshold",
                  "label": "Queue Length",
                  "type": 1,
                  "isRequired": true,
                  "query": "print dynamic(100);",
                  "typeSettings": {
                    "paramValidationRules": [
                      {
                        "regExp": "[^0-9]",
                        "match": false,
                        "message": "Not a positive integer"
                      }
                    ]
                  },
                  "timeContext": {
                    "durationMs": 7200000
                  },
                  "queryType": 0,
                  "resourceType": "{ResourceType}"
                },
                {
                  "id": "4e1c32f9-0aaa-4678-b745-f292e1751993",
                  "version": "KqlParameterItem/1.0",
                  "name": "hostCpuPercentThreshold",
                  "label": "CPU (%)",
                  "type": 1,
                  "isRequired": true,
                  "query": "print dynamic(80);",
                  "typeSettings": {
                    "paramValidationRules": [
                      {
                        "regExp": "[^0-9]",
                        "match": false,
                        "message": "Not a positive integer"
                      },
                      {
                        "regExp": "[1-9]0[1-9]|[1-9]{2}\\d|[2-9]\\d{2}|\\d{4,}",
                        "match": false,
                        "message": "Must be between 0 - 100"
                      }
                    ]
                  },
                  "timeContext": {
                    "durationMs": 7200000
                  },
                  "queryType": 0,
                  "resourceType": "{ResourceType}"
                },
                {
                  "id": "c4cc0d18-4fae-4639-bcf3-71ae674a7db4",
                  "version": "KqlParameterItem/1.0",
                  "name": "hostMemPercentThreshold",
                  "label": "Memory (%)",
                  "type": 1,
                  "isRequired": true,
                  "query": "print dynamic(80);",
                  "typeSettings": {
                    "paramValidationRules": [
                      {
                        "regExp": "[^0-9]",
                        "match": false,
                        "message": "Not a positive integer"
                      },
                      {
                        "regExp": "[1-9]0[1-9]|[1-9]{2}\\d|[2-9]\\d{2}|\\d{4,}",
                        "match": false,
                        "message": "Must be between 0 - 100"
                      }
                    ]
                  },
                  "timeContext": {
                    "durationMs": 7200000
                  },
                  "queryType": 0,
                  "resourceType": "{ResourceType}"
                },
                {
                  "id": "1d855e64-5e59-4595-8493-93c2aae5e625",
                  "version": "KqlParameterItem/1.0",
                  "name": "hostDiskPercentThreshold",
                  "label": "Disk (%)",
                  "type": 1,
                  "isRequired": true,
                  "query": "print dynamic(90);",
                  "typeSettings": {
                    "paramValidationRules": [
                      {
                        "regExp": "[^0-9]",
                        "match": false,
                        "message": "Not a positive integer"
                      },
                      {
                        "regExp": " [1-9]0[1-9]|[1-9]{2}\\d|[2-9]\\d{2}|\\d{4,}",
                        "match": false,
                        "message": "Must be between 0 - 100"
                      }
                    ]
                  },
                  "timeContext": {
                    "durationMs": 7200000
                  },
                  "queryType": 0,
                  "resourceType": "{ResourceType}"
                },
                {
                  "id": "7727ab38-dc51-415f-8d03-e8fb7fc3c775",
                  "version": "KqlParameterItem/1.0",
                  "name": "localMessagesSentThreshold",
                  "label": "Msgs sent (local)",
                  "type": 1,
                  "isRequired": true,
                  "query": "print dynamic(0);",
                  "typeSettings": {
                    "paramValidationRules": [
                      {
                        "regExp": "[^0-9]",
                        "match": false,
                        "message": "Not a positive integer"
                      }
                    ]
                  },
                  "timeContext": {
                    "durationMs": 7200000
                  },
                  "queryType": 0,
                  "resourceType": "{ResourceType}"
                },
                {
                  "id": "34be45f4-87ac-4df1-92a1-6959e2875ff3",
                  "version": "KqlParameterItem/1.0",
                  "name": "upstreamMessagesSentThreshold",
                  "label": "Msgs sent (upstream)",
                  "type": 1,
                  "isRequired": true,
                  "query": "print dynamic(0);",
                  "typeSettings": {
                    "paramValidationRules": [
                      {
                        "regExp": "[^0-9]",
                        "match": false,
                        "message": "Not a positive integer"
                      }
                    ]
                  },
                  "timeContext": {
                    "durationMs": 7200000
                  },
                  "queryType": 0,
                  "resourceType": "{ResourceType}"
                },
                {
                  "id": "d3501cb8-6dd6-4fdd-ab9b-954a5f937cf9",
                  "version": "KqlParameterItem/1.0",
                  "name": "firstPanicNoDataThresholdMins",
                  "label": "Warn: No data received (mins)",
                  "type": 1,
                  "isRequired": true,
                  "query": "print dynamic(30);",
                  "typeSettings": {
                    "paramValidationRules": [
                      {
                        "regExp": "[^0-9]",
                        "match": false,
                        "message": "Not a positive integer"
                      }
                    ]
                  },
                  "timeContext": {
                    "durationMs": 7200000
                  },
                  "queryType": 0,
                  "resourceType": "{ResourceType}"
                },
                {
                  "id": "66e46f1a-c337-4edc-895e-485ac1fceb70",
                  "version": "KqlParameterItem/1.0",
                  "name": "secondPanicNoDataThresholdMins",
                  "label": "Error: No data received (mins)",
                  "type": 1,
                  "isRequired": true,
                  "query": "print 120;",
                  "typeSettings": {
                    "paramValidationRules": [
                      {
                        "regExp": "[^0-9]",
                        "match": false,
                        "message": "Not a positive integer"
                      }
                    ]
                  },
                  "timeContext": {
                    "durationMs": 7200000
                  },
                  "queryType": 0,
                  "resourceType": "{ResourceType}"
                }
              ],
              "style": "formVertical",
              "queryType": 0,
              "resourceType": "{ResourceType}"
            },
            "customWidth": "25",
            "conditionalVisibility": {
              "parameterName": "SelectedTab",
              "comparison": "isEqualTo",
              "value": "settings"
            },
            "name": "threshold parameters",
            "styleSettings": {
              "margin": "0px 12px",
              "padding": "0px 12px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "**Thresholds**\r\n\r\n<p style=\"padding:0px 8px\">\r\nDevices that exceed these threshold parameters are considered _Unhealthy_.  If a device has not recently reported data within a specific warning / error window then it is marked as _Unknown_.\r\n</p>\r\n\r\n<p style=\"padding:0px 8px\">\r\nTo permanently change the default health thresholds you you need to _Edit_ this workbook.\r\n</p>\r\n\r\n<p style=\"padding:0px 8px\">\r\nUse the â†» icon that appears beside the threshold's name to reset the value to its default.\r\n</p>\r\n"
            },
            "customWidth": "30",
            "conditionalVisibility": {
              "parameterName": "SelectedTab",
              "comparison": "isEqualTo",
              "value": "settings"
            },
            "name": "health parameters tip",
            "styleSettings": {
              "margin": "0px 12px 12px 12px",
              "padding": "0px 12px"
            }
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "Use the \"IoT resources\" drop-down above to select a different IoT Resource or include multiple IoT resources.",
                    "style": "info"
                  },
                  "conditionalVisibility": {
                    "parameterName": "ShowTips",
                    "comparison": "isEqualTo",
                    "value": "true"
                  },
                  "name": "show tip - expand scope to multiple IoT Resources",
                  "styleSettings": {
                    "padding": "8px"
                  }
                },
                {
                  "type": 12,
                  "content": {
                    "version": "NotebookGroup/1.0",
                    "groupType": "editable",
                    "items": [
                      {
                        "type": 12,
                        "content": {
                          "version": "NotebookGroup/1.0",
                          "groupType": "editable",
                          "items": [
                            {
                              "type": 3,
                              "content": {
                                "version": "KqlItem/1.0",
                                "query": "// Set thresholds based on workbook parameter values.\r\nlet hostMemPercentThreshold = toint({hostMemPercentThreshold}); // 80;\r\nlet hostCpuPercentThreshold = toint({hostCpuPercentThreshold}); // 80;\r\nlet hostDiskPercentThreshold = toint({hostDiskPercentThreshold}); // 90;\r\nlet localMessagesSentThreshold = toint({localMessagesSentThreshold}); // 0;\r\nlet upstreamMessagesSentThreshold = toint({upstreamMessagesSentThreshold}); // 0;\r\nlet qlenThreshold = toint({qlenThreshold}); // 100;\r\nlet firstPanicNoDataThresholdMins = toint({firstPanicNoDataThresholdMins}); // 30;\r\nlet secondPanicNoDataThresholdMins = max_of(firstPanicNoDataThresholdMins, toint({secondPanicNoDataThresholdMins})); // 120;\r\nlet startTime = {timeRange:start};\r\nlet endTime =  {timeRange:end};\r\nlet _data = InsightsMetrics\r\n    | where TimeGenerated between (startTime .. endTime) // restrict the time window\r\n    | extend iotresource = split(_ResourceId, \"/\")[-1]\r\n    | extend device = strcat(iotresource, \"/\", extract(\"edge_device.:.([^,]+).,\", 1, Tags, typeof(string)));\r\nlet cpu_percent = _data\r\n    | where Name == \"edgeAgent_used_cpu_percent\"\r\n        and Tags contains_cs \"host\"\r\n        and Tags contains_cs \"0.99\"\r\n    | extend value = toint(Val)\r\n    | top-nested of device by Ignore0=max(1),\r\n    top-nested 3 of TimeGenerated by Ignore1=max(TimeGenerated),\r\n    top-nested of value by Ignore2=max(1)\r\n    | project-away Ignore*\r\n    | summarize p95HostCpu=max(value) by device;\r\n//\r\nlet totalMemByDevice = _data\r\n    | where Name == \"edgeAgent_total_memory_bytes\" and Tags contains_cs \"host\"\r\n    | extend value = tolong(Val)\r\n    | project device, value, TimeGenerated\r\n    | top-nested of device by Ignore0=max(1),\r\n    top-nested 3 of TimeGenerated by Ignore1=max(TimeGenerated),\r\n    top-nested of value by Ignore2=max(1)\r\n    | project-away Ignore*\r\n    | summarize total_bytes=max(value) by device;\r\n//\r\nlet memUsedPercent = _data\r\n    | where Name == \"edgeAgent_used_memory_bytes\" and Tags contains_cs \"host\"\r\n    | top-nested of device by Ignore0=max(1),\r\n    top-nested 3 of TimeGenerated by Ignore1=max(TimeGenerated),\r\n    top-nested of Val by Ignore2=max(1)\r\n    | project-away Ignore*\r\n    | extend used_bytes = tolong(Val) \r\n    | project device, used_bytes, TimeGenerated\r\n    | join kind=leftouter totalMemByDevice on $left.device == $right.device\r\n    | extend mem_used_percent = (todouble(used_bytes) / todouble(total_bytes)) * 100\r\n    | extend mem_used_percent = round(mem_used_percent, 0)\r\n    | summarize p95HostMem=max(mem_used_percent) by device;\r\n//\r\nlet cpu_and_mem = memUsedPercent\r\n    | join cpu_percent on $left.device == $right.device\r\n    | project-away device1;\r\n//\r\nlet totalBytesByDevice = _data\r\n    | where Name == \"edgeAgent_total_disk_space_bytes\"\r\n    | extend dimensions=parse_json(Tags)\r\n    | extend value = tolong(Val)\r\n    | extend diskname = tostring(dimensions.disk_name)\r\n    | extend diskfs = tostring(dimensions.disk_filesystem)\r\n    | where diskfs != \"overlay\"\r\n    | top-nested of device by Ignore0=max(1),\r\n    top-nested 3 of TimeGenerated by Ignore1=max(TimeGenerated),\r\n    top-nested of value by Ignore2=max(1),\r\n    top-nested of diskname by Ignore3=max(1)\r\n    | project-away Ignore*\r\n    | project device, diskname, value, TimeGenerated\r\n    | summarize Bytes=max(value) by device, diskname\r\n    | summarize totalBytes=sum(Bytes) by device;\r\n//\r\nlet used_disk_trend = _data\r\n    | where Name == \"edgeAgent_available_disk_space_bytes\"\r\n    | extend dimensions=parse_json(Tags)\r\n    | extend value = tolong(Val)\r\n    | extend diskname = tostring(dimensions.disk_name)\r\n    | extend diskfs = tostring(dimensions.disk_filesystem)\r\n    | where diskfs != \"overlay\"\r\n    | top-nested of device by Ignore0=max(1),\r\n    top-nested 3 of TimeGenerated by Ignore1=max(TimeGenerated),\r\n    top-nested of value by Ignore2=max(1),\r\n    top-nested of diskname by Ignore3=max(1)\r\n    | project-away Ignore*\r\n    | project device, diskname, value, TimeGenerated\r\n    | summarize Bytes=max(value) by device, diskname, TimeGenerated\r\n    | summarize availBytes=sum(Bytes) by device, TimeGenerated\r\n    | join kind=leftouter\r\n        totalBytesByDevice\r\n        on $left.device == $right.device\r\n    | extend percentUsed = round((todouble(totalBytes) - todouble(availBytes)) / todouble(totalBytes) * 100, 0)\r\n    | project TimeGenerated, device, percentUsed\r\n    | summarize p95Disk=max(percentUsed) by device;\r\n//\r\nlet cpu_mem_disk = cpu_and_mem\r\n    | join\r\n        used_disk_trend\r\n        on $left.device == $right.device\r\n    | project-away device1;\r\n//\r\nlet p95QlenByDevice = _data\r\n    | where Name == \"edgehub_queue_length\"\r\n    | extend dimensions=parse_json(Tags)\r\n    | extend ep = tostring(dimensions.endpoint)\r\n    | extend qlen = iif(Val > 0x7FFFFFFFFFFFFFFF, toreal(0), Val)\r\n    | top-nested of device by Ignore0=max(1),\r\n    top-nested 3 of TimeGenerated by Ignore1=max(TimeGenerated),\r\n    top-nested of qlen by Ignore2=max(1),\r\n    top-nested of ep by Ignore3=max(1)\r\n    | project-away Ignore*\r\n    | project device, qlen, ep, TimeGenerated\r\n    | summarize sum(qlen) by TimeGenerated, device\r\n    | summarize p95QLen = max_of(0, max(sum_qlen)) by device;\r\n//\r\nlet lastUpdateTimeByDevice = _data\r\n    | where Name == \"edgehub_gettwin_total\" or Name == \"edgeAgent_total_time_running_correctly_seconds\"\r\n    | project TimeGenerated, device\r\n    | summarize lastUpdateTime=max(TimeGenerated) by device;\r\n//\r\nlet p95QlenByDeviceAndLastUpdate = p95QlenByDevice \r\n    | join kind=rightouter lastUpdateTimeByDevice on device\r\n    | extend device=device1\r\n    | project-away device1\r\n    | extend lastUpdatedMins = tolong(datetime_diff('minute', now(), lastUpdateTime))\r\n    | project device, p95QLen, lastUpdatedMins;\r\n//\r\nlet qlenAndLastUpdate = p95QlenByDeviceAndLastUpdate\r\n    | join kind=leftouter\r\n        cpu_mem_disk\r\n        on $left.device == $right.device\r\n    | project-away device1;\r\n// Local and upstream messages\r\nlet recentMessageCount = _data\r\n    | where Name == \"edgehub_messages_sent_total\"\r\n    | project TimeGenerated, device, Val, Tags\r\n    | partition hint.strategy=native by device (\r\n        sort by device, TimeGenerated desc \r\n        | extend target = trim_start(@\"[^/]+/\", extract(\"to.:.([^,]+).,\", 1, Tags, typeof(string))) // using extract which is faster than extractjson\r\n        | extend isupstream = target has \"Upstream\"\r\n        | extend source = strcat(device, \"::\", trim_start(@\"[^/]+/\", extract(\"from.:.([^,]+).,\", 1, Tags, typeof(string))))\r\n        | extend sourceTarget = strcat(source, \"::\", target)\r\n        | summarize msgCounts = make_list(Val)\r\n            by device, source, sourceTarget, isupstream\r\n        )\r\n    | extend\r\n        diffs = series_subtract(msgCounts, array_shift_left(msgCounts, 1, toint(msgCounts[-1]))),\r\n        zeroes = repeat(0, array_length(msgCounts))\r\n    | extend diffs = array_iff(series_greater(diffs, zeroes), diffs, zeroes)\r\n    | extend latestDiff = max_of(toint(diffs[0]), 0)\r\n    | summarize recentUpstreamMessages = sumif(latestDiff, isupstream),\r\n        recentLocalMessages = sumif(latestDiff, not(isupstream))\r\n        by device;\r\n// Final join\r\nqlenAndLastUpdate\r\n| join kind=leftouter recentMessageCount \r\n    on device\r\n| project-away device1\r\n| extend healthIndicator = \r\n    iff((p95HostMem < hostMemPercentThreshold \r\n    and p95HostCpu < hostCpuPercentThreshold \r\n    and p95Disk < hostDiskPercentThreshold \r\n    and p95QLen < qlenThreshold),\r\n    iff(lastUpdatedMins < firstPanicNoDataThresholdMins, 0, 1),\r\n    2\r\n    )\r\n| extend healthIndicator = \r\n    iff(lastUpdatedMins > secondPanicNoDataThresholdMins,\r\n    1,\r\n    iff((isnull(p95HostMem) or p95HostMem < hostMemPercentThreshold) \r\n    and (isnull(p95HostCpu) or p95HostCpu < hostCpuPercentThreshold)\r\n    and (isnull(p95Disk) or p95Disk < hostDiskPercentThreshold)\r\n    and (isnull(p95QLen) or p95QLen < qlenThreshold) \r\n    and (recentLocalMessages >= localMessagesSentThreshold or localMessagesSentThreshold == 0)\r\n    and (recentUpstreamMessages >= upstreamMessagesSentThreshold or upstreamMessagesSentThreshold == 0),\r\n    0,\r\n    2\r\n    )\r\n    )\r\n| extend statusHelper = \r\n    case(\r\n    lastUpdatedMins > secondPanicNoDataThresholdMins, -2,\r\n    lastUpdatedMins > firstPanicNoDataThresholdMins, -1,\r\n    healthIndicator\r\n    )\r\n| extend healthText = \r\n    case(\r\n    statusHelper == 0, \"Healthy\",\r\n    statusHelper == 1, \"Unhealthy\",\r\n    statusHelper == 2, \"Unhealthy\",\r\n    \"Unknown\"\r\n    )\r\n| union (datatable (healthText: string) [\"Healthy\", \"Unhealthy\", \"Unknown\"])\r\n| summarize \r\n    HealthyDevices = countif(isnotempty(device) and healthText == \"Healthy\"),\r\n    UnhealthyDevices = countif(isnotempty(device) and healthText == \"Unhealthy\"),\r\n    UnknownDevices = countif(isnotempty(device) and healthText == \"Unknown\"),\r\n    Devices = countif(isnotempty(device)),\r\n    HighCPU = countif(p95HostCpu >= hostCpuPercentThreshold and healthText == \"Unhealthy\"),\r\n    HighMem = countif(p95HostMem >= hostMemPercentThreshold and healthText == \"Unhealthy\"),\r\n    HighDisk = countif(p95Disk >= hostDiskPercentThreshold and healthText == \"Unhealthy\"),\r\n    HighQLen = countif(p95QLen >= qlenThreshold and healthText == \"Unhealthy\"),\r\n    FirstPanicNoData = countif(lastUpdatedMins between (firstPanicNoDataThresholdMins .. secondPanicNoDataThresholdMins)),\r\n    SecondPanicNoData = countif(lastUpdatedMins >= secondPanicNoDataThresholdMins)\r\n| extend PctHealthyDevices = strcat(\"(\", toint(100 * HealthyDevices / Devices), \"%)\"),\r\n         PctUnhealthyDevices = strcat(\"(\", toint(100 * UnhealthyDevices / Devices), \"%)\"),\r\n         PctUnknownDevices = strcat(\"(\", toint(100 * UnknownDevices / Devices), \"%)\"),\r\n         DataLoaded = true;",
                                "size": 4,
                                "title": "Health Summary Text - Base Query",
                                "timeContext": {
                                  "durationMs": 7200000
                                },
                                "timeContextFromParameter": "timeRange",
                                "queryType": 0,
                                "resourceType": "{ResourceType}",
                                "crossComponentResources": [
                                  "{IoTResources}"
                                ],
                                "gridSettings": {
                                  "rowLimit": 5
                                }
                              },
                              "conditionalVisibility": {
                                "parameterName": "ShowHealthSummaryBaseQuery",
                                "comparison": "isEqualTo",
                                "value": "true"
                              },
                              "name": "health summary text - base query"
                            },
                            {
                              "type": 9,
                              "content": {
                                "version": "KqlParameterItem/1.0",
                                "parameters": [
                                  {
                                    "id": "ee9868ed-a8f5-44a2-b205-1a8fd7f97af8",
                                    "version": "KqlParameterItem/1.0",
                                    "name": "NumDevicesHighQLen",
                                    "type": 1,
                                    "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"4dce97cd-216c-49c7-ac15-4eaf8e80a1a6\",\"mergeType\":\"table\",\"leftTable\":\"health summary text - base query\"}],\"projectRename\":[{\"originalName\":\"[health summary text - base query].HighQLen\",\"mergedName\":\"HighQLen\",\"fromId\":\"4dce97cd-216c-49c7-ac15-4eaf8e80a1a6\"},{\"originalName\":\"[health summary text - base query].Devices\"},{\"originalName\":\"[health summary text - base query].HighCPU\"},{\"originalName\":\"[health summary text - base query].HighMem\"},{\"originalName\":\"[health summary text - base query].HighDisk\"},{\"originalName\":\"[health summary text - base query].FirstPanicNoData\"},{\"originalName\":\"[health summary text - base query].SecondPanicNoData\"}]}",
                                    "isHiddenWhenLocked": true,
                                    "timeContext": {
                                      "durationMs": 7200000
                                    },
                                    "queryType": 7
                                  },
                                  {
                                    "id": "8e775c50-ee8c-4108-ba2b-781deda70177",
                                    "version": "KqlParameterItem/1.0",
                                    "name": "NumDevicesHighCPU",
                                    "type": 1,
                                    "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"4dce97cd-216c-49c7-ac15-4eaf8e80a196\",\"mergeType\":\"table\",\"leftTable\":\"health summary text - base query\"}],\"projectRename\":[{\"originalName\":\"[health summary text - base query].HighCPU\",\"mergedName\":\"HighCPU\",\"fromId\":\"4dce97cd-216c-49c7-ac15-4eaf8e80a196\"},{\"originalName\":\"[health summary text - base query].Devices\"},{\"originalName\":\"[health summary text - base query].HighMem\"},{\"originalName\":\"[health summary text - base query].HighDisk\"},{\"originalName\":\"[health summary text - base query].HighQLen\"},{\"originalName\":\"[health summary text - base query].FirstPanicNoData\"},{\"originalName\":\"[health summary text - base query].SecondPanicNoData\"}]}",
                                    "isHiddenWhenLocked": true,
                                    "timeContext": {
                                      "durationMs": 7200000
                                    },
                                    "queryType": 7
                                  },
                                  {
                                    "id": "6ebf7ab9-f90f-4173-bbfe-8c1c5c7657e9",
                                    "version": "KqlParameterItem/1.0",
                                    "name": "NumDevicesHighMem",
                                    "type": 1,
                                    "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"4dce97cd-216c-49c7-ac15-4eaf8e80a19e\",\"mergeType\":\"table\",\"leftTable\":\"health summary text - base query\"}],\"projectRename\":[{\"originalName\":\"[health summary text - base query].HighMem\",\"mergedName\":\"HighMem\",\"fromId\":\"4dce97cd-216c-49c7-ac15-4eaf8e80a19e\"},{\"originalName\":\"[health summary text - base query].Devices\"},{\"originalName\":\"[health summary text - base query].HighCPU\"},{\"originalName\":\"[health summary text - base query].HighDisk\"},{\"originalName\":\"[health summary text - base query].HighQLen\"},{\"originalName\":\"[health summary text - base query].FirstPanicNoData\"},{\"originalName\":\"[health summary text - base query].SecondPanicNoData\"}]}",
                                    "isHiddenWhenLocked": true,
                                    "timeContext": {
                                      "durationMs": 7200000
                                    },
                                    "queryType": 7
                                  },
                                  {
                                    "id": "9cd1e965-32fb-48e1-a8d7-2b715b69b0d7",
                                    "version": "KqlParameterItem/1.0",
                                    "name": "NumDevicesHighDisk",
                                    "type": 1,
                                    "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"4dce97cd-216c-49c7-ac15-4eaf8e80a1a0\",\"mergeType\":\"table\",\"leftTable\":\"health summary text - base query\"}],\"projectRename\":[{\"originalName\":\"[health summary text - base query].HighDisk\",\"mergedName\":\"HighDisk\",\"fromId\":\"4dce97cd-216c-49c7-ac15-4eaf8e80a1a0\"},{\"originalName\":\"[health summary text - base query].Devices\"},{\"originalName\":\"[health summary text - base query].HighCPU\"},{\"originalName\":\"[health summary text - base query].HighMem\"},{\"originalName\":\"[health summary text - base query].HighQLen\"},{\"originalName\":\"[health summary text - base query].FirstPanicNoData\"},{\"originalName\":\"[health summary text - base query].SecondPanicNoData\"}]}",
                                    "isHiddenWhenLocked": true,
                                    "timeContext": {
                                      "durationMs": 7200000
                                    },
                                    "queryType": 7
                                  },
                                  {
                                    "id": "d4492440-1a06-493b-9d75-c23264ab2ee6",
                                    "version": "KqlParameterItem/1.0",
                                    "name": "NumDevicesFirstPanicNoData",
                                    "type": 1,
                                    "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"4dce97cd-216c-49c7-ac15-4eaf8e80a1a2\",\"mergeType\":\"table\",\"leftTable\":\"health summary text - base query\"}],\"projectRename\":[{\"originalName\":\"[health summary text - base query].FirstPanicNoData\",\"mergedName\":\"FirstPanicNoData\",\"fromId\":\"4dce97cd-216c-49c7-ac15-4eaf8e80a1a2\"},{\"originalName\":\"[health summary text - base query].Devices\"},{\"originalName\":\"[health summary text - base query].HighCPU\"},{\"originalName\":\"[health summary text - base query].HighMem\"},{\"originalName\":\"[health summary text - base query].HighDisk\"},{\"originalName\":\"[health summary text - base query].HighQLen\"},{\"originalName\":\"[health summary text - base query].SecondPanicNoData\"}]}",
                                    "isHiddenWhenLocked": true,
                                    "timeContext": {
                                      "durationMs": 7200000
                                    },
                                    "queryType": 7
                                  },
                                  {
                                    "id": "8dbb3665-31ad-45fa-90fa-eec6d98916cf",
                                    "version": "KqlParameterItem/1.0",
                                    "name": "NumDevicesSecondPanicNoData",
                                    "type": 1,
                                    "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"4dce97cd-216c-49c7-ac15-4eaf8e80a1a4\",\"mergeType\":\"table\",\"leftTable\":\"health summary text - base query\"}],\"projectRename\":[{\"originalName\":\"[health summary text - base query].SecondPanicNoData\",\"mergedName\":\"SecondPanicNoData\",\"fromId\":\"4dce97cd-216c-49c7-ac15-4eaf8e80a1a4\"},{\"originalName\":\"[health summary text - base query].HighMem\"},{\"originalName\":\"[health summary text - base query].HighDisk\"},{\"originalName\":\"[health summary text - base query].Devices\"},{\"originalName\":\"[health summary text - base query].HighCPU\"},{\"originalName\":\"[health summary text - base query].HighQLen\"},{\"originalName\":\"[health summary text - base query].FirstPanicNoData\"}]}",
                                    "isHiddenWhenLocked": true,
                                    "timeContext": {
                                      "durationMs": 7200000
                                    },
                                    "queryType": 7
                                  },
                                  {
                                    "id": "d53d6df0-c3d9-4a59-8bf3-42905ba21f07",
                                    "version": "KqlParameterItem/1.0",
                                    "name": "NumDevices",
                                    "type": 1,
                                    "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"26daab96-de47-4f7f-91d5-20b75e019073\",\"mergeType\":\"table\",\"leftTable\":\"health summary text - base query\"}],\"projectRename\":[{\"originalName\":\"[health summary text - base query].Devices\",\"mergedName\":\"Devices\",\"fromId\":\"26daab96-de47-4f7f-91d5-20b75e019073\"},{\"originalName\":\"[health summary text - base query].HealthyDevices\"},{\"originalName\":\"[health summary text - base query].UnhealthyDevices\"},{\"originalName\":\"[health summary text - base query].UnknownDevices\"},{\"originalName\":\"[health summary text - base query].HighCPU\"},{\"originalName\":\"[health summary text - base query].HighMem\"},{\"originalName\":\"[health summary text - base query].HighDisk\"},{\"originalName\":\"[health summary text - base query].HighQLen\"},{\"originalName\":\"[health summary text - base query].FirstPanicNoData\"},{\"originalName\":\"[health summary text - base query].SecondPanicNoData\"},{\"originalName\":\"[health summary text - base query].PctHealthyDevices\"},{\"originalName\":\"[health summary text - base query].PctUnhealthyDevices\"},{\"originalName\":\"[health summary text - base query].PctUnknownDevices\"}]}",
                                    "isHiddenWhenLocked": true,
                                    "queryType": 7
                                  },
                                  {
                                    "id": "04e76e86-4495-400b-a4f9-a765c3cbed73",
                                    "version": "KqlParameterItem/1.0",
                                    "name": "DataLoaded",
                                    "type": 1,
                                    "isRequired": true,
                                    "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"26daab96-de47-4f7f-91d5-20b75e019179\",\"mergeType\":\"table\",\"leftTable\":\"health summary text - base query\"}],\"projectRename\":[{\"originalName\":\"[health summary text - base query].DataLoaded\",\"mergedName\":\"DataLoaded\",\"fromId\":\"26daab96-de47-4f7f-91d5-20b75e019179\"},{\"originalName\":\"[health summary text - base query].HealthyDevices\"},{\"originalName\":\"[health summary text - base query].UnhealthyDevices\"},{\"originalName\":\"[health summary text - base query].UnknownDevices\"},{\"originalName\":\"[health summary text - base query].Devices\"},{\"originalName\":\"[health summary text - base query].HighCPU\"},{\"originalName\":\"[health summary text - base query].HighMem\"},{\"originalName\":\"[health summary text - base query].HighDisk\"},{\"originalName\":\"[health summary text - base query].HighQLen\"},{\"originalName\":\"[health summary text - base query].FirstPanicNoData\"},{\"originalName\":\"[health summary text - base query].SecondPanicNoData\"},{\"originalName\":\"[health summary text - base query].PctHealthyDevices\"},{\"originalName\":\"[health summary text - base query].PctUnhealthyDevices\"},{\"originalName\":\"[health summary text - base query].PctUnknownDevices\"}]}",
                                    "isHiddenWhenLocked": true,
                                    "queryType": 7
                                  }
                                ],
                                "style": "pills",
                                "queryType": 7
                              },
                              "name": "Health Summary Text Parameters"
                            },
                            {
                              "type": 1,
                              "content": {
                                "json": "#### Loading...",
                                "style": "info"
                              },
                              "conditionalVisibility": {
                                "parameterName": "DataLoaded",
                                "comparison": "isNotEqualTo",
                                "value": "true"
                              },
                              "name": "loading text"
                            },
                            {
                              "type": 3,
                              "content": {
                                "version": "KqlItem/1.0",
                                "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"26daab96-de47-4f7f-91d5-20b75e0190c4\",\"mergeType\":\"table\",\"leftTable\":\"health summary text - base query\"}],\"projectRename\":[{\"originalName\":\"[health summary text - base query].UnhealthyDevices\",\"mergedName\":\"UnhealthyDevices\",\"fromId\":\"26daab96-de47-4f7f-91d5-20b75e0190c4\"},{\"originalName\":\"[health summary text - base query].Devices\",\"mergedName\":\"Devices\",\"fromId\":\"26daab96-de47-4f7f-91d5-20b75e0190c4\"},{\"originalName\":\"[health summary text - base query].PctUnhealthyDevices\",\"mergedName\":\"PctUnhealthyDevices\",\"fromId\":\"26daab96-de47-4f7f-91d5-20b75e0190c4\"},{\"originalName\":\"[health summary text - base query].DataLoaded\",\"mergedName\":\"DataLoaded\",\"fromId\":\"unknown\"},{\"originalName\":\"[health summary text - base query].HealthyDevices\"},{\"originalName\":\"[health summary text - base query].UnknownDevices\"},{\"originalName\":\"[health summary text - base query].HighCPU\"},{\"originalName\":\"[health summary text - base query].HighMem\"},{\"originalName\":\"[health summary text - base query].HighDisk\"},{\"originalName\":\"[health summary text - base query].HighQLen\"},{\"originalName\":\"[health summary text - base query].FirstPanicNoData\"},{\"originalName\":\"[health summary text - base query].SecondPanicNoData\"},{\"originalName\":\"[health summary text - base query].PctHealthyDevices\"},{\"originalName\":\"[health summary text - base query].PctUnknownDevices\"}]}",
                                "size": 3,
                                "queryType": 7,
                                "visualization": "tiles",
                                "tileSettings": {
                                  "titleContent": {
                                    "formatter": 22,
                                    "formatOptions": {
                                      "compositeBarSettings": {
                                        "labelText": "Unhealthy",
                                        "columnSettings": []
                                      }
                                    }
                                  },
                                  "subtitleContent": {
                                    "columnMatch": "PctUnhealthyDevices",
                                    "formatter": 1
                                  },
                                  "rightContent": {
                                    "columnMatch": "UnhealthyDevices",
                                    "formatter": 12,
                                    "formatOptions": {
                                      "palette": "none"
                                    }
                                  },
                                  "secondaryContent": {
                                    "columnMatch": "UnhealthyDevices",
                                    "formatter": 18,
                                    "formatOptions": {
                                      "thresholdsOptions": "colors",
                                      "thresholdsGrid": [
                                        {
                                          "operator": "Default",
                                          "thresholdValue": null,
                                          "representation": "redBright",
                                          "text": ""
                                        }
                                      ]
                                    }
                                  },
                                  "showBorder": true
                                }
                              },
                              "customWidth": "0",
                              "showPin": false,
                              "name": "unhealthy devices tiles",
                              "styleSettings": {
                                "maxWidth": "33"
                              }
                            },
                            {
                              "type": 3,
                              "content": {
                                "version": "KqlItem/1.0",
                                "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"26daab96-de47-4f7f-91d5-20b75e0190b9\",\"mergeType\":\"table\",\"leftTable\":\"health summary text - base query\"}],\"projectRename\":[{\"originalName\":\"[health summary text - base query].HealthyDevices\",\"mergedName\":\"HealthyDevices\",\"fromId\":\"26daab96-de47-4f7f-91d5-20b75e0190b9\"},{\"originalName\":\"[health summary text - base query].Devices\",\"mergedName\":\"Devices\",\"fromId\":\"26daab96-de47-4f7f-91d5-20b75e0190b9\"},{\"originalName\":\"[health summary text - base query].PctHealthyDevices\",\"mergedName\":\"PctHealthyDevices\",\"fromId\":\"26daab96-de47-4f7f-91d5-20b75e0190b9\"},{\"originalName\":\"[health summary text - base query].DataLoaded\",\"mergedName\":\"DataLoaded\",\"fromId\":\"unknown\"},{\"originalName\":\"[health summary text - base query].UnhealthyDevices\"},{\"originalName\":\"[health summary text - base query].UnknownDevices\"},{\"originalName\":\"[health summary text - base query].HighCPU\"},{\"originalName\":\"[health summary text - base query].HighMem\"},{\"originalName\":\"[health summary text - base query].HighDisk\"},{\"originalName\":\"[health summary text - base query].HighQLen\"},{\"originalName\":\"[health summary text - base query].FirstPanicNoData\"},{\"originalName\":\"[health summary text - base query].SecondPanicNoData\"},{\"originalName\":\"[health summary text - base query].PctUnhealthyDevices\"},{\"originalName\":\"[health summary text - base query].PctUnknownDevices\"}]}",
                                "size": 3,
                                "queryType": 7,
                                "visualization": "tiles",
                                "tileSettings": {
                                  "titleContent": {
                                    "formatter": 22,
                                    "formatOptions": {
                                      "compositeBarSettings": {
                                        "labelText": "Healthy",
                                        "columnSettings": []
                                      }
                                    }
                                  },
                                  "subtitleContent": {
                                    "columnMatch": "PctHealthyDevices",
                                    "formatter": 1
                                  },
                                  "rightContent": {
                                    "columnMatch": "HealthyDevices",
                                    "formatter": 12,
                                    "formatOptions": {
                                      "palette": "none"
                                    }
                                  },
                                  "secondaryContent": {
                                    "columnMatch": "HealthyDevices",
                                    "formatter": 18,
                                    "formatOptions": {
                                      "thresholdsOptions": "colors",
                                      "thresholdsGrid": [
                                        {
                                          "operator": "Default",
                                          "thresholdValue": null,
                                          "representation": "green",
                                          "text": ""
                                        }
                                      ]
                                    }
                                  },
                                  "showBorder": true
                                },
                                "chartSettings": {
                                  "yAxis": [
                                    "HealthyDevices"
                                  ],
                                  "seriesLabelSettings": [
                                    {
                                      "seriesName": "(0%)",
                                      "color": "green"
                                    }
                                  ],
                                  "ySettings": {
                                    "numberFormatSettings": {
                                      "unit": 0,
                                      "options": {
                                        "style": "decimal",
                                        "useGrouping": true
                                      }
                                    }
                                  }
                                }
                              },
                              "customWidth": "0",
                              "showPin": false,
                              "name": "healthy devices tile",
                              "styleSettings": {
                                "maxWidth": "34%"
                              }
                            },
                            {
                              "type": 3,
                              "content": {
                                "version": "KqlItem/1.0",
                                "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"26daab96-de47-4f7f-91d5-20b75e0190cb\",\"mergeType\":\"table\",\"leftTable\":\"health summary text - base query\"}],\"projectRename\":[{\"originalName\":\"[health summary text - base query].UnknownDevices\",\"mergedName\":\"UnknownDevices\",\"fromId\":\"26daab96-de47-4f7f-91d5-20b75e0190cb\"},{\"originalName\":\"[health summary text - base query].Devices\",\"mergedName\":\"Devices\",\"fromId\":\"26daab96-de47-4f7f-91d5-20b75e0190cb\"},{\"originalName\":\"[health summary text - base query].PctUnknownDevices\",\"mergedName\":\"PctUnknownDevices\",\"fromId\":\"26daab96-de47-4f7f-91d5-20b75e0190cb\"},{\"originalName\":\"[health summary text - base query].DataLoaded\",\"mergedName\":\"DataLoaded\",\"fromId\":\"unknown\"},{\"originalName\":\"[health summary text - base query].HealthyDevices\"},{\"originalName\":\"[health summary text - base query].UnhealthyDevices\"},{\"originalName\":\"[health summary text - base query].HighCPU\"},{\"originalName\":\"[health summary text - base query].HighMem\"},{\"originalName\":\"[health summary text - base query].HighDisk\"},{\"originalName\":\"[health summary text - base query].HighQLen\"},{\"originalName\":\"[health summary text - base query].FirstPanicNoData\"},{\"originalName\":\"[health summary text - base query].SecondPanicNoData\"},{\"originalName\":\"[health summary text - base query].PctHealthyDevices\"},{\"originalName\":\"[health summary text - base query].PctUnhealthyDevices\"}]}",
                                "size": 3,
                                "queryType": 7,
                                "visualization": "tiles",
                                "tileSettings": {
                                  "titleContent": {
                                    "formatter": 22,
                                    "formatOptions": {
                                      "compositeBarSettings": {
                                        "labelText": "Unknown",
                                        "columnSettings": []
                                      }
                                    }
                                  },
                                  "subtitleContent": {
                                    "columnMatch": "PctUnknownDevices",
                                    "formatter": 1
                                  },
                                  "rightContent": {
                                    "columnMatch": "UnknownDevices",
                                    "formatter": 12,
                                    "formatOptions": {
                                      "palette": "none"
                                    }
                                  },
                                  "secondaryContent": {
                                    "columnMatch": "UnknownDevices",
                                    "formatter": 18,
                                    "formatOptions": {
                                      "thresholdsOptions": "colors",
                                      "thresholdsGrid": [
                                        {
                                          "operator": "Default",
                                          "thresholdValue": null,
                                          "representation": "gray",
                                          "text": ""
                                        }
                                      ]
                                    }
                                  },
                                  "showBorder": true
                                }
                              },
                              "customWidth": "0",
                              "showPin": false,
                              "name": "unknown devices tile",
                              "styleSettings": {
                                "maxWidth": "33"
                              }
                            },
                            {
                              "type": 12,
                              "content": {
                                "version": "NotebookGroup/1.0",
                                "groupType": "editable",
                                "loadType": "always",
                                "items": [
                                  {
                                    "type": 1,
                                    "content": {
                                      "json": "** {NumDevicesHighQLen} ** device(s) reporting **high queue length** (>= {qlenThreshold})"
                                    },
                                    "conditionalVisibility": {
                                      "parameterName": "NumDevicesHighQLen",
                                      "comparison": "isNotEqualTo",
                                      "value": ""
                                    },
                                    "name": "high Q length summary"
                                  },
                                  {
                                    "type": 1,
                                    "content": {
                                      "json": "** {NumDevicesHighCPU} ** device(s) reporting **high CPU usage** (>= {hostCpuPercentThreshold}%)"
                                    },
                                    "conditionalVisibility": {
                                      "parameterName": "NumDevicesHighCPU",
                                      "comparison": "isNotEqualTo",
                                      "value": null
                                    },
                                    "name": "high CPU summary"
                                  },
                                  {
                                    "type": 1,
                                    "content": {
                                      "json": "** {NumDevicesHighMem} ** device(s) reporting **high memory usage** (>= {hostMemPercentThreshold}%)"
                                    },
                                    "conditionalVisibility": {
                                      "parameterName": "NumDevicesHighMem",
                                      "comparison": "isNotEqualTo",
                                      "value": null
                                    },
                                    "name": "high memory summary"
                                  },
                                  {
                                    "type": 1,
                                    "content": {
                                      "json": "** {NumDevicesHighDisk} ** device(s) reporting **high disk usage** (>= {hostDiskPercentThreshold}%)"
                                    },
                                    "conditionalVisibility": {
                                      "parameterName": "NumDevicesHighDisk",
                                      "comparison": "isNotEqualTo",
                                      "value": null
                                    },
                                    "name": "high disk summary"
                                  },
                                  {
                                    "type": 1,
                                    "content": {
                                      "json": "** {NumDevicesFirstPanicNoData} ** devices **have not been seen in over {firstPanicNoDataThresholdMins} mins** (warning)"
                                    },
                                    "conditionalVisibility": {
                                      "parameterName": "NumDevicesFirstPanicNoData",
                                      "comparison": "isNotEqualTo",
                                      "value": null
                                    },
                                    "name": "first panic summary"
                                  },
                                  {
                                    "type": 1,
                                    "content": {
                                      "json": "** {NumDevicesSecondPanicNoData} ** devices **have not been seen in over {secondPanicNoDataThresholdMins} mins**"
                                    },
                                    "conditionalVisibility": {
                                      "parameterName": "NumDevicesSecondPanicNoData",
                                      "comparison": "isNotEqualTo",
                                      "value": null
                                    },
                                    "name": "second panic summary"
                                  },
                                  {
                                    "type": 1,
                                    "content": {
                                      "json": "All devices appear to be healthy!"
                                    },
                                    "conditionalVisibilities": [
                                      {
                                        "parameterName": "NumDevicesHighQLen",
                                        "comparison": "isEqualTo"
                                      },
                                      {
                                        "parameterName": "NumDevicesHighCPU",
                                        "comparison": "isEqualTo"
                                      },
                                      {
                                        "parameterName": "NumDevicesHighMem",
                                        "comparison": "isEqualTo"
                                      },
                                      {
                                        "parameterName": "NumDevicesHighDisk",
                                        "comparison": "isEqualTo"
                                      },
                                      {
                                        "parameterName": "NumDevicesFirstPanicNoData",
                                        "comparison": "isEqualTo"
                                      },
                                      {
                                        "parameterName": "NumDevicesSecondPanicNoData",
                                        "comparison": "isEqualTo"
                                      },
                                      {
                                        "parameterName": "NumDevices",
                                        "comparison": "isNotEqualTo"
                                      }
                                    ],
                                    "name": "all OK"
                                  }
                                ]
                              },
                              "customWidth": "0",
                              "conditionalVisibilities": [
                                {
                                  "parameterName": "NumDevices",
                                  "comparison": "isNotEqualTo"
                                },
                                {
                                  "parameterName": "DataLoaded",
                                  "comparison": "isEqualTo",
                                  "value": "true"
                                }
                              ],
                              "name": "text summaries",
                              "styleSettings": {
                                "margin": "0px 8px 8px 8px",
                                "padding": "16px 8px 0px 8px"
                              }
                            }
                          ]
                        },
                        "customWidth": "0",
                        "name": "fleet summary text",
                        "styleSettings": {
                          "margin": "0px",
                          "padding": "0px"
                        }
                      }
                    ]
                  },
                  "name": "fleet summary group"
                },
                {
                  "type": 12,
                  "content": {
                    "version": "NotebookGroup/1.0",
                    "groupType": "editable",
                    "loadType": "explicit",
                    "loadButtonText": "Details",
                    "items": [
                      {
                        "type": 12,
                        "content": {
                          "version": "NotebookGroup/1.0",
                          "groupType": "editable",
                          "items": [
                            {
                              "type": 9,
                              "content": {
                                "version": "KqlParameterItem/1.0",
                                "parameters": [
                                  {
                                    "id": "26af5775-3dba-4947-b12b-f1356a3ee67d",
                                    "version": "KqlParameterItem/1.0",
                                    "name": "healthStatus",
                                    "label": "Health Status",
                                    "type": 2,
                                    "isRequired": true,
                                    "multiSelect": true,
                                    "quote": "'",
                                    "delimiter": ",",
                                    "typeSettings": {
                                        "additionalResourceOptions": [
                                            "value::all"
                                        ],
                                      "showDefault": false
                                    },
                                    "jsonData": "[\r\n    { \"value\" : \"Healthy\", \"label\" : \"Healthy\" },\r\n    { \"value\" : \"Unhealthy\", \"label\" : \"Unhealthy\" },\r\n    { \"value\" : \"Unknown\", \"label\" : \"Unknown\" }\r\n]",
                                    "timeContext": {
                                      "durationMs": 7200000
                                    },
                                    "defaultValue": "value::all"
                                  },
                                  {
                                    "id": "a4fe1e43-0c9e-4368-82a0-6800438bca8e",
                                    "version": "KqlParameterItem/1.0",
                                    "name": "minLastSeen",
                                    "label": "Last seen >= (mins)",
                                    "type": 2,
                                    "isRequired": true,
                                    "typeSettings": {
                                      "additionalResourceOptions": [],
                                      "showDefault": false
                                    },
                                    "jsonData": "[\r\n    { \"value\" : \"0\", \"label\" : \"Any\", \"selected\" : true },\r\n    { \"value\" : \"1\", \"label\" : \"1 min\" },\r\n    { \"value\" : 5, \"label\" : \"5 mins\" },\r\n    { \"value\" : 60, \"label\" : \"1 hr\" },\r\n    { \"value\" : 120, \"label\" : \"2 hrs\" },\r\n    { \"value\" : 240, \"label\" : \"4 hrs\" },\r\n    { \"value\" : 480, \"label\" : \"8 hrs\" },\r\n    { \"value\" : 1440, \"label\" : \"1 day\" },\r\n    { \"value\" : 2880, \"label\" : \"2 days\" },\r\n    { \"value\" : 10080, \"label\" : \"1 week\" }\r\n]",
                                    "timeContext": {
                                      "durationMs": 7200000
                                    }
                                  },
                                  {
                                    "id": "eb232a4c-f8b6-4734-92f4-ac2e5e1bb096",
                                    "version": "KqlParameterItem/1.0",
                                    "name": "minQLen",
                                    "label": "Queue Length >= (#)",
                                    "type": 1,
                                    "isRequired": true,
                                    "query": "print dynamic(0);",
                                    "typeSettings": {
                                      "paramValidationRules": [
                                        {
                                          "regExp": "[^0-9]",
                                          "match": false,
                                          "message": "Not a positive integer"
                                        }
                                      ]
                                    },
                                    "timeContext": {
                                      "durationMs": 7200000
                                    },
                                    "queryType": 0,
                                    "resourceType": "{ResourceType}"
                                  },
                                  {
                                    "id": "60ffd2b5-3c70-4dff-9690-645879a77a3d",
                                    "version": "KqlParameterItem/1.0",
                                    "name": "minCpu",
                                    "label": "CPU >= (%)",
                                    "type": 1,
                                    "isRequired": true,
                                    "query": "print dynamic(0);",
                                    "typeSettings": {
                                      "paramValidationRules": [
                                        {
                                          "regExp": "[^0-9]",
                                          "match": false,
                                          "message": "Not a positive integer"
                                        },
                                        {
                                          "regExp": "[1-9]0[1-9]|[1-9]{2}\\d|[2-9]\\d{2}|\\d{4,}",
                                          "match": false,
                                          "message": "Must be between 0 - 100"
                                        }
                                      ]
                                    },
                                    "timeContext": {
                                      "durationMs": 7200000
                                    },
                                    "queryType": 0,
                                    "resourceType": "{ResourceType}"
                                  },
                                  {
                                    "id": "03f75ae1-0f94-45d4-985b-cb518303f184",
                                    "version": "KqlParameterItem/1.0",
                                    "name": "minMem",
                                    "label": "Memory >= (%)",
                                    "type": 1,
                                    "isRequired": true,
                                    "query": "print dynamic(0);",
                                    "typeSettings": {
                                      "paramValidationRules": [
                                        {
                                          "regExp": "[^0-9]",
                                          "match": false,
                                          "message": "Not a positive integer"
                                        },
                                        {
                                          "regExp": "[1-9]0[1-9]|[1-9]{2}\\d|[2-9]\\d{2}|\\d{4,}",
                                          "match": false,
                                          "message": "Must be between 0 - 100"
                                        }
                                      ]
                                    },
                                    "timeContext": {
                                      "durationMs": 7200000
                                    },
                                    "queryType": 0,
                                    "resourceType": "{ResourceType}"
                                  },
                                  {
                                    "id": "6dbef618-2d8c-401e-840b-17683610312d",
                                    "version": "KqlParameterItem/1.0",
                                    "name": "minDisk",
                                    "label": "Disk >= (%)",
                                    "type": 1,
                                    "isRequired": true,
                                    "query": "print dynamic(0);",
                                    "typeSettings": {
                                      "paramValidationRules": [
                                        {
                                          "regExp": "[^0-9]",
                                          "match": false,
                                          "message": "Not a positive integer"
                                        },
                                        {
                                          "regExp": "[1-9]0[1-9]|[1-9]{2}\\d|[2-9]\\d{2}|\\d{4,}",
                                          "match": false,
                                          "message": "Must be between 0 - 100"
                                        }
                                      ]
                                    },
                                    "timeContext": {
                                      "durationMs": 7200000
                                    },
                                    "queryType": 0,
                                    "resourceType": "{ResourceType}"
                                  }
                                ],
                                "style": "above",
                                "queryType": 0,
                                "resourceType": "{ResourceType}"
                              },
                              "name": "Datatable Filters",
                              "styleSettings": {
                                "margin": "0px 0px 0px 0px"
                              }
                            }
                          ],
                          "exportParameters": true
                        },
                        "name": "filter group",
                        "styleSettings": {
                          "margin": "0px 0px 0px 12px",
                          "padding": "0px 0px 0px 0px"
                        }
                      },
                      {
                        "type": 1,
                        "content": {
                          "json": "Click the device _Name_ to see device details.  Click the device _Status_ to see a snapshot of health metrics.\r\n\r\nWhen a device is _Unhealthy_ an arrow icon will appear beside the number in each column that has surpassed its expected threshold value.\r\n",
                          "style": "info"
                        },
                        "conditionalVisibilities": [
                          {
                            "parameterName": "ShowTips",
                            "comparison": "isEqualTo",
                            "value": "true"
                          },
                          {
                            "parameterName": "InsightsMetricsExist",
                            "comparison": "isEqualTo",
                            "value": "yes"
                          }
                        ],
                        "name": "device-list-main-tip",
                        "styleSettings": {
                          "padding": "12px 0px 0px 0px"
                        }
                      },
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "// Set thresholds based on workbook parameter values.\nlet hostMemPercentThreshold = toint({hostMemPercentThreshold}); // 80;\nlet hostCpuPercentThreshold = toint({hostCpuPercentThreshold}); // 80;\nlet hostDiskPercentThreshold = toint({hostDiskPercentThreshold}); // 90;\nlet localMessagesSentThreshold = toint({localMessagesSentThreshold}); // 0;\nlet upstreamMessagesSentThreshold = toint({upstreamMessagesSentThreshold}); // 0;\nlet qlenThreshold = toint({qlenThreshold}); // 100;\nlet firstPanicNoDataThresholdMins = toint({firstPanicNoDataThresholdMins}); // 30;\nlet secondPanicNoDataThresholdMins = max_of(firstPanicNoDataThresholdMins, toint({secondPanicNoDataThresholdMins})); // 120;\nlet startTime = {timeRange:start};\nlet endTime =  {timeRange:end};\n//query\nlet _data = InsightsMetrics\n    | where TimeGenerated between (startTime .. endTime) // restrict the time window\n    | extend iotresource = split(_ResourceId, \"/\")[-1]\n    | extend device = strcat(iotresource, \"/\", extract(\"edge_device.:.([^,]+).,\", 1, Tags, typeof(string)));\nlet cpu_percent = _data\n    | where Name == \"edgeAgent_used_cpu_percent\" and Tags contains_cs \"host\" and Tags contains_cs \"0.99\"\n    | extend value = toint(Val)\n    | top-nested of device by Ignore0=max(1),\n      top-nested 3 of TimeGenerated by Ignore1=max(TimeGenerated),\n      top-nested of value by Ignore2=max(1)\n    | project-away Ignore*\n    | summarize p95HostCpu=max(value) by device;\n//\nlet totalMemByDevice = _data\n    | where Name == \"edgeAgent_total_memory_bytes\" and Tags contains_cs \"host\"\n    | extend value = tolong(Val)\n    | project device, value, TimeGenerated\n    | top-nested of device by Ignore0=max(1),\n      top-nested 3 of TimeGenerated by Ignore1=max(TimeGenerated),\n      top-nested of value by Ignore2=max(1)\n    | project-away Ignore*\n    | summarize total_bytes=max(value) by device;\n//\nlet memUsedPercent = _data\n    | where Name == \"edgeAgent_used_memory_bytes\" and Tags contains_cs \"host\"\n    | top-nested of device by Ignore0=max(1),\n      top-nested 3 of TimeGenerated by Ignore1=max(TimeGenerated),\n      top-nested of Val by Ignore2=max(1)\n    | project-away Ignore*\n    | extend used_bytes = tolong(Val) \n    | project device, used_bytes, TimeGenerated\n    | join kind=leftouter totalMemByDevice on $left.device == $right.device\n    | extend mem_used_percent = (todouble(used_bytes) / todouble(total_bytes)) * 100\n    | extend mem_used_percent = round(mem_used_percent, 0)\n    | summarize p95HostMem=max(mem_used_percent) by device;\n//\nlet cpu_and_mem = memUsedPercent\n    | join cpu_percent on $left.device == $right.device\n    | project-away device1;\n//\nlet totalBytesByDevice = _data\n    | where Name == \"edgeAgent_total_disk_space_bytes\"\n    | extend dimensions=parse_json(Tags)\n    | extend value = tolong(Val)\n    | extend diskname = tostring(dimensions.disk_name)\n    | extend diskfs = tostring(dimensions.disk_filesystem)\n    | where diskfs != \"overlay\"\n    | top-nested of device by Ignore0=max(1),\n      top-nested 3 of TimeGenerated by Ignore1=max(TimeGenerated),\n      top-nested of value by Ignore2=max(1),\n      top-nested of diskname by Ignore3=max(1)\n    | project-away Ignore*\n    | project device, diskname, value, TimeGenerated\n    | summarize Bytes=max(value) by device, diskname\n    | summarize totalBytes=sum(Bytes) by device;\n//\nlet used_disk_trend = _data\n    | where Name == \"edgeAgent_available_disk_space_bytes\"\n    | extend dimensions=parse_json(Tags)\n    | extend value = tolong(Val)\n    | extend diskname = tostring(dimensions.disk_name)\n    | extend diskfs = tostring(dimensions.disk_filesystem)\n    | where diskfs != \"overlay\"\n    | top-nested of device by Ignore0=max(1),\n      top-nested 3 of TimeGenerated by Ignore1=max(TimeGenerated),\n      top-nested of value by Ignore2=max(1),\n      top-nested of diskname by Ignore3=max(1)\n    | project-away Ignore*\n    | project device, diskname, value, TimeGenerated\n    | summarize Bytes=max(value) by device, diskname, TimeGenerated\n    | summarize availBytes=sum(Bytes) by device, TimeGenerated\n    | join kind=leftouter\n        totalBytesByDevice\n        on $left.device == $right.device\n    | extend percentUsed = round((todouble(totalBytes) - todouble(availBytes)) / todouble(totalBytes) * 100, 0)\n    | project TimeGenerated, device, percentUsed\n    | summarize p95Disk=max(percentUsed) by device;\n//\nlet cpu_mem_disk = cpu_and_mem\n    | join\n        used_disk_trend\n        on $left.device == $right.device\n    | project-away device1;\n//\nlet p95QlenByDevice = _data\n    | where Name == \"edgehub_queue_length\"\n    | extend dimensions=parse_json(Tags)\n    | extend ep = tostring(dimensions.endpoint)\n    | extend qlen = iif(Val > 0x7FFFFFFFFFFFFFFF, toreal(0), Val)\n    | top-nested of device by Ignore0=max(1),\n      top-nested 3 of TimeGenerated by Ignore1=max(TimeGenerated),\n      top-nested of qlen by Ignore2=max(1),\n      top-nested of ep by Ignore3=max(1)\n    | project-away Ignore*\n    | project device, qlen, ep, TimeGenerated\n    | summarize sum(qlen) by TimeGenerated, device\n    | summarize p95QLen = max_of(0, max(sum_qlen)) by device;\n//\nlet lastUpdateTimeByDevice = _data\n    | where Name == \"edgehub_gettwin_total\" or Name == \"edgeAgent_total_time_running_correctly_seconds\"\n    | project TimeGenerated, device\n    | summarize lastUpdateTime=max(TimeGenerated) by device;\n//\nlet p95QlenByDeviceAndLastUpdate = p95QlenByDevice \n    | join kind=rightouter lastUpdateTimeByDevice on device\n    | extend device=device1\n    | project-away device1\n    | extend lastUpdatedSeconds = tolong(datetime_diff('second', now(), lastUpdateTime))\n    | extend lastUpdatedMins = tolong(datetime_diff('minute', now(), lastUpdateTime))\n    | extend lastUpdatedHours = tolong(datetime_diff('hour', now(), lastUpdateTime))\n    | extend lastUpdatedDays = tolong(datetime_diff('day', now(), lastUpdateTime))\n    | extend agoText = case(lastUpdatedSeconds <= 60, strcat(\"seen \", lastUpdatedSeconds, iff(lastUpdatedSeconds == 1, \" sec ago\", \" secs ago\")),\n        lastUpdatedSeconds <= 3600, strcat(\"seen \", lastUpdatedMins, iff(lastUpdatedMins == 1, \" min ago\", \" mins ago\")), \n        lastUpdatedSeconds <= 86400, strcat(\"seen \", lastUpdatedHours, iff(lastUpdatedHours == 1, \" hr ago\", \" hrs ago\")),\n        strcat(\"ðŸ‘€ \", lastUpdatedDays, iff(lastUpdatedDays > 1, \" days ago\", \" day ago\")))\n    | project agoText, device, p95QLen, lastUpdatedMins;\n//\nlet qlenAndLastUpdate = p95QlenByDeviceAndLastUpdate\n    | join kind=leftouter\n        cpu_mem_disk\n        on $left.device == $right.device\n    | project-away device1;\n// Local and upstream messages\nlet recentMessageCount = _data\n    | where Name == \"edgehub_messages_sent_total\"\n    | project TimeGenerated, device, Val, Tags\n    | partition hint.strategy=native by device (\n        sort by device, TimeGenerated desc \n        | extend target = trim_start(@\"[^/]+/\", extract(\"to.:.([^,]+).,\", 1, Tags, typeof(string))) // using extract which is faster than extractjson\n        | extend isupstream = target has \"Upstream\"\n        | extend source = strcat(device, \"::\", trim_start(@\"[^/]+/\", extract(\"from.:.([^,]+).,\", 1, Tags, typeof(string))))\n        | extend sourceTarget = strcat(source, \"::\", target)\n        | summarize msgCounts = make_list(Val)\n                 by device, source, sourceTarget, isupstream\n    )\n    | extend diffs = series_subtract(msgCounts, array_shift_left(msgCounts, 1, toint(msgCounts[-1]))), zeroes = repeat(0, array_length(msgCounts))\n    | extend diffs = array_iff(series_greater(diffs, zeroes), diffs, zeroes)\n    | extend latestDiff = max_of(toint(diffs[0]), 0)\n    | summarize recentUpstreamMessages = sumif(latestDiff, isupstream),\n                totalUpstreamMessages = sumif(array_sum(diffs), isupstream),\n                recentLocalMessages = sumif(latestDiff, not(isupstream)),\n                totalLocalMessages = sumif(array_sum(diffs), not(isupstream))\n             by device;\n// Final join\nqlenAndLastUpdate\n| join kind=leftouter recentMessageCount \n    on device\n| project-away device1\n| extend healthIndicator = \n    iff((p95HostMem < hostMemPercentThreshold \n        and p95HostCpu < hostCpuPercentThreshold \n        and p95Disk < hostDiskPercentThreshold \n        and p95QLen < qlenThreshold),\n        iff(lastUpdatedMins < firstPanicNoDataThresholdMins, 0, 1),\n        2\n    )\n| extend healthIndicator = \n    iff(lastUpdatedMins > secondPanicNoDataThresholdMins,\n        1,\n        iff((isnull(p95HostMem) or p95HostMem < hostMemPercentThreshold) \n            and (isnull(p95HostCpu) or p95HostCpu < hostCpuPercentThreshold)\n            and (isnull(p95Disk) or p95Disk < hostDiskPercentThreshold)\n            and (isnull(p95QLen) or p95QLen < qlenThreshold) \n            and (recentLocalMessages >= localMessagesSentThreshold or localMessagesSentThreshold == 0)\n            and (recentUpstreamMessages >= upstreamMessagesSentThreshold or upstreamMessagesSentThreshold == 0),\n            0,\n            2\n        )\n    )\n| extend statusHelper = \n    case(\n        lastUpdatedMins > secondPanicNoDataThresholdMins, -2,\n        lastUpdatedMins > firstPanicNoDataThresholdMins, -1,\n        healthIndicator\n    )\n| extend healthText = \n    case(\n        statusHelper == 0, \"Healthy\",\n        statusHelper == 1, \"Unhealthy\",\n        statusHelper == 2, \"Unhealthy\",\n        \"Unknown\"\n    )\n| where healthText in ({healthStatus})\n    and (p95QLen >= tolong({minQLen}) or isnull(p95QLen))\n    and (p95HostMem >= tolong({minMem}) or isnull(p95HostMem))\n    and (p95HostCpu >= tolong({minCpu}) or isnull(p95HostCpu))\n    and (p95Disk >= tolong({minDisk}) or isnull(p95Disk))\n    and (lastUpdatedMins >= {minLastSeen} or isnull(lastUpdatedMins))\n| extend iotresource_device = split(device, \"/\")\n| extend iotresource = tostring(iotresource_device[0])\n| extend device = tostring(iotresource_device[1])\n| extend resourceIndex = array_index_of(split(\"{IoTResources:name}\", \", \"), iotresource)\n| extend iotResourceId = trim(\"'\", tostring(split(\"{IoTResources}\", \",\")[resourceIndex]))\n| project iotResourceId, iotresource, device, healthIndicator, statusHelper, healthText, agoText, lastUpdatedMins, p95QLen, p95HostCpu, p95HostMem, p95Disk, recentLocalMessages, recentUpstreamMessages, totalLocalMessages, totalUpstreamMessages,\n          hostCpuPercentThreshold, hostMemPercentThreshold, hostDiskPercentThreshold, localMessagesSentThreshold, upstreamMessagesSentThreshold, qlenThreshold,\n          firstPanicNoDataThresholdMins, secondPanicNoDataThresholdMins\n| order by statusHelper desc, lastUpdatedMins desc, p95QLen desc, p95HostCpu desc, p95HostMem desc, p95Disk desc, device asc;",
                          "size": 0,
                          "noDataMessage": "No results to display.  Some may have been filtered.",
                          "timeContext": {
                            "durationMs": 0
                          },
                          "timeContextFromParameter": "timeRange",
                          "showRefreshButton": true,
                          "exportFieldName": "device",
                          "exportParameterName": "SelectedDeviceDetails",
                          "exportDefaultValue": "default",
                          "queryType": 0,
                          "resourceType": "{ResourceType}",
                          "crossComponentResources": [
                            "{IoTResources}"
                          ],
                          "visualization": "table",
                          "gridSettings": {
                            "formatters": [
                              {
                                "columnMatch": "$gen_group",
                                "formatter": 1
                              },
                              {
                                "columnMatch": "iotResourceId",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "iotresource",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "device",
                                "formatter": 7,
                                "formatOptions": {
                                  "linkTarget": "WorkbookTemplate",
                                  "linkIsContextBlade": false,
                                  "workbookContext": {
                                    "componentIdSource": "workbook",
                                    "resourceIdsSource": "workbook",
                                    "templateIdSource": "static",
                                    "templateId": "Community-Workbooks/IoTHub/IoT Edge device details",
                                    "typeSource": "workbook",
                                    "gallerySource": "workbook",
                                    "locationSource": "workbook",
                                    "passSpecificParams": true,
                                    "templateParameters": [
                                      {
                                        "name": "SelectedResource",
                                        "source": "column",
                                        "value": "iotresource"
                                      },
                                      {
                                        "name": "SelectedDevice",
                                        "source": "cell",
                                        "value": ""
                                      },
                                      {
                                        "name": "timeRange",
                                        "source": "parameter",
                                        "value": "timeRange"
                                      },
                                      {
                                        "name": "resourceId",
                                        "source": "column",
                                        "value": "iotResourceId"
                                      },
                                      {
                                        "name": "invokedFromFleetViewWorkbook",
                                        "source": "static",
                                        "value": "yes"
                                      }
                                    ]
                                  },
                                  "customColumnWidthSetting": "20ch"
                                },
                                "tooltipFormat": {
                                  "tooltip": "Open the details workbook for device '[\"device\"]'."
                                }
                              },
                              {
                                "columnMatch": "healthIndicator",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "statusHelper",
                                "formatter": 18,
                                "formatOptions": {
                                  "linkTarget": "WorkbookTemplate",
                                  "linkIsContextBlade": true,
                                  "thresholdsOptions": "icons",
                                  "thresholdsGrid": [
                                    {
                                      "operator": "==",
                                      "thresholdValue": "1",
                                      "representation": "2",
                                      "text": "[\"healthText\"]"
                                    },
                                    {
                                      "operator": "==",
                                      "thresholdValue": "2",
                                      "representation": "3",
                                      "text": "[\"healthText\"]"
                                    },
                                    {
                                      "operator": "==",
                                      "thresholdValue": "-1",
                                      "representation": "unknown",
                                      "text": "[\"healthText\"]"
                                    },
                                    {
                                      "operator": "<",
                                      "thresholdValue": "-1",
                                      "representation": "4",
                                      "text": "[\"healthText\"]"
                                    },
                                    {
                                      "operator": "Default",
                                      "thresholdValue": null,
                                      "representation": "success",
                                      "text": "[\"healthText\"]"
                                    }
                                  ],
                                  "workbookContext": {
                                    "componentIdSource": "workbook",
                                    "resourceIdsSource": "workbook",
                                    "templateIdSource": "static",
                                    "templateId": "Community-Workbooks/IoTHub/IoT Edge health snapshot",
                                    "typeSource": "default",
                                    "gallerySource": "default",
                                    "locationSource": "default",
                                    "passSpecificParams": true,
                                    "templateParameters": [
                                      {
                                        "name": "SelectedResource",
                                        "source": "column",
                                        "value": "iotresource"
                                      },
                                      {
                                        "name": "resourceId",
                                        "source": "column",
                                        "value": "iotResourceId"
                                      },
                                      {
                                        "name": "SelectedDevice",
                                        "source": "column",
                                        "value": "device"
                                      },
                                      {
                                        "name": "timeRange",
                                        "source": "parameter",
                                        "value": "timeRange"
                                      },
                                      {
                                        "name": "SnapshotSelect",
                                        "source": "static",
                                        "value": "'CPU'"
                                      },
                                      {
                                        "name": "hostMemPercentThreshold",
                                        "source": "column",
                                        "value": "hostMemPercentThreshold"
                                      },
                                      {
                                        "name": "hostCpuPercentThreshold",
                                        "source": "column",
                                        "value": "hostCpuPercentThreshold"
                                      },
                                      {
                                        "name": "hostDiskPercentThreshold",
                                        "source": "column",
                                        "value": "hostDiskPercentThreshold"
                                      },
                                      {
                                        "name": "localMessagesSentThreshold",
                                        "source": "column",
                                        "value": "localMessagesSentThreshold"
                                      },
                                      {
                                        "name": "upstreamMessagesSentThreshold",
                                        "source": "column",
                                        "value": "upstreamMessagesSentThreshold"
                                      },
                                      {
                                        "name": "qlenThreshold",
                                        "source": "column",
                                        "value": "qlenThreshold"
                                      },
                                      {
                                        "name": "invokedFromFleetViewWorkbook",
                                        "source": "static",
                                        "value": "yes"
                                      }
                                    ]
                                  }
                                },
                                "tooltipFormat": {
                                  "tooltip": "Open the health snapshot workbook for '[\"device\"]'."
                                }
                              },
                              {
                                "columnMatch": "healthText",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "agoText",
                                "formatter": 2,
                                "formatOptions": {
                                  "customColumnWidthSetting": "14.5ch"
                                }
                              },
                              {
                                "columnMatch": "lastUpdatedMins",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "p95QLen",
                                "formatter": 18,
                                "formatOptions": {
                                  "thresholdsOptions": "icons",
                                  "thresholdsGrid": [
                                    {
                                      "operator": ">=",
                                      "thresholdValue": "[\"qlenThreshold\"]",
                                      "representation": "trendup",
                                      "text": "{0}{1}"
                                    },
                                    {
                                      "operator": "Default",
                                      "thresholdValue": null,
                                      "representation": "Blank",
                                      "text": "{0}{1}"
                                    }
                                  ],
                                  "customColumnWidthSetting": "19ch"
                                }
                              },
                              {
                                "columnMatch": "p95HostCpu",
                                "formatter": 18,
                                "formatOptions": {
                                  "thresholdsOptions": "icons",
                                  "thresholdsGrid": [
                                    {
                                      "operator": ">=",
                                      "thresholdValue": "[\"hostCpuPercentThreshold\"]",
                                      "representation": "trendup",
                                      "text": "{0}{1}"
                                    },
                                    {
                                      "operator": "Default",
                                      "thresholdValue": null,
                                      "representation": "Blank",
                                      "text": "{0}{1}"
                                    }
                                  ],
                                  "customColumnWidthSetting": "16ch"
                                },
                                "numberFormat": {
                                  "unit": 1,
                                  "options": {
                                    "style": "decimal",
                                    "maximumFractionDigits": 0
                                  }
                                }
                              },
                              {
                                "columnMatch": "p95HostMem",
                                "formatter": 18,
                                "formatOptions": {
                                  "thresholdsOptions": "icons",
                                  "thresholdsGrid": [
                                    {
                                      "operator": ">=",
                                      "thresholdValue": "[\"hostMemPercentThreshold\"]",
                                      "representation": "trendup",
                                      "text": "{0}{1}"
                                    },
                                    {
                                      "operator": "Default",
                                      "thresholdValue": null,
                                      "representation": "Blank",
                                      "text": "{0}{1}"
                                    }
                                  ],
                                  "customColumnWidthSetting": "19ch"
                                },
                                "numberFormat": {
                                  "unit": 1,
                                  "options": {
                                    "style": "decimal",
                                    "maximumFractionDigits": 0
                                  }
                                }
                              },
                              {
                                "columnMatch": "p95Disk",
                                "formatter": 18,
                                "formatOptions": {
                                  "thresholdsOptions": "icons",
                                  "thresholdsGrid": [
                                    {
                                      "operator": ">=",
                                      "thresholdValue": "[\"hostDiskPercentThreshold\"]",
                                      "representation": "trendup",
                                      "text": "{0}{1}"
                                    },
                                    {
                                      "operator": "Default",
                                      "thresholdValue": null,
                                      "representation": "Blank",
                                      "text": "{0}{1}"
                                    }
                                  ],
                                  "customColumnWidthSetting": "16ch"
                                },
                                "numberFormat": {
                                  "unit": 1,
                                  "options": {
                                    "style": "decimal",
                                    "useGrouping": false,
                                    "maximumFractionDigits": 0
                                  }
                                }
                              },
                              {
                                "columnMatch": "recentLocalMessages",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "recentUpstreamMessages",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "totalLocalMessages",
                                "formatter": 18,
                                "formatOptions": {
                                  "thresholdsOptions": "icons",
                                  "thresholdsGrid": [
                                    {
                                      "operator": "Default",
                                      "thresholdValue": null,
                                      "representation": "Blank",
                                      "text": "{0}{1}"
                                    }
                                  ],
                                  "customColumnWidthSetting": "20ch"
                                },
                                "numberFormat": {
                                  "unit": 0,
                                  "options": {
                                    "style": "decimal",
                                    "useGrouping": true
                                  }
                                },
                                "tooltipFormat": {
                                  "tooltip": "Recent: [\"recentLocalMessages\"], Total: [\"totalLocalMessages\"]"
                                }
                              },
                              {
                                "columnMatch": "totalUpstreamMessages",
                                "formatter": 18,
                                "formatOptions": {
                                  "thresholdsOptions": "icons",
                                  "thresholdsGrid": [
                                    {
                                      "operator": "Default",
                                      "thresholdValue": null,
                                      "representation": "Blank",
                                      "text": "{0}{1}"
                                    }
                                  ],
                                  "customColumnWidthSetting": "24ch"
                                },
                                "numberFormat": {
                                  "unit": 0,
                                  "options": {
                                    "style": "decimal",
                                    "useGrouping": true
                                  }
                                },
                                "tooltipFormat": {
                                  "tooltip": "Recent: [\"recentUpstreamMessages\"], Total: [\"totalUpstreamMessages\"]"
                                }
                              },
                              {
                                "columnMatch": "hostCpuPercentThreshold",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "hostMemPercentThreshold",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "hostDiskPercentThreshold",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "localMessagesSentThreshold",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "upstreamMessagesSentThreshold",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "qlenThreshold",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "firstPanicNoDataThresholdMins",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "secondPanicNoDataThresholdMins",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "colorHelper",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "device_messages_total",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "device_messages_trend",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "qlenTrend",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "cpu_used_percent",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "mem_used_percent",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "disk_used_trend",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "lastUpdatedSeconds",
                                "formatter": 5
                              }
                            ],
                            "rowLimit": 10000,
                            "filter": true,
                            "hierarchySettings": {
                              "treeType": 1,
                              "groupBy": [
                                "iotresource"
                              ],
                              "expandTopLevel": true
                            },
                            "labelSettings": [
                              {
                                "columnId": "iotresource",
                                "label": "IoT Resource"
                              },
                              {
                                "columnId": "device",
                                "label": "Name"
                              },
                              {
                                "columnId": "statusHelper",
                                "label": "Status"
                              },
                              {
                                "columnId": "agoText",
                                "label": "Last seen"
                              },
                              {
                                "columnId": "p95QLen",
                                "label": "Queue (p95)"
                              },
                              {
                                "columnId": "p95HostCpu",
                                "label": "CPU (p95)"
                              },
                              {
                                "columnId": "p95HostMem",
                                "label": "Memory (p95)"
                              },
                              {
                                "columnId": "p95Disk",
                                "label": "Disk (p95)"
                              },
                              {
                                "columnId": "recentLocalMessages",
                                "label": "â–³ Msg. (local)"
                              },
                              {
                                "columnId": "recentUpstreamMessages",
                                "label": "â–³ Msg. (upstream)"
                              },
                              {
                                "columnId": "totalLocalMessages",
                                "label": "Local Msg. Count"
                              },
                              {
                                "columnId": "totalUpstreamMessages",
                                "label": "Upstream Msg. Count"
                              }
                            ]
                          },
                          "sortBy": []
                        },
                        "showPin": true,
                        "name": "device-health-graph",
                        "styleSettings": {
                          "margin": "-36px 0px 0px 0px",
                          "padding": "0px 0px 0px 14px"
                        }
                      }
                    ]
                  },
                  "name": "device-health-group",
                  "styleSettings": {
                    "margin": "0px"
                  }
                }
              ],
              "exportParameters": true
            },
            "conditionalVisibilities": [
              {
                "parameterName": "InsightsMetricsExist",
                "comparison": "isEqualTo",
                "value": "yes"
              },
              {
                "parameterName": "SelectedTab",
                "comparison": "isEqualTo",
                "value": "summaryview"
              }
            ],
            "name": "summary report group"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "InsightsMetricsExist",
        "comparison": "isEqualTo",
        "value": "yes"
      },
      "name": "fleet view"
    },
    {
      "type": 1,
      "content": {
        "json": "The definition for the _Health Snapshot_ workbook is found in the community Application Insights Workbooks github repository under [Workbooks/IoTHub/IoT Edge Health Snapshot](https://github.com/microsoft/Application-Insights-Workbooks/blob/master/Workbooks/IoTHub/IoT%20Edge%20health%20snapshot/iotedge-health-snapshot.workbook).",
        "style": "info"
      },
      "conditionalVisibility": {
        "parameterName": "NeverSet",
        "comparison": "isNotEqualTo",
        "value": ""
      },
      "name": "location of health snapshot definition"
    }
  ],
  "fallbackResourceIds": [
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
