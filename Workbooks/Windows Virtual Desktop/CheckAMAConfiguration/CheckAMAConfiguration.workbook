{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "b859a03f-2283-43dd-8536-42714bbfced6",
            "version": "KqlParameterItem/1.0",
            "name": "Subscription",
            "type": 6,
            "isRequired": true,
            "query": "where type startswith 'Microsoft.DesktopVirtualization/'\r\n    | summarize Count = count() by subscriptionId\r\n    | order by Count desc\r\n    | extend Rank = row_number()\r\n    | project value = subscriptionId, label = subscriptionId, selected = Rank == 1\r\n",
            "crossComponentResources": [
              "value::all"
            ],
            "typeSettings": {
              "additionalResourceOptions": []
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "2e3dfd9b-2d0f-4feb-94e8-107f220c4e28",
            "version": "KqlParameterItem/1.0",
            "name": "ResourceGroup",
            "label": "Resource Group",
            "type": 5,
            "isRequired": true,
            "query": "resources\r\n| where type contains  \"desktopvirtualization\"\r\n| summarize Count = count() by resourceGroup\r\n| project Label = resourceGroup, Id = resourceGroup, Selected = Count >= 0",
            "crossComponentResources": [
              "{Subscription}"
            ],
            "typeSettings": {
              "additionalResourceOptions": []
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "951b5870-e216-45c6-b159-34150868a46e",
            "version": "KqlParameterItem/1.0",
            "name": "HostPool",
            "label": "Host Pool",
            "type": 5,
            "isRequired": true,
            "query": "resources\r\n| where type == \"microsoft.desktopvirtualization/hostpools\" and resourceGroup =~ \"{ResourceGroup}\"\r\n",
            "crossComponentResources": [
              "{Subscription}"
            ],
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "966a75f4-f4a4-4404-b649-67da45ddf636",
            "version": "KqlParameterItem/1.0",
            "name": "WVDHosts",
            "type": 5,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GETARRAY\",\"path\":\"/subscriptions/{Subscription:id}/resourcegroups/{ResourceGroup}/providers/Microsoft.DesktopVirtualization/hostpools/{HostPool:label}/sessionhosts?api-version=2019-01-23-preview\",\"urlParams\":[],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"\",\"columns\":[{\"path\":\"$.properties.resourceId\",\"columnid\":\"Name\"},{\"path\":\"$.properties.resourceId\",\"columnid\":\"Disp\"},{\"path\":\"$.name\",\"columnid\":\"selected\"}]}}]}",
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ]
            },
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 12
          },
          {
            "id": "42ed3fcf-029c-49d5-b29e-655ecf674c1d",
            "version": "KqlParameterItem/1.0",
            "name": "pooldiagcheck",
            "type": 1,
            "isRequired": true,
            "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"/{HostPool}/providers/microsoft.insights/diagnosticSettings?api-version=2021-05-01-preview\",\"urlParams\":[],\"batchDisabled\":false,\"transformers\":null}",
            "isHiddenWhenLocked": true,
            "queryType": 12
          },
          {
            "id": "ff8c2838-aaf0-40f6-a604-d4bfe72fc92f",
            "version": "KqlParameterItem/1.0",
            "name": "poolla",
            "type": 5,
            "query": "{\"version\":\"1.0.0\",\"content\":\"{pooldiagcheck}\",\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.value[0]\",\"columns\":[{\"path\":\"$.properties.workspaceId\",\"columnid\":\"Id\"},{\"path\":\"$.id\",\"columnid\":\"Disp\"},{\"path\":\"$.id\",\"columnid\":\"Selected\"}]}}]}",
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 8
          },
          {
            "id": "08f46c2a-f080-40c5-b36f-acd0e80c6259",
            "version": "KqlParameterItem/1.0",
            "name": "laextensions",
            "type": 1,
            "isRequired": true,
            "query": "resources\r\n| where type =~ \"Microsoft.Compute/virtualMachines/extensions\"and properties.type == \"MicrosoftMonitoringAgent\"\r\n| extend vmname = extract(\"(.*?)/extensions\",1, id)\r\n| where vmname in~ ({WVDHosts})\r\n| summarize total=count()\r\n| project tostring(total), selected=true\r\n",
            "crossComponentResources": [
              "{Subscription}"
            ],
            "isHiddenWhenLocked": true,
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 1
          },
          {
            "id": "2edb83c2-527f-46fd-9e26-3e72d80da433",
            "version": "KqlParameterItem/1.0",
            "name": "HasMonitorPool",
            "type": 1,
            "isRequired": true,
            "query": "{\"version\":\"1.0.0\",\"content\":\"{\\\"value\\\":\\\"{poolla}\\\"}\",\"transformers\":null}",
            "isHiddenWhenLocked": true,
            "queryType": 8
          },
          {
            "id": "572b7906-3701-4c76-b061-b8bc1329e174",
            "version": "KqlParameterItem/1.0",
            "name": "HasMonitor",
            "type": 1,
            "isRequired": true,
            "isHiddenWhenLocked": true,
            "criteriaData": [
              {
                "criteriaContext": {
                  "leftOperand": "HasMonitorPool",
                  "operator": "is Empty",
                  "rightValType": "param",
                  "resultValType": "static",
                  "resultVal": "no"
                }
              },
              {
                "criteriaContext": {
                  "operator": "Default",
                  "rightValType": "param",
                  "resultValType": "static",
                  "resultVal": "yes"
                }
              }
            ]
          },
          {
            "id": "221f3a7b-fe3a-4da2-9276-37acb6d457ba",
            "version": "KqlParameterItem/1.0",
            "name": "wvdworkspace",
            "type": 5,
            "isRequired": true,
            "query": "resources\r\n| where type == \"microsoft.desktopvirtualization/applicationgroups\"\r\n| project id, workspace= properties.workspaceArmPath, hp=properties.hostPoolArmPath\r\n| where isnotnull(workspace)\r\n| where hp =~ \"{HostPool}\"\r\n| project workspace, label=workspace,selected=1",
            "crossComponentResources": [
              "value::all"
            ],
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": []
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "version": "KqlParameterItem/1.0",
            "name": "wvdworkspacediag",
            "type": 1,
            "isRequired": true,
            "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"/{wvdworkspace}/providers/microsoft.insights/diagnosticSettings?api-version=2021-05-01-preview\",\"urlParams\":[],\"batchDisabled\":false,\"transformers\":null}",
            "isHiddenWhenLocked": true,
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 12,
            "id": "3a544516-84a7-46e0-a8d1-3047d0ace2ca"
          },
          {
            "id": "e47a2bfd-c87b-48c2-bc96-5da32fd9c480",
            "version": "KqlParameterItem/1.0",
            "name": "OneWVDHost",
            "type": 5,
            "query": "resources\r\n| project id=tolower(id), name\r\n| join kind=leftouter(\r\nresources // vms with AMA extensions have higher priority\r\n| where type == \"microsoft.compute/virtualmachines/extensions\"\r\n| extend  exttype= properties.type\r\n| where exttype =~\"AzureMonitorWindowsAgent\"\r\n| project  exttype, id=tolower(trim_end(\"/extensions/.+\",id))\r\n ) on id\r\n|project id,name, rank=iff(isnotempty(id1),1,2)\r\n| top 1 by rank asc",
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "c0034ed5-157b-47b5-ab67-c7c80e6165b0",
            "version": "KqlParameterItem/1.0",
            "name": "assignedDCR",
            "type": 5,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"{OneWVDHost}/providers/Microsoft.Insights/dataCollectionRuleAssociations?api-version=2021-04-01\",\"urlParams\":[],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.value\",\"columns\":[{\"path\":\"$.properties.dataCollectionRuleId\",\"columnid\":\"Id\",\"columnType\":\"string\"},{\"path\":\"$.properties.dataCollectionRuleId\",\"columnid\":\"Name\",\"columnType\":\"string\",\"substringRegexMatch\":\".*/dataCollectionRules/(microsoft-avdi-).*\",\"substringReplace\":\"$1\"},{\"path\":\"$.properties.dataCollectionRuleId\",\"columnid\":\"Selected\",\"substringRegexMatch\":\".*/dataCollectionRules/(microsoft-avdi-).*|.*\",\"substringReplace\":\"$1\"}]}}]}",
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": []
            },
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 12,
            "value": null
          },
          {
            "id": "f5fc0f57-654e-4c34-a330-d8463460c169",
            "version": "KqlParameterItem/1.0",
            "name": "HostsLA",
            "type": 5,
            "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"{assignedDCR:id}?api-version=2022-06-01\",\"urlParams\":[],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.properties.destinations.logAnalytics\",\"columns\":[]}}]}",
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "queryType": 12
          },
          {
            "id": "74d96039-7494-4577-940a-e6ce61c63d3a",
            "version": "KqlParameterItem/1.0",
            "name": "laworkspaces",
            "type": 5,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "{\"version\":\"1.0.0\",\"content\":\"\\r\\n[{\\\"value\\\":\\\"{poolla}\\\",\\\"label\\\":\\\"1\\\", \\\"selected\\\":true},\\r\\n {\\\"value\\\":\\\"{HostsLA}\\\",\\\"label\\\":\\\"2\\\", \\\"selected\\\":true}]\",\"transformers\":null}",
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "queryType": 8
          }
        ],
        "style": "pills",
        "queryType": 8
      },
      "name": "parameters_general"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "paragraph",
        "links": [
          {
            "id": "6cd11baa-e9d1-4898-b176-4e6cb52d1ef2",
            "cellValue": "https://docs.microsoft.com/en-us/azure/virtual-desktop/azure-monitor",
            "linkTarget": "Url",
            "linkLabel": "How-To",
            "preText": "To use the configuration workbook, follow the setup instructions in our ",
            "postText": "guide.",
            "style": "link"
          },
          {
            "id": "c62cbac7-79f2-41f6-bc36-8ca3948d5993",
            "cellValue": "https://docs.microsoft.com/en-us/azure/virtual-desktop/azure-monitor-glossary",
            "linkTarget": "Url",
            "linkLabel": "glossary",
            "preText": "For additional resources, see our ",
            "style": "link"
          },
          {
            "id": "bd48d3b2-02e0-411e-a58e-2008a797f9b7",
            "cellValue": "https://docs.microsoft.com/en-us/azure/virtual-desktop/troubleshoot-azure-monitor",
            "linkTarget": "Url",
            "linkLabel": "troubleshooting",
            "preText": "and",
            "postText": "documents.",
            "style": "link"
          }
        ]
      },
      "name": "CheckConfigLink"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "tabs",
        "links": [
          {
            "id": "ff91c2aa-87a9-46ca-80d9-b99ea3c4c9ed",
            "cellValue": "configstep",
            "linkTarget": "parameter",
            "linkLabel": "Resources diagnostic settings",
            "subTarget": "hostpool",
            "style": "link"
          },
          {
            "id": "a92a0475-29d5-404d-8b87-6322463b5966",
            "cellValue": "configstep",
            "linkTarget": "parameter",
            "linkLabel": "Session host data settings",
            "subTarget": "sessionhost",
            "style": "link"
          },
          {
            "id": "d0f9051a-60c3-4e3f-bf9e-09eb44647bc2",
            "cellValue": "configstep",
            "linkTarget": "parameter",
            "linkLabel": "Data Generated",
            "subTarget": "datagen",
            "style": "link"
          }
        ]
      },
      "name": "ConfigStepTabs"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "### Check diagnostic settings for host pool: {HostPool:label}"
            },
            "name": "CheckDiagSettingsMessage"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "crossComponentResources": [
                "value::all"
              ],
              "parameters": [
                {
                  "id": "47d10c5f-30e7-49ec-a61d-bc98f80e13b8",
                  "version": "KqlParameterItem/1.0",
                  "name": "poolWorkspace",
                  "label": "Log Analytics workspace",
                  "type": 5,
                  "description": "Select the Log Analytics workspace to send resource diagnostics to.",
                  "isRequired": true,
                  "query": "resources\r\n| where type =~ \"Microsoft.OperationalInsights/workspaces\"\r\n| project id, label=name, selected=id=~\"{poolla}\"",
                  "crossComponentResources": [
                    "value::all"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 0
                  },
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources"
                },
                {
                  "id": "acf698d7-6649-48c8-b353-98c6549a7e23",
                  "version": "KqlParameterItem/1.0",
                  "name": "wvdworkspacesettings",
                  "type": 1,
                  "isRequired": true,
                  "query": "resources\r\n| take 1\r\n| project config=dynamic({wvdworkspacediag})\r\n| project config = parse_json(config).value\r\n| mv-expand config\r\n| project Name=config.name, Workspace=config.properties.workspaceId, tables=config.properties.logs\r\n| where Workspace =~ \"{poolWorkspace}\"\r\n| project Workspace, disp=Workspace, selected=1",
                  "crossComponentResources": [
                    "{Subscription}"
                  ],
                  "isHiddenWhenLocked": true,
                  "timeContext": {
                    "durationMs": 0
                  },
                  "timeContextFromParameter": "TimeRange",
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources"
                }
              ],
              "style": "pills",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources"
            },
            "name": "parameters_checkhostpool"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Host pool {HostPool:name}",
              "items": [
                {
                  "type": 12,
                  "content": {
                    "version": "NotebookGroup/1.0",
                    "groupType": "editable",
                    "items": [
                      {
                        "type": 1,
                        "content": {
                          "json": "No existing diagnostic configuration was found for the selected host pool.",
                          "style": "warning"
                        },
                        "name": "NoDiagConfigMessage"
                      },
                      {
                        "type": 12,
                        "content": {
                          "version": "NotebookGroup/1.0",
                          "groupType": "editable",
                          "items": [
                            {
                              "type": 1,
                              "content": {
                                "json": "Azure Monitor is not configured for the selected host pool.  \r\nConfigure diagnostic settings for the host pool.\r\n\r\n1. Select the Log analytics workspace in the **Log Analytics workspace** parameter\r\n2. Select **Configure host pool**\r\n3. Select **Deploy**.\r\nAfter the deployment is completed, refresh the workbook by selecting the refresh button on the top.\r\n\r\n[More information on Azure Monitor for Azure Virtual Desktop](https://docs.microsoft.com/en-us/azure/virtual-desktop/diagnostics-log-analytics)"
                              },
                              "name": "HostPoolNotCfg"
                            },
                            {
                              "type": 11,
                              "content": {
                                "version": "LinkItem/1.0",
                                "style": "list",
                                "links": [
                                  {
                                    "id": "162f5ab1-83c7-4cf6-baf7-f5e8977eff73",
                                    "linkTarget": "ArmTemplate",
                                    "linkLabel": "Configure host pool",
                                    "style": "primary",
                                    "templateRunContext": {
                                      "componentIdSource": "parameter",
                                      "componentId": "HostPool",
                                      "templateUriSource": "static",
                                      "templateUri": "Community-Workbooks/Windows Virtual Desktop/templates/hostpooldiag.armtemplate",
                                      "templateParameters": [
                                        {
                                          "name": "hostpoolName",
                                          "source": "static",
                                          "value": "{HostPool:name}",
                                          "kind": "stringValue"
                                        },
                                        {
                                          "name": "settingName",
                                          "source": "static",
                                          "value": "WVDInsights",
                                          "kind": "stringValue"
                                        },
                                        {
                                          "name": "workspaceId",
                                          "source": "parameter",
                                          "value": "poolWorkspace",
                                          "kind": "stringValue"
                                        }
                                      ],
                                      "titleSource": "static",
                                      "descriptionSource": "static",
                                      "description": "**Configure host pool diagnostic settings**\r\n\r\nWorkspace will be configured for the following categories:\r\n- Management Activities\r\n- Feed\r\n- Connections\r\n- Errors\r\n- Checkpoints\r\n- HostRegistration\r\n- AgentHealthStatus\r\n",
                                      "runLabelSource": "static"
                                    }
                                  }
                                ]
                              },
                              "conditionalVisibility": {
                                "parameterName": "poolWorkspace",
                                "comparison": "isNotEqualTo"
                              },
                              "name": "confighostpool"
                            }
                          ]
                        },
                        "conditionalVisibility": {
                          "parameterName": "HasMonitorPool",
                          "comparison": "isEqualTo"
                        },
                        "name": "NoDataPool"
                      }
                    ]
                  },
                  "conditionalVisibility": {
                    "parameterName": "poolla",
                    "comparison": "isEqualTo"
                  },
                  "name": "PoolGroup"
                },
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "crossComponentResources": [
                      "{poolla}"
                    ],
                    "parameters": [
                      {
                        "id": "c6b1edff-5145-41bf-8314-48d94e2c37d1",
                        "version": "KqlParameterItem/1.0",
                        "name": "requiredTables",
                        "type": 1,
                        "isRequired": true,
                        "value": "'checkpoint', 'error', 'management', 'connection', 'hostregistration', 'agenthealthstatus'",
                        "isHiddenWhenLocked": true,
                        "typeSettings": {
                          "multiLineText": true,
                          "editorLanguage": "text"
                        }
                      },
                      {
                        "id": "ecb0c8d7-2331-40a6-8918-80f678664fe4",
                        "version": "KqlParameterItem/1.0",
                        "name": "MissingTables",
                        "type": 1,
                        "isRequired": true,
                        "query": "datatable(config:string) ['{pooldiagcheck}']\r\n| project config = parse_json(config).value\r\n| mv-expand config\r\n| project Name=config.name, Workspace=tostring(config.properties.workspaceId), tables=config.properties.logs\r\n| where Workspace =~ \"{poolWorkspace}\"\r\n| mv-expand tables\r\n| project Name, Workspace, Table=tolower(tables.category), Enabled=tables.enabled\r\n| join kind=leftouter (datatable(Required:string) [{requiredTables}] ) on $left.Table == $right.Required\r\n| where Enabled == false and isnotempty(Required)\r\n| summarize result = count()\r\n| project tostring(result)\r\n",
                        "crossComponentResources": [
                          "{poolla}"
                        ],
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                          "durationMs": 86400000
                        },
                        "queryType": 0,
                        "resourceType": "microsoft.operationalinsights/workspaces"
                      }
                    ],
                    "style": "pills",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "conditionalVisibility": {
                    "parameterName": "poolla",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "FindMissingTables"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "datatable(config:string) ['{pooldiagcheck}']\r\n| project config = parse_json(config).value\r\n| mv-expand config\r\n| project Name=config.name, Workspace=tostring(config.properties.workspaceId), tables=config.properties.logs\r\n| mv-expand tables\r\n| project Name, Workspace, Groups=tables.categoryGroup, Table=tostring(tables.category), tableId=tolower(tables.category), Enabled=tables.enabled\r\n| join kind=leftouter (datatable(Required:string) [{requiredTables}] ) on $left.tableId == $right.Required\r\n| project Name, Workspace, Groups, Table, Required = iif(isempty(Required),\"No\",\"Yes\"), Enabled = iff(Enabled == true, \"Yes\", \"No\"), Critical = iff(Enabled == false and isnotempty(Required), \"Yes\",\"No\")\r\n",
                    "size": 1,
                    "title": "Host pool diagnostic settings: {HostPool}",
                    "timeContext": {
                      "durationMs": 0
                    },
                    "showExportToExcel": true,
                    "exportToExcelOptions": "all",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{poolWorkspace}"
                    ],
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Enabled",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "Critical",
                          "formatter": 18,
                          "formatOptions": {
                            "thresholdsOptions": "icons",
                            "thresholdsGrid": [
                              {
                                "operator": "==",
                                "thresholdValue": "No",
                                "representation": "success",
                                "text": "[\"Enabled\"]"
                              },
                              {
                                "operator": "Default",
                                "thresholdValue": null,
                                "representation": "4",
                                "text": "[\"Enabled\"]"
                              }
                            ]
                          }
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "Name",
                          "label": "Name"
                        },
                        {
                          "columnId": "Workspace",
                          "label": "Workspace"
                        },
                        {
                          "columnId": "Groups",
                          "label": "Category group"
                        },
                        {
                          "columnId": "Table",
                          "label": "Table"
                        },
                        {
                          "columnId": "Required",
                          "label": "Required"
                        },
                        {
                          "columnId": "Enabled",
                          "label": "Enabled"
                        },
                        {
                          "columnId": "Critical",
                          "label": "Enabled"
                        }
                      ]
                    },
                    "sortBy": []
                  },
                  "conditionalVisibility": {
                    "parameterName": "poolla",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "HostPoolDiag"
                },
                {
                  "type": 12,
                  "content": {
                    "version": "NotebookGroup/1.0",
                    "groupType": "editable",
                    "items": [
                      {
                        "type": 1,
                        "content": {
                          "json": "Required tables are not configured for the selected host pool.  \r\nConfigure diagnostic settings for the host pool.\r\n\r\n1. Select **Configure host pool**\r\n2. Select **Deploy**.\r\nAfter the deployment is completed, refresh the workbook by selecting the refresh button on the top.\r\n\r\nWhen you enable data collection for a table for the first time, there may be a delay before the initial set of data appears.\r\n \r\n\r\n[More information on Azure Monitor for Azure Virtual Desktop](https://docs.microsoft.com/en-us/azure/virtual-desktop/diagnostics-log-analytics)",
                          "style": "warning"
                        },
                        "name": "HostPoolMissingTables"
                      },
                      {
                        "type": 11,
                        "content": {
                          "version": "LinkItem/1.0",
                          "style": "list",
                          "links": [
                            {
                              "id": "cb233ef3-69da-418d-a6a6-3fdd775684d1",
                              "linkTarget": "ArmTemplate",
                              "linkLabel": "Configure host pool",
                              "style": "primary",
                              "templateRunContext": {
                                "componentIdSource": "parameter",
                                "componentId": "HostPool",
                                "templateUriSource": "static",
                                "templateUri": "Community-Workbooks/Windows Virtual Desktop/templates/hostpooldiag.armtemplate",
                                "templateParameters": [
                                  {
                                    "name": "hostpoolName",
                                    "source": "static",
                                    "value": "{HostPool:name}",
                                    "kind": "stringValue"
                                  },
                                  {
                                    "name": "settingName",
                                    "source": "static",
                                    "value": "WVDInsights",
                                    "kind": "stringValue"
                                  },
                                  {
                                    "name": "workspaceId",
                                    "source": "parameter",
                                    "value": "poolWorkspace",
                                    "kind": "stringValue"
                                  }
                                ],
                                "titleSource": "static",
                                "descriptionSource": "static",
                                "description": "**Configure host pool diagnostic settings**\r\n\r\nWorkspace will be configured for the following categories:\r\n- Management Activities\r\n- Feed\r\n- Connections\r\n- Errors\r\n- Checkpoints\r\n- HostRegistration\r\n- AgentHealthStatus\r\n",
                                "runLabelSource": "static"
                              }
                            }
                          ]
                        },
                        "conditionalVisibility": {
                          "parameterName": "poolWorkspace",
                          "comparison": "isNotEqualTo"
                        },
                        "name": "confighostpoolMT"
                      }
                    ]
                  },
                  "conditionalVisibilities": [
                    {
                      "parameterName": "MissingTables",
                      "comparison": "isNotEqualTo",
                      "value": "0"
                    },
                    {
                      "parameterName": "poolla",
                      "comparison": "isNotEqualTo"
                    }
                  ],
                  "name": "PoolMissingTable",
                  "styleSettings": {
                    "showBorder": true
                  }
                }
              ]
            },
            "name": "WVDHostpool",
            "styleSettings": {
              "margin": "5px",
              "padding": "5px",
              "showBorder": true
            }
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Workspace {wvdworkspace:name}",
              "items": [
                {
                  "type": 12,
                  "content": {
                    "version": "NotebookGroup/1.0",
                    "groupType": "editable",
                    "items": [
                      {
                        "type": 1,
                        "content": {
                          "json": "No existing diagnostic configuration was found for the selected workspace.",
                          "style": "warning"
                        },
                        "name": "NoHostPoolDiag"
                      },
                      {
                        "type": 12,
                        "content": {
                          "version": "NotebookGroup/1.0",
                          "groupType": "editable",
                          "items": [
                            {
                              "type": 1,
                              "content": {
                                "json": "Azure Monitor is not configured for the selected workspace.  \r\nConfigure diagnostic settings for the workspace.\r\n\r\n1. Select the Log analytics workspace in the **Log Analytics workspace** parameter\r\n2. Select **Configure workspace**\r\n3. Select **Deploy**.\r\nAfter the deployment is completed, refresh the workbook by selecting the refresh button on the top.\r\n\r\n[More information on Azure Monitor for Azure Virtual Desktop](https://docs.microsoft.com/en-us/azure/virtual-desktop/diagnostics-log-analytics)"
                              },
                              "name": "NoWVDWorkspaceCfg"
                            },
                            {
                              "type": 11,
                              "content": {
                                "version": "LinkItem/1.0",
                                "style": "list",
                                "links": [
                                  {
                                    "id": "3a35c64b-9fde-4e6f-92eb-c0fd0cf417af",
                                    "linkTarget": "ArmTemplate",
                                    "linkLabel": "Configure workspace",
                                    "style": "primary",
                                    "templateRunContext": {
                                      "componentIdSource": "parameter",
                                      "componentId": "wvdworkspace",
                                      "templateUriSource": "static",
                                      "templateUri": "Community-Workbooks/Windows Virtual Desktop/templates/avdworkspacediag.armtemplate",
                                      "templateParameters": [
                                        {
                                          "name": "workspaceName",
                                          "source": "static",
                                          "value": "{wvdworkspace:name}",
                                          "kind": "stringValue"
                                        },
                                        {
                                          "name": "settingName",
                                          "source": "static",
                                          "value": "WVDInsights",
                                          "kind": "stringValue"
                                        },
                                        {
                                          "name": "workspaceId",
                                          "source": "parameter",
                                          "value": "poolWorkspace",
                                          "kind": "stringValue"
                                        }
                                      ],
                                      "titleSource": "static",
                                      "descriptionSource": "static",
                                      "description": "**Configure workspace diganostic settings**\r\n\r\nThe workspace will be configured for the following categories:\r\n- Management Activities\r\n- Feed\r\n- Errors\r\n- Checkpoints\r\n",
                                      "runLabelSource": "static"
                                    }
                                  }
                                ]
                              },
                              "conditionalVisibility": {
                                "parameterName": "poolWorkspace",
                                "comparison": "isNotEqualTo"
                              },
                              "name": "confighostpoolWorkspace"
                            }
                          ]
                        },
                        "name": "NoDataPoolWorkspace"
                      }
                    ]
                  },
                  "conditionalVisibility": {
                    "parameterName": "wvdworkspacesettings",
                    "comparison": "isEqualTo"
                  },
                  "name": "NoWVDworkspaceDiag"
                },
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "crossComponentResources": [
                      "{poolla}"
                    ],
                    "parameters": [
                      {
                        "id": "c4b1c6a5-4350-46ae-a15c-d3a777e427c2",
                        "version": "KqlParameterItem/1.0",
                        "name": "requiredTablesWkspc",
                        "type": 1,
                        "isRequired": true,
                        "value": "'checkpoint', 'error', 'management', 'feed'",
                        "isHiddenWhenLocked": true,
                        "typeSettings": {
                          "multiLineText": true,
                          "editorLanguage": "text"
                        }
                      },
                      {
                        "id": "ded71a5c-4331-4e52-81e0-0f307b2fb01c",
                        "version": "KqlParameterItem/1.0",
                        "name": "MissingTablesWkspc",
                        "type": 1,
                        "isRequired": true,
                        "query": "datatable(config:string) ['{wvdworkspacediag}']\r\n| project config = parse_json(config).value\r\n| mv-expand config\r\n| project Name=config.name, Workspace=tostring(config.properties.workspaceId), tables=config.properties.logs\r\n| where Workspace =~ \"{poolWorkspace}\"\r\n| mv-expand tables\r\n| project Name, Workspace, Table=tolower(tables.category), Enabled=tables.enabled\r\n| join kind=leftouter (datatable(Required:string) [{requiredTablesWkspc}] ) on $left.Table == $right.Required\r\n| where Enabled == false and isnotempty(Required)\r\n| summarize result = count()\r\n| project tostring(result)\r\n\r\n",
                        "crossComponentResources": [
                          "{poolla}"
                        ],
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                          "durationMs": 86400000
                        },
                        "queryType": 0,
                        "resourceType": "microsoft.operationalinsights/workspaces"
                      }
                    ],
                    "style": "pills",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "conditionalVisibility": {
                    "parameterName": "poolla",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "FindMissingTablesWkspc"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "datatable(config:string) ['{wvdworkspacediag}']\r\n| project config = parse_json(config).value\r\n| mv-expand config\r\n| project Name=config.name, Workspace=tostring(config.properties.workspaceId), tables=config.properties.logs\r\n| where Workspace =~ \"{poolWorkspace}\"\r\n| mv-expand tables\r\n| project Name, Workspace, Groups=tables.categoryGroup, Table=tostring(tables.category), tableId=tolower(tables.category), Enabled=tables.enabled\r\n| join kind=leftouter (datatable(Required:string) [{requiredTablesWkspc}] ) on $left.tableId == $right.Required\r\n| project Name, Workspace, Groups, Table, Required = iif(isempty(Required),\"No\",\"Yes\"), Enabled = iff(Enabled == true, \"Yes\", \"No\"), Critical = iff(Enabled == false and isnotempty(Required), \"Yes\",\"No\")\r\n\r\n",
                    "size": 1,
                    "title": "AVD workspace diagnostic settings: {wvdworkspace}",
                    "timeContext": {
                      "durationMs": 0
                    },
                    "showExportToExcel": true,
                    "exportToExcelOptions": "all",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{poolWorkspace}"
                    ],
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Enabled",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "Critical",
                          "formatter": 18,
                          "formatOptions": {
                            "thresholdsOptions": "icons",
                            "thresholdsGrid": [
                              {
                                "operator": "==",
                                "thresholdValue": "No",
                                "representation": "success",
                                "text": "[\"Enabled\"]"
                              },
                              {
                                "operator": "Default",
                                "thresholdValue": null,
                                "representation": "4",
                                "text": "[\"Enabled\"]"
                              }
                            ]
                          }
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "Name",
                          "label": "Name"
                        },
                        {
                          "columnId": "Workspace",
                          "label": "Workspace"
                        },
                        {
                          "columnId": "Groups",
                          "label": "Category group"
                        },
                        {
                          "columnId": "Table",
                          "label": "Table"
                        },
                        {
                          "columnId": "Required",
                          "label": "Required"
                        },
                        {
                          "columnId": "Enabled",
                          "label": "Enabled"
                        },
                        {
                          "columnId": "Critical",
                          "label": "Enabled"
                        }
                      ]
                    }
                  },
                  "conditionalVisibility": {
                    "parameterName": "wvdworkspacesettings",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "WVDWorkspaceConfig"
                },
                {
                  "type": 12,
                  "content": {
                    "version": "NotebookGroup/1.0",
                    "groupType": "editable",
                    "items": [
                      {
                        "type": 1,
                        "content": {
                          "json": "Required tables are not configured for the selected workspace.  \r\nConfigure diagnostic settings for the workspace.\r\n\r\n1. Select **Configure workspace**\r\n2. Select **Deploy**.\r\nAfter the deployment is completed, refresh the workbook by selecting the refresh button on the top.\r\n\r\nWhen you enable data collection for a table for the first time, there may be a delay before the initial set of data appears.\r\n \r\n\r\n[More information on Azure Monitor for Azure Virtual Desktop](https://docs.microsoft.com/en-us/azure/virtual-desktop/diagnostics-log-analytics)",
                          "style": "warning"
                        },
                        "name": "WorkspaceNotCfg"
                      },
                      {
                        "type": 11,
                        "content": {
                          "version": "LinkItem/1.0",
                          "style": "list",
                          "links": [
                            {
                              "id": "198f4bff-91ba-45e4-a622-e15abcf10ece",
                              "linkTarget": "ArmTemplate",
                              "linkLabel": "Configure workspace",
                              "style": "primary",
                              "templateRunContext": {
                                "componentIdSource": "parameter",
                                "componentId": "wvdworkspace",
                                "templateUriSource": "static",
                                "templateUri": "Community-Workbooks/Windows Virtual Desktop/templates/avdworkspacediag.armtemplate",
                                "templateParameters": [
                                  {
                                    "name": "workspaceName",
                                    "source": "static",
                                    "value": "{wvdworkspace:name}",
                                    "kind": "stringValue"
                                  },
                                  {
                                    "name": "settingName",
                                    "source": "static",
                                    "value": "WVDInsights",
                                    "kind": "stringValue"
                                  },
                                  {
                                    "name": "workspaceId",
                                    "source": "parameter",
                                    "value": "poolWorkspace",
                                    "kind": "stringValue"
                                  }
                                ],
                                "titleSource": "static",
                                "descriptionSource": "static",
                                "description": "**Configure workspace diganostic settings**\r\n\r\nThe workspace will be configured for the following categories:\r\n- Management Activities\r\n- Feed\r\n- Errors\r\n- Checkpoints\r\n",
                                "runLabelSource": "static"
                              }
                            }
                          ]
                        },
                        "conditionalVisibility": {
                          "parameterName": "poolWorkspace",
                          "comparison": "isNotEqualTo"
                        },
                        "name": "configWorkspaceDiagMT"
                      }
                    ]
                  },
                  "conditionalVisibilities": [
                    {
                      "parameterName": "MissingTablesWkspc",
                      "comparison": "isNotEqualTo",
                      "value": "0"
                    },
                    {
                      "parameterName": "wvdworkspacesettings",
                      "comparison": "isNotEqualTo"
                    }
                  ],
                  "name": "WkspcMissingTable",
                  "styleSettings": {
                    "showBorder": true
                  }
                }
              ]
            },
            "name": "WVDWorkspace",
            "styleSettings": {
              "margin": "5px",
              "padding": "5px",
              "showBorder": true
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "configstep",
        "comparison": "isEqualTo",
        "value": "hostpool"
      },
      "name": "CheckHostPool",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "The session hosts are already configured with the Log Analytics extensions.",
              "style": "warning"
            },
            "conditionalVisibility": {
              "parameterName": "laextensions",
              "comparison": "isNotEqualTo",
              "value": "0"
            },
            "name": "LAextensionsWarnings",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "parameters": [
                      {
                        "id": "293dd6b8-45c0-4503-a00c-2ae4a770682d",
                        "version": "KqlParameterItem/1.0",
                        "name": "resourceGroupDCR",
                        "type": 5,
                        "isRequired": true,
                        "query": "{\"version\":\"1.0.0\",\"content\":\"{\\\"value\\\":\\\"{Subscription}/resourceGroups/AzureMonitor-DataCollectionRules\\\", \\\"display\\\":\\\"ddd\\\", \\\"selected\\\":1}\",\"transformers\":null}",
                        "isHiddenWhenLocked": true,
                        "typeSettings": {
                          "additionalResourceOptions": [],
                          "showDefault": false
                        },
                        "queryType": 8
                      },
                      {
                        "id": "83beb348-6334-460e-9428-0e41659f4ad1",
                        "version": "KqlParameterItem/1.0",
                        "name": "dcrResourceGroup",
                        "type": 2,
                        "query": "resourcecontainers\r\n| where name =~ \"AzureMonitor-DataCollectionRules\"\r\n| summarize count()\r\n| project count_, disp=count_, selected=1\r\n",
                        "crossComponentResources": [
                          "{Subscription}"
                        ],
                        "isHiddenWhenLocked": true,
                        "typeSettings": {
                          "additionalResourceOptions": [],
                          "showDefault": false
                        },
                        "queryType": 1,
                        "resourceType": "microsoft.resourcegraph/resources"
                      },
                      {
                        "id": "cf133e2b-12bd-487d-810b-fa12642c84a6",
                        "version": "KqlParameterItem/1.0",
                        "name": "rgLocation",
                        "type": 2,
                        "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"/subscriptions/{Subscription:id}/resourcegroups/{ResourceGroup}?api-version=2021-04-01\",\"urlParams\":[],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"columns\":[{\"path\":\"$.location\",\"columnid\":\"Location\"},{\"path\":\"$.location\",\"columnid\":\"Disp\"},{\"path\":\"$.location\",\"columnid\":\"Selecte\"}]}}]}",
                        "isHiddenWhenLocked": true,
                        "typeSettings": {
                          "additionalResourceOptions": [],
                          "showDefault": false
                        },
                        "queryType": 12
                      }
                    ],
                    "style": "pills",
                    "queryType": 8
                  },
                  "name": "parameters_LAconfig"
                },
                {
                  "type": 12,
                  "content": {
                    "version": "NotebookGroup/1.0",
                    "groupType": "editable",
                    "items": [
                      {
                        "type": 1,
                        "content": {
                          "json": "A resource group needs to be created for the data collection rules."
                        },
                        "name": "text - 1"
                      },
                      {
                        "type": 11,
                        "content": {
                          "version": "LinkItem/1.0",
                          "style": "list",
                          "links": [
                            {
                              "id": "97ff0c6f-ac40-4f70-b8c9-2adf2aa9d3c0",
                              "linkTarget": "ArmAction",
                              "linkLabel": "Create a resource group",
                              "style": "primary",
                              "armActionContext": {
                                "path": "/subscriptions/{Subscription:id}/resourcegroups/AzureMonitor-DataCollectionRules?api-version=2021-04-01",
                                "headers": [],
                                "params": [],
                                "body": "{\r\n    \"location\": \"{rgLocation}\"\r\n}\r\n",
                                "httpMethod": "PUT",
                                "title": "Create resource group for DCRs",
                                "description": "The resource group **AzureMonitor-DataCollectionRules** will be created on the subscription {Subscription:label}.",
                                "actionName": "DCR resource group",
                                "runLabel": "Create resource group"
                              }
                            }
                          ]
                        },
                        "name": "DeploydcrResourceGroup "
                      }
                    ]
                  },
                  "conditionalVisibility": {
                    "parameterName": "dcrResourceGroup",
                    "comparison": "isEqualTo",
                    "value": "0"
                  },
                  "name": "CreateDcrResourceGroup",
                  "styleSettings": {
                    "showBorder": true
                  }
                },
                {
                  "type": 12,
                  "content": {
                    "version": "NotebookGroup/1.0",
                    "groupType": "editable",
                    "title": "Data collection rule",
                    "expandable": true,
                    "expanded": true,
                    "items": [
                      {
                        "type": 12,
                        "content": {
                          "version": "NotebookGroup/1.0",
                          "groupType": "editable",
                          "title": "Create DCR",
                          "items": [
                            {
                              "type": 9,
                              "content": {
                                "version": "KqlParameterItem/1.0",
                                "crossComponentResources": [
                                  "value::selected"
                                ],
                                "parameters": [
                                  {
                                    "id": "a916b7ba-7d5c-4fea-bd1e-def3bf93f0b9",
                                    "version": "KqlParameterItem/1.0",
                                    "name": "LAfromDCR",
                                    "type": 1,
                                    "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"{assignedDCR:id}\",\"urlParams\":[],\"batchDisabled\":false,\"transformers\":null}",
                                    "isHiddenWhenLocked": true,
                                    "timeContext": {
                                      "durationMs": 86400000
                                    },
                                    "queryType": 12
                                  },
                                  {
                                    "id": "56179fe0-b557-422b-b4e5-7f082eb9a1e3",
                                    "version": "KqlParameterItem/1.0",
                                    "name": "currentLA",
                                    "type": 1,
                                    "isHiddenWhenLocked": true,
                                    "criteriaData": [
                                      {
                                        "criteriaContext": {
                                          "leftOperand": "assignedDCR",
                                          "operator": "isNotNull",
                                          "rightValType": "param",
                                          "resultValType": "param",
                                          "resultVal": "LAfromDCR"
                                        }
                                      },
                                      {
                                        "criteriaContext": {
                                          "operator": "Default",
                                          "resultValType": "static",
                                          "resultVal": "not_set"
                                        }
                                      }
                                    ],
                                    "timeContext": {
                                      "durationMs": 86400000
                                    }
                                  },
                                  {
                                    "id": "4de041d9-ab34-4113-b7b3-ec486d5aaae6",
                                    "version": "KqlParameterItem/1.0",
                                    "name": "dcrDestination",
                                    "label": "Workspace destination",
                                    "type": 5,
                                    "query": "resources\r\n| where type =~ \"Microsoft.OperationalInsights/workspaces\"\r\n| project id, disp=id, selected= id == \"{currentLA}\"",
                                    "crossComponentResources": [
                                      "value::all"
                                    ],
                                    "typeSettings": {
                                      "additionalResourceOptions": [],
                                      "showDefault": false
                                    },
                                    "timeContext": {
                                      "durationMs": 86400000
                                    },
                                    "queryType": 1,
                                    "resourceType": "microsoft.resourcegraph/resources",
                                    "value": null
                                  },
                                  {
                                    "id": "f34ef667-5737-49ec-822b-0bd7b029210f",
                                    "version": "KqlParameterItem/1.0",
                                    "name": "dcrDestLocation",
                                    "type": 1,
                                    "isRequired": true,
                                    "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"{dcrDestination}?api-version=2021-12-01-preview\",\"urlParams\":[],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"columns\":[{\"path\":\"$.location\",\"columnid\":\"Location\"}]}}]}",
                                    "isHiddenWhenLocked": true,
                                    "timeContext": {
                                      "durationMs": 86400000
                                    },
                                    "queryType": 12
                                  },
                                  {
                                    "id": "83dda60b-d704-40fa-9765-f8ccf82dea2a",
                                    "version": "KqlParameterItem/1.0",
                                    "name": "dcrList",
                                    "type": 1,
                                    "isRequired": true,
                                    "query": "resources\r\n| where resourceGroup =~ \"AzureMonitor-DataCollectionRules\"\r\n| where type =~\"Microsoft.Insights/dataCollectionRules\"\r\n| project DCR=id, [\"LA workspace\"]=properties.destinations.logAnalytics[0].workspaceResourceId, subscriptionId\r\n| join kind=inner (\r\n        resourcecontainers\r\n        | where type == \"microsoft.resources/subscriptions\"\r\n        | project subscriptionId, subscription=id\r\n        ) on subscriptionId\r\n|project strcat('{\"dcr\":\"',DCR, '\", \"workspace\":\"', [\"LA workspace\"],\r\n    '\", \"sub\":\"', subscription,'\"}')\r\n\r\n\r\n\r\n",
                                    "crossComponentResources": [
                                      "value::selected"
                                    ],
                                    "isHiddenWhenLocked": true,
                                    "queryType": 1,
                                    "resourceType": "microsoft.resourcegraph/resources"
                                  },
                                  {
                                    "id": "d89d17f0-afca-4732-bfb6-a0bc1c62ed8c",
                                    "version": "KqlParameterItem/1.0",
                                    "name": "dcrListCriteria",
                                    "type": 1,
                                    "isHiddenWhenLocked": true,
                                    "criteriaData": [
                                      {
                                        "criteriaContext": {
                                          "leftOperand": "dcrList",
                                          "operator": "is Empty",
                                          "rightValType": "param",
                                          "resultValType": "static",
                                          "resultVal": "[]"
                                        }
                                      },
                                      {
                                        "criteriaContext": {
                                          "operator": "Default",
                                          "resultValType": "static",
                                          "resultVal": "{dcrList}"
                                        }
                                      }
                                    ]
                                  }
                                ],
                                "style": "pills",
                                "queryType": 1,
                                "resourceType": "microsoft.resourcegraph/resources"
                              },
                              "name": "DCRparameters"
                            },
                            {
                              "type": 3,
                              "content": {
                                "version": "KqlItem/1.0",
                                "query": "{\"version\":\"1.0.0\",\"content\":\"{dcrListCriteria}\",\"transformers\":null}",
                                "size": 4,
                                "title": "Available DCRs",
                                "queryType": 8,
                                "gridSettings": {
                                  "labelSettings": [
                                    {
                                      "columnId": "dcr",
                                      "label": "DCR"
                                    },
                                    {
                                      "columnId": "workspace",
                                      "label": "LA workspace"
                                    },
                                    {
                                      "columnId": "sub",
                                      "label": "Subscription"
                                    }
                                  ]
                                }
                              },
                              "name": "query - 4"
                            },
                            {
                              "type": 12,
                              "content": {
                                "version": "NotebookGroup/1.0",
                                "groupType": "editable",
                                "items": [
                                  {
                                    "type": 1,
                                    "content": {
                                      "json": "To create a new DCR, select the Log Analytics workspace destination and click **Create data collection rule**."
                                    },
                                    "name": "text - 0"
                                  },
                                  {
                                    "type": 11,
                                    "content": {
                                      "version": "LinkItem/1.0",
                                      "style": "list",
                                      "links": [
                                        {
                                          "id": "049f980d-f0d8-41d1-aadb-7991881191d5",
                                          "linkTarget": "ArmTemplate",
                                          "linkLabel": "Create data collection rule",
                                          "style": "primary",
                                          "templateRunContext": {
                                            "componentIdSource": "parameter",
                                            "componentId": "resourceGroupDCR",
                                            "templateUriSource": "static",
                                            "templateUri": "Community-Workbooks/Windows Virtual Desktop/templates/createdcr1.armtemplate",
                                            "templateParameters": [
                                              {
                                                "name": "dcrName",
                                                "source": "static",
                                                "value": "microsoft-avdi-{dcrDestLocation}",
                                                "kind": "stringValue"
                                              },
                                              {
                                                "name": "dcrLocation",
                                                "source": "parameter",
                                                "value": "dcrDestLocation",
                                                "kind": "stringValue"
                                              },
                                              {
                                                "name": "workspaceId",
                                                "source": "parameter",
                                                "value": "dcrDestination",
                                                "kind": "stringValue"
                                              }
                                            ],
                                            "titleSource": "static",
                                            "descriptionSource": "static",
                                            "runLabelSource": "static"
                                          }
                                        }
                                      ]
                                    },
                                    "conditionalVisibility": {
                                      "parameterName": "dcrResourceGroup",
                                      "comparison": "isNotEqualTo"
                                    },
                                    "name": "Deploydcr"
                                  }
                                ]
                              },
                              "conditionalVisibility": {
                                "parameterName": "WorkspaceAMA",
                                "comparison": "isEqualTo"
                              },
                              "name": "DCRNotConfigured"
                            }
                          ],
                          "exportParameters": true
                        },
                        "name": "CreateDCR",
                        "styleSettings": {
                          "showBorder": true
                        }
                      },
                      {
                        "type": 9,
                        "content": {
                          "version": "KqlParameterItem/1.0",
                          "parameters": [
                            {
                              "id": "a6c434b8-c7dd-4388-a673-2c3170a1a265",
                              "version": "KqlParameterItem/1.0",
                              "name": "defaultDCR",
                              "type": 1,
                              "isRequired": true,
                              "isHiddenWhenLocked": true,
                              "criteriaData": [
                                {
                                  "criteriaContext": {
                                    "leftOperand": "assignedDCR",
                                    "operator": "isNotNull",
                                    "rightValType": "param",
                                    "resultValType": "param",
                                    "resultVal": "assignedDCR"
                                  }
                                },
                                {
                                  "criteriaContext": {
                                    "operator": "Default",
                                    "resultValType": "static",
                                    "resultVal": "fakeId"
                                  }
                                }
                              ],
                              "timeContext": {
                                "durationMs": 86400000
                              }
                            },
                            {
                              "id": "4c77dcb3-5543-40bf-9817-9065eac1cff6",
                              "version": "KqlParameterItem/1.0",
                              "name": "SelectedDCR",
                              "label": "Selected DCR",
                              "type": 5,
                              "isRequired": true,
                              "query": "{\"version\":\"1.0.0\",\"content\":\"{dcrList}\",\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"columns\":[{\"path\":\"$.dcr\",\"columnid\":\"dcr\"},{\"path\":\"$.dcr\",\"columnid\":\"disl\"},{\"path\":\"$.dcr\",\"columnid\":\"selected\",\"substringRegexMatch\":\"^({defaultDCR})|.*\",\"substringReplace\":\"$1\"}]}}]}",
                              "typeSettings": {
                                "additionalResourceOptions": [],
                                "showDefault": false
                              },
                              "timeContext": {
                                "durationMs": 86400000
                              },
                              "queryType": 8
                            }
                          ],
                          "style": "pills",
                          "queryType": 8
                        },
                        "name": "SelectDCRparameters"
                      },
                      {
                        "type": 1,
                        "content": {
                          "json": "Please select a DCR.",
                          "style": "warning"
                        },
                        "conditionalVisibility": {
                          "parameterName": "SelectedDCR",
                          "comparison": "isEqualTo"
                        },
                        "name": "NoDCRSelected"
                      },
                      {
                        "type": 12,
                        "content": {
                          "version": "NotebookGroup/1.0",
                          "groupType": "editable",
                          "title": "DCR associations",
                          "items": [
                            {
                              "type": 9,
                              "content": {
                                "version": "KqlParameterItem/1.0",
                                "crossComponentResources": [
                                  "{poolla}"
                                ],
                                "parameters": [
                                  {
                                    "id": "32478e20-266f-49f3-9f00-0d645d824d01",
                                    "version": "KqlParameterItem/1.0",
                                    "name": "assocResources",
                                    "type": 2,
                                    "isRequired": true,
                                    "multiSelect": true,
                                    "quote": "'",
                                    "delimiter": ",",
                                    "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GETARRAY\",\"path\":\"{SelectedDCR:Id}/associations?api-version=2021-04-01\",\"urlParams\":[],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"columns\":[{\"path\":\"$.id\",\"columnid\":\"id\",\"substringRegexMatch\":\"(.+)/providers/microsoft.insights/datacollectionruleassociations/(.*)\",\"substringReplace\":\"$1\"},{\"path\":\"$.id\",\"columnid\":\"disp\"},{\"path\":\"$.id\",\"columnid\":\"selected\"}]}}]}",
                                    "isHiddenWhenLocked": true,
                                    "typeSettings": {
                                      "additionalResourceOptions": [],
                                      "showDefault": false
                                    },
                                    "timeContext": {
                                      "durationMs": 86400000
                                    },
                                    "queryType": 12
                                  },
                                  {
                                    "id": "76e19626-a6b8-4e01-b69a-9e257e510ee5",
                                    "version": "KqlParameterItem/1.0",
                                    "name": "assocCriteria",
                                    "type": 1,
                                    "isRequired": true,
                                    "isHiddenWhenLocked": true,
                                    "criteriaData": [
                                      {
                                        "criteriaContext": {
                                          "leftOperand": "assocResources",
                                          "operator": "is Empty",
                                          "rightValType": "param",
                                          "resultValType": "static",
                                          "resultVal": "'fakeid'"
                                        }
                                      },
                                      {
                                        "criteriaContext": {
                                          "operator": "Default",
                                          "resultValType": "static",
                                          "resultVal": "{assocResources}"
                                        }
                                      }
                                    ]
                                  },
                                  {
                                    "id": "9d4e0989-baa3-42fe-a665-b1f9e8c48ea1",
                                    "version": "KqlParameterItem/1.0",
                                    "name": "missingAssociations",
                                    "type": 5,
                                    "multiSelect": true,
                                    "quote": "\"",
                                    "delimiter": ",",
                                    "query": "let sessionHosts = datatable(shId:string) [{WVDHosts}];\r\nlet associations = datatable(shId:string) [{assocCriteria}];\r\nsessionHosts\r\n| project shId = tolower(shId)\r\n|join kind=leftanti (associations| project shId= tolower(shId)) on shId\r\n| project name=trim_start(\".+machines/\",shId), disp=shId, selected=1\r\n",
                                    "crossComponentResources": [
                                      "{poolla}"
                                    ],
                                    "isHiddenWhenLocked": true,
                                    "typeSettings": {
                                      "additionalResourceOptions": [],
                                      "showDefault": false
                                    },
                                    "queryType": 0,
                                    "resourceType": "microsoft.operationalinsights/workspaces"
                                  }
                                ],
                                "style": "pills",
                                "queryType": 0,
                                "resourceType": "microsoft.operationalinsights/workspaces"
                              },
                              "name": "parameters - 0"
                            },
                            {
                              "type": 1,
                              "content": {
                                "json": "No session hosts with missing associations found.",
                                "style": "success"
                              },
                              "conditionalVisibility": {
                                "parameterName": "missingAssociations",
                                "comparison": "isEqualTo"
                              },
                              "name": "AssociationsOk"
                            },
                            {
                              "type": 12,
                              "content": {
                                "version": "NotebookGroup/1.0",
                                "groupType": "editable",
                                "items": [
                                  {
                                    "type": 3,
                                    "content": {
                                      "version": "KqlItem/1.0",
                                      "query": "let sessionHosts = datatable(shId:string) [{WVDHosts}];\r\nlet associations = datatable(shId:string) [{assocCriteria}];\r\nsessionHosts\r\n| project shId = tolower(shId)\r\n|join kind=leftanti (associations| project shId= tolower(shId)) on shId\r\n| project ID=shId",
                                      "size": 0,
                                      "title": "The following session hosts do not have the correct DCR associations",
                                      "timeContext": {
                                        "durationMs": 86400000
                                      },
                                      "queryType": 0,
                                      "resourceType": "microsoft.operationalinsights/workspaces",
                                      "crossComponentResources": [
                                        "{poolla}"
                                      ],
                                      "gridSettings": {
                                        "labelSettings": [
                                          {
                                            "columnId": "ID",
                                            "label": "Session host"
                                          }
                                        ]
                                      }
                                    },
                                    "name": "MissingAssociationsSH"
                                  },
                                  {
                                    "type": 11,
                                    "content": {
                                      "version": "LinkItem/1.0",
                                      "style": "list",
                                      "links": [
                                        {
                                          "id": "23c6abc3-78a5-46e0-beb5-13c7942c7f75",
                                          "linkTarget": "ArmTemplate",
                                          "linkLabel": "Deploy Association",
                                          "style": "primary",
                                          "templateRunContext": {
                                            "componentIdSource": "parameter",
                                            "componentId": "WVDHosts",
                                            "templateUriSource": "static",
                                            "templateUri": "Community-Workbooks/Windows Virtual Desktop/templates/addassociation.armtemplate",
                                            "templateParameters": [
                                              {
                                                "name": "virtualMachines",
                                                "source": "parameter",
                                                "value": "missingAssociations",
                                                "kind": "stringValue"
                                              },
                                              {
                                                "name": "associationName",
                                                "source": "static",
                                                "value": "microsoft-avdi",
                                                "kind": "stringValue"
                                              },
                                              {
                                                "name": "dataCollectionRuleId",
                                                "source": "parameter",
                                                "value": "SelectedDCR",
                                                "kind": "stringValue"
                                              },
                                              {
                                                "name": "resourceType",
                                                "source": "static",
                                                "value": "{OneWVDHost:resourceType}",
                                                "kind": "stringValue"
                                              }
                                            ],
                                            "titleSource": "static",
                                            "descriptionSource": "static",
                                            "description": "{missingAssociations:label}",
                                            "runLabelSource": "static"
                                          }
                                        }
                                      ]
                                    },
                                    "name": "links - 1"
                                  }
                                ]
                              },
                              "conditionalVisibility": {
                                "parameterName": "missingAssociations",
                                "comparison": "isNotEqualTo"
                              },
                              "name": "MissingAssociationGroup"
                            }
                          ]
                        },
                        "conditionalVisibility": {
                          "parameterName": "SelectedDCR",
                          "comparison": "isNotEqualTo"
                        },
                        "name": "DcrAssociation",
                        "styleSettings": {
                          "showBorder": true
                        }
                      }
                    ]
                  },
                  "conditionalVisibility": {
                    "parameterName": "dcrResourceGroup",
                    "comparison": "isNotEqualTo",
                    "value": "0"
                  },
                  "name": "DCRConfig",
                  "styleSettings": {
                    "showBorder": true
                  }
                }
              ]
            },
            "name": "DCRGroup"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Session hosts missing Azure Monitor extension",
              "items": [
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "parameters": [
                      {
                        "id": "9326571c-bfd2-4a61-91da-8db0fea9495a",
                        "version": "KqlParameterItem/1.0",
                        "name": "NoExtensionVms",
                        "type": 1,
                        "isRequired": true,
                        "query": "resources\r\n| where id in~ ({WVDHosts})\r\n| project id=tolower(id), name, location\r\n| join kind=leftouter (\r\nresources\r\n| where (type =~ \"Microsoft.Compute/virtualMachines/extensions\" or type =~\"microsoft.hybridcompute/machines\") and properties.type == \"AzureMonitorWindowsAgent\"\r\n| project vmname = tolower(extract(\"(.*?)/extension\", 1, id)),extname=name\r\n) on $left.id == $right.vmname\r\n| where isempty(vmname)\r\n| order by id\r\n| project id, name, extensionName=iif(isempty(extname), \"AzureMonitorWindowsAgent\", extname),location\r\n| project strcat('{\"id\":\"',id,\r\n    '\",\"name\":\"', name,\r\n    '\",\"extensionName\":\"', extensionName,\r\n    '\",\"location\":\"',location, '\"}')\r\n    , dist=name,selected=1",
                        "crossComponentResources": [
                          "value::all"
                        ],
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                          "durationMs": 0
                        },
                        "queryType": 1,
                        "resourceType": "microsoft.resourcegraph/resources"
                      },
                      {
                        "id": "9f08d968-d7d5-4c76-8f8d-69e7700ccc81",
                        "version": "KqlParameterItem/1.0",
                        "name": "VmNames",
                        "type": 2,
                        "isRequired": true,
                        "multiSelect": true,
                        "quote": "'",
                        "delimiter": ",",
                        "query": "{\"version\":\"1.0.0\",\"content\":\"{NoExtensionVms}\",\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"columns\":[{\"path\":\"$.name\",\"columnid\":\"Name\",\"columnType\":\"string\"},{\"path\":\"$.name\",\"columnid\":\"Disp\",\"columnType\":\"string\"},{\"path\":\"$.name\",\"columnid\":\"Selected\",\"columnType\":\"long\",\"substringRegexMatch\":\",*\",\"substringReplace\":\"1\"}]}}]}",
                        "isHiddenWhenLocked": true,
                        "typeSettings": {
                          "additionalResourceOptions": [],
                          "showDefault": false
                        },
                        "timeContext": {
                          "durationMs": 0
                        },
                        "queryType": 8
                      },
                      {
                        "id": "a98f5f1c-2833-49cf-a5e2-bd790c072add",
                        "version": "KqlParameterItem/1.0",
                        "name": "ExtensionNames",
                        "type": 2,
                        "isRequired": true,
                        "multiSelect": true,
                        "quote": "'",
                        "delimiter": ",",
                        "query": "{\"version\":\"1.0.0\",\"content\":\"{NoExtensionVms}\",\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"columns\":[{\"path\":\"$.extensionName\",\"columnid\":\"extName\",\"columnType\":\"string\"},{\"path\":\"$.extensionName\",\"columnid\":\"disp\",\"columnType\":\"string\"},{\"path\":\"$.extensionName\",\"columnid\":\"selected\",\"columnType\":\"long\",\"substringRegexMatch\":\".*\",\"substringReplace\":\"1\"}]}}]}",
                        "isHiddenWhenLocked": true,
                        "typeSettings": {
                          "additionalResourceOptions": [],
                          "showDefault": false
                        },
                        "timeContext": {
                          "durationMs": 0
                        },
                        "queryType": 8
                      },
                      {
                        "id": "89d0e55d-430e-434c-bf9a-ca7a508d8035",
                        "version": "KqlParameterItem/1.0",
                        "name": "vmlocations",
                        "type": 2,
                        "isRequired": true,
                        "multiSelect": true,
                        "quote": "'",
                        "delimiter": ",",
                        "query": "{\"version\":\"1.0.0\",\"content\":\"{NoExtensionVms}\",\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"columns\":[{\"path\":\"$.location\",\"columnid\":\"location\",\"columnType\":\"string\"},{\"path\":\"$.location\",\"columnid\":\"disp\",\"columnType\":\"string\"},{\"path\":\"$.location\",\"columnid\":\"selected\",\"columnType\":\"long\",\"substringRegexMatch\":\".*\",\"substringReplace\":\"1\"}]}}]}",
                        "isHiddenWhenLocked": true,
                        "typeSettings": {
                          "additionalResourceOptions": [],
                          "showDefault": false
                        },
                        "queryType": 8
                      },
                      {
                        "id": "98bbe2fb-79ac-4004-b57b-e665fe4ef715",
                        "version": "KqlParameterItem/1.0",
                        "name": "VmIds",
                        "type": 5,
                        "isRequired": true,
                        "multiSelect": true,
                        "quote": "'",
                        "delimiter": ",",
                        "query": "{\"version\":\"1.0.0\",\"content\":\"{NoExtensionVms}\",\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"columns\":[{\"path\":\"$.id\",\"columnid\":\"id\"},{\"path\":\"$.id\",\"columnid\":\"disp\"},{\"path\":\"$.id\",\"columnid\":\"selected\"}]}}]}",
                        "isHiddenWhenLocked": true,
                        "typeSettings": {
                          "additionalResourceOptions": [],
                          "showDefault": false
                        },
                        "queryType": 8
                      }
                    ],
                    "style": "pills",
                    "queryType": 8
                  },
                  "name": "parameters_workspacecheck"
                },
                {
                  "type": 12,
                  "content": {
                    "version": "NotebookGroup/1.0",
                    "groupType": "editable",
                    "items": [
                      {
                        "type": 1,
                        "content": {
                          "json": "Some hosts on the host pool do not have the Azure Monitor agent installed.\r\nSelect **Add extension** to add deploy the Azure Monitor extension to the session hosts.\r\n\r\nAfter the deployment is completed, to check the status of session hosts refresh the workbook by selecting the refresh button at the top of the workbook."
                        },
                        "name": "TextAMAMissing"
                      },
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "{\"version\":\"1.0.0\",\"content\":\"{NoExtensionVms}\",\"transformers\":null}",
                          "size": 1,
                          "noDataMessage": "There are not session hosts missing the AMA extenstion.",
                          "noDataMessageStyle": 3,
                          "queryType": 8,
                          "gridSettings": {
                            "formatters": [
                              {
                                "columnMatch": "id",
                                "formatter": 13,
                                "formatOptions": {
                                  "linkTarget": null,
                                  "showIcon": true
                                }
                              },
                              {
                                "columnMatch": "name",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "extensionName",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "location",
                                "formatter": 5
                              }
                            ]
                          }
                        },
                        "name": "query missing LA"
                      },
                      {
                        "type": 11,
                        "content": {
                          "version": "LinkItem/1.0",
                          "style": "list",
                          "links": [
                            {
                              "id": "6bcd709a-7304-4511-8bab-a14094ebb4c0",
                              "linkTarget": "ArmTemplate",
                              "linkLabel": "Add extension",
                              "style": "primary",
                              "templateRunContext": {
                                "componentIdSource": "parameter",
                                "componentId": "VmIds",
                                "templateUriSource": "static",
                                "templateUri": "Community-Workbooks/Windows Virtual Desktop/templates/amaextension.armtemplate",
                                "templateParameters": [
                                  {
                                    "name": "virtualMachines",
                                    "source": "parameter",
                                    "value": "VmNames",
                                    "kind": "stringValue"
                                  },
                                  {
                                    "name": "extensionNames",
                                    "source": "parameter",
                                    "value": "ExtensionNames",
                                    "kind": "stringValue"
                                  },
                                  {
                                    "name": "vmLocations",
                                    "source": "parameter",
                                    "value": "vmlocations",
                                    "kind": "stringValue"
                                  },
                                  {
                                    "name": "resourceType",
                                    "source": "static",
                                    "value": "{OneWVDHost:resourceType}",
                                    "kind": "stringValue"
                                  }
                                ],
                                "titleSource": "static",
                                "descriptionSource": "static",
                                "description": "We will add the Azure Monitor extension to the following session hosts:  \r\n{VmNames}\r\n\r\nThe configuration workbook only supports installing the Azure Monitor on *running* hosts. Check your host status in the Azure Portal Virtual Machines blade.\r\n\r\nOnly deploying the Azure Monitor agent is not enough to collect data from session hosts. The DCR association also needs to be configured for data collection.",
                                "runLabelSource": "static"
                              }
                            }
                          ]
                        },
                        "name": "DeployAMAExtension"
                      }
                    ]
                  },
                  "conditionalVisibility": {
                    "parameterName": "NoExtensionVms",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "AddVmExtensions"
                },
                {
                  "type": 1,
                  "content": {
                    "json": "No session hosts missing AMA extension.",
                    "style": "success"
                  },
                  "conditionalVisibility": {
                    "parameterName": "NoExtensionVms",
                    "comparison": "isEqualTo"
                  },
                  "name": "TextForNoMissingAMA"
                }
              ]
            },
            "name": "AMAExtension",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Session hosts missing managed identity",
              "items": [
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "parameters": [
                      {
                        "id": "d6de1aa7-8f7c-4694-a22d-6c9783ff5e81",
                        "version": "KqlParameterItem/1.0",
                        "name": "NoIdentityVms",
                        "type": 1,
                        "isRequired": true,
                        "query": "resources\r\n| where id in~ ({WVDHosts})\r\n| project id=tolower(id), name, identity=tostring(identity.type), location\r\n| where isempty(identity) or identity=~ \"none\"\r\n| order by id\r\n| project id, name , location, selected=1\r\n| project strcat('{\"id\":\"',id,\r\n    '\",\"name\":\"', name,\r\n    '\",\"location\":\"',location, '\"}')\r\n    , dist=name,selected=1\r\n\r\n",
                        "crossComponentResources": [
                          "value::all"
                        ],
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                          "durationMs": 0
                        },
                        "queryType": 1
                      },
                      {
                        "id": "66c0fe4b-dfa0-4537-b722-f5c32dec9de3",
                        "version": "KqlParameterItem/1.0",
                        "name": "NoIdentityVMNames",
                        "type": 2,
                        "isRequired": true,
                        "multiSelect": true,
                        "quote": "'",
                        "delimiter": ",",
                        "query": "{\"version\":\"1.0.0\",\"content\":\"{NoIdentityVms}\",\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"columns\":[{\"path\":\"$.name\",\"columnid\":\"name\"},{\"path\":\"$.name\",\"columnid\":\"disp\"},{\"path\":\"$.name\",\"columnid\":\"selected\"}]}}]}",
                        "isHiddenWhenLocked": true,
                        "typeSettings": {
                          "additionalResourceOptions": [],
                          "showDefault": false
                        },
                        "queryType": 8
                      },
                      {
                        "id": "0f6a6e22-3170-4b02-925b-b699957c88c0",
                        "version": "KqlParameterItem/1.0",
                        "name": "NoIdentityvmlocations",
                        "type": 2,
                        "isRequired": true,
                        "multiSelect": true,
                        "quote": "'",
                        "delimiter": ",",
                        "query": "{\"version\":\"1.0.0\",\"content\":\"{NoIdentityVms}\",\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"columns\":[{\"path\":\"$.location\",\"columnid\":\"location\"},{\"path\":\"$.location\",\"columnid\":\"disp\"},{\"path\":\"$.location\",\"columnid\":\"selected\"}]}}]}",
                        "isHiddenWhenLocked": true,
                        "typeSettings": {
                          "additionalResourceOptions": [],
                          "showDefault": false
                        },
                        "queryType": 8
                      },
                      {
                        "id": "9b488b0b-e0e0-4c99-bb93-0a29eff226f2",
                        "version": "KqlParameterItem/1.0",
                        "name": "NoIdentityvmIds",
                        "type": 5,
                        "isRequired": true,
                        "multiSelect": true,
                        "quote": "'",
                        "delimiter": ",",
                        "query": "{\"version\":\"1.0.0\",\"content\":\"{NoIdentityVms}\",\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"columns\":[{\"path\":\"$.id\",\"columnid\":\"id\"},{\"path\":\"$.id\",\"columnid\":\"disp\"},{\"path\":\"$.id\",\"columnid\":\"selectes\"}]}}]}",
                        "isHiddenWhenLocked": true,
                        "typeSettings": {
                          "additionalResourceOptions": []
                        },
                        "queryType": 8
                      }
                    ],
                    "style": "pills",
                    "queryType": 8
                  },
                  "name": "parameters_identitycheck"
                },
                {
                  "type": 12,
                  "content": {
                    "version": "NotebookGroup/1.0",
                    "groupType": "editable",
                    "items": [
                      {
                        "type": 1,
                        "content": {
                          "json": "Some hosts on the host pool do not have a system managed identity.\r\nSelect **Add system managed identiry** to add system managed identity to the session hosts.\r\n\r\nAfter the deployment is completed, refresh the workbook by selecting the refresh button on the top."
                        },
                        "name": "TextMSIMissing"
                      },
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "{\"version\":\"1.0.0\",\"content\":\"{NoIdentityVms}\",\"transformers\":null}",
                          "size": 1,
                          "noDataMessage": "There are not session hosts missing the AMA extenstion.",
                          "noDataMessageStyle": 3,
                          "queryType": 8,
                          "gridSettings": {
                            "formatters": [
                              {
                                "columnMatch": "id",
                                "formatter": 13,
                                "formatOptions": {
                                  "linkTarget": null,
                                  "showIcon": true
                                }
                              },
                              {
                                "columnMatch": "name",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "location",
                                "formatter": 5
                              }
                            ]
                          }
                        },
                        "name": "MissingMSI"
                      },
                      {
                        "type": 11,
                        "content": {
                          "version": "LinkItem/1.0",
                          "style": "list",
                          "links": [
                            {
                              "id": "068db6bb-d253-41f6-934f-e8470b7ec69b",
                              "linkTarget": "ArmTemplate",
                              "linkLabel": "Add system managed identity",
                              "style": "primary",
                              "templateRunContext": {
                                "componentIdSource": "parameter",
                                "componentId": "NoIdentityvmIds",
                                "templateUriSource": "static",
                                "templateUri": "Community-Workbooks/Windows Virtual Desktop/templates/addmsi.armtemplate",
                                "templateParameters": [
                                  {
                                    "name": "virtualMachines",
                                    "source": "parameter",
                                    "value": "NoIdentityVMNames",
                                    "kind": "stringValue"
                                  },
                                  {
                                    "name": "vmLocations",
                                    "source": "parameter",
                                    "value": "NoIdentityvmlocations",
                                    "kind": "stringValue"
                                  },
                                  {
                                    "name": "resourceType",
                                    "source": "static",
                                    "value": "{OneWVDHost:resourceType}",
                                    "kind": "stringValue"
                                  }
                                ],
                                "titleSource": "static",
                                "descriptionSource": "static",
                                "description": "We will configure system managed identities on the session hosts without any managed identity.",
                                "runLabelSource": "static",
                                "runLabel": "Add system managed identity"
                              }
                            }
                          ]
                        },
                        "name": "DeployMSI"
                      }
                    ]
                  },
                  "conditionalVisibility": {
                    "parameterName": "NoIdentityVms",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "AddVmMSI"
                },
                {
                  "type": 1,
                  "content": {
                    "json": "No session hosts missing manged identity.",
                    "style": "success"
                  },
                  "conditionalVisibility": {
                    "parameterName": "NoIdentityVms",
                    "comparison": "isEqualTo"
                  },
                  "name": "TxtForNoMissingMSI"
                }
              ]
            },
            "name": "VMIdentity",
            "styleSettings": {
              "showBorder": true
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "configstep",
        "comparison": "isEqualTo",
        "value": "sessionhost"
      },
      "name": "LAConfig",
      "styleSettings": {
        "margin": "5px",
        "padding": "5px",
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "crossComponentResources": [
                "{laworkspaces}"
              ],
              "parameters": [
                {
                  "id": "cd2c2498-f37e-4592-9f97-8c2462674cab",
                  "version": "KqlParameterItem/1.0",
                  "name": "WVDHost2",
                  "label": "Hosts",
                  "type": 5,
                  "isRequired": true,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"/subscriptions/{Subscription:id}/resourcegroups/{ResourceGroup}/providers/Microsoft.DesktopVirtualization/hostpools/{HostPool:label}/sessionhosts?api-version=2019-01-23-preview\",\"urlParams\":[{\"key\":\"\",\"value\":\"\"}],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.value\",\"columns\":[{\"path\":\"$.name\",\"columnid\":\"Name\"},{\"path\":\"$.properties.resourceId\",\"columnid\":\"Label\"}]}}]}",
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 0
                  },
                  "defaultValue": "value::all",
                  "queryType": 12
                },
                {
                  "id": "fed9cdb5-5a85-47a1-80ba-c1a276e0c13b",
                  "version": "KqlParameterItem/1.0",
                  "name": "TimeRange",
                  "type": 4,
                  "isRequired": true,
                  "value": {
                    "durationMs": 172800000
                  },
                  "typeSettings": {
                    "selectableValues": [
                      {
                        "durationMs": 300000
                      },
                      {
                        "durationMs": 900000
                      },
                      {
                        "durationMs": 1800000
                      },
                      {
                        "durationMs": 3600000
                      },
                      {
                        "durationMs": 14400000
                      },
                      {
                        "durationMs": 43200000
                      },
                      {
                        "durationMs": 86400000
                      },
                      {
                        "durationMs": 172800000
                      },
                      {
                        "durationMs": 259200000
                      },
                      {
                        "durationMs": 604800000
                      },
                      {
                        "durationMs": 1209600000
                      },
                      {
                        "durationMs": 2419200000
                      },
                      {
                        "durationMs": 2592000000
                      }
                    ],
                    "allowCustom": false
                  },
                  "timeContext": {
                    "durationMs": 0
                  }
                },
                {
                  "id": "725fcb3a-b376-422e-b7a8-99c91996a95e",
                  "version": "KqlParameterItem/1.0",
                  "name": "CalcHostData",
                  "type": 9,
                  "isRequired": true,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "query": "let WVDHosts = dynamic([{WVDHost2}]);\nPerf\n| where TimeGenerated > ago(1d)\n| extend HostPool = '{HostPool:label}'\n| extend ComputerName = strcat(HostPool, \"/\", Computer)\n| where ComputerName in~ (WVDHosts)\n| extend PerfCounter = strcat(ObjectName, \":\", CounterName)\n| summarize PerfCounter_MBs=sum(_BilledSize)/(1024*1024), HostCount=dcount(ComputerName)\n| extend Category = 'Total'\n| join (\nEvent\n| where TimeGenerated > ago(1d)\n| extend HostPool = '{HostPool:label}'\n| extend ComputerName = strcat(HostPool, \"/\", Computer)\n| where ComputerName in~ (WVDHosts)\n| summarize Events_MBs=sum(_BilledSize)/(1024*1024)\n| extend Category = 'Total'\n) on Category\n| project Category, Events_MBs, PerfCounter_MBs, HostCount\n",
                  "crossComponentResources": [
                    "{laworkspaces}"
                  ],
                  "isHiddenWhenLocked": true,
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "value": [
                    "Total"
                  ]
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "parameters_data"
          },
          {
            "type": 1,
            "content": {
              "json": "Once you've configured your environment settings, use this section to monitor your data ingestion. You are responsible for Log Analytics charges for data storage and ingestion. <br>To learn more about cost expectations and how to adjust your settings to manage ingestion and storage, see [estimate Azure Monitor costs](https://docs.microsoft.com/en-us/azure/virtual-desktop/azure-monitor-costs). <br>Configuration changes may take time to generate a difference in the amount of data being displayed below.",
              "style": "info"
            },
            "name": "TimeDurationMessage"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let WVDHosts = dynamic([{WVDHost2}]);\r\nlet AVDData=WVDCheckpoints\r\n    | where _ResourceId =~ '{HostPool}' or _ResourceId =~ '{wvdworkspace}'\r\n| union  (\r\n    WVDConnections\r\n    | where _ResourceId =~ '{HostPool}'\r\n), (\r\n    WVDErrors\r\n    | where _ResourceId =~ '{HostPool}' or _ResourceId =~ '{wvdworkspace}'\r\n), (\r\n    WVDFeeds\r\n    | where _ResourceId =~ '{wvdworkspace}'\r\n), (\r\n    WVDHostRegistrations\r\n    | where _ResourceId =~ '{HostPool}'\r\n), (\r\n    WVDManagement\r\n    | where _ResourceId =~ '{HostPool}' or _ResourceId =~ '{wvdworkspace}'\r\n), (\r\n    WVDAgentHealthStatus\r\n    | where _ResourceId =~ '{HostPool}'\r\n)\r\n| summarize Value=sum(_BilledSize)/(1024*1024)\r\n| project Value, DataSource=\"AVD Diagnostics\";\r\nPerf\r\n| extend HostPool = '{HostPool:label}'\r\n| extend ComputerName = strcat(HostPool, \"/\", Computer)\r\n| where ComputerName in~ (WVDHosts)\r\n| extend PerfCounter = strcat(ObjectName, \":\", CounterName)\r\n| summarize Value=sum(_BilledSize)/(1024*1024)\r\n| project Value, DataSource=\"Perf Counters\" \r\n| union (\r\nEvent\r\n| extend HostPool = '{HostPool:label}'\r\n| extend ComputerName = strcat(HostPool, \"/\", Computer)\r\n| where ComputerName in~ (WVDHosts)\r\n| summarize Value=sum(_BilledSize)/(1024*1024)\r\n| project Value, DataSource=\"Events\"\r\n)\r\n| union AVDData\r\n",
              "size": 0,
              "title": "Billed data over last 24hrs",
              "timeContext": {
                "durationMs": 86400000
              },
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{laworkspaces}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "Perf Counters",
                    "label": "Perf Counters",
                    "color": "orange"
                  },
                  {
                    "seriesName": "Events",
                    "label": "Events",
                    "color": "blue"
                  },
                  {
                    "seriesName": "AVD Diagnostics",
                    "label": "AVD Diagnostics",
                    "color": "green"
                  }
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 4,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true,
                      "maximumSignificantDigits": 3
                    }
                  }
                }
              }
            },
            "customWidth": "0",
            "showPin": false,
            "name": "Billed_Data_PieChart",
            "styleSettings": {
              "padding": "5",
              "maxWidth": "30%"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let WVDHosts = dynamic([{WVDHost2}]);\r\nlet AVDData=WVDCheckpoints\r\n    | where _ResourceId =~ '{HostPool}' or _ResourceId =~ '{wvdworkspace}'\r\n| union  (\r\n    WVDConnections\r\n    | where _ResourceId =~ '{HostPool}'\r\n), (\r\n    WVDErrors\r\n    | where _ResourceId =~ '{HostPool}' or _ResourceId =~ '{wvdworkspace}'\r\n), (\r\n    WVDFeeds\r\n    | where _ResourceId =~ '{wvdworkspace}'\r\n), (\r\n    WVDHostRegistrations\r\n    | where _ResourceId =~ '{HostPool}'\r\n), (\r\n    WVDManagement\r\n    | where _ResourceId =~ '{HostPool}' or _ResourceId =~ '{wvdworkspace}'\r\n), (\r\n    WVDAgentHealthStatus\r\n    | where _ResourceId =~ '{HostPool}'\r\n)\r\n| summarize AVDData_MBs=sum(_BilledSize)/(1024*1024) by bin(TimeGenerated, {TimeRange:grain});\r\nPerf\r\n| extend HostPool = '{HostPool:label}'\r\n| extend ComputerName = strcat(HostPool, \"/\", Computer)\r\n| where ComputerName in~ (WVDHosts)\r\n| extend PerfCounter = strcat(ObjectName, \":\", CounterName)\r\n| summarize PerfCounter_MBs=sum(_BilledSize)/(1024*1024) by bin(TimeGenerated, {TimeRange:grain})\r\n| union (\r\nEvent\r\n| extend HostPool = '{HostPool:label}'\r\n| extend ComputerName = strcat(HostPool, \"/\", Computer)\r\n| where ComputerName in~ (WVDHosts)\r\n| summarize Events_MBs=sum(_BilledSize)/(1024*1024) by bin(TimeGenerated, {TimeRange:grain})\r\n)\r\n| union AVDData\r\n| project TimeGenerated, Events_MBs, PerfCounter_MBs, AVDData_MBs\r\n",
              "size": 0,
              "title": "Billed data over {TimeRange:label}",
              "noDataMessage": "no records found to total",
              "timeContextFromParameter": "TimeRange",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{laworkspaces}"
              ],
              "visualization": "areachart",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Records",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal",
                        "useGrouping": true
                      }
                    }
                  },
                  {
                    "columnMatch": "InstanceNames",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal",
                        "useGrouping": true
                      }
                    }
                  },
                  {
                    "columnMatch": "Bytes",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal",
                        "useGrouping": true
                      }
                    }
                  },
                  {
                    "columnMatch": "Billed_MBytes",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal",
                        "useGrouping": true,
                        "minimumFractionDigits": 2,
                        "maximumFractionDigits": 2
                      }
                    }
                  },
                  {
                    "columnMatch": "BytesPerRecord",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal",
                        "useGrouping": true,
                        "minimumFractionDigits": 2,
                        "maximumFractionDigits": 2
                      }
                    }
                  }
                ]
              },
              "sortBy": [],
              "chartSettings": {
                "xAxis": "TimeGenerated",
                "yAxis": [
                  "PerfCounter_MBs",
                  "Events_MBs",
                  "AVDData_MBs"
                ],
                "group": null,
                "createOtherGroup": 0,
                "seriesLabelSettings": [
                  {
                    "seriesName": "PerfCounter_MBs",
                    "label": "Perf Counters",
                    "color": "orange"
                  },
                  {
                    "seriesName": "Events_MBs",
                    "label": "Events",
                    "color": "blue"
                  },
                  {
                    "seriesName": "AVDData_MBs",
                    "label": "AVD Diagnostics",
                    "color": "green"
                  }
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 4,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true,
                      "maximumSignificantDigits": 3
                    }
                  },
                  "min": 0
                }
              }
            },
            "customWidth": "70",
            "name": "MBoverTime",
            "styleSettings": {
              "margin": "0",
              "padding": "5px",
              "maxWidth": "80%"
            }
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Performance Counters",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let WVDHosts = dynamic([{WVDHost2}]);\r\nPerf\r\n| extend HostPool = '{HostPool:label}'\r\n| extend ComputerName = strcat(HostPool, \"/\", Computer)\r\n| where ComputerName in~ (WVDHosts)\r\n| extend ShortName = trim_end(@'\\..*', Computer)\r\n| extend PerfCounter = strcat(ObjectName, \":\", CounterName)\r\n| summarize Billed_MBytes=sum(_BilledSize)/(1024*1024) by ShortName\r\n| order by Billed_MBytes desc\r\n| take 10",
                    "size": 0,
                    "title": "Top 10 hosts by performance counter data",
                    "color": "magenta",
                    "noDataMessage": "no events found in Perf database",
                    "timeContextFromParameter": "TimeRange",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{HostsLA}"
                    ],
                    "visualization": "barchart",
                    "chartSettings": {
                      "xAxis": "ShortName",
                      "yAxis": [
                        "Billed_MBytes"
                      ],
                      "group": null,
                      "createOtherGroup": 0,
                      "seriesLabelSettings": [
                        {
                          "seriesName": "Billed_MBytes",
                          "color": "orange"
                        }
                      ],
                      "ySettings": {
                        "numberFormatSettings": {
                          "unit": 4,
                          "options": {
                            "style": "decimal",
                            "useGrouping": true,
                            "maximumSignificantDigits": 3
                          }
                        },
                        "min": 0
                      }
                    }
                  },
                  "name": "EventsinPerfDb"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let WVDHosts = dynamic([{WVDHost2}]);\r\nPerf\r\n| extend HostPool = '{HostPool:label}'\r\n| extend ComputerName = strcat(HostPool, \"/\", Computer)\r\n| where ComputerName in~ (WVDHosts)\r\n| extend PerfCounter = strcat(ObjectName, \":\", CounterName)\r\n| summarize Billed_MBytes=sum(_BilledSize)/(1024*1024) by PerfCounter\r\n| sort by Billed_MBytes desc",
                    "size": 0,
                    "title": "Data per counter",
                    "noDataMessage": "no events found in Perf database",
                    "timeContextFromParameter": "TimeRange",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{HostsLA}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Billed_MBytes",
                          "formatter": 4,
                          "formatOptions": {
                            "min": 0,
                            "palette": "orange"
                          },
                          "numberFormat": {
                            "unit": 4,
                            "options": {
                              "style": "decimal",
                              "useGrouping": true,
                              "maximumSignificantDigits": 3
                            }
                          }
                        },
                        {
                          "columnMatch": "Records",
                          "formatter": 0,
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal",
                              "useGrouping": true
                            }
                          }
                        },
                        {
                          "columnMatch": "InstanceNames",
                          "formatter": 0,
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal",
                              "useGrouping": true
                            }
                          }
                        },
                        {
                          "columnMatch": "Bytes",
                          "formatter": 0,
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal",
                              "useGrouping": true
                            }
                          }
                        },
                        {
                          "columnMatch": "BytesPerRecord",
                          "formatter": 0,
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal",
                              "useGrouping": true,
                              "minimumFractionDigits": 2,
                              "maximumFractionDigits": 2
                            }
                          }
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "PerfCounter",
                          "label": "Perf counter"
                        },
                        {
                          "columnId": "Billed_MBytes",
                          "label": "Billed Data"
                        }
                      ]
                    },
                    "sortBy": [],
                    "chartSettings": {
                      "xAxis": "PerfCounter",
                      "yAxis": [
                        "Records"
                      ],
                      "group": null,
                      "createOtherGroup": 0,
                      "ySettings": {
                        "min": 0
                      }
                    }
                  },
                  "name": "DataGenPerPerfCounter"
                }
              ]
            },
            "name": "PerfCounters",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Events",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let WVDHosts = dynamic([{WVDHost2}]);\r\nEvent\r\n| extend HostPool = '{HostPool:label}'\r\n| extend ComputerName = strcat(HostPool, \"/\", Computer)\r\n| where ComputerName in~ (WVDHosts)\r\n| extend ShortName = trim_end(@'\\..*', Computer)\r\n| summarize _BilledSize = sum(_BilledSize)  by ShortName, EventLevelName\r\n| summarize Information = sumif(_BilledSize, EventLevelName == \"Information\"), Error = sumif(_BilledSize, EventLevelName == \"Error\"), Warning = sumif(_BilledSize, EventLevelName == \"Warning\"), Success = sumif(_BilledSize, EventLevelName == \"Success\") by ShortName\r\n| sort by (Information + Error + Warning + Success) desc\r\n| take 10\r\n",
                    "size": 0,
                    "aggregation": 3,
                    "title": "Top 10 hosts by event data",
                    "noDataMessage": "no events found in Event database",
                    "timeContextFromParameter": "TimeRange",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{HostsLA}"
                    ],
                    "visualization": "categoricalbar",
                    "chartSettings": {
                      "xAxis": "ShortName",
                      "seriesLabelSettings": [
                        {
                          "seriesName": "Information",
                          "color": "blue"
                        },
                        {
                          "seriesName": "Error",
                          "color": "redBright"
                        },
                        {
                          "seriesName": "Warning",
                          "color": "yellow"
                        },
                        {
                          "seriesName": "Success",
                          "color": "green"
                        }
                      ],
                      "ySettings": {
                        "numberFormatSettings": {
                          "unit": 2,
                          "options": {
                            "style": "decimal",
                            "useGrouping": true,
                            "maximumSignificantDigits": 3
                          }
                        },
                        "min": 0
                      }
                    }
                  },
                  "name": "EventRecordsperHost"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let WVDHosts = dynamic([{WVDHost2}]);\r\nEvent\r\n| extend HostPool = '{HostPool:label}'\r\n| extend ComputerName = strcat(HostPool, \"/\", Computer)\r\n| where ComputerName in~ (WVDHosts)\r\n| summarize Billed_MBytes=sum(_BilledSize)/(1024*1024) by EventLog\r\n| sort by Billed_MBytes desc",
                    "size": 0,
                    "title": "Data per event source",
                    "noDataMessage": "no events found in Event database",
                    "timeContextFromParameter": "TimeRange",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{HostsLA}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Billed_MBytes",
                          "formatter": 4,
                          "formatOptions": {
                            "min": 0,
                            "palette": "blue"
                          },
                          "numberFormat": {
                            "unit": 4,
                            "options": {
                              "style": "decimal",
                              "useGrouping": true,
                              "maximumSignificantDigits": 3
                            }
                          }
                        },
                        {
                          "columnMatch": "Records",
                          "formatter": 0,
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal",
                              "useGrouping": false
                            }
                          }
                        },
                        {
                          "columnMatch": "Bytes",
                          "formatter": 0,
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal",
                              "useGrouping": true
                            }
                          }
                        },
                        {
                          "columnMatch": "BytesPerRecord",
                          "formatter": 0,
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal",
                              "useGrouping": true,
                              "minimumFractionDigits": 2,
                              "maximumFractionDigits": 2
                            }
                          }
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "Billed_MBytes",
                          "label": "Billed data"
                        }
                      ]
                    },
                    "sortBy": [],
                    "chartSettings": {
                      "xAxis": "PerfCounter",
                      "yAxis": [
                        "Records"
                      ],
                      "group": null,
                      "createOtherGroup": 0,
                      "ySettings": {
                        "min": 0
                      }
                    }
                  },
                  "name": "DataGenPerEvent"
                }
              ]
            },
            "name": "Events",
            "styleSettings": {
              "showBorder": true
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "configstep",
        "comparison": "isEqualTo",
        "value": "datagen"
      },
      "name": "DataGen_Group",
      "styleSettings": {
        "margin": "5px",
        "padding": "5px",
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "template",
        "loadFromTemplateId": "community-Workbooks/Windows Virtual Desktop/shared/Template Versioning Footer",
        "items": []
      },
      "name": "TemplateVersioningFooter"
    }
  ],
  "fallbackResourceIds": [
    "Azure Monitor"
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
