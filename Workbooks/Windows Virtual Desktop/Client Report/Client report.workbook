{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "b859a03f-2283-43dd-8536-42714bbfced6",
            "version": "KqlParameterItem/1.0",
            "name": "Subscription",
            "type": 6,
            "isRequired": true,
            "query": "summarize Count = count() by subscriptionId\r\n| project value = strcat('/subscriptions/', subscriptionId), label = subscriptionId, Selected = Count >= 0",
            "crossComponentResources": [
              "value::selected"
            ],
            "typeSettings": {
              "additionalResourceOptions": []
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "2e3dfd9b-2d0f-4feb-94e8-107f220c4e28",
            "version": "KqlParameterItem/1.0",
            "name": "ResourceGroup",
            "type": 5,
            "isRequired": true,
            "query": "resources\r\n| where type contains  \"desktopvirtualization\"\r\n| summarize Count = count() by resourceGroup\r\n| project Label = resourceGroup, Id = resourceGroup, Selected = Count >= 0",
            "crossComponentResources": [
              "{Subscription}"
            ],
            "typeSettings": {
              "additionalResourceOptions": []
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "951b5870-e216-45c6-b159-34150868a46e",
            "version": "KqlParameterItem/1.0",
            "name": "HostPool",
            "type": 5,
            "isRequired": true,
            "query": "resources\r\n| where type == \"microsoft.desktopvirtualization/hostpools\" and resourceGroup == \"{ResourceGroup}\"\r\n",
            "crossComponentResources": [
              "{Subscription}"
            ],
            "typeSettings": {
              "additionalResourceOptions": []
            },
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "966a75f4-f4a4-4404-b649-67da45ddf636",
            "version": "KqlParameterItem/1.0",
            "name": "WVDHosts",
            "type": 5,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"/subscriptions/{Subscription:id}/resourcegroups/{ResourceGroup}/providers/Microsoft.DesktopVirtualization/hostpools/{HostPool:label}/sessionhosts?api-version=2019-01-23-preview\",\"urlParams\":[],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.value\",\"columns\":[{\"path\":\"$.name\",\"columnid\":\"Name\"}]}}]}",
            "value": [
              "value::all"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ]
            },
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 12
          },
          {
            "id": "04a8ead2-1fb2-4666-a7b0-6d92e3c29b46",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "type": 4,
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 1800000
                },
                {
                  "durationMs": 3600000
                },
                {
                  "durationMs": 14400000
                },
                {
                  "durationMs": 43200000
                },
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 172800000
                },
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 1209600000
                },
                {
                  "durationMs": 2592000000
                },
                {
                  "durationMs": 5184000000
                },
                {
                  "durationMs": 7776000000
                }
              ],
              "allowCustom": true
            },
            "value": {
              "durationMs": 2592000000
            },
            "label": "Time range"
          },
          {
            "id": "ff8c2838-aaf0-40f6-a604-d4bfe72fc92f",
            "version": "KqlParameterItem/1.0",
            "name": "poolla",
            "type": 5,
            "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"/{HostPool}/providers/microsoft.insights/diagnosticSettings?api-version=2017-05-01-preview\",\"urlParams\":[],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.value\",\"columns\":[{\"path\":\"$.properties.workspaceId\",\"columnid\":\"id\"},{\"path\":\"$.id\",\"columnid\":\"selected\"}]}}]}",
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 12
          },
          {
            "id": "08f46c2a-f080-40c5-b36f-acd0e80c6259",
            "version": "KqlParameterItem/1.0",
            "name": "WorkspaceId",
            "type": 1,
            "query": "resources\r\n| where resourceGroup =~ \"WVDSelfhost\"\r\n| where type =~ \"Microsoft.Compute/virtualMachines/extensions\"and properties.type == \"MicrosoftMonitoringAgent\"\r\n| project Value = parse_json(properties.settings).workspaceId, selected=true\r\n| limit 1",
            "crossComponentResources": [
              "value::selected"
            ],
            "isHiddenWhenLocked": true,
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "29c8282b-4c11-409c-b4e9-1049edbaf67a",
            "version": "KqlParameterItem/1.0",
            "name": "Workspace",
            "type": 5,
            "query": "resources\r\n| where type == \"microsoft.operationalinsights/workspaces\"\r\n| where properties.customerId == \"{WorkspaceId}\"",
            "crossComponentResources": [
              "value::selected"
            ],
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": []
            },
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          }
        ],
        "style": "pills",
        "queryType": 12
      },
      "name": "parameters - 2"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "# Client Report"
            },
            "name": "text - 0"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "c84ce0a1-5b4b-44ae-a7f7-be40f620f5dc",
                  "version": "KqlParameterItem/1.0",
                  "name": "ActivityType",
                  "label": "Activity type",
                  "type": 2,
                  "description": "The type of activity generated by the client as it communicates with the WVD service. Connection activities are generated when a user actively chooses to connect to a published resource on a VM. Feed refresh activities are generated when the client retrieves the list of those published resources, which can happen automatically in the background.",
                  "isRequired": true,
                  "query": "{\"version\":\"1.0.0\",\"content\":\"[\\r\\n\\t{\\r\\n\\t\\t\\\"value\\\": \\\"WVDConnections\\\",\\r\\n\\t\\t\\\"display\\\": \\\"Connections\\\",\\r\\n\\t\\t\\\"selected\\\": \\\"true\\\"\\r\\n\\t},\\r\\n\\t{\\r\\n\\t\\t\\\"value\\\": \\\"WVDFeeds\\\",\\r\\n\\t\\t\\\"display\\\": \\\"Feed refreshes\\\"\\r\\n\\t},\\r\\n\\t{\\r\\n\\t\\t\\\"value\\\": \\\"*\\\",\\r\\n\\t\\t\\\"display\\\": \\\"Connections and feed refreshes\\\"\\r\\n\\t}\\r\\n]\",\"transformers\":null}",
                  "value": "*",
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 0
                  },
                  "queryType": 8
                }
              ],
              "style": "pills",
              "queryType": 8
            },
            "name": "Activity type parameter"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let WVDHosts = dynamic([{WVDHosts}]);\r\nWVDConnections\r\n| where \"{ActivityType}\" == Type or \"{ActivityType}\" == \"*\"\r\n| extend Computername = strcat(\"{HostPool:label}\",\"/\", SessionHostName)\r\n| where Computername in (WVDHosts)\r\n| distinct CorrelationId, UserName, ClientType, ClientVersion\r\n| union\r\n(\r\n    WVDFeeds\r\n    | where \"{ActivityType}\" == Type or \"{ActivityType}\" == \"*\"\r\n    | distinct CorrelationId, UserName, ClientType, ClientVersion\r\n)\r\n| summarize Users=dcount(UserName), Activities=dcount(CorrelationId), Versions=dcount(ClientVersion) by ClientType\r\n| project ClientType, ClientShort=replace(\"com.microsoft.rdc.\", \"\", ClientType), Versions, Users, Activities\r\n| extend AggregationLevel=\"ClientVersion\", ChartTitle=strcat(\"Active users (on \", ClientShort, \") by client version over time\")\r\n| sort by Users desc, Activities desc",
              "size": 0,
              "aggregation": 5,
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "TimeRange",
              "exportedParameters": [
                {
                  "fieldName": "ClientType",
                  "parameterName": "SelectedClientType",
                  "parameterType": 1,
                  "defaultValue": "*"
                },
                {
                  "fieldName": "AggregationLevel",
                  "parameterName": "SelectedAggregationLevel",
                  "parameterType": 1,
                  "defaultValue": "ClientTypeShort"
                },
                {
                  "fieldName": "ChartTitle",
                  "parameterName": "ChartTitle",
                  "parameterType": 1,
                  "defaultValue": "Active users by client type over time"
                },
                {
                  "fieldName": "ClientShort",
                  "parameterName": "SelectedClientShort",
                  "parameterType": 1,
                  "defaultValue": "all clients"
                }
              ],
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{poolla}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "ClientType",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "Versions",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "Users",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "palette": "blue"
                    },
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal",
                        "useGrouping": true
                      }
                    }
                  },
                  {
                    "columnMatch": "Activities",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "palette": "gray"
                    },
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal",
                        "useGrouping": true
                      }
                    }
                  },
                  {
                    "columnMatch": "AggregationLevel",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "ChartTitle",
                    "formatter": 5
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "ClientType"
                  },
                  {
                    "columnId": "ClientShort",
                    "label": "Client"
                  },
                  {
                    "columnId": "Versions"
                  },
                  {
                    "columnId": "Users"
                  },
                  {
                    "columnId": "Activities"
                  },
                  {
                    "columnId": "AggregationLevel"
                  },
                  {
                    "columnId": "ChartTitle"
                  }
                ]
              },
              "sortBy": [],
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "ClientTypeShort"
                },
                "subtitleContent": {
                  "columnMatch": "Subtitle"
                },
                "leftContent": {
                  "columnMatch": "UsersConnecting",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "blue"
                  }
                },
                "rightContent": {
                  "columnMatch": "UsersRefreshing",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "blue"
                  }
                },
                "secondaryContent": {
                  "columnMatch": "Versions"
                },
                "showBorder": false
              }
            },
            "customWidth": "30",
            "name": "Client apps selector",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let WVDHosts = dynamic([{WVDHosts}]);\r\nWVDConnections\r\n| where \"{ActivityType}\" == Type or \"{ActivityType}\" == \"*\"\r\n| where \"{SelectedClientType}\" == \"*\" or \"{SelectedClientType}\" == ClientType\r\n| extend Computername = strcat(\"{HostPool:label}\",\"/\", SessionHostName)\r\n| where Computername in (WVDHosts)\r\n| as SourceData\r\n| where State==\"Started\"\r\n| project-rename StartTime=TimeGenerated\r\n| join kind=fullouter\r\n(\r\n    SourceData\r\n    | where State == \"Completed\"\r\n    | project CorrelationId, UserName, ClientVersion, ClientType, EndTime=TimeGenerated\r\n) on CorrelationId\r\n| project CorrelationId=coalesce(CorrelationId, CorrelationId1), UserName=coalesce(UserName, UserName1), StartTime=coalesce(StartTime, {TimeRange:start}), EndTime=coalesce(EndTime, {TimeRange:end}), ClientType=coalesce(ClientType, ClientType1), ClientVersion=coalesce(ClientVersion, ClientVersion1)\r\n| union\r\n(\r\n    WVDFeeds\r\n    | where \"{ActivityType}\" == Type or \"{ActivityType}\" == \"*\"\r\n    | where \"{SelectedClientType}\" == \"*\" or \"{SelectedClientType}\" == ClientType\r\n    | summarize StartTime=min(TimeGenerated), EndTime=max(TimeGenerated) by UserName, ClientType, ClientVersion, RefreshOperation=substring(CorrelationId, 0, 36 - 4)\r\n)\r\n| extend ClientTypeShort=replace(\"com.microsoft.rdc.\", \"\", ClientType), ProbeTime = range(bin_at(StartTime, {TimeRange:grain}, {TimeRange:start}), bin_at(EndTime + {TimeRange:grain}, {TimeRange:grain}, {TimeRange:end}), {TimeRange:grain})\r\n| mv-expand ProbeTime to typeof(datetime)\r\n| extend ConnectionContainsProbe = (StartTime < ProbeTime and EndTime > ProbeTime),\r\n         ConnectionEndedInPreviousBucket = (StartTime < ProbeTime and EndTime + {TimeRange:grain} >= ProbeTime)\r\n| extend ShouldCount = ConnectionContainsProbe or ConnectionEndedInPreviousBucket\r\n| make-series Users=dcountif(UserName, ShouldCount) on ProbeTime from {TimeRange:start} to {TimeRange:end}+{TimeRange:grain} step {TimeRange:grain} by {SelectedAggregationLevel}\r\n",
              "size": 0,
              "aggregation": 5,
              "title": "{ChartTitle}",
              "noDataMessage": "There were no activities found for the selected filters",
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "TimeRange",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{poolla}"
              ],
              "visualization": "areachart",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "ClientType",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "ClientTypeShort",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "25ch"
                    }
                  },
                  {
                    "columnMatch": "UsersConnecting",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "palette": "blue",
                      "customColumnWidthSetting": "100px"
                    },
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal",
                        "useGrouping": false
                      }
                    }
                  },
                  {
                    "columnMatch": "ConnectionCount",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "palette": "blue",
                      "customColumnWidthSetting": "100px"
                    },
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal",
                        "useGrouping": true
                      }
                    }
                  },
                  {
                    "columnMatch": "UsersRefreshing",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "palette": "gray",
                      "customColumnWidthSetting": "100px"
                    },
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal",
                        "useGrouping": false
                      }
                    }
                  },
                  {
                    "columnMatch": "RefreshCount",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "palette": "gray",
                      "customColumnWidthSetting": "100px"
                    },
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal",
                        "useGrouping": true
                      }
                    }
                  },
                  {
                    "columnMatch": "LatestVersion",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "17ch"
                    }
                  },
                  {
                    "columnMatch": "Versions",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "14ch"
                    }
                  }
                ]
              },
              "sortBy": []
            },
            "customWidth": "70",
            "name": "Active users by client over time",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px",
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let WVDHosts = dynamic([{WVDHosts}]);\r\nWVDConnections\r\n| where \"{ActivityType}\" == Type or \"{ActivityType}\" == \"*\"\r\n| where \"{SelectedClientType}\" == \"*\" or \"{SelectedClientType}\" == ClientType\r\n| extend HostPool = '{HostPool:label}'\r\n| extend HostPool = strcat(HostPool, \"/\")\r\n| extend ComputerName = strcat(HostPool, SessionHostName)\r\n| where ComputerName in (WVDHosts)\r\n| union\r\n(\r\n    WVDFeeds\r\n    | where \"{ActivityType}\" == Type or \"{ActivityType}\" == \"*\"\r\n    | where \"{SelectedClientType}\" == \"*\" or \"{SelectedClientType}\" == ClientType\r\n)\r\n| summarize Users=dcount(UserName), Activities=dcount(CorrelationId) by ClientType, ClientVersion\r\n| as VersionData\r\n| join kind=leftouter\r\n(\r\n    VersionData\r\n    | extend ExtendedVersion=strcat(ClientVersion, '.0.0.0.0')\r\n    | extend FirstFourSegments=indexof(ExtendedVersion, \".\", indexof(ExtendedVersion, \".\", indexof(ExtendedVersion, \".\", indexof(ExtendedVersion, \".\") + 1) + 1) + 1)\r\n    | extend NormalizedVersion=substring(ExtendedVersion, 0, FirstFourSegments)\r\n    | distinct ClientType, ClientVersion, NormalizedVersion\r\n    | as VersionCatalog\r\n    | join kind=inner\r\n    (\r\n        VersionCatalog\r\n        | distinct ClientType, NormalizedVersion\r\n        | extend SplitVersion=split(NormalizedVersion, '.')\r\n        | order by ClientType, toint(SplitVersion[0]) desc, toint(SplitVersion[1]) desc, toint(SplitVersion[2]) desc, toint(SplitVersion[3]) desc\r\n        | extend VersionSortIndex=row_number(1, prev(ClientType) != ClientType)\r\n        | project ClientType, NormalizedVersion, VersionSortIndex\r\n    ) on ClientType, NormalizedVersion\r\n    | project ClientType, ClientVersion, VersionSortIndex\r\n) on ClientType, ClientVersion\r\n| project VersionSortIndex, ClientType=replace(\"com.microsoft.rdc.\", \"\", ClientType), ClientVersion, Users, Activities\r\n| sort by VersionSortIndex asc",
              "size": 0,
              "title": "Usage by client version for {SelectedClientShort}",
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "TimeRange",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{poolla}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "VersionSortIndex",
                    "formatter": 1
                  },
                  {
                    "columnMatch": "ClientType",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "ClientVersion",
                    "formatter": 1,
                    "formatOptions": {
                      "customColumnWidthSetting": "24ch"
                    }
                  },
                  {
                    "columnMatch": "Users",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "palette": "blue"
                    },
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal",
                        "useGrouping": true
                      }
                    }
                  },
                  {
                    "columnMatch": "Activities",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "palette": "gray"
                    },
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal",
                        "useGrouping": true
                      }
                    }
                  }
                ],
                "rowLimit": 500,
                "labelSettings": [
                  {
                    "columnId": "VersionSortIndex",
                    "label": "#",
                    "comment": "The descending sort index for the version number"
                  },
                  {
                    "columnId": "ClientType",
                    "label": "Client versions",
                    "comment": ""
                  },
                  {
                    "columnId": "ClientVersion",
                    "label": "Version",
                    "comment": "Software version of the client"
                  }
                ]
              },
              "sortBy": []
            },
            "customWidth": "30",
            "conditionalVisibility": {
              "parameterName": "SelectedClientShort",
              "comparison": "isNotEqualTo",
              "value": "all clients"
            },
            "name": "Usage by client version for client type",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px",
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let WVDHosts = dynamic([{WVDHosts}]);\r\nWVDConnections\r\n| where \"{ActivityType}\" == Type or \"{ActivityType}\" == \"*\"\r\n| where \"{SelectedClientType}\" == \"*\" or \"{SelectedClientType}\" == ClientType\r\n| extend HostPool = '{HostPool:label}'\r\n| extend HostPool = strcat(HostPool, \"/\")\r\n| extend ComputerName = strcat(HostPool, SessionHostName)\r\n| where ComputerName in (WVDHosts)\r\n| union\r\n(\r\n    WVDFeeds\r\n    | where \"{ActivityType}\" == Type or \"{ActivityType}\" == \"*\"\r\n    | where \"{SelectedClientType}\" == \"*\" or \"{SelectedClientType}\" == ClientType\r\n)\r\n| summarize Users=dcount(UserName), Activities=dcount(CorrelationId) by ClientType, ClientVersion\r\n| as VersionData\r\n| join kind=leftouter\r\n(\r\n    VersionData\r\n    | extend ExtendedVersion=strcat(ClientVersion, '.0.0.0.0')\r\n    | extend FirstFourSegments=indexof(ExtendedVersion, \".\", indexof(ExtendedVersion, \".\", indexof(ExtendedVersion, \".\", indexof(ExtendedVersion, \".\") + 1) + 1) + 1)\r\n    | extend NormalizedVersion=substring(ExtendedVersion, 0, FirstFourSegments)\r\n    | distinct ClientType, ClientVersion, NormalizedVersion\r\n    | as VersionCatalog\r\n    | join kind=inner\r\n    (\r\n        VersionCatalog\r\n        | distinct ClientType, NormalizedVersion\r\n        | extend SplitVersion=split(NormalizedVersion, '.')\r\n        | order by ClientType, toint(SplitVersion[0]) desc, toint(SplitVersion[1]) desc, toint(SplitVersion[2]) desc, toint(SplitVersion[3]) desc\r\n        | extend VersionSortIndex=row_number(1, prev(ClientType) != ClientType)\r\n        | project ClientType, NormalizedVersion, VersionSortIndex\r\n    ) on ClientType, NormalizedVersion\r\n    | project ClientType, ClientVersion, VersionSortIndex\r\n) on ClientType, ClientVersion\r\n| project VersionSortIndex, ClientType=replace(\"com.microsoft.rdc.\", \"\", ClientType), ClientVersion, Users, Activities\r\n| sort by VersionSortIndex asc",
              "size": 0,
              "title": "Usage by client version for {SelectedClientShort}",
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "TimeRange",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{poolla}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "$gen_group",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "29.2857ch"
                    }
                  },
                  {
                    "columnMatch": "VersionSortIndex",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "ClientType",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "ClientVersion",
                    "formatter": 5,
                    "formatOptions": {
                      "customColumnWidthSetting": "17ch"
                    }
                  },
                  {
                    "columnMatch": "Users",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "palette": "blue"
                    },
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal",
                        "useGrouping": true
                      }
                    }
                  },
                  {
                    "columnMatch": "Activities",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "palette": "gray",
                      "aggregation": "Sum"
                    },
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal",
                        "useGrouping": true
                      }
                    }
                  }
                ],
                "rowLimit": 500,
                "hierarchySettings": {
                  "treeType": 1,
                  "groupBy": [
                    "ClientType"
                  ],
                  "expandTopLevel": false,
                  "finalBy": "ClientVersion"
                },
                "sortBy": [
                  {
                    "itemKey": "$gen_count_$gen_group_0",
                    "sortOrder": 1
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "VersionSortIndex",
                    "label": "#",
                    "comment": "The descending sort index for the version number"
                  },
                  {
                    "columnId": "ClientType",
                    "label": "Client versions",
                    "comment": ""
                  },
                  {
                    "columnId": "ClientVersion",
                    "label": "Version",
                    "comment": "Software version of the client"
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "$gen_count_$gen_group_0",
                  "sortOrder": 1
                }
              ]
            },
            "customWidth": "30",
            "conditionalVisibility": {
              "parameterName": "SelectedClientShort",
              "comparison": "isEqualTo",
              "value": "all clients"
            },
            "name": "Usage by client version for all clients",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px",
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let WVDHosts = dynamic([{WVDHosts}]);\r\nlet LatestClientsReleaseTimes =\r\nWVDConnections\r\n| where \"{SelectedClientType}\" == \"*\" or \"{SelectedClientType}\" == ClientType\r\n| extend HostPool = '{HostPool:label}'\r\n| extend HostPool = strcat(HostPool, \"/\")\r\n| extend ComputerName = strcat(HostPool, SessionHostName)\r\n| where ComputerName in (WVDHosts)\r\n| summarize FirstSeen=min(TimeGenerated) by ClientType, ClientVersion\r\n| join kind=fullouter\r\n(\r\n    WVDFeeds\r\n    | where \"{SelectedClientType}\" == \"*\" or \"{SelectedClientType}\" == ClientType\r\n    | summarize FirstSeen=min(TimeGenerated) by ClientType, ClientVersion\r\n) on ClientType, ClientVersion\r\n| project ClientType=coalesce(ClientType, ClientType1), ClientVersion=coalesce(ClientVersion, ClientVersion1), FirstSeen=min_of(FirstSeen, FirstSeen1)\r\n| extend ExtendedVersion=strcat(ClientVersion, '.0.0.0.0')\r\n| extend FirstFourSegments=indexof(ExtendedVersion, \".\", indexof(ExtendedVersion, \".\", indexof(ExtendedVersion, \".\", indexof(ExtendedVersion, \".\") + 1) + 1) + 1)\r\n| extend NormalizedVersion=substring(ExtendedVersion, 0, FirstFourSegments)\r\n| as VersionCatalog\r\n| join kind=inner\r\n(\r\n    VersionCatalog\r\n    | distinct ClientType, NormalizedVersion\r\n    | extend SplitVersion=split(NormalizedVersion, '.')\r\n    | order by ClientType, toint(SplitVersion[0]) desc, toint(SplitVersion[1]) desc, toint(SplitVersion[2]) desc, toint(SplitVersion[3]) desc\r\n    | extend VersionSortIndex=row_number(1, prev(ClientType) != ClientType)\r\n    | project ClientType, NormalizedVersion, VersionSortIndex\r\n) on ClientType, NormalizedVersion\r\n| project ClientType, ClientVersion, FirstSeen, VersionSortIndex;\r\nWVDConnections\r\n| where TimeGenerated {TimeRange} and (\"{SelectedClientType}\" == \"*\" or \"{SelectedClientType}\" == ClientType)\r\n| extend HostPool = '{HostPool:label}'\r\n| extend HostPool = strcat(HostPool, \"/\")\r\n| extend ComputerName = strcat(HostPool, SessionHostName)\r\n| where ComputerName in (WVDHosts)\r\n| summarize ConnectionCount=dcount(CorrelationId), LastSeen=max(TimeGenerated) by UserName, ClientType, ClientVersion\r\n| join kind=fullouter\r\n(\r\n    WVDFeeds\r\n    | where TimeGenerated {TimeRange} and (\"{SelectedClientType}\" == \"*\" or \"{SelectedClientType}\" == ClientType)\r\n    | summarize RefreshCount=dcount(CorrelationId), LastSeen=max(TimeGenerated) by UserName, ClientType, ClientVersion\r\n) on UserName, ClientType, ClientVersion\r\n| project UserName=coalesce(UserName, UserName1), ClientType=coalesce(ClientType, ClientType1), ClientVersion=coalesce(ClientVersion, ClientVersion1), LastSeen=max_of(LastSeen1, LastSeen), Connections=coalesce(ConnectionCount, 0), Refreshes=coalesce(RefreshCount, 0)\r\n| project-away *1\r\n| as UserData\r\n| join kind=leftouter\r\n(\r\n    UserData\r\n    | extend ExtendedVersion=strcat(ClientVersion, '.0.0.0.0')\r\n    | extend FirstFourSegments=indexof(ExtendedVersion, \".\", indexof(ExtendedVersion, \".\", indexof(ExtendedVersion, \".\", indexof(ExtendedVersion, \".\") + 1) + 1) + 1)\r\n    | extend NormalizedVersion=substring(ExtendedVersion, 0, FirstFourSegments)\r\n    | distinct ClientType, ClientVersion, NormalizedVersion\r\n    | as VersionCatalog\r\n    | join kind=inner\r\n    (\r\n        VersionCatalog\r\n        | distinct ClientType, NormalizedVersion\r\n        | extend SplitVersion=split(NormalizedVersion, '.')\r\n        | order by ClientType, toint(SplitVersion[0]) desc, toint(SplitVersion[1]) desc, toint(SplitVersion[2]) desc, toint(SplitVersion[3]) desc\r\n        | extend VersionSortIndex=row_number(1, prev(ClientType) != ClientType)\r\n        | project ClientType, NormalizedVersion, VersionSortIndex\r\n    ) on ClientType, NormalizedVersion\r\n    | project ClientType, ClientVersion, VersionSortIndex\r\n) on ClientType, ClientVersion\r\n| project-away *1\r\n| summarize arg_min(VersionSortIndex, *) by UserName, ClientType\r\n| where VersionSortIndex > 1\r\n| extend VersionsBehind=VersionSortIndex-1\r\n| join kind=inner  \r\n(\r\n    LatestClientsReleaseTimes\r\n    | where VersionSortIndex == 1\r\n) on ClientType\r\n| extend TimeDelta=LastSeen-FirstSeen\r\n| where TimeDelta > 1d\r\n| project UserName, ClientType, ClientTypeShort=replace(\"com.microsoft.rdc.\", \"\", ClientType), ClientVersion, LastSeen, Connections, Refreshes, LatestVersion=ClientVersion1, FirstSeen, TimeDelta=TimeDelta/1d\r\n| extend RowLabel=strcat(ClientTypeShort, \" - Newest: \", LatestVersion)\r\n| sort by TimeDelta desc",
              "size": 0,
              "title": "Users with potentially outdated clients (all activity types)",
              "noDataMessage": "There are no users who have continued to use an outdated client for more than 1 day after the release of a newer version",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{poolla}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "$gen_group",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "42ch"
                    }
                  },
                  {
                    "columnMatch": "UserName",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "ClientType",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "ClientTypeShort",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "ClientVersion",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "13.1429ch"
                    }
                  },
                  {
                    "columnMatch": "LastSeen",
                    "formatter": 0,
                    "formatOptions": {
                      "aggregation": "Max",
                      "customColumnWidthSetting": "22.8571ch"
                    }
                  },
                  {
                    "columnMatch": "Connections",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "palette": "blue",
                      "aggregation": "Sum",
                      "customColumnWidthSetting": "118px"
                    },
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal",
                        "useGrouping": true
                      }
                    }
                  },
                  {
                    "columnMatch": "Refreshes",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "palette": "gray",
                      "aggregation": "Sum",
                      "customColumnWidthSetting": "134px"
                    },
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal",
                        "useGrouping": true
                      }
                    }
                  },
                  {
                    "columnMatch": "LatestVersion",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "FirstSeen",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "TimeDelta",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "max": 7,
                      "palette": "greenRed",
                      "aggregation": "Average",
                      "customColumnWidthSetting": "197px"
                    },
                    "numberFormat": {
                      "unit": 27,
                      "options": {
                        "style": "decimal",
                        "useGrouping": false,
                        "maximumSignificantDigits": 2
                      }
                    }
                  },
                  {
                    "columnMatch": "RowLabel",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "-- Group By --",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "42ch"
                    }
                  }
                ],
                "rowLimit": 1000,
                "hierarchySettings": {
                  "treeType": 1,
                  "groupBy": [
                    "RowLabel"
                  ],
                  "expandTopLevel": false,
                  "finalBy": "UserName"
                },
                "labelSettings": [
                  {
                    "columnId": "UserName",
                    "label": ""
                  },
                  {
                    "columnId": "ClientType",
                    "label": "Client versions",
                    "comment": ""
                  },
                  {
                    "columnId": "ClientTypeShort",
                    "label": "Client",
                    "comment": "The client type identification string"
                  },
                  {
                    "columnId": "ClientVersion",
                    "label": "Version"
                  },
                  {
                    "columnId": "LastSeen",
                    "label": "Last seen"
                  },
                  {
                    "columnId": "Connections"
                  },
                  {
                    "columnId": "Refreshes",
                    "label": "Feed refreshes"
                  },
                  {
                    "columnId": "LatestVersion",
                    "label": "Latest version"
                  },
                  {
                    "columnId": "FirstSeen",
                    "label": "First active"
                  },
                  {
                    "columnId": "TimeDelta",
                    "label": "Time behind latest version",
                    "comment": "Length of time during which this client has remained active, despite a newer version being available"
                  },
                  {
                    "columnId": "RowLabel",
                    "label": "Users with outdated clients"
                  }
                ]
              },
              "sortBy": []
            },
            "customWidth": "70",
            "name": "Users with potentially outdated clients (all activity types)",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px",
              "showBorder": true
            }
          }
        ]
      },
      "name": "ClientReportPage"
    }
  ],
  "fallbackResourceIds": [
    "Azure Monitor"
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}