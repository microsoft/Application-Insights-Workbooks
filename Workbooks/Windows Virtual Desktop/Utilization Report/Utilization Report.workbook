{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "crossComponentResources": [
          "value::all"
        ],
        "parameters": [
          {
            "id": "b859a03f-2283-43dd-8536-42714bbfced6",
            "version": "KqlParameterItem/1.0",
            "name": "Subscription",
            "type": 6,
            "isRequired": true,
            "query": "where type startswith 'Microsoft.DesktopVirtualization/'\r\n    | summarize Count = count() by subscriptionId\r\n    | order by Count desc\r\n    | extend Rank = row_number()\r\n    | project value = subscriptionId, label = subscriptionId, selected = Rank == 1\r\n",
            "crossComponentResources": [
              "value::all"
            ],
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "2e3dfd9b-2d0f-4feb-94e8-107f220c4e28",
            "version": "KqlParameterItem/1.0",
            "name": "ResourceGroup",
            "type": 5,
            "isRequired": true,
            "query": "resources\r\n| where type contains  \"desktopvirtualization\"\r\n| summarize Count = count() by resourceGroup\r\n| project Label = resourceGroup, Id = resourceGroup, Selected = Count >= 0",
            "crossComponentResources": [
              "{Subscription}"
            ],
            "typeSettings": {
              "additionalResourceOptions": []
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "951b5870-e216-45c6-b159-34150868a46e",
            "version": "KqlParameterItem/1.0",
            "name": "HostPool",
            "type": 5,
            "isRequired": true,
            "query": "resources\r\n| where type == \"microsoft.desktopvirtualization/hostpools\" and resourceGroup == \"{ResourceGroup}\"\r\n",
            "crossComponentResources": [
              "{Subscription}"
            ],
            "typeSettings": {
              "additionalResourceOptions": []
            },
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "966a75f4-f4a4-4404-b649-67da45ddf636",
            "version": "KqlParameterItem/1.0",
            "name": "WVDHosts",
            "type": 5,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"/subscriptions/{Subscription:id}/resourcegroups/{ResourceGroup}/providers/Microsoft.DesktopVirtualization/hostpools/{HostPool:label}/sessionhosts?api-version=2019-01-23-preview\",\"urlParams\":[],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.value\",\"columns\":[{\"path\":\"$.name\",\"columnid\":\"Name\"}]}}]}",
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ]
            },
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 12,
            "value": [
              "value::all"
            ]
          },
          {
            "id": "b97c4544-8970-4638-8ac8-bdb6ae891683",
            "version": "KqlParameterItem/1.0",
            "name": "WVDHostsId",
            "type": 5,
            "isRequired": true,
            "multiSelect": true,
            "quote": "\"",
            "delimiter": ",",
            "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GETARRAY\",\"path\":\"{HostPool}/sessionhosts?api-version=2019-01-23-preview\",\"urlParams\":[],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"columns\":[{\"path\":\"$.properties.resourceId\",\"columnid\":\"Id\"},{\"path\":\"$.properties.resourceId\",\"columnid\":\"Disp\"},{\"path\":\"$.properties.resourceId\",\"columnid\":\"selected\"}]}}]}",
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 12
          },
          {
            "id": "04a8ead2-1fb2-4666-a7b0-6d92e3c29b46",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "type": 4,
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 1800000
                },
                {
                  "durationMs": 3600000
                },
                {
                  "durationMs": 14400000
                },
                {
                  "durationMs": 43200000
                },
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 172800000
                },
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 1209600000
                },
                {
                  "durationMs": 2592000000
                },
                {
                  "durationMs": 5184000000
                },
                {
                  "durationMs": 7776000000
                }
              ],
              "allowCustom": true
            },
            "value": {
              "durationMs": 604800000
            },
            "label": "Time range"
          },
          {
            "id": "ff8c2838-aaf0-40f6-a604-d4bfe72fc92f",
            "version": "KqlParameterItem/1.0",
            "name": "poolla",
            "type": 5,
            "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"/{HostPool}/providers/microsoft.insights/diagnosticSettings?api-version=2021-05-01-preview\",\"urlParams\":[],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.value\",\"columns\":[{\"path\":\"$.properties.workspaceId\",\"columnid\":\"id\"},{\"path\":\"$.id\",\"columnid\":\"selected\"}]}}]}",
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 12
          },
          {
            "id": "08f46c2a-f080-40c5-b36f-acd0e80c6259",
            "version": "KqlParameterItem/1.0",
            "name": "WorkspaceId",
            "type": 1,
            "query": "resources\r\n| where type =~ \"Microsoft.Compute/virtualMachines/extensions\"and properties.type == \"MicrosoftMonitoringAgent\"\r\n| where id contains extract(\"/(.*?)[.]\",1,\"{WVDHosts}\")\r\n| project Value = parse_json(properties.settings).workspaceId, selected=true\r\n| limit 1",
            "crossComponentResources": [
              "{Subscription}"
            ],
            "isHiddenWhenLocked": true,
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "29c8282b-4c11-409c-b4e9-1049edbaf67a",
            "version": "KqlParameterItem/1.0",
            "name": "Workspace",
            "type": 5,
            "query": "resources\r\n| where type == \"microsoft.operationalinsights/workspaces\"\r\n| where properties.customerId == \"{WorkspaceId}\"",
            "crossComponentResources": [
              "value::all"
            ],
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "6c8ec0d1-d1e2-4324-8b1d-e01e3c53d789",
            "version": "KqlParameterItem/1.0",
            "name": "hostnames",
            "type": 5,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "let WVDHosts = dynamic([{WVDHosts}]);\r\nlet hostPool = \"{HostPool:label}\";\r\ndatatable (hosts:dynamic)[dynamic([{WVDHosts}])]\r\n| mv-expand hosts\r\n| project hosts=split(hosts,\"/\")[1]\r\n| project hosts=split(hosts,\".\")[0], selected=1\r\n",
            "crossComponentResources": [
              "{Workspace}"
            ],
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": []
            },
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.resourcegraph/resources"
      },
      "name": "parameters_general"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "crossComponentResources": [
                "{poolla}"
              ],
              "parameters": [
                {
                  "id": "aef02c90-3586-4e8a-9780-9477155cccfc",
                  "version": "KqlParameterItem/1.0",
                  "name": "MachineName",
                  "type": 2,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "query": "datatable (vms:dynamic)[dynamic([{WVDHosts}])]\r\n|mv-expand vms\r\n|project value=extract(\"/([^.]+)\",1,tostring(vms))\r\n| extend disp=value,selected=1\r\n",
                  "crossComponentResources": [
                    "{HostPool}"
                  ],
                  "isHiddenWhenLocked": true,
                  "typeSettings": {
                    "additionalResourceOptions": []
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "queryType": 0,
                  "resourceType": "microsoft.desktopvirtualization/hostpools",
                  "label": "Host"
                },
                {
                  "id": "052a4d8c-a4d2-4a63-9a61-9e929fdb31ca",
                  "version": "KqlParameterItem/1.0",
                  "name": "Cores",
                  "type": 1,
                  "query": "Resources \r\n| where type =~ 'Microsoft.Compute/virtualMachines'  \r\n| where name in( {MachineName})\r\n| extend sku = tostring(properties.hardwareProfile.vmSize)\r\n| project cores = extract(\"_[[:alpha:]]+([0-9]+)\",1, sku)\r\n| top 1 by cores asc",
                  "crossComponentResources": [
                    "value::all"
                  ],
                  "isHiddenWhenLocked": true,
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources"
                },
                {
                  "id": "415f4f0c-90ba-4638-8f6f-8e5975a9fa67",
                  "version": "KqlParameterItem/1.0",
                  "name": "SessionLimit",
                  "type": 1,
                  "query": "resources\r\n| where id =~ \"{HostPool}\"\r\n| project MaxSession = parse_json(properties).maxSessionLimit\r\n| extend disp=\"\", selected=1",
                  "crossComponentResources": [
                    "{Subscription}"
                  ],
                  "isHiddenWhenLocked": true,
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources",
                  "label": "Session limit"
                },
                {
                  "id": "9b1caa0d-384a-4de6-afe6-98b97ea4fae5",
                  "version": "KqlParameterItem/1.0",
                  "name": "SessionHostCount",
                  "type": 1,
                  "query": "datatable (vms:dynamic)[dynamic([{WVDHosts}])]\r\n|mv-expand vms\r\n|summarize count()\r\n",
                  "crossComponentResources": [
                    "{HostPool}"
                  ],
                  "isHiddenWhenLocked": true,
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "queryType": 0,
                  "resourceType": "microsoft.desktopvirtualization/hostpools",
                  "label": "Session host count"
                },
                {
                  "id": "03d96602-269f-4b35-8b87-42172909ff5d",
                  "version": "KqlParameterItem/1.0",
                  "name": "VSessionLimit",
                  "type": 1,
                  "isHiddenWhenLocked": true,
                  "criteriaData": [
                    {
                      "criteriaContext": {
                        "leftOperand": "SessionLimit",
                        "operator": ">",
                        "rightValType": "static",
                        "rightVal": "1000",
                        "resultValType": "expression",
                        "resultVal": "{Cores}*4"
                      }
                    },
                    {
                      "criteriaContext": {
                        "operator": "Default",
                        "rightValType": "param",
                        "resultValType": "param",
                        "resultVal": "SessionLimit"
                      }
                    }
                  ]
                },
                {
                  "id": "20897f5e-b453-41e4-bf68-93f88061e0e1",
                  "version": "KqlParameterItem/1.0",
                  "name": "HasAgentHealthTable",
                  "type": 1,
                  "isRequired": true,
                  "query": "union isfuzzy=true ( table(\"WVDAgentHealthStatus\")| where _ResourceId =~ \"{HostPool}\" | take 1| count as Count ), (print Count=0) | summarize Result = sum(Count) \r\n| project Result = tostring(Result)\r\n",
                  "crossComponentResources": [
                    "{poolla}"
                  ],
                  "isHiddenWhenLocked": true,
                  "timeContextFromParameter": "TimeRange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "parameters - 4"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "No data was found. Verify if the diagnostic setting is correctly configured for the selected host pool. If you have recently configured the diagnostic setting, there may be a delay before the initial set of data appears.",
                    "style": "warning"
                  },
                  "name": "text - 1"
                },
                {
                  "type": 11,
                  "content": {
                    "version": "LinkItem/1.0",
                    "style": "paragraph",
                    "links": [
                      {
                        "id": "7ea3b667-d3ef-4be8-8cc3-13705a565982",
                        "cellValue": "community-Workbooks/Windows Virtual Desktop/Check Configuration",
                        "linkTarget": "WorkbookTemplate",
                        "linkLabel": "Configuration workbook",
                        "preText": "See the",
                        "postText": "to repair the issue.",
                        "style": "link"
                      }
                    ]
                  },
                  "name": "CheckConfigLinkMissingVms",
                  "styleSettings": {
                    "margin": "5px"
                  }
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "HasAgentHealthTable",
              "comparison": "isEqualTo",
              "value": "0"
            },
            "name": "NoAgentHealtStatus",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 12,
                  "content": {
                    "version": "NotebookGroup/1.0",
                    "groupType": "editable",
                    "title": "Sessions",
                    "items": [
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "WVDAgentHealthStatus\r\n| where _ResourceId =~ \"{HostPool}\"\r\n| summarize Sessions= max(toint(ActiveSessions) + toint(InactiveSessions)), InactiveSessions=max(toint(InactiveSessions)) by bin(TimeGenerated, 1m), SessionHostName\r\n| summarize Sessions= sum(Sessions), InactiveSessions = sum(InactiveSessions) by TimeGenerated\r\n| make-series\r\n    Sessions = max(Sessions),[\"Idle Sessions\"] = max(InactiveSessions)\r\n    on TimeGenerated\r\n    step {TimeRange:grain}\r\n| extend series_stats(Sessions)\r\n| project Sessions, TimeGenerated, Average=series_stats_Sessions_avg\r\n| mvexpand Sessions, TimeGenerated\r\n| project Sessions=todouble(Sessions), TimeGenerated= todatetime(TimeGenerated), Average\r\n| summarize arg_max(MaxSessions=Sessions, MaxTime=TimeGenerated), arg_min(MinSessions=Sessions, MinTime=TimeGenerated), Average =any(Average)\r\n| project [\"Host Pool\"]=\"{HostPool:label}\", [\"Max\"]= MaxSessions, MaxTime, [\"Min\"]= MinSessions, MinTime, Average, Metric=\"Sessions\"    \r\n\r\n",
                          "size": 4,
                          "title": "Sessions summary",
                          "timeContextFromParameter": "TimeRange",
                          "queryType": 0,
                          "resourceType": "microsoft.operationalinsights/workspaces",
                          "crossComponentResources": [
                            "{poolla}"
                          ],
                          "gridSettings": {
                            "formatters": [
                              {
                                "columnMatch": "Max",
                                "formatter": 0,
                                "formatOptions": {
                                  "customColumnWidthSetting": "9ch"
                                }
                              },
                              {
                                "columnMatch": "MaxTime",
                                "formatter": 0,
                                "formatOptions": {
                                  "customColumnWidthSetting": "20ch"
                                }
                              },
                              {
                                "columnMatch": "Min",
                                "formatter": 0,
                                "formatOptions": {
                                  "customColumnWidthSetting": "9ch"
                                }
                              },
                              {
                                "columnMatch": "MinTime",
                                "formatter": 0,
                                "formatOptions": {
                                  "customColumnWidthSetting": "20ch"
                                }
                              },
                              {
                                "columnMatch": "Average",
                                "formatter": 0,
                                "formatOptions": {
                                  "customColumnWidthSetting": "9ch"
                                },
                                "numberFormat": {
                                  "unit": 0,
                                  "options": {
                                    "style": "decimal",
                                    "useGrouping": false,
                                    "minimumFractionDigits": 1,
                                    "maximumFractionDigits": 1
                                  }
                                }
                              },
                              {
                                "columnMatch": "Metric",
                                "formatter": 5
                              }
                            ],
                            "labelSettings": [
                              {
                                "columnId": "MaxTime",
                                "label": "Max time"
                              },
                              {
                                "columnId": "MinTime",
                                "label": "Min time"
                              },
                              {
                                "columnId": "Average",
                                "label": "Avg"
                              }
                            ]
                          },
                          "chartSettings": {
                            "group": null,
                            "createOtherGroup": 0
                          }
                        },
                        "name": "SessionSummary"
                      },
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "\r\nWVDAgentHealthStatus\r\n| where _ResourceId =~ \"{HostPool}\"\r\n| summarize Sessions= max(toint(ActiveSessions) + toint(InactiveSessions)), InactiveSessions=max(toint(InactiveSessions)) by bin(TimeGenerated, 1m), SessionHostName\r\n| summarize Sessions= sum(Sessions), InactiveSessions = sum(InactiveSessions) by TimeGenerated\r\n| make-series\r\n    Sessions = max(Sessions),[\"Idle Sessions\"] = max(InactiveSessions)\r\n    on TimeGenerated\r\n    step {TimeRange:grain}\r\n| where array_length(TimeGenerated) > 0\r\n",
                          "size": 0,
                          "aggregation": 3,
                          "title": "Session history",
                          "timeContextFromParameter": "TimeRange",
                          "showExportToExcel": true,
                          "queryType": 0,
                          "resourceType": "microsoft.operationalinsights/workspaces",
                          "crossComponentResources": [
                            "{poolla}"
                          ],
                          "visualization": "timechart",
                          "chartSettings": {
                            "group": null,
                            "createOtherGroup": 0,
                            "ySettings": {
                              "numberFormatSettings": {
                                "unit": 0,
                                "options": {
                                  "style": "decimal",
                                  "useGrouping": true,
                                  "minimumFractionDigits": 1,
                                  "maximumFractionDigits": 1
                                }
                              },
                              "min": 0
                            }
                          }
                        },
                        "name": "SessionHistoryGraph",
                        "styleSettings": {
                          "padding": "2%"
                        }
                      },
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "WVDAgentHealthStatus\r\n| where _ResourceId =~ \"{HostPool}\"\r\n| summarize Sessions= max(toint(ActiveSessions) + toint(InactiveSessions)) by bin(TimeGenerated, 1m), SessionHostName\r\n| summarize Sessions= sum(Sessions) by TimeGenerated\r\n| project Val = ({VSessionLimit}*{SessionHostCount}) - Sessions, TimeGenerated\r\n| make-series [\"Available Sessions\"] = min(Val) on TimeGenerated step {TimeRange:grain}\r\n| where array_length(TimeGenerated) > 0",
                          "size": 0,
                          "aggregation": 3,
                          "title": "Available sessions",
                          "timeContextFromParameter": "TimeRange",
                          "showExportToExcel": true,
                          "queryType": 0,
                          "resourceType": "microsoft.operationalinsights/workspaces",
                          "crossComponentResources": [
                            "{poolla}"
                          ],
                          "visualization": "timechart",
                          "chartSettings": {
                            "group": null,
                            "createOtherGroup": 0,
                            "ySettings": {
                              "min": 0
                            }
                          }
                        },
                        "name": "AvailableSessionsGraph",
                        "styleSettings": {
                          "padding": "2%"
                        }
                      }
                    ]
                  },
                  "customWidth": "50",
                  "name": "SessionCharts"
                },
                {
                  "type": 12,
                  "content": {
                    "version": "NotebookGroup/1.0",
                    "groupType": "editable",
                    "title": "Cores Info",
                    "items": [
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "WVDAgentHealthStatus\r\n| where _ResourceId =~ \"{HostPool}\"\r\n| extend Sessions= todouble(ActiveSessions) + todouble(InactiveSessions)\r\n| make-series [\"Users/cores\"] = max(Sessions/{Cores}) on TimeGenerated step {TimeRange:grain}\r\n| extend series_stats([\"Users/cores\"])\r\n| project [\"Users/cores\"], TimeGenerated, Average = [\"series_stats_Users/cores_avg\"]\r\n| mv-expand [\"Users/cores\"], TimeGenerated\r\n| extend TimeGenerated = todatetime(TimeGenerated)\r\n| summarize arg_max(MaxSessions=todouble([\"Users/cores\"]), MaxTime=TimeGenerated), arg_min(MinSessions=todouble([\"Users/cores\"]), MinTime=TimeGenerated), Average=any(Average)\r\n| project [\"Host Pool\"]=\"{HostPool:label}\", [\"Max User/Cores\"]= MaxSessions, MaxTime, [\"Min User/Coures\"]= MinSessions, MinTime, Average\r\n\r\n",
                          "size": 4,
                          "title": "User per core summary",
                          "timeContextFromParameter": "TimeRange",
                          "queryType": 0,
                          "resourceType": "microsoft.operationalinsights/workspaces",
                          "crossComponentResources": [
                            "{poolla}"
                          ],
                          "gridSettings": {
                            "formatters": [
                              {
                                "columnMatch": "Max User/Cores",
                                "formatter": 0,
                                "formatOptions": {
                                  "customColumnWidthSetting": "9ch"
                                }
                              },
                              {
                                "columnMatch": "MaxTime",
                                "formatter": 0,
                                "formatOptions": {
                                  "customColumnWidthSetting": "20ch"
                                }
                              },
                              {
                                "columnMatch": "Min User/Coures",
                                "formatter": 0,
                                "formatOptions": {
                                  "customColumnWidthSetting": "9ch"
                                }
                              },
                              {
                                "columnMatch": "MinTime",
                                "formatter": 0,
                                "formatOptions": {
                                  "customColumnWidthSetting": "20ch"
                                }
                              },
                              {
                                "columnMatch": "Average",
                                "formatter": 0,
                                "formatOptions": {
                                  "customColumnWidthSetting": "9ch"
                                },
                                "numberFormat": {
                                  "unit": 0,
                                  "options": {
                                    "style": "decimal",
                                    "useGrouping": false,
                                    "minimumFractionDigits": 2,
                                    "maximumFractionDigits": 2
                                  }
                                }
                              }
                            ],
                            "sortBy": [
                              {
                                "itemKey": "Max User/Cores",
                                "sortOrder": 1
                              }
                            ],
                            "labelSettings": [
                              {
                                "columnId": "Max User/Cores",
                                "label": "Max"
                              },
                              {
                                "columnId": "MaxTime",
                                "label": "Max time"
                              },
                              {
                                "columnId": "Min User/Coures",
                                "label": "Min"
                              },
                              {
                                "columnId": "MinTime",
                                "label": "Min Time"
                              },
                              {
                                "columnId": "Average",
                                "label": "Avg"
                              }
                            ]
                          },
                          "sortBy": [
                            {
                              "itemKey": "Max User/Cores",
                              "sortOrder": 1
                            }
                          ],
                          "chartSettings": {
                            "group": null,
                            "createOtherGroup": 0
                          }
                        },
                        "name": "CoreSummary"
                      },
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "WVDAgentHealthStatus\r\n| where _ResourceId =~ \"{HostPool}\"\r\n| extend Sessions= todouble(ActiveSessions) + todouble(InactiveSessions)\r\n| make-series [\"Users/cores\"] = max(Sessions/{Cores}) on TimeGenerated step {TimeRange:grain}\r\n//| where array_length(TimeGenerated) > 0",
                          "size": 0,
                          "aggregation": 3,
                          "title": "Max users per core",
                          "timeContextFromParameter": "TimeRange",
                          "showExportToExcel": true,
                          "queryType": 0,
                          "resourceType": "microsoft.operationalinsights/workspaces",
                          "crossComponentResources": [
                            "{poolla}"
                          ],
                          "visualization": "timechart",
                          "chartSettings": {
                            "ySettings": {
                              "numberFormatSettings": {
                                "unit": 0,
                                "options": {
                                  "style": "decimal",
                                  "useGrouping": true,
                                  "minimumIntegerDigits": 1,
                                  "minimumSignificantDigits": 2,
                                  "maximumSignificantDigits": 2
                                }
                              },
                              "min": 0
                            }
                          }
                        },
                        "name": "MaxUserPerCore",
                        "styleSettings": {
                          "padding": "2%"
                        }
                      },
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "let WVDHosts = dynamic([{WVDHosts}]);\r\nlet hostPool = \"{HostPool:label}\";\r\nPerf\r\n| extend Computername = strcat(hostPool, '/', Computer)\r\n| where Computername in~ (WVDHosts)\r\n| where TimeGenerated {TimeRange:query}\r\n| where ObjectName == \"Processor Information\" and CounterName == \"% Processor Time\" and InstanceName == \"_Total\"\r\n| extend Computer = trim_end(@'\\..*', Computer)\r\n| make-series [\"CPU Usage\"] = avg(CounterValue) on TimeGenerated step {TimeRange:grain} by Computer",
                          "size": 0,
                          "aggregation": 3,
                          "title": "CPU usage",
                          "showExportToExcel": true,
                          "queryType": 0,
                          "resourceType": "microsoft.operationalinsights/workspaces",
                          "crossComponentResources": [
                            "{Workspace}"
                          ],
                          "visualization": "timechart",
                          "chartSettings": {
                            "seriesLabelSettings": [
                              {
                                "seriesName": "CPU Usage",
                                "label": "% CPU"
                              }
                            ],
                            "ySettings": {
                              "numberFormatSettings": {
                                "unit": 1,
                                "options": {
                                  "style": "decimal",
                                  "useGrouping": true,
                                  "minimumIntegerDigits": 1,
                                  "minimumSignificantDigits": 2,
                                  "maximumSignificantDigits": 2
                                }
                              },
                              "min": 0
                            }
                          }
                        },
                        "name": "CPUUsage",
                        "styleSettings": {
                          "padding": "2%"
                        }
                      },
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "WVDAgentHealthStatus\r\n| where _ResourceId =~ \"{HostPool}\"\r\n| extend idle = iif( (toint(ActiveSessions) + toint(InactiveSessions)) == 0, 1, 0)\r\n| summarize idle = max(idle) by bin(TimeGenerated, 1m), SessionHostName\r\n| summarize idle = countif(idle > 0) , SessionHosts = dcount(SessionHostName) by TimeGenerated\r\n| make-series [\"Session host\"] = round(avg(SessionHosts)), [\"Idle host\"] = round(avg(idle)) on TimeGenerated step {TimeRange:grain}",
                          "size": 0,
                          "aggregation": 3,
                          "title": "Session host count",
                          "timeContextFromParameter": "TimeRange",
                          "queryType": 0,
                          "resourceType": "microsoft.operationalinsights/workspaces",
                          "crossComponentResources": [
                            "{poolla}"
                          ],
                          "visualization": "timechart",
                          "chartSettings": {
                            "ySettings": {
                              "min": 0
                            }
                          }
                        },
                        "name": "SessionHostCountViz"
                      }
                    ]
                  },
                  "customWidth": "50",
                  "name": "CoresQuery"
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "HasAgentHealthTable",
              "comparison": "isEqualTo",
              "value": "1"
            },
            "name": "SessionAndCores",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let StartWin = startofday(iff({TimeRange:start}+1d <= {TimeRange:end} , {TimeRange:start}+1d, {TimeRange:start})); //adjust # of days displayed\r\nlet EndWin = endofday({TimeRange:end});\r\nlet lookbackWindow = 28d;  // 4 even weeks\r\nlet StartCountDay = StartWin - lookbackWindow;\r\nWVDConnections\r\n| where _ResourceId =~ '{HostPool}'\r\n| project CorrelationId, State, TimeGenerated, UserName\r\n| as Connections\r\n| where State == \"Started\"\r\n| extend StartTime = TimeGenerated\r\n| join kind=fullouter\r\n(\r\n    Connections\r\n    | where State == \"Completed\"\r\n    | extend EndTime = TimeGenerated\r\n)\r\non CorrelationId\r\n| extend EndTime = coalesce(EndTime, EndWin) // if connection not ended yet use lastday\r\n| where EndTime >= StartCountDay  // chop out connections the ended before our window started\r\n| extend StartTime = coalesce(StartTime, StartCountDay)  // if start aged off set at start of lookbackwindow\r\n| where StartTime <= EndWin\r\n| extend CorrelationId = coalesce(CorrelationId, CorrelationId1)  // fix fields that only came from a completed record\r\n| extend UserName = coalesce(UserName, UserName1)\r\n| project StartTime, EndTime, CorrelationId, UserName  // chop down colms to just what we need\r\n| extend StartTime=max_of(StartTime, StartCountDay), EndTime=min_of(EndTime, EndWin)  // chop connections to window\r\n| extend _bin = bin_at(StartTime, 1d, StartCountDay)  // #1 start of first day connection appears\r\n| extend _endRange = iff(EndTime + lookbackWindow > EndWin, EndWin,\r\n                             iff(EndTime + lookbackWindow - 1d < StartTime, StartTime,\r\n                                    iff(EndTime + lookbackWindow - 1d < _bin, _bin, _bin + lookbackWindow - 1d))) // #2 last day connection will appear\r\n| extend _range = range(_bin, _endRange, 1d) // #3 create a start of day timestamp for every day connection existed and/or day it will be counted\r\n| mv-expand _range to typeof(datetime) // #4 \r\n| summarize Users = dcount(UserName) by Days=bin_at(_range, 1d, StartCountDay) // #5 sum startofday timestamps\r\n| where Days>= StartWin // #6 chop off days we dont want to display\r\n| sort by Days asc\r\n\r\n",
                    "size": 1,
                    "aggregation": 5,
                    "title": "Monthly active users (MAU)",
                    "noDataMessage": "No users detected",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{poolla}"
                    ],
                    "visualization": "barchart",
                    "chartSettings": {
                      "seriesLabelSettings": [
                        {
                          "seriesName": "MAU",
                          "label": "Users"
                        }
                      ],
                      "ySettings": {
                        "min": 0
                      }
                    }
                  },
                  "customWidth": "100",
                  "showPin": true,
                  "name": "MonthlyUsers",
                  "styleSettings": {
                    "showBorder": true
                  }
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let StartWin = startofday({TimeRange:start});    // each day to start at midnight\r\nlet EndWin = startofday({TimeRange:end}+1d);\r\nWVDConnections\r\n| where _ResourceId =~ '{HostPool}'\r\n| project CorrelationId, State, TimeGenerated, UserName\r\n| as Connections\r\n| where State == \"Started\"\r\n| extend StartTime = TimeGenerated\r\n| join kind=fullouter\r\n(\r\n    Connections\r\n    | where State == \"Completed\"\r\n    | extend EndTime = TimeGenerated\r\n)\r\non CorrelationId\r\n| extend EndTime = coalesce(EndTime, EndWin)  // if no end use end of window\r\n| where EndTime >= StartWin\r\n| extend StartTime = coalesce(StartTime, StartWin)  // if start aged off use 1st day\r\n| where StartTime <= EndWin\r\n| extend CorrelationId = coalesce(CorrelationId, CorrelationId1)  // fix fields that only came from a completed record\r\n| project StartTime, EndTime, CorrelationId, State = coalesce(State1, State)\r\n| extend StartTime=max_of(StartTime, StartWin), EndTime=min_of(EndTime, EndWin)  // chop connections to window\r\n| extend _bin = bin_at(StartTime, 1d, StartWin) // first bin must be at start of day\r\n| extend TimeSlot = range(_bin, EndTime, 1d)\r\n| mv-expand TimeSlot to typeof(datetime)\r\n| make-series Sessions = dcount(CorrelationId) default=0 on TimeSlot from StartWin to EndWin step 1d by State\r\n| project Days = TimeSlot, Sessions, State, series_stats(Sessions)",
                    "size": 1,
                    "aggregation": 5,
                    "title": "Daily connections and reconnections",
                    "noDataMessage": "No sessions detected",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{poolla}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Days",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "Sessions",
                          "formatter": 9,
                          "formatOptions": {
                            "palette": "blue",
                            "customColumnWidthSetting": "180px"
                          }
                        },
                        {
                          "columnMatch": "State",
                          "formatter": 0,
                          "formatOptions": {
                            "customColumnWidthSetting": "12ch"
                          }
                        },
                        {
                          "columnMatch": "series_stats_Sessions_min",
                          "formatter": 0,
                          "formatOptions": {
                            "customColumnWidthSetting": "9ch"
                          },
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal",
                              "useGrouping": false,
                              "minimumIntegerDigits": 1
                            }
                          }
                        },
                        {
                          "columnMatch": "series_stats_Sessions_min_idx",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "series_stats_Sessions_max",
                          "formatter": 0,
                          "formatOptions": {
                            "customColumnWidthSetting": "10ch"
                          },
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal",
                              "useGrouping": false,
                              "minimumIntegerDigits": 1
                            }
                          }
                        },
                        {
                          "columnMatch": "series_stats_Sessions_max_idx",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "series_stats_Sessions_avg",
                          "formatter": 0,
                          "formatOptions": {
                            "customColumnWidthSetting": "12ch"
                          },
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal",
                              "useGrouping": false,
                              "minimumIntegerDigits": 1,
                              "minimumFractionDigits": 1,
                              "maximumFractionDigits": 1
                            }
                          }
                        },
                        {
                          "columnMatch": "series_stats_Sessions_stdev",
                          "formatter": 0,
                          "formatOptions": {
                            "customColumnWidthSetting": "12ch"
                          },
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal",
                              "useGrouping": false,
                              "minimumIntegerDigits": 1,
                              "minimumFractionDigits": 1,
                              "maximumFractionDigits": 1
                            }
                          }
                        },
                        {
                          "columnMatch": "series_stats_Sessions_variance",
                          "formatter": 5
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "series_stats_Sessions_min",
                          "label": "Min"
                        },
                        {
                          "columnId": "series_stats_Sessions_max",
                          "label": "Max"
                        },
                        {
                          "columnId": "series_stats_Sessions_avg",
                          "label": "Avg"
                        },
                        {
                          "columnId": "series_stats_Sessions_stdev",
                          "label": "Std dev"
                        }
                      ]
                    },
                    "chartSettings": {
                      "ySettings": {
                        "min": 0
                      }
                    }
                  },
                  "customWidth": "50",
                  "showPin": true,
                  "name": "DailyConnects",
                  "styleSettings": {
                    "showBorder": true
                  }
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let StartWin = startofday({TimeRange:start});    // each day to start at midnight\r\nlet EndWin = startofday({TimeRange:end}+1d);\r\nWVDConnections\r\n| where _ResourceId =~ '{HostPool}'\r\n| project CorrelationId, State, TimeGenerated, UserName\r\n| as Connections\r\n| where State == \"Started\"\r\n| extend StartTime = TimeGenerated\r\n| join kind=fullouter\r\n(\r\n    Connections\r\n    | where State == \"Completed\"\r\n    | extend EndTime = TimeGenerated\r\n)\r\non CorrelationId\r\n| extend EndTime = coalesce(EndTime, EndWin)  // if no end use end of window\r\n| where EndTime >= StartWin\r\n| extend StartTime = coalesce(StartTime, StartWin)  // if start aged off use 1st day\r\n| where StartTime <= EndWin\r\n| extend CorrelationId = coalesce(CorrelationId, CorrelationId1)  // fix fields that only came from a completed record\r\n| project StartTime, EndTime, CorrelationId, State = coalesce(State1, State)\r\n| extend StartTime=max_of(StartTime, StartWin), EndTime=min_of(EndTime, EndWin)  // chop connections to window\r\n| extend _bin = bin_at(StartTime, 1d, StartWin) // first bin must be at start of day\r\n| extend TimeSlot = range(_bin, EndTime, 1d)\r\n| mv-expand TimeSlot to typeof(datetime)\r\n| extend StartTm = iff(StartTime > TimeSlot, StartTime, TimeSlot)\r\n| extend EndTm = iff(EndTime < TimeSlot + 1d, EndTime, TimeSlot + 1d)\r\n| extend Hours = (EndTm - StartTm) / 1h\r\n| make-series Hours = sum(Hours) default=0 on TimeSlot from StartWin to EndWin step 1d\r\n| project Hours, series_stats(Hours)\r\n",
                    "size": 1,
                    "aggregation": 5,
                    "title": "Daily connected hours",
                    "noDataMessage": "No users detected",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{poolla}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Hours",
                          "formatter": 9,
                          "formatOptions": {
                            "palette": "blue"
                          }
                        },
                        {
                          "columnMatch": "series_stats_Hours_min",
                          "formatter": 0,
                          "formatOptions": {
                            "customColumnWidthSetting": "12ch"
                          },
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal",
                              "minimumIntegerDigits": 1,
                              "minimumFractionDigits": 1,
                              "maximumFractionDigits": 1
                            }
                          }
                        },
                        {
                          "columnMatch": "series_stats_Hours_min_idx",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "series_stats_Hours_max",
                          "formatter": 0,
                          "formatOptions": {
                            "customColumnWidthSetting": "12ch"
                          },
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal",
                              "minimumIntegerDigits": 1,
                              "minimumFractionDigits": 1,
                              "maximumFractionDigits": 1
                            }
                          }
                        },
                        {
                          "columnMatch": "series_stats_Hours_max_idx",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "series_stats_Hours_avg",
                          "formatter": 0,
                          "formatOptions": {
                            "customColumnWidthSetting": "12ch"
                          },
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal",
                              "useGrouping": false,
                              "minimumIntegerDigits": 1,
                              "minimumFractionDigits": 1,
                              "maximumFractionDigits": 1
                            }
                          }
                        },
                        {
                          "columnMatch": "series_stats_Hours_stdev",
                          "formatter": 0,
                          "formatOptions": {
                            "customColumnWidthSetting": "12ch"
                          },
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal",
                              "useGrouping": false,
                              "minimumIntegerDigits": 1,
                              "minimumFractionDigits": 1,
                              "maximumFractionDigits": 1
                            }
                          }
                        },
                        {
                          "columnMatch": "series_stats_Hours_variance",
                          "formatter": 5
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "series_stats_Hours_min",
                          "label": "Min"
                        },
                        {
                          "columnId": "series_stats_Hours_max",
                          "label": "Max"
                        },
                        {
                          "columnId": "series_stats_Hours_avg",
                          "label": "Avg"
                        },
                        {
                          "columnId": "series_stats_Hours_stdev",
                          "label": "Std dev"
                        }
                      ]
                    },
                    "chartSettings": {
                      "ySettings": {
                        "min": 0
                      }
                    }
                  },
                  "customWidth": "50",
                  "showPin": true,
                  "name": "Daily Connected Hours",
                  "styleSettings": {
                    "showBorder": true
                  }
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let StartWin = startofday({TimeRange:start});// each day to start at midnight\r\nlet EndWin = startofday({TimeRange:end}+1d);\r\nWVDConnections\r\n| where _ResourceId =~ '{HostPool}'\r\n| project CorrelationId, State, TimeGenerated, UserName\r\n| as Connections\r\n| where State == \"Started\"\r\n| extend StartTime = TimeGenerated\r\n| join kind=fullouter\r\n(\r\n    Connections\r\n    | where State == \"Completed\"\r\n    | extend EndTime = TimeGenerated\r\n)\r\non CorrelationId\r\n| extend EndTime = coalesce(EndTime, EndWin)  // if no end use end of window\r\n| where EndTime >= StartWin\r\n| extend StartTime = coalesce(StartTime, StartWin)  // if start aged off use 1st day\r\n| where StartTime <= EndWin\r\n| extend CorrelationId = coalesce(CorrelationId, CorrelationId1)  // fix fields that only came from a completed record\r\n| extend UserName = coalesce(UserName, UserName1)  // if start aged off use 1st day\r\n| project StartTime, EndTime, CorrelationId, State = coalesce(State1, State), UserName\r\n| extend StartTime=max_of(StartTime, StartWin), EndTime=min_of(EndTime, EndWin)  // chop time for connections to window\r\n| extend Duration = (EndTime - StartTime)/1h\r\n| summarize Hours = sum(Duration) by UserName\r\n| top 10 by Hours desc nulls last",
                    "size": 1,
                    "aggregation": 5,
                    "title": "Top 10 users by connection time",
                    "noDataMessage": "No connections found",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{poolla}"
                    ],
                    "visualization": "barchart",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Hours",
                          "formatter": 9,
                          "formatOptions": {
                            "palette": "blue"
                          }
                        },
                        {
                          "columnMatch": "series_stats_Hours_min",
                          "formatter": 0,
                          "formatOptions": {
                            "customColumnWidthSetting": "12ch"
                          },
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal",
                              "minimumIntegerDigits": 1,
                              "minimumFractionDigits": 1,
                              "maximumFractionDigits": 1
                            }
                          }
                        },
                        {
                          "columnMatch": "series_stats_Hours_min_idx",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "series_stats_Hours_max",
                          "formatter": 0,
                          "formatOptions": {
                            "customColumnWidthSetting": "12ch"
                          },
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal",
                              "minimumIntegerDigits": 1,
                              "minimumFractionDigits": 1,
                              "maximumFractionDigits": 1
                            }
                          }
                        },
                        {
                          "columnMatch": "series_stats_Hours_max_idx",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "series_stats_Hours_avg",
                          "formatter": 0,
                          "formatOptions": {
                            "customColumnWidthSetting": "12ch"
                          },
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal",
                              "useGrouping": false,
                              "minimumIntegerDigits": 1,
                              "minimumFractionDigits": 1,
                              "maximumFractionDigits": 1
                            }
                          }
                        },
                        {
                          "columnMatch": "series_stats_Hours_stdev",
                          "formatter": 0,
                          "formatOptions": {
                            "customColumnWidthSetting": "12ch"
                          },
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal",
                              "useGrouping": false,
                              "minimumIntegerDigits": 1,
                              "minimumFractionDigits": 1,
                              "maximumFractionDigits": 1
                            }
                          }
                        },
                        {
                          "columnMatch": "series_stats_Hours_variance",
                          "formatter": 5
                        }
                      ]
                    },
                    "chartSettings": {
                      "xAxis": "UserName",
                      "yAxis": [
                        "Hours"
                      ],
                      "createOtherGroup": 10,
                      "ySettings": {
                        "numberFormatSettings": {
                          "unit": 26,
                          "options": {
                            "style": "decimal",
                            "useGrouping": true,
                            "maximumSignificantDigits": 2
                          }
                        },
                        "min": 0
                      }
                    }
                  },
                  "customWidth": "50",
                  "showPin": true,
                  "name": "User Usage Distibution",
                  "styleSettings": {
                    "showBorder": true
                  }
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let StartWin = startofday({TimeRange:start});// each day to start at midnight\r\nlet EndWin = startofday({TimeRange:end}+1d);\r\nWVDConnections\r\n| where _ResourceId =~ '{HostPool}'\r\n| project CorrelationId, State, TimeGenerated, UserName, SessionHostName\r\n| as Connections\r\n| where State == \"Started\"\r\n| extend StartTime = TimeGenerated\r\n| join kind=fullouter\r\n(\r\n    Connections\r\n    | where State == \"Completed\"\r\n    | extend EndTime = TimeGenerated\r\n)\r\non CorrelationId\r\n| extend EndTime = coalesce(EndTime, EndWin)  // if no end use end of window\r\n| where EndTime >= StartWin\r\n| extend StartTime = coalesce(StartTime, StartWin)  // if start aged off use 1st day\r\n| where StartTime <= EndWin\r\n| extend CorrelationId = coalesce(CorrelationId, CorrelationId1)  // fix fields that only came from a completed record\r\n| extend UserName = coalesce(UserName, UserName1)  // if start aged off use 1st day\r\n| project StartTime, EndTime, CorrelationId, State = coalesce(State1, State), UserName, SessionHostName\r\n| extend StartTime=max_of(StartTime, StartWin), EndTime=min_of(EndTime, EndWin)  // chop time for connections to window\r\n| extend Duration = (EndTime - StartTime)/1h\r\n| summarize Hours = sum(Duration) by Computer = trim_end(@'\\..*', SessionHostName)\r\n| top 10 by Hours desc nulls last",
                    "size": 1,
                    "aggregation": 5,
                    "title": "Top 10 hosts by connection time",
                    "noDataMessage": "No connections found",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{poolla}"
                    ],
                    "visualization": "barchart",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Hours",
                          "formatter": 9,
                          "formatOptions": {
                            "palette": "blue"
                          }
                        },
                        {
                          "columnMatch": "series_stats_Hours_min",
                          "formatter": 0,
                          "formatOptions": {
                            "customColumnWidthSetting": "12ch"
                          },
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal",
                              "minimumIntegerDigits": 1,
                              "minimumFractionDigits": 1,
                              "maximumFractionDigits": 1
                            }
                          }
                        },
                        {
                          "columnMatch": "series_stats_Hours_min_idx",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "series_stats_Hours_max",
                          "formatter": 0,
                          "formatOptions": {
                            "customColumnWidthSetting": "12ch"
                          },
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal",
                              "minimumIntegerDigits": 1,
                              "minimumFractionDigits": 1,
                              "maximumFractionDigits": 1
                            }
                          }
                        },
                        {
                          "columnMatch": "series_stats_Hours_max_idx",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "series_stats_Hours_avg",
                          "formatter": 0,
                          "formatOptions": {
                            "customColumnWidthSetting": "12ch"
                          },
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal",
                              "useGrouping": false,
                              "minimumIntegerDigits": 1,
                              "minimumFractionDigits": 1,
                              "maximumFractionDigits": 1
                            }
                          }
                        },
                        {
                          "columnMatch": "series_stats_Hours_stdev",
                          "formatter": 0,
                          "formatOptions": {
                            "customColumnWidthSetting": "12ch"
                          },
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal",
                              "useGrouping": false,
                              "minimumIntegerDigits": 1,
                              "minimumFractionDigits": 1,
                              "maximumFractionDigits": 1
                            }
                          }
                        },
                        {
                          "columnMatch": "series_stats_Hours_variance",
                          "formatter": 5
                        }
                      ]
                    },
                    "chartSettings": {
                      "createOtherGroup": 10,
                      "ySettings": {
                        "numberFormatSettings": {
                          "unit": 26,
                          "options": {
                            "style": "decimal",
                            "useGrouping": true,
                            "maximumSignificantDigits": 2
                          }
                        },
                        "min": 0
                      }
                    }
                  },
                  "customWidth": "50",
                  "showPin": true,
                  "name": "Host Usage Distibution",
                  "styleSettings": {
                    "showBorder": true
                  }
                },
                {
                  "type": 12,
                  "content": {
                    "version": "NotebookGroup/1.0",
                    "groupType": "editable",
                    "title": "Connection time for all users",
                    "expandable": true,
                    "items": [
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "let StartWin = startofday({TimeRange:start});// each day to start at midnight\r\nlet EndWin = startofday({TimeRange:end}+1d);\r\nWVDConnections\r\n| where _ResourceId =~ '{HostPool}'\r\n| project CorrelationId, State, TimeGenerated, UserName\r\n| as Connections\r\n| where State == \"Started\"\r\n| extend StartTime = TimeGenerated\r\n| join kind=fullouter\r\n(\r\n    Connections\r\n    | where State == \"Completed\"\r\n    | extend EndTime = TimeGenerated\r\n)\r\non CorrelationId\r\n| extend EndTime = coalesce(EndTime, EndWin)  // if no end use end of window\r\n| where EndTime >= StartWin\r\n| extend StartTime = coalesce(StartTime, StartWin)\r\n| where StartTime <= EndWin\r\n| extend CorrelationId = coalesce(CorrelationId, CorrelationId1)  // fix fields that only came from a completed record\r\n| extend UserName = coalesce(UserName, UserName1)  // if start aged off use 1st day\r\n| project StartTime, EndTime, CorrelationId, State = coalesce(State1, State), UserName\r\n| extend StartTime=max_of(StartTime, StartWin), EndTime=min_of(EndTime, EndWin)  // chop time for connections to window\r\n| extend Duration = (EndTime - StartTime)/1h\r\n| summarize Hours = sum(Duration) by UserName\r\n| sort by Hours desc",
                          "size": 1,
                          "aggregation": 5,
                          "showAnalytics": true,
                          "title": "Connection time by user",
                          "noDataMessage": "No connections found",
                          "showExportToExcel": true,
                          "queryType": 0,
                          "resourceType": "microsoft.operationalinsights/workspaces",
                          "crossComponentResources": [
                            "{poolla}"
                          ],
                          "visualization": "table",
                          "gridSettings": {
                            "formatters": [
                              {
                                "columnMatch": "Hours",
                                "formatter": 0,
                                "numberFormat": {
                                  "unit": 0,
                                  "options": {
                                    "style": "decimal",
                                    "minimumFractionDigits": 1,
                                    "maximumFractionDigits": 1
                                  }
                                }
                              }
                            ],
                            "rowLimit": 5000
                          },
                          "chartSettings": {
                            "xAxis": "UserName",
                            "yAxis": [
                              "Hours"
                            ],
                            "createOtherGroup": 10,
                            "ySettings": {
                              "numberFormatSettings": {
                                "unit": 26,
                                "options": {
                                  "style": "decimal",
                                  "useGrouping": true,
                                  "maximumSignificantDigits": 2
                                }
                              },
                              "min": 0
                            }
                          }
                        },
                        "customWidth": "50",
                        "showPin": true,
                        "name": "AllUserDistibution ",
                        "styleSettings": {
                          "showBorder": true
                        }
                      }
                    ]
                  },
                  "name": "AllusersUsageGroup",
                  "styleSettings": {
                    "padding": "10"
                  }
                }
              ]
            },
            "name": "Trends",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "FSLogix profile compaction",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "Event\r\n| where _ResourceId in~ ({WVDHostsId})\r\n| where EventLog == 'Microsoft-FSLogix-Apps/Operational' and EventID == 57\r\n| extend parsedData = parse_xml(EventData).DataItem.EventData.Data\r\n| project TimeGenerated, WasCompacted= tobool(parsedData[1]['#text']),\r\n    MaxSupportedSizeMB= toint(parsedData[2]['#text']),\r\n    MinSupportedSizeMB= toint(parsedData[3]['#text']),\r\n    SizeBeforeMB= toint(parsedData[4]['#text']),\r\n    SizeAfterMB= toint(parsedData[5]['#text']),\r\n    SavedSpaceMB = toint(parsedData[6]['#text'])\r\n| where WasCompacted\r\n| summarize Total=sum(SavedSpaceMB), Percent=avg(todecimal(SizeBeforeMB - SizeAfterMB)/SizeBeforeMB), count = count()\r\n",
                    "size": 4,
                    "title": "Profile space saved",
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspace}"
                    ],
                    "visualization": "tiles",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "Title",
                        "formatter": 5
                      },
                      "leftContent": {
                        "columnMatch": "Total",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "auto"
                        },
                        "numberFormat": {
                          "unit": 4,
                          "options": {
                            "style": "decimal",
                            "minimumFractionDigits": 1,
                            "maximumFractionDigits": 2
                          }
                        }
                      },
                      "rightContent": {
                        "columnMatch": "Percent",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "auto"
                        },
                        "numberFormat": {
                          "unit": 0,
                          "options": {
                            "style": "percent"
                          }
                        }
                      },
                      "secondaryContent": {
                        "columnMatch": "count",
                        "formatter": 18,
                        "formatOptions": {
                          "thresholdsOptions": "colors",
                          "thresholdsGrid": [
                            {
                              "operator": "Default",
                              "thresholdValue": null,
                              "representation": null,
                              "text": "Number of compactions: {0}"
                            }
                          ],
                          "compositeBarSettings": {
                            "labelText": "",
                            "columnSettings": []
                          }
                        }
                      },
                      "showBorder": true,
                      "size": "auto"
                    }
                  },
                  "customWidth": "20",
                  "name": "CompactSpace"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "Event\r\n| where _ResourceId in~ ({WVDHostsId})\r\n| where EventLog == 'Microsoft-FSLogix-Apps/Operational' and EventID == 57\r\n| extend parsedData = parse_xml(EventData).DataItem.EventData.Data\r\n| project TimeGenerated, WasCompacted= tobool(parsedData[1]['#text']),\r\n    Time = toint(parsedData[7]['#text'])\r\n| where WasCompacted\r\n| summarize Median = percentiles(Time, 50), P95=percentile(Time, 95), Max=max(Time), Min= min(Time) \r\n//| where not(isnan(Average))\r\n\r\n",
                    "size": 4,
                    "title": "Time to compact",
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspace}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Median",
                          "formatter": 0,
                          "numberFormat": {
                            "unit": 23,
                            "options": {
                              "style": "decimal",
                              "maximumFractionDigits": 1
                            }
                          }
                        },
                        {
                          "columnMatch": "P95",
                          "formatter": 0,
                          "numberFormat": {
                            "unit": 23,
                            "options": {
                              "style": "decimal",
                              "maximumFractionDigits": 1
                            }
                          }
                        },
                        {
                          "columnMatch": "Max",
                          "formatter": 0,
                          "numberFormat": {
                            "unit": 23,
                            "options": {
                              "style": "decimal",
                              "maximumFractionDigits": 1
                            }
                          }
                        },
                        {
                          "columnMatch": "Min",
                          "formatter": 0,
                          "numberFormat": {
                            "unit": 23,
                            "options": {
                              "style": "decimal",
                              "maximumFractionDigits": 1
                            }
                          }
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "Median",
                          "label": "Median"
                        },
                        {
                          "columnId": "P95",
                          "label": "P95"
                        },
                        {
                          "columnId": "Max",
                          "label": "Max"
                        },
                        {
                          "columnId": "Min",
                          "label": "Min"
                        }
                      ]
                    }
                  },
                  "customWidth": "40",
                  "name": "CompactTime"
                }
              ]
            },
            "name": "FslogixGroup",
            "styleSettings": {
              "showBorder": true
            }
          }
        ]
      },
      "name": "Utilization"
    }
  ],
  "fallbackResourceIds": [
    "Azure Monitor"
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
