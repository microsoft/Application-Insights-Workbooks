{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "# Cross Region Replication\r\n\r\nTo ensure customers are supported across the world, Azure maintains multiple geographies. These discrete demarcations define disaster recovery and data residency boundaries across one or multiple Azure regions. Cross-region replication is one of several important pillars in Azure's business continuity and disaster recovery strategy. It builds upon the synchronous replication of your applications and data that already exists using availability zones within your primary Azure region for high availability.\r\n\r\nNot all Azure services automatically replicate data or automatically failover from a failed region to cross-replicate to another enabled region. In these scenarios, recovery and replication must be configured by the customer. These examples illustrate the shared responsibility model, which is a fundamental pillar in your disaster recovery strategy. Azure does not require you to use cross-region replication, and you can use services to build resiliency without cross-replicating to another enabled region. However, we strongly recommend that you configure your essential services across regions to benefit from [isolation](https://learn.microsoft.com/azure/security/fundamentals/isolation-choices) and improve [availability](https://learn.microsoft.com/azure/reliability/availability-zones-service-support).\r\n\r\n<span style=\"color:maroon\"> **Required Action:** </span>  For services that support multiple active regions, we recommend utilizing multiple enabled regions whenever possible. This practice ensures optimal availability for applications and minimizes recovery time in the event of an availability issue. Whenever feasible, design your application for  and ease of disaster recovery. You can learn more about maximizing resiliency [here](https://review.learn.microsoft.com/azure/architecture/framework/resiliency/overview) and about disaster recovery [here](https://review.learn.microsoft.com/azure/architecture/framework/resiliency/backup-and-recovery)."
      },
      "name": "Summary Header",
      "styleSettings": {
        "margin": "0",
        "padding": "0"
      }
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "crossComponentResources": [
          "{Subscriptions}"
        ],
        "parameters": [
          {
            "id": "16030a75-1de4-4dad-bfad-0cb49f81690c",
            "version": "KqlParameterItem/1.0",
            "name": "Subscriptions",
            "label": "Subscription",
            "type": 6,
            "isRequired": true,
            "isGlobal": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "includeAll": false,
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "defaultValue": "value::all",
            "value": [
              "value::all"
            ]
          },
          {
            "id": "d3cb53ad-aabe-43cc-9019-f317ece41ea5",
            "version": "KqlParameterItem/1.0",
            "name": "ResourceGroup",
            "label": "Resource group",
            "type": 2,
            "description": "A resource group is a collection of resources that share the same lifecycle, permissions, and policies",
            "isGlobal": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "resources\r\n| distinct resourceGroup",
            "crossComponentResources": [
              "{Subscriptions}"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "selectAllValue": "*",
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "defaultValue": "value::all",
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "value": [
              "value::all"
            ]
          },
          {
            "id": "fd8fc823-879f-4647-b9ea-23e37fe830c7",
            "version": "KqlParameterItem/1.0",
            "name": "Region",
            "label": "Location",
            "type": 8,
            "description": "A geographic location where resources are located",
            "isGlobal": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "includeAll": true,
              "selectAllValue": "*",
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "defaultValue": "value::all",
            "value": [
              "value::all"
            ]
          },
          {
            "id": "4a3b2421-3c79-468e-b7b2-42a9b5320a9f",
            "version": "KqlParameterItem/1.0",
            "name": "Environment",
            "type": 2,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "resources\r\n| extend Environment = case(\r\ntags.Environment <> \"\", replace(\"\\\\\\\\\", \"<Backslash>\", tostring(tags.Environment)),\r\ntags.environment <> \"\", replace(\"\\\\\\\\\", \"<Backslash>\", tostring(tags.environment)),\r\ntags.Env <> \"\", replace(\"\\\\\\\\\", \"<Backslash>\", tostring(tags.Env)),\r\ntags.env <> \"\", replace(\"\\\\\\\\\", \"<Backslash>\", tostring(tags.env)),\r\ntags.Environment <> \"\", tags.Environment,\r\ntags.environment <> \"\", tags.environment,\r\ntags.Env <> \"\", tags.Env,\r\ntags.env <> \"\", tags.env,\r\ntolower(name) contains \"prod\", \"Production\",\r\ntolower(name) contains \"dev\", \"Development\",\r\ntolower(name) contains \"qa\", \"QA\",\r\ntolower(name) contains \"uat\", \"UAT\",\r\ntolower(name) contains \"sit\", \"SIT\",\r\ntolower(name) contains \"test\", \"Test\",\r\n\"Undefined\")\r\n| distinct Environment",
            "crossComponentResources": [
              "{Subscriptions}"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "selectAllValue": "*",
              "showDefault": false
            },
            "defaultValue": "value::all",
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "value": [
              "value::all"
            ]
          },
          {
            "id": "3dddc63e-481a-4687-98c6-0f0f325a223e",
            "version": "KqlParameterItem/1.0",
            "name": "TagName",
            "label": "Tag Name",
            "type": 2,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "Resources\r\n| where tags != '' and tags != '[]'\r\n| mvexpand tags\r\n| extend tagName = replace(\"\\\\\\\\\", \"<Backslash>\", tostring(bag_keys(tags)[0]))\r\n| distinct tagName\r\n| sort by tagName asc",
            "crossComponentResources": [
              "{Subscriptions}"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "selectAllValue": "*",
              "showDefault": false
            },
            "defaultValue": "value::all",
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "67514ca5-c65b-4121-b489-b92c61a07b24",
            "version": "KqlParameterItem/1.0",
            "name": "TagValue",
            "label": "Tag Value",
            "type": 2,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "Resources\r\n| mvexpand tags\r\n| extend tagName = replace(\"\\\\\\\\\", \"<Backslash>\", tostring(bag_keys(tags)[0]))\r\n| extend tagValue = replace(\"\\\\\\\\\", \"<Backslash>\", tostring(tags[tagName]))\r\n| where tags != '' and tags != '[]'  \r\n| where ('*' in (dynamic([{TagName}])) or tagName in (dynamic([{TagName}]))) \r\n| distinct tagValue\r\n| sort by tagValue asc",
            "crossComponentResources": [
              "{Subscriptions}"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "selectAllValue": "*",
              "showDefault": false
            },
            "defaultValue": "value::all",
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          }
        ],
        "style": "above",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources"
      },
      "name": "ParameterDeclaration"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "resources\r\n| where location !contains \"EUAP\"\r\n| where type in~ ('microsoft.RECOVERYSERVICES/VAULTS','MICROSOFT.NETAPP/NETAPPACCOUNTS/CAPACITYPOOLS/VOLUMES')\r\n| where ('*' in (dynamic([{ResourceGroup}])) or resourceGroup in (dynamic([{ResourceGroup}]))) \r\n| where ('*' in (dynamic([{Region}])) or location in (dynamic([{Region}])))\r\n| extend Environment = case(\r\n    tags.Environment <> \"\", replace(\"\\\\\\\\\", \"<Backslash>\", tostring(tags.Environment)),\r\n    tags.environment <> \"\", replace(\"\\\\\\\\\", \"<Backslash>\", tostring(tags.environment)),\r\n    tags.Env <> \"\", tags.Env,\r\n    tags.env <> \"\", tags.env,\r\n    tolower(name) contains \"prod\", \"Production\",\r\n    tolower(name) contains \"dev\", \"Development\",\r\n    tolower(name) contains \"qa\", \"QA\",\r\n    tolower(name) contains \"uat\", \"UAT\",\r\n    tolower(name) contains \"sit\", \"SIT\",\r\n    tolower(name) contains \"test\", \"Test\",\r\n\"Undefined\")\r\n| where ('*' in (dynamic([{Environment}])) or Environment in (dynamic([{Environment}])))\r\n| join kind = inner(\r\n    resources\r\n    | extend tagName = replace(\"\\\\\\\\\", \"<Backslash>\", tostring(bag_keys(tags)[0]))\r\n    | extend tagValue = replace(\"\\\\\\\\\", \"<Backslash>\", tostring(tags[tagName]))\r\n    | distinct tagName,tagValue,id\r\n    | where (('*' in (dynamic([{TagName}])) or tagName in (dynamic([{TagName}])))) and (('*' in (dynamic([{TagValue}])) or tagValue in (dynamic([{TagValue}]))))\r\n    | distinct id\r\n)\r\non id\r\n| project \r\n    Type = tolower(type),\r\n    SkuName = tolower(sku.tier),\r\n    Kind = tolower(kind),\r\n    SubscriptionId = subscriptionId,\r\n    id = tolower(tostring(id)),\r\n    Location = tolower(location),\r\n    ResourceGroup = resourceGroup\r\n  | join kind=leftouter \r\n  (\r\n    advisorresources\r\n    | where properties.shortDescription  contains \"Implement disaster recovery strategies for your Azure NetApp Files Resources\" or \r\n      properties.shortDescription contains \"Enable Cross Region Restore for your recovery Services Vault\"\r\n    | project id=tolower(tostring(properties.resourceMetadata.resourceId)), properties.shortDescription.solution, identity\r\n ) on id\r\n| extend  RegionRedundancy=iif(isempty(id1), \"Configured\", \"Not Configured\")\r\n| extend Configuration = case(\r\n    (Type contains 'MICROSOFT.RECOVERYSERVICES/VAULTS'), \"Enable Cross Region Restore\",\r\n    (Type contains 'MICROSOFT.NETAPP/NETAPPACCOUNTS/CAPACITYPOOLS/VOLUMES'), \"Implement disaster recovery strategies\",\r\n      \"Other\"\r\n    )\r\n| extend DocumentLink = case(\r\n    (Type contains 'MICROSOFT.RECOVERYSERVICES/VAULTS'), \"https://learn.microsoft.com/azure/backup/backup-azure-arm-restore-vms?WT.mc_id=Portal-Microsoft_Azure_Expert#cross-region-restore\",\r\n    (Type contains 'MICROSOFT.NETAPP/NETAPPACCOUNTS/CAPACITYPOOLS/VOLUMES'), \"https://aka.ms/anfcrr\",\r\n      \"https://learn.microsoft.com\"\r\n    ),\r\n    Restrictions = \"\",\r\n    RestrictionLink = \"\"\r\n| summarize ResourceCount=count() by Type, RegionRedundancy, Configuration, DocumentLink, Restrictions, RestrictionLink\r\n| project \r\n    Type, \r\n    Configuration, \r\n    DocumentLink, \r\n    Restrictions,\r\n    RestrictionLink,\r\n    Configured=iff(RegionRedundancy=='Configured', ResourceCount, 0), \r\n    NotConfigured=iff(RegionRedundancy=='Not Configured', ResourceCount, 0)\r\n| summarize TotalResourceCount=sum(Configured)+sum(NotConfigured),Configured=sum(Configured), NotConfigured=sum(NotConfigured) \r\nby Type, Configuration, DocumentLink,Restrictions,RestrictionLink\r\n| extend ConfiguredDisplay= Configured* 100.0/TotalResourceCount",
        "size": 0,
        "title": "Hidden-Summary-Advisor-Query",
        "exportMultipleValues": true,
        "exportedParameters": [
          {
            "fieldName": "Type",
            "parameterName": "SelectedService",
            "parameterType": 1
          }
        ],
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "{Subscriptions}"
        ],
        "visualization": "table",
        "sortBy": [],
        "tileSettings": {
          "showBorder": false,
          "titleContent": {
            "columnMatch": "Service",
            "formatter": 1
          },
          "leftContent": {
            "columnMatch": "count_",
            "formatter": 12,
            "formatOptions": {
              "palette": "auto"
            },
            "numberFormat": {
              "unit": 17,
              "options": {
                "maximumSignificantDigits": 3,
                "maximumFractionDigits": 2
              }
            }
          }
        },
        "graphSettings": {
          "type": 0,
          "topContent": {
            "columnMatch": "Service",
            "formatter": 1
          },
          "centerContent": {
            "columnMatch": "count_",
            "formatter": 1,
            "numberFormat": {
              "unit": 17,
              "options": {
                "maximumSignificantDigits": 3,
                "maximumFractionDigits": 2
              }
            }
          }
        }
      },
      "conditionalVisibility": {
        "parameterName": "showtable",
        "comparison": "isEqualTo",
        "value": "show"
      },
      "customWidth": "20",
      "name": "Summary-Advisor-Query",
      "styleSettings": {
        "maxWidth": "20"
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "resources\r\n| where location !contains \"EUAP\"\r\n| where ('*' in (dynamic([{ResourceGroup}])) or resourceGroup in (dynamic([{ResourceGroup}]))) \r\n| where ('*' in (dynamic([{Region}])) or location in (dynamic([{Region}])))\r\n| where \r\n    (type == 'microsoft.compute/virtualmachines') or \r\n    (type == 'microsoft.documentdb/databaseaccounts') or\r\n    (type == 'microsoft.cache/redis') or\r\n    (type == \"microsoft.storage/storageaccounts\")\r\n| extend Environment = case(\r\n    tags.Environment <> \"\", replace(\"\\\\\\\\\", \"<Backslash>\", tostring(tags.Environment)),\r\n    tags.environment <> \"\", replace(\"\\\\\\\\\", \"<Backslash>\", tostring(tags.environment)),\r\n    tags.Env <> \"\", tags.Env,\r\n    tags.env <> \"\", tags.env,\r\n    tolower(name) contains \"prod\", \"Production\",\r\n    tolower(name) contains \"dev\", \"Development\",\r\n    tolower(name) contains \"qa\", \"QA\",\r\n    tolower(name) contains \"uat\", \"UAT\",\r\n    tolower(name) contains \"sit\", \"SIT\",\r\n    tolower(name) contains \"test\", \"Test\",\r\n\"Undefined\")\r\n| where ('*' in (dynamic([{Environment}])) or Environment in (dynamic([{Environment}])))\r\n| join kind = inner(\r\n    resources\r\n    | extend tagName = replace(\"\\\\\\\\\", \"<Backslash>\", tostring(bag_keys(tags)[0]))\r\n    | extend tagValue = replace(\"\\\\\\\\\", \"<Backslash>\", tostring(tags[tagName]))\r\n    | distinct tagName,tagValue,id\r\n    | where (('*' in (dynamic([{TagName}])) or tagName in (dynamic([{TagName}])))) and (('*' in (dynamic([{TagValue}])) or tagValue in (dynamic([{TagValue}]))))\r\n    | distinct id\r\n)\r\non id\r\n| extend skuName = case(\r\n    type == 'microsoft.compute/virtualmachines', tostring(properties.hardwareProfile.vmSize),\r\n    type == 'microsoft.documentdb/databaseaccounts', tostring(properties.databaseAccountOfferType),\r\n    type == 'microsoft.cache/redis', tostring(properties.sku.name),\r\n    type contains 'storageaccounts', tostring(replace('-', '_', tostring(iff(type =~ \"microsoft.storage/storageaccounts\", sku.name, properties.accountType)))),\r\n    \"Undefined\"\r\n    )\r\n   | project \r\n    Type = tolower(type),\r\n    SkuName = tolower(skuName),\r\n    Kind = tolower(kind),\r\n    SubscriptionId = subscriptionId,\r\n    Name = tolower(tostring(id)),\r\n    Location = tolower(location),\r\n    ResourceGroup = resourceGroup,\r\n    properties\r\n    | join kind = leftouter \r\n    (\r\n        resources\r\n        | take 1\r\n        | project Type = 'microsoft.compute/virtualmachines',Measure = 'ASR'\r\n        | union\r\n        (\r\n        resources\r\n        | take 1\r\n        | project Type = 'microsoft.compute/virtualmachines',Measure = 'Backup'\r\n        )\r\n    ) on Type\r\n    | project-away Type1\r\n    | join kind = leftouter (\r\n        recoveryservicesresources\r\n        | extend Backup= iif( type =~'microsoft.recoveryservices/vaults/backupfabrics/protectioncontainers/protecteditems' \r\n                            and properties.backupManagementType =~ 'AzureIaasVM' ,\"Configured\",\"Not Configured\")\r\n        | extend ASR= iif(type =~ 'Microsoft.RecoveryServices/vaults/replicationFabrics/replicationProtectionContainers/replicationProtectedItems' \r\n                            and properties.providerSpecificDetails.dataSourceInfo.datasourceType =~ 'AzureVm',\"Configured\",\"Not Configured\")\r\n        | project Name = case( type =~'microsoft.recoveryservices/vaults/backupfabrics/protectioncontainers/protecteditems',\r\n                        tolower(tostring(properties.dataSourceInfo.resourceID)),\r\n                        type =~ 'Microsoft.RecoveryServices/vaults/replicationFabrics/replicationProtectionContainers/replicationProtectedItems',\r\n                        Name = tolower(tostring(properties.providerSpecificDetails.dataSourceInfo.resourceId)),\"\"),Backup,ASR\r\n        |where isnotempty(Name)\r\n    )\r\n    on Name\r\n    | extend RegionRedundancy = case(\r\n    (Type contains 'virtualmachines' and Measure == 'Backup' and Backup == \"Configured\" ), \"Configured\",\r\n    (Type contains 'virtualmachines' and Measure == 'ASR' and ASR == \"Configured\" ), \"Configured\",\r\n    (Type contains 'storageaccounts' and split(SkuName, '_', 1)[0] contains \"GRS\" ), \"Configured\",\r\n    (Type == 'microsoft.documentdb/databaseaccounts' and properties.enableMultipleWriteLocations == \"true\"), \"Configured\",\r\n //-- added here\r\n    (Type == 'microsoft.cache/redis' and SkuName == 'premium' and properties.linkedServers!='[]'), \"Configured\",\r\n    (Type == 'microsoft.cache/redis' and SkuName != 'premium'), \"Not Applicable\",\r\n     \"Not Configured\"\r\n    )\r\n    | project-away Backup,ASR,Name1\r\n    | extend Configuration = case(\r\n    (Type contains 'virtualmachines' and Measure == 'Backup'), \"Enable Backup policy\",\r\n    (Type contains 'virtualmachines' and Measure == 'ASR'), \"Enable Azure Site Recovery\",\r\n    (Type contains 'storageaccounts'), \"Use *GRS/*GZRS replication\",\r\n    (Type == 'microsoft.documentdb/databaseaccounts'), \"Multiple Write Locations enabled\",\r\n    (Type == 'microsoft.cache/redis'),\"Configure Geo Replica\",\r\n     \"Other\"\r\n    )\r\n    | extend DocumentLink = case(\r\n    (Type contains 'virtualmachines' and Measure == 'Backup'), 'https://learn.microsoft.com/azure/backup/backup-during-vm-creation',\r\n    (Type contains 'virtualmachines' and Measure == 'ASR'), 'https://learn.microsoft.com/azure/site-recovery/azure-to-azure-quickstart',\r\n    (Type contains 'storageaccounts'), 'https://learn.microsoft.com/azure/storage/common/storage-redundancy',\r\n    (Type == 'microsoft.documentdb/databaseaccounts'), 'https://learn.microsoft.com/azure/cosmos-db/high-availability',\r\n    (Type == 'microsoft.cache/redis'),'https://learn.microsoft.com/azure/azure-cache-for-redis/cache-how-to-geo-replication',\r\n     'https://learn.microsoft.com'\r\n    ),\r\n    Restrictions = case(\r\n    (Type == \"microsoft.storage/storageaccounts\" or Type == \"microsoft.classicstorage/storageaccounts\"),\"Learn more\",\"\"),\r\n    RestrictionLink = case(\r\n    (Type == \"microsoft.storage/storageaccounts\" or Type == \"microsoft.classicstorage/storageaccounts\"),\"https://learn.microsoft.com/azure/storage/common/storage-disaster-recovery-guidance?toc=%2Fazure%2Fstorage%2Fblobs%2Ftoc.json#unsupported-features-and-services\",\"\")\r\n| summarize ResourceCount=count() by Type, RegionRedundancy, Configuration, DocumentLink,Restrictions,RestrictionLink\r\n| project \r\n    Type, \r\n    Configuration, \r\n    DocumentLink, \r\n    Restrictions,\r\n    RestrictionLink,\r\n    Configured=iff(RegionRedundancy=='Configured', ResourceCount, 0), \r\n    NotConfigured=iff(RegionRedundancy=='Not Configured', ResourceCount, 0),\r\n    NotApplicable = iff(RegionRedundancy=='Not Applicable', ResourceCount, 0)\r\n| summarize TotalResourceCount=sum(Configured)+sum(NotConfigured)+sum(NotApplicable),Configured=sum(Configured), NotConfigured=sum(NotConfigured) , NotApplicable = sum(NotApplicable)\r\nby Type, Configuration, DocumentLink, Restrictions, RestrictionLink\r\n| extend ConfiguredDisplay= Configured* 100.0/TotalResourceCount\r\n\r\n",
        "size": 0,
        "title": "Hidden-Summary-ARG-Query",
        "exportMultipleValues": true,
        "exportedParameters": [
          {
            "fieldName": "type",
            "parameterName": "SelectedService",
            "parameterType": 1
          }
        ],
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "{Subscriptions}"
        ],
        "visualization": "table",
        "gridSettings": {
          "labelSettings": [
            {
              "columnId": "Type",
              "label": "Type"
            }
          ]
        },
        "sortBy": [],
        "tileSettings": {
          "showBorder": false,
          "titleContent": {
            "columnMatch": "Service",
            "formatter": 1
          },
          "leftContent": {
            "columnMatch": "count_",
            "formatter": 12,
            "formatOptions": {
              "palette": "auto"
            },
            "numberFormat": {
              "unit": 17,
              "options": {
                "maximumSignificantDigits": 3,
                "maximumFractionDigits": 2
              }
            }
          }
        },
        "graphSettings": {
          "type": 0,
          "topContent": {
            "columnMatch": "Service",
            "formatter": 1
          },
          "centerContent": {
            "columnMatch": "count_",
            "formatter": 1,
            "numberFormat": {
              "unit": 17,
              "options": {
                "maximumSignificantDigits": 3,
                "maximumFractionDigits": 2
              }
            }
          }
        }
      },
      "conditionalVisibility": {
        "parameterName": "showtable",
        "comparison": "isEqualTo",
        "value": "show"
      },
      "customWidth": "20",
      "name": "Summary-ARG-Query",
      "styleSettings": {
        "maxWidth": "20"
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"0f10c2f8-174b-4c55-b056-215c10b2a032\",\"mergeType\":\"union\",\"leftTable\":\"Summary-Advisor-Query\",\"rightTable\":\"Summary-ARG-Query\"}],\"projectRename\":[{\"originalName\":\"[Summary-ARG-Query].ConfiguredDisplay\",\"mergedName\":\"ConfiguredDisplay\",\"fromId\":\"unknown\"},{\"originalName\":\"Type\",\"mergedName\":\"Type\",\"fromId\":\"unknown\"},{\"originalName\":\"[Summary-Advisor-Query].ConfiguredDisplay\",\"mergedName\":\"Configuration %\",\"fromId\":\"0f10c2f8-174b-4c55-b056-215c10b2a032\"},{\"originalName\":\"RestrictionLink\",\"mergedName\":\"RestrictionLink\",\"fromId\":\"unknown\"},{\"originalName\":\"Configuration\",\"mergedName\":\"Configuration\",\"fromId\":\"unknown\"},{\"originalName\":\"ConfiguredDisplay\",\"mergedName\":\"ConfiguredDisplay\",\"fromId\":\"unknown\"},{\"originalName\":\"DocumentLink\",\"mergedName\":\"DocumentLink\",\"fromId\":\"unknown\"},{\"originalName\":\"TotalResourceCount\",\"mergedName\":\"TotalResourceCount\",\"fromId\":\"unknown\"},{\"originalName\":\"Configured\",\"mergedName\":\"Configured\",\"fromId\":\"unknown\"},{\"originalName\":\"NotConfigured\",\"mergedName\":\"NotConfigured\",\"fromId\":\"unknown\"},{\"originalName\":\"Restrictions\",\"mergedName\":\"Restrictions\",\"fromId\":\"unknown\"},{\"originalName\":\"[Summary-ARG-Query].NotApplicable\",\"mergedName\":\"NotApplicable\",\"fromId\":\"unknown\"},{\"originalName\":\"[Summary-Advisor-Query].Type\",\"mergedName\":\"Service\",\"fromId\":\"0f10c2f8-174b-4c55-b056-215c10b2a032\"},{\"originalName\":\"[Summary-Advisor-Query].Configuration\",\"mergedName\":\"Configuration1\",\"fromId\":\"0f10c2f8-174b-4c55-b056-215c10b2a032\"},{\"originalName\":\"[Summary-Advisor-Query].DocumentLink\",\"mergedName\":\"DocumentLink1\",\"fromId\":\"0f10c2f8-174b-4c55-b056-215c10b2a032\"},{\"originalName\":\"[Summary-Advisor-Query].TotalResourceCount\",\"mergedName\":\"Total Resources\",\"fromId\":\"0f10c2f8-174b-4c55-b056-215c10b2a032\"},{\"originalName\":\"[Summary-Advisor-Query].Configured\",\"mergedName\":\"Configured Resources\",\"fromId\":\"0f10c2f8-174b-4c55-b056-215c10b2a032\"},{\"originalName\":\"[Summary-Advisor-Query].NotConfigured\",\"mergedName\":\"NotConfigured1\",\"fromId\":\"0f10c2f8-174b-4c55-b056-215c10b2a032\"},{\"originalName\":\"[Summary-ARG-Query].Type\",\"mergedName\":\"Type1\",\"fromId\":\"0f10c2f8-174b-4c55-b056-215c10b2a032\"},{\"originalName\":\"id\",\"mergedName\":\"id\",\"fromId\":\"unknown\"},{\"originalName\":\"name\",\"mergedName\":\"name\",\"fromId\":\"unknown\"},{\"originalName\":\"type\",\"mergedName\":\"type\",\"fromId\":\"unknown\"},{\"originalName\":\"tenantId\",\"mergedName\":\"tenantId\",\"fromId\":\"unknown\"},{\"originalName\":\"kind\",\"mergedName\":\"kind\",\"fromId\":\"unknown\"},{\"originalName\":\"location\",\"mergedName\":\"location\",\"fromId\":\"unknown\"},{\"originalName\":\"resourceGroup\",\"mergedName\":\"resourceGroup\",\"fromId\":\"unknown\"},{\"originalName\":\"subscriptionId\",\"mergedName\":\"subscriptionId\",\"fromId\":\"unknown\"},{\"originalName\":\"managedBy\",\"mergedName\":\"managedBy\",\"fromId\":\"unknown\"},{\"originalName\":\"sku\",\"mergedName\":\"sku\",\"fromId\":\"unknown\"},{\"originalName\":\"plan\",\"mergedName\":\"plan\",\"fromId\":\"unknown\"},{\"originalName\":\"properties\",\"mergedName\":\"properties\",\"fromId\":\"unknown\"},{\"originalName\":\"tags\",\"mergedName\":\"tags\",\"fromId\":\"unknown\"},{\"originalName\":\"identity\",\"mergedName\":\"identity\",\"fromId\":\"unknown\"},{\"originalName\":\"zones\",\"mergedName\":\"zones\",\"fromId\":\"unknown\"},{\"originalName\":\"extendedLocation\",\"mergedName\":\"extendedLocation\",\"fromId\":\"unknown\"},{\"originalName\":\"Environment\",\"mergedName\":\"Environment\",\"fromId\":\"unknown\"},{\"originalName\":\"id1\",\"mergedName\":\"id1\",\"fromId\":\"unknown\"},{\"originalName\":\"[Summary-ARG-Query].Configuration\",\"mergedName\":\"Configuration\",\"fromId\":\"unknown\"},{\"originalName\":\"[Summary-ARG-Query].DocumentLink\",\"mergedName\":\"DocumentLink\",\"fromId\":\"unknown\"},{\"originalName\":\"[Summary-ARG-Query].TotalResourceCount\",\"mergedName\":\"TotalResourceCount\",\"fromId\":\"unknown\"},{\"originalName\":\"[Summary-ARG-Query].Configured\",\"mergedName\":\"Configured\",\"fromId\":\"unknown\"},{\"originalName\":\"[Summary-ARG-Query].NotConfigured\",\"mergedName\":\"NotConfigured\",\"fromId\":\"unknown\"},{\"originalName\":\"[Summary-ARG-Query].SkuName\",\"mergedName\":\"SkuName\",\"fromId\":\"unknown\"},{\"originalName\":\"[Summary-ARG-Query].Kind\",\"mergedName\":\"Kind\",\"fromId\":\"unknown\"},{\"originalName\":\"[Summary-ARG-Query].SubscriptionId\",\"mergedName\":\"SubscriptionId\",\"fromId\":\"unknown\"},{\"originalName\":\"[Summary-ARG-Query].Name\",\"mergedName\":\"Name\",\"fromId\":\"unknown\"},{\"originalName\":\"[Summary-ARG-Query].Location\",\"mergedName\":\"Location\",\"fromId\":\"unknown\"},{\"originalName\":\"[Summary-ARG-Query].ResourceGroup\",\"mergedName\":\"ResourceGroup\",\"fromId\":\"unknown\"},{\"originalName\":\"[Summary-ARG-Query].properties\",\"mergedName\":\"properties\",\"fromId\":\"unknown\"},{\"originalName\":\"[Summary-ARG-Query].Measure\",\"mergedName\":\"Measure\",\"fromId\":\"unknown\"},{\"originalName\":\"[Summary-ARG-Query].RegionRedundancy\",\"mergedName\":\"RegionRedundancy\",\"fromId\":\"unknown\"},{\"originalName\":\"[Summary-ARG-Query].ResourceCount\",\"mergedName\":\"ResourceCount\",\"fromId\":\"unknown\"}]}",
        "size": 0,
        "title": "Resources Configuration Summary (ðŸ’¡Select services to see respective resource details)",
        "noDataMessage": "This workbook has not identified any resources using currently supported services",
        "showRefreshButton": true,
        "exportMultipleValues": true,
        "exportedParameters": [
          {
            "fieldName": "Type",
            "parameterName": "SelectedService",
            "parameterType": 1
          },
          {
            "fieldName": "Configuration",
            "parameterName": "SelectedConfig",
            "parameterType": 1
          }
        ],
        "showExportToExcel": true,
        "queryType": 7,
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Type",
              "formatter": 16,
              "formatOptions": {
                "showIcon": true,
                "customColumnWidthSetting": "27ch"
              }
            },
            {
              "columnMatch": "RestrictionLink",
              "formatter": 5
            },
            {
              "columnMatch": "Configuration",
              "formatter": 1,
              "formatOptions": {
                "linkColumn": "DocumentLink",
                "linkTarget": "Url",
                "customColumnWidthSetting": "35ch"
              }
            },
            {
              "columnMatch": "ConfiguredDisplay",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "colors",
                "thresholdsGrid": [
                  {
                    "operator": "==",
                    "thresholdValue": "0",
                    "representation": "redBright",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "==",
                    "thresholdValue": "100",
                    "representation": "green",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "<=",
                    "thresholdValue": "75",
                    "representation": "orange",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "<=",
                    "thresholdValue": "99",
                    "representation": "yellow",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "green",
                    "text": "{0}{1}"
                  }
                ],
                "customColumnWidthSetting": "19ch"
              },
              "numberFormat": {
                "unit": 1,
                "options": {
                  "style": "decimal",
                  "minimumFractionDigits": 1
                }
              }
            },
            {
              "columnMatch": "DocumentLink",
              "formatter": 5
            },
            {
              "columnMatch": "TotalResourceCount",
              "formatter": 4,
              "formatOptions": {
                "palette": "blue",
                "customColumnWidthSetting": "130px"
              }
            },
            {
              "columnMatch": "Configured",
              "formatter": 4,
              "formatOptions": {
                "palette": "greenDark",
                "customColumnWidthSetting": "170px"
              }
            },
            {
              "columnMatch": "NotConfigured",
              "formatter": 5
            },
            {
              "columnMatch": "Restrictions",
              "formatter": 1,
              "formatOptions": {
                "linkColumn": "RestrictionLink",
                "linkTarget": "Url",
                "customColumnWidthSetting": "15ch"
              }
            },
            {
              "columnMatch": "NotApplicable",
              "formatter": 5,
              "formatOptions": {
                "customColumnWidthSetting": "150px"
              }
            },
            {
              "columnMatch": "type",
              "formatter": 16,
              "formatOptions": {
                "showIcon": true,
                "customColumnWidthSetting": "25ch"
              }
            },
            {
              "columnMatch": "Service",
              "formatter": 0,
              "formatOptions": {
                "aggregation": "Sum"
              }
            },
            {
              "columnMatch": "Total Resources",
              "formatter": 3,
              "formatOptions": {
                "palette": "blue"
              }
            },
            {
              "columnMatch": "SubscriptionId",
              "formatter": 15,
              "formatOptions": {
                "linkTarget": null,
                "showIcon": true
              }
            },
            {
              "columnMatch": "count_",
              "formatter": 0,
              "formatOptions": {
                "aggregation": "Sum"
              },
              "numberFormat": {
                "unit": 0,
                "options": {
                  "style": "percent",
                  "minimumIntegerDigits": 1
                }
              }
            }
          ],
          "filter": true,
          "labelSettings": [
            {
              "columnId": "ConfiguredDisplay",
              "label": "Configuration %"
            },
            {
              "columnId": "TotalResourceCount",
              "label": "Total Resources"
            },
            {
              "columnId": "Configured",
              "label": "Configured Resources"
            }
          ]
        },
        "sortBy": [],
        "tileSettings": {
          "showBorder": false,
          "titleContent": {
            "columnMatch": "Service",
            "formatter": 1
          },
          "leftContent": {
            "columnMatch": "count_",
            "formatter": 12,
            "formatOptions": {
              "palette": "auto"
            },
            "numberFormat": {
              "unit": 17,
              "options": {
                "maximumSignificantDigits": 3,
                "maximumFractionDigits": 2
              }
            }
          }
        },
        "graphSettings": {
          "type": 0,
          "topContent": {
            "columnMatch": "Service",
            "formatter": 1
          },
          "centerContent": {
            "columnMatch": "count_",
            "formatter": 1,
            "numberFormat": {
              "unit": 17,
              "options": {
                "maximumSignificantDigits": 3,
                "maximumFractionDigits": 2
              }
            }
          }
        }
      },
      "customWidth": "55",
      "name": "Summary - Display",
      "styleSettings": {
        "maxWidth": "60"
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "resources\r\n| where location !contains \"EUAP\"\r\n| where type in~ ('microsoft.RECOVERYSERVICES/VAULTS','MICROSOFT.NETAPP/NETAPPACCOUNTS/CAPACITYPOOLS/VOLUMES')\r\n| where ('*' in (dynamic([{ResourceGroup}])) or resourceGroup in (dynamic([{ResourceGroup}]))) \r\n| where ('*' in (dynamic([{Region}])) or location in (dynamic([{Region}])))\r\n| where array_length(dynamic([{SelectedService}])) == 0 or type in (dynamic([{SelectedService}])) \r\n| extend Environment = case(\r\ntags.Environment <> \"\", replace(\"\\\\\\\\\", \"<Backslash>\", tostring(tags.Environment)),\r\ntags.environment <> \"\", replace(\"\\\\\\\\\", \"<Backslash>\", tostring(tags.environment)),\r\ntags.Env <> \"\", tags.Env,\r\ntags.env <> \"\", tags.env,\r\ntolower(name) contains \"prod\", \"Production\",\r\ntolower(name) contains \"dev\", \"Development\",\r\ntolower(name) contains \"qa\", \"QA\",\r\ntolower(name) contains \"uat\", \"UAT\",\r\ntolower(name) contains \"sit\", \"SIT\",\r\ntolower(name) contains \"test\", \"Test\",\r\n\"Undefined\")\r\n| where ('*' in (dynamic([{Environment}])) or Environment in (dynamic([{Environment}])))\r\n| join kind = inner(\r\n    resources\r\n    | extend tagName = replace(\"\\\\\\\\\", \"<Backslash>\", tostring(bag_keys(tags)[0]))\r\n    | extend tagValue = replace(\"\\\\\\\\\", \"<Backslash>\", tostring(tags[tagName]))\r\n    | distinct tagName,tagValue,id\r\n    | where (('*' in (dynamic([{TagName}])) or tagName in (dynamic([{TagName}])))) and (('*' in (dynamic([{TagValue}])) or tagValue in (dynamic([{TagValue}]))))\r\n    | distinct id\r\n)\r\non id\r\n| project \r\n    Type = tolower(type),\r\n    SkuName = tolower(sku.tier),\r\n    Kind = tolower(kind),\r\n    SubscriptionId = subscriptionId,\r\n    id = tolower(tostring(id)),\r\n    Location = tolower(location),\r\n    ResourceGroup = resourceGroup\r\n  | join kind=leftouter \r\n  (\r\n    advisorresources\r\n    | where properties.shortDescription  contains \"Implement disaster recovery strategies for your Azure NetApp Files Resources\" or \r\n      properties.shortDescription contains \"Enable Cross Region Restore for your recovery Services Vault\" \r\n    | project id=tolower(tostring(properties.resourceMetadata.resourceId)), properties.shortDescription.solution, identity\r\n ) on id\r\n| extend  RegionRedundancy=iif(isempty(id1), \"Configured\", \"Not Configured\")\r\n| summarize ResourceCount=count() by Location, RegionRedundancy\r\n| project \r\n    Location, \r\n    Configured=iff(RegionRedundancy=='Configured', ResourceCount, 0), \r\n    NotConfigured=iff(RegionRedundancy=='Not Configured', ResourceCount, 0)\r\n| summarize TotalResourceCount=sum(Configured)+sum(NotConfigured),Configured=sum(Configured), NotConfigured=sum(NotConfigured) \r\nby Location\r\n| extend ConfiguredDisplay= Configured* 100.0/TotalResourceCount\r\n",
        "size": 0,
        "title": "Map-Advisor-Query",
        "exportMultipleValues": true,
        "exportedParameters": [
          {
            "fieldName": "Location",
            "parameterName": "SelectedLocation",
            "parameterType": 1
          }
        ],
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "{Subscriptions}"
        ],
        "gridSettings": {
          "labelSettings": [
            {
              "columnId": "TotalResourceCount",
              "label": "Total Resources"
            },
            {
              "columnId": "Configured",
              "label": "Redundancy enabled resources"
            },
            {
              "columnId": "ConfiguredDisplay",
              "label": "Configuration %"
            }
          ]
        },
        "sortBy": [],
        "tileSettings": {
          "showBorder": false,
          "titleContent": {
            "columnMatch": "Service",
            "formatter": 1
          },
          "leftContent": {
            "columnMatch": "count_",
            "formatter": 12,
            "formatOptions": {
              "palette": "auto"
            },
            "numberFormat": {
              "unit": 17,
              "options": {
                "maximumSignificantDigits": 3,
                "maximumFractionDigits": 2
              }
            }
          }
        },
        "graphSettings": {
          "type": 0,
          "topContent": {
            "columnMatch": "Service",
            "formatter": 1
          },
          "centerContent": {
            "columnMatch": "count_",
            "formatter": 1,
            "numberFormat": {
              "unit": 17,
              "options": {
                "maximumSignificantDigits": 3,
                "maximumFractionDigits": 2
              }
            }
          }
        },
        "mapSettings": {
          "locInfo": "AzureLoc",
          "locInfoColumn": "Location",
          "sizeSettings": "TotalResourceCount",
          "sizeAggregation": "Sum",
          "labelSettings": "Location",
          "legendMetric": "ConfiguredDisplay",
          "legendAggregation": "Sum",
          "itemColorSettings": {
            "nodeColorField": "ConfiguredDisplay",
            "colorAggregation": "Average",
            "type": "heatmap",
            "heatmapPalette": "redGreen"
          },
          "numberFormatSettings": {
            "unit": 1,
            "options": {
              "style": "decimal",
              "minimumFractionDigits": 1,
              "maximumFractionDigits": 1
            }
          }
        }
      },
      "conditionalVisibility": {
        "parameterName": "1",
        "comparison": "isEqualTo",
        "value": "2"
      },
      "customWidth": "20",
      "name": "Map-Advisor-Query",
      "styleSettings": {
        "maxWidth": "20"
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "resources\r\n| where location !contains \"EUAP\"\r\n| where ('*' in (dynamic([{ResourceGroup}])) or resourceGroup in (dynamic([{ResourceGroup}]))) \r\n| where ('*' in (dynamic([{Region}])) or location in (dynamic([{Region}])))\r\n| where array_length(dynamic([{SelectedService}])) == 0 or type in (dynamic([{SelectedService}]))\r\n| where \r\n    (type == 'microsoft.compute/virtualmachines') or  \r\n    (type == 'microsoft.documentdb/databaseaccounts') or\r\n    (type == 'microsoft.cache/redis') or\r\n    (type == \"microsoft.storage/storageaccounts\" )\r\n| extend Environment = case(\r\ntags.Environment <> \"\", replace(\"\\\\\\\\\", \"<Backslash>\", tostring(tags.Environment)),\r\ntags.environment <> \"\", replace(\"\\\\\\\\\", \"<Backslash>\", tostring(tags.environment)),\r\ntags.Env <> \"\", tags.Env,\r\ntags.env <> \"\", tags.env,\r\ntolower(name) contains \"prod\", \"Production\",\r\ntolower(name) contains \"dev\", \"Development\",\r\ntolower(name) contains \"qa\", \"QA\",\r\ntolower(name) contains \"uat\", \"UAT\",\r\ntolower(name) contains \"sit\", \"SIT\",\r\ntolower(name) contains \"test\", \"Test\",\r\n\"Undefined\")\r\n| where ('*' in (dynamic([{Environment}])) or Environment in (dynamic([{Environment}])))\r\n| join kind = inner(\r\n    resources\r\n    | extend tagName = replace(\"\\\\\\\\\", \"<Backslash>\", tostring(bag_keys(tags)[0]))\r\n    | extend tagValue = replace(\"\\\\\\\\\", \"<Backslash>\", tostring(tags[tagName]))\r\n    | distinct tagName,tagValue,id\r\n    | where (('*' in (dynamic([{TagName}])) or tagName in (dynamic([{TagName}])))) and (('*' in (dynamic([{TagValue}])) or tagValue in (dynamic([{TagValue}]))))\r\n    | distinct id\r\n)\r\non id\r\n| extend skuName = case(\r\n    type == 'microsoft.compute/virtualmachines', tostring(properties.hardwareProfile.vmSize),\r\n    type == 'microsoft.classiccompute/virtualmachines', tostring(properties.hardwareProfile.size),\r\n    type == 'microsoft.documentdb/databaseaccounts', tostring(properties.databaseAccountOfferType),\r\n    type == 'microsoft.cache/redis', tostring(properties.sku.name),\r\n    type contains 'storageaccounts', tostring(replace('-', '_', tostring(iff(type =~ \"microsoft.storage/storageaccounts\", sku.name, properties.accountType)))),\r\n    \"Undefined\"\r\n    )\r\n   | project \r\n    Type = tolower(type),\r\n    SkuName = tolower(skuName),\r\n    Kind = tolower(kind),\r\n    SubscriptionId = subscriptionId,\r\n    Name = tolower(tostring(id)),\r\n    Location = tolower(location),\r\n    ResourceGroup = resourceGroup,\r\n    properties,\r\n    type\r\n    | join kind = leftouter \r\n    (\r\n        resources\r\n        | take 1\r\n        | project Type = 'microsoft.compute/virtualmachines',Measure = 'ASR'\r\n        | union\r\n        (\r\n        resources\r\n        | take 1\r\n        | project Type = 'microsoft.compute/virtualmachines',Measure = 'Backup'\r\n        )\r\n    ) on Type\r\n    | project-away Type1\r\n    | join kind = leftouter (\r\n        recoveryservicesresources\r\n        | extend Backup= iif( type =~'microsoft.recoveryservices/vaults/backupfabrics/protectioncontainers/protecteditems' \r\n                            and properties.backupManagementType =~ 'AzureIaasVM' ,\"Configured\",\"Not Configured\")\r\n        | extend ASR= iif(type =~ 'Microsoft.RecoveryServices/vaults/replicationFabrics/replicationProtectionContainers/replicationProtectedItems' \r\n                            and properties.providerSpecificDetails.dataSourceInfo.datasourceType =~ 'AzureVm',\"Configured\",\"Not Configured\")\r\n        | project Name = case( type =~'microsoft.recoveryservices/vaults/backupfabrics/protectioncontainers/protecteditems',\r\n                        tolower(tostring(properties.dataSourceInfo.resourceID)),\r\n                        type =~ 'Microsoft.RecoveryServices/vaults/replicationFabrics/replicationProtectionContainers/replicationProtectedItems',\r\n                        Name = tolower(tostring(properties.providerSpecificDetails.dataSourceInfo.resourceId)),\"\"),Backup,ASR\r\n        |where isnotempty(Name)\r\n    )\r\n    on Name\r\n    | extend RegionRedundancy = case(\r\n    (Type contains 'virtualmachines' and Measure == 'Backup' and Backup == \"Configured\" ), \"Configured\",\r\n    (Type contains 'virtualmachines' and Measure == 'ASR' and ASR == \"Configured\" ), \"Configured\",\r\n    (Type contains 'storageaccounts' and split(SkuName, '_', 1)[0] contains \"GRS\" ), \"Configured\",\r\n    (Type == 'microsoft.documentdb/databaseaccounts' and properties.enableMultipleWriteLocations == \"true\"), \"Configured\",\r\n //--added here\r\n    (Type == 'microsoft.cache/redis' and SkuName == 'premium' and properties.linkedServers!='[]'), \"Configured\",\r\n    (Type == 'microsoft.cache/redis' and SkuName != 'premium'), \"Not Applicable\",\r\n     \"Not Configured\"\r\n    )\r\n    | project-away Backup,ASR,Name1\r\n    | extend Configuration = case(\r\n    (Type contains 'virtualmachines' and Measure == 'Backup'), \"Enable Backup policy\",\r\n    (Type contains 'virtualmachines' and Measure == 'ASR'), \"Enable Azure Site Recovery\",\r\n    (Type contains 'storageaccounts'), \"Use *GRS/*GZRS replication\",\r\n    (Type == 'microsoft.documentdb/databaseaccounts'), \"Multiple Write Locations enabled\",\r\n    (Type == 'microsoft.cache/redis'),\"Configure Geo Replica\",\r\n     \"Other\"\r\n    )   \r\n| summarize ResourceCount=count() by RegionRedundancy,Configuration,Location\r\n| project \r\n    Location, \r\n    Configuration,\r\n    Configured=iff(RegionRedundancy=='Configured', ResourceCount, 0), \r\n    NotConfigured=iff(RegionRedundancy=='Not Configured', ResourceCount, 0),\r\n    NotApplicable = iff(RegionRedundancy=='Not Applicable', ResourceCount, 0)\r\n| summarize Configured=sum(Configured), NotConfigured=sum(NotConfigured), NotApplicable = sum(NotApplicable) , TotalResourceCount=sum(Configured)+sum(NotConfigured) +sum(NotApplicable)\r\nby Configuration,Location\r\n| extend ConfiguredDisplay= Configured* 100.0/TotalResourceCount\r\n| where array_length(dynamic([{SelectedConfig}])) == 0 or Configuration in (dynamic([{SelectedConfig}])) \r\n| project-away Configuration\r\n",
        "size": 0,
        "title": "Map-ARG-Query",
        "exportMultipleValues": true,
        "exportAggregateParts": true,
        "exportedParameters": [
          {
            "fieldName": "Location",
            "parameterName": "SelectedLocation",
            "parameterType": 1
          }
        ],
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "{Subscriptions}"
        ],
        "sortBy": [],
        "tileSettings": {
          "showBorder": false,
          "titleContent": {
            "columnMatch": "Service",
            "formatter": 1
          },
          "leftContent": {
            "columnMatch": "count_",
            "formatter": 12,
            "formatOptions": {
              "palette": "auto"
            },
            "numberFormat": {
              "unit": 17,
              "options": {
                "maximumSignificantDigits": 3,
                "maximumFractionDigits": 2
              }
            }
          }
        },
        "graphSettings": {
          "type": 0,
          "topContent": {
            "columnMatch": "Service",
            "formatter": 1
          },
          "centerContent": {
            "columnMatch": "count_",
            "formatter": 1,
            "numberFormat": {
              "unit": 17,
              "options": {
                "maximumSignificantDigits": 3,
                "maximumFractionDigits": 2
              }
            }
          }
        },
        "mapSettings": {
          "locInfo": "AzureLoc",
          "locInfoColumn": "Location",
          "sizeSettings": "TotalResourceCount",
          "sizeAggregation": "Sum",
          "labelSettings": "Location",
          "legendMetric": "ConfiguredDisplay",
          "legendAggregation": "Sum",
          "itemColorSettings": {
            "nodeColorField": "ConfiguredDisplay",
            "colorAggregation": "Average",
            "type": "heatmap",
            "heatmapPalette": "redGreen"
          },
          "numberFormatSettings": {
            "unit": 1,
            "options": {
              "style": "decimal",
              "minimumFractionDigits": 1,
              "maximumFractionDigits": 1
            }
          }
        }
      },
      "conditionalVisibility": {
        "parameterName": "1",
        "comparison": "isEqualTo",
        "value": "2"
      },
      "customWidth": "20",
      "name": "Map-ARG-Query",
      "styleSettings": {
        "maxWidth": "20"
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"0f10c2f8-174b-4c55-b056-215c10b2a055\",\"mergeType\":\"union\",\"leftTable\":\"Map-Advisor-Query\",\"rightTable\":\"Map-ARG-Query\"}],\"projectRename\":[{\"originalName\":\"[Map-Advisor-Query].Location\",\"mergedName\":\"Location\",\"fromId\":\"0f10c2f8-174b-4c55-b056-215c10b2a055\"},{\"originalName\":\"[Map-Advisor-Query].TotalResourceCount\",\"mergedName\":\"Total Resources\",\"fromId\":\"0f10c2f8-174b-4c55-b056-215c10b2a055\"},{\"originalName\":\"[Map-Advisor-Query].Configured\",\"mergedName\":\"Redundancy enabled resources\",\"fromId\":\"0f10c2f8-174b-4c55-b056-215c10b2a055\"},{\"originalName\":\"[Map-Advisor-Query].NotConfigured\",\"mergedName\":\"NotConfigured\",\"fromId\":\"0f10c2f8-174b-4c55-b056-215c10b2a055\"},{\"originalName\":\"[Map-Advisor-Query].ConfiguredDisplay\",\"mergedName\":\"Configuration %\",\"fromId\":\"0f10c2f8-174b-4c55-b056-215c10b2a055\"},{\"originalName\":\"Location\",\"mergedName\":\"Location\",\"fromId\":\"unknown\"},{\"originalName\":\"TotalResourceCount\",\"mergedName\":\"TotalResourceCount\",\"fromId\":\"unknown\"},{\"originalName\":\"Configured\",\"mergedName\":\"Configured\",\"fromId\":\"unknown\"},{\"originalName\":\"NotConfigured\",\"mergedName\":\"NotConfigured\",\"fromId\":\"unknown\"},{\"originalName\":\"ConfiguredDisplay\",\"mergedName\":\"ConfiguredDisplay\",\"fromId\":\"unknown\"},{\"originalName\":\"[Map-ARG-Query].sum_TotalResourceCount\",\"mergedName\":\"sum_TotalResourceCount\",\"fromId\":\"unknown\"},{\"originalName\":\"[Map-ARG-Query].sum_Configured\",\"mergedName\":\"sum_Configured\",\"fromId\":\"unknown\"},{\"originalName\":\"[Map-ARG-Query].sum_NotConfigured\",\"mergedName\":\"sum_NotConfigured\",\"fromId\":\"unknown\"},{\"originalName\":\"[Map-ARG-Query].RegionRedundancy\",\"mergedName\":\"RegionRedundancy\",\"fromId\":\"unknown\"},{\"originalName\":\"[Map-ARG-Query].Configuration\",\"mergedName\":\"Configuration\",\"fromId\":\"unknown\"},{\"originalName\":\"[Map-ARG-Query].ResourceCount\",\"mergedName\":\"ResourceCount\",\"fromId\":\"unknown\"},{\"originalName\":\"[Map-ARG-Query].NotApplicable\",\"mergedName\":\"NotApplicable\",\"fromId\":\"unknown\"}]}",
        "size": 0,
        "title": "Replication configuration by Region",
        "noDataMessage": "This workbook has not identified any resources using currently supported services",
        "exportMultipleValues": true,
        "exportAggregateParts": true,
        "exportedParameters": [
          {
            "fieldName": "Location",
            "parameterName": "SelectedLocation",
            "parameterType": 1
          }
        ],
        "queryType": 7,
        "visualization": "map",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Service",
              "formatter": 0,
              "formatOptions": {
                "aggregation": "Sum"
              }
            },
            {
              "columnMatch": "Configured",
              "formatter": 4,
              "formatOptions": {
                "palette": "greenDark",
                "customColumnWidthSetting": "200px"
              }
            },
            {
              "columnMatch": "NotConfigured",
              "formatter": 5
            },
            {
              "columnMatch": "TotalResourceCount",
              "formatter": 4,
              "formatOptions": {
                "palette": "blue",
                "customColumnWidthSetting": "150px"
              }
            },
            {
              "columnMatch": "ConfiguredDisplay",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "colors",
                "thresholdsGrid": [
                  {
                    "operator": "<=",
                    "thresholdValue": "75",
                    "representation": "orange",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "<=",
                    "thresholdValue": "99",
                    "representation": "yellow",
                    "text": "{0}{1}"
                  },
                  {
                    "representation": "green",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": null,
                    "text": "{0}{1}"
                  }
                ],
                "customColumnWidthSetting": "30ch"
              },
              "numberFormat": {
                "unit": 1,
                "options": {
                  "style": "decimal",
                  "minimumFractionDigits": 1
                }
              }
            },
            {
              "columnMatch": "Total Resources",
              "formatter": 3,
              "formatOptions": {
                "palette": "blue"
              }
            },
            {
              "columnMatch": "SubscriptionId",
              "formatter": 15,
              "formatOptions": {
                "linkTarget": null,
                "showIcon": true
              }
            },
            {
              "columnMatch": "count_",
              "formatter": 0,
              "formatOptions": {
                "aggregation": "Sum"
              },
              "numberFormat": {
                "unit": 0,
                "options": {
                  "style": "percent",
                  "minimumIntegerDigits": 1
                }
              }
            }
          ],
          "sortBy": [
            {
              "itemKey": "$gen_bar_TotalResourceCount_3",
              "sortOrder": 2
            }
          ],
          "labelSettings": [
            {
              "columnId": "Configured",
              "label": "Redundancy enabled resources"
            },
            {
              "columnId": "TotalResourceCount",
              "label": "Total Resources"
            },
            {
              "columnId": "ConfiguredDisplay",
              "label": "Configuration %"
            }
          ]
        },
        "sortBy": [
          {
            "itemKey": "$gen_bar_TotalResourceCount_3",
            "sortOrder": 2
          }
        ],
        "tileSettings": {
          "showBorder": false,
          "titleContent": {
            "columnMatch": "Service",
            "formatter": 1
          },
          "leftContent": {
            "columnMatch": "count_",
            "formatter": 12,
            "formatOptions": {
              "palette": "auto"
            },
            "numberFormat": {
              "unit": 17,
              "options": {
                "maximumSignificantDigits": 3,
                "maximumFractionDigits": 2
              }
            }
          }
        },
        "graphSettings": {
          "type": 0,
          "topContent": {
            "columnMatch": "Service",
            "formatter": 1
          },
          "centerContent": {
            "columnMatch": "count_",
            "formatter": 1,
            "numberFormat": {
              "unit": 17,
              "options": {
                "maximumSignificantDigits": 3,
                "maximumFractionDigits": 2
              }
            }
          }
        },
        "mapSettings": {
          "locInfo": "AzureLoc",
          "locInfoColumn": "Location",
          "sizeSettings": "TotalResourceCount",
          "sizeAggregation": "Average",
          "labelSettings": "Location",
          "legendMetric": "ConfiguredDisplay",
          "legendAggregation": "Average",
          "itemColorSettings": {
            "nodeColorField": "ConfiguredDisplay",
            "colorAggregation": "Average",
            "type": "heatmap",
            "heatmapPalette": "redGreen"
          },
          "numberFormatSettings": {
            "unit": 1,
            "options": {
              "style": "decimal",
              "minimumFractionDigits": 1,
              "maximumFractionDigits": 1
            }
          }
        }
      },
      "customWidth": "45",
      "name": "Map-Display",
      "styleSettings": {
        "maxWidth": "45"
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "resources\r\n| where location !contains \"EUAP\"\r\n| where type in~ ('microsoft.RECOVERYSERVICES/VAULTS', 'MICROSOFT.NETAPP/NETAPPACCOUNTS/CAPACITYPOOLS/VOLUMES')\r\n| where ('*' in (dynamic([{ResourceGroup}])) or resourceGroup in (dynamic([{ResourceGroup}]))) \r\n| where ('*' in (dynamic([{Region}])) or location in (dynamic([{Region}])))\r\n| where array_length(dynamic([{SelectedService}])) == 0 or type in (dynamic([{SelectedService}])) \r\n| where array_length(dynamic([{SelectedLocation}])) == 0 or location in (dynamic([{SelectedLocation}]))\r\n| extend Environment = case(\r\ntags.Environment <> \"\", replace(\"\\\\\\\\\", \"<Backslash>\", tostring(tags.Environment)),\r\ntags.environment <> \"\", replace(\"\\\\\\\\\", \"<Backslash>\", tostring(tags.environment)),\r\ntags.Env <> \"\", tags.Env,\r\ntags.env <> \"\", tags.env,\r\ntolower(name) contains \"prod\", \"Production\",\r\ntolower(name) contains \"dev\", \"Development\",\r\ntolower(name) contains \"qa\", \"QA\",\r\ntolower(name) contains \"uat\", \"UAT\",\r\ntolower(name) contains \"sit\", \"SIT\",\r\ntolower(name) contains \"test\", \"Test\",\r\n\"Undefined\")\r\n| where ('*' in (dynamic([{Environment}])) or Environment in (dynamic([{Environment}])))\r\n| join kind = inner(\r\n    resources\r\n    | extend tagName = replace(\"\\\\\\\\\", \"<Backslash>\", tostring(bag_keys(tags)[0]))\r\n    | extend tagValue = replace(\"\\\\\\\\\", \"<Backslash>\", tostring(tags[tagName]))\r\n    | distinct tagName,tagValue,id\r\n    | where (('*' in (dynamic([{TagName}])) or tagName in (dynamic([{TagName}])))) and (('*' in (dynamic([{TagValue}])) or tagValue in (dynamic([{TagValue}]))))\r\n    | distinct id\r\n)\r\non id\r\n| project \r\n    Type = tolower(type),\r\n    SkuName = tolower(sku.tier),\r\n    Kind = tolower(kind),\r\n    SubscriptionId = subscriptionId,\r\n    id = tolower(tostring(id)),\r\n    Location = tolower(location),\r\n    Name = tolower(tostring(id)),\r\n    ResourceGroup = resourceGroup\r\n  | join kind=leftouter \r\n  (\r\n    advisorresources\r\n    | where properties.shortDescription  contains \"Implement disaster recovery strategies for your Azure NetApp Files Resources\" or \r\n      properties.shortDescription contains \"Enable Cross Region Restore for your recovery Services Vault\" \r\n    | project id=tolower(tostring(properties.resourceMetadata.resourceId)), properties.shortDescription.solution, identity\r\n ) on id\r\n| extend  RegionRedundancy=iif(isempty(id1), \"Configured\", \"Not Configured\")\r\n| extend Configuration = case(\r\n    (Type contains 'MICROSOFT.RECOVERYSERVICES/VAULTS'), \"Enable Cross Region Restore\",\r\n    (Type contains 'MICROSOFT.NETAPP/NETAPPACCOUNTS/CAPACITYPOOLS/VOLUMES'), \"Implement disaster recovery strategies\",\r\n      \"Other\"\r\n    )\r\n| extend DocumentLink = case(\r\n    (Type contains 'MICROSOFT.RECOVERYSERVICES/VAULTS'), \"https://learn.microsoft.com/azure/backup/backup-azure-arm-restore-vms?WT.mc_id=Portal-Microsoft_Azure_Expert#cross-region-restore\",\r\n    (Type contains 'MICROSOFT.NETAPP/NETAPPACCOUNTS/CAPACITYPOOLS/VOLUMES'), \"https://aka.ms/anfcrr\",\r\n      \"https://learn.microsoft.com\"\r\n    ),\r\n    Restrictions = \"\",\r\n    RestrictionLink = \"\"\r\n| project \r\n    Subscription=SubscriptionId,\r\n    Type ,\r\n    ResourceGroup,\r\n    Name,\r\n    Location,\r\n    SkuName, \r\n    RegionRedundancy, \r\n    Configuration, \r\n    DocumentLink,\r\n    Restrictions,\r\n    RestrictionLink",
        "size": 0,
        "title": "Hidden-Details-Advisor-Query",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "{Subscriptions}"
        ],
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "$gen_group",
              "formatter": 15,
              "formatOptions": {
                "linkTarget": null,
                "showIcon": true
              }
            },
            {
              "columnMatch": "Subscription",
              "formatter": 5
            },
            {
              "columnMatch": "Type",
              "formatter": 16,
              "formatOptions": {
                "showIcon": true,
                "customColumnWidthSetting": "25ch"
              }
            },
            {
              "columnMatch": "ResourceGroup",
              "formatter": 0,
              "formatOptions": {
                "customColumnWidthSetting": "30ch"
              }
            },
            {
              "columnMatch": "Name",
              "formatter": 13,
              "formatOptions": {
                "linkTarget": "Resource",
                "linkIsContextBlade": true,
                "showIcon": true
              }
            },
            {
              "columnMatch": "RegionRedundancy",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "==",
                    "thresholdValue": "Not Configured",
                    "representation": "2",
                    "text": "{0}{1}"
                  },
                  {
                    "thresholdValue": "Configured",
                    "representation": "success",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "success",
                    "text": "{0}{1}"
                  }
                ]
              }
            },
            {
              "columnMatch": "Configuration",
              "formatter": 1,
              "formatOptions": {
                "linkColumn": "DocumentLink",
                "linkTarget": "Url"
              }
            },
            {
              "columnMatch": "DocumentLink",
              "formatter": 5
            },
            {
              "columnMatch": "Service",
              "formatter": 5,
              "formatOptions": {
                "aggregation": "Sum"
              }
            },
            {
              "columnMatch": "SubscriptionId",
              "formatter": 5
            },
            {
              "columnMatch": "Configured",
              "formatter": 4,
              "formatOptions": {
                "palette": "greenDark",
                "customColumnWidthSetting": "250px"
              }
            },
            {
              "columnMatch": "NotConfigured",
              "formatter": 5
            },
            {
              "columnMatch": "TotalResourceCount",
              "formatter": 4,
              "formatOptions": {
                "palette": "blue",
                "customColumnWidthSetting": "200px"
              }
            },
            {
              "columnMatch": "ConfiguredDisplay",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "colors",
                "thresholdsGrid": [
                  {
                    "operator": "<=",
                    "thresholdValue": "75",
                    "representation": "orange",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "<=",
                    "thresholdValue": "99",
                    "representation": "yellow",
                    "text": "{0}{1}"
                  },
                  {
                    "representation": "green",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": null,
                    "text": "{0}{1}"
                  }
                ],
                "customColumnWidthSetting": "30ch"
              },
              "numberFormat": {
                "unit": 1,
                "options": {
                  "style": "decimal",
                  "minimumFractionDigits": 1
                }
              }
            },
            {
              "columnMatch": "Total Resources",
              "formatter": 3,
              "formatOptions": {
                "palette": "blue"
              }
            },
            {
              "columnMatch": "count_",
              "formatter": 0,
              "formatOptions": {
                "aggregation": "Sum"
              },
              "numberFormat": {
                "unit": 0,
                "options": {
                  "style": "percent",
                  "minimumIntegerDigits": 1
                }
              }
            }
          ],
          "hierarchySettings": {
            "treeType": 1,
            "groupBy": [
              "Subscription"
            ],
            "expandTopLevel": true,
            "finalBy": "Subscription"
          },
          "sortBy": [
            {
              "itemKey": "$gen_thresholds_RegionRedundancy_7",
              "sortOrder": 2
            }
          ]
        },
        "sortBy": [
          {
            "itemKey": "$gen_thresholds_RegionRedundancy_7",
            "sortOrder": 2
          }
        ],
        "tileSettings": {
          "showBorder": false,
          "titleContent": {
            "columnMatch": "Service",
            "formatter": 1
          },
          "leftContent": {
            "columnMatch": "count_",
            "formatter": 12,
            "formatOptions": {
              "palette": "auto"
            },
            "numberFormat": {
              "unit": 17,
              "options": {
                "maximumSignificantDigits": 3,
                "maximumFractionDigits": 2
              }
            }
          }
        },
        "graphSettings": {
          "type": 0,
          "topContent": {
            "columnMatch": "Service",
            "formatter": 1
          },
          "centerContent": {
            "columnMatch": "count_",
            "formatter": 1,
            "numberFormat": {
              "unit": 17,
              "options": {
                "maximumSignificantDigits": 3,
                "maximumFractionDigits": 2
              }
            }
          }
        }
      },
      "conditionalVisibility": {
        "parameterName": "1",
        "comparison": "isEqualTo",
        "value": "2"
      },
      "customWidth": "50",
      "name": "Details-Advisor-Query",
      "styleSettings": {
        "maxWidth": "50"
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "resources\r\n| where location !contains \"EUAP\"\r\n| where ('*' in (dynamic([{ResourceGroup}])) or resourceGroup in (dynamic([{ResourceGroup}]))) \r\n| where ('*' in (dynamic([{Region}])) or location in (dynamic([{Region}])))\r\n| where array_length(dynamic([{SelectedService}])) == 0 or type in (dynamic([{SelectedService}])) \r\n| where array_length(dynamic([{SelectedLocation}])) == 0 or location in (dynamic([{SelectedLocation}]))\r\n| where \r\n    (type == 'microsoft.compute/virtualmachines') or \r\n    (type == 'microsoft.classiccompute/virtualmachines') or \r\n    (type == 'microsoft.documentdb/databaseaccounts') or\r\n    (type == 'microsoft.cache/redis') or\r\n    (type == \"microsoft.storage/storageaccounts\" )\r\n| extend Environment = case(\r\ntags.Environment <> \"\", replace(\"\\\\\\\\\", \"<Backslash>\", tostring(tags.Environment)),\r\ntags.environment <> \"\", replace(\"\\\\\\\\\", \"<Backslash>\", tostring(tags.environment)),\r\ntags.Env <> \"\", tags.Env,\r\ntags.env <> \"\", tags.env,\r\ntolower(name) contains \"prod\", \"Production\",\r\ntolower(name) contains \"dev\", \"Development\",\r\ntolower(name) contains \"qa\", \"QA\",\r\ntolower(name) contains \"uat\", \"UAT\",\r\ntolower(name) contains \"sit\", \"SIT\",\r\ntolower(name) contains \"test\", \"Test\",\r\n\"Undefined\")\r\n| where ('*' in (dynamic([{Environment}])) or Environment in (dynamic([{Environment}])))\r\n| join kind = inner(\r\n    resources\r\n    | extend tagName = replace(\"\\\\\\\\\", \"<Backslash>\", tostring(bag_keys(tags)[0]))\r\n    | extend tagValue = replace(\"\\\\\\\\\", \"<Backslash>\", tostring(tags[tagName]))\r\n    | distinct tagName,tagValue,id\r\n    | where (('*' in (dynamic([{TagName}])) or tagName in (dynamic([{TagName}])))) and (('*' in (dynamic([{TagValue}])) or tagValue in (dynamic([{TagValue}]))))\r\n    | distinct id\r\n)\r\non id\r\n| extend skuName = case(\r\n    type == 'microsoft.compute/virtualmachines', tostring(properties.hardwareProfile.vmSize),\r\n    type == 'microsoft.classiccompute/virtualmachines', tostring(properties.hardwareProfile.size),\r\n    type == 'microsoft.documentdb/databaseaccounts', tostring(properties.databaseAccountOfferType),\r\n    type == 'microsoft.cache/redis', tostring(properties.sku.name),\r\n    type contains 'storageaccounts', tostring(replace('-', '_', tostring(iff(type =~ \"microsoft.storage/storageaccounts\", sku.name, properties.accountType)))),\r\n    \"Undefined\"\r\n    )\r\n   | project \r\n    Type = tolower(type),\r\n    SkuName = tolower(skuName),\r\n    Kind = tolower(kind),\r\n    SubscriptionId = subscriptionId,\r\n    Name = tolower(tostring(id)),\r\n    Location = tolower(location),\r\n    ResourceGroup = resourceGroup,\r\n    properties,\r\n    type\r\n    | join kind = leftouter \r\n    (\r\n        resources\r\n        | take 1\r\n        | project Type = 'microsoft.compute/virtualmachines',Measure = 'ASR'\r\n        | union\r\n        (\r\n        resources\r\n        | take 1\r\n        | project Type = 'microsoft.compute/virtualmachines',Measure = 'Backup'\r\n        )\r\n    ) on Type\r\n    | project-away Type1\r\n    | join kind = leftouter (\r\n        recoveryservicesresources\r\n        | extend Backup= iif( type =~'microsoft.recoveryservices/vaults/backupfabrics/protectioncontainers/protecteditems' \r\n                            and properties.backupManagementType =~ 'AzureIaasVM' ,\"Configured\",\"Not Configured\")\r\n        | extend ASR= iif(type =~ 'Microsoft.RecoveryServices/vaults/replicationFabrics/replicationProtectionContainers/replicationProtectedItems' \r\n                            and properties.providerSpecificDetails.dataSourceInfo.datasourceType =~ 'AzureVm',\"Configured\",\"Not Configured\")\r\n        | project Name = case( type =~'microsoft.recoveryservices/vaults/backupfabrics/protectioncontainers/protecteditems',\r\n                        tolower(tostring(properties.dataSourceInfo.resourceID)),\r\n                        type =~ 'Microsoft.RecoveryServices/vaults/replicationFabrics/replicationProtectionContainers/replicationProtectedItems',\r\n                        Name = tolower(tostring(properties.providerSpecificDetails.dataSourceInfo.resourceId)),\"\"),Backup,ASR\r\n        |where isnotempty(Name)\r\n    )\r\n    on Name\r\n| extend RegionRedundancy = case(\r\n    (Type contains 'virtualmachines' and Measure == 'Backup' and Backup == \"Configured\" ), \"Configured\",\r\n    (Type contains 'virtualmachines' and Measure == 'ASR' and ASR == \"Configured\" ), \"Configured\",\r\n    (Type contains 'storageaccounts' and split(SkuName, '_', 1)[0] contains \"GRS\" ), \"Configured\",\r\n    (Type == 'microsoft.documentdb/databaseaccounts' and properties.enableMultipleWriteLocations == \"true\"), \"Configured\",\r\n//-- added here\r\n    (Type == 'microsoft.cache/redis' and SkuName == 'premium' and properties.linkedServers!='[]'), \"Configured\",\r\n    (Type == 'microsoft.cache/redis' and SkuName != 'premium'), \"Not Applicable\",\r\n     \"Not Configured\"\r\n    )\r\n    | project-away Backup,ASR,Name1\r\n    | extend Configuration = case(\r\n    (Type contains 'virtualmachines' and Measure == 'Backup'), \"Enable Backup policy\",\r\n    (Type contains 'virtualmachines' and Measure == 'ASR'), \"Enable Azure Site Recovery\",\r\n    (Type contains 'storageaccounts'), \"Use *GRS/*GZRS replication\",\r\n    (Type == 'microsoft.documentdb/databaseaccounts'), \"Multiple Write Locations enabled\",\r\n    (Type == 'microsoft.cache/redis'),\"Configure Geo Replica\",\r\n     \"Other\"\r\n    )\r\n    | extend DocumentLink = case(\r\n    (Type contains 'virtualmachines' and Measure == 'Backup'), 'https://learn.microsoft.com/azure/backup/backup-during-vm-creation',\r\n    (Type contains 'virtualmachines' and Measure == 'ASR'), 'https://learn.microsoft.com/azure/site-recovery/azure-to-azure-quickstart',\r\n    (Type contains 'storageaccounts'), 'https://learn.microsoft.com/azure/storage/common/storage-redundancy',\r\n    (Type == 'microsoft.documentdb/databaseaccounts'), 'https://learn.microsoft.com/azure/cosmos-db/high-availability',\r\n    (Type == 'microsoft.cache/redis'),'https://learn.microsoft.com/azure/azure-cache-for-redis/cache-how-to-geo-replication',\r\n     'https://learn.microsoft.com'\r\n    ),\r\n    Restrictions = case(\r\n    (Type == \"microsoft.storage/storageaccounts\" or Type == \"microsoft.classicstorage/storageaccounts\") ,\"Learn more\"\r\n    ,\"\"),\r\n    RestrictionLink = case(\r\n    (Type == \"microsoft.storage/storageaccounts\" or Type == \"microsoft.classicstorage/storageaccounts\") ,\"https://learn.microsoft.com/azure/storage/common/storage-disaster-recovery-guidance?toc=%2Fazure%2Fstorage%2Fblobs%2Ftoc.json#unsupported-features-and-services\"\r\n    ,\"\")\r\n    | where array_length(dynamic([{SelectedConfig}])) == 0 or Configuration in (dynamic([{SelectedConfig}])) \r\n| project \r\n    Subscription=SubscriptionId,\r\n    Type ,\r\n    ResourceGroup,\r\n    Name,\r\n    Location,\r\n    SkuName, \r\n    RegionRedundancy, \r\n    Configuration, \r\n    DocumentLink,\r\n    Restrictions,\r\n    RestrictionLink",
        "size": 0,
        "title": "Hidden-Details-ARG-Query",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "{Subscriptions}"
        ],
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "$gen_group",
              "formatter": 15,
              "formatOptions": {
                "linkTarget": null,
                "showIcon": true
              }
            },
            {
              "columnMatch": "Subscription",
              "formatter": 5
            },
            {
              "columnMatch": "Type",
              "formatter": 16,
              "formatOptions": {
                "showIcon": true,
                "customColumnWidthSetting": "25ch"
              }
            },
            {
              "columnMatch": "ResourceGroup",
              "formatter": 0,
              "formatOptions": {
                "customColumnWidthSetting": "30ch"
              }
            },
            {
              "columnMatch": "Name",
              "formatter": 13,
              "formatOptions": {
                "linkTarget": "Resource",
                "linkIsContextBlade": true,
                "showIcon": true
              }
            },
            {
              "columnMatch": "RegionRedundancy",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "==",
                    "thresholdValue": "Not Configured",
                    "representation": "2",
                    "text": "{0}{1}"
                  },
                  {
                    "thresholdValue": "Configured",
                    "representation": "success",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "success",
                    "text": "{0}{1}"
                  }
                ]
              }
            },
            {
              "columnMatch": "Configuration",
              "formatter": 1,
              "formatOptions": {
                "linkColumn": "DocumentLink",
                "linkTarget": "Url"
              }
            },
            {
              "columnMatch": "DocumentLink",
              "formatter": 5
            },
            {
              "columnMatch": "Service",
              "formatter": 5,
              "formatOptions": {
                "aggregation": "Sum"
              }
            },
            {
              "columnMatch": "SubscriptionId",
              "formatter": 5
            },
            {
              "columnMatch": "Configured",
              "formatter": 4,
              "formatOptions": {
                "palette": "greenDark",
                "customColumnWidthSetting": "250px"
              }
            },
            {
              "columnMatch": "NotConfigured",
              "formatter": 5
            },
            {
              "columnMatch": "TotalResourceCount",
              "formatter": 4,
              "formatOptions": {
                "palette": "blue",
                "customColumnWidthSetting": "200px"
              }
            },
            {
              "columnMatch": "ConfiguredDisplay",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "colors",
                "thresholdsGrid": [
                  {
                    "operator": "<=",
                    "thresholdValue": "75",
                    "representation": "orange",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "<=",
                    "thresholdValue": "99",
                    "representation": "yellow",
                    "text": "{0}{1}"
                  },
                  {
                    "representation": "green",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": null,
                    "text": "{0}{1}"
                  }
                ],
                "customColumnWidthSetting": "30ch"
              },
              "numberFormat": {
                "unit": 1,
                "options": {
                  "style": "decimal",
                  "minimumFractionDigits": 1
                }
              }
            },
            {
              "columnMatch": "Total Resources",
              "formatter": 3,
              "formatOptions": {
                "palette": "blue"
              }
            },
            {
              "columnMatch": "count_",
              "formatter": 0,
              "formatOptions": {
                "aggregation": "Sum"
              },
              "numberFormat": {
                "unit": 0,
                "options": {
                  "style": "percent",
                  "minimumIntegerDigits": 1
                }
              }
            }
          ],
          "hierarchySettings": {
            "treeType": 1,
            "groupBy": [
              "Subscription"
            ],
            "expandTopLevel": true,
            "finalBy": "Subscription"
          },
          "sortBy": [
            {
              "itemKey": "$gen_thresholds_RegionRedundancy_7",
              "sortOrder": 2
            }
          ]
        },
        "sortBy": [
          {
            "itemKey": "$gen_thresholds_RegionRedundancy_7",
            "sortOrder": 2
          }
        ],
        "tileSettings": {
          "showBorder": false,
          "titleContent": {
            "columnMatch": "Service",
            "formatter": 1
          },
          "leftContent": {
            "columnMatch": "count_",
            "formatter": 12,
            "formatOptions": {
              "palette": "auto"
            },
            "numberFormat": {
              "unit": 17,
              "options": {
                "maximumSignificantDigits": 3,
                "maximumFractionDigits": 2
              }
            }
          }
        },
        "graphSettings": {
          "type": 0,
          "topContent": {
            "columnMatch": "Service",
            "formatter": 1
          },
          "centerContent": {
            "columnMatch": "count_",
            "formatter": 1,
            "numberFormat": {
              "unit": 17,
              "options": {
                "maximumSignificantDigits": 3,
                "maximumFractionDigits": 2
              }
            }
          }
        }
      },
      "conditionalVisibility": {
        "parameterName": "1",
        "comparison": "isEqualTo",
        "value": "2"
      },
      "customWidth": "50",
      "name": "Details-ARG-Query",
      "styleSettings": {
        "maxWidth": "50"
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"0f10c2f8-174b-4c55-b056-215c10b2a063\",\"mergeType\":\"union\",\"leftTable\":\"Details-Advisor-Query\",\"rightTable\":\"Details-ARG-Query\"}],\"projectRename\":[{\"originalName\":\"[Details-Advisor-Query].Subscription\",\"mergedName\":\"Subscription\",\"fromId\":\"0f10c2f8-174b-4c55-b056-215c10b2a063\"},{\"originalName\":\"[Details-Advisor-Query].Type\",\"mergedName\":\"Type\",\"fromId\":\"0f10c2f8-174b-4c55-b056-215c10b2a063\"},{\"originalName\":\"[Details-Advisor-Query].ResourceGroup\",\"mergedName\":\"ResourceGroup\",\"fromId\":\"0f10c2f8-174b-4c55-b056-215c10b2a063\"},{\"originalName\":\"[Details-Advisor-Query].Name\",\"mergedName\":\"Name\",\"fromId\":\"0f10c2f8-174b-4c55-b056-215c10b2a063\"},{\"originalName\":\"[Details-Advisor-Query].Location\",\"mergedName\":\"Location\",\"fromId\":\"0f10c2f8-174b-4c55-b056-215c10b2a063\"},{\"originalName\":\"[Details-Advisor-Query].SkuName\",\"mergedName\":\"SkuName\",\"fromId\":\"0f10c2f8-174b-4c55-b056-215c10b2a063\"},{\"originalName\":\"[Details-Advisor-Query].RegionRedundancy\",\"mergedName\":\"RegionRedundancy\",\"fromId\":\"0f10c2f8-174b-4c55-b056-215c10b2a063\"},{\"originalName\":\"[Details-Advisor-Query].Configuration\",\"mergedName\":\"Configuration\",\"fromId\":\"0f10c2f8-174b-4c55-b056-215c10b2a063\"},{\"originalName\":\"[Details-Advisor-Query].DocumentLink\",\"mergedName\":\"DocumentLink\",\"fromId\":\"0f10c2f8-174b-4c55-b056-215c10b2a063\"},{\"originalName\":\"Subscription\",\"mergedName\":\"Subscription\",\"fromId\":\"unknown\"},{\"originalName\":\"Type\",\"mergedName\":\"Type\",\"fromId\":\"unknown\"},{\"originalName\":\"ResourceGroup\",\"mergedName\":\"ResourceGroup\",\"fromId\":\"unknown\"},{\"originalName\":\"Name\",\"mergedName\":\"Name\",\"fromId\":\"unknown\"},{\"originalName\":\"Location\",\"mergedName\":\"Location\",\"fromId\":\"unknown\"},{\"originalName\":\"SkuName\",\"mergedName\":\"SkuName\",\"fromId\":\"unknown\"},{\"originalName\":\"RegionRedundancy\",\"mergedName\":\"RegionRedundancy\",\"fromId\":\"unknown\"},{\"originalName\":\"Configuration\",\"mergedName\":\"Configuration\",\"fromId\":\"unknown\"},{\"originalName\":\"DocumentLink\",\"mergedName\":\"DocumentLink\",\"fromId\":\"unknown\"},{\"originalName\":\"Subscription\",\"mergedName\":\"Subscription\",\"fromId\":\"unknown\"},{\"originalName\":\"Type\",\"mergedName\":\"Type\",\"fromId\":\"unknown\"},{\"originalName\":\"ResourceGroup\",\"mergedName\":\"ResourceGroup\",\"fromId\":\"unknown\"},{\"originalName\":\"Name\",\"mergedName\":\"Name\",\"fromId\":\"unknown\"},{\"originalName\":\"Location\",\"mergedName\":\"Location\",\"fromId\":\"unknown\"},{\"originalName\":\"SkuName\",\"mergedName\":\"SkuName\",\"fromId\":\"unknown\"},{\"originalName\":\"RegionRedundancy\",\"mergedName\":\"RegionRedundancy\",\"fromId\":\"unknown\"},{\"originalName\":\"Configuration\",\"mergedName\":\"Configuration\",\"fromId\":\"unknown\"},{\"originalName\":\"DocumentLink\",\"mergedName\":\"DocumentLink\",\"fromId\":\"unknown\"},{\"originalName\":\"Restrictions\",\"mergedName\":\"Restrictions\",\"fromId\":\"unknown\"},{\"originalName\":\"RestrictionLink\",\"mergedName\":\"RestrictionLink\",\"fromId\":\"unknown\"}]}",
        "size": 0,
        "title": "Resource Details",
        "noDataMessage": "This workbook has not identified any resources using currently supported services",
        "queryType": 7,
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "$gen_group",
              "formatter": 15,
              "formatOptions": {
                "linkTarget": null,
                "showIcon": true,
                "customColumnWidthSetting": "40ch"
              }
            },
            {
              "columnMatch": "Subscription",
              "formatter": 5
            },
            {
              "columnMatch": "Type",
              "formatter": 16,
              "formatOptions": {
                "showIcon": true,
                "customColumnWidthSetting": "25ch"
              }
            },
            {
              "columnMatch": "ResourceGroup",
              "formatter": 0,
              "formatOptions": {
                "customColumnWidthSetting": "25ch"
              }
            },
            {
              "columnMatch": "Name",
              "formatter": 13,
              "formatOptions": {
                "linkTarget": "Resource",
                "linkIsContextBlade": true,
                "showIcon": true
              }
            },
            {
              "columnMatch": "RegionRedundancy",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "==",
                    "thresholdValue": "Not Configured",
                    "representation": "2",
                    "text": "{0}{1}"
                  },
                  {
                    "thresholdValue": "Configured",
                    "representation": "success",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "success",
                    "text": "{0}{1}"
                  }
                ],
                "customColumnWidthSetting": "30ch"
              }
            },
            {
              "columnMatch": "Configuration",
              "formatter": 1,
              "formatOptions": {
                "linkColumn": "DocumentLink",
                "linkTarget": "Url"
              }
            },
            {
              "columnMatch": "DocumentLink",
              "formatter": 5
            },
            {
              "columnMatch": "Restrictions",
              "formatter": 1,
              "formatOptions": {
                "linkColumn": "RestrictionLink",
                "linkTarget": "Url",
                "customColumnWidthSetting": "20ch"
              }
            },
            {
              "columnMatch": "RestrictionLink",
              "formatter": 5
            },
            {
              "columnMatch": "Service",
              "formatter": 5,
              "formatOptions": {
                "aggregation": "Sum"
              }
            },
            {
              "columnMatch": "SubscriptionId",
              "formatter": 5
            },
            {
              "columnMatch": "Configured",
              "formatter": 4,
              "formatOptions": {
                "palette": "greenDark",
                "customColumnWidthSetting": "250px"
              }
            },
            {
              "columnMatch": "NotConfigured",
              "formatter": 5
            },
            {
              "columnMatch": "TotalResourceCount",
              "formatter": 4,
              "formatOptions": {
                "palette": "blue",
                "customColumnWidthSetting": "200px"
              }
            },
            {
              "columnMatch": "ConfiguredDisplay",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "colors",
                "thresholdsGrid": [
                  {
                    "operator": "<=",
                    "thresholdValue": "75",
                    "representation": "orange",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "<=",
                    "thresholdValue": "99",
                    "representation": "yellow",
                    "text": "{0}{1}"
                  },
                  {
                    "representation": "green",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": null,
                    "text": "{0}{1}"
                  }
                ],
                "customColumnWidthSetting": "30ch"
              },
              "numberFormat": {
                "unit": 1,
                "options": {
                  "style": "decimal",
                  "minimumFractionDigits": 1
                }
              }
            },
            {
              "columnMatch": "Total Resources",
              "formatter": 3,
              "formatOptions": {
                "palette": "blue"
              }
            },
            {
              "columnMatch": "count_",
              "formatter": 0,
              "formatOptions": {
                "aggregation": "Sum"
              },
              "numberFormat": {
                "unit": 0,
                "options": {
                  "style": "percent",
                  "minimumIntegerDigits": 1
                }
              }
            }
          ],
          "hierarchySettings": {
            "treeType": 1,
            "groupBy": [
              "Subscription"
            ],
            "expandTopLevel": true,
            "finalBy": "Subscription"
          },
          "sortBy": [
            {
              "itemKey": "$gen_thresholds_RegionRedundancy_7",
              "sortOrder": 2
            }
          ],
          "labelSettings": [
            {
              "columnId": "RegionRedundancy",
              "label": "Cross Region Replication"
            }
          ]
        },
        "sortBy": [
          {
            "itemKey": "$gen_thresholds_RegionRedundancy_7",
            "sortOrder": 2
          }
        ],
        "tileSettings": {
          "showBorder": false,
          "titleContent": {
            "columnMatch": "Service",
            "formatter": 1
          },
          "leftContent": {
            "columnMatch": "count_",
            "formatter": 12,
            "formatOptions": {
              "palette": "auto"
            },
            "numberFormat": {
              "unit": 17,
              "options": {
                "maximumSignificantDigits": 3,
                "maximumFractionDigits": 2
              }
            }
          }
        },
        "graphSettings": {
          "type": 0,
          "topContent": {
            "columnMatch": "Service",
            "formatter": 1
          },
          "centerContent": {
            "columnMatch": "count_",
            "formatter": 1,
            "numberFormat": {
              "unit": 17,
              "options": {
                "maximumSignificantDigits": 3,
                "maximumFractionDigits": 2
              }
            }
          }
        }
      },
      "customWidth": "100",
      "name": "Details - Display"
    }
  ],
  "fallbackResourceIds": [
    "Azure Monitor"
  ],
  "fromTemplateId": "community-Workbooks/Azure Advisor/AzureServiceRetirement",
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
