{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "cf25e75f-17b3-4214-a720-82f4b49e41b2",
            "version": "KqlParameterItem/1.0",
            "name": "Resource",
            "type": 5,
            "description": "Resource ID",
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false,
              "componentIdOnly": true
            },
            "timeContext": {
              "durationMs": 86400000
            }
          },
          {
            "id": "f451ddc5-00e3-4fe7-908e-22d0be9ab59c",
            "version": "KqlParameterItem/1.0",
            "name": "detectionTime",
            "label": "Detection Time",
            "type": 4,
            "isRequired": true,
            "value": {
              "durationMs": 172800000
            },
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 300000
                },
                {
                  "durationMs": 900000
                },
                {
                  "durationMs": 1800000
                },
                {
                  "durationMs": 3600000
                },
                {
                  "durationMs": 14400000
                },
                {
                  "durationMs": 43200000
                },
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 172800000
                },
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 1209600000
                },
                {
                  "durationMs": 2419200000
                },
                {
                  "durationMs": 2592000000
                },
                {
                  "durationMs": 5184000000
                },
                {
                  "durationMs": 7776000000
                }
              ]
            },
            "timeContext": {
              "durationMs": 86400000
            }
          },
          {
            "id": "8c33c2e9-c37d-404b-8cda-03011dda515a",
            "version": "KqlParameterItem/1.0",
            "name": "Associations",
            "type": 5,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "where type =~ 'Microsoft.Network/applicationgateways'\r\n| where properties contains {Resource}",
            "crossComponentResources": [
              "{Resource}"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "value": [
              "value::all"
            ]
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.resourcegraph/resources"
      },
      "customWidth": "50",
      "name": "parameters - 0"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "tabs",
        "tabStyle": "bigger",
        "links": [
          {
            "id": "e259bad1-8100-4ab6-b5f9-dc0cef1c4047",
            "cellValue": "SelectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Triage",
            "subTarget": "triage-tab",
            "preText": "WAF Triage",
            "style": "link"
          },
          {
            "id": "05c90325-2ea4-477f-8556-691b3853a564",
            "cellValue": "SelectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Monitor",
            "subTarget": "monitor-tab",
            "preText": "WAF Monitor",
            "style": "link"
          }
        ]
      },
      "name": "links - 1",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AzureDiagnostics \n| where Category == \"ApplicationGatewayFirewallLog\"\n| where TimeGenerated {detectionTime}\n| extend Id = new_guid()\n| extend policyScopeName_s = column_ifexists(\"policyScopeName_s\", \"\"), action_s = column_ifexists(\"action_s\", \"\")\n| project-reorder Id, ResourceId, policyScopeName_s, action_s\n//| summarize count() by ResourceId, policyScopeName_s, action_s\n| evaluate pivot(action_s, count(), ResourceId, policyScope_s, policyScopeName_s )",
              "size": 1,
              "title": "Select the scope of the WAF policy",
              "showRefreshButton": true,
              "exportMultipleValues": true,
              "exportedParameters": [
                {
                  "fieldName": "policyScopeName_s",
                  "parameterName": "PolicyScope",
                  "parameterType": 1
                },
                {
                  "fieldName": "ResourceId",
                  "parameterName": "ResourceId",
                  "parameterType": 1
                }
              ],
              "showExportToExcel": true,
              "exportToExcelOptions": "all",
              "queryType": 0,
              "resourceType": "microsoft.network/applicationgateways",
              "crossComponentResources": [
                "{Associations}"
              ],
              "visualization": "table",
              "showExpandCollapseGrid": true,
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Blocked",
                    "formatter": 8,
                    "formatOptions": {
                      "palette": "greenRed"
                    }
                  },
                  {
                    "columnMatch": "Matched",
                    "formatter": 8,
                    "formatOptions": {
                      "palette": "greenRed"
                    }
                  }
                ],
                "rowLimit": 500,
                "filter": true,
                "sortBy": [
                  {
                    "itemKey": "$gen_link_ResourceId_0",
                    "sortOrder": 1
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "ResourceId",
                    "label": "App Gateway"
                  },
                  {
                    "columnId": "policyScope_s",
                    "label": "Scope Type"
                  },
                  {
                    "columnId": "policyScopeName_s",
                    "label": "Scope Name"
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "$gen_link_ResourceId_0",
                  "sortOrder": 1
                }
              ],
              "tileSettings": {
                "showBorder": false
              },
              "graphSettings": {
                "type": 0,
                "topContent": {
                  "columnMatch": "ResourceId",
                  "formatter": 1
                },
                "centerContent": {
                  "columnMatch": "Blocked",
                  "formatter": 1,
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              }
            },
            "name": "query-app-gateway-resources"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "tabs",
              "links": [
                {
                  "id": "14e61d36-d59a-405d-8363-ac1aa8a2f491",
                  "cellValue": "SelectedTabPage",
                  "linkTarget": "parameter",
                  "linkLabel": "Triage by Rule",
                  "subTarget": "triage-by-rule",
                  "preText": "Triage by Rule",
                  "style": "link"
                },
                {
                  "id": "93464fc4-d183-4d74-9e06-111c6de081a9",
                  "cellValue": "SelectedTabPage",
                  "linkTarget": "parameter",
                  "linkLabel": "Triage by URL",
                  "subTarget": "triage-by-url",
                  "preText": "Triage ",
                  "style": "link"
                }
              ]
            },
            "name": "TabNavigation"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let Policy_list = dynamic ([{PolicyScope}]);\r\nlet Resource_list = dynamic ([{ResourceId}]);\r\nAzureDiagnostics\r\n| where Category == \"ApplicationGatewayFirewallLog\"\r\n| where ResourceId in (Resource_list) and policyScopeName_s in (Policy_list) \r\n\r\n// at this point hostname_s can still contain both hostname and port; for example: www.myhost.com:80 -> we need to split this up to match on just the host later\r\n| extend splittedhost = split(hostname_s, ':')\r\n//| extend hostname_s_noport =  tostring(splittedhost[0]) //override hostname_s to just contain host; drop the port section\r\n| extend hostname_s_noport = iif(isnull(splittedhost[0]) or isempty(splittedhost[0]), \"NA\", tostring(splittedhost[0]))\r\n| extend port =  tostring(splittedhost[1])\r\n//| distinct hostname_s, hostname_s_noport\r\n| summarize total=count() by hostname_s, hostname_s_noport\r\n| extend hostname_s = iif(isempty(hostname_s),\"NA\", hostname_s)\r\n| project  hostname_s,total\r\n| order by total desc\r\n",
                    "size": 0,
                    "title": "Impacted Hosts",
                    "noDataMessage": "The query returned no results. Please select a scope from the table above.",
                    "timeContextFromParameter": "detectionTime",
                    "showRefreshButton": true,
                    "exportFieldName": "hostname_s",
                    "exportParameterName": "HostName",
                    "queryType": 0,
                    "resourceType": "microsoft.network/applicationgateways",
                    "crossComponentResources": [
                      "{Associations}"
                    ],
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "hostname_s",
                          "formatter": 0,
                          "formatOptions": {
                            "customColumnWidthSetting": "100%"
                          }
                        }
                      ],
                      "sortBy": [
                        {
                          "itemKey": "total",
                          "sortOrder": 2
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "hostname_s",
                          "label": "Host"
                        },
                        {
                          "columnId": "total",
                          "label": "Total"
                        }
                      ]
                    },
                    "sortBy": [
                      {
                        "itemKey": "total",
                        "sortOrder": 2
                      }
                    ]
                  },
                  "customWidth": "15",
                  "name": "Hostnames with entries in Firewall Log"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let Policy_list = dynamic ([{PolicyScope}]);\r\nlet Resource_list = dynamic ([{ResourceId}]);\r\nAzureDiagnostics\r\n| where Category == \"ApplicationGatewayFirewallLog\"\r\n//| where ResourceId == '{ResourceId}' and policyScopeName_s == '{PolicyScope}'\r\n| where ResourceId in (Resource_list) and policyScopeName_s in (Policy_list)\r\n|extend hostname_s = iif(isnull(hostname_s) or isempty(hostname_s), \"NA\", tostring(hostname_s))\r\n| where hostname_s == '{HostName}'\r\n| where TimeGenerated {detectionTime}\r\n\r\n| join kind=inner (AzureDiagnostics | where Category == \"ApplicationGatewayAccessLog\" | where ResourceId in (Resource_list))\r\n on transactionId_g\r\n//| distinct  requestUri_s, httpMethod_s1, originalRequestUriWithArgs_s1, httpStatus_d1\r\n| extend access_log = strcat(\"AzureDiagnostics | where Category == \\\"ApplicationGatewayAccessLog\\\" | where TimeGenerated {detectionTime} | where transactionId_g == \\\"\", transactionId_g, \"\\\"\")\r\n| extend firewall_log = strcat(\"AzureDiagnostics | where Category == \\\"ApplicationGatewayFirewallLog\\\" | where TimeGenerated {detectionTime} | where transactionId_g == \\\"\", transactionId_g, \"\\\"\")\r\n| project-reorder requestUri_s, httpMethod_s1, originalRequestUriWithArgs_s1, httpStatus_d1\r\n| project requestUri_s, httpMethod_s1, originalRequestUriWithArgs_s1, httpStatus_d1, transactionId_g, access_log, firewall_log\r\n| extend Id = new_guid()\r\n\r\n",
                    "size": 0,
                    "title": "URL Impacted for Selected Scope",
                    "noDataMessage": "The query returned no results. Please select a Host.",
                    "timeContextFromParameter": "detectionTime",
                    "showRefreshButton": true,
                    "exportedParameters": [
                      {
                        "fieldName": "requestUri_s",
                        "parameterName": "RequestUri"
                      },
                      {
                        "fieldName": "originalRequestUriWithArgs_s1",
                        "parameterName": "RequestUriWithArgs",
                        "parameterType": 1
                      },
                      {
                        "fieldName": "httpMethod_s1",
                        "parameterName": "HttpMethod",
                        "parameterType": 1
                      },
                      {
                        "fieldName": "httpStatus_d1",
                        "parameterName": "HttpStatus",
                        "parameterType": 1
                      },
                      {
                        "fieldName": "transactionId_g",
                        "parameterName": "TransactionId",
                        "parameterType": 1
                      }
                    ],
                    "queryType": 0,
                    "resourceType": "microsoft.network/applicationgateways",
                    "crossComponentResources": [
                      "{Associations}"
                    ],
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "requestUri_s",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "httpMethod_s1",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "Id",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "access_log",
                          "formatter": 7,
                          "formatOptions": {
                            "linkTarget": "OpenBlade",
                            "linkLabel": "Find in Access Log",
                            "linkIsContextBlade": true,
                            "bladeOpenContext": {
                              "bladeName": "LogsBlade",
                              "extensionName": "Microsoft_Azure_Monitoring_Logs",
                              "bladeParameters": [
                                {
                                  "name": "source",
                                  "source": "static",
                                  "value": "Microsoft_Azure_Monitoring_Logs/LogsBlade"
                                },
                                {
                                  "name": "query",
                                  "source": "cell",
                                  "value": ""
                                },
                                {
                                  "name": "resourceId",
                                  "source": "parameter",
                                  "value": "ResourceId"
                                }
                              ]
                            }
                          }
                        },
                        {
                          "columnMatch": "firewall_log",
                          "formatter": 7,
                          "formatOptions": {
                            "linkTarget": "OpenBlade",
                            "linkLabel": "Find in Firewall Log",
                            "linkIsContextBlade": true,
                            "bladeOpenContext": {
                              "bladeName": "LogsBlade",
                              "extensionName": "Microsoft_Azure_Monitoring_Logs",
                              "bladeParameters": [
                                {
                                  "name": "source",
                                  "source": "static",
                                  "value": "Microsoft_Azure_Monitoring_Logs/LogsBlade"
                                },
                                {
                                  "name": "query",
                                  "source": "cell",
                                  "value": ""
                                },
                                {
                                  "name": "resourceId",
                                  "source": "parameter",
                                  "value": "ResourceId"
                                }
                              ]
                            }
                          }
                        },
                        {
                          "columnMatch": "encodedRequestUriWithArgs",
                          "formatter": 5
                        }
                      ],
                      "filter": true,
                      "hierarchySettings": {
                        "treeType": 1,
                        "groupBy": [
                          "requestUri_s",
                          "httpMethod_s1"
                        ],
                        "expandTopLevel": true
                      },
                      "labelSettings": [
                        {
                          "columnId": "requestUri_s",
                          "label": "Request URI"
                        },
                        {
                          "columnId": "httpMethod_s1",
                          "label": "HTTP Method"
                        },
                        {
                          "columnId": "originalRequestUriWithArgs_s1",
                          "label": "Original Request "
                        },
                        {
                          "columnId": "httpStatus_d1",
                          "label": "HTTP Status "
                        },
                        {
                          "columnId": "access_log",
                          "label": "Access Log"
                        },
                        {
                          "columnId": "firewall_log",
                          "label": "Firewall Log "
                        }
                      ]
                    },
                    "sortBy": []
                  },
                  "customWidth": "60",
                  "name": "Paths which have triggered firewall rules"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "AzureDiagnostics \r\n| where Category == \"ApplicationGatewayFirewallLog\"\r\n//| where TimeGenerated {detectionTime}\r\n| where transactionId_g == '{TransactionId}'\r\n| extend Id = new_guid()\r\n| project-reorder Id, action_s, ruleSetType_s, ruleSetVersion_s, ruleId_s, Message, hostname_s, requestUri_s, details_message_s, details_data_s, details_file_s, details_line_s, transactionId_g\r\n| extend normalizedRuleSetVersion = case(isempty(ruleSetVersion_s), \"\",\r\n                                         // old engine: rulesetVersion_s looks like \"3.1.0\" while type is \"OWASP_CRS\" => leave untouched, can use this as-is\r\n                                         //             final url to GH is like: https://github.com/coreruleset/coreruleset/blob/v3.1.0/rules/REQUEST-913-SCANNER-DETECTION.conf#L56\r\n                                         ruleSetVersion_s matches regex \"[0-9]+.[0-9]+.[0-9]+\", ruleSetVersion_s,\r\n                                         // new engine: rulesetVersion_s looks like \"3.2\" while type is \"OWASP CRS\" => need a version that looks like \"3.2.0\"\r\n                                         //             final url to GH is like: https://github.com/coreruleset/coreruleset/blob/v3.2.0/rules/REQUEST-920-PROTOCOL-ENFORCEMENT.conf#L56\r\n                                         ruleSetVersion_s matches regex \"[0-9]+.[0-9]+\", strcat(ruleSetVersion_s, \".0\"),\r\n                                         \"\")\r\n| extend normalizedDetailsFile = case(  ruleSetType_s == \"OWASP_CRS\", replace(@'rules/', '', details_file_s),   // old engine: details_files_s looks like \"rules/REQUEST-920-PROTOCOL-ENFORCEMENT.conf\" while type is \"OWASP_CRS\"\r\n                                        ruleSetType_s == \"OWASP CRS\", details_file_s,                           // new engine: details_files_s looks like \"REQUEST-920-PROTOCOL-ENFORCEMENT.conf\" while type is \"OWASP CRS\"\r\n                                        details_file_s)\r\n| extend Url = iif(isnotempty(ruleSetVersion_s), strcat('https://github.com/coreruleset/coreruleset/blob/', 'v', normalizedRuleSetVersion, '/rules/', normalizedDetailsFile, '#L', details_line_s), '')\r\n| extend RuleSet_V = strcat(ruleSetType_s, \" \", ruleSetVersion_s )\r\n| project action_s,RuleSet_V, ruleId_s, Message, details_message_s, details_data_s, Url, TimeGenerated, ruleSetType_s, normalizedRuleSetVersion\r\n",
                    "size": 0,
                    "title": "Rules Triggered for Selected Request",
                    "noDataMessage": "The query returned no results. Please select a Transaction ID.",
                    "timeContextFromParameter": "detectionTime",
                    "exportedParameters": [
                      {
                        "fieldName": "transactionId_g",
                        "parameterName": "TransactionId"
                      },
                      {
                        "fieldName": "Message",
                        "parameterName": "message",
                        "parameterType": 1
                      },
                      {
                        "fieldName": "details_message_s",
                        "parameterName": "details",
                        "parameterType": 1
                      },
                      {
                        "fieldName": "details_data_s",
                        "parameterName": "matcheddata",
                        "parameterType": 1
                      },
                      {
                        "fieldName": "Url",
                        "parameterName": "SpiderLabsUrl",
                        "parameterType": 1
                      }
                    ],
                    "queryType": 0,
                    "resourceType": "microsoft.network/applicationgateways",
                    "crossComponentResources": [
                      "{Associations}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "action_s",
                          "formatter": 18,
                          "formatOptions": {
                            "thresholdsOptions": "icons",
                            "thresholdsGrid": [
                              {
                                "operator": "==",
                                "thresholdValue": "Matched",
                                "representation": "2",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "==",
                                "thresholdValue": "Blocked",
                                "representation": "4",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "Default",
                                "thresholdValue": null,
                                "representation": "more",
                                "text": "{0}{1}"
                              }
                            ]
                          }
                        },
                        {
                          "columnMatch": "ruleId_s",
                          "formatter": 18,
                          "formatOptions": {
                            "thresholdsOptions": "colors",
                            "thresholdsGrid": [
                              {
                                "operator": "==",
                                "thresholdValue": "{RuleId}",
                                "representation": "yellow",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "Default",
                                "thresholdValue": null,
                                "text": "{0}{1}"
                              }
                            ]
                          }
                        },
                        {
                          "columnMatch": "Url",
                          "formatter": 7,
                          "formatOptions": {
                            "linkTarget": "Url",
                            "linkLabel": "Go to Core Rule Set Project GitHub for this rule"
                          }
                        },
                        {
                          "columnMatch": "ruleSetType_s",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "normalizedRuleSetVersion",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "statusFromAction",
                          "formatter": 5,
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal"
                            }
                          }
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "action_s",
                          "label": "Ation"
                        },
                        {
                          "columnId": "RuleSet_V",
                          "label": "Ruleset Version"
                        },
                        {
                          "columnId": "ruleId_s",
                          "label": "Rule Id"
                        },
                        {
                          "columnId": "Message",
                          "label": "Description"
                        },
                        {
                          "columnId": "details_message_s",
                          "label": "Details"
                        },
                        {
                          "columnId": "details_data_s",
                          "label": "Matched Data"
                        },
                        {
                          "columnId": "Url",
                          "label": "URL "
                        },
                        {
                          "columnId": "TimeGenerated",
                          "label": "Time Generated"
                        }
                      ]
                    }
                  },
                  "name": "TriggeredRules - By Url"
                },
                {
                  "type": 1,
                  "content": {
                    "json": "## Selection Summary:\r\n\r\nYou were looking for requests which triggered a WAF rule on url: _{RequestUri}_.  \r\nYou have found an HTTP request, impacted by this rule, with transaction id equal to *{TransactionId}*.  \r\n\r\n\r\n\r\n\r\n\r\nMore info on this request and the selected rule:\r\n- Message: {message}\r\n- Details: {details}\r\n- Matched Data: {matcheddata}"
                  },
                  "name": "text - 7 - Copy"
                }
              ],
              "exportParameters": true
            },
            "conditionalVisibility": {
              "parameterName": "SelectedTabPage",
              "comparison": "isEqualTo",
              "value": "triage-by-url"
            },
            "name": "Triage by URL"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let Policy_list = dynamic ([{PolicyScope}]);\r\nlet Resource_list = dynamic ([{ResourceId}]);\r\nAzureDiagnostics \r\n| where Category == \"ApplicationGatewayFirewallLog\"\r\n| where TimeGenerated {detectionTime}\r\n//| where ResourceId == '{ResourceId}' and policyScopeName_s in ('{PolicyScope}')\r\n|where ResourceId in (Resource_list) and policyScopeName_s in (Policy_list)\r\n| summarize Count = count() by ruleId_s, action_s, ruleSetType_s, ruleSetVersion_s, ruleGroup_s, details_file_s, details_line_s,  ResourceId, policyScopeName_s, policyScope_s\r\n//| summarize Count = count() by ruleSetType_s, ruleSetVersion_s, ruleId_s, details_file_s, details_line_s, action_s, ResourceId, policyScopeName_s, policyScope_s\r\n//| project-reorder Count\r\n| extend normalizedRuleSetVersion = case(isempty(ruleSetVersion_s), \"\",\r\n                                       \r\n                                         ruleSetVersion_s matches regex \"[0-9]+.[0-9]+.[0-9]+\", ruleSetVersion_s,\r\n                                        \r\n                                         ruleSetVersion_s matches regex \"[0-9]+.[0-9]+\", strcat(ruleSetVersion_s, \".0\"),\r\n                                         \"\")\r\n| extend normalizedDetailsFile = case(  ruleSetType_s == \"OWASP_CRS\", replace(@'rules/', '', details_file_s),   \r\n                                        ruleSetType_s == \"OWASP CRS\", details_file_s,                           \r\n                                        details_file_s)\r\n| extend Url = iif(isnotempty(ruleGroup_s), strcat('https://github.com/coreruleset/coreruleset/blob/', 'v', normalizedRuleSetVersion, '/rules/', normalizedDetailsFile, '#L', details_line_s), '')\r\n// add sparklines\r\n| join kind=inner (AzureDiagnostics | where Category == \"ApplicationGatewayFirewallLog\" | where TimeGenerated {detectionTime} | where  ResourceId in (Resource_list) and policyScopeName_s in (Policy_list)\r\n                                    | make-series Trend = count() on TimeGenerated from {detectionTime:start} to {detectionTime:end} step (time({detectionTime:seconds} seconds) / 20)  by ruleId_s\r\n    ) on ruleId_s\r\n\r\n| extend Id = new_guid()\r\n| extend RuleSet_V = strcat(ruleSetType_s, \" \", ruleSetVersion_s )\r\n|project-away ruleId_s1, Id\r\n|project-reorder Count, ruleId_s, action_s, RuleSet_V, ruleGroup_s, ResourceId, policyScopeName_s, policyScope_s, Url, Trend, ruleSetType_s,ruleSetVersion_s\r\n| order by Count desc\r\n\r\n",
                    "size": 0,
                    "showAnalytics": true,
                    "title": "Rules Triggered for Selected Scope",
                    "noDataMessage": "The query returned no results. Please select a scope from the table above.",
                    "timeContextFromParameter": "detectionTime",
                    "showRefreshButton": true,
                    "exportedParameters": [
                      {
                        "fieldName": "ruleId_s",
                        "parameterName": "RuleId",
                        "parameterType": 1
                      },
                      {
                        "fieldName": "Url",
                        "parameterName": "SpiderLabsUrl",
                        "parameterType": 1
                      },
                      {
                        "fieldName": "ruleSetVersion_s",
                        "parameterName": "RuleSetVersion",
                        "parameterType": 1
                      }
                    ],
                    "queryType": 0,
                    "resourceType": "microsoft.network/applicationgateways",
                    "crossComponentResources": [
                      "{Associations}"
                    ],
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Count",
                          "formatter": 8,
                          "formatOptions": {
                            "palette": "greenRed"
                          }
                        },
                        {
                          "columnMatch": "Url",
                          "formatter": 7,
                          "formatOptions": {
                            "linkTarget": "Url",
                            "linkLabel": "Go to Core Rule Set Project GitHub for this rule"
                          }
                        },
                        {
                          "columnMatch": "Trend",
                          "formatter": 9,
                          "formatOptions": {
                            "palette": "greenRed"
                          }
                        },
                        {
                          "columnMatch": "ruleSetType_s",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "ruleSetVersion_s",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "details_file_s",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "details_line_s",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "normalizedRuleSetVersion",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "normalizedDetailsFile",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "TimeGenerated",
                          "formatter": 5
                        }
                      ],
                      "filter": true,
                      "sortBy": [
                        {
                          "itemKey": "$gen_link_ResourceId_5",
                          "sortOrder": 1
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "ruleId_s",
                          "label": "Rule ID"
                        },
                        {
                          "columnId": "action_s",
                          "label": "Action"
                        },
                        {
                          "columnId": "RuleSet_V",
                          "label": "Ruleset Version"
                        },
                        {
                          "columnId": "ruleGroup_s",
                          "label": "Rule Group"
                        },
                        {
                          "columnId": "ResourceId",
                          "label": "AppGW"
                        },
                        {
                          "columnId": "policyScopeName_s",
                          "label": "Scope Name"
                        },
                        {
                          "columnId": "policyScope_s",
                          "label": "Scope Type"
                        },
                        {
                          "columnId": "Url",
                          "label": "URL"
                        }
                      ]
                    },
                    "sortBy": [
                      {
                        "itemKey": "$gen_link_ResourceId_5",
                        "sortOrder": 1
                      }
                    ]
                  },
                  "customWidth": "100",
                  "name": "query - violated rules"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let Policy_list = dynamic ([{PolicyScope}]);\r\nlet Resource_list = dynamic ([{ResourceId}]);\r\nAzureDiagnostics\r\n| where Category == \"ApplicationGatewayFirewallLog\"\r\n| where ResourceId in (Resource_list) and policyScopeName_s in (Policy_list) and ruleId_s == '{RuleId}' and ruleSetVersion_s == '{RuleSetVersion}'\r\n| where TimeGenerated {detectionTime}\r\n\r\n// at this point hostname_s can still contain both hostname and port; for example: www.myhost.com:80 -> we need to split this up to match on just the host later\r\n| extend splittedhost = split(hostname_s, ':')\r\n//| extend hostname_s_noport =  tostring(splittedhost[0]) //override hostname_s to just contain host; drop the port section\r\n| extend hostname_s_noport = iif(isnull(splittedhost[0]) or isempty(splittedhost[0]), \"NA\", tostring(splittedhost[0]))\r\n| extend port =  tostring(splittedhost[1])\r\n//| distinct hostname_s, hostname_s_noport\r\n| summarize total=count() by hostname_s_noport, ruleId_s,hostname_s\r\n| extend hostname_s = iif(isempty(hostname_s),\"NA\", hostname_s)\r\n| project  hostname_s,total,hostname_s_noport\r\n| order by total desc\r\n",
                    "size": 0,
                    "title": "Impacted Hosts ",
                    "noDataMessage": "The query returned no results. Please select a Rule from the table above.",
                    "timeContextFromParameter": "detectionTime",
                    "showRefreshButton": true,
                    "exportedParameters": [
                      {
                        "fieldName": "hostname_s",
                        "parameterName": "HostName",
                        "parameterType": 1
                      },
                      {
                        "fieldName": "hostname_s_noport",
                        "parameterName": "HostNameNoPort",
                        "parameterType": 1
                      }
                    ],
                    "queryType": 0,
                    "resourceType": "microsoft.network/applicationgateways",
                    "crossComponentResources": [
                      "{Associations}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "hostname_s_noport",
                          "formatter": 5
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "hostname_s",
                          "label": "Host"
                        },
                        {
                          "columnId": "total",
                          "label": "Total"
                        }
                      ]
                    },
                    "sortBy": []
                  },
                  "customWidth": "30",
                  "showPin": true,
                  "name": "Affected Hosts"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let Policy_list = dynamic ([{PolicyScope}]);\r\nlet Resource_list = dynamic ([{ResourceId}]);\r\nAzureDiagnostics\r\n| where Category == \"ApplicationGatewayFirewallLog\"\r\n| where TimeGenerated {detectionTime}\r\n//| where ResourceId == '{ResourceId}' and policyScopeName_s == '{PolicyScope}' and ruleId_s == '{RuleId}'\r\n|where ResourceId in (Resource_list) and policyScopeName_s in (Policy_list) and ruleId_s == '{RuleId}'\r\n|extend hostname_s = iif(isnull(hostname_s) or isempty(hostname_s), \"NA\", tostring(hostname_s))\r\n| where hostname_s == '{HostName}'\r\n| project-reorder hostname_s, transactionId_g\r\n| join kind=inner (AzureDiagnostics | where Category == \"ApplicationGatewayAccessLog\" | where TimeGenerated {detectionTime}) on transactionId_g\r\n//| distinct host_s1, httpMethod_s1, requestUri_s1, originalRequestUriWithArgs_s1\r\n| extend access_log = strcat(\"AzureDiagnostics | where Category == \\\"ApplicationGatewayAccessLog\\\" | where TimeGenerated {detectionTime} | where transactionId_g == \\\"\", transactionId_g, \"\\\"\")\r\n| extend firewall_log = strcat(\"AzureDiagnostics | where Category == \\\"ApplicationGatewayFirewallLog\\\" | where TimeGenerated {detectionTime} | where transactionId_g == \\\"\", transactionId_g, \"\\\"\")\r\n| project host_s1, requestUri_s1, httpMethod_s1,  originalRequestUriWithArgs_s1 , transactionId_g, access_log, firewall_log\r\n| order by host_s1, requestUri_s1, httpMethod_s1, originalRequestUriWithArgs_s1, transactionId_g\r\n| extend id = new_guid()",
                    "size": 0,
                    "showAnalytics": true,
                    "title": "Rule-Impacted URLs for Selected Host ",
                    "noDataMessage": "The query returned no results. Please select a Host from the table on the left..",
                    "timeContextFromParameter": "detectionTime",
                    "showRefreshButton": true,
                    "exportedParameters": [
                      {
                        "fieldName": "httpMethod_s1",
                        "parameterName": "Method",
                        "parameterType": 1
                      },
                      {
                        "fieldName": "originalRequestUriWithArgs_s1",
                        "parameterName": "FullUri",
                        "parameterType": 1
                      },
                      {
                        "fieldName": "requestUri_s1",
                        "parameterName": "RequestUri",
                        "parameterType": 1
                      },
                      {
                        "fieldName": "transactionId_g",
                        "parameterName": "TransactionId",
                        "parameterType": 1
                      }
                    ],
                    "queryType": 0,
                    "resourceType": "microsoft.network/applicationgateways",
                    "crossComponentResources": [
                      "{Associations}"
                    ],
                    "visualization": "table",
                    "showExpandCollapseGrid": true,
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "host_s1",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "requestUri_s",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "access_log",
                          "formatter": 7,
                          "formatOptions": {
                            "linkTarget": "OpenBlade",
                            "linkLabel": "Find in Access Log",
                            "linkIsContextBlade": true,
                            "appInsightsContext": {
                              "resourceIdSource": "workbook",
                              "secondaryIdSource": "parameter",
                              "secondaryId": "ResourceId"
                            },
                            "bladeOpenContext": {
                              "bladeName": "LogsBlade",
                              "extensionName": "Microsoft_Azure_Monitoring_Logs",
                              "bladeParameters": [
                                {
                                  "name": "source",
                                  "source": "static",
                                  "value": "Microsoft_Azure_Monitoring_Logs/LogsBlade"
                                },
                                {
                                  "name": "query",
                                  "source": "cell",
                                  "value": ""
                                },
                                {
                                  "name": "resourceId",
                                  "source": "parameter",
                                  "value": "ResourceId"
                                }
                              ]
                            }
                          }
                        },
                        {
                          "columnMatch": "firewall_log",
                          "formatter": 7,
                          "formatOptions": {
                            "linkTarget": "OpenBlade",
                            "linkLabel": "Find in Firewall Log ",
                            "linkIsContextBlade": true,
                            "bladeOpenContext": {
                              "bladeName": "LogsBlade",
                              "extensionName": "Microsoft_Azure_Monitoring_Logs",
                              "bladeParameters": [
                                {
                                  "name": "source",
                                  "source": "static",
                                  "value": "Microsoft_Azure_Monitoring"
                                },
                                {
                                  "name": "query",
                                  "source": "cell",
                                  "value": ""
                                },
                                {
                                  "name": "resourceId",
                                  "source": "parameter",
                                  "value": "ResourceId"
                                }
                              ]
                            }
                          }
                        },
                        {
                          "columnMatch": "id",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "encodedRequestUri",
                          "formatter": 5
                        }
                      ],
                      "rowLimit": 1000,
                      "filter": true,
                      "hierarchySettings": {
                        "treeType": 1,
                        "groupBy": [
                          "requestUri_s1"
                        ],
                        "expandTopLevel": true,
                        "finalBy": "requestUri_s"
                      },
                      "sortBy": [
                        {
                          "itemKey": "$gen_count_$gen_group_0",
                          "sortOrder": 1
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "host_s1",
                          "label": "Host"
                        },
                        {
                          "columnId": "requestUri_s1",
                          "label": "Request URI"
                        },
                        {
                          "columnId": "httpMethod_s1",
                          "label": "HTTP Method"
                        },
                        {
                          "columnId": "originalRequestUriWithArgs_s1",
                          "label": "Original Request"
                        },
                        {
                          "columnId": "transactionId_g",
                          "label": "Request Id"
                        },
                        {
                          "columnId": "access_log",
                          "label": "Access Log"
                        },
                        {
                          "columnId": "firewall_log",
                          "label": "Firewall Log"
                        }
                      ]
                    },
                    "sortBy": [
                      {
                        "itemKey": "$gen_count_$gen_group_0",
                        "sortOrder": 1
                      }
                    ]
                  },
                  "customWidth": "70",
                  "name": "affected urls"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "AzureDiagnostics \r\n| where Category == \"ApplicationGatewayFirewallLog\"\r\n| where transactionId_g == '{TransactionId}'\r\n| extend Id = new_guid()\r\n| project-reorder Id, action_s, ruleSetType_s, ruleSetVersion_s, ruleId_s, Message, hostname_s, requestUri_s, details_message_s, details_data_s, details_file_s, details_line_s, transactionId_g\r\n| extend normalizedRuleSetVersion = case(isempty(ruleSetVersion_s), \"\",\r\n                                         // old engine: rulesetVersion_s looks like \"3.1.0\" while type is \"OWASP_CRS\" => leave untouched, can use this as-is\r\n                                         //             final url to GH is like: https://github.com/coreruleset/coreruleset/blob/v3.1.0/rules/REQUEST-913-SCANNER-DETECTION.conf#L56\r\n                                         ruleSetVersion_s matches regex \"[0-9]+.[0-9]+.[0-9]+\", ruleSetVersion_s,\r\n                                         // new engine: rulesetVersion_s looks like \"3.2\" while type is \"OWASP CRS\" => need a version that looks like \"3.2.0\"\r\n                                         //             final url to GH is like: https://github.com/coreruleset/coreruleset/blob/v3.2.0/rules/REQUEST-920-PROTOCOL-ENFORCEMENT.conf#L56\r\n                                         ruleSetVersion_s matches regex \"[0-9]+.[0-9]+\", strcat(ruleSetVersion_s, \".0\"),\r\n                                         \"\")\r\n| extend normalizedDetailsFile = case(  ruleSetType_s == \"OWASP_CRS\", replace(@'rules/', '', details_file_s),   // old engine: details_files_s looks like \"rules/REQUEST-920-PROTOCOL-ENFORCEMENT.conf\" while type is \"OWASP_CRS\"\r\n                                        ruleSetType_s == \"OWASP CRS\", details_file_s,                           // new engine: details_files_s looks like \"REQUEST-920-PROTOCOL-ENFORCEMENT.conf\" while type is \"OWASP CRS\"\r\n                                        details_file_s)\r\n| extend Url = iif(isnotempty(ruleSetVersion_s), strcat('https://github.com/coreruleset/coreruleset/blob/', 'v', normalizedRuleSetVersion, '/rules/', normalizedDetailsFile, '#L', details_line_s), '')\r\n| extend RuleSet_V = strcat(ruleSetType_s, \" \", ruleSetVersion_s )\r\n| project action_s,RuleSet_V, ruleId_s, Message, details_message_s, details_data_s, Url, TimeGenerated\r\n",
                    "size": 0,
                    "title": "Rules Triggered for Selected Request ",
                    "noDataMessage": "The query returned no results. Please select a Tramsaction Id.",
                    "timeContextFromParameter": "detectionTime",
                    "exportedParameters": [
                      {
                        "fieldName": "transactionId_g",
                        "parameterName": "TransactionId",
                        "parameterType": 1
                      },
                      {
                        "fieldName": "Message",
                        "parameterName": "message",
                        "parameterType": 1
                      },
                      {
                        "fieldName": "details_message_s",
                        "parameterName": "details",
                        "parameterType": 1
                      },
                      {
                        "fieldName": "details_data_s",
                        "parameterName": "matcheddata",
                        "parameterType": 1
                      }
                    ],
                    "queryType": 0,
                    "resourceType": "microsoft.network/applicationgateways",
                    "crossComponentResources": [
                      "{Associations}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "action_s",
                          "formatter": 18,
                          "formatOptions": {
                            "thresholdsOptions": "icons",
                            "thresholdsGrid": [
                              {
                                "operator": "==",
                                "thresholdValue": "Matched",
                                "representation": "2",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "==",
                                "thresholdValue": "Blocked",
                                "representation": "4",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "Default",
                                "thresholdValue": null,
                                "representation": "more",
                                "text": "{0}{1}"
                              }
                            ]
                          }
                        },
                        {
                          "columnMatch": "ruleId_s",
                          "formatter": 18,
                          "formatOptions": {
                            "thresholdsOptions": "colors",
                            "thresholdsGrid": [
                              {
                                "operator": "==",
                                "thresholdValue": "{RuleId}",
                                "representation": "yellow",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "Default",
                                "thresholdValue": null,
                                "text": "{0}{1}"
                              }
                            ]
                          }
                        },
                        {
                          "columnMatch": "Url",
                          "formatter": 7,
                          "formatOptions": {
                            "linkTarget": "Url",
                            "linkLabel": "Go to Core Rule Set Project GitHub for this rule"
                          }
                        },
                        {
                          "columnMatch": "statusFromAction",
                          "formatter": 1,
                          "numberFormat": {
                            "unit": 0,
                            "options": {
                              "style": "decimal"
                            }
                          }
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "action_s",
                          "label": "Action"
                        },
                        {
                          "columnId": "RuleSet_V",
                          "label": "Ruleset Version"
                        },
                        {
                          "columnId": "ruleId_s",
                          "label": "Rule Id"
                        },
                        {
                          "columnId": "Message",
                          "label": "Description"
                        },
                        {
                          "columnId": "details_message_s",
                          "label": "Details"
                        },
                        {
                          "columnId": "details_data_s",
                          "label": "Matched Data"
                        },
                        {
                          "columnId": "Url",
                          "label": "URL"
                        },
                        {
                          "columnId": "TimeGenerated",
                          "label": "Time Generated"
                        }
                      ]
                    }
                  },
                  "name": "TriggeredRules"
                },
                {
                  "type": 1,
                  "content": {
                    "json": "## Selection Summary:\r\n\r\nYou were looking for example requests which were impacted by WAF rule with id: **{RuleId}**.  \r\n\r\nOn the host with name \"*{HostName}*\" and url \"*{FullUri}*\" you have found an HTTP request, impacted by this rule, with transaction id equal to *{TransactionId}*.  \r\n\r\nMore info on this request and the selected rule:\r\n- Message: {message}\r\n- Details: {details}\r\n- Matched Data: {matcheddata}"
                  },
                  "name": "text - 7"
                }
              ],
              "exportParameters": true
            },
            "conditionalVisibility": {
              "parameterName": "SelectedTabPage",
              "comparison": "isEqualTo",
              "value": "triage-by-rule"
            },
            "name": "Triage by rule"
          }
        ],
        "exportParameters": true
      },
      "conditionalVisibility": {
        "parameterName": "SelectedTab",
        "comparison": "isEqualTo",
        "value": "triage-tab"
      },
      "name": "Triage Page"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "tabs",
              "links": [
                {
                  "id": "9a5fb8f4-61fa-4a63-bc89-ade6a64187a9",
                  "cellValue": "MonitorSelectedTab",
                  "linkTarget": "parameter",
                  "linkLabel": "Azure WAF Logs",
                  "subTarget": "WAFLogsTab",
                  "style": "link"
                },
                {
                  "id": "b3e39e6e-e8ba-418d-a632-63b5903fd594",
                  "cellValue": "MonitorSelectedTab",
                  "linkTarget": "parameter",
                  "linkLabel": "Azure WAF Metrics ",
                  "subTarget": "WAFMetricsTab",
                  "style": "link"
                }
              ]
            },
            "name": "Workbook Tabs"
          },
          {
            "type": 1,
            "content": {
              "json": "---"
            },
            "name": "text - 12"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let FakeData = (datatable (Message:string, ruleName_s:string, clientIp_s:string, clientIP_s:string, action_s:string, transactionId_s:string,trackingReference_s:string) [ \"\", \"\", \"\", \"\", \"\", \"\", \"\" ]);\r\nFakeData | union AzureDiagnostics\r\n| where OperationName == \"ApplicationGatewayFirewall\" or Category == \"WebApplicationFirewallLogs\"\r\n| extend Rule = strcat(ruleName_s, Message), ClientIP = strcat(clientIp_s, clientIP_s)\r\n| extend Action = iif(action_s == \"Blocked\", Action = \"Block\", action_s)\r\n| extend Action = iif(Action == \"Detected\", Action = \"Log\", Action)\r\n| extend Action = iif(action_s == \"JSChallenge\", Action = \"JSChallenge\", Action)\r\n| summarize number = count() by Action",
                    "size": 3,
                    "showAnalytics": true,
                    "title": "WAF Actions (select to filter)",
                    "timeContextFromParameter": "detectionTime",
                    "showRefreshButton": true,
                    "exportFieldName": "series",
                    "exportParameterName": "SelectedAction",
                    "exportDefaultValue": "*",
                    "showExportToExcel": true,
                    "exportToExcelOptions": "all",
                    "queryType": 0,
                    "resourceType": "microsoft.network/applicationgateways",
                    "crossComponentResources": [
                      "{Associations}"
                    ],
                    "visualization": "piechart"
                  },
                  "customWidth": "27",
                  "name": "query - 11"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let FakeData = (datatable (Message:string, ruleName_s:string, clientIp_s:string, clientIP_s:string, action_s:string, transactionId_s:string,trackingReference_s:string) [ \"\", \"\", \"\", \"\", \"\", \"\", \"\" ]);\r\nFakeData | union AzureDiagnostics\r\n| where OperationName == \"ApplicationGatewayFirewall\" or Category == \"WebApplicationFirewallLogs\"\r\n| extend Rule = strcat(ruleName_s, Message), ClientIP = strcat(clientIp_s, clientIP_s)\r\n| extend Action = iif(action_s == \"Blocked\", Action = \"Block\", action_s)\r\n| extend Action = iif(Action == \"Detected\", Action = \"Log\", Action)\r\n| where Action == \"Block\"\r\n| where requestUri_s <> \"/\"\r\n| summarize count() by requestUri_s \r\n| top 40 by count_ desc ",
                    "size": 3,
                    "showAnalytics": true,
                    "title": "Top 40 Blocked Request URIs (select to filter)",
                    "noDataMessage": "The current data has no \"Blocked\" results",
                    "timeContextFromParameter": "detectionTime",
                    "showRefreshButton": true,
                    "exportFieldName": "requestUri_s",
                    "exportParameterName": "RequestURI",
                    "exportDefaultValue": "*",
                    "showExportToExcel": true,
                    "exportToExcelOptions": "all",
                    "queryType": 0,
                    "resourceType": "microsoft.network/applicationgateways",
                    "crossComponentResources": [
                      "{Associations}"
                    ],
                    "visualization": "tiles",
                    "gridSettings": {
                      "filter": true
                    },
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "requestUri_s",
                        "formatter": 1,
                        "formatOptions": {
                          "showIcon": true
                        }
                      },
                      "leftContent": {
                        "columnMatch": "count_",
                        "formatter": 8,
                        "formatOptions": {
                          "palette": "auto",
                          "showIcon": true
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "useGrouping": false,
                            "maximumFractionDigits": 2,
                            "maximumSignificantDigits": 5
                          }
                        }
                      },
                      "showBorder": false,
                      "rowLimit": 40
                    },
                    "graphSettings": {
                      "type": 0,
                      "topContent": {
                        "columnMatch": "requestUri_s",
                        "formatter": 1
                      },
                      "centerContent": {
                        "columnMatch": "count_",
                        "formatter": 1,
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "maximumSignificantDigits": 3,
                            "maximumFractionDigits": 2
                          }
                        }
                      }
                    },
                    "mapSettings": {
                      "locInfo": "LatLong",
                      "sizeSettings": "count_",
                      "sizeAggregation": "Sum",
                      "legendMetric": "count_",
                      "legendAggregation": "Sum",
                      "itemColorSettings": {
                        "type": "heatmap",
                        "colorAggregation": "Sum",
                        "nodeColorField": "count_",
                        "heatmapPalette": "greenRed"
                      }
                    }
                  },
                  "customWidth": "63",
                  "name": "query - 9"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let FakeData = (datatable (Message:string, ruleName_s:string, clientIp_s:string, clientIP_s:string, action_s:string, transactionId_s:string,trackingReference_s:string, ruleId_s:string) [ \"\", \"\", \"\", \"\", \"\", \"\", \"\" ,\"\"]);\r\nFakeData | union AzureDiagnostics\r\n| where OperationName == \"ApplicationGatewayFirewall\" or Category == \"WebApplicationFirewallLogs\"\r\n| extend Action = iif(action_s == \"Blocked\", Action = \"Block\", action_s)\r\n| extend Action = iif(Action == \"Detected\", Action = \"Log\", Action)\r\n| where '{SelectedAction}' == Action or '{SelectedAction}' == \"*\" \r\n| where '{RequestURI}' == requestUri_s or '{RequestURI}' == \"*\"\r\n| extend Rule = strcat(ruleName_s, Message), ClientIP = strcat(clientIp_s, clientIP_s)\r\n| extend Rule= iif(Rule contains \"Mandatory rule. Cannot be disabled.\", strcat_array(split(Rule, \"Mandatory rule. Cannot be disabled. Inbound \",1),\"\"), Rule) // Removes initial component for mandatory rule \r\n| extend Rule = iif(Rule contains \"Total Inbound Score\", strcat_array(array_concat(split(Rule, \" - SQLI=\", 0), parse_json('[\") -\"]'), split(Rule,\"):\",1)),\"\"),Rule) // Removes smaller information if more info is available for anomaly score\r\n| summarize count() by  ruleId_s, Rule\r\n| top 50 by count_ desc\r\n",
                    "size": 0,
                    "showAnalytics": true,
                    "title": "Top 50 WAF Rules (select to filter)",
                    "timeContextFromParameter": "detectionTime",
                    "showRefreshButton": true,
                    "exportFieldName": "Rule",
                    "exportParameterName": "Selected",
                    "exportDefaultValue": "*",
                    "showExportToExcel": true,
                    "exportToExcelOptions": "all",
                    "queryType": 0,
                    "resourceType": "microsoft.network/applicationgateways",
                    "crossComponentResources": [
                      "{Associations}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "count_",
                          "formatter": 8,
                          "formatOptions": {
                            "palette": "blueDark",
                            "compositeBarSettings": {
                              "labelText": "",
                              "columnSettings": []
                            }
                          }
                        }
                      ],
                      "rowLimit": 50,
                      "filter": true,
                      "labelSettings": [
                        {
                          "columnId": "ruleId_s",
                          "label": "Rule Id"
                        },
                        {
                          "columnId": "count_",
                          "label": "Count"
                        }
                      ]
                    },
                    "sortBy": []
                  },
                  "customWidth": "40",
                  "name": "query - 12"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let FakeData = (datatable (Message:string, ruleName_s:string, clientIp_s:string, clientIP_s:string, action_s:string, transactionId_s:string,trackingReference_s:string) [ \"\", \"\", \"\", \"\", \"\", \"\", \"\" ]);\r\nFakeData | union AzureDiagnostics\r\n| where  OperationName == \"ApplicationGatewayFirewall\" or Category == \"WebApplicationFirewallLogs\"\r\n| extend Action = iif(action_s == \"Blocked\", Action = \"Block\", action_s)\r\n| extend Action = iif(Action == \"Detected\", Action = \"Log\", Action)\r\n| where '{SelectedAction}' == Action or '{SelectedAction}' == \"*\" \r\n| where '{RequestURI}' == requestUri_s or '{RequestURI}' == \"*\"\r\n| extend Rule = strcat(ruleName_s, Message), ClientIP = strcat(clientIp_s, clientIP_s)\r\n| where '{Selected}' == Rule or '{Selected}' == \"*\"\r\n| summarize count() by Rule, bin(TimeGenerated, 1h)\r\n",
                    "size": 0,
                    "showAnalytics": true,
                    "title": "Rules Over Time",
                    "timeContextFromParameter": "detectionTime",
                    "showRefreshButton": true,
                    "showExportToExcel": true,
                    "exportToExcelOptions": "all",
                    "queryType": 0,
                    "resourceType": "microsoft.network/applicationgateways",
                    "crossComponentResources": [
                      "{Associations}"
                    ],
                    "visualization": "barchart",
                    "tileSettings": {
                      "showBorder": false,
                      "titleContent": {
                        "columnMatch": "Message",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "count_",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "auto"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "maximumSignificantDigits": 3,
                            "maximumFractionDigits": 2
                          }
                        }
                      }
                    }
                  },
                  "customWidth": "60",
                  "name": "query - 13"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let FakeData = datatable (\r\n    Message:string, ruleName_s:string, clientIp_s:string, clientIP_s:string, action_s:string, transactionId_s:string, site_s:string,\r\n    details_message_sRole:string, details_file_sRole:string, hostname_sRole:string, Role:string, trackingReference_s:string,\r\n    requestUri_s:string, ruleSetType_s:string, details_message_s:string, details_data_s:string, details_file_s:string,\r\n    hostname_s:string, instanceId_s:string, ruleId_s:string, ruleSetVersion_s:string\r\n) [\"\" ,\"\" ,\"\" ,\"\" ,\"\" ,\"\" ,\"\" ,\"\" ,\"\" ,\"\" ,\"\" ,\"\" ,\"\" ,\"\" ,\"\" ,\"\" ,\"\" ,\"\" ,\"\" ,\"\" ,\"\" ];\r\n\r\nFakeData\r\n| union AzureDiagnostics\r\n| where OperationName == \"ApplicationGatewayFirewall\" or Category == \"WebApplicationFirewallLogs\"\r\n| extend Rule = strcat(ruleName_s, Message), ClientIP = strcat(clientIp_s, clientIP_s)\r\n| extend Action = iif(action_s == \"Blocked\", \"Block\", iif(action_s == \"Detected\", \"Log\", action_s))\r\n| where '{SelectedAction}' == Action or '{SelectedAction}' == \"*\" \r\n| where '{RequestURI}' == requestUri_s or '{RequestURI}' == \"*\"\r\n| where '{Selected}' == Rule or '{Selected}' == \"*\" \r\n| extend RuleSet_V = strcat(ruleSetType_s, \" \", ruleSetVersion_s)\r\n| extend RoleExtracted = extract(\"ApplicationGateway([a-zA-Z_0-9]*)\", 1, instanceId_s)\r\n| extend RequestUri = requestUri_s, Message_Details = details_message_s, Data_Details = details_data_s, File_Details = details_file_s, Hostname = hostname_s, Site = site_s\r\n| project ruleId_s, Rule, RuleSet_V, TimeGenerated, SourceSystem, Hostname, ResourceId, ResourceGroup, ResourceProvider, Category, RoleExtracted, Action, Site, Message_Details, File_Details, ClientIP, RequestUri\r\n| sort by TimeGenerated\r\n",
                    "size": 0,
                    "showAnalytics": true,
                    "title": "Rules Details",
                    "timeContextFromParameter": "detectionTime",
                    "showRefreshButton": true,
                    "showExportToExcel": true,
                    "exportToExcelOptions": "all",
                    "queryType": 0,
                    "resourceType": "{Associations}",
                    "crossComponentResources": [
                      "{Associations}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "SourceSystem",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "ResourceProvider",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "RoleExtracted",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "Site",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "File_Details",
                          "formatter": 5
                        }
                      ],
                      "filter": true,
                      "labelSettings": [
                        {
                          "columnId": "ruleId_s",
                          "label": "Rule Id"
                        },
                        {
                          "columnId": "RuleSet_V",
                          "label": "Ruleset Version"
                        },
                        {
                          "columnId": "TimeGenerated",
                          "label": "Time Generated"
                        },
                        {
                          "columnId": "Hostname",
                          "label": "Host"
                        },
                        {
                          "columnId": "ResourceId",
                          "label": "AppGW"
                        },
                        {
                          "columnId": "ResourceGroup",
                          "label": "Resource Group "
                        },
                        {
                          "columnId": "Message_Details",
                          "label": "Message Details"
                        },
                        {
                          "columnId": "ClientIP",
                          "label": "Client IP"
                        },
                        {
                          "columnId": "RequestUri",
                          "label": "Request URI"
                        }
                      ]
                    },
                    "sortBy": []
                  },
                  "name": "query - 11"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let FakeData = (datatable (Message:string, ruleName_s:string, clientIp_s:string, clientIP_s:string, action_s:string, transactionId_s:string,trackingReference_s:string ,ruleId_s:string) [ \"\", \"\", \"\", \"\", \"\", \"\", \"\" ,\"\"]);\r\nFakeData | union AzureDiagnostics\r\n| where  OperationName == \"ApplicationGatewayFirewall\"\r\n| where '{RequestURI}' == requestUri_s or '{RequestURI}' == \"*\"\r\n| extend Rule = strcat(ruleName_s, Message), ClientIP = strcat(clientIp_s, clientIP_s)\r\n| extend Action = iif(action_s == \"Blocked\", Action = \"Block\", action_s)\r\n| extend Action = iif(Action == \"Detected\", Action = \"Log\", Action)\r\n| where '{SelectedAction}' == Action or '{SelectedAction}' == \"*\" \r\n| where '{Selected}' == Rule or '{Selected}' == \"*\" \r\n| summarize Amount = count() by  Rule\r\n| order by Amount desc\r\n\r\n",
                    "size": 0,
                    "title": "Requests by Rule (select to filter)",
                    "noDataMessage": "No data found –try to expand the detection time range to include more events",
                    "timeContextFromParameter": "detectionTime",
                    "showRefreshButton": true,
                    "exportFieldName": "",
                    "exportParameterName": "MessageFilter",
                    "exportDefaultValue": "{\"Rule\":\"*\"}",
                    "showExportToExcel": true,
                    "exportToExcelOptions": "all",
                    "queryType": 0,
                    "resourceType": "microsoft.network/applicationgateways",
                    "crossComponentResources": [
                      "{Associations}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Amount",
                          "formatter": 8,
                          "formatOptions": {
                            "palette": "blueDark",
                            "showIcon": true,
                            "aggregation": "Sum"
                          }
                        }
                      ],
                      "filter": true,
                      "sortBy": [
                        {
                          "itemKey": "$gen_heatmap_Amount_1",
                          "sortOrder": 2
                        }
                      ]
                    },
                    "sortBy": [
                      {
                        "itemKey": "$gen_heatmap_Amount_1",
                        "sortOrder": 2
                      }
                    ]
                  },
                  "customWidth": "30",
                  "name": "query - 16"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let SelectedMS = dynamic({MessageFilter}); // reference to the above list of messages (Event trigger)\r\nlet Child = SelectedMS.Rule; // Used to choose a group of messages - redirects to the message which was grouped\r\nlet FakeData = (datatable (Message:string, ruleName_s:string, clientIp_s:string, clientIP_s:string, action_s:string, transactionId_s:string,trackingReference_s:string) [ \"\", \"\", \"\", \"\", \"\", \"\", \"\" ]);\r\nFakeData | union AzureDiagnostics\r\n| where '{RequestURI}' == requestUri_s or '{RequestURI}' == \"*\"\r\n| where OperationName == \"ApplicationGatewayFirewall\"\r\n| extend Action = iif(action_s == \"Blocked\", Action = \"Block\", action_s)\r\n| extend Action = iif(Action == \"Detected\", Action = \"Log\", Action)\r\n| where '{SelectedAction}' == Action or '{SelectedAction}' == \"*\" \r\n| extend Rule = strcat(ruleName_s, Message), ClientIP = strcat(clientIp_s, clientIP_s)\r\n| where Rule == Child or Child == \"*\"\r\n| where '{Selected}' == Rule or '{Selected}' == \"*\"\r\n| summarize Amount = count() by Rule, bin(TimeGenerated, 1h), ResourceId\r\n| project Amount, Rule, TimeGenerated, ResourceId\r\n| order by Amount desc",
                    "size": 0,
                    "showAnalytics": true,
                    "title": "Requests by Rule Over Time",
                    "noDataMessage": "No data found –try to expand the detection time range to include more events",
                    "timeContextFromParameter": "detectionTime",
                    "showRefreshButton": true,
                    "exportParameterName": "Message",
                    "exportDefaultValue": "{ \"Name\":\"\", \"Type\":\"*\"}",
                    "showExportToExcel": true,
                    "exportToExcelOptions": "all",
                    "queryType": 0,
                    "resourceType": "microsoft.network/applicationgateways",
                    "crossComponentResources": [
                      "{Associations}"
                    ],
                    "visualization": "areachart"
                  },
                  "customWidth": "70",
                  "name": "query - 14"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let SelectedMS = dynamic({MessageFilter}); // reference to the above list of messages (Event trigger)\r\nlet Child = SelectedMS.Rule; // Used to choose a group of messages - redirects to the message which was grouped\r\nlet FakeData = (datatable (Message:string, ruleName_s:string, clientIp_s:string, clientIP_s:string, action_s:string, transactionId_s:string,trackingReference_s:string) [ \"\", \"\", \"\", \"\", \"\", \"\", \"\" ]);\r\nFakeData | union AzureDiagnostics\r\n| where OperationName == \"ApplicationGatewayFirewall\" \r\n| where '{RequestURI}' == requestUri_s or '{RequestURI}' == \"*\"\r\n| extend Rule = strcat(ruleName_s, Message), ClientIP = strcat(clientIp_s, clientIP_s)\r\n| extend Action = iif(action_s == \"Blocked\", Action = \"Block\", action_s)\r\n| extend Action = iif(Action == \"Detected\", Action = \"Log\", Action)\r\n| extend TrackingID = iff (isnull(strcat(transactionId_s, trackingReference_s)) or isempty(strcat(transactionId_s, trackingReference_s)) ,\"NA\", strcat(transactionId_s, trackingReference_s))\r\n| where '{SelectedAction}' == Action or '{SelectedAction}' == \"*\" \r\n| where '{Selected}' == Rule or '{Selected}' == \"*\"\r\n| where Rule == Child or Child == \"*\" \r\n| distinct TrackingID",
                    "size": 0,
                    "showAnalytics": true,
                    "title": " Filter by Tracking ID",
                    "noDataMessage": "No data found –try to expand the detection time range to include more events",
                    "timeContextFromParameter": "detectionTime",
                    "exportFieldName": "TrackingID",
                    "exportParameterName": "SelectedTrackingID",
                    "exportDefaultValue": "*",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.network/applicationgateways",
                    "crossComponentResources": [
                      "{Associations}"
                    ],
                    "gridSettings": {
                      "rowLimit": 500,
                      "filter": true,
                      "sortBy": [
                        {
                          "itemKey": "TrackingID",
                          "sortOrder": 1
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "TrackingID",
                          "label": "Tracking Id"
                        }
                      ]
                    },
                    "sortBy": [
                      {
                        "itemKey": "TrackingID",
                        "sortOrder": 1
                      }
                    ]
                  },
                  "customWidth": "20",
                  "name": "query - 12"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let SelectedMS = dynamic({MessageFilter}); // reference to the above list of messages (Event trigger)\r\nlet Child = SelectedMS.Rule; // Used to choose a group of messages - redirects to the message which was grouped\r\nlet FakeData = (datatable (Message:string,ruleName_s:string,clientIp_s:string,clientIP_s:string,action_s:string,transactionId_s:string,site_s:string,details_message_sRole:string,details_file_sRole:string,hostname_sRole:string,Role:string,trackingReference_s:string,ruleGroup_s:string,instanceId_s:string,ruleSetType_s:string,details_message_s:string,details_data_s:string,details_file_s:string,hostname_s:string, ruleId_s:string,ruleSetVersion_s:string, ResourceId:string) [\"\",\"\",\"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\",\"\", \"\", \"\", \"\", \"\",\"\",\"\",\"\",\"\",\"\" ]);\r\nFakeData | union AzureDiagnostics\r\n| where OperationName == \"ApplicationGatewayFirewall\" \r\n| where '{RequestURI}' == requestUri_s or '{RequestURI}' == \"*\"\r\n| extend Rule = strcat(ruleName_s, Message), ClientIP = strcat(clientIp_s, clientIP_s)\r\n| extend Action = iif(action_s == \"Blocked\", Action = \"Block\", action_s)\r\n| extend Action = iif(Action == \"Detected\", Action = \"Log\", Action)\r\n| extend TrackingID = iff (isnull(strcat(transactionId_s, trackingReference_s)) or isempty(strcat(transactionId_s, trackingReference_s)) ,\"NA\", strcat(transactionId_s, trackingReference_s))\r\n//| extend TrackingID = strcat(transactionId_s, trackingReference_s)\r\n//| extend TrackingID = iff(isnull(TrackingID) or isempty(TrackingID),\"NA\", TrackingID)\r\n| where '{SelectedTrackingID}' == TrackingID or '{SelectedTrackingID}' == \"*\" \r\n| where '{SelectedAction}' == Action or '{SelectedAction}' == \"*\" \r\n| where '{Selected}' == Rule or '{Selected}' == \"*\"\r\n| extend RuleSet_V = strcat(ruleSetType_s, \" \", ruleSetVersion_s)\r\n| where Rule == Child or Child == \"*\"\r\n| extend RuleGroup = ruleGroup_s, InstandUri = instanceId_s, RequestUri = requestUri_s, RuleSetType = ruleSetType_s, Message_Details = details_message_s, Data_Details = details_data_s, File_Details = details_file_s, Hostname = hostname_s\r\n| project TrackingID, TimeGenerated, ruleId_s,Rule,RuleSet_V, ClientIP, RuleGroup, ResourceId, InstandUri, RequestUri, RuleSetType, Action, Message_Details, File_Details, Data_Details, Hostname, Category",
                    "size": 0,
                    "showAnalytics": true,
                    "title": " Rule for Tracking ID",
                    "noDataMessage": "No data found –try to expand the detection time range to include more events",
                    "timeContextFromParameter": "detectionTime",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.network/applicationgateways",
                    "crossComponentResources": [
                      "{Associations}"
                    ],
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "InstandUri",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "RuleSetType",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "File_Details",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "Data_Details",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "Category",
                          "formatter": 5
                        }
                      ],
                      "rowLimit": 50,
                      "filter": true,
                      "labelSettings": [
                        {
                          "columnId": "TrackingID",
                          "label": "Tracking Id"
                        },
                        {
                          "columnId": "TimeGenerated",
                          "label": "Time Generated"
                        },
                        {
                          "columnId": "ruleId_s",
                          "label": "Rule Id"
                        },
                        {
                          "columnId": "RuleSet_V",
                          "label": "Ruleset Version"
                        },
                        {
                          "columnId": "ClientIP",
                          "label": "Client IP"
                        },
                        {
                          "columnId": "RuleGroup",
                          "label": "Rule Group"
                        },
                        {
                          "columnId": "ResourceId",
                          "label": "AppGW"
                        },
                        {
                          "columnId": "RequestUri",
                          "label": "Request URI"
                        },
                        {
                          "columnId": "Message_Details",
                          "label": "Message Details"
                        }
                      ]
                    }
                  },
                  "customWidth": "80",
                  "name": "query - 13"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let SelectedMS = dynamic({MessageFilter}); // reference to the above list of messages (Event trigger)\r\nlet Child = SelectedMS.Rule; // Used to choose a group of messages - redirects to the message which was grouped\r\nlet FakeData = (datatable (Message:string, ruleName_s:string, clientIp_s:string, clientIP_s:string, action_s:string, transactionId_s:string,trackingReference_s:string) [ \"\", \"\", \"\", \"\", \"\", \"\", \"\" ]);\r\nFakeData | union AzureDiagnostics\r\n| where '{RequestURI}' == requestUri_s or '{RequestURI}' == \"*\"\r\n| where OperationName == \"ApplicationGatewayFirewall\" \r\n| extend Rule = strcat(ruleName_s, Message), ClientIP = strcat(clientIp_s, clientIP_s)\r\n| extend Action = iif(action_s == \"Blocked\", Action = \"Block\", action_s)\r\n| extend Action = iif(Action == \"Detected\", Action = \"Log\", Action)\r\n| extend TrackingID = strcat(transactionId_s, trackingReference_s)\r\n| where '{SelectedTrackingID}' == TrackingID or '{SelectedTrackingID}' == \"*\" \r\n| where Rule == Child or Child == \"*\"\r\n| where '{SelectedAction}' == Action or '{SelectedAction}' == \"*\"\r\n| where '{Selected}' == Rule or '{Selected}' == \"*\"\r\n| summarize count() by ClientIP\r\n| top 10 by count_ desc",
                    "size": 0,
                    "showAnalytics": true,
                    "title": "Top 10 source IPs (select to filter)",
                    "noDataMessage": "No data found –try to expand the detection time range to include more events",
                    "timeContextFromParameter": "detectionTime",
                    "exportFieldName": "x",
                    "exportParameterName": "ClientIP",
                    "exportDefaultValue": "*",
                    "showExportToExcel": true,
                    "exportToExcelOptions": "all",
                    "queryType": 0,
                    "resourceType": "microsoft.network/applicationgateways",
                    "crossComponentResources": [
                      "{Associations}"
                    ],
                    "visualization": "barchart",
                    "tileSettings": {
                      "showBorder": false,
                      "titleContent": {
                        "columnMatch": "ClientIP",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "count_",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "auto"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "maximumSignificantDigits": 3,
                            "maximumFractionDigits": 2
                          }
                        }
                      }
                    },
                    "graphSettings": {
                      "type": 0,
                      "topContent": {
                        "columnMatch": "ClientIP",
                        "formatter": 1
                      },
                      "centerContent": {
                        "columnMatch": "count_",
                        "formatter": 1,
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "maximumSignificantDigits": 3,
                            "maximumFractionDigits": 2
                          }
                        }
                      }
                    },
                    "chartSettings": {
                      "showLegend": true
                    },
                    "mapSettings": {
                      "locInfo": "LatLong",
                      "sizeSettings": "count_",
                      "sizeAggregation": "Sum",
                      "legendMetric": "count_",
                      "legendAggregation": "Sum",
                      "itemColorSettings": {
                        "type": "heatmap",
                        "colorAggregation": "Sum",
                        "nodeColorField": "count_",
                        "heatmapPalette": "greenRed"
                      }
                    }
                  },
                  "customWidth": "25",
                  "name": "query - 12"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let SelectedMS = dynamic({MessageFilter}); // reference to the above list of messages (Event trigger)\r\nlet Child = SelectedMS.Rule; // Used to choose a group of messages - redirects to the message which was grouped\r\nlet FakeData = (datatable (Message:string,ruleName_s:string,clientIp_s:string,clientIP_s:string,action_s:string,transactionId_s:string,site_s:string,details_message_sRole:string,details_file_sRole:string,hostname_sRole:string,Role:string,trackingReference_s:string,ruleGroup_s:string,instanceId_s:string,ruleSetType_s:string,details_message_s:string,details_data_s:string,details_file_s:string,hostname_s:string,requestUri_s:string,ruleId_s:string,ruleSetVersion_s:string,ResourceId:string) [\"\",\"\",\"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\",\"\", \"\", \"\", \"\", \"\",\"\",\"\",\"\",\"\",\"\",\"\" ]);\r\nFakeData | union AzureDiagnostics\r\n| where OperationName == \"ApplicationGatewayFirewall\" \r\n| where '{RequestURI}' == requestUri_s or '{RequestURI}' == \"*\"\r\n| extend Rule = strcat(ruleName_s, Message), ClientIP = strcat(clientIp_s, clientIP_s)\r\n| where Rule == Child or Child == \"*\"\r\n| extend Action = iif(action_s == \"Blocked\", Action = \"Block\", action_s)\r\n| extend Action = iif(Action == \"Detected\", Action = \"Log\", Action)\r\n| extend TrackingID = strcat(transactionId_s, trackingReference_s)\r\n| where '{SelectedTrackingID}' == TrackingID or '{SelectedTrackingID}' == \"*\" \r\n| where '{SelectedAction}' == Action or '{SelectedAction}' == \"*\" \r\n| where '{Selected}' == Rule or '{Selected}' == \"*\"\r\n| extend RuleSet_V = strcat(ruleSetType_s, \" \", ruleSetVersion_s )\r\n| where ('{ClientIP}' == ClientIP or '{ClientIP}' == \"*\")\r\n| extend RuleGroup = ruleGroup_s, InstandUri = instanceId_s, RequestUri = requestUri_s, RuleSetType = ruleSetType_s, Message_Details = details_message_s, Data_Details = details_data_s, File_Details = details_file_s, Hostname = hostname_s\r\n| project TimeGenerated, ruleId_s, Rule,RuleSet_V, ClientIP, RuleGroup,ResourceId, InstandUri, RequestUri, RuleSetType, Action, Message_Details, File_Details, Data_Details, Hostname, Category",
                    "size": 0,
                    "title": " Requests (from selected IP)",
                    "noDataMessage": "No data found –try to expand the detection time range to include more events",
                    "timeContextFromParameter": "detectionTime",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.network/applicationgateways",
                    "crossComponentResources": [
                      "{Associations}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "InstandUri",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "RuleSetType",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "File_Details",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "Data_Details",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "Category",
                          "formatter": 5
                        }
                      ],
                      "filter": true,
                      "labelSettings": [
                        {
                          "columnId": "TimeGenerated",
                          "label": "Time Generated "
                        },
                        {
                          "columnId": "ruleId_s",
                          "label": "Rule Id"
                        },
                        {
                          "columnId": "RuleSet_V",
                          "label": "Ruleset Version"
                        },
                        {
                          "columnId": "ClientIP",
                          "label": "Client IP"
                        },
                        {
                          "columnId": "RuleGroup",
                          "label": "Rule Group"
                        },
                        {
                          "columnId": "ResourceId",
                          "label": "AppGW"
                        },
                        {
                          "columnId": "RequestUri",
                          "label": "Request URI"
                        },
                        {
                          "columnId": "Message_Details",
                          "label": "Message Details"
                        }
                      ]
                    }
                  },
                  "customWidth": "75",
                  "showPin": true,
                  "name": "query - 13"
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "MonitorSelectedTab",
              "comparison": "isEqualTo",
              "value": "WAFLogsTab"
            },
            "name": "WAF Logs"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 10,
                  "content": {
                    "chartId": "workbookc21108a5-6fd3-403e-aafd-d8b6eb53bae8",
                    "version": "MetricsItem/2.0",
                    "size": 0,
                    "chartType": 2,
                    "resourceType": "microsoft.network/applicationgateways",
                    "metricScope": 0,
                    "resourceParameter": "Associations",
                    "resourceIds": [
                      "{Associations}"
                    ],
                    "timeContextFromParameter": "detectionTime",
                    "timeContext": {
                      "durationMs": 259200000
                    },
                    "metrics": [
                      {
                        "namespace": "microsoft.network/applicationgateways",
                        "metric": "microsoft.network/applicationgateways--AzwafTotalRequests",
                        "aggregation": 1
                      }
                    ],
                    "title": "WAF Total Requests ",
                    "gridSettings": {
                      "rowLimit": 10000
                    }
                  },
                  "name": "WAF Total Requests per association"
                },
                {
                  "type": 10,
                  "content": {
                    "chartId": "workbook52eb8d72-7af5-4c4f-8e72-434507e3a051",
                    "version": "MetricsItem/2.0",
                    "size": 0,
                    "chartType": 2,
                    "resourceType": "microsoft.network/applicationgateways",
                    "metricScope": 0,
                    "resourceParameter": "Associations",
                    "resourceIds": [
                      "{Associations}"
                    ],
                    "timeContextFromParameter": "detectionTime",
                    "timeContext": {
                      "durationMs": 259200000
                    },
                    "metrics": [
                      {
                        "namespace": "microsoft.network/applicationgateways",
                        "metric": "microsoft.network/applicationgateways--AzwafSecRule",
                        "aggregation": 1
                      }
                    ],
                    "title": "WAF Total Managed Rule Matches by associations ",
                    "gridSettings": {
                      "rowLimit": 10000
                    }
                  },
                  "customWidth": "100",
                  "name": "WAF Total Managed Rule Matches by associations "
                },
                {
                  "type": 10,
                  "content": {
                    "chartId": "workbook52eb8d72-7af5-4c4f-8e72-434507e3a051",
                    "version": "MetricsItem/2.0",
                    "size": 0,
                    "chartType": 2,
                    "resourceType": "microsoft.network/applicationgateways",
                    "metricScope": 0,
                    "resourceParameter": "Associations",
                    "resourceIds": [
                      "{Associations}"
                    ],
                    "timeContextFromParameter": "detectionTime",
                    "timeContext": {
                      "durationMs": 0
                    },
                    "metrics": [
                      {
                        "namespace": "microsoft.network/applicationgateways",
                        "metric": "microsoft.network/applicationgateways--AzwafSecRule",
                        "aggregation": 1,
                        "splitBy": null
                      }
                    ],
                    "title": "WAF Managed Rule Matches by associations - Block ",
                    "filters": [
                      {
                        "id": "1",
                        "key": "Action",
                        "operator": 0,
                        "values": [
                          "Block"
                        ]
                      }
                    ],
                    "gridSettings": {
                      "rowLimit": 10000
                    }
                  },
                  "customWidth": "50",
                  "name": "WAF Managed Rule Matches - RuleGroup - Block"
                },
                {
                  "type": 10,
                  "content": {
                    "chartId": "workbook52eb8d72-7af5-4c4f-8e72-434507e3a051",
                    "version": "MetricsItem/2.0",
                    "size": 0,
                    "chartType": 2,
                    "resourceType": "microsoft.network/applicationgateways",
                    "metricScope": 0,
                    "resourceParameter": "Associations",
                    "resourceIds": [
                      "{Associations}"
                    ],
                    "timeContextFromParameter": "detectionTime",
                    "timeContext": {
                      "durationMs": 0
                    },
                    "metrics": [
                      {
                        "namespace": "microsoft.network/applicationgateways",
                        "metric": "microsoft.network/applicationgateways--AzwafSecRule",
                        "aggregation": 1,
                        "splitBy": null
                      }
                    ],
                    "title": "WAF  Managed Rule Matches by associations - Allow ",
                    "filters": [
                      {
                        "id": "1",
                        "key": "Action",
                        "operator": 0,
                        "values": [
                          "Pass"
                        ]
                      }
                    ],
                    "gridSettings": {
                      "rowLimit": 10000
                    }
                  },
                  "customWidth": "50",
                  "name": "WAF Managed Rule Matches - RuleId - allow "
                },
                {
                  "type": 10,
                  "content": {
                    "chartId": "workbook52eb8d72-7af5-4c4f-8e72-434507e3a051",
                    "version": "MetricsItem/2.0",
                    "size": 0,
                    "chartType": 2,
                    "resourceType": "microsoft.network/applicationgateways",
                    "metricScope": 0,
                    "resourceParameter": "Associations",
                    "resourceIds": [
                      "{Associations}"
                    ],
                    "timeContextFromParameter": "detectionTime",
                    "timeContext": {
                      "durationMs": 259200000
                    },
                    "metrics": [
                      {
                        "namespace": "microsoft.network/applicationgateways",
                        "metric": "microsoft.network/applicationgateways--AzWAFJSChallengeRequestCount",
                        "aggregation": 1
                      }
                    ],
                    "title": "WAF Total JS Challenge Request Count by Association",
                    "gridSettings": {
                      "rowLimit": 10000
                    }
                  },
                  "customWidth": "100",
                  "name": "WAF Managed Rule Matches - RuleId - Allow - Application Gateway"
                },
                {
                  "type": 10,
                  "content": {
                    "chartId": "workbook52eb8d72-7af5-4c4f-8e72-434507e3a051",
                    "version": "MetricsItem/2.0",
                    "size": 0,
                    "chartType": 2,
                    "resourceType": "microsoft.network/applicationgateways",
                    "metricScope": 0,
                    "resourceParameter": "Associations",
                    "resourceIds": [
                      "{Associations}"
                    ],
                    "timeContextFromParameter": "detectionTime",
                    "timeContext": {
                      "durationMs": 259200000
                    },
                    "metrics": [
                      {
                        "namespace": "microsoft.network/applicationgateways",
                        "metric": "microsoft.network/applicationgateways--AzWAFJSChallengeRequestCount",
                        "aggregation": 1
                      }
                    ],
                    "title": "WAF JS Challenge Request Count by Association - Block",
                    "mapSettings": {
                      "locInfo": "AzureResource",
                      "sizeSettings": "US/WAF Managed Rule Matches",
                      "sizeAggregation": "Sum",
                      "legendMetric": "US/WAF Managed Rule Matches",
                      "legendAggregation": "Sum",
                      "itemColorSettings": {
                        "type": "heatmap",
                        "colorAggregation": "Sum",
                        "nodeColorField": "US/WAF Managed Rule Matches",
                        "heatmapPalette": "greenRed"
                      },
                      "locInfoColumn": "Name"
                    },
                    "graphSettings": {
                      "type": 0,
                      "topContent": {
                        "columnMatch": "Subscription",
                        "formatter": 1
                      },
                      "centerContent": {
                        "columnMatch": "microsoft.network/applicationgateways--AzwafSecRule",
                        "formatter": 1,
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "maximumSignificantDigits": 3,
                            "maximumFractionDigits": 2
                          }
                        }
                      }
                    },
                    "filters": [
                      {
                        "id": "1",
                        "key": "Action",
                        "operator": 0,
                        "values": [
                          "Block"
                        ]
                      }
                    ],
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Subscription",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "Name",
                          "formatter": 13,
                          "formatOptions": {
                            "linkTarget": "Resource"
                          }
                        },
                        {
                          "columnMatch": "microsoft.network/applicationgateways--AzwafSecRule Timeline",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "microsoft.network/applicationgateways--AzwafSecRule",
                          "formatter": 1,
                          "numberFormat": {
                            "unit": 0,
                            "options": null
                          }
                        }
                      ],
                      "rowLimit": 10000,
                      "labelSettings": [
                        {
                          "columnId": "microsoft.network/applicationgateways--AzwafSecRule",
                          "label": "WAF Managed Rule Matches (Sum)"
                        },
                        {
                          "columnId": "microsoft.network/applicationgateways--AzwafSecRule Timeline",
                          "label": "WAF Managed Rule Matches Timeline"
                        }
                      ]
                    }
                  },
                  "customWidth": "50",
                  "name": "WAF Total JS Challenge Request Count by Association - Block"
                },
                {
                  "type": 10,
                  "content": {
                    "chartId": "workbook52eb8d72-7af5-4c4f-8e72-434507e3a051",
                    "version": "MetricsItem/2.0",
                    "size": 0,
                    "chartType": 2,
                    "resourceType": "microsoft.network/applicationgateways",
                    "metricScope": 0,
                    "resourceParameter": "Associations",
                    "resourceIds": [
                      "{Associations}"
                    ],
                    "timeContextFromParameter": "detectionTime",
                    "timeContext": {
                      "durationMs": 259200000
                    },
                    "metrics": [
                      {
                        "namespace": "microsoft.network/applicationgateways",
                        "metric": "microsoft.network/applicationgateways--AzWAFJSChallengeRequestCount",
                        "aggregation": 1
                      }
                    ],
                    "title": "WAF JS Challenge Request Count by Association - Allow",
                    "filters": [
                      {
                        "id": "1",
                        "key": "Action",
                        "operator": 0,
                        "values": [
                          "Pass"
                        ]
                      }
                    ],
                    "gridSettings": {
                      "rowLimit": 10000
                    }
                  },
                  "customWidth": "50",
                  "name": "WAF Managed Rule Matches - GeoLocation - Allow"
                },
                {
                  "type": 10,
                  "content": {
                    "chartId": "workbook52eb8d72-7af5-4c4f-8e72-434507e3a051",
                    "version": "MetricsItem/2.0",
                    "size": 0,
                    "chartType": 2,
                    "resourceType": "microsoft.network/applicationgateways",
                    "metricScope": 0,
                    "resourceParameter": "Associations",
                    "resourceIds": [
                      "{Associations}"
                    ],
                    "timeContextFromParameter": "detectionTime",
                    "timeContext": {
                      "durationMs": 259200000
                    },
                    "metrics": [
                      {
                        "namespace": "microsoft.network/applicationgateways",
                        "metric": "microsoft.network/applicationgateways--AzwafCustomRule",
                        "aggregation": 1
                      }
                    ],
                    "title": "WAF Custom Rules total Matches by Association",
                    "gridSettings": {
                      "rowLimit": 10000
                    }
                  },
                  "customWidth": "100",
                  "name": "WAF Custom Rules Matches -RuleName - Block/Pass - ApplicationGateway"
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "MonitorSelectedTab",
              "comparison": "isEqualTo",
              "value": "WAFMetricsTab"
            },
            "name": "WAF metrics"
          }
        ],
        "exportParameters": true
      },
      "conditionalVisibility": {
        "parameterName": "SelectedTab",
        "comparison": "isEqualTo",
        "value": "monitor-tab"
      },
      "name": "Monitor Page"
    }
  ],
}
