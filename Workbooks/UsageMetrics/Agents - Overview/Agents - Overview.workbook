{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "9fa0e610-5688-4a8a-9c88-b9ea5a56620f",
            "version": "KqlParameterItem/1.0",
            "name": "ResourceId",
            "type": 5,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false,
              "componentIdOnly": true
            }
          },
          {
            "id": "12b13c6f-6c2b-44af-b712-cee14c0fb12a",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "label": "Time range",
            "type": 4,
            "isRequired": true,
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 300000
                },
                {
                  "durationMs": 900000
                },
                {
                  "durationMs": 1800000
                },
                {
                  "durationMs": 3600000
                },
                {
                  "durationMs": 14400000
                },
                {
                  "durationMs": 43200000
                },
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 172800000
                },
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 1209600000
                },
                {
                  "durationMs": 2419200000
                },
                {
                  "durationMs": 2592000000
                },
                {
                  "durationMs": 5184000000
                },
                {
                  "durationMs": 7776000000
                }
              ]
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "value": {
              "durationMs": 7776000000
            }
          },
          {
            "id": "58b2fbee-3304-4075-bbe1-531e9f1c2ae3",
            "version": "KqlParameterItem/1.0",
            "name": "SelectedAgent",
            "label": "Agent",
            "type": 2,
            "isRequired": true,
            "query": "dependencies\r\n| where customDimensions[\"gen_ai.operation.name\"] == \"invoke_agent\"\r\n| extend AgentName = tostring(customDimensions[\"gen_ai.agent.name\"])\r\n| where isnotempty(AgentName)\r\n| distinct AgentName\r\n| extend priority=0, DisplayName=AgentName\r\n| union (print AgentName = \"__ALL__\", DisplayName = \"All agents\", priority = 1)\r\n| order by priority, DisplayName\r\n| project value=AgentName, displayName=DisplayName",
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "queryType": 0,
            "resourceType": "microsoft.insights/components",
            "value": "__ALL__"
          },
          {
            "id": "f42a57f8-69fa-4835-bdd2-cb26871a1eb3",
            "version": "KqlParameterItem/1.0",
            "name": "DetectionContent",
            "type": 1,
            "query": "let agents = dependencies\r\n| where customDimensions[\"gen_ai.operation.name\"] == \"invoke_agent\"\r\n| extend AgentName = tostring(customDimensions[\"gen_ai.agent.name\"]);\r\nlet tools = dependencies\r\n| extend Operation = tostring(customDimensions[\"gen_ai.operation.name\"])\r\n| where isnotempty(Operation)\r\n| where Operation == \"execute_tool\"\r\n| lookup kind=leftouter (agents) on $left.operation_ParentId == $right.id\r\n| where \"{SelectedAgent}\" == \"__ALL__\" or \"{SelectedAgent}\" == AgentName\r\n| extend Tool = tostring(customDimensions[\"gen_ai.tool.name\"])\r\n| extend Description = tostring(customDimensions[\"gen_ai.tool.description\"]);\r\ntools\r\n| where success == false\r\n| project timestamp, Tool\r\n| evaluate autocluster()\r\n| where Percent > 60\r\n| order by Percent desc\r\n| take 1\r\n| project Detection = strcat(toint(Percent), \"% of tool failures were on calls to '\", Tool, \"'\")",
            "isHiddenWhenLocked": true,
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 0,
            "resourceType": "microsoft.insights/components"
          },
          {
            "id": "74747891-f8e5-4e44-897e-c00836791635",
            "version": "KqlParameterItem/1.0",
            "name": "AgentRunsSearchParameters",
            "type": 1,
            "isHiddenWhenLocked": true,
            "criteriaData": [
              {
                "criteriaContext": {
                  "leftOperand": "SelectedAgent",
                  "operator": "!=",
                  "rightValType": "static",
                  "rightVal": "__ALL__",
                  "resultValType": "static",
                  "resultVal": "{   \"ResourceId\": \"{ResourceId:id}\", \"HideChart\": true,\"IsGenAiFlow\": true,\r\n   \"FilterSpec\": {     \"originalParams\": {       \"eventTypes\": [         {           \"value\": \"dependency\",           \"tableName\": \"dependencies\",           \"label\": \"Dependency\"         }       ],       \"timeContext\": {         \"durationMs\": \"{TimeRange:seconds}000\",         \"endTime\": \"{TimeRange:endISO}\",         \"createdTime\": \"{TimeRange:startISO}\",         \"isInitialTime\": false,         \"grain\": 1,         \"useDashboardTimeRange\": false       },       \"filter\": [         {           \"dimension\": {             \"name\": \"customDimensions/gen_ai.operation.name\",             \"draftKey\": \"customDimensions/gen_ai.operation.name\",             \"displayName\": \"GenAI Operation\",             \"tables\": [               \"dependencies\"             ]           },           \"values\": [             \"invoke_agent\"           ]         },         {           \"dimension\": {             \"name\": \"customDimensions/gen_ai.agent.name\",             \"draftKey\": \"customDimensions/gen_ai.agent.name\",             \"displayName\": \"Agent name\",             \"tables\": [               \"dependencies\"             ]           },           \"values\": [             \"{SelectedAgent}\"           ]         }       ],       \"searchPhrase\": {         \"originalPhrase\": \"\"       }     }   } }"
                }
              },
              {
                "criteriaContext": {
                  "operator": "Default",
                  "resultValType": "static",
                  "resultVal": "{   \"ResourceId\": \"{ResourceId:id}\", \"HideChart\": true,\"IsGenAiFlow\": true,\r\n   \"FilterSpec\": {     \"originalParams\": {       \"eventTypes\": [         {           \"value\": \"dependency\",           \"tableName\": \"dependencies\",           \"label\": \"Dependency\"         }       ],       \"timeContext\": {         \"durationMs\": \"{TimeRange:seconds}000\",         \"endTime\": \"{TimeRange:endISO}\",         \"createdTime\": \"{TimeRange:startISO}\",         \"isInitialTime\": false,         \"grain\": 1,         \"useDashboardTimeRange\": false       },       \"filter\": [         {           \"dimension\": {             \"name\": \"customDimensions/gen_ai.operation.name\",             \"draftKey\": \"customDimensions/gen_ai.operation.name\",             \"displayName\": \"GenAI Operation\",             \"tables\": [               \"dependencies\"             ]           },           \"values\": [             \"invoke_agent\"           ]         }       ],       \"searchPhrase\": {         \"originalPhrase\": \"\"       }     }   } }"
                }
              }
            ]
          },
          {
            "id": "72d7706a-f935-4976-b38c-a3bdcda1bae4",
            "version": "KqlParameterItem/1.0",
            "name": "AgentRunsFailuresParameters",
            "type": 1,
            "isHiddenWhenLocked": true,
            "criteriaData": [
              {
                "criteriaContext": {
                  "leftOperand": "SelectedAgent",
                  "operator": "!=",
                  "rightValType": "static",
                  "rightVal": "__ALL__",
                  "resultValType": "static",
                  "resultVal": "{   \"ResourceId\": \"{ResourceId:id}\", \"HideChart\": true,\"IsGenAiFlow\": true,\r\n   \"FilterSpec\": {     \"originalParams\": {       \"eventTypes\": [         {           \"value\": \"dependency\",           \"tableName\": \"dependencies\",           \"label\": \"Dependency\"         }       ],       \"timeContext\": {         \"durationMs\": \"{TimeRange:seconds}000\",         \"endTime\": \"{TimeRange:endISO}\",         \"createdTime\": \"{TimeRange:startISO}\",         \"isInitialTime\": false,         \"grain\": 1,         \"useDashboardTimeRange\": false       },       \"filter\": [          {             \"dimension\": {                 \"displayName\": \"Dependency call status\",                 \"tables\": [                     \"dependencies\"                 ],                 \"name\": \"dependency/success\",                 \"draftKey\": \"dependency/success\"             },             \"values\": [                 \"False\"             ],             \"operator\": {                 \"label\": \"=\",                 \"value\": \"==\",                 \"isSelected\": true             }         },         {           \"dimension\": {             \"name\": \"customDimensions/gen_ai.operation.name\",             \"draftKey\": \"customDimensions/gen_ai.operation.name\",             \"displayName\": \"GenAI Operation\",             \"tables\": [               \"dependencies\"             ]           },           \"values\": [             \"invoke_agent\",             \"execute_tool\",             \"chat.completions\",             \"text_completions\",             \"generate_content\"           ]         },         {           \"dimension\": {             \"name\": \"customDimensions/gen_ai.agent.name\",             \"draftKey\": \"customDimensions/gen_ai.agent.name\",             \"displayName\": \"Agent Name\",             \"tables\": [               \"dependencies\"             ]           },           \"values\": [             \"{SelectedAgent}\"           ]         }       ],       \"searchPhrase\": {         \"originalPhrase\": \"\"       }     }   } }"
                }
              },
              {
                "criteriaContext": {
                  "operator": "Default",
                  "resultValType": "static",
                  "resultVal": "{   \"ResourceId\": \"{ResourceId:id}\", \"HideChart\": true,\"IsGenAiFlow\": true,\r\n   \"FilterSpec\": {     \"originalParams\": {       \"eventTypes\": [         {           \"value\": \"dependency\",           \"tableName\": \"dependencies\",           \"label\": \"Dependency\"         }       ],       \"timeContext\": {         \"durationMs\": \"{TimeRange:seconds}000\",         \"endTime\": \"{TimeRange:endISO}\",         \"createdTime\": \"{TimeRange:startISO}\",         \"isInitialTime\": false,         \"grain\": 1,         \"useDashboardTimeRange\": false       },       \"filter\": [          {             \"dimension\": {                 \"displayName\": \"Dependency call status\",                 \"tables\": [                     \"dependencies\"                 ],                 \"name\": \"dependency/success\",                 \"draftKey\": \"dependency/success\"             },             \"values\": [                 \"False\"             ],             \"operator\": {                 \"label\": \"=\",                 \"value\": \"==\",                 \"isSelected\": true             }         },         {           \"dimension\": {             \"name\": \"customDimensions/gen_ai.operation.name\",             \"draftKey\": \"customDimensions/gen_ai.operation.name\",             \"displayName\": \"GenAI Operation\",             \"tables\": [               \"dependencies\"             ]           },           \"values\": [             \"invoke_agent\",             \"execute_tool\",             \"chat.completions\",             \"text_completions\",             \"generate_content\"           ]         }       ],       \"searchPhrase\": {         \"originalPhrase\": \"\"       }     }   } }"
                }
              }
            ]
          },
          {
            "id": "6443cb30-3c7a-484c-9d83-0a7799348b32",
            "version": "KqlParameterItem/1.0",
            "name": "GenAIDataCheck",
            "type": 1,
            "query": "dependencies\r\n| where isnotempty(customDimensions[\"gen_ai.operation.name\"])\r\n| summarize count()\r\n| project DataCheck = iff(count_ > 0, \"OK\", \"NotFound\")",
            "isHiddenWhenLocked": true,
            "timeContext": {
              "durationMs": 86400000
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 0,
            "resourceType": "microsoft.insights/components"
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "customWidth": "0",
      "name": "parameters - 1",
      "styleSettings": {
        "margin": "0 0 20px 0"
      }
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "toolbar",
        "links": [
          {
            "id": "5f2be271-52c3-429c-aa3b-75ecba2c6ba9",
            "linkTarget": "OpenBlade",
            "linkLabel": "Explore in Grafana",
            "style": "primary",
            "icon": "Diagnostics",
            "bladeOpenContext": {
              "bladeName": "AzureGrafana.ReactView",
              "extensionName": "Microsoft_Azure_PinToGrafana",
              "bladeJsonParameters": "{\n  \"GalleryType\": \"microsoft.insights/components\",\n  \"ResourceId\": \"{ResourceId:Id}\",\n  \"ConfigurationId\": \"AgentFramework\"\n}"
            }
          }
        ]
      },
      "name": "HeaderLinks",
      "styleSettings": {
        "padding": "5px 0 0 0",
        "maxWidth": "250px"
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<div style=\"text-align:center;padding: 0 40px;\">\r\n   <h1>Get started with monitoring AI agents</h1>\r\n   <p>Get insights into your agent usage, tool calls, and token consumption by monitoring your Generative AI applications with Azure Monitor.</p>\r\n   <a href=\"https://aka.ms/app-insights/agents-getstarted\" target=\"_blank\">Learn how to get started</a>\r\n</div>\r\n<div style=\"text-align:center;margin-top:80px\">\r\n   Already set up?<br/>There may be no recent activity. Select a different time range at the top of the page.\r\n</div>"
            },
            "name": "NotFoundText"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "GenAIDataCheck",
        "comparison": "isEqualTo",
        "value": "NotFound"
      },
      "name": "NoDataGroup",
      "styleSettings": {
        "margin": "20px 0"
      }
    },
    {
      "type": 1,
      "content": {
        "json": "### Insight Found\r\n#### {DetectionContent}",
        "style": "info"
      },
      "conditionalVisibility": {
        "parameterName": "DetectionContent",
        "comparison": "isNotEqualTo"
      },
      "name": "InsightDetection",
      "styleSettings": {
        "margin": "20px 0"
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let agents = dependencies\r\n| where customDimensions[\"gen_ai.operation.name\"] == \"invoke_agent\"\r\n| extend AgentName = tostring(customDimensions[\"gen_ai.agent.name\"])\r\n| where \"{SelectedAgent}\" == \"__ALL__\" or \"{SelectedAgent}\" == AgentName;\r\nlet models = dependencies\r\n| extend Model = tostring(customDimensions[\"gen_ai.request.model\"])\r\n| where isnotempty(Model)\r\n| lookup kind=leftouter (agents) on $left.operation_ParentId == $right.id\r\n| where \"{SelectedAgent}\" == \"__ALL__\" or \"{SelectedAgent}\" == AgentName;\r\nlet agentCalls = dependencies\r\n| lookup kind=inner (agents) on $left.operation_ParentId == $right.id;\r\nlet alertsTile = arg(\"\").AlertsManagementResources \r\n| where type =~ 'microsoft.alertsmanagement/alerts'\r\n| where todatetime(properties.essentials.startDateTime) {TimeRange}  \r\n| where properties.essentials.targetResource =~ {ResourceId}\r\n| extend Severity=tostring(properties.essentials.severity)\r\n| extend Condition = tostring(properties.essentials.monitorCondition)\r\n| where Condition != \"Resolved\"\r\n| summarize AlertValue=count(), Text=\"Alerts\", Name=\"Total fired alerts\", Resource={ResourceId}, Order=0, LinkText = \"View alerts\";\r\nlet operationalTile= union agents, agentCalls\r\n| extend ErrorType = tostring(customDimensions[\"error.type\"])\r\n| extend ErrorType = iff(success == false and isempty(ErrorType), \"Other\", ErrorType)\r\n| where isnotempty(ErrorType)\r\n| extend OperationName = tostring(customDimensions[\"gen_ai.operation.name\"])\r\n| extend ErrorType = strcat(OperationName, \": \", ErrorType)\r\n| extend AgentName = iff(isempty(AgentName), \"Unknown\", AgentName)\r\n| summarize sum(itemCount) by AgentName\r\n//| extend AgentName = strcat(AgentName, \" (\", sum_itemCount, \")\")\r\n| union (print AgentName = \"No errors\", sum_itemCount = 0)\r\n| order by sum_itemCount desc\r\n| take 1\r\n| project Value=sum_itemCount,Name=AgentName,Title=\"Operational\",Text=\"Agent with highest errors\",Order = 1;\r\nlet tokensTile = models\r\n| extend InputTokens = toint(customDimensions[\"gen_ai.usage.input_tokens\"]), OutputTokens = toint(customDimensions[\"gen_ai.usage.output_tokens\"])\r\n| where InputTokens > 0 or OutputTokens > 0\r\n| extend TokenConsumption = InputTokens + OutputTokens\r\n| summarize Count=sum(TokenConsumption * itemCount) by Model\r\n//| extend Model = strcat(Model, \" (\", sum_itemCount, \")\")\r\n| union (print Model = \"No usage\", Count = 0)\r\n| order by Count desc\r\n| take 1\r\n| project Value = Count, Name = Model, Title=\"Token Use\", Text=\"Model with highest token usage\", Order = 2;\r\nunion alertsTile, operationalTile, tokensTile\r\n| sort by Order asc",
        "size": 4,
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "tiles",
        "tileSettings": {
          "titleContent": {
            "columnMatch": "Text",
            "formatter": 1
          },
          "subtitleContent": {
            "columnMatch": "Name",
            "formatter": 1
          },
          "leftContent": {
            "columnMatch": "AlertValue",
            "formatter": 18,
            "formatOptions": {
              "linkColumn": "Resource",
              "linkTarget": "Resource",
              "subTarget": "alertsV2",
              "thresholdsOptions": "icons",
              "thresholdsGrid": [
                {
                  "sourceColumn": "Text",
                  "operator": "==",
                  "thresholdValue": "Alerts",
                  "representation": "Alert",
                  "text": "{0}{1}"
                },
                {
                  "operator": "Default",
                  "thresholdValue": null,
                  "text": ""
                }
              ]
            },
            "numberFormat": {
              "unit": 17,
              "options": {
                "style": "decimal",
                "useGrouping": true,
                "maximumFractionDigits": 2
              }
            },
            "tooltipFormat": {
              "tooltip": "View Alerts"
            }
          },
          "rightContent": {
            "columnMatch": "Value",
            "formatter": 2,
            "numberFormat": {
              "unit": 17,
              "options": {
                "style": "decimal",
                "useGrouping": true,
                "maximumFractionDigits": 2
              }
            }
          },
          "showBorder": true,
          "size": "auto",
          "styleSettings": {
            "borderStyle": "rounded",
            "backgroundColor": "colorGray100"
          }
        }
      },
      "conditionalVisibility": {
        "parameterName": "GenAIDataCheck",
        "comparison": "isEqualTo",
        "value": "OK"
      },
      "name": "summaryTiles"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Agent Operational Metrics",
        "expandable": true,
        "expanded": true,
        "items": [
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "#### Agent Runs"
                  },
                  "customWidth": "0",
                  "name": "AgentRunsTitle",
                  "styleSettings": {
                    "margin": "0 0 10px 0"
                  }
                },
                {
                  "type": 11,
                  "content": {
                    "version": "LinkItem/1.0",
                    "style": "paragraph",
                    "links": [
                      {
                        "id": "c5ffd7d4-b91a-4c14-beb5-e188617da692",
                        "cellValue": "",
                        "linkTarget": "OpenBlade",
                        "linkLabel": "View Traces with Agent Runs",
                        "preText": "",
                        "style": "secondary",
                        "linkIsContextBlade": true,
                        "bladeOpenContext": {
                          "bladeName": "SearchV2Blade",
                          "extensionName": "AppInsightsExtension",
                          "bladeJsonParameters": "{AgentRunsSearchParameters}"
                        }
                      }
                    ]
                  },
                  "customWidth": "0",
                  "name": "AgentRunsOpenBlade",
                  "styleSettings": {
                    "margin": "0 0 10px 10px"
                  }
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "dependencies\r\n| where customDimensions[\"gen_ai.operation.name\"] == \"invoke_agent\"\r\n| extend AgentName = tostring(customDimensions[\"gen_ai.agent.name\"])\r\n| where \"{SelectedAgent}\" == \"__ALL__\" or \"{SelectedAgent}\" == AgentName\r\n| make-series Invocations=sum(itemCount) default=0 on timestamp from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by AgentName\r\n| render timechart",
                    "size": 1,
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.insights/components"
                  },
                  "name": "AgentRunsQuery"
                }
              ]
            },
            "customWidth": "50",
            "name": "AgentRunsGroup",
            "styleSettings": {
              "margin": "10px 10px 0 10px",
              "padding": "10px 10px 0 10px",
              "showBorder": true
            }
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "#### Gen AI Errors"
                  },
                  "customWidth": "0",
                  "name": "GenAIErrorsTitle",
                  "styleSettings": {
                    "margin": "0 0 10px 0"
                  }
                },
                {
                  "type": 11,
                  "content": {
                    "version": "LinkItem/1.0",
                    "style": "paragraph",
                    "links": [
                      {
                        "id": "d88d8e21-14cf-48ea-896c-90c47f9b6ba6",
                        "cellValue": "todo",
                        "linkTarget": "OpenBlade",
                        "linkLabel": "View Traces with GenAI Errors",
                        "preText": "",
                        "style": "secondary",
                        "linkIsContextBlade": true,
                        "bladeOpenContext": {
                          "bladeName": "SearchV2Blade",
                          "extensionName": "AppInsightsExtension",
                          "bladeJsonParameters": "{AgentRunsFailuresParameters}"
                        }
                      }
                    ]
                  },
                  "customWidth": "0",
                  "name": "GenAIErrorsOpenBlade",
                  "styleSettings": {
                    "margin": "0 0 10px 10px"
                  }
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let agents = dependencies\r\n| where customDimensions[\"gen_ai.operation.name\"] == \"invoke_agent\"\r\n| extend AgentName = tostring(customDimensions[\"gen_ai.agent.name\"])\r\n| where \"{SelectedAgent}\" == \"__ALL__\" or \"{SelectedAgent}\" == AgentName;\r\nlet agentCalls = dependencies\r\n| lookup kind=inner (agents) on $left.operation_ParentId == $right.id;\r\nunion agents, agentCalls\r\n| extend ErrorType = tostring(customDimensions[\"error.type\"])\r\n| extend ErrorType = iff(success == false and isempty(ErrorType), \"Other\", ErrorType)\r\n| where isnotempty(ErrorType)\r\n| extend OperationName = tostring(customDimensions[\"gen_ai.operation.name\"])\r\n| extend ErrorType = strcat(OperationName, \": \", ErrorType)\r\n| make-series Errors=sumif(itemCount, success==false) default=0 on timestamp from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by ErrorType\r\n",
                    "size": 1,
                    "color": "red",
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.insights/components",
                    "visualization": "barchart",
                    "chartSettings": {
                      "xSettings": {
                        "label": "Time"
                      },
                      "ySettings": {
                        "numberFormatSettings": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "useGrouping": true
                          }
                        }
                      }
                    }
                  },
                  "name": "GenAIErrorsQuery"
                }
              ]
            },
            "customWidth": "50",
            "name": "GenAIErrorsGroup",
            "styleSettings": {
              "margin": "10px 10px 0 10px",
              "padding": "10px 10px 0 10px",
              "showBorder": true
            }
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "#### Tool Calls"
                  },
                  "customWidth": "0",
                  "name": "ToolCallsTitle",
                  "styleSettings": {
                    "margin": "0 0 5px 5px"
                  }
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let agents = dependencies\r\n| where customDimensions[\"gen_ai.operation.name\"] == \"invoke_agent\"\r\n| extend AgentName = tostring(customDimensions[\"gen_ai.agent.name\"]);\r\nlet tools = dependencies\r\n| extend Operation = tostring(customDimensions[\"gen_ai.operation.name\"])\r\n| where isnotempty(Operation)\r\n| where Operation == \"execute_tool\"\r\n| lookup kind=leftouter (agents) on $left.operation_ParentId == $right.id\r\n| where \"{SelectedAgent}\" == \"__ALL__\" or \"{SelectedAgent}\" == AgentName\r\n| extend Tool = tostring(customDimensions[\"gen_ai.tool.name\"])\r\n| extend Description = tostring(customDimensions[\"gen_ai.tool.description\"]);\r\ntools\r\n| make-series DurationTrend=(sum(duration *itemCount)*1.0)/sum(itemCount), ErrorTrend=sumif(itemCount, success == false) default=0 on timestamp from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by Tool\r\n| lookup (tools | summarize Calls=sum(itemCount), Duration=(sum(duration *itemCount)*1.0)/sum(itemCount), Errors=sumif(itemCount, success == false), Description=any(Description) by Tool) on Tool\r\n| project Name=Tool, ErrorTrend, Errors, DurationTrend, Duration, Calls",
                    "size": 1,
                    "aggregation": 3,
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.insights/components",
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Name",
                          "formatter": 7,
                          "formatOptions": {
                            "linkTarget": "OpenBlade",
                            "linkIsContextBlade": true,
                            "bladeOpenContext": {
                              "bladeName": "SearchV2Blade",
                              "extensionName": "AppInsightsExtension",
                              "bladeJsonParameters": "{\r\n  \"ResourceId\": \"{ResourceId:id}\",\r\n\t\"HideChart\": true,\"IsGenAiFlow\": true,\r\n\r\n  \"FilterSpec\": {\r\n    \"originalParams\": {\r\n      \"eventTypes\": [\r\n        {\r\n          \"value\": \"dependency\",\r\n          \"tableName\": \"dependencies\",\r\n          \"label\": \"Dependency\"\r\n        }\r\n      ],\r\n      \"timeContext\": {\r\n        \"durationMs\": \"{TimeRange:seconds}000\",\r\n        \"endTime\": \"{TimeRange:endISO}\",\r\n        \"createdTime\": \"{TimeRange:startISO}\",\r\n        \"isInitialTime\": false,\r\n        \"grain\": 1,\r\n        \"useDashboardTimeRange\": false\r\n      },\r\n      \"filter\": [\r\n        {\r\n          \"dimension\": {\r\n            \"name\": \"customDimensions/gen_ai.tool.name\",\r\n            \"draftKey\": \"customDimensions/gen_ai.tool.name\",\r\n            \"displayName\": \"Tool name\",\r\n            \"tables\": [\r\n              \"dependencies\"\r\n            ]\r\n          },\r\n          \"values\": [\r\n            \"{Name_column}\"\r\n          ]\r\n        }\r\n      ],\r\n      \"searchPhrase\": {\r\n        \"originalPhrase\": \"\"\r\n      }\r\n    }\r\n  }\r\n}"
                            },
                            "customColumnWidthSetting": "10%"
                          }
                        },
                        {
                          "columnMatch": "ErrorTrend",
                          "formatter": 9,
                          "formatOptions": {
                            "palette": "red"
                          }
                        },
                        {
                          "columnMatch": "Errors",
                          "formatter": 1,
                          "formatOptions": {
                            "customColumnWidthSetting": "50px"
                          },
                          "numberFormat": {
                            "unit": 17,
                            "options": {
                              "style": "decimal",
                              "maximumFractionDigits": 2
                            }
                          }
                        },
                        {
                          "columnMatch": "DurationTrend",
                          "formatter": 9,
                          "formatOptions": {
                            "palette": "blue"
                          }
                        },
                        {
                          "columnMatch": "Duration",
                          "formatter": 1,
                          "formatOptions": {
                            "customColumnWidthSetting": "50px"
                          },
                          "numberFormat": {
                            "unit": 23,
                            "options": {
                              "style": "decimal",
                              "maximumFractionDigits": 2
                            }
                          }
                        },
                        {
                          "columnMatch": "Calls",
                          "formatter": 0,
                          "formatOptions": {
                            "customColumnWidthSetting": "65px"
                          },
                          "numberFormat": {
                            "unit": 17,
                            "options": {
                              "style": "decimal",
                              "maximumFractionDigits": 2
                            }
                          }
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "ErrorTrend",
                          "label": "Errors"
                        },
                        {
                          "columnId": "Errors",
                          "label": " ",
                          "comment": ""
                        },
                        {
                          "columnId": "DurationTrend",
                          "label": "Avg. Duration"
                        },
                        {
                          "columnId": "Duration",
                          "label": " "
                        }
                      ]
                    },
                    "chartSettings": {
                      "yAxis": [
                        "avg_duration"
                      ],
                      "xSettings": {
                        "label": "Time"
                      },
                      "ySettings": {
                        "numberFormatSettings": {
                          "unit": 23,
                          "options": {
                            "style": "decimal",
                            "useGrouping": true,
                            "maximumFractionDigits": 1
                          }
                        }
                      }
                    }
                  },
                  "name": "ToolCallsQuery"
                }
              ]
            },
            "customWidth": "50",
            "name": "ToolCallsGroup",
            "styleSettings": {
              "margin": "20px 10px 0 10px",
              "padding": "10px 0 0 5px",
              "showBorder": true
            }
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "#### Models"
                  },
                  "customWidth": "0",
                  "name": "ModelsTitle",
                  "styleSettings": {
                    "margin": "0 0 5px 5px"
                  }
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let agents = dependencies\r\n| where customDimensions[\"gen_ai.operation.name\"] == \"invoke_agent\"\r\n| extend AgentName = tostring(customDimensions[\"gen_ai.agent.name\"]);\r\nlet models = dependencies\r\n| extend Model = tostring(customDimensions[\"gen_ai.request.model\"])\r\n| where isnotempty(Model)\r\n| lookup kind=leftouter (agents) on $left.operation_ParentId == $right.id\r\n| where \"{SelectedAgent}\" == \"__ALL__\" or \"{SelectedAgent}\" == AgentName;\r\nmodels\r\n| make-series DurationTrend=(sum(duration *itemCount)*1.0)/sum(itemCount), ErrorTrend=sumif(itemCount, success == false) default=0 on timestamp from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by Model\r\n| lookup (models | summarize Calls=sum(itemCount), Duration=(sum(duration *itemCount)*1.0)/sum(itemCount), Errors=sumif(itemCount, success == false) by Model) on Model\r\n| project Name=Model, ErrorTrend, Errors, DurationTrend, Duration, Calls",
                    "size": 1,
                    "aggregation": 3,
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.insights/components",
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Name",
                          "formatter": 7,
                          "formatOptions": {
                            "linkTarget": "OpenBlade",
                            "linkIsContextBlade": true,
                            "bladeOpenContext": {
                              "bladeName": "SearchV2Blade",
                              "extensionName": "AppInsightsExtension",
                              "bladeJsonParameters": "{\r\n  \"ResourceId\": \"{ResourceId:id}\",\r\n\t\"HideChart\": true,\"IsGenAiFlow\": true,\r\n\r\n  \"FilterSpec\": {\r\n    \"originalParams\": {\r\n      \"eventTypes\": [\r\n        {\r\n          \"value\": \"dependency\",\r\n          \"tableName\": \"dependencies\",\r\n          \"label\": \"Dependency\"\r\n        }\r\n      ],\r\n      \"timeContext\": {\r\n        \"durationMs\": \"{TimeRange:seconds}000\",\r\n        \"endTime\": \"{TimeRange:endISO}\",\r\n        \"createdTime\": \"{TimeRange:startISO}\",\r\n        \"isInitialTime\": false,\r\n        \"grain\": 1,\r\n        \"useDashboardTimeRange\": false\r\n      },\r\n      \"filter\": [\r\n        {\r\n          \"dimension\": {\r\n            \"name\": \"customDimensions/gen_ai.request.model\",\r\n            \"draftKey\": \"customDimensions/gen_ai.request.model\",\r\n            \"displayName\": \"Model name\",\r\n            \"tables\": [\r\n              \"dependencies\"\r\n            ]\r\n          },\r\n          \"values\": [\r\n            \"{Name_column}\"\r\n          ]\r\n        }\r\n      ],\r\n      \"searchPhrase\": {\r\n        \"originalPhrase\": \"\"\r\n      }\r\n    }\r\n  }\r\n}"
                            },
                            "customColumnWidthSetting": "5%"
                          }
                        },
                        {
                          "columnMatch": "ErrorTrend",
                          "formatter": 9,
                          "formatOptions": {
                            "palette": "red"
                          }
                        },
                        {
                          "columnMatch": "Errors",
                          "formatter": 1,
                          "formatOptions": {
                            "customColumnWidthSetting": "50px"
                          },
                          "numberFormat": {
                            "unit": 17,
                            "options": {
                              "style": "decimal",
                              "maximumFractionDigits": 2
                            }
                          }
                        },
                        {
                          "columnMatch": "DurationTrend",
                          "formatter": 9,
                          "formatOptions": {
                            "palette": "blue"
                          }
                        },
                        {
                          "columnMatch": "Duration",
                          "formatter": 1,
                          "formatOptions": {
                            "customColumnWidthSetting": "50px"
                          },
                          "numberFormat": {
                            "unit": 23,
                            "options": {
                              "style": "decimal",
                              "maximumFractionDigits": 2
                            }
                          }
                        },
                        {
                          "columnMatch": "Calls",
                          "formatter": 0,
                          "formatOptions": {
                            "customColumnWidthSetting": "65px"
                          },
                          "numberFormat": {
                            "unit": 17,
                            "options": {
                              "style": "decimal",
                              "maximumFractionDigits": 2
                            }
                          }
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "ErrorTrend",
                          "label": "Errors"
                        },
                        {
                          "columnId": "Errors",
                          "label": " ",
                          "comment": ""
                        },
                        {
                          "columnId": "DurationTrend",
                          "label": "Avg. Duration"
                        },
                        {
                          "columnId": "Duration",
                          "label": " "
                        }
                      ]
                    },
                    "chartSettings": {
                      "yAxis": [
                        "avg_duration"
                      ],
                      "xSettings": {
                        "label": "Time"
                      },
                      "ySettings": {
                        "numberFormatSettings": {
                          "unit": 23,
                          "options": {
                            "style": "decimal",
                            "useGrouping": true,
                            "maximumFractionDigits": 1
                          }
                        }
                      }
                    }
                  },
                  "name": "ModelsQuery"
                }
              ]
            },
            "customWidth": "50",
            "name": "ModelsGroup",
            "styleSettings": {
              "margin": "20px 10px 0 10px",
              "padding": "10px 0 0 5px",
              "showBorder": true
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "GenAIDataCheck",
        "comparison": "isNotEqualTo",
        "value": "NotFound"
      },
      "name": "operational"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Token Consumption",
        "expandable": true,
        "expanded": true,
        "items": [
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "#### Token Consumption by Model"
                  },
                  "customWidth": "0",
                  "name": "TokenConsumptonByModelTitle",
                  "styleSettings": {
                    "margin": "0 0 10px 0"
                  }
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let agents = dependencies\r\n| where customDimensions[\"gen_ai.operation.name\"] == \"invoke_agent\"\r\n| extend AgentName = tostring(customDimensions[\"gen_ai.agent.name\"]);\r\nlet models = dependencies\r\n| extend Model = tostring(customDimensions[\"gen_ai.request.model\"])\r\n| where isnotempty(Model)\r\n| lookup kind=leftouter (agents) on $left.operation_ParentId == $right.id\r\n| where \"{SelectedAgent}\" == \"__ALL__\" or \"{SelectedAgent}\" == AgentName;\r\nmodels\r\n| extend InputTokens = toint(customDimensions[\"gen_ai.usage.input_tokens\"]), OutputTokens = toint(customDimensions[\"gen_ai.usage.output_tokens\"])\r\n| where InputTokens > 0 or OutputTokens > 0\r\n| extend TokenConsumption = InputTokens + OutputTokens\r\n| make-series TokenConsumption=sum(TokenConsumption * itemCount) default=0 on timestamp from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by Model\r\n| render columnchart",
                    "size": 1,
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.insights/components",
                    "chartSettings": {
                      "ySettings": {
                        "numberFormatSettings": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "useGrouping": true
                          }
                        }
                      }
                    }
                  },
                  "name": "TokenConsumptionByModelQuery"
                }
              ]
            },
            "customWidth": "50",
            "name": "TokenConsumptionByModelGroup",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px 10px 0 10px",
              "showBorder": true
            }
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "#### Input vs Output Tokens"
                  },
                  "customWidth": "0",
                  "name": "InputVsOutputTokensTitle",
                  "styleSettings": {
                    "margin": "0 0 10px 0"
                  }
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let agents = dependencies\r\n| where customDimensions[\"gen_ai.operation.name\"] == \"invoke_agent\"\r\n| extend AgentName = tostring(customDimensions[\"gen_ai.agent.name\"]);\r\nlet models = dependencies\r\n| extend Model = tostring(customDimensions[\"gen_ai.request.model\"])\r\n| where isnotempty(Model)\r\n| lookup kind=leftouter (agents) on $left.operation_ParentId == $right.id\r\n| where \"{SelectedAgent}\" == \"__ALL__\" or \"{SelectedAgent}\" == AgentName;\r\nmodels\r\n| extend InputTokens = toint(customDimensions[\"gen_ai.usage.input_tokens\"]), OutputTokens = toint(customDimensions[\"gen_ai.usage.output_tokens\"])\r\n| where InputTokens > 0 or OutputTokens > 0\r\n| make-series [\"Input Tokens\"]=sum(InputTokens * itemCount), [\"Output Tokens\"]=sum(OutputTokens * itemCount) default=0 on timestamp from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}\r\n| render timechart",
                    "size": 1,
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.insights/components",
                    "chartSettings": {
                      "ySettings": {
                        "numberFormatSettings": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "useGrouping": true,
                            "maximumFractionDigits": 2
                          }
                        }
                      }
                    }
                  },
                  "name": "InputVsOutputTokensQuery"
                }
              ]
            },
            "customWidth": "50",
            "name": "InputVsOutputTokensGroup",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px 10px 0 10px",
              "showBorder": true
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "GenAIDataCheck",
        "comparison": "isNotEqualTo",
        "value": "NotFound"
      },
      "name": "tokenConsumption",
      "styleSettings": {
        "margin": "10px 0 0 0"
      }
    }
  ],
  "fallbackResourceIds": [
  ],
  "styleSettings": {
    "spacingStyle": "none"
  },
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}