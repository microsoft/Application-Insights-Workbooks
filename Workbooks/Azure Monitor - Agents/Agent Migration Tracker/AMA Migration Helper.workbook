{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "# Azure Monitor Migration Helper"
      },
      "name": "Workbook-Header"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "b859a03f-2283-43dd-8536-42714bbfced6",
            "version": "KqlParameterItem/1.0",
            "name": "Subscription",
            "type": 6,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "resourcecontainers\r\n| where type == \"microsoft.resources/subscriptions\"\r\n| parse id with \"/subscriptions/\" subscriptionId\r\n| join ( resources\r\n| where type =~ 'microsoft.operationalinsights/workspaces'\r\n| summarize by subscriptionId\r\n) on subscriptionId\r\n| project value = subscriptionId, label = name, selected = true",
            "crossComponentResources": [
              "value::selected"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "label": "Subscription(s)",
            "value": [
              "value::all"
            ]
          },
          {
            "id": "8df9c309-e7d1-43ad-b2ad-2d190c0c4e60",
            "version": "KqlParameterItem/1.0",
            "name": "Workspace",
            "type": 5,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "resources\r\n| where type =~ 'microsoft.operationalinsights/workspaces'\r\n| project value = id, label = name, selected = true",
            "crossComponentResources": [
              "{Subscription}"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "label": "Workspace(s)",
            "value": [
              "value::all"
            ]
          },
          {
            "id": "04a8ead2-1fb2-4666-a7b0-6d92e3c29b46",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "type": 4,
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 1209600000
                },
                {
                  "durationMs": 2592000000
                },
                {
                  "durationMs": 5184000000
                },
                {
                  "durationMs": 7776000000
                }
              ],
              "allowCustom": false
            },
            "value": {
              "durationMs": 2592000000
            }
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "Parameters"
    },
    {
      "type": 1,
      "content": {
        "json": "Use this workbook to review the status of migration from [legacy Log Analytics Agents (MMA/OMS)](https://docs.microsoft.com/en-us/azure/azure-monitor/agents/log-analytics-agent) to [Azure Monitor Agent (AMA)](https://docs.microsoft.com/en-us/azure/azure-monitor/agents/azure-monitor-agent-overview?tabs=PowerShellWindows). The legacy agents will not be supported after August, 2024.\r\n\r\n* Select Workspaces view to review the machines connected to the workspace that are running MMA/OMS agents, and the list of solutions/services used. Review the [migration guidance per solution](https://docs.microsoft.com/en-us/azure/azure-monitor/agents/azure-monitor-agent-overview?tabs=PowerShellWindows#supported-services-and-features).\r\n* Select corresponding tabs to look at status of the machine and the agents installed on them, including the data collection rules that are associated to the machines.",
        "style": "info"
      },
      "name": "workbook-info"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "tabs",
        "links": [
          {
            "id": "171ec6b0-45d1-4095-a664-e27a5a0e8e5d",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Subscriptions Overview",
            "subTarget": "Overview",
            "preText": "Overview Tab",
            "style": "link"
          },
          {
            "id": "81a835f7-a7a7-4fc6-8787-94f3b9f62dd0",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Workspaces",
            "subTarget": "Workspaces",
            "style": "link"
          },
          {
            "id": "c5a937b9-f1a7-42f0-a271-d403683b6b76",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Azure Virtual Machines",
            "subTarget": "AzureVM",
            "style": "link"
          },
          {
            "id": "be680966-78d6-4c1f-976b-7818ed131e9f",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Azure Virtual Machine Scale Sets",
            "subTarget": "VMSS",
            "style": "link"
          },
          {
            "id": "6a9e9444-29f9-4bd6-9bbf-1b17bd6bb906",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Arc-Enabled Servers",
            "subTarget": "Arc",
            "style": "link"
          },
          {
            "id": "6cea1468-b8f1-478d-9e4f-7bdbe90cf0ec",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Hybrid without Arc",
            "subTarget": "HybridNoArc",
            "style": "link"
          }
        ]
      },
      "name": "GlobalTabs"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "# Subscription(s) Overview"
            },
            "name": "Overview-explain-text"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "resourcecontainers\r\n| where type == \"microsoft.resources/subscriptions\"\r\n| extend text = \"Subscriptions selected\"\r\n| summarize count() by text",
              "size": 4,
              "noDataMessage": "No subscriptions selected",
              "noDataMessageStyle": 4,
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "text",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "count_",
                  "formatter": 12,
                  "formatOptions": {
                    "min": 0,
                    "palette": "blue"
                  }
                },
                "showBorder": true,
                "size": "full"
              }
            },
            "customWidth": "25",
            "name": "SubCount"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "resources\r\n| where type == \"microsoft.operationalinsights/workspaces\"\r\n| extend text = \"Workspace(s) detected\"\r\n| summarize wscount = count() by text",
              "size": 4,
              "noDataMessage": "No workspaces detected in these subscriptions",
              "noDataMessageStyle": 5,
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "text",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "wscount",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                },
                "showBorder": true,
                "size": "full"
              }
            },
            "customWidth": "25",
            "name": "wscount"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "resources\r\n| where type == \"microsoft.compute/virtualmachines\"\r\n| extend text = \" Azure VMs detected\"\r\n| summarize Mcount = count() by text",
              "size": 4,
              "noDataMessage": "No Azure Virtual Machines in the selected subscriptions",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "text",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "Mcount",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                },
                "showBorder": true,
                "size": "full"
              }
            },
            "customWidth": "25",
            "name": "azurevmcount"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "resources\r\n| where type == \"microsoft.compute/virtualmachinescalesets\"\r\n| extend text = \" VM Scale Set(s) detected\"\r\n| summarize vmsscount = count() by text",
              "size": 4,
              "noDataMessage": "No VM Scale Sets detected in the selected subscriptions",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "text",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "vmsscount",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                },
                "showBorder": true,
                "size": "full"
              }
            },
            "customWidth": "25",
            "name": "vmsscount"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "resources\r\n| where type == \"microsoft.hybridcompute/machines\"\r\n| extend text = \" Arc-enabled servers detected\"\r\n| summarize arccount = count() by text",
              "size": 4,
              "noDataMessage": "No Arc-enabled servers detected in the selected subscriptions",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "text",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "arccount",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                },
                "showBorder": true,
                "size": "full"
              }
            },
            "customWidth": "25",
            "name": "arccount"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Heartbeat\r\n| where isempty(_ResourceId)\r\n| summarize LastHeartBeat = arg_max(TimeGenerated, *) by Computer\r\n| extend text = \"Hybrid without Arc servers\"\r\n| summarize AgentCount = count() by text",
              "size": 4,
              "noDataMessage": "No hybrid servers without Arc detected in the selected workspaces.",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "text",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "AgentCount",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                },
                "showBorder": true,
                "size": "full"
              }
            },
            "customWidth": "25",
            "name": "hybridwithoutarccount"
          },
          {
            "type": 1,
            "content": {
              "json": "# Migration Status"
            },
            "name": "MigrationStatusHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "resources\r\n| where type == \"microsoft.compute/virtualmachines\" or type == \"microsoft.hybridcompute/machines\"\r\n| parse id with * \"achines/\" ComputerName\r\n| extend ComputerName = tolower(ComputerName)\r\n| join kind=leftouter (\r\nresources\r\n| where (type contains \"microsoft.hybridcompute/machines/extensions\" or type contains \"microsoft.compute/virtualmachines/extensions\")\r\n| extend publisher = properties.publisher\r\n| where publisher =~ \"Microsoft.EnterpriseCloud.Monitoring\"\r\n| parse id with * \"achines/\" ComputerName \"/\" *\r\n| extend ComputerName = tolower(ComputerName)\r\n| extend MMA = tostring(name)\r\n) on ComputerName\r\n| join kind=leftouter (\r\nresources\r\n| where (type contains \"microsoft.hybridcompute/machines/extensions\" or type contains \"microsoft.compute/virtualmachines/extensions\")\r\n| extend publisher = properties.publisher\r\n| where publisher =~ \"Microsoft.Azure.Monitor\"\r\n| parse id with * \"achines/\" ComputerName \"/\" *\r\n| extend ComputerName = tolower(ComputerName)\r\n| extend AMAgent = tostring(name)\r\n) on ComputerName\r\n| project id, name, ['type'], MMA, AMAgent, subscriptionId\r\n| union (\r\n    resources\r\n    | where type == \"microsoft.compute/virtualmachinescalesets\"\r\n    | project id, name, subscriptionId\r\n    | join kind=leftouter (\r\n    resources\r\n    | where type == \"microsoft.compute/virtualmachinescalesets\"\r\n    | extend extensionprofile = properties.virtualMachineProfile.extensionProfile\r\n    | extend extensions = extensionprofile.extensions\r\n    | mv-expand extensions\r\n    | extend extensiontype = extensions.properties.type\r\n    | where extensiontype in (\"MicrosoftMonitoringAgent\" )\r\n    | project id, name, MMA = extensiontype, subscriptionId\r\n    ) on name \r\n    | join kind=fullouter (\r\n    resources\r\n    | where type == \"microsoft.compute/virtualmachinescalesets\"\r\n    | extend extensionprofile = properties.virtualMachineProfile.extensionProfile\r\n    | extend extensions = extensionprofile.extensions\r\n    | mv-expand extensions\r\n    | extend extensiontype = extensions.properties.type\r\n    | where extensiontype in (\"AzureMonitorWindowsAgent\")\r\n    | project id, name, AMAgent = extensiontype, subscriptionId\r\n    ) on $left.name == $right.name\r\n    | extend ComputerName = iff(isempty(name), name1, name)\r\n    | extend id = iff(isempty(id), id1, id)\r\n    | extend subscriptionId = iff(isempty(subscriptionId), subscriptionId1, subscriptionId)\r\n    | project id, name = ComputerName, [\"type\"] = \"Virtual Machine Scale Sets\", MMA, AMAgent, subscriptionId\r\n)\r\n| extend VMType = case(type == \"microsoft.compute/virtualmachines\", \"Azure Virtual Machines\",\r\n                type == \"microsoft.hybridcompute/machines\", \"Arc-enabled Servers\", \r\n                type == \"Virtual Machine Scale Sets\", \"Virtual Machine Scale Sets\", \r\n                \"Other\")\r\n| extend MMA = iff(isnotempty(MMA_string), MMA_string, MMA_dynamic)\r\n| extend AMAgent = iff(isnotempty(AMAgent_string), AMAgent_string, AMAgent_dynamic)\r\n| summarize MachineCount = count(), BothAgents = countif(isnotempty(MMA) and isnotempty(AMAgent)), MMAOnly = countif(isnotempty(MMA) and isempty(AMAgent)), AMAOnly = countif(isempty(MMA) and isnotempty(AMAgent)) by subscriptionId, VMType\r\n| extend counts = pack_array(BothAgents, MMAOnly, AMAOnly)\r\n| extend migstatus = case(BothAgents != 0, \"In Progress\",\r\n                            AMAOnly != 0 and BothAgents == 0 and MMAOnly == 0, \"Completed\", \r\n                            AMAOnly != 0 and MMAOnly != 0, \"In Progress\",\r\n                            MMAOnly != 0 and BothAgents == 0, \"Not Started\", \"Not Started\")",
              "size": 0,
              "showAnalytics": true,
              "noDataMessage": "No Azure VMs, VMScale Sets or Arc-enabled VMs detected",
              "showExportToExcel": true,
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "subscriptionId",
                    "formatter": 15,
                    "formatOptions": {
                      "linkTarget": "Resource",
                      "linkIsContextBlade": true,
                      "showIcon": true,
                      "customColumnWidthSetting": "40ch"
                    }
                  },
                  {
                    "columnMatch": "VMType",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "30ch"
                    }
                  },
                  {
                    "columnMatch": "MachineCount",
                    "formatter": 1,
                    "formatOptions": {
                      "customColumnWidthSetting": "20ch"
                    }
                  },
                  {
                    "columnMatch": "BothAgents",
                    "formatter": 4,
                    "formatOptions": {
                      "palette": "blue",
                      "customColumnWidthSetting": "20ch"
                    }
                  },
                  {
                    "columnMatch": "MMAOnly",
                    "formatter": 4,
                    "formatOptions": {
                      "palette": "red",
                      "customColumnWidthSetting": "20ch"
                    }
                  },
                  {
                    "columnMatch": "AMAOnly",
                    "formatter": 4,
                    "formatOptions": {
                      "palette": "green",
                      "customColumnWidthSetting": "20ch"
                    }
                  },
                  {
                    "columnMatch": "counts",
                    "formatter": 22,
                    "formatOptions": {
                      "aggregation": "Inherit",
                      "compositeBarSettings": {
                        "labelText": "[\"migstatus\"]",
                        "columnSettings": [
                          {
                            "columnName": "BothAgents",
                            "color": "blue"
                          },
                          {
                            "columnName": "MMAOnly",
                            "color": "red"
                          },
                          {
                            "columnName": "AMAOnly",
                            "color": "green"
                          }
                        ]
                      },
                      "customColumnWidthSetting": "30ch"
                    }
                  },
                  {
                    "columnMatch": "migstatus",
                    "formatter": 5
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "subscriptionId",
                    "label": "Subscription"
                  },
                  {
                    "columnId": "VMType",
                    "label": "Resource Type"
                  },
                  {
                    "columnId": "MachineCount",
                    "label": "Resource Count"
                  },
                  {
                    "columnId": "BothAgents",
                    "label": "Both Agents"
                  },
                  {
                    "columnId": "MMAOnly",
                    "label": "MMA/OMS Only"
                  },
                  {
                    "columnId": "AMAOnly",
                    "label": "AMA Only"
                  },
                  {
                    "columnId": "counts",
                    "label": "Migration Status"
                  }
                ]
              }
            },
            "name": "agentmigrationtracker"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "Overview"
      },
      "name": "Overview Group"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "# Workspaces Overview"
            },
            "name": "WorkspacesOverviewHeader"
          },
          {
            "type": 1,
            "content": {
              "json": "Select a workspace in the drop down below to view the agent breakdown for the workspace, as well as the solutions in the workspace, and the data collection rules that use the workspace as a destination.",
              "style": "info"
            },
            "name": "Workspace-select-info"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "parameters": [
                {
                  "id": "16ae0ffa-3747-4c57-8f87-e2388c68c56b",
                  "version": "KqlParameterItem/1.0",
                  "name": "wsid",
                  "label": "Workspace",
                  "type": 5,
                  "description": "Select the workspace from the drop down to view agent, solution and data collection information",
                  "isRequired": true,
                  "query": "resources\r\n| where type == \"microsoft.operationalinsights/workspaces\"\r\n| where id in ({Workspace})\r\n| extend sku = properties.sku.name,\r\n\tcreatedDate = properties.createdDate\r\n| join kind=leftouter  ( \r\nresourcecontainers\r\n| where type == \"microsoft.resources/subscriptions\"\r\n| project subscriptionId, subname = name\r\n) on subscriptionId\r\n| project subscriptionId, subname, id, name, location, resourceGroup, createdDate\r\n| order by subscriptionId\r\n| project value = id, label = name, group = strcat('ðŸ”‘ ', subname)",
                  "crossComponentResources": [
                    "{Subscription}"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources"
                }
              ],
              "style": "pills",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources"
            },
            "name": "WorkspaceSelectionParam"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "parameters": [
                      {
                        "id": "df6dfea5-53cc-46d5-a767-42d8d0aea4d4",
                        "version": "KqlParameterItem/1.0",
                        "name": "workspaceid",
                        "type": 5,
                        "description": "Used to pass Workspace from previous step",
                        "query": "resources\r\n| where type == \"microsoft.operationalinsights/workspaces\"\r\n| where id =~ '{wsid}'",
                        "crossComponentResources": [
                          "{Subscription}"
                        ],
                        "isHiddenWhenLocked": true,
                        "typeSettings": {
                          "resourceTypeFilter": {
                            "microsoft.operationalinsights/workspaces": true
                          },
                          "additionalResourceOptions": []
                        },
                        "timeContext": {
                          "durationMs": 86400000
                        },
                        "queryType": 1,
                        "resourceType": "microsoft.resourcegraph/resources"
                      }
                    ],
                    "style": "above",
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources"
                  },
                  "name": "workspace-hidden-param"
                },
                {
                  "type": 11,
                  "content": {
                    "version": "LinkItem/1.0",
                    "style": "tabs",
                    "links": [
                      {
                        "id": "95fe5c28-26ca-4aeb-af27-1efe33da53f7",
                        "cellValue": "selectedTab",
                        "linkTarget": "parameter",
                        "linkLabel": "Agents",
                        "subTarget": "Agents",
                        "preText": "Agents",
                        "style": "link"
                      },
                      {
                        "id": "07108f4a-eb70-4368-9382-169dc4099703",
                        "cellValue": "selectedTab",
                        "linkTarget": "parameter",
                        "linkLabel": "Solutions",
                        "subTarget": "Solutions",
                        "style": "link"
                      },
                      {
                        "id": "bbf1f75a-fc87-4a6f-99e3-0460250cabd1",
                        "cellValue": "selectedTab",
                        "linkTarget": "parameter",
                        "linkLabel": "Data Collection Rules",
                        "subTarget": "DCR",
                        "style": "link"
                      }
                    ]
                  },
                  "name": "Workspace-Tabs"
                },
                {
                  "type": 12,
                  "content": {
                    "version": "NotebookGroup/1.0",
                    "groupType": "editable",
                    "items": [
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "Heartbeat\r\n| summarize arg_max(TimeGenerated, *) by Category, Computer\r\n| extend machinetype = case(ComputerEnvironment == \"Non-Azure\" and isempty(_ResourceId), \"Hybrid without Arc\",\r\n                            ResourceProvider == \"Microsoft.ContainerService\", \"Containers\",\r\n                            ComputerEnvironment == \"Non-Azure\" and ResourceProvider == \"Microsoft.HybridCompute\", \"ArcEnabled\",\r\n                            ComputerEnvironment == \"Azure\" and ResourceType == \"virtualMachines\", \"AzureVM\",\r\n                            ComputerEnvironment == \"Azure\" and ResourceType == \"virtualMachineScaleSets\", \"VMSS\", \"Other\")\r\n| summarize MachineCount = count(), MMACount = countif(Category == \"Direct Agent\"), AMACount = countif(Category == \"Azure Monitor Agent\") by machinetype\r\n| extend counts = pack_array(MMACount, AMACount)\r\n| extend migstatus = case(MMACount != 0 and AMACount != 0, \"In Progress\",\r\n                            AMACount != 0 and MMACount == 0, \"Completed\", \"Not Started\")",
                          "size": 1,
                          "title": "Agents connected to {workspaceid:label}",
                          "noDataMessage": "No heartbeats for Azure Virtual Machines, VM Scale Sets, Arc-enabled machines or Hybrid machines without Arc detected in this workspace. Please select another.",
                          "timeContext": {
                            "durationMs": 86400000
                          },
                          "showExportToExcel": true,
                          "queryType": 0,
                          "resourceType": "microsoft.operationalinsights/workspaces",
                          "crossComponentResources": [
                            "{workspaceid}"
                          ],
                          "gridSettings": {
                            "formatters": [
                              {
                                "columnMatch": "machinetype",
                                "formatter": 0,
                                "formatOptions": {
                                  "customColumnWidthSetting": "22ch"
                                }
                              },
                              {
                                "columnMatch": "MachineCount",
                                "formatter": 0,
                                "formatOptions": {
                                  "customColumnWidthSetting": "20ch"
                                }
                              },
                              {
                                "columnMatch": "MMACount",
                                "formatter": 4,
                                "formatOptions": {
                                  "min": 0,
                                  "palette": "redBright",
                                  "customColumnWidthSetting": "18ch"
                                }
                              },
                              {
                                "columnMatch": "AMACount",
                                "formatter": 4,
                                "formatOptions": {
                                  "min": 0,
                                  "palette": "green",
                                  "customColumnWidthSetting": "18ch"
                                }
                              },
                              {
                                "columnMatch": "counts",
                                "formatter": 22,
                                "formatOptions": {
                                  "aggregation": "Sum",
                                  "compositeBarSettings": {
                                    "labelText": "[\"migstatus\"]",
                                    "columnSettings": [
                                      {
                                        "columnName": "MMACount",
                                        "color": "redBright"
                                      },
                                      {
                                        "columnName": "AMACount",
                                        "color": "green"
                                      }
                                    ]
                                  },
                                  "customColumnWidthSetting": "30ch"
                                }
                              },
                              {
                                "columnMatch": "migstatus",
                                "formatter": 5,
                                "formatOptions": {
                                  "compositeBarSettings": {
                                    "labelText": "",
                                    "columnSettings": []
                                  }
                                }
                              }
                            ],
                            "labelSettings": [
                              {
                                "columnId": "machinetype",
                                "label": "Resource Type"
                              },
                              {
                                "columnId": "MachineCount",
                                "label": "Resource Count"
                              },
                              {
                                "columnId": "MMACount",
                                "label": "MMA/OMS"
                              },
                              {
                                "columnId": "AMACount",
                                "label": "AMA"
                              },
                              {
                                "columnId": "counts",
                                "label": "Migration Status"
                              }
                            ]
                          }
                        },
                        "conditionalVisibility": {
                          "parameterName": "selectedTab",
                          "comparison": "isEqualTo",
                          "value": "Agents"
                        },
                        "name": "AgentsinWorkspace"
                      }
                    ]
                  },
                  "conditionalVisibility": {
                    "parameterName": "selectedTab",
                    "comparison": "isEqualTo",
                    "value": "Agents"
                  },
                  "name": "Workspace-Agents-Group"
                },
                {
                  "type": 12,
                  "content": {
                    "version": "NotebookGroup/1.0",
                    "groupType": "editable",
                    "items": [
                      {
                        "type": 9,
                        "content": {
                          "version": "KqlParameterItem/1.0",
                          "crossComponentResources": [
                            "{Subscription}"
                          ],
                          "parameters": [
                            {
                              "id": "b47d23bc-89cd-407d-9a22-4397af375473",
                              "version": "KqlParameterItem/1.0",
                              "name": "DCRCount",
                              "type": 2,
                              "query": "resources\r\n| where type == \"microsoft.operationalinsights/workspaces\"\r\n| extend wsid = tolower(id)\r\n| where wsid == tolower(\"{workspaceid}\")\r\n| project wsid, name\r\n| join kind=leftouter (\r\nresources\r\n| where type == \"microsoft.insights/datacollectionrules\"\r\n| extend provisioningState = properties.provisioningState,\r\n    description = properties.description,\r\n    sentineltag = tags.createdBy,\r\n    dataSources = properties.dataSources,\r\n    destinations = properties.destinations\r\n| extend workspace = destinations.logAnalytics\r\n| mv-expand workspace\r\n| extend wsid = tostring(workspace.workspaceResourceId)\r\n| project wsname = name, wsid\r\n) on wsid\r\n| summarize DCRC = count() by name, wsid1\r\n| extend dcrcount = iff(isempty(wsid1), 0, DCRC)\r\n| project label = dcrcount, value = dcrcount, selected = true",
                              "crossComponentResources": [
                                "{Subscription}"
                              ],
                              "isHiddenWhenLocked": true,
                              "typeSettings": {
                                "additionalResourceOptions": [],
                                "showDefault": false
                              },
                              "timeContext": {
                                "durationMs": 86400000
                              },
                              "queryType": 1,
                              "resourceType": "microsoft.resourcegraph/resources"
                            },
                            {
                              "id": "c90b8f2c-00e2-4c0f-867a-35c880739b03",
                              "version": "KqlParameterItem/1.0",
                              "name": "dcrsub",
                              "type": 6,
                              "query": "resources\r\n| where type == \"microsoft.operationalinsights/workspaces\"\r\n| extend wsid = tolower(id)\r\n| where wsid == tolower(\"{workspaceid}\")\r\n| project value = subscriptionId, label = subscriptionId, selected = true",
                              "crossComponentResources": [
                                "{Subscription}"
                              ],
                              "isHiddenWhenLocked": true,
                              "typeSettings": {
                                "additionalResourceOptions": []
                              },
                              "timeContext": {
                                "durationMs": 86400000
                              },
                              "queryType": 1,
                              "resourceType": "microsoft.resourcegraph/resources"
                            }
                          ],
                          "style": "pills",
                          "queryType": 1,
                          "resourceType": "microsoft.resourcegraph/resources"
                        },
                        "name": "dcr-hidden-params"
                      },
                      {
                        "type": 1,
                        "content": {
                          "json": "This tab lists all the data collection rules this workspace ({workspaceid:label}) as a target. These rules are required to centrally configure and operationalize the new Azure Monitor Agent (AMA), when associated to machines running the new agent. They define where to collect the data from (i.e. â€˜Data Sourceâ€™), where to send the data to (i.e. â€˜Destinationâ€™) and any custom processing or filtering for the data. Click on the rule name in the list below to view the associated machines. [Learn more](https://docs.microsoft.com/en-us/azure/azure-monitor/essentials/data-collection-rule-overview)\r\n\r\n\r\nIf there are no Virtual Machines associated with this data collection rule, see [Configure data collection for the Azure Monitor Agent](https://docs.microsoft.com/en-us/azure/azure-monitor/agents/data-collection-rule-azure-monitor-agent) to see how you can associate virtual machines.\r\n\r\n\r\n*Note: Data Collection Rules need to exist in the same physical location as the workspace, but they can be associated with machines in any other location or subscription.*",
                          "style": "info"
                        },
                        "conditionalVisibility": {
                          "parameterName": "DCRCount",
                          "comparison": "isNotEqualTo",
                          "value": "0"
                        },
                        "name": "DCR-Text"
                      },
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "resources\r\n| where type == \"microsoft.insights/datacollectionrules\"\r\n| extend provisioningState = properties.provisioningState,\r\n    description = properties.description,\r\n    sentineltag = tags.createdBy,\r\n    dataSources = properties.dataSources,\r\n    destinations = properties.destinations\r\n| extend workspace = destinations.logAnalytics\r\n| mv-expand workspace\r\n| extend wsid = tolower(workspace.workspaceResourceId)\r\n| where wsid == tolower({workspaceid:value})\r\n| extend Sentinel = iff(sentineltag == \"Sentinel\", \"True\", \"False\")\r\n| extend DataSource = case(dataSources contains \"extensions\", \"Extensions\", \r\n                    dataSources contains \"syslog\", \"Syslog\", \r\n                    dataSources contains \"windowsEventLogs\", \"EventLogs\", \r\n                    dataSources contains \"performanceCounters\", \"Performance\", \"Other\")\r\n| extend destination = case(destinations contains \"logAnalytics\", \"Log Analytics Workspace\", \r\n                    destinations contains \"azureMonitorMetrics\", \"Metrics\", \"Other\")\r\n| project id, name, subscriptionId, provisioningState, description, Sentinel, resourceGroup, DataSource, destination, wsid",
                          "size": 0,
                          "queryType": 1,
                          "resourceType": "microsoft.resourcegraph/resources",
                          "crossComponentResources": [
                            "{Subscription}"
                          ]
                        },
                        "conditionalVisibility": {
                          "parameterName": "1",
                          "comparison": "isEqualTo",
                          "value": "1"
                        },
                        "name": "DCR-ARG"
                      },
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"/subscriptions/{dcrsub:id}/providers/Microsoft.Insights/dataCollectionRules\",\"urlParams\":[{\"key\":\"api-version\",\"value\":\"2021-04-01\"}],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.value\",\"columns\":[{\"path\":\"name\",\"columnid\":\"Name\"},{\"path\":\"$..workspaceResourceId\",\"columnid\":\"Workspace\"},{\"path\":\"kind\",\"columnid\":\"OS\"},{\"path\":\"properties.dataFlows[*].streams[0]\",\"columnid\":\"Streams\",\"substringRegexMatch\":\"(Microsoft-)*(\\\\w+)\",\"substringReplace\":\"$2\"},{\"path\":\"$..xPathQueries\",\"columnid\":\"xPath\"},{\"path\":\"location\",\"columnid\":\"Location\"},{\"path\":\"$..facilityNames\",\"columnid\":\"SyslogFacilities\"}]}}]}",
                          "size": 0,
                          "queryType": 12
                        },
                        "conditionalVisibility": {
                          "parameterName": "1",
                          "comparison": "isEqualTo",
                          "value": "1"
                        },
                        "name": "DCR-Arm"
                      },
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"5d85c953-b359-4907-883a-c0c34696f0dc\",\"mergeType\":\"innerunique\",\"leftTable\":\"DCR-ARG\",\"rightTable\":\"DCR-Arm\",\"leftColumn\":\"name\",\"rightColumn\":\"Name\"}],\"projectRename\":[{\"originalName\":\"[DCR-ARG].id\",\"mergedName\":\"id\",\"fromId\":\"5d85c953-b359-4907-883a-c0c34696f0dc\"},{\"originalName\":\"[DCR-Arm].Location\",\"mergedName\":\"Location\",\"fromId\":\"5d85c953-b359-4907-883a-c0c34696f0dc\"},{\"originalName\":\"[DCR-ARG].resourceGroup\",\"mergedName\":\"resourceGroup\",\"fromId\":\"5d85c953-b359-4907-883a-c0c34696f0dc\"},{\"originalName\":\"[DCR-Arm].Streams\",\"mergedName\":\"Streams\",\"fromId\":\"5d85c953-b359-4907-883a-c0c34696f0dc\"},{\"originalName\":\"[DCR-ARG].name\",\"mergedName\":\"name\",\"fromId\":\"5d85c953-b359-4907-883a-c0c34696f0dc\"},{\"originalName\":\"[DCR-ARG].subscriptionId\",\"mergedName\":\"subscriptionId\",\"fromId\":\"5d85c953-b359-4907-883a-c0c34696f0dc\"},{\"originalName\":\"[DCR-ARG].provisioningState\",\"mergedName\":\"provisioningState\",\"fromId\":\"5d85c953-b359-4907-883a-c0c34696f0dc\"},{\"originalName\":\"[DCR-ARG].description\",\"mergedName\":\"description\",\"fromId\":\"5d85c953-b359-4907-883a-c0c34696f0dc\"},{\"originalName\":\"[DCR-ARG].DataSource\",\"mergedName\":\"DataSource\",\"fromId\":\"5d85c953-b359-4907-883a-c0c34696f0dc\"},{\"originalName\":\"[DCR-ARG].destination\",\"mergedName\":\"destination\",\"fromId\":\"5d85c953-b359-4907-883a-c0c34696f0dc\"},{\"originalName\":\"[DCR-ARG].wsid\",\"mergedName\":\"wsid\",\"fromId\":\"5d85c953-b359-4907-883a-c0c34696f0dc\"},{\"originalName\":\"[DCR-Arm].Name\",\"mergedName\":\"Name\",\"fromId\":\"5d85c953-b359-4907-883a-c0c34696f0dc\"},{\"originalName\":\"[DCR-Arm].Workspace\",\"mergedName\":\"Workspace\",\"fromId\":\"5d85c953-b359-4907-883a-c0c34696f0dc\"},{\"originalName\":\"[DCR-Arm].OS\",\"mergedName\":\"OS\",\"fromId\":\"5d85c953-b359-4907-883a-c0c34696f0dc\"},{\"originalName\":\"[DCR-Arm].xPath\",\"mergedName\":\"xPath\",\"fromId\":\"5d85c953-b359-4907-883a-c0c34696f0dc\"},{\"originalName\":\"[DCR-Arm].SyslogFacilities\",\"mergedName\":\"SyslogFacilities\",\"fromId\":\"5d85c953-b359-4907-883a-c0c34696f0dc\"},{\"originalName\":\"[DCR-ARG].Sentinel\",\"mergedName\":\"Sentinel\",\"fromId\":\"5d85c953-b359-4907-883a-c0c34696f0dc\"}]}",
                          "size": 0,
                          "title": "{$rowCount} Data Collection rules for {workspaceid:label}",
                          "noDataMessage": "No Data Collection Rules exist in the selected subscriptions with this workspace as a target.",
                          "exportedParameters": [
                            {
                              "fieldName": "Name",
                              "parameterName": "DCR",
                              "parameterType": 1
                            },
                            {
                              "fieldName": "resourceGroup",
                              "parameterName": "DCRrg",
                              "parameterType": 1
                            },
                            {
                              "fieldName": "subscriptionId",
                              "parameterName": "DCRSub",
                              "parameterType": 1
                            }
                          ],
                          "queryType": 7,
                          "gridSettings": {
                            "formatters": [
                              {
                                "columnMatch": "id",
                                "formatter": 13,
                                "formatOptions": {
                                  "linkTarget": null,
                                  "showIcon": true
                                }
                              },
                              {
                                "columnMatch": "Location",
                                "formatter": 17,
                                "formatOptions": {
                                  "customColumnWidthSetting": "16ch"
                                }
                              },
                              {
                                "columnMatch": "resourceGroup",
                                "formatter": 0,
                                "formatOptions": {
                                  "customColumnWidthSetting": "25ch"
                                }
                              },
                              {
                                "columnMatch": "name",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "subscriptionId",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "provisioningState",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "description",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "wsid",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "Name",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "Workspace",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "OS",
                                "formatter": 5
                              }
                            ],
                            "labelSettings": [
                              {
                                "columnId": "id",
                                "label": "Data Collection Rule"
                              },
                              {
                                "columnId": "resourceGroup",
                                "label": "Resource Group"
                              },
                              {
                                "columnId": "destination",
                                "label": "Destination"
                              },
                              {
                                "columnId": "wsid",
                                "label": "Workspace"
                              }
                            ]
                          }
                        },
                        "conditionalVisibility": {
                          "parameterName": "DCRCount",
                          "comparison": "isNotEqualTo",
                          "value": "0"
                        },
                        "showPin": false,
                        "name": "DCR-merged"
                      },
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"/subscriptions/{DCRSub}/resourceGroups/{DCRrg}/providers/Microsoft.Insights/dataCollectionRules/{DCR}/associations\",\"urlParams\":[{\"key\":\"api-version\",\"value\":\"2021-04-01\"}],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.value\",\"columns\":[{\"path\":\"id\",\"columnid\":\"VMs\",\"substringRegexMatch\":\"(\\\\/subscriptions.*)(\\\\/providers.*|Providers.*)\",\"substringReplace\":\"$1\"}]}}]}",
                          "size": 0,
                          "title": "VMs associated with {DCR}",
                          "noDataMessage": "No Virtual Machines associated with this data collection rule.",
                          "queryType": 12
                        },
                        "conditionalVisibility": {
                          "parameterName": "DCR",
                          "comparison": "isNotEqualTo"
                        },
                        "name": "DCRVms"
                      },
                      {
                        "type": 1,
                        "content": {
                          "json": "This tab lists all the data collection rules this workspace ({workspaceid:label}) as a target. These rules are required to centrally configure and operationalize the new Azure Monitor Agent (AMA), when associated to machines running the new agent. They define where to collect the data from (i.e. â€˜Data Sourceâ€™), where to send the data to (i.e. â€˜Destinationâ€™) and any custom processing or filtering for the data. \r\n\r\nNo Data Collection Rules found with this workspace ({workspaceid:label}) as a target. Consider converting your current data collections to Data Collection Rules - [read more here](https://docs.microsoft.com/en-us/azure/azure-monitor/agents/data-collection-rule-azure-monitor-agent)\r\n\r\n\r\n*Note: Data Collection Rules need to exist in the same physical location as the workspace, but they can be associated with machines in any other location or subscription.*",
                          "style": "info"
                        },
                        "conditionalVisibility": {
                          "parameterName": "DCRCount",
                          "comparison": "isEqualTo",
                          "value": "0"
                        },
                        "name": "NoDCRtext"
                      }
                    ]
                  },
                  "conditionalVisibility": {
                    "parameterName": "selectedTab",
                    "comparison": "isEqualTo",
                    "value": "DCR"
                  },
                  "name": "DCRGroup"
                },
                {
                  "type": 12,
                  "content": {
                    "version": "NotebookGroup/1.0",
                    "groupType": "editable",
                    "items": [
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "resources\r\n| where type == \"microsoft.operationsmanagement/solutions\"\r\n| extend workspace = tolower(properties.workspaceResourceId)\r\n| parse workspace with * \"/workspaces/\" workspacename\r\n| where workspace == tolower(\"{workspaceid}\")\r\n| parse name with Solution \"(\" *\r\n| extend Solution = iff(isempty(Solution), name, Solution)\r\n| where Solution !in (\"azureActivity\")\r\n| extend workspacename = tolower(workspacename)\r\n| extend Message = case(Solution in~ ('security', 'securityCenter', 'securityCenterFree', 'antimalware', 'sqlAdvancedThreatProtection',  'sqlVulnerabilityAssessment', 'sqlAssessment', 'sqlAssessmentPlus'), \"Start migrating to Defender for Servers on AMA\",\r\n    Solution in~ ('windowsDefenderATP'), \"Migrate to latest MDE solution for Windows 10+, For Windows 8 and lower, the legacy agent based support will be deprecated by August 2024\", \r\n    Solution in~ ('updates'), \"Migration to Update Management Center (does not use legacy agents nor AMA)\",\r\n    Solution in~ ('azureAutomation'), \"Migrate to Azure Automation Hybrid Worker Extensions (does not use legacy agents nor AMA)\",\r\n    Solution in~ ('changeTracking'), \"Start migrating to Change Tracking on AMA\",\r\n    Solution in~ ('securityinsights', 'windowsFirewall', 'windowsEventForwarding'), \"Migrate to Sentinel-AMA connectors\",\r\n    Solution in~ ('dnsAnalytics'), \"Migrate to Sentinel-DNS-AMA connector\",\r\n    Solution in~ ('vminsights', 'servicemap'), \"Migrate to VM Insights on AMA\",\r\n    Solution in~ ('containerInsights', 'containers'), \"Already auto-migrated to AMA. Optional: Migrate to managed identity and DCRs\",\r\n    Solution in~ ('infrastructureInsights'), \"This has been deprecated and no longer supported.\",\r\n    Solution in~ ('networkMonitoring'), \"Migrate to Connection Monitor on AMA\",\r\n    Solution in~ ('adAssessment','adAssessmentPlus','adSecurityAssessment','sccmAssessmentPlus','windowsServerAssessment','exchangeAssessment','azureAssessment','exchangeOnlineAssessment','windowsClientAssessmentPlus','sharePointOnlineAssessment','spAssessment','sfBOnlineAssessment','sfBAssessment','SCOMAssessmentPlus','SQLAssessmentPlus', 'SQLAssessment/SQLAssessmentPlus','DesktopAssessmentPlus','WindowsClientAssessment'), \"Coming soon on AMA\",\r\n    Solution contains \"Start-Stop-VM\", \"Migrate to the new Stop/Start VM V2 feature\",\r\n    Solution in~ ('behaviorAnalyticsInsights'), \"Migrate toÂ Identify advanced threats with User and Entity Behavior Analytics (UEBA) in Microsoft Sentinel | Microsoft Learn which does not use agents\",\r\n    Solution in~ ('AzureSQLAnalytics'), \"Migrate toÂ Monitor your SQL deployments with SQL Insights (preview) - Azure SQL Database | Microsoft Learn on AMA\",\r\n    Solution in~ ('agentHealthAssessment'), \"We will have a replacement â€˜AMA Healthâ€™ releasing soon\",\r\n    Solution in~ ('logicAppsManagement','Office365', 'LogicAppB2B'), \"It will work the same on AMA\",\r\n    \"If you plan to continue using this solution, reach out to Microsoft\")\r\n| extend Link = case(Solution in~ ('security', 'securityCenter', 'securityCenterFree', 'antimalware', 'sqlAdvancedThreatProtection',  'sqlVulnerabilityAssessment', 'sqlAssessment', 'sqlAssessmentPlus'), \"https://learn.microsoft.com/en-gb/azure/defender-for-cloud/auto-deploy-azure-monitoring-agent\",\r\n    Solution in~ ('windowsDefenderATP'), \"https://learn.microsoft.com/en-gb/microsoft-365/security/defender-endpoint/switch-to-mde-phase-3?view=o365-worldwide#onboarding-methods\", \r\n    Solution in~ ('updates'), \"https://learn.microsoft.com/en-gb/azure/update-center/\",\r\n    Solution in~ ('azureAutomation'), \"https://learn.microsoft.com/en-gb/azure/automation/automation-hybrid-runbook-worker\",\r\n    Solution in~ ('changeTracking'), \"https://learn.microsoft.com/en-us/azure/automation/change-tracking/overview-monitoring-agent\",\r\n    Solution in~ ('securityinsights', 'windowsFirewall', 'windowsEventForwarding'), \"https://learn.microsoft.com/en-gb/azure/sentinel/data-connectors-reference#windows-security-events-via-ama\",\r\n    Solution in~ ('dnsAnalytics'), \"https://learn.microsoft.com/en-gb/azure/sentinel/connect-dns-ama\",\r\n    Solution in~ ('vminsights', 'servicemap'), \"https://learn.microsoft.com/en-gb/azure/azure-monitor/vm/vminsights-enable-overview\",\r\n    Solution in~ ('containerInsights', 'containers'), \"https://learn.microsoft.com/en-gb/azure/azure-monitor/containers/container-insights-enable-existing-clusters?tabs=azure-cli#migrate-to-managed-identity-authentication\",\r\n    Solution in~ ('networkMonitoring'), \"https://learn.microsoft.com/en-us/azure/network-watcher/azure-monitor-agent-with-connection-monitor\",\r\n    Solution contains \"Start-Stop-VM\", \"https://learn.microsoft.com/en-us/azure/azure-functions/start-stop-vms/overview\",\r\n    Solution in~ ('adAssessment','adAssessmentPlus','adSecurityAssessment','sccmAssessmentPlus','windowsServerAssessment','exchangeAssessment','azureAssessment','exchangeOnlineAssessment','windowsClientAssessmentPlus','sharePointOnlineAssessment','spAssessment','sfBOnlineAssessment','sfBAssessment','SCOMAssessmentPlus','SQLAssessmentPlus', 'SQLAssessment/SQLAssessmentPlus','DesktopAssessmentPlus','WindowsClientAssessment'), \" \",\r\n    Solution in~ ('behaviorAnalyticsInsights'), \"https://learn.microsoft.com/en-us/azure/sentinel/identify-threats-with-entity-behavior-analytics\",\r\n    Solution in~ ('AzureSQLAnalytics'), \"https://learn.microsoft.com/en-us/azure/azure-sql/database/sql-insights-overview?view=azuresql\",\r\n    Solution in~ ('logicAppsManagement','Office365', 'LogicAppB2B'), \"\",\r\n    strcat(\"mailto:obs-agent-pms@microsoft.com?subject=[Migration%20Helper]:\", Solution))\r\n| project workspace, workspacename, Solution, Message, Link\r\n| order by ['Link'] asc",
                          "size": 0,
                          "title": "{workspaceid}",
                          "queryType": 1,
                          "resourceType": "microsoft.resourcegraph/resources",
                          "crossComponentResources": [
                            "{Subscription}"
                          ]
                        },
                        "conditionalVisibility": {
                          "parameterName": "1",
                          "comparison": "isEqualTo",
                          "value": "1"
                        },
                        "name": "Solutions-ARG"
                      },
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "union withsource = tt * \r\n| where isnotempty(Solution)\r\n| parse Solution with SolutionName \"/\" *\r\n| extend Solution = iff(isempty(SolutionName), Solution, SolutionName)\r\n| extend Solution = case(Solution in (\"Update\"), \"Updates\",\r\n    Solution contains \"SQLAuditing\", \"SQLAuditing\",\r\n    Solution in (\"VMInsights\"), \"VMInsights\", Solution)\r\n| summarize LastData = arg_max(TimeGenerated, *) by Solution\r\n| extend TimeFromNow = now() - LastData\r\n| extend [\"TimeAgo\"] = strcat(case(TimeFromNow < 2m, strcat(toint(TimeFromNow / 1s), ' seconds'), TimeFromNow < 60m, strcat(toint(TimeFromNow / 1m), ' minutes'), TimeFromNow < 24h, strcat(toint(TimeFromNow / 1h), ' hours'), strcat(toint(TimeFromNow / 1d), ' days')), ' ago')\r\n| project LastData, [\"Time\"]=strcat('ðŸ•’ ', TimeAgo), Solution",
                          "size": 0,
                          "timeContextFromParameter": "TimeRange",
                          "queryType": 0,
                          "resourceType": "microsoft.operationalinsights/workspaces",
                          "crossComponentResources": [
                            "{workspaceid}"
                          ]
                        },
                        "conditionalVisibility": {
                          "parameterName": "1",
                          "comparison": "isEqualTo",
                          "value": "1"
                        },
                        "name": "Solutions-WS"
                      },
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"afd7df58-054e-4ccd-a93c-1ff2b04b40a0\",\"mergeType\":\"leftouter\",\"leftTable\":\"Solutions-ARG\",\"rightTable\":\"Solutions-WS\",\"leftColumn\":\"Solution\",\"rightColumn\":\"Solution\"}],\"projectRename\":[{\"originalName\":\"[Solutions-ARG].workspace\",\"mergedName\":\"workspace\",\"fromId\":\"afd7df58-054e-4ccd-a93c-1ff2b04b40a0\"},{\"originalName\":\"[Solutions-ARG].workspacename\",\"mergedName\":\"workspacename\",\"fromId\":\"afd7df58-054e-4ccd-a93c-1ff2b04b40a0\"},{\"originalName\":\"[Solutions-ARG].Solution\",\"mergedName\":\"Solution\",\"fromId\":\"afd7df58-054e-4ccd-a93c-1ff2b04b40a0\"},{\"originalName\":\"[Solutions-ARG].Message\",\"mergedName\":\"Message\",\"fromId\":\"afd7df58-054e-4ccd-a93c-1ff2b04b40a0\"},{\"originalName\":\"[Solutions-ARG].Link\",\"mergedName\":\"Link\",\"fromId\":\"afd7df58-054e-4ccd-a93c-1ff2b04b40a0\"},{\"originalName\":\"[Solutions-WS].LastData\",\"mergedName\":\"LastData\",\"fromId\":\"afd7df58-054e-4ccd-a93c-1ff2b04b40a0\"},{\"originalName\":\"[Solutions-WS].Time\",\"mergedName\":\"Time\",\"fromId\":\"afd7df58-054e-4ccd-a93c-1ff2b04b40a0\"},{\"originalName\":\"[Solutions-WS].Solution\",\"mergedName\":\"Solution1\",\"fromId\":\"afd7df58-054e-4ccd-a93c-1ff2b04b40a0\"}]}",
                          "size": 0,
                          "title": "{$rowCount} Solutions in {workspaceid:label}",
                          "noDataMessage": "No solutions detected in this workspace",
                          "showExportToExcel": true,
                          "queryType": 7,
                          "gridSettings": {
                            "formatters": [
                              {
                                "columnMatch": "workspace",
                                "formatter": 5,
                                "formatOptions": {
                                  "linkTarget": "Resource",
                                  "subTarget": "Solutions",
                                  "linkIsContextBlade": true,
                                  "customColumnWidthSetting": "25ch"
                                }
                              },
                              {
                                "columnMatch": "workspacename",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "Solution",
                                "formatter": 0,
                                "formatOptions": {
                                  "customColumnWidthSetting": "30ch"
                                }
                              },
                              {
                                "columnMatch": "Message",
                                "formatter": 1,
                                "formatOptions": {
                                  "linkColumn": "Link",
                                  "linkTarget": "Url",
                                  "customColumnWidthSetting": "70ch"
                                }
                              },
                              {
                                "columnMatch": "Link",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "LastData",
                                "formatter": 5
                              },
                              {
                                "columnMatch": "Time",
                                "formatter": 18,
                                "formatOptions": {
                                  "thresholdsOptions": "icons",
                                  "thresholdsGrid": [
                                    {
                                      "operator": "is Empty",
                                      "representation": "Blank",
                                      "text": "No recent data"
                                    },
                                    {
                                      "operator": "Default",
                                      "thresholdValue": null,
                                      "representation": "Blank",
                                      "text": "{0}{1}"
                                    }
                                  ],
                                  "customColumnWidthSetting": "25ch"
                                }
                              },
                              {
                                "columnMatch": "Solution1",
                                "formatter": 5
                              }
                            ],
                            "labelSettings": [
                              {
                                "columnId": "workspace",
                                "label": "Workspace"
                              },
                              {
                                "columnId": "Message",
                                "label": "Recommendation"
                              },
                              {
                                "columnId": "Time",
                                "label": "Last Data Received"
                              }
                            ]
                          }
                        },
                        "conditionalVisibility": {
                          "parameterName": "wsid",
                          "comparison": "isNotEqualTo"
                        },
                        "showPin": false,
                        "name": "Solution-Data-Merged"
                      }
                    ]
                  },
                  "conditionalVisibility": {
                    "parameterName": "selectedTab",
                    "comparison": "isEqualTo",
                    "value": "Solutions"
                  },
                  "name": "solutionsgroup"
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "wsid",
              "comparison": "isNotEqualTo"
            },
            "name": "workspacespecific-group"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "Workspaces"
      },
      "name": "Workspaces"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## Azure Virtual Machines"
            },
            "name": "AzureVM-Header"
          },
          {
            "type": 1,
            "content": {
              "json": "This tab lists all the Azure virtual machines that have reported monitoring agent heartbeat signals in the {TimeRange} to the selected workspaces, from either the legacy Log Analytics Agents (MMA/OMS) or the new Azure Monitor Agent (AMA). It shows the status of the monitoring agents, and if Managed Identity is enabled, which is a prerequisite for AMA. [Learn more](https://docs.microsoft.com/en-us/azure/azure-monitor/agents/azure-monitor-agent-manage?tabs=ARMAgentPowerShell%2CPowerShellWindows%2CPowerShellWindowsArc%2CCLIWindows%2CCLIWindowsArc#prerequisites).\r\n",
              "style": "info"
            },
            "name": "AzureVMText"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Heartbeat\r\n| where ResourceProvider == \"Microsoft.Compute\" and ResourceType != \"virtualMachineScaleSets\"  and ComputerEnvironment != \"Non-Azure\" //and SubscriptionId == '{Subscription:id}'\r\n| summarize LastHeartBeat = arg_max(TimeGenerated, *) by _ResourceId\r\n| extend TimeFromNow = now() - LastHeartBeat\r\n| extend [\"TimeAgo\"] = strcat(case(TimeFromNow < 2m, strcat(toint(TimeFromNow / 1s), ' seconds'), TimeFromNow < 2h, strcat(toint(TimeFromNow / 1m), ' minutes'), TimeFromNow < 2d, strcat(toint(TimeFromNow / 1h), ' hours'), strcat(toint(TimeFromNow / 1d), ' days')), ' ago')\r\n| join kind=leftouter  (Heartbeat\r\n| where Category == \"SCOM Agent\"\r\n| summarize arg_max(TimeGenerated, *) by Computer\r\n| project _ResourceId, Category, Computer) on _ResourceId\r\n| extend SCOMAgent = iff(isnotempty(Computer1), \"Yes\", \"No\")\r\n| project LastHeartBeat, [\"Time\"]=strcat('ðŸ•’ ', TimeAgo), ResourceID = tolower(_ResourceId), Computer, SCOMAgent",
              "size": 0,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ]
            },
            "conditionalVisibility": {
              "parameterName": "1",
              "comparison": "isEqualTo",
              "value": "1"
            },
            "name": "azurevm-law-raw"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "resources\r\n| where type == \"microsoft.compute/virtualmachines\"\r\n| extend PowerStatus = properties.extended.instanceView.powerState.displayStatus,\r\n\tOSType = properties.storageProfile.osDisk.osType,\r\n    IdentityType = identity.type,\r\n    ComputerName = tolower(name)\r\n| project ComputerName, id, location, resourceGroup, PowerStatus, OSType, IdentityType\r\n| join kind=leftouter (\r\nresources\r\n| where type contains \"microsoft.compute/virtualmachines/extensions\"\r\n| extend publisher = properties.publisher\r\n| where publisher =~ \"Microsoft.EnterpriseCloud.Monitoring\"\r\n| parse id with * \"/virtualMachines/\" ComputerName \"/\" *\r\n| extend extensionType = properties.type, \r\n\tstatus = properties.provisioningState,\r\n\tversion = properties.typeHandlerVersion,\r\n    ComputerName = tolower(ComputerName)\r\n| project ComputerName, MMA = name, MMAStatus = status, version\r\n) on ComputerName\r\n| join kind=leftouter (\r\nresources\r\n| where type contains \"microsoft.compute/virtualmachines/extensions\"\r\n| extend publisher = properties.publisher\r\n| where publisher =~ \"Microsoft.Azure.Monitor\"\r\n| parse id with * \"/virtualMachines/\" ComputerName \"/\" *\r\n| extend extensionType = properties.type, \r\n\tstatus = properties.provisioningState,\r\n\tversion = properties.typeHandlerVersion,\r\n    ComputerName = tolower(ComputerName)\r\n| project ComputerName, AMA = name, AMAStatus = status, AMAVersion = version\r\n) on ComputerName\r\n| extend Progress = case(isnotempty(MMA) and isnotempty(AMA), \"In Progress\",\r\n                        isnotempty(MMA) and isempty(AMA), \"Not Started\",\r\n                        isempty(MMA) and isnotempty(AMA), \"Completed\", \"Other\")\r\n| project ComputerName, ResourceID = tolower(id), location, resourceGroup, OSType, PowerStatus, MMA, MMAStatus, IdentityType, AMA, AMAStatus, AMAVersion, Progress",
              "size": 0,
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "conditionalVisibility": {
              "parameterName": "1",
              "comparison": "isEqualTo",
              "value": "1"
            },
            "name": "azurevm-arg"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"c20c3df9-da71-4311-987e-37ccf8d730a5\",\"mergeType\":\"leftouter\",\"leftTable\":\"azurevm-arg\",\"rightTable\":\"azurevm-law-raw\",\"leftColumn\":\"ResourceID\",\"rightColumn\":\"ResourceID\"}],\"projectRename\":[{\"originalName\":\"[azurevm-arg].name\",\"mergedName\":\"name\",\"fromId\":\"c20c3df9-da71-4311-987e-37ccf8d730a5\"},{\"originalName\":\"[azurevm-arg].ResourceID\",\"mergedName\":\"ResourceID\",\"fromId\":\"c20c3df9-da71-4311-987e-37ccf8d730a5\"},{\"originalName\":\"[azurevm-arg].location\",\"mergedName\":\"location\",\"fromId\":\"c20c3df9-da71-4311-987e-37ccf8d730a5\"},{\"originalName\":\"[azurevm-arg].resourceGroup\",\"mergedName\":\"resourceGroup\",\"fromId\":\"c20c3df9-da71-4311-987e-37ccf8d730a5\"},{\"originalName\":\"[azurevm-arg].OSType\",\"mergedName\":\"OSType\",\"fromId\":\"c20c3df9-da71-4311-987e-37ccf8d730a5\"},{\"originalName\":\"[azurevm-arg].PowerStatus\",\"mergedName\":\"PowerStatus\",\"fromId\":\"c20c3df9-da71-4311-987e-37ccf8d730a5\"},{\"originalName\":\"[azurevm-arg].MMA\",\"mergedName\":\"MMA\",\"fromId\":\"c20c3df9-da71-4311-987e-37ccf8d730a5\"},{\"originalName\":\"[azurevm-arg].MMAStatus\",\"mergedName\":\"MMAStatus\",\"fromId\":\"c20c3df9-da71-4311-987e-37ccf8d730a5\"},{\"originalName\":\"[azurevm-arg].IdentityType\",\"mergedName\":\"IdentityType\",\"fromId\":\"c20c3df9-da71-4311-987e-37ccf8d730a5\"},{\"originalName\":\"[azurevm-arg].AMA\",\"mergedName\":\"AMA\",\"fromId\":\"c20c3df9-da71-4311-987e-37ccf8d730a5\"},{\"originalName\":\"[azurevm-arg].AMAStatus\",\"mergedName\":\"AMAStatus\",\"fromId\":\"c20c3df9-da71-4311-987e-37ccf8d730a5\"},{\"originalName\":\"[azurevm-arg].AMAVersion\",\"mergedName\":\"AMAVersion\",\"fromId\":\"c20c3df9-da71-4311-987e-37ccf8d730a5\"},{\"originalName\":\"[azurevm-law-raw].LastHeartBeat\",\"mergedName\":\"LastHeartBeat\",\"fromId\":\"c20c3df9-da71-4311-987e-37ccf8d730a5\"},{\"originalName\":\"[azurevm-law-raw].Time\",\"mergedName\":\"Time\",\"fromId\":\"c20c3df9-da71-4311-987e-37ccf8d730a5\"},{\"originalName\":\"[azurevm-arg].Progress\",\"mergedName\":\"Progress\",\"fromId\":\"c20c3df9-da71-4311-987e-37ccf8d730a5\"},{\"originalName\":\"[azurevm-law-raw].ResourceID\",\"mergedName\":\"ResourceID1\",\"fromId\":\"c20c3df9-da71-4311-987e-37ccf8d730a5\"},{\"originalName\":\"[azurevm-law-raw].Computer\",\"mergedName\":\"Computer\",\"fromId\":\"c20c3df9-da71-4311-987e-37ccf8d730a5\"},{\"originalName\":\"[azurevm-law-raw].SCOMAgent\",\"mergedName\":\"SCOMAgent\",\"fromId\":\"c20c3df9-da71-4311-987e-37ccf8d730a5\"},{\"originalName\":\"[azurevm-arg].ComputerName\",\"mergedName\":\"ComputerName\",\"fromId\":\"unknown\"}]}",
              "size": 0,
              "showExportToExcel": true,
              "queryType": 7,
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "name",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "ResourceID",
                    "formatter": 13,
                    "formatOptions": {
                      "linkTarget": "Resource",
                      "subTarget": "",
                      "linkIsContextBlade": true,
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "location",
                    "formatter": 17
                  },
                  {
                    "columnMatch": "OSType",
                    "formatter": 1
                  },
                  {
                    "columnMatch": "PowerStatus",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "!=",
                          "thresholdValue": "VM running",
                          "representation": "2",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "Blank",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "MMA",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "MMAStatus",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "is Empty",
                          "representation": "Blank",
                          "text": ""
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Succeeded",
                          "representation": "Blank",
                          "text": "Installed"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "2",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "IdentityType",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "is Empty",
                          "representation": "Blank",
                          "text": "No"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "Blank",
                          "text": "Yes"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "AMA",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "AMAStatus",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "AMAVersion",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "is Empty",
                          "representation": "Blank",
                          "text": "Not installed"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "success",
                          "text": "Agent Version {0}{1}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "LastHeartBeat",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "Time",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "is Empty",
                          "representation": "Blank",
                          "text": "No recent heartbeat"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "Blank",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "Progress",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "contains",
                          "thresholdValue": "Not Started",
                          "representation": "GetStarted",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "contains",
                          "thresholdValue": "In Progress",
                          "representation": "Postpone",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "contains",
                          "thresholdValue": "Completed",
                          "representation": "SmileyHappy",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "contains",
                          "thresholdValue": "Other",
                          "representation": "Question",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "Monitoring",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "ResourceID1",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "Computer",
                    "formatter": 5
                  }
                ],
                "rowLimit": 1000,
                "labelSettings": [
                  {
                    "columnId": "ResourceID",
                    "label": "VM Name"
                  },
                  {
                    "columnId": "location",
                    "label": "Location"
                  },
                  {
                    "columnId": "resourceGroup",
                    "label": "Resource Group"
                  },
                  {
                    "columnId": "OSType",
                    "label": "Operating System"
                  },
                  {
                    "columnId": "PowerStatus",
                    "label": "VM Status"
                  },
                  {
                    "columnId": "MMAStatus",
                    "label": "MMA/OMS Status"
                  },
                  {
                    "columnId": "IdentityType",
                    "label": "Managed Identity Enabled?"
                  },
                  {
                    "columnId": "AMAVersion",
                    "label": "AMA Installed"
                  },
                  {
                    "columnId": "Time",
                    "label": "Last Heartbeat"
                  },
                  {
                    "columnId": "Progress",
                    "label": "Migration Status"
                  },
                  {
                    "columnId": "SCOMAgent",
                    "label": "SCOM Agent"
                  }
                ]
              }
            },
            "showPin": false,
            "name": "AzureVM-Combo"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "AzureVM"
      },
      "name": "azurevmgroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## Azure Virtual Machine Scale Sets"
            },
            "name": "VMSS-header"
          },
          {
            "type": 1,
            "content": {
              "json": "This tab lists all the virtual machine scale sets that have reported monitoring agent heartbeat signals in the {TimeRange} to the selected workspaces, from either the legacy Log Analytics Agents (MMA/OMS) or the new Azure Monitor Agent (AMA). It shows the status of the monitoring agents, and if Managed Identity is enabled, which is a prerequisite for AMA. [Learn more](https://docs.microsoft.com/en-us/azure/azure-monitor/agents/azure-monitor-agent-manage?tabs=ARMAgentPowerShell%2CPowerShellWindows%2CPowerShellWindowsArc%2CCLIWindows%2CCLIWindowsArc#prerequisites).",
              "style": "info"
            },
            "name": "VMSSText"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "resources\r\n| where type == \"microsoft.compute/virtualmachinescalesets\"\r\n| join kind=leftouter (\r\nresources\r\n| where type == \"microsoft.compute/virtualmachinescalesets\"\r\n| extend extensions = properties.virtualMachineProfile.extensionProfile.extensions\r\n| mv-expand extensions\r\n| extend extname = extensions.name,\r\n    version = extensions.properties.typeHandlerVersion\r\n| extend ManagedIdentity = identity.type\r\n| where extname in (\"MicrosoftMonitoringAgent\")\r\n| project id, name, location, resourceGroup, subscriptionId, extname, ['version'], ManagedIdentity\r\n) on id\r\n| join kind=leftouter (\r\nresources\r\n| where type == \"microsoft.compute/virtualmachinescalesets\"\r\n| extend extensions = properties.virtualMachineProfile.extensionProfile.extensions\r\n| mv-expand extensions\r\n| extend extname = extensions.name,\r\n    version = extensions.properties.typeHandlerVersion\r\n| extend ManagedIdentity = identity.type\r\n| where extname in (\"AzureMonitorWindowsAgent\", \"AzureMonitorLinuxAgent\")\r\n| project id, name, location, resourceGroup, subscriptionId, extname, ['version'], ManagedIdentity\r\n) on id\r\n| project id, name, location, resourceGroup, subscriptionId, AMA = extname1, AMAVersion = version1, MMA = extname, MMAversion = version, ManagedIdentity\r\n| extend Progress = case(isnotempty(MMA) and isnotempty(AMA), \"In Progress\",\r\n                        isnotempty(MMA) and isempty(AMA), \"Not Started\",\r\n                        isempty(MMA) and isnotempty(AMA), \"Completed\", \r\n                        isempty(MMA) and isempty(AMA), \"Azure Monitor Not in Use\", \"Other\")",
              "size": 0,
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "conditionalVisibility": {
              "parameterName": "1",
              "comparison": "isEqualTo",
              "value": "1"
            },
            "name": "vmss-arg"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Heartbeat\r\n| where ResourceProvider == \"Microsoft.Compute\" and ResourceType == \"virtualMachineScaleSets\"  and ComputerEnvironment != \"Non-Azure\"\r\n| parse _ResourceId with VMSSResourceId \"/virtualmachines/\" *\r\n| summarize LastHeartBeat = arg_max(TimeGenerated, *) by VMSSResourceId\r\n| extend TimeFromNow = now() - LastHeartBeat\r\n| extend [\"TimeAgo\"] = strcat(case(TimeFromNow < 2m, strcat(toint(TimeFromNow / 1s), ' seconds'), TimeFromNow < 2h, strcat(toint(TimeFromNow / 1m), ' minutes'), TimeFromNow < 2d, strcat(toint(TimeFromNow / 1h), ' hours'), strcat(toint(TimeFromNow / 1d), ' days')), ' ago')\r\n| project LastHeartBeat, [\"Time\"]=strcat('ðŸ•’ ', TimeAgo), VMSSResourceId",
              "size": 0,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ]
            },
            "conditionalVisibility": {
              "parameterName": "1",
              "comparison": "isEqualTo",
              "value": "1"
            },
            "name": "vmss-law"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"c7420d42-c44f-4d11-b7d6-6a97ad70010e\",\"mergeType\":\"leftouter\",\"leftTable\":\"vmss-arg\",\"rightTable\":\"vmss-law\",\"leftColumn\":\"id\",\"rightColumn\":\"VMSSResourceId\"}],\"projectRename\":[{\"originalName\":\"[vmss-arg].subscriptionId\",\"mergedName\":\"SubscriptionID\",\"fromId\":\"c7420d42-c44f-4d11-b7d6-6a97ad70010e\"},{\"originalName\":\"[vmss-arg].id\",\"mergedName\":\"id\",\"fromId\":\"c7420d42-c44f-4d11-b7d6-6a97ad70010e\"},{\"originalName\":\"[vmss-arg].name\",\"mergedName\":\"name\",\"fromId\":\"c7420d42-c44f-4d11-b7d6-6a97ad70010e\"},{\"originalName\":\"[vmss-arg].location\",\"mergedName\":\"location\",\"fromId\":\"c7420d42-c44f-4d11-b7d6-6a97ad70010e\"},{\"originalName\":\"[vmss-arg].resourceGroup\",\"mergedName\":\"resourceGroup\",\"fromId\":\"c7420d42-c44f-4d11-b7d6-6a97ad70010e\"},{\"originalName\":\"[vmss-arg].MMAversion\",\"mergedName\":\"MMAversion\",\"fromId\":\"c7420d42-c44f-4d11-b7d6-6a97ad70010e\"},{\"originalName\":\"[vmss-arg].MMA\",\"mergedName\":\"MMA\",\"fromId\":\"c7420d42-c44f-4d11-b7d6-6a97ad70010e\"},{\"originalName\":\"[vmss-arg].ManagedIdentity\",\"mergedName\":\"ManagedIdentity\",\"fromId\":\"c7420d42-c44f-4d11-b7d6-6a97ad70010e\"},{\"originalName\":\"[vmss-arg].AMA\",\"mergedName\":\"AMA\",\"fromId\":\"c7420d42-c44f-4d11-b7d6-6a97ad70010e\"},{\"originalName\":\"[vmss-arg].AMAVersion\",\"mergedName\":\"AMAVersion\",\"fromId\":\"c7420d42-c44f-4d11-b7d6-6a97ad70010e\"},{\"originalName\":\"[vmss-law].Time\",\"mergedName\":\"Time\",\"fromId\":\"c7420d42-c44f-4d11-b7d6-6a97ad70010e\"},{\"originalName\":\"[vmss-arg].Progress\",\"mergedName\":\"Progress\",\"fromId\":\"c7420d42-c44f-4d11-b7d6-6a97ad70010e\"},{\"originalName\":\"[vmss-law].LastHeartBeat\",\"mergedName\":\"LastHeartBeat\",\"fromId\":\"c7420d42-c44f-4d11-b7d6-6a97ad70010e\"},{\"originalName\":\"[vmss-law].VMSSResourceId\",\"mergedName\":\"VMSSResourceId\",\"fromId\":\"c7420d42-c44f-4d11-b7d6-6a97ad70010e\"}]}",
              "size": 0,
              "title": "{$rowCount} Virtual Machine Scale Set(s)",
              "noDataMessage": "No Azure Virtual Machine Scale Sets detected in the selected subscriptions.",
              "queryType": 7,
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "SubscriptionID",
                    "formatter": 15,
                    "formatOptions": {
                      "linkTarget": "Resource",
                      "linkIsContextBlade": true,
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "id",
                    "formatter": 13,
                    "formatOptions": {
                      "linkTarget": "Resource",
                      "linkIsContextBlade": true,
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "name",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "location",
                    "formatter": 17
                  },
                  {
                    "columnMatch": "resourceGroup",
                    "formatter": 14,
                    "formatOptions": {
                      "linkTarget": null,
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "MMAversion",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "is Empty",
                          "representation": "Blank",
                          "text": "Not Installed"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "Blank",
                          "text": "Installed"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "MMA",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "ManagedIdentity",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "is Empty",
                          "representation": "Blank",
                          "text": "No"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "Blank",
                          "text": "Yes"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "AMA",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "AMAVersion",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "is Empty",
                          "representation": "Blank",
                          "text": "Not deployed"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "success",
                          "text": "Agent Version {0}{1}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "Progress",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "In Progress",
                          "representation": "Clock",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Not Started",
                          "representation": "GetStarted",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Completed",
                          "representation": "SmileyHappy",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "Monitoring",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "LastHeartBeat",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "VMSSResourceId",
                    "formatter": 5
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "id",
                    "label": "VMSS Name"
                  },
                  {
                    "columnId": "location",
                    "label": "Location"
                  },
                  {
                    "columnId": "resourceGroup",
                    "label": "Resource Group"
                  },
                  {
                    "columnId": "MMAversion",
                    "label": "MMA/OMS Status"
                  },
                  {
                    "columnId": "AMAVersion",
                    "label": "AMA Status"
                  },
                  {
                    "columnId": "Time",
                    "label": "Last Heartbeat"
                  },
                  {
                    "columnId": "Progress",
                    "label": "Migration Status"
                  }
                ]
              }
            },
            "showPin": false,
            "name": "vmss-merge"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "VMSS"
      },
      "name": "VMSS-Group"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "# Arc-enabled servers"
            },
            "name": "ArcServers-Header"
          },
          {
            "type": 1,
            "content": {
              "json": "This tab lists all the on-premise servers or servers managed via other clouds, that have Arc agent (ConnectedMachineAgent) installed and that have reported monitoring agent heartbeat signals in the {TimeRange:label} to the selected workspaces, from either the legacy Log Analytics Agents (MMA/OMS) or the new Azure Monitor Agent (AMA). It shows the status of the monitoring agents installed.",
              "style": "info"
            },
            "name": "ArcServers-Info"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Heartbeat\r\n| where (ResourceProvider == \"Microsoft.HybridCompute\") and _ResourceId != \"\"\r\n| summarize LastHeartBeat = arg_max(TimeGenerated, *) by _ResourceId\r\n| extend TimeFromNow = now() - LastHeartBeat\r\n| extend [\"TimeAgo\"] = strcat(case(TimeFromNow < 2m, strcat(toint(TimeFromNow / 1s), ' seconds'), TimeFromNow < 2h, strcat(toint(TimeFromNow / 1m), ' minutes'), TimeFromNow < 2d, strcat(toint(TimeFromNow / 1h), ' hours'), strcat(toint(TimeFromNow / 1d), ' days')), ' ago')\r\n| join kind=leftouter  (Heartbeat\r\n| where Category == \"SCOM Agent\"\r\n| summarize arg_max(TimeGenerated, *) by Computer\r\n| project _ResourceId, Category, Computer) on _ResourceId\r\n| extend SCOMAgent = iff(isnotempty(Computer1), \"Yes\", \"No\")\r\n| project LastHeartBeat, [\"Time\"]=strcat('ðŸ•’ ', TimeAgo), _ResourceId, Computer, SCOMAgent",
              "size": 0,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ]
            },
            "conditionalVisibility": {
              "parameterName": "1",
              "comparison": "isEqualTo",
              "value": "1"
            },
            "name": "Arc-LAW"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "resources\r\n| where type == \"microsoft.hybridcompute/machines\"\r\n| extend provisioningState = properties.provisioningState,\r\n\tstatus = properties.status,\r\n\tagentVersion = properties.agentVersion,\r\n\tlastStatusChange = properties.lastStatusChange,\r\n\terrorDetails = properties.errorDetails,\r\n\tosName = properties.osName,\r\n\tosSku = properties.osSku\r\n| extend name = tolower(name)\r\n| project id, name, location, resourceGroup, provisioningState, status, agentVersion, lastStatusChange, osName, osSku\r\n| join kind=leftouter (\r\nresources\r\n| where type contains \"microsoft.hybridcompute/machines/extensions\"\r\n| extend publisher = properties.publisher\r\n| where publisher =~ \"Microsoft.EnterpriseCloud.Monitoring\"\r\n| parse id with * \"/machines/\" ComputerName \"/\" *\r\n| extend extensionType = properties.type, \r\n\tstatus = properties.provisioningState,\r\n\tversion = properties.typeHandlerVersion\r\n| extend ComputerName = tolower(ComputerName)\r\n| project ComputerName, MMA = name, MMAStatus = status, MMAVersion = version\r\n) on $left.name == $right.ComputerName\r\n| join kind=leftouter (\r\nresources\r\n| where type contains \"microsoft.hybridcompute/machines/extensions\"\r\n| extend publisher = properties.publisher\r\n| where publisher =~ \"Microsoft.Azure.Monitor\"\r\n| parse id with * \"/machines/\" ComputerName \"/\" *\r\n| extend extensionType = properties.type, \r\n\tstatus = properties.provisioningState,\r\n\tversion = properties.typeHandlerVersion\r\n| extend ComputerName = tolower(ComputerName)\r\n| project ComputerName, AMA = name, AMAStatus = status, AMAVersion = version\r\n) on $left.name == $right.ComputerName\r\n| extend Progress = case(isnotempty(MMA) and isnotempty(AMA), \"In Progress\",\r\n                        isnotempty(MMA) and isempty(AMA), \"Not Started\",\r\n                        isempty(MMA) and isnotempty(AMA), \"Completed\", \"Other\")\r\n| project id, name, location, resourceGroup, status, agentVersion, osName, osSku, MMA, MMAStatus, MMAVersion, AMA, AMAStatus, AMAVersion, Progress",
              "size": 0,
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "conditionalVisibility": {
              "parameterName": "1",
              "comparison": "isEqualTo",
              "value": "1"
            },
            "name": "Arc-ARG"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"870ee573-6a1f-49db-b6c6-1790141de046\",\"mergeType\":\"innerunique\",\"leftTable\":\"Arc-LAW\",\"rightTable\":\"Arc-ARG\",\"leftColumn\":\"_ResourceId\",\"rightColumn\":\"id\"}],\"projectRename\":[{\"originalName\":\"[Arc-ARG].id\",\"mergedName\":\"id\",\"fromId\":\"870ee573-6a1f-49db-b6c6-1790141de046\"},{\"originalName\":\"[Arc-LAW]._ResourceId\",\"mergedName\":\"_ResourceId\",\"fromId\":\"870ee573-6a1f-49db-b6c6-1790141de046\"},{\"originalName\":\"[Arc-LAW].Computer\",\"mergedName\":\"Computer\",\"fromId\":\"870ee573-6a1f-49db-b6c6-1790141de046\"},{\"originalName\":\"[Arc-ARG].name\",\"mergedName\":\"name\",\"fromId\":\"870ee573-6a1f-49db-b6c6-1790141de046\"},{\"originalName\":\"[Arc-ARG].location\",\"mergedName\":\"location\",\"fromId\":\"870ee573-6a1f-49db-b6c6-1790141de046\"},{\"originalName\":\"[Arc-ARG].resourceGroup\",\"mergedName\":\"resourceGroup\",\"fromId\":\"870ee573-6a1f-49db-b6c6-1790141de046\"},{\"originalName\":\"[Arc-ARG].osName\",\"mergedName\":\"osName\",\"fromId\":\"870ee573-6a1f-49db-b6c6-1790141de046\"},{\"originalName\":\"[Arc-ARG].osSku\",\"mergedName\":\"osSku\",\"fromId\":\"870ee573-6a1f-49db-b6c6-1790141de046\"},{\"originalName\":\"[Arc-ARG].status\",\"mergedName\":\"status\",\"fromId\":\"870ee573-6a1f-49db-b6c6-1790141de046\"},{\"originalName\":\"[Arc-ARG].agentVersion\",\"mergedName\":\"agentVersion\",\"fromId\":\"870ee573-6a1f-49db-b6c6-1790141de046\"},{\"originalName\":\"[Arc-ARG].MMA\",\"mergedName\":\"MMA\",\"fromId\":\"870ee573-6a1f-49db-b6c6-1790141de046\"},{\"originalName\":\"[Arc-ARG].MMAStatus\",\"mergedName\":\"MMAStatus\",\"fromId\":\"870ee573-6a1f-49db-b6c6-1790141de046\"},{\"originalName\":\"[Arc-ARG].MMAVersion\",\"mergedName\":\"MMAVersion\",\"fromId\":\"870ee573-6a1f-49db-b6c6-1790141de046\"},{\"originalName\":\"[Arc-ARG].AMA\",\"mergedName\":\"AMA\",\"fromId\":\"870ee573-6a1f-49db-b6c6-1790141de046\"},{\"originalName\":\"[Arc-ARG].AMAStatus\",\"mergedName\":\"AMAStatus\",\"fromId\":\"870ee573-6a1f-49db-b6c6-1790141de046\"},{\"originalName\":\"[Arc-ARG].AMAVersion\",\"mergedName\":\"AMAVersion\",\"fromId\":\"870ee573-6a1f-49db-b6c6-1790141de046\"},{\"originalName\":\"[Arc-LAW].Time\",\"mergedName\":\"Time\",\"fromId\":\"870ee573-6a1f-49db-b6c6-1790141de046\"},{\"originalName\":\"[Arc-ARG].Progress\",\"mergedName\":\"Progress\",\"fromId\":\"870ee573-6a1f-49db-b6c6-1790141de046\"},{\"originalName\":\"[Arc-LAW].LastHeartBeat\",\"mergedName\":\"LastHeartBeat\",\"fromId\":\"870ee573-6a1f-49db-b6c6-1790141de046\"},{\"originalName\":\"[Arc-LAW].SCOMAgent\",\"mergedName\":\"SCOMAgent\",\"fromId\":\"870ee573-6a1f-49db-b6c6-1790141de046\"}]}",
              "size": 0,
              "title": "{$rowCount} Azure Arc-enabled servers",
              "noDataMessage": "No Arc-enabled Virtual Machines with a relationship to the selected workspace(s). Please select the workspace that contain your Arc-enabled virtual machine(s)",
              "showExportToExcel": true,
              "queryType": 7,
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "_ResourceId",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "Computer",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "name",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "location",
                    "formatter": 17
                  },
                  {
                    "columnMatch": "resourceGroup",
                    "formatter": 14,
                    "formatOptions": {
                      "linkTarget": null,
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "osName",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "osSku",
                    "formatter": 1
                  },
                  {
                    "columnMatch": "status",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "Connected",
                          "representation": "success",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "2",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "agentVersion",
                    "formatter": 1
                  },
                  {
                    "columnMatch": "MMA",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "MMAStatus",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "is Empty",
                          "representation": "Blank",
                          "text": "Not Installed"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "success",
                          "text": "Installed"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "MMAVersion",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "AMA",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "AMAStatus",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "AMAVersion",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "is Empty",
                          "representation": "Blank",
                          "text": "Not Installed"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "success",
                          "text": "Version {0}{1}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "Progress",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "In Progress",
                          "representation": "Clock",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Not Started",
                          "representation": "GetStarted",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Completed",
                          "representation": "SmileyHappy",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "Monitoring",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "LastHeartBeat",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "SCOMAgent",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "Yes",
                          "representation": "1",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "Blank",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "id",
                    "label": "Server Name"
                  },
                  {
                    "columnId": "location",
                    "label": "Location"
                  },
                  {
                    "columnId": "resourceGroup",
                    "label": "Resource Group"
                  },
                  {
                    "columnId": "osSku",
                    "label": "Operating System"
                  },
                  {
                    "columnId": "status",
                    "label": "Arc Status"
                  },
                  {
                    "columnId": "MMAStatus",
                    "label": "MMA/OMS Status"
                  },
                  {
                    "columnId": "AMAVersion",
                    "label": "AMA Installed"
                  },
                  {
                    "columnId": "Time",
                    "label": "Last Heartbeat"
                  },
                  {
                    "columnId": "SCOMAgent",
                    "label": "SCOM Agent"
                  }
                ]
              }
            },
            "showPin": false,
            "name": "Hybrid-Arc-Merge"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "Arc"
      },
      "name": "ArcServerGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "# Hybrid Machines without Arc"
            },
            "name": "hybrid-without-arc-header"
          },
          {
            "type": 1,
            "content": {
              "json": "This tab lists all the on-premises servers or servers managed via other clouds that have reported monitoring agent heartbeat signals in the {TimeRange} to the selected workspace(s) from the legacy Log Analytics Agents (MMA/OMS). In order to migrate you must [install Arc agent](https://docs.microsoft.com/en-us/azure/azure-arc/servers/agent-overview) on these servers first, which is a prerequisite to install the Azure Monitor Agent.",
              "style": "info"
            },
            "name": "HybridNoArc-info"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "resources\r\n| where type == \"microsoft.operationalinsights/workspaces\"\r\n| extend wsid = tolower(id),\r\n    workspaceid = properties.customerId\r\n| project wsid, name, workspaceid",
              "size": 0,
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "gridSettings": {
                "sortBy": [
                  {
                    "itemKey": "name",
                    "sortOrder": 1
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "name",
                  "sortOrder": 1
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "1",
              "comparison": "isEqualTo",
              "value": "1"
            },
            "name": "workspace-arg"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Heartbeat\r\n| where isempty(_ResourceId)\r\n| summarize LastHeartBeat = arg_max(TimeGenerated, *) by Computer\r\n| extend TimeFromNow = now() - LastHeartBeat\r\n| extend [\"TimeAgo\"] = strcat(case(TimeFromNow < 2m, strcat(toint(TimeFromNow / 1s), ' seconds'), TimeFromNow < 2h, strcat(toint(TimeFromNow / 1m), ' minutes'), TimeFromNow < 2d, strcat(toint(TimeFromNow / 1h), ' hours'), strcat(toint(TimeFromNow / 1d), ' days')), ' ago')\r\n| extend OSName = iff(OSType == \"Windows\" and isempty(OSName) and OSMajorVersion == 10, \"Windows 10/11\", OSName)\r\n| extend [\"Migration status\"] = \"Not started\"\r\n| extend MMAstatus = \"Installed\"\r\n| parse ManagementGroupName with \"AOI-\" workspaceid\r\n| join kind=leftouter  (Heartbeat\r\n| where Category == \"SCOM Agent\"\r\n| summarize arg_max(TimeGenerated, *) by Computer\r\n| project _ResourceId, Category, Computer) on _ResourceId\r\n| extend SCOMAgent = iff(isnotempty(Computer1), \"Yes\", \"No\")\r\n| project workspaceid, Computer, OSName, RemoteIPCountry, [\"Last Heartbeat\"]=strcat('ðŸ•’ ', TimeAgo), MMAstatus, [\"Migration status\"], SCOMAgent",
              "size": 0,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ]
            },
            "conditionalVisibility": {
              "parameterName": "1",
              "comparison": "isEqualTo",
              "value": "1"
            },
            "name": "HybridNoArc-LAW"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"c7420d42-c44f-4d11-b7d6-6a97ad700159\",\"mergeType\":\"innerunique\",\"leftTable\":\"HybridNoArc-LAW\",\"rightTable\":\"workspace-arg\",\"leftColumn\":\"workspaceid\",\"rightColumn\":\"workspaceid\"}],\"projectRename\":[{\"originalName\":\"[workspace-arg].wsid\",\"mergedName\":\"wsid\",\"fromId\":\"c7420d42-c44f-4d11-b7d6-6a97ad700159\"},{\"originalName\":\"[HybridNoArc-LAW].workspaceid\",\"mergedName\":\"workspaceid\",\"fromId\":\"c7420d42-c44f-4d11-b7d6-6a97ad700159\"},{\"originalName\":\"[HybridNoArc-LAW].Computer\",\"mergedName\":\"Computer\",\"fromId\":\"c7420d42-c44f-4d11-b7d6-6a97ad700159\"},{\"originalName\":\"[HybridNoArc-LAW].OSName\",\"mergedName\":\"OSName\",\"fromId\":\"c7420d42-c44f-4d11-b7d6-6a97ad700159\"},{\"originalName\":\"[HybridNoArc-LAW].RemoteIPCountry\",\"mergedName\":\"RemoteIPCountry\",\"fromId\":\"c7420d42-c44f-4d11-b7d6-6a97ad700159\"},{\"originalName\":\"[HybridNoArc-LAW].Last Heartbeat\",\"mergedName\":\"Last Heartbeat\",\"fromId\":\"c7420d42-c44f-4d11-b7d6-6a97ad700159\"},{\"originalName\":\"[HybridNoArc-LAW].MMAstatus\",\"mergedName\":\"MMAstatus\",\"fromId\":\"c7420d42-c44f-4d11-b7d6-6a97ad700159\"},{\"originalName\":\"[HybridNoArc-LAW].Migration status\",\"mergedName\":\"Migration status\",\"fromId\":\"c7420d42-c44f-4d11-b7d6-6a97ad700159\"},{\"originalName\":\"[HybridNoArc-LAW].SCOMAgent\",\"mergedName\":\"SCOMAgent\",\"fromId\":\"c7420d42-c44f-4d11-b7d6-6a97ad700159\"},{\"originalName\":\"[workspace-arg].name\",\"mergedName\":\"name\",\"fromId\":\"c7420d42-c44f-4d11-b7d6-6a97ad700159\"},{\"originalName\":\"[workspace-arg].workspaceid\",\"mergedName\":\"workspaceid1\",\"fromId\":\"c7420d42-c44f-4d11-b7d6-6a97ad700159\"}]}",
              "size": 0,
              "title": "{$rowCount} Hybrid without Arc Server(s)",
              "noDataMessage": "No Hybrid machines with the MMA installed detected in the selected workspaces.",
              "noDataMessageStyle": 3,
              "queryType": 7,
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "wsid",
                    "formatter": 13,
                    "formatOptions": {
                      "linkTarget": "Resource",
                      "linkIsContextBlade": true,
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "workspaceid",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "Migration status",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "GetStarted",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "SCOMAgent",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "representation": "1",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "Blank",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "name",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "workspaceid1",
                    "formatter": 5
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "wsid",
                    "label": "Workspace"
                  },
                  {
                    "columnId": "OSName",
                    "label": "Operating System"
                  },
                  {
                    "columnId": "RemoteIPCountry",
                    "label": "Location"
                  },
                  {
                    "columnId": "MMAstatus",
                    "label": "MMA/OMS Status"
                  }
                ]
              }
            },
            "showPin": false,
            "name": "HybridNoArc-Merge"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "HybridNoArc"
      },
      "name": "HybridWithoutArcGroup"
    }
  ],
  "fallbackResourceIds": [
    "Azure Monitor"
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}